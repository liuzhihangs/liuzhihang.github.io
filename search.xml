<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Spring åŠ¨æ€ä»£ç†æ—¶æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¸‰çº§ç¼“å­˜ï¼Ÿ</title>
      <link href="2021/01/30/source-spring-circular-dependence-2.html"/>
      <url>2021/01/30/source-spring-circular-dependence-2.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>åœ¨ç ”ç©¶ <a href="https://mp.weixin.qq.com/s/UlUQ95gVt8I8wmVOEjn1aw">ã€ Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ ã€</a> çš„æ—¶å€™ï¼Œäº†è§£åˆ° Spring æ˜¯å€ŸåŠ©<em>ä¸‰çº§ç¼“å­˜</em>æ¥è§£å†³å¾ªç¯ä¾èµ–çš„ã€‚</p><p>åŒæ ·åœ¨ä¸Šä¸€èŠ‚ç•™ä¸‹äº†ç–‘é—®ï¼š</p><ol><li>å¾ªç¯ä¾èµ–ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¸‰çº§ç¼“å­˜ï¼Ÿè€Œä¸æ˜¯ä½¿ç”¨äºŒçº§ç¼“å­˜ï¼Ÿ</li><li>AOP åŠ¨æ€ä»£ç†å¯¹å¾ªç¯ä¾èµ–çš„æœ‰æ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ</li></ol><p>æœ¬ç¯‡æ–‡ç« ä¹Ÿæ˜¯å›´ç»•ä¸Šé¢çš„å†…å®¹è¿›è¡Œå±•å¼€ã€‚</p><blockquote><p>ç¬”è®°ä¹Ÿåœ¨ä¸æ–­æ•´ç†ï¼Œä¹‹å‰å¯èƒ½ä¼šæœ‰ç‚¹æ‚ä¹±ã€‚</p></blockquote><h3 id="å¾ªåºæ¸è¿›ï¼Œçœ‹ä¸€çœ‹ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Ÿ"><a href="#å¾ªåºæ¸è¿›ï¼Œçœ‹ä¸€çœ‹ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Ÿ" class="headerlink" title="å¾ªåºæ¸è¿›ï¼Œçœ‹ä¸€çœ‹ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Ÿ"></a>å¾ªåºæ¸è¿›ï¼Œçœ‹ä¸€çœ‹ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Ÿ</h3><p>å¼€å§‹å…ˆç®€å•å›é¡¾ä¸€ä¸‹ Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå½“ç„¶å°ä¼™ä¼´ä¹Ÿå¯ä»¥ç›´æ¥é˜…è¯»<a href="https://mp.weixin.qq.com/s/qZ4xXlqpNzsdHkvFm02Yuw">ã€ å•ä¾‹ Bean çš„åˆ›å»º ã€</a>è¿™ç¯‡æ–‡ç« ã€‚</p><p>ä¸è¿‡è€ƒè™‘åˆ°é˜…è¯»æœ¬æ–‡å‰å†é˜…è¯»ä¸Šä¸€ç¯‡æ–‡ç« ã€Debug ç­‰ç­‰ï¼Œä¼šæ¯”è¾ƒè€—æ—¶ï¼Œæ‰€ä»¥æœ¬ç¯‡æ–‡ç« å‰é¢ä¸€å°éƒ¨åˆ†ä¼šå…ˆå¯¹ä¹‹å‰çš„æ–‡ç« å†…å®¹åšç®€è¦æ¦‚æ‹¬ï¼Œä¹Ÿç›¸å½“äºå¯¹æˆ‘è‡ªå·±å­¦ä¹ çš„çŸ¥è¯†è¿›è¡Œä¸€ä¸ªæ€»ç»“ã€‚</p><p>å…ˆæ¥å›é¡¾ä¸€ä¸‹ä¸‰çº§ç¼“å­˜çš„æ¦‚å¿µã€‚</p><blockquote><p><strong>singletonObjectsï¼š</strong> ä¸€çº§ç¼“å­˜ï¼Œå­˜å‚¨å•ä¾‹å¯¹è±¡ï¼ŒBean å·²ç»å®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–å®Œæˆã€‚</p><p><strong>earlySingletonObjectsï¼š</strong> äºŒçº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonObjectï¼Œè¿™ä¸ª Bean å®ä¾‹åŒ–äº†ï¼Œè¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚</p><p><strong>singletonFactoriesï¼š</strong> ä¸‰çº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonFactoryã€‚</p></blockquote><h4 id="Bean-çš„åˆ›å»ºè¿‡ç¨‹"><a href="#Bean-çš„åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="Bean çš„åˆ›å»ºè¿‡ç¨‹"></a>Bean çš„åˆ›å»ºè¿‡ç¨‹</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularServiceA</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String fieldA = <span class="string">&quot;å­—æ®µ A&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/Py9LKD-MrHkh6.png" alt="å•ä¾‹ Bean çš„åˆ›å»ºè¿‡ç¨‹"></p><p>é€šè¿‡ä¸Šé¢çš„æµç¨‹ï¼Œå¯ä»¥çœ‹å‡º Spring åœ¨åˆ›å»º Bean çš„è¿‡ç¨‹ä¸­é‡ç‚¹æ˜¯åœ¨ AbstractAutowireCapableBeanFactory ä¸­çš„ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li><strong>å®ä¾‹åŒ– createBeanInstanceï¼š</strong> å…¶ä¸­å®ä¾‹åŒ– Bean å¹¶å¯¹ Bean è¿›è¡Œèµ‹å€¼ï¼Œåƒä¾‹å­ä¸­çš„ <code>fieldA</code> å­—æ®µåœ¨è¿™é‡Œå°±ä¼šèµ‹å€¼ã€‚</li><li><strong>å±æ€§æ³¨å…¥ populateBeanï¼š</strong> å¯ä»¥ç†è§£ä¸ºå¯¹ Bean é‡Œé¢çš„å±æ€§è¿›è¡Œèµ‹å€¼ã€‚(ä¼šä¾èµ–å…¶ä»– Bean)</li><li><strong>åˆå§‹åŒ– initializeBeanï¼š</strong> æ‰§è¡Œåˆå§‹åŒ–å’Œ Bean çš„åç½®å¤„ç†å™¨ã€‚</li></ol><blockquote><p>å®ä¾‹åŒ–èµ‹å€¼æºç å¯ä»¥é˜…è¯»ï¼š</p><p>BeanUtils.instantiateClass(constructorToUse) </p></blockquote><h4 id="å¦‚æœè¦ä¾èµ–å…¶ä»–-Bean-å‘¢ï¼Ÿ"><a href="#å¦‚æœè¦ä¾èµ–å…¶ä»–-Bean-å‘¢ï¼Ÿ" class="headerlink" title="å¦‚æœè¦ä¾èµ–å…¶ä»– Bean å‘¢ï¼Ÿ"></a>å¦‚æœè¦ä¾èµ–å…¶ä»– Bean å‘¢ï¼Ÿ</h4><p>é‚£å¦‚æœ CircularServiceA ä¾èµ–äº†å…¶ä»– Bean å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularServiceA</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String fieldA = <span class="string">&quot;å­—æ®µ A&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircularServiceB circularServiceB;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularServiceB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/41pskM-PPjKdq.png" alt="A ä¾èµ–äº† B"></p><p>å½“ A ä¾èµ–äº† B çš„æ—¶å€™ï¼Œåœ¨ <code>createBeanInstance</code> è¿™ä¸€æ­¥ï¼Œå¹¶ä¸ä¼šå¯¹ B è¿›è¡Œå±æ€§èµ‹å€¼ã€‚</p><p>è€Œæ˜¯åœ¨ <code>populatedBean</code> è¿™é‡ŒæŸ¥æ‰¾ä¾èµ–é¡¹ï¼Œå¹¶åˆ›å»º Bã€‚</p><h4 id="å¾ªç¯ä¾èµ–ä¸‹çš„åˆ›å»ºè¿‡ç¨‹"><a href="#å¾ªç¯ä¾èµ–ä¸‹çš„åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="å¾ªç¯ä¾èµ–ä¸‹çš„åˆ›å»ºè¿‡ç¨‹"></a>å¾ªç¯ä¾èµ–ä¸‹çš„åˆ›å»ºè¿‡ç¨‹</h4><p>å¾ªç¯ä¾èµ–çš„åœºæ™¯ï¼Œåœ¨ä¸Šä¸€ç¯‡æ–‡ç« å·²ç»æœ‰æ‰€è®²è§£ï¼Œè¿™é‡Œä»…ä»…ç”»å›¾è¯´æ˜ä¸€ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularServiceA</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String fieldA = <span class="string">&quot;å­—æ®µ A&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircularServiceB circularServiceB;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularServiceB</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircularServiceA circularServiceA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/giuIlH-DkGpSm.png" alt="A B å¾ªç¯ä¾èµ–"></p><p>åœ¨ A å’Œ B å¾ªç¯ä¾èµ–çš„åœºæ™¯ä¸­ï¼š</p><p>B <code>populatedBean</code> æŸ¥æ‰¾ä¾èµ–é¡¹ A çš„æ—¶å€™ï¼Œä»ä¸€çº§ç¼“å­˜ä¸­è™½ç„¶æœªè·å–åˆ° Aï¼Œä½†æ˜¯å‘ç° A åœ¨åˆ›å»ºä¸­ã€‚</p><p>æ­¤æ—¶ï¼Œä»ä¸‰çº§ç¼“å­˜ä¸­è·å– A çš„ <code>singletonFactory</code> è°ƒç”¨å·¥å‚æ–¹æ³•ï¼Œåˆ›å»º <code>getEarlyBeanReference</code> A çš„æ—©æœŸå¼•ç”¨å¹¶è¿”å›ã€‚</p><p>B å¼•ç”¨åˆ° A ï¼ŒB å°±å¯ä»¥åˆå§‹åŒ–å®Œæ¯•ï¼Œç„¶å A åŒæ ·ä¹Ÿå¯ä»¥åˆå§‹åŒ–å®Œæ¯•äº†ã€‚</p><h3 id="äºŒçº§ç¼“å­˜èƒ½å¦è§£å†³å¾ªç¯ä¾èµ–"><a href="#äºŒçº§ç¼“å­˜èƒ½å¦è§£å†³å¾ªç¯ä¾èµ–" class="headerlink" title="äºŒçº§ç¼“å­˜èƒ½å¦è§£å†³å¾ªç¯ä¾èµ–"></a>äºŒçº§ç¼“å­˜èƒ½å¦è§£å†³å¾ªç¯ä¾èµ–</h3><p>é€šè¿‡ä¸Šé¢çš„å›¾ï¼Œä»”ç»†åˆ†æä¸€ä¸‹ï¼Œå…¶å®æŠŠäºŒçº§ç¼“å­˜æ‹¿æ‰ï¼Œåœ¨ B å°è¯•è·å– A çš„æ—¶å€™ç›´æ¥è¿”å› A çš„å®ä¾‹ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼šå¯ä»¥çš„ï¼</p><p>ä½†æ˜¯ä¸ºä»€ä¹ˆè¿˜æ˜¯ç”¨ä¸‰çº§ç¼“å­˜å‘¢ï¼Ÿ </p><p>ç½‘ä¸Šçš„å¾ˆå¤šèµ„æ–™è¯´æ˜¯å’ŒåŠ¨æ€ä»£ç†æœ‰å…³ç³»ï¼Œé‚£å°±ä»åŠ¨æ€ä»£ç†çš„æ–¹é¢ç»§ç»­å¾€ä¸‹åˆ†æåˆ†æã€‚</p><h3 id="åŠ¨æ€ä»£ç†çš„åœºæ™¯"><a href="#åŠ¨æ€ä»£ç†çš„åœºæ™¯" class="headerlink" title="åŠ¨æ€ä»£ç†çš„åœºæ™¯"></a>åŠ¨æ€ä»£ç†çš„åœºæ™¯</h3><p>åœ¨ JavaConfigï¼ˆé…ç½®ç±»ï¼‰ ä¸Šæ·»åŠ  <code>@EnableAspectJAutoProxy</code> æ³¨è§£ï¼Œå¼€å¯ AOP ï¼Œé€šè¿‡ Debug å¾ªåºæ¸è¿›çœ‹ä¸€çœ‹åŠ¨æ€ä»£ç†å¯¹å¾ªç¯ä¾èµ–çš„å½±å“ã€‚</p><h4 id="åŠ¨æ€ä»£ç†ä¸‹ï¼ŒBean-çš„åˆ›å»ºè¿‡ç¨‹"><a href="#åŠ¨æ€ä»£ç†ä¸‹ï¼ŒBean-çš„åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="åŠ¨æ€ä»£ç†ä¸‹ï¼ŒBean çš„åˆ›å»ºè¿‡ç¨‹"></a>åŠ¨æ€ä»£ç†ä¸‹ï¼ŒBean çš„åˆ›å»ºè¿‡ç¨‹</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularServiceA</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String fieldA = <span class="string">&quot;å­—æ®µ A&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;æ–¹æ³• A æ‰§è¡Œ&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectA</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;execution(public void com.liuzhihang.circular.CircularServiceA.methodA())&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;beforeA æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªæœ‰ A çš„æƒ…å†µä¸‹ï¼Œç»™ A æ·»åŠ åˆ‡é¢ï¼Œå¼€å§‹ Debugã€‚</p><p>å‰é¢çš„æµç¨‹éƒ½ç›¸åŒï¼Œåœ¨ initializeBean å¼€å§‹å‡ºç°å·®å¼‚ã€‚</p><p>è¿™ä¸€æ­¥éœ€è¦åˆå§‹åŒ– Bean å¹¶æ‰§è¡Œ Bean çš„åç½®å¤„ç†å™¨ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/kbDvax-3FjpZe.png" alt="æ‰§è¡Œåç½®å¤„ç†å™¨"></p><p>å…¶ä¸­æœ‰ä¸€ä¸ªå¤„ç†å™¨ä¸ºï¼š <code>AnnotationAwareAspectJAutoProxyCreator</code> å…¶å®å°±æ˜¯åŠ çš„æ³¨è§£åˆ‡é¢ï¼Œä¼šè·³è½¬åˆ° <code>AbstractAutoProxyCreator ç±»çš„ postProcessAfterInitialization æ–¹æ³•</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/oCPVZ3-a5XbM4.png" alt="postProcessAfterInitialization"></p><p>å¦‚å›¾æ‰€ç¤ºï¼šwrapIfNecessary æ–¹æ³•ä¼šåˆ¤æ–­æ˜¯å¦æ»¡è¶³ä»£ç†æ¡ä»¶ï¼Œæ˜¯çš„è¯è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¦åˆ™è¿”å›å½“å‰ Beanã€‚</p><p>åç»­è°ƒç”¨ <code>getProxy</code> <code>ã€createAopProxy</code> ç­‰ç­‰ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ°ä¸‹é¢ä¸€éƒ¨åˆ†ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/igrrym-36KWWI.png"></p><p>æœ€ç»ˆä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼ŒAOP ä»£ç†ç›¸å…³çš„å°±ä¸ç»†çœ‹äº†ã€‚</p><p>ä¸€è·¯æ”¾è¡Œï¼Œç›´åˆ° initializeBean æ‰§è¡Œç»“æŸã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/bcpJAn-uJAqpn.png" alt="A è¢«æ›¿æ¢ä¸ºäº†ä»£ç†å¯¹è±¡"></p><p>æ­¤æ—¶å‘ç°ï¼šA è¢«æ›¿æ¢ä¸ºäº†ä»£ç†å¯¹è±¡ã€‚</p><p>æ‰€ä»¥ doCreateBean è¿”å›ï¼Œä»¥åŠåé¢æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­çš„éƒ½æ˜¯ä»£ç†å¯¹è±¡ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/LfRIEB-Do8LUy.png" alt="çº¢æ¡†éƒ¨åˆ†ä¸ºå·®å¼‚"></p><h4 id="æœ‰å¾ªç¯ä¾èµ–çš„åŠ¨æ€ä»£ç†"><a href="#æœ‰å¾ªç¯ä¾èµ–çš„åŠ¨æ€ä»£ç†" class="headerlink" title="æœ‰å¾ªç¯ä¾èµ–çš„åŠ¨æ€ä»£ç†"></a>æœ‰å¾ªç¯ä¾èµ–çš„åŠ¨æ€ä»£ç†</h4><p>è¿™ä¸€æ¬¡æŠŠå¾ªç¯ä¾èµ–æ‰“å¼€ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularServiceA</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String fieldA = <span class="string">&quot;å­—æ®µ A&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircularServiceB circularServiceB;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;æ–¹æ³• A æ‰§è¡Œ&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectA</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;execution(public void com.liuzhihang.circular.CircularServiceA.methodA())&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeA</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;beforeA æ‰§è¡Œ&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularServiceB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircularServiceA circularServiceA;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectB</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Before(&quot;execution(public void com.liuzhihang.circular.CircularServiceB.methodB())&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeB</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;beforeB æ‰§è¡Œ&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼€å§‹ Debugï¼Œå‰é¢çš„ä¸€äº›åˆ—æµç¨‹ï¼Œéƒ½å’Œæ­£å¸¸çš„æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚è€Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼Œåˆ›å»º B çš„æ—¶å€™ï¼Œéœ€è¦ä»ä¸‰çº§ç¼“å­˜è·å– Aã€‚</p><p>æ­¤æ—¶åœ¨ <code>getSingleton</code> æ–¹æ³•ä¸­ä¼šè°ƒç”¨ï¼š<code>singletonObject = singletonFactory.getObject();</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/GPjbsP-tKWmpm.png" alt="B å±æ€§èµ‹å€¼æ—¶ï¼Œä»ä¸‰çº§ç¼“å­˜è·å– A"></p><p>æœ‰æ—¶ä¼šæ¯”è¾ƒç–‘æƒ‘ <code>singletonFactory.getObject()</code> è°ƒç”¨çš„æ˜¯å“ªé‡Œï¼Ÿ</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/J3DYgB-O3XP0I.png" alt="ä¸‰çº§ç¼“å­˜è·å–å¯¹è±¡"></p><p>æ‰€ä»¥è¿™ä¸€å—è°ƒç”¨çš„æ˜¯ <code>getEarlyBeanReference</code>ï¼Œå¼€å§‹éå†æ‰§è¡Œ <code>BeanPostProcessor</code>ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/UBxYMT-FMcSHX.png" alt="getEarlyBeanReference"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/3oXKgp-5uCoST.png" alt="getEarlyBeanReference"></p><p>çœ‹åˆ° <code>wrapIfNecessary</code> å°±æ˜ç™½äº†å§ï¼è¿™å—ä¼šè·å–ä¸€ä¸ª<code>ä»£ç†å¯¹è±¡</code>ã€‚ </p><p><strong>ä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶è¿”å›ï¼Œå¹¶æ”¾åˆ°äºŒçº§ç¼“å­˜çš„æ˜¯ä¸€ä¸ª A çš„ä»£ç†å¯¹è±¡ã€‚</strong></p><p>è¿™æ · B å°±åˆ›å»ºå®Œæ¯•äº†ï¼</p><p>åˆ° A å¼€å§‹åˆå§‹åŒ–å¹¶æ‰§è¡Œåç½®å¤„ç†å™¨äº†ï¼å› ä¸º A ä¹Ÿæœ‰ä»£ç†ï¼Œæ‰€ä»¥ A ä¹Ÿä¼šæ‰§è¡Œåˆ° <code>postProcessAfterInitialization</code> è¿™ä¸€éƒ¨åˆ†ï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/STKWOC-FGcZvJ.png" alt="åˆ¤æ–­äºŒçº§ç¼“å­˜"></p><p>ä½†æ˜¯åœ¨æ‰§è¡Œ <code>wrapIfNecessary</code> ä¹‹å‰ï¼Œä¼šå…ˆåˆ¤æ–­ä»£ç†å¯¹è±¡ç¼“å­˜æ˜¯å¦æœ‰ A äº†ã€‚</p><p><code>this.earlyProxyReferences.remove(cacheKey) != bean</code></p><p>ä½†æ˜¯è¿™å—è·å–åˆ°çš„æ˜¯ A çš„ä»£ç†å¯¹è±¡ã€‚è‚¯å®šæ˜¯ false ã€‚ æ‰€ä»¥ä¸ä¼šå†ç”Ÿæˆä¸€æ¬¡ A çš„ä»£ç†å¯¹è±¡ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/iqIHlA-MYz92A.png" alt="ä»£ç† - å¾ªç¯ä¾èµ–"></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å¯ä»¥çœ‹åˆ°ï¼Œå¾ªç¯ä¾èµ–ä¸‹ï¼Œæœ‰æ²¡æœ‰ä»£ç†æƒ…å†µä¸‹çš„åŒºåˆ«å°±åœ¨ï¼š</p><p><code>singletonObject = singletonFactory.getObject();</code></p><p>åœ¨å¾ªç¯ä¾èµ–å‘ç”Ÿçš„æƒ…å†µä¸‹ B ä¸­çš„ A èµ‹å€¼æ—¶ï¼š</p><ol><li>æ— ä»£ç†ï¼šgetObject ç›´æ¥è¿”å›åŸæ¥çš„ Bean</li><li>æœ‰ä»£ç†ï¼šgetObject è¿”å›çš„æ˜¯ä»£ç†å¯¹è±¡</li></ol><p>ç„¶åéƒ½æ”¾åˆ°<strong>äºŒçº§ç¼“å­˜</strong>ã€‚</p><h4 id="ä¸ºä»€ä¹ˆè¦ä¸‰çº§ç¼“å­˜"><a href="#ä¸ºä»€ä¹ˆè¦ä¸‰çº§ç¼“å­˜" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä¸‰çº§ç¼“å­˜?"></a>ä¸ºä»€ä¹ˆè¦ä¸‰çº§ç¼“å­˜?</h4><ol><li>å‡è®¾å»æ‰ä¸‰çº§ç¼“å­˜</li></ol><p>å»æ‰ä¸‰çº§ç¼“å­˜ä¹‹åï¼ŒBean ç›´æ¥åˆ›å»º <code>earlySingletonObjects</code>ï¼Œ çœ‹ç€å¥½åƒä¹Ÿå¯ä»¥ã€‚</p><p>å¦‚æœæœ‰ä»£ç†çš„æ—¶å€™ï¼Œåœ¨ <code>earlySingletonObjects</code> ç›´æ¥æ”¾ä»£ç†å¯¹è±¡å°±è¡Œäº†ã€‚</p><p>ä½†æ˜¯ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼š<strong>åœ¨å®ä¾‹åŒ–é˜¶æ®µå°±å¾—æ‰§è¡Œåç½®å¤„ç†å™¨ï¼Œåˆ¤æ–­æœ‰ AnnotationAwareAspectJAutoProxyCreator å¹¶åˆ›å»ºä»£ç†å¯¹è±¡</strong>ã€‚</p><p>è¿™ä¹ˆä¸€æƒ³ï¼Œæ˜¯ä¸æ˜¯ä¼šå¯¹ Bean çš„ç”Ÿå‘½å‘¨æœŸæœ‰å½±å“ã€‚</p><p>åŒæ ·ï¼Œå…ˆåˆ›å»º <code>singletonFactory</code> çš„å¥½å¤„å°±æ˜¯ï¼š<strong>åœ¨çœŸæ­£éœ€è¦å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå†ä½¿ç”¨ singletonFactory.getObject() è·å– Bean æˆ–è€… Bean çš„ä»£ç†</strong>ã€‚ç›¸å½“äºæ˜¯å»¶è¿Ÿå®ä¾‹åŒ–ã€‚</p><ol start="2"><li>å‡è®¾å»æ‰äºŒçº§ç¼“å­˜</li></ol><p>å¦‚æœå»æ‰äº†äºŒçº§ç¼“å­˜ï¼Œåˆ™éœ€è¦ç›´æ¥åœ¨ <code>singletonFactory.getObject()</code> é˜¶æ®µåˆå§‹åŒ–å®Œæ¯•ï¼Œå¹¶æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/AxHpdh-HXV06Z.png" alt="B å’Œ C éƒ½ä¾èµ– A"></p><p>é‚£æœ‰è¿™ä¹ˆä¸€ç§åœºæ™¯ï¼ŒB å’Œ C éƒ½ä¾èµ–äº† Aã€‚</p><p>è¦çŸ¥é“åœ¨æœ‰ä»£ç†çš„æƒ…å†µä¸‹ <code>singletonFactory.getObject()</code> è·å–çš„æ˜¯ä»£ç†å¯¹è±¡ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/BCNbfb-9D6nlz.png" alt="å¤šæ¬¡è·å–ä»£ç†å¯¹è±¡ä¸åŒ"></p><p>è€Œå¤šæ¬¡è°ƒç”¨ <code>singletonFactory.getObject()</code> è¿”å›çš„ä»£ç†å¯¹è±¡æ˜¯ä¸åŒçš„ï¼Œå°±ä¼šå¯¼è‡´ B å’Œ C ä¾èµ–äº†ä¸åŒçš„ Aã€‚</p><p>é‚£å¦‚æœè·å– B åˆ°ä¹‹åç›´æ¥æ”¾åˆ°ä¸€çº§ç¼“å­˜ï¼Œç„¶å C å†è·å–å‘¢ï¼Ÿ</p><p>ğŸ˜³ â€¦â€¦ </p><p>ä¸€çº§ç¼“å­˜æ”¾çš„æ˜¯å·²ç»åˆå§‹åŒ–å®Œæ¯•çš„ Beanï¼Œè¦çŸ¥é“ A ä¾èµ–äº† B å’Œ C ï¼ŒA è¿™æ—¶å€™è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæ¯•ã€‚</p><h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>å¾ªç¯ä¾èµ–çš„åœºæ™¯æœ‰å¾ˆå¤šï¼Œæœ¬æ–‡åªæ˜¯é€šè¿‡ Debug ï¼Œæ¥äº†è§£åˆ°å¾ªç¯ä¾èµ–å’Œ AOP ä¹‹é—´çš„å…³ç³»ï¼Œä»¥åŠäº†è§£åˆ°ä¸ºä»€ä¹ˆè¦ç”¨ä¸‰çº§ç¼“å­˜ã€‚</p><p>å½“ç„¶ï¼ŒSpring è®¾è®¡ä¹‹åˆæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿå¦‚ä½•ä¸€æ­¥ä¸€æ­¥å‘å±•æˆç°åœ¨è¿™ç§çš„ï¼Ÿ</p><p>è‚¯å®šæ˜¯ä¸èƒ½æ…¢æ…¢å»ç ”ç©¶äº†ï¼Œæ‰€ä»¥åªèƒ½ä»¥ç°åœ¨çš„ç‰ˆæœ¬ï¼Œå»æ£æµ‹ä½œè€…çš„æ„å›¾ã€‚</p><p>ä¸è¶³ä¹‹å¤„ï¼Œå¤šå¤šæŒ‡æ­£ã€‚</p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/UlUQ95gVt8I8wmVOEjn1aw">Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ</a></li><li><a href="https://mp.weixin.qq.com/s/qZ4xXlqpNzsdHkvFm02Yuw">Spring æºç å­¦ä¹  16ï¼šå•ä¾‹ Bean åˆ›å»º</a></li><li><a href="https://mp.weixin.qq.com/s/FhWdwroo7ipN1nzgvNpshA">Spring æºç å­¦ä¹  15ï¼šfinishBeanFactoryInitializationï¼ˆé‡ç‚¹ï¼‰</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ</title>
      <link href="2021/01/23/source-spring-circular-dependence-1.html"/>
      <url>2021/01/23/source-spring-circular-dependence-1.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´åœ¨å·¥ä½œä¸­éƒ½ä¼šé‡åˆ°å¾ªç¯ä¾èµ–ï¼Œä¸è¿‡å¤§å¤šæ•°å®ƒæ˜¯è¿™æ ·æ˜¾ç¤ºçš„ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/F0EjJ0-cjS89L.png"></p><p>è¿˜ä¼šæç¤ºè¿™ä¹ˆä¸€å¥ï¼š</p><p><em>Requested bean is currently in creation: Is there an unresolvable circular reference?</em></p><p>è€é“ï¼è¿™å°±æ˜¯å‘ç”Ÿå¾ªç¯ä¾èµ–äº†ï¼</p><p>å½“ç„¶è¿™é‡Œæ˜¯ä¸€ä¸ªå¼‚å¸¸æƒ…å†µã€‚</p><p>åœ¨æˆ‘çš„ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»å¦‚ä½•é¿å… <a href="https://mp.weixin.qq.com/s/Hn3C5a_hNPcscB93XlFO8Q">Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆ</a>ï¼Œå…¶ä¸­ç½‘å‹ç»™å»ºè®®ï¼Œè¯´å¯ä»¥åœ¨ç±»ä¸­æ³¨å…¥è‡ªèº«ï¼Œç„¶åè°ƒç”¨ï¼Œè€Œæ³¨å…¥è‡ªèº«çš„è¿‡ç¨‹ä¹Ÿæ˜¯å¾ªç¯ä¾èµ–çš„å¤„ç†è¿‡ç¨‹ã€‚</p><p>ä¸‹é¢å°±ä¸€èµ·çœ‹ä¸€çœ‹ï¼Œä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Œä»¥åŠ Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ</p><h3 id="ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–"><a href="#ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–" class="headerlink" title="ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–"></a>ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/vinf1u-ALdO65.png" alt="Circular dependencies"></p><p><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-dependency-resolution" title="Spring å®˜æ–¹æ–‡æ¡£">Dependency Resolution Process</a></p><blockquote><p>Spring IoC å®¹å™¨ä¼šåœ¨è¿è¡Œæ—¶æ£€æµ‹åˆ°<strong>æ„é€ å‡½æ•°æ³¨å…¥</strong>å¾ªç¯å¼•ç”¨ï¼Œå¹¶æŠ›å‡º BeanCurrentlyInCreationExceptionã€‚</p><p>æ‰€ä»¥è¦é¿å…æ„é€ å‡½æ•°æ³¨å…¥ï¼Œå¯ä»¥ä½¿ç”¨ setter æ³¨å…¥æ›¿ä»£ã€‚</p></blockquote><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£è¯´æ˜ï¼ŒSpring ä¼šè‡ªåŠ¨è§£å†³åŸºäº setter æ³¨å…¥çš„å¾ªç¯ä¾èµ–ã€‚</p><p>å½“ç„¶åœ¨å’±ä»¬å·¥ä½œä¸­ç°åœ¨éƒ½ä½¿ç”¨ <code>@Autowired</code> æ³¨è§£æ¥æ³¨å…¥å±æ€§ã€‚</p><blockquote><p>PS: @Autowired æ˜¯é€šè¿‡åå°„è¿›è¡Œèµ‹å€¼ã€‚</p></blockquote><p>è¿™é‡Œä»æˆ‘ä»¬æœ€ç»å¸¸ä½¿ç”¨çš„åœºæ™¯åˆ‡å…¥ï¼Œçœ‹ Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ</p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularServiceA</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircularServiceB circularServiceB;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularServiceB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircularServiceC circularServiceC;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularServiceC</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircularServiceA circularServiceA;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ Aã€Bã€C ä¸‰ä¸ªç±»ï¼Œå¯ä»¥çœ‹åˆ°å‘ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/2G8CEa-rstD88.png" alt="å¾ªç¯ä¾èµ–"></p><p>ä½†æ˜¯å³ä½¿å‘ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥å¯åŠ¨ OKï¼Œä½¿ç”¨å¹¶æ²¡æœ‰ä»»ä½•å½±å“ã€‚</p><h3 id="Spring-æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„"><a href="#Spring-æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„" class="headerlink" title="Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„"></a>Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„</h3><p>åœ¨ <a href="https://mp.weixin.qq.com/s/qZ4xXlqpNzsdHkvFm02Yuw">Spring å•ä¾‹ Bean çš„åˆ›å»º</a> ä¸­ä»‹ç»ä»‹ç»äº†ä½¿ç”¨ä¸‰çº§ç¼“å­˜ã€‚</p><blockquote><p>singletonObjectsï¼š ä¸€çº§ç¼“å­˜ï¼Œå­˜å‚¨å•ä¾‹å¯¹è±¡ï¼ŒBean å·²ç»å®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–å®Œæˆã€‚</p><p>earlySingletonObjectsï¼š äºŒçº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonObjectï¼Œè¿™ä¸ª Bean å®ä¾‹åŒ–äº†ï¼Œè¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚</p><p>singletonFactoriesï¼š ä¸‰çº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonFactoryã€‚</p></blockquote><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/KS60bs-aWqhoU.png"></p><p>å½“ç„¶ï¼Œè¿™é‡Œçœ‹ç€æ¯”è¾ƒé•¿ï¼Œå¯ä»¥ç®€åŒ–ä¸€ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/1QnEIw-1agsnx.png"></p><h3 id="é€šè¿‡-Debug-æ¥è¯´æ˜ç”Ÿæˆè¿‡ç¨‹"><a href="#é€šè¿‡-Debug-æ¥è¯´æ˜ç”Ÿæˆè¿‡ç¨‹" class="headerlink" title="é€šè¿‡ Debug æ¥è¯´æ˜ç”Ÿæˆè¿‡ç¨‹"></a>é€šè¿‡ Debug æ¥è¯´æ˜ç”Ÿæˆè¿‡ç¨‹</h3><p>ä» preInstantiateSingletons æ–¹æ³•å¼€å§‹ï¼š</p><p>æ·»åŠ æ–­ç‚¹ <code>beanName.equals(&quot;circularServiceA&quot;)</code></p><p>å¯åŠ¨Debugï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/SYoDdM-0pgCsu.png" alt="Start"></p><p>ä¼šä»ç¼“å­˜ä¸­è·å–å•ä¾‹ Bean </p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/AeMsAm-KnFiZA.png"></p><p>è¿™é‡Œå¾ˆæ˜¾ç„¶è·å–ä¸åˆ°ï¼Œç»§ç»­æ‰§è¡Œï¼Œåˆ›å»ºå•ä¾‹å®ä¾‹</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/JRFOxl-Tsbi9H.png"></p><p>å‘ç°æ˜¯å•ä¾‹å†æ¬¡è·å–</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/YWcgWk-90K6tS.png"></p><p>è¿™é‡Œè¿˜ä¼šä»ä¸€çº§ç¼“å­˜è·å–ä¸€æ¬¡ <code>circularServiceA</code> ï¼Œ æ²¡æœ‰è·å–åˆ°ï¼Œå°† <code>circularServiceA</code> æ·»åŠ åˆ°åœ¨åˆ›å»ºçš„æ± å­é‡Œé¢ ï¼ˆsingletonsCurrentlyInCreation æ˜¯ä¸€ä¸ª set é›†åˆï¼‰ã€‚</p><p>ç„¶åä¼šè°ƒç”¨å·¥å‚æ–¹æ³• createBean(beanName, mbd, args) åˆ›å»ºå¯¹è±¡ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/MnA2Db-juxIN7.png" alt="createBean æ–¹æ³•"></p><p>åœ¨ createBean ä¸­å»å®ä¾‹åŒ– Bean ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/kVo7G6-DAtYGM.png"></p><p>åˆ¤æ–­æ˜¯å¦æ˜¯å¾ªç¯å¼•ç”¨ï¼Œæ˜¯çš„è¯éœ€è¦æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ä¸­ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/iRDZbq-4fZA5S.png" alt="æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜"></p><p><code>circularServiceA</code> ä¸åœ¨ä¸€çº§ç¼“å­˜ä¸­ï¼Œåˆ™å°† <code>circularServiceA</code> çš„ singletonFactory æ·»åŠ åˆ° ä¸‰çº§ç¼“å­˜ ï¼ˆsingletonFactoriesï¼‰ ä¸­ï¼ŒåŒæ—¶ä»äºŒçº§ç¼“å­˜ä¸­ç§»é™¤ã€‚</p><p>åˆ°è¿™ä¸€æ­¥ä¸ºæ­¢ï¼ŒcircularServiceA å·²ç»åœ¨ä¸‰çº§ç¼“å­˜ä¸­äº†ã€‚</p><p>å¼€å§‹å¯¹ Bean çš„å±æ€§è¿›è¡Œèµ‹å€¼ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/oZ70es-2WsKdT.png" alt="å±æ€§èµ‹å€¼"></p><p>åœ¨ populateBean æ–¹æ³•ä¸­æ‰§è¡Œåˆ°</p><p><code>PropertyValues pvsToUse = bp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);</code> </p><p>å°±ä¼šå¯¹å±æ€§è¿›è¡Œèµ‹å€¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ZjKmVC-J3xIl5.png" alt="å±æ€§èµ‹å€¼"></p><p>åœ¨ injet æ–¹æ³•ä¸­ï¼Œå›å»è§£å†³ç›¸å…³ä¾èµ–ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/EnkUit-T1uQvh.png" alt="è§£å†³ä¾èµ–"></p><p>ç»§ç»­ Debug ï¼Œå‘ç°è§£å†³ä¾èµ–ï¼Œæœ€åå‘ç°å…¶å®åˆè°ƒç”¨å› <code>beanFactory.getBean(beanName);</code> </p><p>ä¸è¿‡è¿™æ¬¡åˆ›å»ºçš„æ˜¯ <code>circularServiceB</code>ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/WuKewa-ACO0Ae.png"></p><p>ä¸‹é¢æ˜¯è°ƒç”¨é“¾ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ykN9uD-2XrZUz.png" alt="è°ƒç”¨é“¾"></p><p><code>circularServiceB</code> çš„è¿‡ç¨‹å’Œ <code>circularServiceA</code> çš„ä¸€æ ·ï¼Œä¹Ÿæ˜¯åˆ›å»ºäº†ä¸‰çº§ç¼“å­˜ï¼Œç„¶åå»åˆ›å»º <code>circularServiceC</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/VdfOIS-SUo0Fz.png" alt="singletionFactories"></p><p>è¿™æ—¶å€™ä¸‰çº§ç¼“å­˜é‡Œé¢æœ‰å®ƒä»¬ä¸‰ä¸ªçš„ singletonFactory ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/6px7bF-uBnMnF.png"></p><p><code>circularServiceC</code> ä¹Ÿè°ƒç”¨åˆ° doGetBean æ–¹æ³•å»è·å– <code>circularServiceA</code></p><p>ä¸è¿‡è¿™æ¬¡ è°ƒç”¨åˆ° <code>Object sharedInstance = getSingleton(beanName);</code> çš„æ—¶å€™, <code>circularServiceA</code> å·²ç»å­˜åœ¨äº†ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/EHvsaz-wEqbsG.png"></p><p>è¿™æ¬¡è°ƒç”¨è™½ç„¶æ²¡æœ‰ä»ä¸€çº§ç¼“å­˜ ï¼ˆsingletonObjectsï¼‰ ä¸­è·å–åˆ° circularServiceAï¼Œä½†æ˜¯ <code>circularServiceA</code> åœ¨<strong>åˆ›å»ºä¸­</strong>ï¼Œæ‰€ä»¥è¿›å…¥åˆ¤æ–­</p><p>åœ¨è¿™é‡Œæ‰§è¡Œå®Œä¹‹åï¼Œ <code>circularServiceA</code> ä»ä¸‰çº§ç¼“å­˜å‡çº§åˆ°äºŒçº§ç¼“å­˜</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/wXvq02-Ayomqs.png"></p><p>ä½¿ç”¨åå°„å¯¹ <code>circularServiceC</code> ä¸­çš„ <code>circularServiceA</code> è¿›è¡Œèµ‹å€¼ï¼Œ æ­¤æ—¶ <code>circularServiceA</code> æ˜¯åœ¨ äºŒçº§ç¼“å­˜ä¸­ã€‚</p><p><strong>é‚£å°±æ¯”è¾ƒå¥½å¥‡äº†ï¼Œè¿™æ—¶å€™ circularServiceC é‡Œé¢çš„ circularServiceA å·²ç»é€šè¿‡åå°„èµ‹å€¼ï¼Œè¿™ä¸ªèµ‹å€¼ç»™çš„æ˜¯ä»€ä¹ˆå€¼ï¼Ÿ</strong></p><p>æŸ¥çœ‹ä»£ç ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/WdGk05-KZ94hA.png"></p><p>è¿™å—æ˜¯ä»ä¸‰çº§ç¼“å­˜ï¼ˆsingletonFactoriesï¼‰ä¸­è·å–çš„ singletonObjectï¼Œç„¶åè°ƒç”¨</p><p><code>singletonObject = singletonFactory.getObject();</code> </p><p>è·å–çš„ä¸€ä¸ªå¯¹è±¡</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ZlcQGZ-tKDGNM.png"></p><p>è¿™é‡Œè·å–åˆ°çš„æ˜¯ circularServiceA çš„å¼•ç”¨ï¼Œæ³¨æ„ circularServiceA è¿™æ—¶å€™è¿˜æ²¡åˆ›å»ºå®Œæˆï¼Œåªæ˜¯å¼•ç”¨ã€‚æ‰€ä»¥è¿™é‡Œèµ‹å€¼çš„æ˜¯ circularServiceA çš„å¼•ç”¨ã€‚</p><p>åˆ°è¿™é‡Œ <code>circularServiceC</code> å°±åˆ›å»ºå®Œäº†ã€‚</p><p>ç„¶åä¼šå°† C æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜å’Œå·²æ³¨å†Œåˆ—è¡¨ä¸­ï¼ŒåŒæ—¶ä»äºŒçº§ä¸‰çº§ç¼“å­˜ä¸­åˆ é™¤ Cã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/fcNkmJ-fth6DQ.png"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/QwK4yN-dbrlQj.png"></p><p>ç»§ç»­æ‰§è¡Œ B å’Œ A çš„å±æ€§èµ‹å€¼ä»¥åŠåç»­çš„åˆå§‹åŒ–æµç¨‹ã€‚</p><p>è‡³æ­¤ï¼Œå¾ªç¯ä¾èµ–è§£å†³å®Œæ¯•ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>Spring ä½¿ç”¨ä¸‰çº§ç¼“å­˜æ¥è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œä¸‰çº§ç¼“å­˜åˆ†åˆ«æ˜¯ï¼š</p><ul><li><p><strong>singletonObjectsï¼š</strong> ä¸€çº§ç¼“å­˜ï¼Œå­˜å‚¨å•ä¾‹å¯¹è±¡ï¼ŒBean å·²ç»å®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–å®Œæˆã€‚</p></li><li><p><strong>earlySingletonObjectsï¼š</strong> äºŒçº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonObjectï¼Œè¿™ä¸ª Bean å®ä¾‹åŒ–äº†ï¼Œè¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚</p></li><li><p><strong>singletonFactoriesï¼š</strong> ä¸‰çº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonFactoryã€‚</p></li></ul><p>æœ¬æ–‡ä¹Ÿé€šè¿‡ Debug æ¥éªŒè¯äº†ä½¿ç”¨ä¸‰çº§ç¼“å­˜è§£å†³ä¾èµ–çš„è¿‡ç¨‹ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/1QnEIw-1agsnx.png"></p><p>ä¸è¿‡è¿˜æœ‰ä¸€äº›é—®é¢˜æ²¡æœ‰è¯´æ˜ï¼š</p><ol><li>å¾ªç¯ä¾èµ–å’Œä»£ç†ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿæ¯”å¦‚ @Transactional å’Œ @Async æ³¨è§£ä¼šå¯¹å¾ªç¯ä¾èµ–äº§ç”Ÿä»€ä¹ˆå½±å“ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆè¦ç”¨ä¸‰çº§ç¼“å­˜ï¼ŸäºŒçº§ç¼“å­˜ä¸å¯ä»¥ä¹ˆï¼Ÿ</li></ol><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/qZ4xXlqpNzsdHkvFm02Yuw">Spring æºç å­¦ä¹  16ï¼šå•ä¾‹ Bean åˆ›å»º</a></li><li><a href="https://mp.weixin.qq.com/s/MAlT1Y5MVmEclAZC6rgojQ">Spring æºç å­¦ä¹  15ï¼šfinishBeanFactoryInitializationï¼ˆé‡ç‚¹ï¼‰</a></li><li><a href="https://mp.weixin.qq.com/s/bKmqVFuLLLCquWf3tzH30g">Spring æºç å­¦ä¹  14ï¼šinitApplicationEventMulticaster</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  16ï¼šå•ä¾‹ Bean åˆ›å»º</title>
      <link href="2021/01/17/source-spring-16.html"/>
      <url>2021/01/17/source-spring-16.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>åœ¨ finishBeanFactoryInitialization ä¸­ä»‹ç»äº†åˆ›å»º Bean çš„æµç¨‹å¤§æ¦‚æµç¨‹ï¼Œè¿™é‡Œè¿›å…¥å•ä¾‹ Bean çš„åˆ›å»ºè¿‡ç¨‹ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/U1LzL3-cy2ZtW.png"></p><p>è¿™é‡Œä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†åˆ›å»ºå•ä¾‹ Bean</p><ol><li>getSingleton</li><li>createBean</li><li>getObjectForBeanInstance</li></ol><p>ä¸‹é¢è¿›å…¥æºç ï¼š</p><h3 id="getSingleton"><a href="#getSingleton" class="headerlink" title="getSingleton"></a>getSingleton</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">    Assert.notNull(beanName, <span class="string">&quot;Bean name must not be null&quot;</span>);</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥ singletonObjects ç¼“å­˜ä¸­æ˜¯å¦æœ‰</span></span><br><span class="line">        Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ£€æŸ¥æ˜¯å¦åœ¨æ‰§è¡Œé”€æ¯</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.singletonsCurrentlyInDestruction) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationNotAllowedException(beanName,</span><br><span class="line">                        <span class="string">&quot;Singleton bean creation not allowed while singletons of this factory are in destruction &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Creating shared instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°† Bean æ·»åŠ åˆ° singletonsCurrentlyInCreation é›†åˆä¸­, è¡¨ç¤ºæ­£åœ¨åˆ›å»º</span></span><br><span class="line">            beforeSingletonCreation(beanName);</span><br><span class="line">            <span class="keyword">boolean</span> newSingleton = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">boolean</span> recordSuppressedExceptions = (<span class="keyword">this</span>.suppressedExceptions == <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (recordSuppressedExceptions) &#123;</span><br><span class="line">                <span class="keyword">this</span>.suppressedExceptions = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨å·¥å‚æ–¹æ³•</span></span><br><span class="line">                <span class="comment">// ä¹Ÿå°±æ˜¯è°ƒç”¨ createBean(beanName, mbd, args)</span></span><br><span class="line">                singletonObject = singletonFactory.getObject();</span><br><span class="line">                newSingleton = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">                <span class="comment">// Has the singleton object implicitly appeared in the meantime -&gt;</span></span><br><span class="line">                <span class="comment">// if yes, proceed with it since the exception indicates that state.</span></span><br><span class="line">                singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (BeanCreationException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (recordSuppressedExceptions) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (Exception suppressedException : <span class="keyword">this</span>.suppressedExceptions) &#123;</span><br><span class="line">                        ex.addRelatedCause(suppressedException);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (recordSuppressedExceptions) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.suppressedExceptions = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åˆ›å»ºæˆåŠŸ, ä» singletonsCurrentlyInCreation ç§»é™¤</span></span><br><span class="line">                afterSingletonCreation(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (newSingleton) &#123;</span><br><span class="line">                <span class="comment">// å°†ç»™å®šçš„å•ä¾‹å¯¹è±¡æ·»åŠ åˆ°è¯¥å·¥å‚çš„å•ä¾‹ç¼“å­˜ä¸­</span></span><br><span class="line">                <span class="comment">// this.singletonObjects.put(beanName, singletonObject);</span></span><br><span class="line">                <span class="comment">// this.singletonFactories.remove(beanName);</span></span><br><span class="line">                <span class="comment">// this.earlySingletonObjects.remove(beanName);</span></span><br><span class="line">                <span class="comment">// this.registeredSingletons.add(beanName);</span></span><br><span class="line">                addSingleton(beanName, singletonObject);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singletonObject;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›ä»¥ç»™å®šåç§°æ³¨å†Œçš„ï¼ˆåŸå§‹ï¼‰å•ä¾‹å¯¹è±¡ï¼Œå¦‚æœå°šæœªæ³¨å†Œï¼Œåˆ™åˆ›å»ºå¹¶æ³¨å†Œä¸€ä¸ªæ–°å¯¹è±¡ã€‚</p><p>è¿™ä¸€å—ä¸€å…±å¯ä»¥æ‹†æˆä¸‰éƒ¨åˆ†æ¥ç†è§£ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/6KBL1X-ZvNhzi.png"></p><h4 id="1-ä»ç¼“å­˜ä¸­è·å–-singletonObjects"><a href="#1-ä»ç¼“å­˜ä¸­è·å–-singletonObjects" class="headerlink" title="1. ä»ç¼“å­˜ä¸­è·å– singletonObjects"></a>1. ä»ç¼“å­˜ä¸­è·å– singletonObjects</h4><p><code>singletonObject</code> æ˜¯ä»€ä¹ˆï¼Ÿ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Cache of singleton objects: bean name to bean instance. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br></pre></td></tr></table></figure><p><code>singletonObjects</code> æ˜¯ä¸€ä¸ª ConcurrentHashMapï¼Œ ç”¨æ¥ç¼“å­˜å•ä¾‹å¯¹è±¡çš„å®ä¾‹ã€‚</p><h4 id="2-åˆ›å»º-singletonObject"><a href="#2-åˆ›å»º-singletonObject" class="headerlink" title="2. åˆ›å»º singletonObject"></a>2. åˆ›å»º singletonObject</h4><p>åœ¨ä»ç¼“å­˜ä¸­æ²¡æœ‰è·å–åˆ° <code>singletonObject</code> ï¼Œåˆ›å»ºæ–°çš„å¯¹è±¡</p><p><code>singletonObject = singletonFactory.getObject();</code> </p><p>è¿™ä¸€æ­¥å…¶å®å°±æ˜¯è°ƒç”¨å¤–è¾¹çš„ <code>createBean(beanName, mbd, args)</code> æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¥å‚æ–¹æ³•ã€‚ é€šè¿‡ <code>createBean</code> æ–¹æ³•ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>singletonObject</code>ã€‚</p><h4 id="3-å°†åˆ›å»ºçš„-singletonObject-æ·»åŠ åˆ°ç¼“å­˜ä¸­"><a href="#3-å°†åˆ›å»ºçš„-singletonObject-æ·»åŠ åˆ°ç¼“å­˜ä¸­" class="headerlink" title="3. å°†åˆ›å»ºçš„ singletonObject æ·»åŠ åˆ°ç¼“å­˜ä¸­"></a>3. å°†åˆ›å»ºçš„ singletonObject æ·»åŠ åˆ°ç¼“å­˜ä¸­</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingleton</span><span class="params">(String beanName, Object singletonObject)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">        <span class="keyword">this</span>.singletonObjects.put(beanName, singletonObject);</span><br><span class="line">        <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">        <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">        <span class="comment">// å·²ç»æˆåŠŸåˆ›å»ºçš„å•ä¾‹</span></span><br><span class="line">        <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥æ¶‰åŠåˆ°ä¸‰ä¸ªç¼“å­˜ï¼Œä»¥åŠä¸€ä¸ªæˆåŠŸåˆ›å»ºçš„å•ä¾‹åˆ—è¡¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Cache of singleton objects: bean name to bean instance. */</span></span><br><span class="line"><span class="comment">/** ç¼“å­˜å•ä¾‹å¯¹è±¡ï¼Œ K-V -&gt; BeanName - Bean å®ä¾‹ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of singleton factories: bean name to ObjectFactory. */</span></span><br><span class="line"><span class="comment">/** ç¼“å­˜ Bean å·¥å‚ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of early singleton objects: bean name to bean instance. */</span></span><br><span class="line"><span class="comment">/** ç¼“å­˜æ—©æœŸå•ä¾‹å¯¹è±¡ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Set of registered singletons, containing the bean names in registration order. */</span></span><br><span class="line"><span class="comment">/** å·²æ³¨å†Œçš„å•ä¾‹åˆ—è¡¨ï¼ŒæŒ‰æ³¨å†Œé¡ºåºä¿å­˜ BeanNameã€‚ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; registeredSingletons = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">256</span>);</span><br></pre></td></tr></table></figure><p>å°†åˆ›å»ºçš„å•ä¾‹å¯¹è±¡ï¼Œæ·»åŠ åˆ°<code>å•ä¾‹ç¼“å­˜</code>ä¸­ï¼ŒåŒæ—¶å°†<code>å·¥å‚ç¼“å­˜</code>ä»¥åŠ<code>æ—©æœŸå•ä¾‹å¯¹è±¡ç¼“å­˜</code>ä¸­çš„å¯¹åº”å¯¹è±¡åˆ é™¤ã€‚</p><h3 id="createBean"><a href="#createBean" class="headerlink" title="createBean"></a>createBean</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    RootBeanDefinition mbdToUse = mbd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure bean class is actually resolved at this point, and</span></span><br><span class="line">    <span class="comment">// clone the bean definition in case of a dynamically resolved Class</span></span><br><span class="line">    <span class="comment">// which cannot be stored in the shared merged bean definition.</span></span><br><span class="line">    <span class="comment">// è·å–çœŸå®çš„ç±»å‹</span></span><br><span class="line">    Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</span><br><span class="line">    <span class="keyword">if</span> (resolvedClass != <span class="keyword">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ–°çš„ mbd é˜²æ­¢ å…¶ä»–çº¿ç¨‹ä¿®æ”¹</span></span><br><span class="line">        mbdToUse = <span class="keyword">new</span> RootBeanDefinition(mbd);</span><br><span class="line">        mbdToUse.setBeanClass(resolvedClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare method overrides.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// éªŒè¯å¹¶å‡†å¤‡ä¸ºæ­¤beanå®šä¹‰çš„æ–¹æ³•æ›¿ä»£ã€‚ æ£€æŸ¥æ˜¯å¦å­˜åœ¨å…·æœ‰æŒ‡å®šåç§°çš„æ–¹æ³•ã€‚</span></span><br><span class="line">        mbdToUse.prepareMethodOverrides();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(mbdToUse.getResourceDescription(),</span><br><span class="line">                beanName, <span class="string">&quot;Validation of method overrides failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span></span><br><span class="line">        <span class="comment">// åº”ç”¨å®ä¾‹åŒ–ä¹‹å‰çš„åå¤„ç†å™¨ï¼Œä»¥è§£å†³æŒ‡å®šçš„beanæ˜¯å¦å­˜åœ¨å®ä¾‹åŒ–å¿«æ·æ–¹å¼ã€‚</span></span><br><span class="line">        <span class="comment">// InstantiationAwareBeanPostProcessor åç½®å¤„ç†å™¨ </span></span><br><span class="line">        <span class="comment">// postProcessBeforeInstantiation æ–¹æ³•å¯èƒ½ä¼šå·²ç»å®ä¾‹åŒ– Bean</span></span><br><span class="line">        Object bean = resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line">        <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbdToUse.getResourceDescription(), beanName,</span><br><span class="line">                <span class="string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ– Bean</span></span><br><span class="line">        Object beanInstance = doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanInstance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;</span><br><span class="line">        <span class="comment">// A previously detected exception with proper bean creation context already,</span></span><br><span class="line">        <span class="comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span></span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                mbdToUse.getResourceDescription(), beanName, <span class="string">&quot;Unexpected exception during bean creation&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¸­æ¶‰åŠåˆ°ï¼šåˆ›å»º Bean å®ä¾‹ , å¡«å…… Bean , åº”ç”¨ PostProcessorã€‚</p><p>å…¶ä¸­å®ä¾‹åŒ– Bean æ˜¯åœ¨ <code>doCreateBean</code> ä¸­ã€‚ç°åœ¨é‡ç‚¹çœ‹ä¸€ä¸‹ <code>doCreateBean</code> æ–¹æ³•ã€‚</p><h4 id="doCreateBean"><a href="#doCreateBean" class="headerlink" title="doCreateBean"></a>doCreateBean</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate the bean.</span></span><br><span class="line">    <span class="comment">// Bean çš„ å¯¹è±¡åŒ…è£…</span></span><br><span class="line">    BeanWrapper instanceWrapper = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">        <span class="comment">// ä»ç¼“å­˜ä¸­è·å–</span></span><br><span class="line">        instanceWrapper = <span class="keyword">this</span>.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜ä¸­è·å–ä¸åˆ°åˆ™ç›´æ¥åˆ›å»º, è¿™é‡Œåˆ›å»ºçš„ BeanInstance !!!</span></span><br><span class="line">        instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å– Bean å®ä¾‹ä»¥åŠç±»å‹</span></span><br><span class="line">    Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">    Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">    <span class="keyword">if</span> (beanType != NullBean.class) &#123;</span><br><span class="line">        mbd.resolvedTargetType = beanType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow post-processors to modify the merged bean definition.</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mbd.postProcessed) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœå…è®¸ä¿®æ”¹ mbd</span></span><br><span class="line">                <span class="comment">// è°ƒç”¨ MergedBeanDefinitionPostProcessor åç½®å¤„ç†å™¨çš„</span></span><br><span class="line">                <span class="comment">// postProcessMergedBeanDefinition(mbd, beanType, beanName);</span></span><br><span class="line">                applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                        <span class="string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            mbd.postProcessed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></span><br><span class="line">    <span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span><br><span class="line">    <span class="comment">// mbd æ˜¯å•ä¾‹ ä¸” å…è®¸å¾ªç¯å¼•ç”¨, (é»˜è®¤ true) ä¸”åœ¨åˆ›å»º</span></span><br><span class="line">    <span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">            isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">    <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                    <span class="string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å…ˆè·å– ä¹‹å‰çš„ Bean çš„å¼•ç”¨, ä» beanPostProcessorCache ä¸­ è·å– SmartInstantiationAwareBeanPostProcessor</span></span><br><span class="line">        <span class="comment">// ç„¶åä» SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference è·å–ä¹‹å‰çš„å¼•ç”¨</span></span><br><span class="line">        addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize the bean instance.</span></span><br><span class="line">    Object exposedObject = bean;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å±æ€§èµ‹å€¼</span></span><br><span class="line">        populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">        <span class="comment">// æ‰§è¡Œ init æ–¹æ³•</span></span><br><span class="line">        exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (BeanCreationException) ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                    mbd.getResourceDescription(), beanName, <span class="string">&quot;Initialization of bean failed&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œå…è®¸å¾ªç¯ä¾èµ–</span></span><br><span class="line">    <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">        <span class="comment">// è·å–æ—©æœŸçš„ Bean, å¦‚æœæ²¡æœ‰å¾ªç¯ä¾èµ– åˆ™è·å–ä¸åˆ°</span></span><br><span class="line">        Object earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æœ‰å¾ªç¯ä¾èµ–</span></span><br><span class="line">        <span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºçš„æ˜¯ä¸æ˜¯åŒä¸€ä¸ªï¼Œå¯èƒ½ä¼šæœ‰ä»£ç†å¯¹è±¡</span></span><br><span class="line">            <span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">                exposedObject = earlySingletonReference;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">                <span class="comment">// è·å–ä¾èµ–çš„ Bean å¹¶ å¾ªç¯æ”¾å…¥åˆ° actualDependentBeans</span></span><br><span class="line">                String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">                Set&lt;String&gt; actualDependentBeans = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(dependentBeans.length);</span><br><span class="line">                <span class="keyword">for</span> (String dependentBean : dependentBeans) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">                        actualDependentBeans.add(dependentBean);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName,</span><br><span class="line">                            <span class="string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; has been injected into other beans [&quot;</span> +</span><br><span class="line">                            StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</span><br><span class="line">                            <span class="string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register bean as disposable.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ³¨å†Œé”€æ¯æ–¹æ³•</span></span><br><span class="line">        registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                mbd.getResourceDescription(), beanName, <span class="string">&quot;Invalid destruction signature&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·æ˜¯ä»£ç å¾ˆé•¿å¾ˆé•¿ï¼</p><p>åˆ†æ­¥éª¤é˜…è¯»ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/tx0C4e-zD6xG0.png"></p><p>å¦‚æœè¿™ä¸ª Bean æ˜¯å•ä¾‹ Bean ä¸”å…è®¸å¾ªç¯å¼•ç”¨ä¸”åœ¨åˆ›å»ºä¸­ï¼Œåˆ™è¯´æ˜åœ¨æœ‰å¾ªç¯å¼•ç”¨ã€‚åˆ™è°ƒç”¨ï¼š</p><p><code>addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</code></p><p>è¿™ä¸€è¡Œä»£ç æ¶‰åŠåˆ°ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ <code>getEarlyBeanReference</code> å’Œ <code>addSingletonFactory</code></p><ul><li>getEarlyBeanReference</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/vWP5Jt-tsa92g.png"></p><ul><li>addSingletonFactory</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/uvUVh4-TWy5l0.png"></p><p>è¿™ä¸€å—å¯ä»¥çœ‹åˆ°å°†åˆ›å»ºçš„ä¸€ä¸ªå•ä¾‹å¯¹è±¡çš„ <code>singletonFactory</code> æ·»åŠ åˆ°äº† <code>singletonFactories</code> ç¼“å­˜ä¸­ã€‚</p><p>åŒæ—¶å°† <code>earlySingletonObjects</code> ç¼“å­˜ä¸­çš„å•ä¾‹å¯¹è±¡ç§»é™¤ã€‚</p><p>é‚£ä»€ä¹ˆæ—¶å€™æ·»åŠ åˆ° <code>earlySingletonObjects</code> ç¼“å­˜ä¸­çš„å‘¢ï¼Ÿ</p><p>è¿™å—å¯ä»¥å‚è€ƒ <a href="https://mp.weixin.qq.com/s/MAlT1Y5MVmEclAZC6rgojQ">Spring æºç å­¦ä¹  15ï¼šfinishBeanFactoryInitialization</a> åœ¨ <code>getSingleton</code> æ–¹æ³•ä¸­ put è¿›å»çš„ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘æŠŠè¿™ä¸€å°å—ä»£ç ä¹Ÿè´´å‡ºæ¥ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/QPVvXy-pJUe1N.png"></p><p>åœ¨è¿™é‡Œå°†ç¼“å­˜ä» <code>singletonFactories</code> ç§»åˆ°äº† <code>earlySingletonObjects</code>ã€‚</p><p>Spring çš„ Bean å®ä¾‹åŒ–çš„æ—¶å€™ç”¨åˆ°çš„ä¸‰çº§ç¼“å­˜å…¶å®æ˜¯ï¼š</p><p><strong>singletonObjectsï¼š</strong> ä¸€çº§ç¼“å­˜ï¼Œå­˜å‚¨å•ä¾‹å¯¹è±¡ï¼ŒBean å·²ç»å®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–å®Œæˆã€‚</p><p><strong>earlySingletonObjectsï¼š</strong> äºŒçº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonObjectï¼Œè¿™ä¸ª Bean å®ä¾‹åŒ–äº†ï¼Œè¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚ </p><p><strong>singletonFactoriesï¼š</strong> ä¸‰çº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonFactory</p><p><strong>ä¸‹é¢ä¼šåˆå§‹åŒ– Bean</strong></p><p>è¿™é‡Œå…³æ³¨é‡ç‚¹å…³æ³¨ä¸‹é¢ä¸€éƒ¨åˆ†ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/hmZmhM-SI303W.png"></p><ul><li>populateBean</li></ul><p>å¯¹ Bean çš„å±æ€§è¿›è¡Œèµ‹å€¼ã€‚</p><p>è¿™å—éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å¯¹å±æ€§è¿›è¡Œèµ‹å€¼æ—¶ï¼Œå‘ç°ä¾èµ–äº†å…¶ä»– Beanï¼Œå°±ä¼šå»å…ˆåˆ›å»ºå…¶ä»– Beanã€‚</p><p>æˆ‘è¿™è¾¹ä½¿ç”¨çš„æ³¨è§£ @Autowired å°±ä¼šæ‰§è¡Œä¸‹é¢ä¸€éƒ¨åˆ†ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ZjKmVC-J3xIl5.png"></p><p>åœ¨è¿™é‡Œè§£æå±æ€§çš„æ—¶å€™ï¼Œå°±ä¼šå»åˆ›å»ºå†…éƒ¨ä¾èµ–çš„ Beanã€‚</p><ul><li>initializeBean</li></ul><h3 id="getObjectForBeanInstance"><a href="#getObjectForBeanInstance" class="headerlink" title="getObjectForBeanInstance"></a>getObjectForBeanInstance</h3><p>è·å–ç»™å®šbeanå®ä¾‹çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯FactoryBeanï¼Œåˆ™ä¸ºbeanå®ä¾‹æœ¬èº«æˆ–å…¶åˆ›å»ºçš„å¯¹è±¡ã€‚</p><p>è¿™ä¸€å—é€»è¾‘ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ ¹æ®å‰é¢ä½ åˆ›å»ºçš„ beanInstance ï¼Œ åˆ¤æ–­å…¶ç±»å‹ï¼Œä»è€Œåˆ›å»º Bean å®ä¾‹ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº†ä¸€ä¸ª å•ä¾‹ Bean çš„åˆ›å»ºï¼Œå½“ç„¶éƒ½æ˜¯å¤§å—å¤§å—çš„æºç ï¼Œéœ€è¦è€å¿ƒçš„å•ƒã€‚</p><p>é˜…è¯»å®Œæºç ï¼ŒåŸºæœ¬ä¸Šå¯¹å¾ªç¯ä¾èµ–èƒ½æœ‰ä¸ªè¯¦ç»†çš„äº†è§£ï¼ŒçŸ¥é“ Spring åœ¨åˆå§‹åŒ– Bean çš„æ—¶å€™æ˜¯ä½¿ç”¨ä¸‰çº§ç¼“å­˜æ¥å¤„ç†å¾ªç¯ä¾èµ–çš„é¢ï¼Œè€Œåé¢åˆ™ä¼šå•ç‹¬å‡†å¤‡ä¸€ç¯‡æ–‡ç« å¯¹å¾ªç¯ä¾èµ–åšä»‹ç»ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/fybVmp-2dcCmU.png"></p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/MAlT1Y5MVmEclAZC6rgojQ">Spring æºç å­¦ä¹  15ï¼šfinishBeanFactoryInitializationï¼ˆé‡ç‚¹ï¼‰</a></li><li><a href="https://mp.weixin.qq.com/s/bKmqVFuLLLCquWf3tzH30g">Spring æºç å­¦ä¹  14ï¼šinitApplicationEventMulticaster</a></li><li><a href="https://mp.weixin.qq.com/s/99IdvVkTULwTcxrxhF84Ew">Spring æºç å­¦ä¹  13ï¼šinitMessageSource</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  15ï¼šfinishBeanFactoryInitializationï¼ˆé‡ç‚¹ï¼‰</title>
      <link href="2021/01/12/source-spring-15.html"/>
      <url>2021/01/12/source-spring-15.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å¯ä»¥è¯´å‰é¢çš„éƒ½æ˜¯å‡†å¤‡å·¥ä½œï¼Œè€Œæ¥ä¸‹æ¥å¼€å§‹çš„æ‰æ˜¯é‡ç‚¹ï¼Œåœ¨è¿™ä¸€æ­¥ä¼šå®Œæˆ BeanFactory çš„åˆå§‹åŒ–ï¼ŒåŒæ—¶å®ä¾‹åŒ–å•ä¾‹ Beanã€‚</p><p>å…·ä½“æ€ä¹ˆæ“ä½œçš„ï¼Œé‚£å°±ä¸€èµ·é˜…è¯»æºç å§ï¼</p><p>ä¸è¿‡åœ¨é˜…è¯»æºç ä¹‹å‰ï¼Œè¿˜æ˜¯éœ€è¦äº†è§£ä¸€äº›çŸ¥è¯†çš„ã€‚</p><ol><li>ä»€ä¹ˆæ˜¯ FactoryBean ï¼Ÿ</li><li>FactoryBean æ˜¯å¦‚ä½•ä½¿ç”¨çš„ ï¼Ÿ </li><li>Bean æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼Ÿ</li><li>å¸¸è¯´çš„å¾ªç¯ä¾èµ–æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ</li></ol><h3 id="ä»€ä¹ˆæ˜¯-FactoryBean-ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-FactoryBean-ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ FactoryBean ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ FactoryBean ï¼Ÿ</h3><p>åœ¨å®˜ç½‘çš„è¿™ç¯‡æ–‡ç« <a href="https://spring.io/blog/2011/08/09/what-s-a-factorybean" title="What&#39;s a FactoryBean?">ã€ŠWhatâ€™s a FactoryBean?ã€‹</a>ä¸­æœ‰ç›¸å…³è§£ç­”ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥çœ‹ä¸€ä¸‹ã€‚</p><p>ç”±å†…éƒ¨ä½¿ç”¨çš„å¯¹è±¡å®ç°çš„æ¥å£ï¼Œè¿™äº›å¯¹è±¡ BeanFactory æœ¬èº«å°±æ˜¯å•ä¸ªå¯¹è±¡çš„å·¥å‚ã€‚å¦‚æœ bean å®ç°æ­¤æ¥å£ï¼Œåˆ™å®ƒå°†ç”¨ä½œå¯¹è±¡å…¬å¼€çš„å·¥å‚ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”¨ä½œå°†è‡ªèº«å…¬å¼€çš„ bean å®ä¾‹ã€‚</p><p>æ³¨æ„ï¼šå®ç°æ­¤æ¥å£çš„ bean ä¸èƒ½ç”¨ä½œæ™®é€š beanã€‚ FactoryBeanä»¥ bean æ ·å¼å®šä¹‰ï¼Œä½†æ˜¯ä¸º bean å¼•ç”¨ï¼ˆgetObject()ï¼‰å…¬å¼€çš„å¯¹è±¡å§‹ç»ˆæ˜¯å®ƒåˆ›å»ºçš„å¯¹è±¡ã€‚</p><p>FactoryBeans å¯ä»¥æ”¯æŒå•ä¾‹å’ŒåŸå‹ï¼Œå¹¶ä¸”å¯ä»¥æŒ‰éœ€å»¶è¿Ÿåˆ›å»ºå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥åœ¨å¯åŠ¨æ—¶æ€¥äºåˆ›å»ºå¯¹è±¡ã€‚</p><p>å½“ç”Ÿå‘½ä¸€ä¸ª FactoryBean æ—¶ï¼Œä¼šå­˜åœ¨ä¸¤ä¸ªç±»å‹çš„ Beanï¼Œåˆ†åˆ«æ˜¯ FactoryBean æœ¬èº«ï¼Œä»¥åŠå®ƒéœ€è¦åˆ›å»ºçš„ç±»å‹çš„ Beanã€‚</p><p>ä¸‹é¢æ˜¯ä½¿ç”¨ç¤ºä¾‹ï¼š</p><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><h4 id="1-PaidComponent"><a href="#1-PaidComponent" class="headerlink" title="1. PaidComponent"></a>1. PaidComponent</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaidComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PaidComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;PaidComponent æ— å‚æ„é€ è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-PaidComponentFactoryBean"><a href="#2-PaidComponentFactoryBean" class="headerlink" title="2. PaidComponentFactoryBean"></a>2. PaidComponentFactoryBean</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaidComponentFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">PaidComponent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PaidComponent <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;PaidComponentFactoryBean çš„ getObject æ–¹æ³•è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> PaidComponent();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line"><span class="keyword">return</span> PaidComponent.class;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-Test"><a href="#3-Test" class="headerlink" title="3 Test"></a>3 Test</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfigApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">context.register(JavaConfig.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.refresh();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">System.out.println(context.getBean(<span class="string">&quot;paidComponentFactoryBean&quot;</span>));</span><br><span class="line">System.out.println(context.getBean(<span class="string">&quot;&amp;paidComponentFactoryBean&quot;</span>));</span><br><span class="line">System.out.println(context.getBean(PaidComponent.class));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/5Ho48G-UVQwo4.png"></p><p>å¯ä»¥çœ‹å‡ºæ³¨å†Œäº†ä¸¤ä¸ª Beanï¼Œ ä¸€ä¸ªæ˜¯ <code>paidComponentFactoryBean</code> ï¼Œå¦ä¸€ä¸ªæ˜¯ <code>&amp;paidComponentFactoryBean</code>ã€‚</p><p>è€Œç›´æ¥è·å– <code>paidComponentFactoryBean</code> è·å–åˆ°çš„å…¶å®æ˜¯ FactoryBean çš„ <code>getObject()</code> æ–¹æ³•è¿”å›çš„ç±»å‹ã€‚</p><h3 id="finishBeanFactoryInitialization-æºç "><a href="#finishBeanFactoryInitialization-æºç " class="headerlink" title="finishBeanFactoryInitialization æºç "></a>finishBeanFactoryInitialization æºç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Initialize conversion service for this context.</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ç±»å‹è½¬æ¢å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">            beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">        beanFactory.setConversionService(</span><br><span class="line">                beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register a default embedded value resolver if no bean post-processor</span></span><br><span class="line">    <span class="comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span></span><br><span class="line">    <span class="comment">// at this point, primarily for resolution in annotation attribute values.</span></span><br><span class="line">    <span class="comment">// ä¸»è¦ç”¨äºæ³¨é‡Šå±æ€§å€¼çš„è§£æ</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">        beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span></span><br><span class="line">    <span class="comment">// å°½æ—©åˆå§‹åŒ– LoadTimeWeaverAware Beanï¼Œä»¥ä¾¿å°½æ—©æ³¨å†Œå…¶è½¬æ¢å™¨ã€‚</span></span><br><span class="line">    String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">        getBean(weaverAwareName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Stop using the temporary ClassLoader for type matching.</span></span><br><span class="line">    <span class="comment">// åœæ­¢ä½¿ç”¨ä¸´æ—¶çš„ClassLoaderè¿›è¡Œç±»å‹åŒ¹é…ã€‚</span></span><br><span class="line">    beanFactory.setTempClassLoader(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow for caching all bean definition metadata, not expecting further changes.</span></span><br><span class="line">    <span class="comment">// è®¾ç½® beanDefinition å…ƒæ•°æ® ä¸å¯ä»¥å†ä¿®æ”¹</span></span><br><span class="line">    beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ–å•ä¾‹ bean</span></span><br><span class="line">    beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡ç‚¹å…³æ³¨æœ€åä¸€è¡Œ</p><p><code>beanFactory.preInstantiateSingletons();</code></p><h4 id="preInstantiateSingletons"><a href="#preInstantiateSingletons" class="headerlink" title="preInstantiateSingletons"></a>preInstantiateSingletons</h4><p>è¿™å—è¿›å…¥çš„æ˜¯ç±»  <code>DefaultListableBeanFactory</code> ç±»çš„æºç ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span></span><br><span class="line">    <span class="comment">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span></span><br><span class="line">    <span class="comment">// å°† beanDefinitionNames æ”¾åˆ°é›†åˆä¸­</span></span><br><span class="line">    List&lt;String&gt; beanNames = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Trigger initialization of all non-lazy singleton beans...</span></span><br><span class="line">    <span class="comment">// éå†</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">        <span class="comment">// è·å– bd ä¿¡æ¯, å› ä¸ºå¯èƒ½ å®šä¹‰äº† parentBeanDefinition</span></span><br><span class="line">        RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">        <span class="comment">// éæŠ½è±¡, å•ä¾‹, ä¸”ä¸æ˜¯æ‡’åŠ è½½</span></span><br><span class="line">        <span class="keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸º FactoryBean</span></span><br><span class="line">            <span class="keyword">if</span> (isFactoryBean(beanName)) &#123;</span><br><span class="line">                <span class="comment">// FactoryBean éœ€è¦æ·»åŠ å‰ç¼€ &amp; ,é€šè¿‡ getBean(&amp;beanName) è·å–çš„æ˜¯ FactoryBean æœ¬èº«</span></span><br><span class="line">                Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">                <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> FactoryBean) &#123;</span><br><span class="line">                    FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦åˆå§‹åŒ–</span></span><br><span class="line">                    <span class="keyword">boolean</span> isEagerInit;</span><br><span class="line">                    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span> &amp;&amp; factory <span class="keyword">instanceof</span> SmartFactoryBean) &#123;</span><br><span class="line">                        isEagerInit = AccessController.doPrivileged(</span><br><span class="line">                                (PrivilegedAction&lt;Boolean&gt;) ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,</span><br><span class="line">                                getAccessControlContext());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        isEagerInit = (factory <span class="keyword">instanceof</span> SmartFactoryBean &amp;&amp;</span><br><span class="line">                                ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// éœ€è¦åˆå§‹åŒ–</span></span><br><span class="line">                    <span class="keyword">if</span> (isEagerInit) &#123;</span><br><span class="line">                        getBean(beanName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                getBean(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Trigger post-initialization callback for all applicable beans...</span></span><br><span class="line">    <span class="comment">// å¦‚æœ Bean å®ç°äº† SmartInitializingSingleton,</span></span><br><span class="line">    <span class="comment">// åœ¨è¿™é‡Œä¼šç»Ÿä¸€è°ƒç”¨ afterSingletonsInstantiated æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">        Object singletonInstance = getSingleton(beanName);</span><br><span class="line">        <span class="keyword">if</span> (singletonInstance <span class="keyword">instanceof</span> SmartInitializingSingleton) &#123;</span><br><span class="line">            StartupStep smartInitialize = <span class="keyword">this</span>.getApplicationStartup().start(<span class="string">&quot;spring.beans.smart-initialize&quot;</span>)</span><br><span class="line">                    .tag(<span class="string">&quot;beanName&quot;</span>, beanName);</span><br><span class="line">            SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance;</span><br><span class="line">            <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">                    smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;, getAccessControlContext());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">            &#125;</span><br><span class="line">            smartInitialize.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ–¹æ³•ä¸­é€šè¿‡å¾ªç¯ <code>beanNames</code> è¿›è¡Œåˆå§‹åŒ– Beanã€‚</p><p>å…¶ä¸­éœ€è¦åŒºåˆ« BeanFactory å’Œ æ™®é€š Beanã€‚ è¿™ä¹Ÿæ˜¯æˆ‘å¼€å§‹ä¸ºä»€ä¹ˆå…ˆä»‹ç»äº†<code>ä»€ä¹ˆæ˜¯ BeanFactory ?</code></p><p>ä¸‹é¢å°±éœ€è¦é‡ç‚¹å…³æ³¨ <code>getBean(beanName)</code> æ–¹æ³•ã€‚</p><h4 id="getBean"><a href="#getBean" class="headerlink" title="getBean"></a>getBean</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> doGetBean(name, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>getBean</code> æ–¹æ³•ä¸­è°ƒç”¨çš„æ˜¯ <code>doGetBean</code> æ–¹æ³•ã€‚</p><h4 id="doGetBean"><a href="#doGetBean" class="headerlink" title="doGetBean"></a>doGetBean</h4><p>doGetBean æ–¹æ³•ä½œç”¨æ˜¯ï¼š<code>è¿”å›ä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥æ˜¯æŒ‡å®šbeançš„å…±äº«æˆ–ç‹¬ç«‹çš„</code>ã€‚ </p><p>è¯¥æ–¹æ³•æ¥å—å››ä¸ªå‚æ•°ï¼š</p><blockquote><p>name â€“ è¦æ£€ç´¢çš„ bean çš„åç§°<br>requiredType â€“ è¦æ£€ç´¢çš„ bean çš„å¿…éœ€ç±»å‹ï¼Œè¿™ä¸ªå¯ä»¥ä¸ºç©º<br>args â€“ä½¿ç”¨æ˜¾å¼å‚æ•°åˆ›å»ºbeanå®ä¾‹æ—¶è¦ä½¿ç”¨çš„å‚æ•°ï¼ˆä»…åœ¨åˆ›å»ºæ–°å®ä¾‹è€Œä¸æ˜¯æ£€ç´¢ç°æœ‰å®ä¾‹æ—¶æ‰åº”ç”¨ï¼‰<br>typeCheckOnly â€“æ˜¯å¦ä¸ºç±»å‹æ£€æŸ¥è€Œä¸æ˜¯å®é™…ä½¿ç”¨è·å–å®ä¾‹</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, <span class="meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="meta">@Nullable</span> Object[] args, <span class="keyword">boolean</span> typeCheckOnly)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å»æ‰å·¥å‚å¼•ç”¨çš„å‰ç¼€, åŒæ—¶è½¬æ¢åˆ«å</span></span><br><span class="line">    String beanName = transformedBeanName(name);</span><br><span class="line">    Object bean;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Eagerly check singleton cache for manually registered singletons.</span></span><br><span class="line">    <span class="comment">// ä»ç¼“å­˜ä¸­æ£€æŸ¥å•ä¾‹æ˜¯å¦å·²ç»å­˜åœ¨</span></span><br><span class="line">    Object sharedInstance = getSingleton(beanName);</span><br><span class="line">    <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                        <span class="string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä»ç¼“å­˜ä¸­å¦‚æœè·å–åˆ°äº†, æ™®é€š Bean ç›´æ¥è¿”å›, FactoryBean åˆ™è¿”å› FactoryBean åˆ›å»ºçš„ Bean</span></span><br><span class="line">        bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Fail if we&#x27;re already creating this bean instance:</span></span><br><span class="line">        <span class="comment">// We&#x27;re assumably within a circular reference.</span></span><br><span class="line">        <span class="comment">// è¿”å›æŒ‡å®šçš„ åŸå‹bean (prototype ç±»å‹çš„ Bean) æ˜¯å¦å½“å‰æ­£åœ¨åˆ›å»ºä¸­ï¼ˆåœ¨å½“å‰çº¿ç¨‹å†…ï¼‰ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if bean definition exists in this factory.</span></span><br><span class="line">        <span class="comment">// æ£€æŸ¥ BeanFactory æ˜¯å¦å­˜åœ¨è¿™ä¸ª Bean çš„ BeanDefinition</span></span><br><span class="line">        BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line">        <span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">            <span class="comment">// Not found -&gt; check parent.</span></span><br><span class="line">            <span class="comment">// æ£€æŸ¥çˆ¶å®¹å™¨ä¸­æœ‰æ²¡æœ‰å®šä¹‰</span></span><br><span class="line">            String nameToLookup = originalBeanName(name);</span><br><span class="line">            <span class="comment">// è¿”å›ä»çˆ¶å®¹å™¨ä¸­æŸ¥è¯¢çš„ç»“æœ</span></span><br><span class="line">            <span class="keyword">if</span> (parentBeanFactory <span class="keyword">instanceof</span> AbstractBeanFactory) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">                        nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Delegation to parent with explicit args.</span></span><br><span class="line">                <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (requiredType != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// No args -&gt; delegate to standard getBean method.</span></span><br><span class="line">                <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!typeCheckOnly) &#123;</span><br><span class="line">            <span class="comment">// å°†å½“å‰ beanName æ”¾å…¥ä¸€ä¸ª alreadyCreated çš„ Set é›†åˆä¸­ã€‚</span></span><br><span class="line">            <span class="comment">// æ ‡è¯†æœ¬æ¬¡è°ƒç”¨æ–¹æ³•ï¼Œå¹¶éæ˜¯è¦è·å–beançš„ç±»å‹ï¼Œè€Œæ˜¯ä¸ºäº†åˆ›å»ºå®ä¾‹ï¼Œå°†beanNameå­˜åˆ°alreadyCreatedé›†åˆï¼Œä»£è¡¨è¯¥beanå·²ç»åˆ›å»ºäº†ï¼Œåé¢tryã€‚ã€‚catchæœ‰å¼‚å¸¸ä¼šæ¸…ç©ºè¯¥beanName</span></span><br><span class="line">            markBeanAsCreated(beanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        StartupStep beanCreation = <span class="keyword">this</span>.applicationStartup.start(<span class="string">&quot;spring.beans.instantiate&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;beanName&quot;</span>, name);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (requiredType != <span class="keyword">null</span>) &#123;</span><br><span class="line">                beanCreation.tag(<span class="string">&quot;beanType&quot;</span>, requiredType::toString);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è·å– Bean çš„ BeanDefinition</span></span><br><span class="line">            RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">            checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Guarantee initialization of beans that the current bean depends on.</span></span><br><span class="line">            <span class="comment">// ç¡®ä¿ä¾èµ–çš„ Bean å·²ç»è¢«åˆå§‹åŒ–, æ¯”å¦‚ @DependsOn æ³¨è§£</span></span><br><span class="line">            String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">            <span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                <span class="string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    registerDependentBean(dep, beanName);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// åˆ›å»ºä¾èµ–çš„ Bean</span></span><br><span class="line">                        getBean(dep);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                <span class="string">&quot;&#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create bean instance.</span></span><br><span class="line">            <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">                <span class="comment">// å•ä¾‹ bean</span></span><br><span class="line">                sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                        <span class="comment">// Explicitly remove instance from singleton cache: It might have been put there</span></span><br><span class="line">                        <span class="comment">// eagerly by the creation process, to allow for circular reference resolution.</span></span><br><span class="line">                        <span class="comment">// Also remove any beans that received a temporary reference to the bean.</span></span><br><span class="line">                        destroySingleton(beanName);</span><br><span class="line">                        <span class="keyword">throw</span> ex;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åˆ›å»ºåŸå‹Bean</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line">                <span class="comment">// It&#x27;s a prototype -&gt; create a new instance.</span></span><br><span class="line">                Object prototypeInstance = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    beforePrototypeCreation(beanName);</span><br><span class="line">                    prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">finally</span> &#123;</span><br><span class="line">                    afterPrototypeCreation(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">                bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å§”æ‰˜ç»™å®ç°ç±»å¤„ç†</span></span><br><span class="line">                String scopeName = mbd.getScope();</span><br><span class="line">                <span class="keyword">if</span> (!StringUtils.hasLength(scopeName)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No scope name defined for bean Â´&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                Scope scope = <span class="keyword">this</span>.scopes.get(scopeName);</span><br><span class="line">                <span class="keyword">if</span> (scope == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Object scopedInstance = scope.get(beanName, () -&gt; &#123;</span><br><span class="line">                        beforePrototypeCreation(beanName);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">finally</span> &#123;</span><br><span class="line">                            afterPrototypeCreation(beanName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ScopeNotActiveException(beanName, scopeName, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            beanCreation.tag(<span class="string">&quot;exception&quot;</span>, ex.getClass().toString());</span><br><span class="line">            beanCreation.tag(<span class="string">&quot;message&quot;</span>, String.valueOf(ex.getMessage()));</span><br><span class="line">            cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            beanCreation.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if required type matches the type of the actual bean instance.</span></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ‰€éœ€çš„ç±»å‹æ˜¯å¦ä¸å®é™…beanå®ä¾‹çš„ç±»å‹åŒ¹é…ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">            <span class="keyword">if</span> (convertedBean == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> convertedBean;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (TypeMismatchException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;Failed to convert bean &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; to required type &#x27;&quot;</span> +</span><br><span class="line">                        ClassUtils.getQualifiedName(requiredType) + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (T) bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç æ¯”è¾ƒé•¿ï¼ŒåŸºæœ¬ä¸Šæ­¥éª¤å·²ç»æ·»åŠ ç›¸åº”çš„æ³¨é‡Šï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol><li>ä»ç¼“å­˜ä¸­è·å–åˆ° Beanï¼Œåˆ›å»ºå¯¹åº”çš„ Beanï¼›</li><li>æ²¡æœ‰ä»ç¼“å­˜ä¸­è·å–åˆ° Beanï¼Œåˆ›å»ºå¯¹åº”çš„ Beanï¼›</li><li>æ£€æŸ¥æ‰€éœ€çš„ç±»å‹æ˜¯å¦ä¸å®é™…beanå®ä¾‹çš„ç±»å‹åŒ¹é…ã€‚</li></ol><p>ä¸‹é¢ä»è¿™ä¸‰ä¸ªæ­¥éª¤åˆ†åˆ«ä»‹ç»ï¼š</p><ul><li>ä»ç¼“å­˜ä¸­è·å–åˆ° Beanï¼Œåˆ›å»ºå¯¹åº”çš„ Bean</li></ul><p><strong><code>Object sharedInstance = getSingleton(beanName);</code></strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getSingleton(beanName, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å›ä»¥ç»™å®šåç§°æ³¨å†Œçš„ï¼ˆåŸå§‹ï¼‰å•ä¾‹å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ£€æŸ¥å·²ç»å®ä¾‹åŒ–çš„å•ä¾‹ï¼Œå¹¶å…è®¸æ—©æœŸå¼•ç”¨å½“å‰åˆ›å»ºçš„å•ä¾‹ï¼ˆè§£æå¾ªç¯å¼•ç”¨ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Quick check for existing instance without full singleton lock</span></span><br><span class="line">    <span class="comment">// private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);</span></span><br><span class="line">    <span class="comment">// ç¼“å­˜äº† å•ä¾‹ Bean</span></span><br><span class="line">    Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰è·å–åˆ°, å¹¶ä¸”å½“å‰ Bean æ­£åœ¨è¢«åˆ›å»ºä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        <span class="comment">// private final Map&lt;String, Object&gt; earlySingletonObjects = new ConcurrentHashMap&lt;&gt;(16);</span></span><br><span class="line">        <span class="comment">// æ—©æœŸçš„å•ä¾‹å¯¹è±¡, å…ˆä» earlySingletonObjects ä¸­è·å–</span></span><br><span class="line">        singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">        <span class="comment">// æ²¡æœ‰ä» earlySingletonObjects ç¼“å­˜ä¸­è·å–åˆ°</span></span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">                <span class="comment">// Consistent creation of early reference within full singleton lock</span></span><br><span class="line">                <span class="comment">// å†æ¬¡è·å–å¹¶æ£€æŸ¥</span></span><br><span class="line">                singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">                    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16);</span></span><br><span class="line">                        <span class="comment">// ä» singletonFactories ç¼“å­˜ä¸­è·å–</span></span><br><span class="line">                        ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                        <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            singletonObject = singletonFactory.getObject();</span><br><span class="line">                            <span class="comment">// æ·»åŠ åˆ° earlySingletonObjects ç¼“å­˜ä¸­</span></span><br><span class="line">                            <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                            <span class="comment">// ä» singletonFactories ç¼“å­˜ä¸­åˆ é™¤</span></span><br><span class="line">                            <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œè·å–ä¸€ä¸ª Bean ï¼š</p><ol><li>å…ˆä» <code>singletonObjects</code> ä¸­è·å– Beanï¼›</li><li>è·å–ä¸åˆ°ï¼Œä» <code>earlySingletonObjects</code> ä¸­è·å– Beanï¼›</li><li>è·å–ä¸åˆ°ï¼Œä» <code>singletonFactories</code> ä¸­è·å– Beanã€‚</li></ol><p>å½“ç„¶è¿™ä¸€å—æ¶‰åŠåˆ°å¾ªç¯å¼•ç”¨ï¼Œç¯‡å¹…æœ‰é™ï¼Œåé¢ä¼šä¸“é—¨ä»‹ç»å¾ªç¯å¼•ç”¨ã€‚</p><ul><li>æ²¡æœ‰ä»ç¼“å­˜ä¸­è·å–åˆ° Beanï¼Œåˆ›å»ºå¯¹åº”çš„ Bean</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Create bean instance.</span></span><br><span class="line"><span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">    <span class="comment">// å•ä¾‹ bean</span></span><br><span class="line">    sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="comment">// Explicitly remove instance from singleton cache: It might have been put there</span></span><br><span class="line">            <span class="comment">// eagerly by the creation process, to allow for circular reference resolution.</span></span><br><span class="line">            <span class="comment">// Also remove any beans that received a temporary reference to the bean.</span></span><br><span class="line">            destroySingleton(beanName);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºåŸå‹Bean</span></span><br><span class="line">    </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å§”æ‰˜ç»™å®ç°ç±»å¤„ç†</span></span><br><span class="line">    String scopeName = mbd.getScope();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ£€æŸ¥æ‰€éœ€çš„ç±»å‹æ˜¯å¦ä¸å®é™…beanå®ä¾‹çš„ç±»å‹åŒ¹é…</li></ul><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è¿™é‡Œä¸»è¦ä»‹ç»äº† Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œä¸»è¦æ˜¯å¯¹æ•´ä¸ªè¿‡ç¨‹æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£å’Œç†Ÿæ‚‰ï¼Œé’ˆå¯¹è¿‡ç¨‹ç”»å›¾å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/II1QBD-L3tiN3.png"></p><p>å…¶ä¸­ Bean çš„å®ä¾‹åŒ–ä¸»è¦å…³æ³¨å•ä¾‹ Bean çš„å®ä¾‹åŒ–ï¼Œåé¢å‡†å¤‡å¯¹å…¶è¿›è¡Œè¯¦ç»†ç ”ç©¶åï¼Œå†è¿›è¡Œè¯´æ˜ã€‚</p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/bKmqVFuLLLCquWf3tzH30g">Spring æºç å­¦ä¹  14ï¼šinitApplicationEventMulticaster</a></li><li><a href="https://mp.weixin.qq.com/s/99IdvVkTULwTcxrxhF84Ew">Spring æºç å­¦ä¹  13ï¼šinitMessageSource</a></li><li><a href="https://mp.weixin.qq.com/s/QrogJIm9OaUmeRk9tGiNeg">Spring æºç å­¦ä¹  12ï¼šregisterBeanPostProcessors</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  14ï¼šinitApplicationEventMulticaster ã€onRefresh å’Œ registerListeners</title>
      <link href="2021/01/05/source-spring-14.html"/>
      <url>2021/01/05/source-spring-14.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ä¸Šä¸€ç¯‡ä»‹ç»äº†å›½é™…åŒ–çš„ä½¿ç”¨ä»¥åŠåˆå§‹åŒ–æ¶ˆæ¯æºçš„æºç ï¼Œæ¥ä¸‹æ¥æ¥ç€å¾€ä¸‹é˜…è¯»ï¼Œå°†è¿›å…¥ initApplicationEventMulticaster ã€onRefresh å’Œ registerListeners çš„ç›¸å…³æ“ä½œé€»è¾‘ã€‚</p><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨ä»¥åŠæ³¨å†Œç›‘å¬å™¨ã€‚è€Œ onRefresh éƒ¨åˆ†åˆ™éœ€è¦å­ç±»å»å®ç°ã€‚ æ‰€ä»¥æœ¬æ–‡ä¸»è¦ä»‹ç»ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>ä»€ä¹ˆæ˜¯ Spring äº‹ä»¶ï¼Ÿ</li><li>ç›‘å¬å™¨æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Ÿ</li></ol><h3 id="ä»€ä¹ˆæ˜¯-Spring-äº‹ä»¶ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-Spring-äº‹ä»¶ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ Spring äº‹ä»¶ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ Spring äº‹ä»¶ï¼Ÿ</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/7NqBIZ-8RXd1N.png"></p><p>è¿™å—çš„ä»‹ç»åœ¨å®˜ç½‘ <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#context-functionality-events" title="Spring å®˜æ–¹æ–‡æ¡£">1.15.2. Standard and Custom Events</a> éƒ¨åˆ†æœ‰ä»‹ç»ã€‚</p><blockquote><p>Spring é€šè¿‡ ApplicationEvent ç±»å’Œ ApplicationListener æ¥å£æä¾› ApplicationContext ä¸­çš„äº‹ä»¶å¤„ç†ã€‚å¦‚æœå°†å®ç° ApplicationListener æ¥å£çš„ bean éƒ¨ç½²åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œåˆ™æ¯æ¬¡å°† ApplicationEvent å‘å¸ƒåˆ° ApplicationContext æ—¶ï¼Œéƒ½ä¼šé€šçŸ¥è¯¥ beanã€‚æœ¬è´¨ä¸Šï¼Œè¿™æ˜¯æ ‡å‡†çš„è§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼ã€‚</p></blockquote><p>å½’çº³ä¸‹æ¥ä¸»è¦å°±æ˜¯ä¸‰ä¸ªéƒ¨åˆ†: äº‹ä»¶ã€äº‹ä»¶å‘å¸ƒè€…ã€äº‹ä»¶ç›‘å¬å™¨ã€‚</p><ol><li>äº‹ä»¶ï¼šApplicationEventï¼Œè¦è‡ªå®šä¹‰äº‹ä»¶ï¼Œåˆ™éœ€è¦åˆ›å»ºä¸€ä¸ªç±»ç»§æ‰¿ ApplicationEventã€‚</li><li>äº‹ä»¶å‘å¸ƒè€…ï¼šApplicationEventPublisher å’Œ ApplicationEventMulticasterï¼Œå› ä¸º ApplicationContext å®ç°äº† ApplicationEventPublisherï¼Œæ‰€ä»¥äº‹ä»¶å‘å¸ƒå¯ä»¥ç›´æ¥ä½¿ç”¨ ApplicationContextã€‚</li><li>äº‹ä»¶ç›‘å¬å™¨ï¼šApplicationListenerï¼Œé€šè¿‡åˆ›å»ºä¸€ä¸ªå®ç°äº† ApplicationListener å¹¶æ³¨å†Œä¸º Spring bean çš„ç±»æ¥æ¥æ”¶æ¶ˆæ¯ã€‚</li></ol><p>Spring ä¹Ÿæä¾›äº†ä¹Ÿæœ‰ä¸€äº›å†…ç½®çš„ç›‘å¬å™¨ï¼Œå¯ä»¥åœ¨å®˜ç½‘æŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸åšä»‹ç»äº†ã€‚</p><h3 id="ä½¿ç”¨ç›‘å¬å™¨"><a href="#ä½¿ç”¨ç›‘å¬å™¨" class="headerlink" title="ä½¿ç”¨ç›‘å¬å™¨"></a>ä½¿ç”¨ç›‘å¬å™¨</h3><p>ç®€å•æ¥è¯´ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>æ³¨å†Œäº‹ä»¶</li><li>æ³¨å†Œç›‘å¬å™¨</li><li>å‘å¸ƒäº‹ä»¶</li></ol><p>åœ¨æ¥å£è°ƒç”¨å‘å¸ƒäº‹ä»¶æ—¶ï¼Œç›‘å¬å™¨å°±ä¼šåšå‡ºç›¸åº”çš„æ“ä½œã€‚</p><h4 id="1-æ³¨å†Œäº‹ä»¶"><a href="#1-æ³¨å†Œäº‹ä»¶" class="headerlink" title="1. æ³¨å†Œäº‹ä»¶"></a>1. æ³¨å†Œäº‹ä»¶</h4><p>åˆ›å»º <code>MyApplicationEvent</code> ç±»å¹¶ç»§æ‰¿ <code>ApplicationEvent</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5366526231219883438L</span>;</span><br><span class="line"><span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new &#123;<span class="doctag">@code</span> ApplicationEvent&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> source the object on which the event initially occurred or with</span></span><br><span class="line"><span class="comment"> *               which the event is associated (never &#123;<span class="doctag">@code</span> null&#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyApplicationEvent</span><span class="params">(Object source, String message)</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>(source);</span><br><span class="line"><span class="keyword">this</span>.message = message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-æ³¨å†Œç›‘å¬å™¨"><a href="#2-æ³¨å†Œç›‘å¬å™¨" class="headerlink" title="2. æ³¨å†Œç›‘å¬å™¨"></a>2. æ³¨å†Œç›‘å¬å™¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">MyApplicationEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(MyApplicationEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;MyApplicationListener æ”¶åˆ°æ¶ˆæ¯: &quot;</span> + event.getMessage());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£ <code>@EventListener</code> çš„æ–¹å¼æ¥ä½¿ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAnnotationApplicationListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EventListener(classes = MyApplicationEvent.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">myApplicationEventListener</span><span class="params">(MyApplicationEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;ä½¿ç”¨æ³¨è§£çš„æ–¹å¼, æ”¶åˆ°äº‹ä»¶: &quot;</span> + event.getMessage());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-ä½¿ç”¨"><a href="#3-ä½¿ç”¨" class="headerlink" title="3. ä½¿ç”¨"></a>3. ä½¿ç”¨</h4><p>å› ä¸º AnnotationConfigApplicationContext å®ç°äº† ApplicationContext ï¼Œ è€Œ ApplicationContext å®ç°äº† ApplicationEventPublisherï¼Œæ‰€ä»¥è¿™å—ä¼ å…¥å½“å‰ context æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfigApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">context.register(JavaConfig.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.refresh();</span><br><span class="line"></span><br><span class="line">MyApplicationEvent myApplicationEvent = <span class="keyword">new</span> MyApplicationEvent(context, <span class="string">&quot;å‘¼å«åœŸè±†,å‘¼å«åœŸè±†!&quot;</span>);</span><br><span class="line"></span><br><span class="line">context.publishEvent(myApplicationEvent);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¥å¿—è¾“å‡ºï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/6I8oSf-BcMLIj.png"></p><h3 id="æºç éƒ¨åˆ†"><a href="#æºç éƒ¨åˆ†" class="headerlink" title="æºç éƒ¨åˆ†"></a>æºç éƒ¨åˆ†</h3><h4 id="initApplicationEventMulticaster"><a href="#initApplicationEventMulticaster" class="headerlink" title="initApplicationEventMulticaster"></a>initApplicationEventMulticaster</h4><p>è¿™å—å’Œä¸Šé¢åˆå§‹åŒ–æ¶ˆæ¯æºç±»ä¼¼ï¼Œéƒ½æ˜¯æŸ¥æ‰¾æŒ‡å®šåç§°çš„ Bean ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™è‡ªå·±ä½¿ç”¨é»˜è®¤çš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationEventMulticaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦åŒ…å« applicationEventMulticaster Bean</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationEventMulticaster =</span><br><span class="line">                beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨  SimpleApplicationEventMulticaster åˆ›å»ºä¸€ä¸ª äº‹ä»¶å‘å¸ƒå™¨</span></span><br><span class="line">        SimpleApplicationEventMulticaster simpleApplicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">        simpleApplicationEventMulticaster.setApplicationStartup(getApplicationStartup());</span><br><span class="line">        <span class="keyword">this</span>.applicationEventMulticaster = simpleApplicationEventMulticaster;</span><br><span class="line">        beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="keyword">this</span>.applicationEventMulticaster);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span class="string">&quot;&#x27; bean, using &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;[&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster.getClass().getSimpleName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="onRefresh"><a href="#onRefresh" class="headerlink" title="onRefresh"></a>onRefresh</h4><p>è¿™å—éœ€è¦å­ç±»å»å®ç°ï¼Œæˆ‘è¿™é‡Œé€šè¿‡æ–­ç”µï¼Œæš‚æ—¶æ²¡æœ‰è¿›å»ã€‚æ‰€ä»¥å°±ä¸ä»‹ç»äº†ã€‚</p><h4 id="registerListeners"><a href="#registerListeners" class="headerlink" title="registerListeners"></a>registerListeners</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ·»åŠ å®ç°ApplicationListenerä½œä¸ºä¾¦å¬å™¨çš„beanã€‚</span></span><br><span class="line">    <span class="comment">// ä¸ä¼šå½±å“å…¶ä»–ä¾¦å¬å™¨ï¼Œå¯ä»¥å°†å®ƒä»¬æ·»åŠ ä¸ºébeanã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register statically specified listeners first.</span></span><br><span class="line">    <span class="comment">// å…ˆæ³¨å†Œé™æ€æŒ‡å®šçš„ç›‘å¬å™¨</span></span><br><span class="line">    <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">        getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">    <span class="comment">// uninitialized to let post-processors apply to them!</span></span><br><span class="line">    <span class="comment">// åªæ˜¯æ·»åŠ  å¹¶æ²¡æœ‰æ‰§è¡Œ</span></span><br><span class="line">    String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">        getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Publish early application events now that we finally have a multicaster...</span></span><br><span class="line">    <span class="comment">// å‘å¸ƒæ—©æœŸçš„æ—¶é—´,å¹¶ä¸”å°† earlyApplicationEvents è®¾ç½®ä¸ºç©º</span></span><br><span class="line">    Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="keyword">this</span>.earlyApplicationEvents;</span><br><span class="line">    <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(earlyEventsToProcess)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">            getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è¿™ç¯‡æ–‡ç« ä¸»è¦å†…å®¹æ˜¯ä»‹ç» Spring äº‹ä»¶çš„ä½¿ç”¨ï¼ŒåŒæ—¶ç®€å•ä»‹ç»äº† initApplicationEventMulticaster ã€onRefresh å’Œ registerListeners éƒ¨åˆ†çš„æºç ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/KgCNdp-V1Ov1L.png"></p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/99IdvVkTULwTcxrxhF84Ew">Spring æºç å­¦ä¹  13ï¼šinitMessageSource</a></li><li><a href="https://mp.weixin.qq.com/s/QrogJIm9OaUmeRk9tGiNeg">Spring æºç å­¦ä¹  12ï¼šregisterBeanPostProcessors</a></li><li><a href="https://mp.weixin.qq.com/s/6VrVDg4m6yi7V4rZZB-6tA">Spring æºç å­¦ä¹  11ï¼šinvokeBeanFactoryPostProcessors</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  13ï¼šinitMessageSource</title>
      <link href="2021/01/02/source-spring-13.html"/>
      <url>2021/01/02/source-spring-13.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>åœ¨é˜…è¯»å®Œ registerBeanPostProcessors æºç ä¹‹åï¼Œ ä¸‹ä¸€æ­¥å°±è¿›å…¥åˆ° initMessageSourceï¼Œè¿™ä¸€æ­¥ä¸»è¦ä½œç”¨æ˜¯åˆå§‹åŒ–å›½é™…åŒ–æ–‡ä»¶ã€‚</p><p>ä¾ç„¶å¦‚ä¹‹å‰æ‰€ç¤ºï¼Œå…ˆé€šè¿‡å®˜ç½‘äº†è§£åˆ°å›½é™…åŒ–çš„ç”¨æ³•ï¼Œç„¶åå†å¯¹æºç è¿›è¡Œç ”ç©¶ã€‚</p><h3 id="MessageSource-å›½é™…åŒ–"><a href="#MessageSource-å›½é™…åŒ–" class="headerlink" title="MessageSource å›½é™…åŒ–"></a>MessageSource å›½é™…åŒ–</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/i7fXJs-MLV2A0.png"></p><p>å¦‚å®˜ç½‘<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#context-functionality-messagesource" title="Spring å®˜æ–¹æ–‡æ¡£">1.15.1. Internationalization using MessageSource</a>æ‰€ç¤ºï¼Œä¸»è¦ä½œç”¨å°±æ˜¯ä½¿ç”¨å›½é™…åŒ–ï¼Œå®šåˆ¶ä¸åŒçš„æ¶ˆæ¯ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ MessageSource å®šä¹‰çš„ Bean åå­—å¿…é¡»ä¸º <code>messageSource</code>ï¼Œ è€Œå¦‚æœæ‰¾ä¸åˆ°åˆ™ä¼šé»˜è®¤æ³¨å†Œ <code>DelegatingMessageSource</code> ä½œä¸º messageSource  çš„  Beanã€‚</p><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><h4 id="1-åˆ›å»ºå›½é™…åŒ–æ–‡ä»¶"><a href="#1-åˆ›å»ºå›½é™…åŒ–æ–‡ä»¶" class="headerlink" title="1. åˆ›å»ºå›½é™…åŒ–æ–‡ä»¶"></a>1. åˆ›å»ºå›½é™…åŒ–æ–‡ä»¶</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/vbK7nm-tNoYJn.png"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/VKIW32-gHAVHQ.png"></p><h4 id="2-å£°æ˜-MessageSource"><a href="#2-å£°æ˜-MessageSource" class="headerlink" title="2. å£°æ˜ MessageSource"></a>2. å£°æ˜ MessageSource</h4><p>åœ¨ JavaConfig ä¸­ å£°æ˜ MessageSource ï¼Œ è®°å¾—åå­—ä¸€å®šè¦å«åš <code>messageSource</code> ï¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.liuzhihang&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(name = &quot;messageSource&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageSource <span class="title">getMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">ResourceBundleMessageSource messageSource = <span class="keyword">new</span> ResourceBundleMessageSource();</span><br><span class="line"></span><br><span class="line">messageSource.setDefaultEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">messageSource.addBasenames(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;message_en&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> messageSource;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-æµ‹è¯•ç»“æœ"><a href="#3-æµ‹è¯•ç»“æœ" class="headerlink" title="3. æµ‹è¯•ç»“æœ"></a>3. æµ‹è¯•ç»“æœ</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfigApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">context.register(JavaConfig.class);</span><br><span class="line"></span><br><span class="line">context.refresh();</span><br><span class="line"></span><br><span class="line">MessageSource messageSource = context.getBean(MessageSource.class);</span><br><span class="line"></span><br><span class="line">String zhMessage = messageSource.getMessage(<span class="string">&quot;user.name&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, Locale.CHINA);</span><br><span class="line">String enMessage = messageSource.getMessage(<span class="string">&quot;user.name&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, Locale.ENGLISH);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;zhMessage = &quot;</span> + zhMessage);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;enMessage = &quot;</span> + enMessage);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œæ‰§è¡Œä¹‹åè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/sqNm0Q-MyrhWD.png"></p><p>çŸ¥é“äº†å›½é™…åŒ–æ˜¯å¦‚ä½•ä½¿ç”¨çš„ä¹‹åï¼Œå†æƒ³ä¸€æƒ³è¿™ä¸€æ­¥æºç ï¼Œå°±çŸ¥é“æ˜¯ä»€ä¹ˆä½œç”¨äº†å§ï¼</p><h3 id="initMessageSource-æºç "><a href="#initMessageSource-æºç " class="headerlink" title="initMessageSource æºç "></a>initMessageSource æºç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bean çš„åç§°å¿…é¡»è¦æ˜¯ messageSource</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">        <span class="comment">// Make MessageSource aware of parent MessageSource.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">            HierarchicalMessageSource hms = (HierarchicalMessageSource) <span class="keyword">this</span>.messageSource;</span><br><span class="line">            <span class="keyword">if</span> (hms.getParentMessageSource() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Only set parent context as parent MessageSource if no parent MessageSource</span></span><br><span class="line">                <span class="comment">// registered already.</span></span><br><span class="line">                hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Using MessageSource [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Use empty MessageSource to be able to accept getMessage calls.</span></span><br><span class="line">        <span class="comment">// å¦åˆ™åˆ™ä½¿ç”¨é»˜è®¤çš„</span></span><br><span class="line">        DelegatingMessageSource dms = <span class="keyword">new</span> DelegatingMessageSource();</span><br><span class="line">        dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">        <span class="keyword">this</span>.messageSource = dms;</span><br><span class="line">        beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="keyword">this</span>.messageSource);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + MESSAGE_SOURCE_BEAN_NAME + <span class="string">&quot;&#x27; bean, using [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å—æºç å”¯ä¸€å€¼å¾—å…³æ³¨çš„åœ°æ–¹å°±æ˜¯ï¼ŒBean çš„åç§°å¿…é¡»è¦æ˜¯ messageSource ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æœ¬æ–‡é€šè¿‡å®˜ç½‘ï¼Œäº†è§£åˆ°ä»€ä¹ˆæ˜¯å›½é™…åŒ–ï¼Œä»¥åŠå›½é™…åŒ–çš„ä½¿ç”¨ï¼Œå¹¶ç»“åˆä»£ç å’Œæºç ï¼ŒçŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p><p>å½“ç„¶æœ¬æ–‡éœ€è¦æ³¨æ„çš„åœ°æ–¹å°±æ˜¯å›½é™…åŒ– MessageSource çš„ Bean åç§°è¦å¿…é¡»ä¸º messageSourceã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/Ic7vnq-uIcbjr.png"></p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/QrogJIm9OaUmeRk9tGiNeg">Spring æºç å­¦ä¹  12ï¼šregisterBeanPostProcessors</a></li><li><a href="https://mp.weixin.qq.com/s/6VrVDg4m6yi7V4rZZB-6tA">Spring æºç å­¦ä¹  11ï¼šinvokeBeanFactoryPostProcessors</a></li><li><a href="https://mp.weixin.qq.com/s/6vTqVFC4frjhqdMirGPCnQ">Spring æºç å­¦ä¹  10ï¼šprepareBeanFactory å’Œ postProcessBeanFactory</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  12ï¼šregisterBeanPostProcessors</title>
      <link href="2021/01/01/source-spring-12.html"/>
      <url>2021/01/01/source-spring-12.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å‰é¢é€šè¿‡ invokeBeanFactoryPostProcessors è¿™ä¸€æ­¥äº†è§£åˆ°äº†ä»€ä¹ˆæ˜¯ BeanFactoryPostProcessor ï¼Œä»¥åŠ BeanFactoryPostProcessor çš„ä½¿ç”¨åŠä½œç”¨ï¼Œå¹¶é€šè¿‡ invokeBeanFactoryPostProcessors è¿™ä¸€æ­¥æºç ï¼Œå¯¹ BeanFactoryPostProcessor çš„åŠ è½½æµç¨‹æœ‰äº†è¿›ä¸€æ­¥äº†è§£ã€‚</p><p>ç°åœ¨å°±ä¸€èµ·è¿›å…¥ä¸‹ä¸€ä¸ªç¯èŠ‚ï¼š</p><p><code>registerBeanPostProcessors(beanFactory);</code></p><p>è¿™ä¸€æ­¥ä¸»è¦çš„ä½œç”¨æ˜¯åŠ è½½ BeanPostProcessorï¼Œä»åå­—ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåªæ˜¯åŠ è½½ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œã€‚</p><p>ä¸è¿‡ï¼Œåœ¨è¿›å…¥æºç ä¹‹å‰ï¼Œä¾ç„¶æ˜¯ç»“åˆå®˜ç½‘ï¼Œå…ˆäº†è§£ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>ä»€ä¹ˆæ˜¯ BeanPostProcessorï¼Ÿ</li><li>BeanPostProcessor æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Ÿ</li><li>BeanPostProcessor æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</li></ol><h3 id="ä»€ä¹ˆæ˜¯-BeanPostProcessor-ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-BeanPostProcessor-ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ BeanPostProcessor ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ BeanPostProcessor ï¼Ÿ</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/PqDpkg-Wujih5.png"></p><p>å¦‚æˆªå›¾æ‰€ç¤ºï¼Œåœ¨å®˜ç½‘ <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-extension-bpp" title="Spring å®˜æ–¹æ–‡æ¡£">1.8.1 Customizing Beans by Using a BeanPostProcessor</a> ä¸­ä»‹ç»ï¼Œ <code>BeanPostProcessor</code> æ¥å£å®šä¹‰å›è°ƒæ–¹æ³•ï¼Œå¯ä»¥å®ç°è¿™äº›æ–¹æ³•ï¼Œä»è€Œåœ¨ Bean å®ä¾‹åŒ–æœŸé—´ä¿®æ”¹ Bean çš„å±æ€§ã€‚</p><h3 id="BeanPostProcessor-æ˜¯å¦‚ä½•ä½¿ç”¨çš„"><a href="#BeanPostProcessor-æ˜¯å¦‚ä½•ä½¿ç”¨çš„" class="headerlink" title="BeanPostProcessor æ˜¯å¦‚ä½•ä½¿ç”¨çš„?"></a>BeanPostProcessor æ˜¯å¦‚ä½•ä½¿ç”¨çš„?</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> UserComponent) &#123;</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;BeanPostProcessor å¼€å§‹æ‰§è¡Œ åˆå§‹åŒ–å‰...&quot;</span> + beanName);</span><br><span class="line"></span><br><span class="line">UserComponent userComponent = (UserComponent) bean;</span><br><span class="line">userComponent.setUserName(<span class="string">&quot;liuzhihang-postProcessBeforeInitialization&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> userComponent;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> UserComponent) &#123;</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;BeanPostProcessor å¼€å§‹æ‰§è¡Œ åˆå§‹åŒ–å...&quot;</span> + beanName);</span><br><span class="line"></span><br><span class="line">UserComponent userComponent = (UserComponent) bean;</span><br><span class="line">userComponent.setUserName(<span class="string">&quot;liuzhihang-postProcessAfterInitialization&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> userComponent;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä»£ç æ‰€ç¤ºï¼Œåªéœ€è¦å£°æ˜ä¸€ä¸ªè‡ªå·±çš„ MyBeanPostProcessor æ¥å®ç° <code>BeanPostProcessor</code> å¹¶é‡å†™å…¶æ–¹æ³•ï¼š</p><p>postProcessBeforeInitialization ï¼šåœ¨ Bean å®ä¾‹åè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ä¹‹å‰è¿›è¡Œå¤„ç†ã€‚</p><p>postProcessAfterInitialization ï¼šåœ¨ Bean å®ä¾‹åŒ–åè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ä¹‹åè¿›è¡Œå¤„ç†ã€‚</p><p>å¹¶ä¸”åœ¨æµ‹è¯•æ—¶å¯ä»¥å‘ç°ï¼ŒBeanPostProcessor ä¿®æ”¹çš„å±æ€§ä¼šè¦†ç›– BeanFactoryPostProcessorï¼Œè‡³äºåŸå› å¯ä»¥é˜…è¯»ä¸‹ <a href="https://mp.weixin.qq.com/s/6VrVDg4m6yi7V4rZZB-6tA">Spring æºç å­¦ä¹  11ï¼šinvokeBeanFactoryPostProcessors</a> è¿™ç¯‡æ–‡ç« ï¼Œç›¸ä¿¡å¯¹ BeanFactoryPostProcessor æœ‰äº†ä¸€å®šçš„äº†è§£ä¹‹åï¼Œä¸€å®šä¼šæœ‰è‡ªå·±çš„ç­”æ¡ˆã€‚</p><p>å½“ç„¶æˆ‘ä¸ªäººçš„ç†è§£å°±æ˜¯ BeanFactoryPostProcessor æ˜¯åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ˜¯é€šè¿‡ä¿®æ”¹å…ƒæ•°æ®ä»è€Œä¿®æ”¹çš„ Bean çš„å…ƒç´ ä¿¡æ¯ã€‚</p><p>è¿™å—ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç è¿›è¡ŒéªŒè¯ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/mHNyKC-SBWUcw.png"></p><p>å¯ä»¥çœ‹å‡ºï¼Œæ‰§è¡Œé¡ºåºæ˜¯</p><p><code>BeanFactoryPostProcessor#postProcessBeanFactory</code><br>-&gt;<br><code>BeanPostProcessor#postProcessBeforeInitialization</code><br>-&gt;<br><code>BeanPostProcessor#postProcessAfterInitialization</code></p><p>æ‰€ä»¥ï¼Œåé¢ä¿®æ”¹çš„å±æ€§ï¼Œä¼šè¦†ç›–ä¹‹å‰ä¿®æ”¹çš„å±æ€§ã€‚</p><p>è‡³äº <code>BeanPostProcessor</code> æ˜¯å¦‚ä½•ä¿®æ”¹å±æ€§çš„ï¼Œåœ¨è¿™é‡Œå…ˆä¸åšä»‹ç»ï¼Œç»§ç»­è¿›å…¥æœ¬èŠ‚çš„ä¸»è§’ <code>registerBeanPostProcessors æºç åˆ†æ</code> </p><h3 id="registerBeanPostProcessors-æºç "><a href="#registerBeanPostProcessors-æºç " class="headerlink" title="registerBeanPostProcessors æºç "></a>registerBeanPostProcessors æºç </h3><p>åœ¨ Spring refresh æ–¹æ³•ä¸­ï¼Œæ‰§è¡Œ registerBeanPostProcessors ä¸»è¦ä½œç”¨æ˜¯å°† BeanPostProcessor æ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œæºç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨äº† <code>PostProcessorRegistrationDelegate</code> ç±»çš„é™æ€æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾ BeanPostProcessor ç±»å‹çš„ Bean çš„åç§°é›†åˆ, å°±æ˜¯è·å–æ‰€æœ‰ç»§æ‰¿äº† BeanPostProcessor çš„ç±»</span></span><br><span class="line">    String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register BeanPostProcessorChecker that logs an info message when</span></span><br><span class="line">    <span class="comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span></span><br><span class="line">    <span class="comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span></span><br><span class="line">    <span class="comment">//  æ³¨å†Œä¸€ä¸ª BeanPostProcessorCheckerï¼Œç”¨æ¥è®°å½• bean åœ¨ BeanPostProcessor å®ä¾‹åŒ–æ—¶çš„ä¿¡æ¯ã€‚</span></span><br><span class="line">    <span class="keyword">int</span> beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + <span class="number">1</span> + postProcessorNames.length;</span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">    <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">    <span class="comment">// å››ä¸ªé›†åˆ åŒºåˆ†å®ç°ä¸åŒæ¥å£çš„ BeanPostProcessors</span></span><br><span class="line">    List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">            priorityOrderedPostProcessors.add(pp);</span><br><span class="line">            <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">                internalPostProcessors.add(pp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">    <span class="comment">// æ’åºåæ‰§è¡Œ å®ç° PriorityOrdered çš„ BeanPostProcessors</span></span><br><span class="line">    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, register the BeanPostProcessors that implement Ordered.</span></span><br><span class="line">    List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">        BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">        orderedPostProcessors.add(pp);</span><br><span class="line">        <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now, register all regular BeanPostProcessors.</span></span><br><span class="line">    List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">        nonOrderedPostProcessors.add(pp);</span><br><span class="line">        <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finally, re-register all internal BeanPostProcessors.</span></span><br><span class="line">    sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span></span><br><span class="line">    <span class="comment">// moving it to the end of the processor chain (for picking up proxies etc).</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(applicationContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­æ·»åŠ äº†ç›¸åº”çš„æ³¨é‡Šï¼Œç›¸ä¿¡è¯»è¿‡ä¸Šä¸€ç¯‡æ–‡ç« ï¼ˆinvokeBeanFactoryPostProcessors æºç ï¼‰çš„å°ä¼™ä¼´ï¼Œä¸€å®šä¼šæ„Ÿè§‰éå¸¸ç†Ÿæ‚‰ï¼Œè¿™ä¸ªæ–¹æ³•çš„é€»è¾‘å’Œä¸Šé¢åŸºæœ¬ä¸€è‡´ï¼Œéƒ½æ˜¯å£°æ˜é›†åˆï¼Œæ’åºï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ã€‚</p><p>ä¸è¿‡è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š</p><p><code>registerBeanPostProcessors è¿™ä¸€æ­¥ä»…ä»…å°† BeanPostProcessor æ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œï¼ï¼ï¼</code></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æœ¬æ–‡æºç éƒ¨åˆ†ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œä¸»è¦èŠ±è´¹éƒ¨åˆ†ç¯‡å¹…ä»‹ç»ä»€ä¹ˆæ˜¯ BeanPostProcessor ä»¥åŠ BeanPostProcessor çš„ä½¿ç”¨æ–¹æ³•ã€‚</p><p>ä¸€å¥è¯æ€»ç»“è¿™ä¸€æ­¥å°±æ˜¯ï¼šæ³¨å†Œ BeanPostProcessor åˆ° BeanFactory ä¸­ï¼Œä½†æ˜¯æ²¡æœ‰æ‰§è¡Œã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/dHDiOq-CxKXF8.png"></p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/6VrVDg4m6yi7V4rZZB-6tA">Spring æºç å­¦ä¹  11ï¼šinvokeBeanFactoryPostProcessors</a></li><li><a href="https://mp.weixin.qq.com/s/6vTqVFC4frjhqdMirGPCnQ">Spring æºç å­¦ä¹  10ï¼šprepareBeanFactory å’Œ postProcessBeanFactory</a></li><li><a href="https://mp.weixin.qq.com/s/i6vdCmOO2ZMsYWfheSLc6g">Spring æºç å­¦ä¹  09ï¼šrefresh å¤§æ¦‚æµç¨‹</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  11ï¼šinvokeBeanFactoryPostProcessors</title>
      <link href="2020/12/28/source-spring-11.html"/>
      <url>2020/12/28/source-spring-11.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>invokeBeanFactoryPostProcessors ä¼šæ‰§è¡Œ BeanFactory çš„åç½®å¤„ç†å™¨ã€‚çœ‹åˆ°è¿™é‡Œä¼šæœ‰ç–‘é—®ï¼š</p><ol><li>ä»€ä¹ˆæ˜¯ BeanFactoryPostProcessor ï¼Ÿ</li><li>BeanfactoryPostProcessor è¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿ</li></ol><p>çŸ¥é“äº†ä¸Šé¢ä¸¤ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œå¯¹ BeanFactoryPostProcessor æœ‰äº†äº†è§£ä¹‹åï¼Œç„¶åå†æ·±å…¥æºç ï¼Œç»§ç»­é˜…è¯» invokeBeanFactoryPostProcessors è¿™ä¸ªæ–¹æ³•ã€‚</p><h3 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h3><p>èµ„æ–™è¿˜æ˜¯åœ¨<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-extension-factory-postprocessors" title="Customizing Configuration Metadata with a BeanFactoryPostProcessor">å®˜ç½‘</a>å¯ä»¥æ‰¾åˆ°ç­”æ¡ˆ:</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ZCnfJ9-tR3MFK.png"></p><p>é˜…è¯»äº†ä¸€ä¸‹ï¼Œå¤§æ¦‚æ„æ€æ˜¯ <code>Spring IoC å®¹å™¨å…è®¸ BeanFactoryPostProcessor è¯»å–é…ç½®å…ƒæ•°æ®ï¼Œå¹¶æœ‰å¯èƒ½åœ¨å®¹å™¨å®ä¾‹åŒ–é™¤ BeanFactoryPostProcessor å®ä¾‹ä»¥å¤–çš„ä»»ä½• bean ä¹‹å‰æ›´æ”¹å®ƒã€‚</code></p><p>åŒæ ·å¯ä»¥ä½¿ç”¨ Ordered æ¥å£å¯¹ BeanFactoryPostProcessor è¿›è¡Œæ’åºã€‚</p><h4 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/XmG0jo-mewyfG.png"></p><p>BeanFactoryPostProcessor æ“ä½œçš„æ˜¯ BeanDefinition ï¼Œå³å…ƒæ•°æ®ã€‚ä½†æ˜¯åŒæ ·å¯ä»¥é€šè¿‡è·å–åˆ° BeanFactory è¿›è¡Œå®ä¾‹åŒ– Beanï¼Œä½†æ˜¯å®˜ç½‘å¾ˆä¸å»ºè®®è¿™æ ·ä½¿ç”¨ã€‚</p><h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><h4 id="ä½¿ç”¨-BeanFactoryPostProcessor"><a href="#ä½¿ç”¨-BeanFactoryPostProcessor" class="headerlink" title="ä½¿ç”¨ BeanFactoryPostProcessor"></a>ä½¿ç”¨ BeanFactoryPostProcessor</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¿®æ”¹ BeanDefinition ä¿¡æ¯</span></span><br><span class="line">        BeanDefinition userComponentBeanDefinition = beanFactory.getBeanDefinition(<span class="string">&quot;userComponent&quot;</span>);</span><br><span class="line">        userComponentBeanDefinition.setLazyInit(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¿®æ”¹ Bean çš„ä¿¡æ¯</span></span><br><span class="line">        <span class="comment">// xxx éå¸¸ä¸æ¨è beanFactory.getBean è¿‡æ—©çš„å®ä¾‹åŒ– Bean</span></span><br><span class="line">        UserComponent bean = beanFactory.getBean(UserComponent.class);</span><br><span class="line">        bean.setUserName(<span class="string">&quot;liuzhihang-01&quot;</span>);</span><br><span class="line">            </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºè‡ªå·±çš„ BeanFactoryPostProcessor å¹¶å®ç° BeanFactoryPostProcessor æ¥å£ï¼Œæ·»åŠ æ³¨è§£å³å¯ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/8dEPpR-aN53mU.png"></p><p>å½“ç„¶é™¤äº†å®ç° BeanFactoryPostProcessor æ¥å£ï¼Œè¿˜æœ‰å…¶ä»–æ¥å£å¯ä»¥å®ç°ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/llYeQ9-DTwOme.png"></p><h4 id="ä½¿ç”¨-BeanDefinitionRegistryPostProcessor"><a href="#ä½¿ç”¨-BeanDefinitionRegistryPostProcessor" class="headerlink" title="ä½¿ç”¨ BeanDefinitionRegistryPostProcessor"></a>ä½¿ç”¨ BeanDefinitionRegistryPostProcessor</h4><p>BeanDefinitionRegistryPostProcessor ç»§æ‰¿äº† BeanFactoryPostProcessorï¼ŒåŒæ—¶æ‰©å±•äº†å¢åŠ äº† <code>postProcessBeanDefinitionRegistry</code> æ–¹æ³•ã€‚å¯ä»¥æ”¯æŒåœ¨ BeanDefinition æ³¨å†Œä¹‹å Bean å®ä¾‹åŒ–ä¹‹å‰å¯¹ BeanDefinition è¿›è¡Œæ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanDefinitionRegistryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="comment">// ä¿®æ”¹ BeanDefinition ä¿¡æ¯</span></span><br><span class="line">        BeanDefinition userComponentBeanDefinition = beanFactory.getBeanDefinition(<span class="string">&quot;userComponent&quot;</span>);</span><br><span class="line">        userComponentBeanDefinition.setLazyInit(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¿®æ”¹ Bean çš„ä¿¡æ¯</span></span><br><span class="line">        <span class="comment">// xxx éå¸¸ä¸æ¨è beanFactory.getBean è¿‡æ—©çš„å®ä¾‹åŒ– Bean</span></span><br><span class="line">        UserComponent bean = beanFactory.getBean(UserComponent.class);</span><br><span class="line">        bean.setUserName(<span class="string">&quot;liuzhihang-01&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨å†Œä¸€ä¸ª BeanDefinition</span></span><br><span class="line">        BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(OrderComponent.class);</span><br><span class="line"></span><br><span class="line">        AbstractBeanDefinition orderComponentBeanDefinition = builder.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">        registry.registerBeanDefinition(<span class="string">&quot;orderComponent&quot;</span>, orderComponentBeanDefinition);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æµ‹è¯•ä»£ç æˆªå›¾ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/OAsBSh-FPE9FY.png"></p><p>OrderComponent ç±»æ²¡æœ‰æ·»åŠ ä»»ä½•æ³¨è§£ï¼Œç„¶åæ³¨å†Œä¸º BeanDefinition ä¹‹åï¼Œä»å®¹å™¨ä¸­å¯ä»¥è·å–åˆ° orderComponentã€‚</p><h4 id="å¦‚ä½•ä¿®æ”¹å­—æ®µå±æ€§"><a href="#å¦‚ä½•ä¿®æ”¹å­—æ®µå±æ€§" class="headerlink" title="å¦‚ä½•ä¿®æ”¹å­—æ®µå±æ€§"></a>å¦‚ä½•ä¿®æ”¹å­—æ®µå±æ€§</h4><p>åœ¨ Spring æ–‡æ¡£ä¸Šè¯´æ˜ï¼Œéå¸¸ä¸å»ºè®®åœ¨ BeanFactoryPostProcessor ä¸­å®ä¾‹åŒ– Beanï¼Œé‚£è¿™æ—¶å€™æƒ³ä¿®æ”¹ Bean çš„ä¿¡æ¯ï¼Œæ”¹å¦‚ä½•æ“ä½œï¼Ÿ</p><p>å…¶å®å¯ä»¥é€šè¿‡è·å–åˆ° <code>MutablePropertyValues</code> åè¿›è¡Œæ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¿®æ”¹ BeanDefinition ä¿¡æ¯</span></span><br><span class="line">        BeanDefinition userComponentBeanDefinition = beanFactory.getBeanDefinition(<span class="string">&quot;userComponent&quot;</span>);</span><br><span class="line">        userComponentBeanDefinition.setLazyInit(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        MutablePropertyValues userComponentPropertyValues = userComponentBeanDefinition.getPropertyValues();</span><br><span class="line"></span><br><span class="line">        userComponentPropertyValues.addPropertyValue(<span class="string">&quot;userName&quot;</span>, <span class="string">&quot;liuzhihang-02&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¿®æ”¹ Bean çš„ä¿¡æ¯</span></span><br><span class="line">        <span class="comment">// xxx éå¸¸ä¸æ¨è beanFactory.getBean è¿‡æ—©çš„å®ä¾‹åŒ– Bean</span></span><br><span class="line">        <span class="comment">// UserComponent bean = beanFactory.getBean(UserComponent.class);</span></span><br><span class="line">        <span class="comment">// bean.setUserName(&quot;liuzhihang-01&quot;);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="invokeBeanFactoryPostProcessors"><a href="#invokeBeanFactoryPostProcessors" class="headerlink" title="invokeBeanFactoryPostProcessors"></a>invokeBeanFactoryPostProcessors</h3><p>çœ‹å®Œå‰é¢ï¼Œæˆ‘æƒ³å·²ç»çŸ¥é“äº† BeanFactoryPostProcessor æ˜¯åšä»€ä¹ˆç”¨çš„äº†ï¼Œè€Œè¿™ä¸€æ­¥çš„ä¸»è¦ä½œç”¨å°±æ˜¯å®ä¾‹åŒ–æ‰€æœ‰çš„ BeanFactoryPostProcessorã€‚</p><p>è¿›å…¥æºç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span></span><br><span class="line">    <span class="comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span></span><br><span class="line">    <span class="keyword">if</span> (!IN_NATIVE_IMAGE &amp;&amp; beanFactory.getTempClassLoader() == <span class="keyword">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">        beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ getBeanFactoryPostProcessors æ–¹æ³•è·å–çš„æ˜¯è‡ªå·±æ·»åŠ çš„ BeanFactoryPostProcessorã€‚è¿™å¥è¯æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;BeanFactoryPostProcessor&gt; <span class="title">getBeanFactoryPostProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.beanFactoryPostProcessors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹æºç ï¼Œå°±æ˜¯ç›´æ¥ä» beanFactoryPostProcessors è·å–çš„ï¼Œé‚£å¦‚ä½•å‘å…¶ä¸­æ·»åŠ å‘¢ï¼Ÿ</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/jWhWAu-MicUEW.png"></p><p>å…¶å®è°ƒç”¨å®¹å™¨çš„ <code>addBeanFactoryPostProcessor</code> æ–¹æ³•å³å¯ã€‚</p><p>ç»§ç»­é˜…è¯»é‡ç‚¹ä»£ç  <code>invokeBeanFactoryPostProcessors</code> ï¼š</p><p>æ³¨æ„æ³¨æ„ï¼Œè¿™å—ä»£ç éå¸¸é•¿ï¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span></span><br><span class="line">    Set&lt;String&gt; processedBeans = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸º BeanDefinitionRegistry</span></span><br><span class="line">    <span class="comment">// debug å‘ç° è¿™é‡Œä¼ å…¥çš„æ˜¯ DefaultListableBeanFactory</span></span><br><span class="line">    <span class="comment">// DefaultListableBeanFactory å®ç°äº† BeanDefinitionRegistry</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry) &#123;</span><br><span class="line">        BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºäº†ä¸¤ä¸ª List é›†åˆ, ç”¨æ¥å­˜æ”¾å¤„ç†å™¨</span></span><br><span class="line">        <span class="comment">// BeanDefinitionRegistryPostProcessor æ˜¯ BeanFactoryPostProcessor çš„å­æ¥å£</span></span><br><span class="line">        <span class="comment">// BeanDefinitionRegistryPostProcessor è¿˜å¯ä»¥é¢å¤–å¤„ç† BeanDefinition, æ·»åŠ  BeanDefinition</span></span><br><span class="line">        <span class="comment">// ç”¨æ³•å¯ä»¥å‚è€ƒç¤ºä¾‹</span></span><br><span class="line">        List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾ªç¯ beanFactoryPostProcessors</span></span><br><span class="line">        <span class="comment">// beanFactoryPostProcessors æ˜¯ä½¿ç”¨ API context.addBeanFactoryPostProcessor æ·»åŠ è¿›æ¥çš„</span></span><br><span class="line">        <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// BeanDefinitionRegistryPostProcessor è¦å•ç‹¬æ·»åŠ åˆ° registryProcessors</span></span><br><span class="line">            <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;</span><br><span class="line">                BeanDefinitionRegistryPostProcessor registryProcessor =</span><br><span class="line">                        (BeanDefinitionRegistryPostProcessor) postProcessor;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¤„ç† Bean çš„ä¿¡æ¯</span></span><br><span class="line">                registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">                registryProcessors.add(registryProcessor);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                regularPostProcessors.add(postProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">        <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line">        <span class="comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span></span><br><span class="line">        <span class="comment">// PriorityOrdered, Ordered, and the rest.</span></span><br><span class="line">        <span class="comment">// ä¸Šé¢å¾ªç¯æ˜¯æ‰§è¡Œçš„æˆ‘ä»¬è°ƒç”¨ API æ·»åŠ çš„ BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">        <span class="comment">// ä¸‹é¢æ‰§è¡Œ Spring è‡ªå·±çš„ BeanDefinitionRegistryPostProcessor é›†åˆ</span></span><br><span class="line">        <span class="comment">// å…ˆæ‰§è¡Œå®ç°äº† PriorityOrderedæ¥å£çš„ï¼Œç„¶åæ˜¯ Ordered æ¥å£çš„ï¼Œæœ€åæ‰§è¡Œå‰©ä¸‹çš„</span></span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ­¥å…ˆè°ƒç”¨ BeanDefinitionRegistryPostProcessors å®ƒå®ç°äº†PriorityOrdered</span></span><br><span class="line">        <span class="comment">// åœ¨åˆå§‹åŒ– reader æ—¶ åœ¨æ³¨å†Œäº† ConfigurationClassPostProcessor åˆ°å®¹å™¨é‡Œé¢</span></span><br><span class="line">        <span class="comment">// BeanDefinitionRegistryPostProcessor å®ç°äº† BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">        String[] postProcessorNames =</span><br><span class="line">                beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">                <span class="comment">// æ·»åŠ  bean</span></span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                <span class="comment">// è¿™é‡Œåªæ·»åŠ äº†åå­— åé¢ç”¨æ¥åˆ¤æ–­è°å·²ç»æ‰§è¡Œè¿‡äº†</span></span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ’åº</span></span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾ªç¯æ‰§è¡Œ processors çš„ postProcessBeanDefinitionRegistry æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªå¾—åœ¨ä»”ç»†çœ‹</span></span><br><span class="line">        <span class="comment">// debug çœ‹åˆ° æ‰§è¡Œå®Œè¿™ä¸€æ­¥æˆ‘å¦ä¸€ä¸ªåŠ  @Component æ³¨è§£çš„ç±» æ³¨å†Œåˆ° Registry é‡Œé¢äº†</span></span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        <span class="comment">// æ¸…é™¤</span></span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span></span><br><span class="line">        <span class="comment">// å¤„ç†å®ç° Ordered çš„ processor</span></span><br><span class="line">        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="comment">// åªæœ‰ä¸åŒ…å«çš„æ‰æ‰§è¡Œ, æ‰§è¡Œå®Œä¹‹åä¼šæ·»åŠ è¿› processedBeans</span></span><br><span class="line">            <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åŒä¸Š</span></span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span></span><br><span class="line">        <span class="comment">// æœ€åæ‰§è¡Œå…¶ä»–</span></span><br><span class="line">        <span class="keyword">boolean</span> reiterate = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">            reiterate = <span class="keyword">false</span>;</span><br><span class="line">            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">                <span class="comment">// åªæœ‰ä¸åŒ…å«çš„æ‰æ‰§è¡Œ, æ‰§è¡Œå®Œä¹‹åä¼šæ·»åŠ è¿› processedBeans</span></span><br><span class="line">                <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                    processedBeans.add(ppName);</span><br><span class="line">                    reiterate = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">            registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">            currentRegistryProcessors.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span></span><br><span class="line">        <span class="comment">// ä¸Šé¢å¤„ç†çš„éƒ½æ˜¯ postProcessBeanDefinitionRegistry æ˜¯åœ¨ -&gt; BeanDefinitionRegistryPostProcessor ä¸­</span></span><br><span class="line">        <span class="comment">// ä¸‹é¢å¼€å§‹å¤„ç† postProcessBeanFactory  -&gt; æ˜¯åœ¨ BeanFactoryPostProcessor ä¸­</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Invoke factory processors registered with the context instance.</span></span><br><span class="line">        <span class="comment">// ä¸æ˜¯ BeanDefinitionRegistry åˆ™æ˜¯æ™®é€š BeanFactory ç›´æ¥æ‰§è¡Œ beanFactoryPostProcessors å³å¯</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">    <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬äºŒéƒ¨åˆ†</span></span><br><span class="line">    <span class="comment">// ä¸Šé¢æ‰§è¡Œçš„æ˜¯ BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">    <span class="comment">// ä¸‹é¢å¼€å§‹æ‰§è¡Œ BeanFactoryPostProcessor</span></span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">    <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">    <span class="comment">// æŒ‰ç…§é¡ºåºæ‰§è¡Œ</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">            <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">            <span class="comment">// è¯´æ˜ä¸Šé¢å·²ç»æ‰§è¡Œäº†, ä¸‹é¢å¿½ç•¥</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">    <span class="comment">// æ‰§è¡Œå®ç° PriorityOrdered çš„</span></span><br><span class="line">    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finally, invoke all other BeanFactoryPostProcessors.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear cached merged bean definitions since the post-processors might have</span></span><br><span class="line">    <span class="comment">// modified the original metadata, e.g. replacing placeholders in values...</span></span><br><span class="line">    <span class="comment">// æ¸…ç©ºä¸å¿…è¦çš„å…ƒæ•°æ®ä¿¡æ¯</span></span><br><span class="line">    beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ€»ä½“å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ol><li>æ‰§è¡Œ BeanDefinitionRegistryPostProcessor æ¥å£é‡Œé¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼špostProcessBeanDefinitionRegistry å’Œ postProcessBeanFactoryã€‚</li><li>æ‰§è¡Œ BeanFactoryPostProcessor æ¥å£é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚</li></ol><p>ä»¥ç¬¬ä¸€éƒ¨åˆ†ä¸ºä¾‹ï¼š</p><ol><li>é¦–å…ˆåˆ¤æ–­ä¼ å…¥çš„ BeanFactory æ˜¯å¦ä¸º BeanDefinitionRegistry<ol><li>å£°æ˜ä¸¤ä¸ª List é›†åˆï¼ŒregularPostProcessors ç”¨æ¥å­˜å‚¨ BeanFactoryPostProcessorï¼ŒregistryProcessors ç”¨æ¥å­˜å‚¨ BeanDefinitionRegistryPostProcessor<ol><li>å¾ªç¯ beanFactoryPostProcessorsï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨ API æ–¹å¼æ·»åŠ è¿›æ¥çš„ BeanFactoryPostProcessorã€‚</li><li>åœ¨å¾ªç¯ä¸­ BeanDefinitionRegistryPostProcessor çš„ postProcessBeanDefinitionRegistry ä¼šè¢«æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ç¤ºä¾‹çš„é‚£ä¸ªæ·»åŠ  BeanDefinition æ¼”ç¤ºçš„æ–¹æ³•ä¼šè¢«æ‰§è¡Œã€‚</li></ol></li><li>å¼€å§‹æ‰§è¡Œ Spring è‡ªå·±çš„ BeanDefinitionRegistryPostProcessorï¼Œ å¤„ç†é¡ºåºä¸º PriorityOrdered, Ordered, and the rest<ol><li>å¾ªç¯ï¼Œå°†å¯¹åº”çš„ BeanDefinitionRegistryPostProcessor æ·»åŠ åˆ° currentRegistryProcessors é›†åˆå’ŒprocessedBeansé›†åˆè¡¨ç¤ºä¸ºå·²ç»å¤„ç†ã€‚</li><li>æ’åºåæ·»åŠ åˆ°ç¬¬ä¸€æ­¥çš„ registryProcessors ä¸­ã€‚</li><li>è°ƒç”¨ invokeBeanDefinitionRegistryPostProcessors æ‰§è¡Œæ‰€æœ‰çš„ Processor é‡Œé¢çš„ postProcessBeanDefinitionRegistry æ–¹æ³•</li></ol></li><li>æ‰§è¡Œå®Œ 1 å’Œ 2 ä¹‹åï¼Œæ‰€æœ‰çš„ postProcessBeanDefinitionRegistry å·²ç»è¢«æ‰§è¡Œå®Œäº†ï¼Œä½†æ˜¯ä¸¤ä¸ªé›†åˆï¼ˆregistryProcessorsã€regularPostProcessorsï¼‰é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•è¿˜æ²¡æœ‰è¢«æ‰§è¡Œã€‚æœ€åä¼šå¾ªç¯æ‰§è¡Œã€‚</li></ol></li><li>å¦‚æœä¸æ˜¯ BeanDefinitionRegistry ç±»å‹ï¼Œåˆ™ç›´æ¥æ‰§è¡Œä¼ å…¥çš„ beanFactoryPostProcessors å³å¯ã€‚</li></ol><p>ä¸‹é¢æ˜¯å¯¹åº”çš„ä»£ç æˆªå›¾</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/vc4xUC-rCOdvD.png"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/1A06zT-DDaqjY.png"></p><p>ä»¥ä¸Šåªæ˜¯è¿™ä¸ªæ–¹æ³•çš„å‰åŠéƒ¨åˆ†ï¼Œæ‰§è¡Œäº† BeanDefinitionRegistryPostProcessor é‡Œé¢çš„ postProcessBeanDefinitionRegistry å’Œ postProcessBeanFactoryã€‚</p><p>å› ä¸ºè¿˜æœ‰ç›´æ¥å®ç° BeanFactoryPostProcessor çš„å¤„ç†å™¨ï¼Œä¸‹é¢åˆ™å¼€å§‹å¤„ç† BeanFactoryPostProcessor çš„å¤„ç†å™¨ã€‚è¿‡ç¨‹å’Œä¸Šé¢ç±»ä¼¼ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é€šè¿‡ä»¥ä¸Šçš„é˜…è¯»ï¼Œå¯¹ <code>invokeBeanFactoryPostProcessors(beanFactory);</code> è¿™ä¸€æ­¥æ–¹æ³•è¿›è¡Œæ€»ç»“ã€‚</p><h4 id="BeanFactoryPostProcessor-ä½œç”¨"><a href="#BeanFactoryPostProcessor-ä½œç”¨" class="headerlink" title="BeanFactoryPostProcessor ä½œç”¨"></a>BeanFactoryPostProcessor ä½œç”¨</h4><p>BeanFactoryPostProcessor ä¸»è¦ä½œç”¨æ˜¯åœ¨æ³¨å†Œ BeanDefinition ä¹‹åï¼Œåœ¨ Bean åˆå§‹åŒ–ä¹‹å‰ï¼Œä¿®æ”¹ BeanDefinition çš„ä¿¡æ¯ã€‚</p><p>BeanFactoryPostProcessor æœ‰ä¸ªå®ç°å« BeanDefinitionRegistryPostProcessorï¼Œå®ƒå¯ä»¥é¢å¤–çš„æ³¨å†Œæ–°çš„ BeanDefinition åˆ°å®¹å™¨ä¸­ã€‚</p><h4 id="æµç¨‹æ¦‚è¿°"><a href="#æµç¨‹æ¦‚è¿°" class="headerlink" title="æµç¨‹æ¦‚è¿°"></a>æµç¨‹æ¦‚è¿°</h4><ol><li>è¿™ä¸€æ­¥ä¸»è¦æ˜¯å¤„ç† BeanFactoryPostProcessorï¼Œåˆ†ä¸ºä¸¤æ­¥ã€‚</li><li>æ‰§è¡Œ BeanDefinitionRegistryPostProcessor æ¥å£é‡Œé¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼špostProcessBeanDefinitionRegistry å’Œ postProcessBeanFactoryã€‚</li><li>æ‰§è¡Œ BeanFactoryPostProcessor æ¥å£é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/hoPCO0-yAfXNu.png"></p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/6vTqVFC4frjhqdMirGPCnQ">Spring æºç å­¦ä¹  10ï¼šprepareBeanFactory å’Œ postProcessBeanFactory</a></li><li><a href="https://mp.weixin.qq.com/s/i6vdCmOO2ZMsYWfheSLc6g">Spring æºç å­¦ä¹  09ï¼šrefresh å¤§æ¦‚æµç¨‹</a></li><li><a href="https://mp.weixin.qq.com/s/XPljpjGBpD7t2cmPAofm7A">Spring æºç å­¦ä¹  08ï¼šregister æ³¨å†Œé…ç½®ç±»</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  10ï¼šprepareBeanFactory å’Œ postProcessBeanFactory</title>
      <link href="2020/12/27/source-spring-10.html"/>
      <url>2020/12/27/source-spring-10.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æ ¹æ® refresh æµç¨‹ï¼Œå½“ <code>obtainFreshBeanFactory</code> æ‰§è¡Œç»“æŸåï¼Œä¸‹ä¸€æ­¥ä¼šæ‰§è¡Œ <code>prepareBeanFactory</code> ï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯<code>å‡†å¤‡ BeanFactory</code>ï¼Œä¸‹é¢ä¸€èµ·çœ‹ä¸€çœ‹è¿™éƒ¨åˆ†é€»è¾‘ã€‚</p><h3 id="prepareBeanFactory"><a href="#prepareBeanFactory" class="headerlink" title="prepareBeanFactory"></a>prepareBeanFactory</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line"><span class="comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span></span><br><span class="line"><span class="comment">// è®¾ç½®beanFactoryçš„ç±»åŠ è½½å™¨</span></span><br><span class="line">beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line"><span class="comment">// spring.spel.ignore å±æ€§æ§åˆ¶æ˜¯å¦è§£æ SpEL è¡¨è¾¾å¼</span></span><br><span class="line"><span class="keyword">if</span> (!shouldIgnoreSpel) &#123;</span><br><span class="line">beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è®¾ç½®å±æ€§è§£æå™¨</span></span><br><span class="line">beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> ResourceEditorRegistrar(<span class="keyword">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Configure the bean factory with context callbacks.</span></span><br><span class="line"><span class="comment">// æ·»åŠ åˆ°åç½®å¤„ç†å™¨åˆ—è¡¨, æ–°åˆ›å»ºçš„ ApplicationContextAwareProcessor å…¥å‚ä¸ºå½“å‰ ApplicationContext</span></span><br><span class="line">beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¿½ç•¥è‡ªåŠ¨è£…é…</span></span><br><span class="line"><span class="comment">// é»˜è®¤æƒ…å†µä¸‹ åªæœ‰BeanFactoryAware è¢«å¿½ç•¥ è¦å¿½ç•¥å…¶ä»–ç±»å‹ï¼Œéœ€è¦å•ç‹¬è®¾ç½®</span></span><br><span class="line">beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line">beanFactory.ignoreDependencyInterface(ApplicationStartup.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span></span><br><span class="line"><span class="comment">// MessageSource registered (and found for autowiring) as a bean.</span></span><br><span class="line"><span class="comment">// æ³¨å†Œè‡ªåŠ¨è£…é…çš„ç±»</span></span><br><span class="line">beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line">beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span></span><br><span class="line"><span class="comment">// æ˜¯å¦éœ€è¦ç±»åŠ è½½æœŸé—´ç»‡å…¥  å¢åŠ Aspectjçš„æ”¯æŒ</span></span><br><span class="line"><span class="keyword">if</span> (!IN_NATIVE_IMAGE &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line"><span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register default environment beans.</span></span><br><span class="line"><span class="comment">// æ³¨å†Œå…¶ä»–çš„ bean</span></span><br><span class="line"><span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!beanFactory.containsLocalBean(APPLICATION_STARTUP_BEAN_NAME)) &#123;</span><br><span class="line">beanFactory.registerSingleton(APPLICATION_STARTUP_BEAN_NAME, getApplicationStartup());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å—ä»£ç æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±ç›´æ¥è´´ä»£ç äº†ã€‚</p><p>å†å¯¹ä»£ç è¿›è¡Œåˆ†æï¼Œä¸»è¦ç»å†ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š</p><ol><li>addBeanPostProcessor æ·»åŠ  BeanPostProcessor</li><li>registerResolvableDependency æ³¨å†Œä¾èµ–å…³ç³»</li><li>registerSingleton æ³¨å†Œå…¶ä»–çš„å•ä¾‹ Bean</li></ol><p>ä¸‹é¢å¯ä»¥ Debug çœ‹ä¸€ä¸‹ã€‚</p><h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>æ–¹æ³•è°ƒç”¨å‰ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/NJwbIq-S5vLU0.png"></p><p>registerResolvableDependency æ‰§è¡Œä¹‹å</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/aRpomY-pOoRdu.png"></p><p>è¿™é‡Œå‘ç°è°ƒç”¨ <code>registerResolvableDependency</code> æ‰§è¡Œç»“æŸä¹‹åï¼Œ<code>beanDefinitionNames</code> ä¸­å¹¶æ²¡æœ‰å¤šæ·»åŠ ç›¸å…³å¯¹è±¡ã€‚</p><p>æŸ¥çœ‹æºç å‘ç°å…¶å®æ˜¯æ·»åŠ åˆ°äº† <code>resolvableDependencies</code> è¿™ä¸ª Map ä¸­äº†ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/r83Zdu-IywxsL.png"></p><blockquote><p>å›é¡¾</p><p>åœ¨ä»‹ç» <code>DefaultListableBeanFactory</code> æ—¶ï¼Œè¯´ BeanDefinition æ˜¯å­˜å‚¨åœ¨ beanDefinitionMap ä¸­çš„ã€‚<br>è€Œè¿™é‡Œçš„ä¾èµ–å…³ç³»æ˜¯åˆ™æ˜¯å­˜å‚¨åœ¨ <code>resolvableDependencies</code> ä¸­çš„ã€‚</p></blockquote><h3 id="postProcessBeanFactory"><a href="#postProcessBeanFactory" class="headerlink" title="postProcessBeanFactory"></a>postProcessBeanFactory</h3><p>åœ¨æ‰§è¡Œ prepareBeanFactory ä¹‹åï¼Œå½“çœ‹åˆ° <code>postProcessBeanFactory(beanFactory);</code> æ–¹æ³•çš„æ—¶å€™å°±å¾ˆç–‘æƒ‘ï¼Œ å› ä¸ºè¿™ä¸ªæ˜¯éœ€è¦å­ç±»å®ç°çš„ï¼Œåªæ˜¯ä½œä¸ºä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå­ç±»å®ç°ä¹‹åï¼Œå¯ä»¥åœ¨é‡Œé¢æ·»åŠ è‡ªå·±çš„é€»è¾‘ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è¿™ç¯‡æ–‡ç« ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å‡†å¤‡ BeanFactory å‘å…¶ä¸­æ·»åŠ ç³»ç»Ÿçš„ä¾èµ–ä»¥åŠ bean, è€Œ postProcessBeanFactory åˆ™æ˜¯ä¸€ä¸ªæ¨¡ç‰ˆæ–¹æ³•ç”¨æ¥ä¾›å­ç±»å®ç°ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/nDmWFO-dHVLOp.png"></p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/i6vdCmOO2ZMsYWfheSLc6g">Spring æºç å­¦ä¹  09ï¼šrefresh å¤§æ¦‚æµç¨‹</a></li><li><a href="https://mp.weixin.qq.com/s/XPljpjGBpD7t2cmPAofm7A">Spring æºç å­¦ä¹  08ï¼šregister æ³¨å†Œé…ç½®ç±»</a></li><li><a href="https://mp.weixin.qq.com/s/VnUugIxZkUcqDvt9Yv47iQ">Spring æºç å­¦ä¹  07ï¼šClassPathBeanDefinitionScanner</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  09ï¼šrefresh å¤§æ¦‚æµç¨‹</title>
      <link href="2020/12/16/source-spring-09.html"/>
      <url>2020/12/16/source-spring-09.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å‰é¢çš„å‡†å¤‡å·¥ä½œç»“æŸä¹‹åï¼Œå°±æ˜¯è¿›å…¥æ ¸å¿ƒä»£ç  refreshã€‚</p><h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">        StartupStep contextRefresh = <span class="keyword">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.refresh&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‡†å¤‡ä¸€äº›ä¸Šä¸‹æ–‡</span></span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–å‡†å¤‡åçš„ beanFactory  DefaultListableBeanFactory</span></span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‡†å¤‡ BeanFactory</span></span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å…è®¸åœ¨ä¸Šä¸‹æ–‡å­ç±»ä¸­å¯¹beanå·¥å‚è¿›è¡Œåå¤„ç†ã€‚</span></span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            StartupStep beanPostProcess = <span class="keyword">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.beans.post-process&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åœ¨ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨æ³¨å†Œä¸º beanFactory åç½®å¤„ç†å™¨</span></span><br><span class="line">            <span class="comment">// å°±æ˜¯å®ç°äº† BeanFactoryPostProcessor çš„ bean</span></span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ³¨å†Œåç½®å¤„ç†çš„Beanåˆ°å®¹å™¨å½“ä¸­</span></span><br><span class="line">            <span class="comment">// å°±æ˜¯æ‰©å±•äº† BeanPostProcessor çš„ Bean</span></span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line">            beanPostProcess.end();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–æ¶ˆæ¯æºã€‚</span></span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–å›½é™…åŒ–å·¥å…· MessageSource</span></span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨ã€‚</span></span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åœ¨ç‰¹å®šä¸Šä¸‹æ–‡å­ç±»ä¸­åˆå§‹åŒ–å…¶ä»–ç‰¹æ®Šbeanã€‚å­ç±»å¯ä»¥è‡ªå·±å®ç°</span></span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ£€æŸ¥å¹¶æ³¨å†Œç›‘å¬å™¨ã€‚</span></span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„ï¼ˆéå»¶è¿Ÿåˆå§‹åŒ–ï¼‰å•ä¾‹ã€‚</span></span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æœ€åä¸€æ­¥: å®Œæˆæ­¤ä¸Šä¸‹æ–‡çš„åˆ·æ–°ï¼Œè°ƒç”¨ LifecycleProcessor çš„ onRefreshï¼ˆï¼‰æ–¹æ³•å¹¶å‘å¸ƒ</span></span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é”€æ¯å·²åˆ›å»ºçš„å•ä¾‹ä»¥é¿å…èµ„æºæ‚¬æŒ‚ã€‚</span></span><br><span class="line">            destroyBeans();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é‡ç½®æ´»åŠ¨çŠ¶æ€</span></span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">            <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">            resetCommonCaches();</span><br><span class="line">            contextRefresh.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æºç å°±æ˜¯å¯†å¯†éº»éº»çš„ä¸€å¤§å †ï¼Œæºç ä¸Šæœ‰ç›¸åº”çš„æ³¨é‡Šã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/qaUQQJ-l1bAsm.png"></p><p>ä¸‹é¢å°±æ ¹æ®æµç¨‹ï¼Œä¸€æ­¥ä¸€æ­¥çš„æ·±å…¥æºç ï¼Œäº†è§£åˆ°æ¯ä¸€æ­¥éƒ½æ˜¯åšä»€ä¹ˆäº†ã€‚</p><h3 id="å®¹å™¨åˆ·æ–°å‡†å¤‡"><a href="#å®¹å™¨åˆ·æ–°å‡†å¤‡" class="headerlink" title="å®¹å™¨åˆ·æ–°å‡†å¤‡"></a>å®¹å™¨åˆ·æ–°å‡†å¤‡</h3><p><code>prepareRefresh</code> è¿™ä¸€æ­¥ä¸»è¦æ˜¯å‡†å¤‡ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å°±ä¸è¿‡å¤šä»‹ç»äº†ã€‚</p><h3 id="obtainFreshBeanFactory"><a href="#obtainFreshBeanFactory" class="headerlink" title="obtainFreshBeanFactory"></a>obtainFreshBeanFactory</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/nD4PyL-DFi913.png"></p><p>ä¸‹é¢å…³æ³¨åˆå§‹åŒ– BeanFactory è¿™ä¸€æ­¥ï¼š</p><p>è¿›å…¥æºç ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/4RezAZ-ngEGKj.png"></p><p>é€šè¿‡ Debug å¯ä»¥çœ‹å‡º <code>refreshBeanFactory()</code> è¿™ä¸€æ­¥è°ƒç”¨çš„æ˜¯ <code>org.springframework.context.support.GenericApplicationContext#refreshBeanFactory</code> ä¸­å®ç°çš„æ–¹æ³•ã€‚</p><p>ç»§ç»­è·Ÿè¿›</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/nhZCwD-I9EXrp.png"></p><p>å‘ç°è¿™å—åˆ¤æ–­äº†ä¸€ä¸ª <code>refreshed</code> åˆ·æ–°çŠ¶æ€ã€‚</p><p><code>refreshBeanFactory</code> æ–¹æ³•ä¹Ÿæœ‰å¦ä¸€ä¸ªå®ç°æ˜¯åœ¨ <code>AbstractRefreshableApplicationContext</code> ä¸­ï¼Œ åªä¸è¿‡æˆ‘çš„æ–­ç‚¹æ²¡æœ‰æ–­è¿›å»ï¼Œè¿™å—ä¹Ÿä¸€èµ·çœ‹ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨ BeanFactory åˆ™é”€æ¯ Bean å¹¶å…³é—­ BeanFactory</span></span><br><span class="line">    <span class="keyword">if</span> (hasBeanFactory()) &#123;</span><br><span class="line">        destroyBeans();</span><br><span class="line">        closeBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ BeanFactory</span></span><br><span class="line">        DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">        beanFactory.setSerializationId(getId());</span><br><span class="line">        <span class="comment">// è®¾ç½®å±æ€§</span></span><br><span class="line">        customizeBeanFactory(beanFactory);</span><br><span class="line">        <span class="comment">// åŠ è½½ Bean ä¿¡æ¯</span></span><br><span class="line">        loadBeanDefinitions(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">&quot;I/O error parsing bean definition source for &quot;</span> + getDisplayName(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ä¼šåˆ›å»º BeanFactory å¹¶åŠ è½½ BeanDefinitionã€‚åªä¸è¿‡æˆ‘æš‚æ—¶æ²¡æœ‰æ–­åˆ°ï¼Œæ‰€ä»¥ç­‰åé¢é‡åˆ°ä¹‹åå†è¯¦ç»†ä»‹ç»ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/3JfDRw-4a5C5Y.png"></p><p>æœ¬æ–‡ç®€å•ä»‹ç»äº† refresh çš„æµç¨‹ï¼Œå¹¶ä»‹ç»äº†å‰ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>prepareRefresh å‡†å¤‡ä¸Šä¸‹æ–‡ä¿¡æ¯</li><li>obtainFreshBeanFactory åˆå§‹åŒ– BeanFactory</li></ol><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/XPljpjGBpD7t2cmPAofm7A">Spring æºç å­¦ä¹  08ï¼šregister æ³¨å†Œé…ç½®ç±»</a></li><li><a href="https://mp.weixin.qq.com/s/VnUugIxZkUcqDvt9Yv47iQ">Spring æºç å­¦ä¹  07ï¼šClassPathBeanDefinitionScanner</a></li><li><a href="https://mp.weixin.qq.com/s/u40NdypoO2ow2wdV293eow">Spring æºç å­¦ä¹  06ï¼šAnnotatedBeanDefinitionReader</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  08ï¼šregister æ³¨å†Œé…ç½®ç±»</title>
      <link href="2020/12/06/source-spring-08.html"/>
      <url>2020/12/06/source-spring-08.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>çœ‹å®Œæ— å‚æ„é€ çš„æºç åŠæµç¨‹ä¹‹åï¼Œåé¢å°†ä¼šæ‰§è¡Œ <code>register</code> æ–¹æ³•ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/iURj3q-YF3Fqe.png"></p><p>register æ–¹æ³•ï¼Œå…¥å‚æ˜¯æˆ‘ä»¬çš„é…ç½®ç±» <code>JavaConfig.class</code> ï¼Œä¸‹é¢è·Ÿç€æºç ç»§ç»­å¾€ä¸‹èµ°ï¼</p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/72gJH7-cF6JtX.png"></p><p><code>this.reader.register(componentClasses);</code></p><p>è¿™é‡Œæ‰§è¡Œçš„æ˜¯ reader çš„æ–¹æ³•ï¼Œå…¥å‚å°±æ˜¯ä¼ å…¥çš„ <code>JavaConfig.class</code>ã€‚</p><blockquote><p>reader åœ¨ä¹‹å‰åˆå§‹åŒ–ï¼Œå°±æ˜¯æ³¨å†Œä¸€äº› PostProcessorã€‚</p></blockquote><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/OL9u7q-Y6NATv.png"></p><ol><li>å¾ªç¯ï¼Œæ³¨å†Œæ‰€æœ‰çš„é…ç½®ç±»ï¼›</li><li>doRegisterBean å¼€å§‹æ³¨å†Œã€‚</li></ol><p><code>doRegisterBean</code> æ‰æ˜¯çœŸæ­£æ³¨å†Œ Bean çš„é€»è¾‘ï¼Œä»åå­—ä¹Ÿå¯ä»¥æœ‰æ‰€çŒœæµ‹ã€‚ä¸‹é¢å¼€å§‹è¿›å…¥ <code>doRegisterBean</code> çš„æºç é˜…è¯»ï¼š</p><h4 id="doRegisterBean"><a href="#doRegisterBean" class="headerlink" title="doRegisterBean"></a>doRegisterBean</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/OXRMeM-cMgaGt.png"></p><p>æ­¤å¤„ä»£ç è¾ƒé•¿ï¼Œä»¥æˆªå›¾ä»£æ›¿ã€‚</p><p>é€šè¿‡æºç å¯ä»¥çœ‹å‡ºï¼Œè¿™å—ä¸»è¦æµç¨‹ï¼š</p><ol><li>æ ¡éªŒä¼ å…¥çš„ <code>JavaConfig.class</code> çš„æ³¨è§£ï¼ˆæ˜¯å¦éœ€è¦å¿½ç•¥ï¼‰ï¼›</li><li>å¤„ç†é€šç”¨æ³¨è§£ï¼›</li><li>å°è£…ä¸º BeanDefinitionHolder åï¼Œæ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚</li></ol><h4 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/QfGRrs-tdXZRz.png"></p><p>é€šè¿‡ debug å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ‰§è¡Œå®Œ <code>register</code> ä¹‹åï¼Œç›¸å½“äºå°† JavaConfig ä½œä¸ºä¸€ä¸ª Bean æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/mcTElg-qWdJKu.png"></p><p>åœ¨æˆ‘çœ‹æ¥å‰é¢çš„éƒ¨åˆ†ä¸»è¦æ¶‰åŠåˆ°å‡†å¤‡å·¥ä½œï¼Œè‡³äºæ›´æ·±å±‚æ¬¡çš„ç ”ç©¶ï¼Œåˆ†æï¼Œæš‚æ—¶æ²¡æœ‰æ·±å…¥ã€‚</p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/VnUugIxZkUcqDvt9Yv47iQ">Spring æºç å­¦ä¹  07ï¼šClassPathBeanDefinitionScanner</a></li><li><a href="https://mp.weixin.qq.com/s/u40NdypoO2ow2wdV293eow">Spring æºç å­¦ä¹  06ï¼šAnnotatedBeanDefinitionReader</a></li><li><a href="https://mp.weixin.qq.com/s/b7QhZguNTM_6C83b4IiMdg">Spring æºç å­¦ä¹  05ï¼šBeanDefinition æ¦‚å¿µåŠå…¶å®ç°</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  07ï¼šClassPathBeanDefinitionScanner</title>
      <link href="2020/12/05/source-spring-07.html"/>
      <url>2020/12/05/source-spring-07.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>AnnotationConfigApplicationContext æ„é€ å‡½æ•°é™¤äº†åˆå§‹åŒ–ä¸€ä¸ª <code>reader</code> ï¼Œè¿˜æœ‰ä¸€ä¸ª <code>scanner</code>ï¼Œä¸‹é¢æ¥ä¸€èµ·çœ‹çœ‹ <code>ClassPathBeanDefinitionScanner</code> éƒ½æœ‰ä»€ä¹ˆé€»è¾‘ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/aag0Mf-hC4vg6.png"></p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p><code>this.scanner = new ClassPathBeanDefinitionScanner(this);</code> ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/dIkTFJ-9bYFDo.png"></p><p>å…¶ä¸­ <code>useDefaultFilters</code> é»˜è®¤è®¾ç½®çš„ trueã€‚æ‰€ä»¥æœ€ç»ˆä¼šæ‰§è¡Œä¸‹é¢ä¸‰éƒ¨åˆ†ä»£ç ï¼š</p><ol><li>registerDefaultFilters();</li><li>setEnvironment(environment);</li><li>setResourceLoader(resourceLoader);</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/7IpG0J-yzsRns.png"></p><p>å†æ¥çœ‹ä¸‹ UML ï¼š</p><p><code>ClassPathBeanDefinitionScanner</code> ç»§æ‰¿äº† <code>ClassPathScanningCandidateComponentProvider</code>ï¼Œè€Œä¸Šé¢è¯´çš„è¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œå…¶å®éƒ½æ˜¯çˆ¶ç±» <code>ClassPathScanningCandidateComponentProvider</code> çš„æ–¹æ³•ã€‚</p><p>å¯¹åº”çš„è¿™ä¸‰ä¸ªæ“ä½œå°±æ˜¯ç»™å®ƒçš„å‚æ•°èµ‹å€¼ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/P15SfZ-To57wW.png"></p><h4 id="registerDefaultFilters"><a href="#registerDefaultFilters" class="headerlink" title="registerDefaultFilters"></a>registerDefaultFilters</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/EjGINh-OGlb4j.png"></p><p>æœ¬æ­¥éª¤ä¸»è¦æ˜¯æ·»åŠ è¿‡æ»¤å™¨ï¼Œå¯¹ includeFilters èµ‹å€¼ã€‚ æ³¨å†Œè¿‡æ»¤å™¨ <code>@Component</code>ï¼Œ<code>@Controller</code> <code>@Service</code>ã€ <code>@Repository</code> ä¹Ÿä¼šè¢«æ·»åŠ è¿›å»ã€‚</p><p>ä¹Ÿä¼šæ³¨å†Œæ·»åŠ  JSR-250 çš„ @ManagedBean å’Œ JSR-330 çš„ @Named æ³¨è§£ã€‚</p><h4 id="setEnvironment"><a href="#setEnvironment" class="headerlink" title="setEnvironment"></a>setEnvironment</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/HLHo9N-l5MfXo.png"></p><h4 id="setResourceLoader"><a href="#setResourceLoader" class="headerlink" title="setResourceLoader"></a>setResourceLoader</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/NTEYuH-nYXQTF.png"></p><p><code>setEnvironment</code> å’Œ <code>setResourceLoader</code> èµ‹å€¼æ“ä½œï¼ŒåŸºæœ¬ä¸Šå¦‚ä»£ç æ‰€ç¤ºã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/cWzzC7-zOZGjH.png"></p><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯åˆå§‹åŒ–ç±»æ‰«æå™¨ï¼Œåœ¨å®ƒåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–ä¸€äº›éœ€è¦è¢«æ‰«æçš„æ³¨è§£ï¼Œä»¥åŠèµ„æºåŠ è½½å™¨ã€‚</p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/u40NdypoO2ow2wdV293eow">Spring æºç å­¦ä¹  06ï¼šAnnotatedBeanDefinitionReader</a></li><li><a href="https://mp.weixin.qq.com/s/b7QhZguNTM_6C83b4IiMdg">Spring æºç å­¦ä¹  05ï¼šBeanDefinition æ¦‚å¿µåŠå…¶å®ç°</a></li><li><a href="https://mp.weixin.qq.com/s/JwRsKHqJ0ZcJ6Cgbp5BKiw">Spring æºç å­¦ä¹  04ï¼šåˆå§‹åŒ–å®¹å™¨ä¸ DefaultListableBeanFactory</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  06ï¼šAnnotatedBeanDefinitionReader</title>
      <link href="2020/12/04/source-spring-06.html"/>
      <url>2020/12/04/source-spring-06.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>BeanDefinition çš„æ¦‚å¿µä¹Ÿäº†è§£äº†ï¼Œä¹ŸçŸ¥é“ä¸€ä¸ª Bean åœ¨ Spring ä¸­å®šä¹‰çš„ä¿¡æ¯æœ‰å“ªäº›ä¹‹åï¼Œç»§ç»­è¨€å½’æ­£ä¼ ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/erZhOh-c50rG0.png"></p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>åœ¨åˆå§‹åŒ–æ—¶ä¼šå…ˆç”Ÿæˆä¸€ä¸ª reader ï¼Œè¿›å…¥æ–¹æ³•ï¼Œå…¶å®æ˜¯èµ°çš„ä¸‹é¢çš„é€»è¾‘ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/RPkIz4-hjaaG4.png"></p><p>å…¶ä¸­ <code>getOrCreateEnvironment(registry)</code> ä¼šè¿”å›ä¸€ä¸ª <code>Environment</code> ç”¨æ¥è¡¨ç¤ºå½“å‰çš„è¿è¡Œç¯å¢ƒä¹‹ç±»çš„ã€‚</p><p><code>ConditionEvaluator</code> æ˜¯ç”¨æ¥å®Œæˆå¯¹ <code>@Conditional</code> è¿™ä¸ªæ¡ä»¶æ³¨è§£çš„åˆ¤æ–­ã€‚</p><p>è¿™å—å¯ä»¥å‚è€ƒå®˜ç½‘ï¼š<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-environment">Environment Abstraction ç« èŠ‚</a></p><p><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-java-conditional">Conditionally Include @Configuration Classes or @Bean Methods ç« èŠ‚</a></p><blockquote><p><strong>è¡¥å……</strong></p><p>BeanDefinitionRegistryï¼šå°±æ˜¯å¯¹ BeanDefinition è¿›è¡Œæ³¨å†Œã€ç§»é™¤ã€è·å–ç­‰æ“ä½œçš„ä¸€ä¸ªæ¥å£ã€‚<br>æ¯”å¦‚ï¼šregisterBeanDefinitionã€removeBeanDefinitionã€containsBeanDefinition çœ‹åå­—ä¹Ÿèƒ½çŒœä¸ªå¤§æ¦‚æ„æ€ã€‚</p></blockquote><h4 id="registerAnnotationConfigProcessors"><a href="#registerAnnotationConfigProcessors" class="headerlink" title="registerAnnotationConfigProcessors"></a>registerAnnotationConfigProcessors</h4><p>ä¸‹é¢æ¥çœ‹æœ€åä¸€è¡Œä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="keyword">this</span>.registry);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä»£ç ç›¸å¯¹è¾ƒé•¿ï¼Œè¿˜æ˜¯ä»¥æˆªå›¾ä»£æ›¿ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/6wAV8a-8qbZoP.png"></p><p>å¯¹ beanFactory æ·»åŠ ä¾èµ–æ¯”è¾ƒå™¨ å’Œ è‡ªåŠ¨è£…é…è§£æå™¨ åå¼€å§‹æ·»åŠ å„ç§å¤„ç†å™¨ã€‚</p><p>æ·»åŠ å¤„ç†å™¨æ—¶ï¼Œä¸‹é¢æ”¶ç¼©çš„ä»£ç å’Œå”¯ä¸€å±•å¼€çš„ <code>ConfigurationClassPostProcessor</code> å†…éƒ¨é€»è¾‘ç›¸åŒï¼Œéƒ½æ˜¯è°ƒç”¨ <code>registerPostProcessor</code> æ–¹æ³•ï¼Œä¸‹é¢å†ä»‹ç»ä¸‹è¿™å‡ ä¸ªå¤„ç†å™¨çš„ä½œç”¨ï¼š</p><ul><li>ConfigurationClassPostProcessor ç”¨äºå¯¹ @Configuration ç±»è¿›è¡Œå¼•å¯¼å¤„ç†ã€‚</li><li>AutowiredAnnotationBeanPostProcessor å¤„ç† @Autowired @Value å’Œ JSR-330çš„@Inject è¿˜æœ‰ @Lookup æ³¨è§£</li><li>CommonAnnotationBeanPostProcessor ç”¨æ¥å¤„ç† @PostConstruct @PreDestroy @Resourceã€‚</li><li>PersistenceAnnotationBeanPostProcessor å½“æ”¯æŒ JPA æ—¶æ·»åŠ è¿™ä¸ªã€‚</li><li>EventListenerMethodProcessor æ”¯æŒ @EventListenerã€‚</li></ul><h4 id="registerPostProcessor"><a href="#registerPostProcessor" class="headerlink" title="registerPostProcessor"></a>registerPostProcessor</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/uaUJJU-bcIdE3.png"></p><p>registerPostProcessor æ–¹æ³•æœ‰ä¸¤ä¸ªé€»è¾‘ï¼š</p><ol><li>å°†è¿™å‡ ä¸ª Processor æ³¨å†Œåˆ° beanFactoryï¼›</li><li>å¤„ç†å™¨å°è£…ä¸º BeanDefinitionHolder å¯¹è±¡ã€‚</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/jdTJln-hqvIeJ.png" alt="BeanDefinitionHolder"></p><p>BeanDefinitionHolder å°±æ˜¯å°è£…äº†ä¸‹ BeanDefinition ï¼Œè¯´æ˜è¿™ä¸ª BeanDefinition çš„æŒæœ‰è€… name æ˜¯è°ã€‚ </p><h4 id="å¤§èƒ†çŒœæµ‹"><a href="#å¤§èƒ†çŒœæµ‹" class="headerlink" title="å¤§èƒ†çŒœæµ‹"></a>å¤§èƒ†çŒœæµ‹</h4><p>æ‰§è¡Œå®Œè¿™ä¸€è¡Œä¹‹åï¼Œåœ¨ AnnotationConfigApplicationContext é‡Œé¢æœ‰äº† è¿™å‡ ä¸ª BeanDefinitionã€‚</p><h4 id="å°å¿ƒæ±‚è¯"><a href="#å°å¿ƒæ±‚è¯" class="headerlink" title="å°å¿ƒæ±‚è¯"></a>å°å¿ƒæ±‚è¯</h4><p>Debug èµ°èµ·ï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/wFyqjc-OROaV6.png"></p><p>é¢â€¦â€¦  åªæœ‰å››ä¸ªï¼Œå‡è£…æ˜¯å¯¹çš„ã€‚è¿˜æ˜¯ä¸€æ­¥ä¸€æ­¥çœ‹ä¸€çœ‹å§ï¼åŸæ¥æ˜¯æ²¡æœ‰ JSR-250 å’Œ JPAï¼Œé‚£è¿™ä¸ªå°±æ­£å¸¸äº†ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/jMZmN5-GpjdYh.png"></p><p>å…¶å®ç®€è€Œè¨€ä¹‹ï¼Œè¿™ä¸€æ­¥å°±æ˜¯æ³¨å†Œäº†ä¸€äº› Spring è‡ªå·±çš„ PostProcessorã€‚</p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/b7QhZguNTM_6C83b4IiMdg">Spring æºç å­¦ä¹  05ï¼šBeanDefinition æ¦‚å¿µåŠå…¶å®ç°</a></li><li><a href="https://mp.weixin.qq.com/s/JwRsKHqJ0ZcJ6Cgbp5BKiw">Spring æºç å­¦ä¹  04ï¼šåˆå§‹åŒ–å®¹å™¨ä¸ DefaultListableBeanFactory</a></li><li><a href="https://mp.weixin.qq.com/s/V7SjmIFKAXyppBF_KHbxXQ">Spring æºç å­¦ä¹  03ï¼šåˆ›å»º IoC å®¹å™¨çš„å‡ ç§æ–¹å¼</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  05ï¼šBeanDefinition æ¦‚å¿µåŠå…¶å®ç°</title>
      <link href="2020/12/03/source-spring-05.html"/>
      <url>2020/12/03/source-spring-05.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>BeanDefinitionï¼šé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ Bean çš„å®šä¹‰ï¼Œæ˜¯ç”¨æ¥æè¿°ä¸€ä¸ª Bean éƒ½æœ‰ä»€ä¹ˆä¿¡æ¯ã€‚å‰é¢è¯´åœ¨åˆå§‹åŒ– <code>DefaultListableBeanFactory</code> æ—¶ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ª <code>Map&lt;String, BeanDefinition&gt;</code>ï¼Œè¿™ä¸ª Map çš„åŠŸèƒ½æš‚ä¸”ä¸è¯´ï¼Œï¼ˆPSï¼šæŸ¥èµ„æ–™è¯´çš„æ˜¯å­˜å‚¨ beanï¼‰ï¼Œæ‰€ä»¥ä»Šå¤©å°±ç»“åˆå®˜æ–¹æ–‡æ¡£ä»¥åŠæºç ï¼Œä¸€èµ·äº†è§£ä¸€ä¸‹ <code>BeanDefinition</code>ï¼</p><h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/RQNh7C-qiNl5V.png"></p><p>åœ¨å®¹å™¨å†…éƒ¨ï¼Œä½¿ç”¨ <code>BeanDefinition</code> å¯¹è±¡å®šä¹‰ä¸€ä¸ª Beanã€‚è€Œå®šä¹‰çš„ä¿¡æ¯åŒ…å« ç±»åã€ä½œç”¨åŸŸã€æ˜¯å¦æ‡’åŠ è½½ã€æ„é€ å‚æ•°ã€åˆå§‹åŒ–æ–¹æ³•ã€é”€æ¯æ–¹å¼ç­‰ç­‰ã€‚</p><p>äº†è§£äº†æ¦‚å¿µä¹‹åï¼Œå¼€å§‹é˜…è¯»æºç ï¼Œæºç éƒ¨åˆ†æ¯”è¾ƒé•¿ã€‚</p><h3 id="æºç ä»‹ç»"><a href="#æºç ä»‹ç»" class="headerlink" title="æºç ä»‹ç»"></a>æºç ä»‹ç»</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/BeanDefinition-pzN9Uc.png" alt="BeanDefinition"></p><p>é€šè¿‡ UML å¯ä»¥çœ‹å‡º BeanDefinition æ¥å£ç»§æ‰¿äº† AttributeAccessor å’Œ BeanMetadataElement ä¸¤ä¸ªæ¥å£ã€‚</p><h4 id="AttributeAccessor"><a href="#AttributeAccessor" class="headerlink" title="AttributeAccessor"></a>AttributeAccessor</h4><p>AttributeAccessorï¼šå®šä¹‰ç”¨äºå°†å…ƒæ•°æ®é™„åŠ åˆ°ä»»æ„å¯¹è±¡æˆ–ä»ä»»æ„å¯¹è±¡è®¿é—®å…ƒæ•°æ®çš„é€šç”¨åå®šçš„æ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AttributeAccessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(String name, <span class="meta">@Nullable</span> Object value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">Object <span class="title">getAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">Object <span class="title">removeAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">String[] attributeNames();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ¥å£æ–¹æ³•å¯ä»¥çœ‹å‡ºï¼ŒAttributeAccessor ä¸»è¦å®šä¹‰äº†å¯¹å…ƒæ•°æ®<code>å±æ€§</code>çš„å¢åˆ æ”¹æŸ¥ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/uZKzQo-PU9mzG.png"></p><p><code>AttributeAccessorSupport</code> æ˜¯ AttributeAccessor æ¥å£çš„ä¸€ä¸ªå®ç°ï¼Œé€šè¿‡å®ç°å¯ä»¥çœ‹å‡ºï¼Œå…¶å†…éƒ¨ä½¿ç”¨äº† Map ä¿å­˜åç§°å’Œå±æ€§å€¼ã€‚</p><h4 id="BeanMetadataElement"><a href="#BeanMetadataElement" class="headerlink" title="BeanMetadataElement"></a>BeanMetadataElement</h4><p>BeanMetadataElementï¼šç”±åŒ…å«é…ç½®æºå¯¹è±¡çš„ bean å…ƒæ•°æ®å…ƒç´ å®ç°çš„æ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanMetadataElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">default</span> Object <span class="title">getSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥å£å†…éƒ¨åªæœ‰ä¸€ä¸ª <code>getSource()</code> æ–¹æ³•ï¼Œå…¶å«ä¹‰ä¸ºï¼š<strong>è¿”å›æ­¤å…ƒæ•°æ®å…ƒç´ çš„é…ç½®æºObject ï¼ˆå¯ä»¥ä¸ºnull ï¼‰ã€‚</strong></p><p>å…¶å®è¿˜æ˜¯ä¸çŸ¥é“å•¥æ„æ€â€¦â€¦</p><p>åœ¨å­ç±»ï¼ˆ<code>BeanMetadataAttributeAccessor</code>ï¼‰ä¸­åŠ ä¸Šæ–­ç‚¹ï¼Œdebug</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/bR6lTo-GEmj33.png"></p><p>è¿™é‡Œ source é‡Œé¢å­˜å‚¨äº† Class ç±»æ–‡ä»¶åœ¨ç£ç›˜çš„çœŸå®è·¯å¾„ã€‚å½“ç„¶å§‘ä¸”å¯ä»¥è¿™ä¹ˆè®¤ä¸ºï¼Œæ¯•ç«Ÿæˆ‘è¿™ä¹Ÿæ˜¯åˆšå¼€å§‹å­¦ä¹ æºç ï¼Œå½“å‰çš„ç»“è®ºåªæ˜¯ debug åˆ°çš„ï¼Œä¹Ÿæœ‰å¯èƒ½åœ¨åˆ«çš„å®ç°ç±»ä¸­å­˜å‚¨çš„æ˜¯åˆ«çš„ä¿¡æ¯ã€‚</p><h4 id="BeanDefinition"><a href="#BeanDefinition" class="headerlink" title="BeanDefinition"></a>BeanDefinition</h4><p>BeanDefinition æ–¹æ³•è¾ƒå¤šï¼Œå°±ä¸è´´ä»£ç ï¼Œæˆ–è€…æˆªå›¾äº†ã€‚è¯¦ç»†å¯ä»¥é€šè¿‡ <a href="https://github.com/liuzhihang/spring-framework/blob/master/spring-beans/src/main/java/org/springframework/beans/factory/config/BeanDefinition.java">æˆ‘çš„ GitHub</a> è¿›è¡Œé˜…è¯»ï¼Œä¸Šé¢æ·»åŠ äº†ç›¸å…³æ³¨é‡Šã€‚</p><p>ä¸è¿‡è¿˜æ˜¯ç®€è¦ä»‹ç»ä¸€ä¸‹æ–¹æ³•ï¼Œå¤§æ¦‚æœ‰ Bean çš„åå­—ã€ä½œç”¨èŒƒå›´ã€æ˜¯å¦é¦–é€‰ã€ä»¥åŠ Bean çš„åˆå§‹åŒ–é”€æ¯æ–¹æ³•ç­‰ç­‰ã€‚</p><p>BeanDefinition åªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å®ç°åˆåˆ†ä¸ºå¥½å‡ ç§ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/AbstractBeanDefinition-x4hCMm.png" alt="AbstractBeanDefinition"></p><h4 id="AbstractBeanDefinition"><a href="#AbstractBeanDefinition" class="headerlink" title="AbstractBeanDefinition"></a>AbstractBeanDefinition</h4><p>AbstractBeanDefinition ä½œä¸º BeanDefinition çš„æŠ½è±¡å®ç°ç±»ï¼Œå†…éƒ¨å®šä¹‰äº†å¾ˆå¤šå±æ€§ï¼Œä»¥æ»¡è¶³ BeanDefinition å®šä¹‰çš„æ¥å£åŠŸèƒ½ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/avOyP7-LBkQNL.png"></p><p>è¿™äº›å±æ€§çš„æ“ä½œï¼Œå°±å¯¹åº”ç€ BeanDefinition å®šä¹‰çš„æ¥å£æ–¹æ³•ã€‚</p><h4 id="AbstractBeanDefinition-çš„ä¸‰ä¸ªå®ç°ç±»"><a href="#AbstractBeanDefinition-çš„ä¸‰ä¸ªå®ç°ç±»" class="headerlink" title="AbstractBeanDefinition çš„ä¸‰ä¸ªå®ç°ç±»"></a>AbstractBeanDefinition çš„ä¸‰ä¸ªå®ç°ç±»</h4><p>AbstractBeanDefinition çš„å®ç°åˆåˆ†ä¸ºä¸‰ä¸ªï¼šåˆ†åˆ«æ˜¯ <code>ChildBeanDefinition</code>ã€ <code>RootBeanDefinition</code>ã€ <code>GenericBeanDefinition</code>ã€‚</p><ol><li><p>ChildBeanDefinitionï¼šå¯ä»¥ä» Parent Definition é‡Œé¢ç»§æ‰¿ä¸€äº›å…¬å…±å®šä¹‰ï¼ˆåˆå§‹åŒ–æ–¹æ³•ã€é”€æ¯æ–¹æ³•ã€æ˜¯å¦æ‡’åŠ è½½ç­‰ç­‰ï¼‰ä¸è¿‡</p></li><li><p>RootBeanDefinitionï¼šå®šä¹‰ Bean Definition çš„å…¬å…±å±æ€§ï¼Œè¯¥å®šä¹‰åœ¨è¿è¡Œæ—¶æ”¯æŒSpring BeanFactoryä¸­çš„ç‰¹å®šbeanã€‚ è€Œ RootBeanDefinition æ˜¯ä¸å¯ä»¥è®¾ç½® parentName æŒ‡å®š Parent Definition çš„ã€‚</p></li><li><p>GenericBeanDefinitionï¼šæ˜¯ä¸€ä¸ªé€šç”¨çš„ Bean Definitionï¼Œæ˜¯ä¸€ç«™å¼æœåŠ¡ï¼Œç”¨äºæ ‡å‡†beanå®šä¹‰ã€‚ åƒä»»ä½•beanå®šä¹‰ä¸€æ ·ï¼Œå®ƒå…è®¸æŒ‡å®šä¸€ä¸ªç±»ä»¥åŠå¯é€‰çš„æ„é€ å‡½æ•°å‚æ•°å€¼å’Œå±æ€§å€¼ã€‚ å¦å¤–ï¼Œå¯ä»¥é€šè¿‡ <code>parentName</code> å±æ€§çµæ´»åœ°é…ç½®ä»çˆ¶beanå®šä¹‰æ´¾ç”Ÿçš„å†…å®¹ã€‚æ‰€ä»¥ç°åœ¨ä¸€èˆ¬ä½¿ç”¨ GenericBeanDefinitionã€‚</p></li></ol><blockquote><p>ä» Spring 2.5 å¼€å§‹ï¼Œä»¥ç¼–ç¨‹æ–¹å¼æ³¨å†Œ Bean Definition çš„é¦–é€‰æ–¹æ³•æ˜¯ GenericBeanDefinition ç±»ï¼Œè¯¥ç±»å…è®¸é€šè¿‡ GenericBeanDefinition.setParentName æ–¹æ³•åŠ¨æ€å®šä¹‰çˆ¶ä¾èµ–é¡¹ã€‚ </p></blockquote><p>GenericBeanDefinition ä¸‹é¢è¿˜æœ‰ä¸¤ä¸ªå®ç°ï¼š<code>ScannedGenericBeanDefinition</code> ã€<code>AnnotatedGenericBeanDefinition</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/mX91iq-VpxacB.png"></p><p>äºŒè€…å¹¶æ— å¤ªå¤§åŒºåˆ«ï¼Œåªä¸è¿‡ <code>AnnotatedGenericBeanDefinition</code> æ¯” <code>ScannedGenericBeanDefinition</code> å¤šäº†ä¸€ä¸ª <code>factoryMethodMetadata</code> çš„å®šä¹‰ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é€šè¿‡é˜…è¯» BeanDefinition çš„æºç ï¼Œå¹¶å¯¹å…¶å®ç°ç±»çš„æºç è¿›è¡Œé˜…è¯»ä¹‹åï¼Œå¤§è‡´äº†è§£ BeanDefinition çš„æ¦‚å¿µåŠå…¶å«ä¹‰ã€‚å¤§æ¦‚ä½œå›¾æ€»ç»“å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/lrjeS3-Mn06Yj.png"></p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/JwRsKHqJ0ZcJ6Cgbp5BKiw">Spring æºç å­¦ä¹  04ï¼šåˆå§‹åŒ–å®¹å™¨ä¸ DefaultListableBeanFactory</a></li><li><a href="https://mp.weixin.qq.com/s/V7SjmIFKAXyppBF_KHbxXQ">Spring æºç å­¦ä¹  03ï¼šåˆ›å»º IoC å®¹å™¨çš„å‡ ç§æ–¹å¼</a></li><li><a href="https://mp.weixin.qq.com/s/YPDPU7ePtii0vlrynexb_w">Spring æºç å­¦ä¹  02ï¼šå…³äº Spring IoC å’Œ Bean çš„æ¦‚å¿µ</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  04ï¼šåˆå§‹åŒ–å®¹å™¨ä¸ DefaultListableBeanFactory</title>
      <link href="2020/12/02/source-spring-04.html"/>
      <url>2020/12/02/source-spring-04.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/Sf8fRH-D6nt5n.png"></p><p>åœ¨å‰ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/V7SjmIFKAXyppBF_KHbxXQ">åˆ›å»º IoC å®¹å™¨çš„å‡ ç§æ–¹å¼</a>ä¸­ï¼Œä»‹ç»äº†å››ç§æ–¹å¼ï¼Œè¿™é‡Œä»¥ <code>AnnotationConfigApplicationContext</code> ä¸ºä¾‹ï¼Œè·Ÿè¿›ä»£ç ï¼Œçœ‹çœ‹ IoC çš„å¯åŠ¨æµç¨‹ã€‚</p><h3 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h3><p>ä» JavaConfig ä¸­åŠ è½½é…ç½®çš„ <code>AnnotationConfigApplicationContext</code> å¯åŠ¨æ–¹å¼å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/NbaqT1-SIKlXs.png"></p><p>è¿›å»ä¹‹åå‘ç°æ„é€ å…¶å®æ˜¯è°ƒç”¨çš„å½“å‰æ— å‚æ„é€ ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/dA7SqR-pnWaJ0.png"></p><p>æ‰€ä»¥åœ¨å¯åŠ¨æ—¶ä¹Ÿå¯ä»¥ç›´æ¥å£°æ˜æ— å‚æ„é€ ï¼Œæ”¹å†™ä¸ºä¸‹é¢è¿™ç§ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfigApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">context.register(JavaConfig.class);</span><br><span class="line">context.refresh();</span><br><span class="line"></span><br><span class="line">System.out.println(context.getBean(UserComponent.class));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»Šå¤©å°±ç ”ç©¶ç ”ç©¶æ— å‚æ„é€ è¿™ä¸€éƒ¨åˆ†ç©¶ç«Ÿåšäº†ä»€ä¹ˆé€»è¾‘ï¼</p><h4 id="æ— å‚æ„é€ "><a href="#æ— å‚æ„é€ " class="headerlink" title="æ— å‚æ„é€ "></a>æ— å‚æ„é€ </h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/VfQDRi-qtFJay.png"></p><p>å…¶ä¸­çš„ <code>StartupStep</code> æ˜¯ 5.3 æ–°å¢çš„ç±»ï¼Œçœ‹ä»£ç æ³¨é‡Šçš„æ„æ€æ˜¯ï¼šè¡¨ç¤ºç”¨æ¥è®°å½•å¯åŠ¨è¿‡ç¨‹ä¸­çš„ä¸€äº›æŒ‡æ ‡ä¿¡æ¯ç­‰ã€‚æš‚æ—¶ä¸åšç ”ç©¶ã€‚</p><p>ä¸»è¦ç ”ç©¶çº¢æ¡†éƒ¨åˆ†ï¼æ³¨æ„ï¼Œ<strong>è¿™ä¸€å—å¹¶ä¸ä»£è¡¨åªæœ‰çº¢æ¡†éƒ¨åˆ†</strong>ï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/jHZiO9-lClEgy.png"></p><p>å› ä¸º <code>AnnotationConfigApplicationContext</code> ç»§æ‰¿äº† <code>GenericApplicationContext</code>ï¼Œæ‰€ä»¥ä¼šå…ˆæ‰§è¡Œçˆ¶ç±»çš„æ„é€ æ–¹æ³•ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/T9dF4r-BeA6nA.png"></p><p>æ‰€ä»¥è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ª <code>DefaultListableBeanFactory</code> çš„å®¹å™¨ã€‚</p><h3 id="DefaultListableBeanFactory"><a href="#DefaultListableBeanFactory" class="headerlink" title="DefaultListableBeanFactory"></a>DefaultListableBeanFactory</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/DefaultListableBeanFactory-oBHX69.png" alt="DefaultListableBeanFactory UML"></p><p>è™½ç„¶è¯´ Spring çš„ <code>BeanFactory</code> å®šä¹‰äº†å®¹å™¨çš„åŸºç¡€æ¦‚å¿µã€æ¥å£æ–¹æ³•ç­‰ï¼Œä½†æ˜¯ <code>DefaultListableBeanFactory</code> æ‰æ˜¯ä¸€ä¸ªçœŸæ­£å¯ä»¥ new å‡ºæ¥çš„å…·ä½“çš„å®¹å™¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æš‚ä¸”ç§°ä¹‹ä¸º bean å·¥å‚ã€‚</p><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹ <code>DefaultListableBeanFactory</code> é‡Œé¢éƒ½æœ‰ä»€ä¹ˆï¼Ÿ</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/oUgw6b-dgE9ZX.png"></p><p>åœ¨ <code>DefaultListableBeanFactory</code> é‡Œé¢ä¼šåˆå§‹åŒ–å¾ˆå¤šå‚æ•°ï¼Œå…¶ä¸­é‡ç‚¹å…³æ³¨çš„æ˜¯ä¸‹é¢ä¸¤ä¸ªå‚æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Map of bean definition objects, keyed by bean name. */</span></span><br><span class="line"><span class="comment">// BeanDefinition çš„å­˜å‚¨ Map å…¶ä¸­ key ä¸º beanName</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** List of bean definition names, in registration order. */</span></span><br><span class="line"><span class="comment">// BeanName çš„é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;String&gt; beanDefinitionNames = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">256</span>);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>BeanDefinition</code> æè¿°äº†ä¸€ä¸ª bean å®ä¾‹ï¼Œè¯¥å®ä¾‹å…·æœ‰å±æ€§å€¼ï¼Œæ„é€ å‡½æ•°å‚æ•°å€¼ä»¥åŠå…·ä½“å®ç°æ‰€æä¾›çš„æ›´å¤šä¿¡æ¯ã€‚</p><p>å¯¹åº”çš„ <code>beanDefinitionMap</code> å°±æ˜¯å­˜å‚¨çš„åˆå§‹åŒ–çš„ beanName å’Œ BeanDefinitionã€‚</p><p>è‡³äº BeanDefinition å…·ä½“å†…å®¹ï¼Œä¸‹ä¸€èŠ‚å†åšä»‹ç»ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é€šè¿‡ä¸Šé¢çš„é˜…è¯»ï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–æµç¨‹ä¸­å¢åŠ ä¸€éƒ¨åˆ†æ¨¡å—ï¼Œå³å®ä¾‹åŒ– <code>DefaultListableBeanFactory</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/m4P5ZW-VrZwt7.png"></p><p>å†å›é¡¾ä¸€ä¸‹ <code>DefaultListableBeanFactory</code> çš„æ¦‚å¿µã€‚</p><blockquote><p><strong>DefaultListableBeanFactoryï¼š</strong></p><p>Spring çš„ ConfigurableListableBeanFactory å’Œ BeanDefinitionRegistry æ¥å£çš„é»˜è®¤å®ç°ï¼šåŸºäºbeanå®šä¹‰å…ƒæ•°æ®çš„æˆç†Ÿbeanå·¥å‚ï¼Œå¯é€šè¿‡åå¤„ç†å™¨è¿›è¡Œæ‰©å±•ã€‚<br>é‡ç‚¹éœ€è¦æŠŠæ¡çš„æ˜¯ DefaultListableBeanFactory å†…éƒ¨å®šä¹‰äº† BeanDefinition çš„ Mapã€‚</p></blockquote><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>æœ¬æ–‡ä»å…¥å£å¼€å§‹ï¼Œè¿›å…¥åˆ°æ„é€ ï¼Œä¸»è¦ä»‹ç»äº† <code>DefaultListableBeanFactory</code> çš„åˆ›å»ºï¼ŒåŠåˆ›å»ºæ—¶åˆå§‹åŒ–äº†ä¸€å †å‚æ•°ã€‚</p><p>è€ƒè™‘åˆ°æ–‡ç« ç¯‡å¹…é—®é¢˜ï¼Œå°½é‡é¿å…å¤§æ®µå¤§æ®µçš„è´´ä»£ç ä»¥åŠæ³¨é‡Šï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è¯•ç€è‡ªå·±æ­å»ºæºç æ„å»ºç¯å¢ƒï¼Œç„¶å Debug èµ°ä¸€èµ°ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥äº’ç›¸æ¢è®¨ï¼Œå…±åŒå­¦ä¹ ã€‚</p><p>ç¬”è€…ä¹Ÿæ˜¯åˆšå¼€å§‹é˜…è¯»å­¦ä¹ æºç ï¼Œä¸è¶³ä¹‹å¤„ï¼Œå¸Œæœ›å¤šå¤šæŒ‡æ­£ã€‚</p><h4 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h4><ul><li><a href="https://mp.weixin.qq.com/s/V7SjmIFKAXyppBF_KHbxXQ">Spring æºç å­¦ä¹  03ï¼šåˆ›å»º IoC å®¹å™¨çš„å‡ ç§æ–¹å¼</a></li><li><a href="https://mp.weixin.qq.com/s/YPDPU7ePtii0vlrynexb_w">Spring æºç å­¦ä¹  02ï¼šå…³äº Spring IoC å’Œ Bean çš„æ¦‚å¿µ</a></li><li><a href="https://mp.weixin.qq.com/s/gDhJMSPSX2vz68p5X3juow">Spring æºç å­¦ä¹  01ï¼šæºç é˜…è¯»ç¯å¢ƒçš„æ­å»º</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  03ï¼šåˆ›å»º IoC å®¹å™¨çš„å‡ ç§æ–¹å¼</title>
      <link href="2020/12/01/source-spring-03.html"/>
      <url>2020/12/01/source-spring-03.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/1cc7GX-1iJNvm.png" alt="åˆ›å»ºå®¹å™¨"></p><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« æœ«å°¾ç”»äº†ä¸€å¹…ç®€å›¾ï¼Œç°åœ¨ä»ç®€å›¾è¿™å…¥æ‰‹ï¼Œå…ˆæ¥çœ‹çœ‹å¦‚ä½•åˆ›å»ºå®¹å™¨ï¼</p><h3 id="åˆ›å»ºå®¹å™¨"><a href="#åˆ›å»ºå®¹å™¨" class="headerlink" title="åˆ›å»ºå®¹å™¨"></a>åˆ›å»ºå®¹å™¨</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/GenericGroovyApplicationContext-6dwIrF.png"></p><p>åœ¨æ­å»º <a href="https://mp.weixin.qq.com/s/gDhJMSPSX2vz68p5X3juow">Spring æºç é˜…è¯»ç¯å¢ƒ</a> æ—¶ï¼Œæœ€åä¸¾äº†ä¸€ä¸ªä¾‹å­ï¼Œå…¶å®å°±æ˜¯åˆ›å»ºå®¹å™¨ï¼Œå¹¶ä»å®¹å™¨ä¸­è·å– Bean ï¼Œæ¥æµ‹è¯•ç¯å¢ƒæ˜¯å¦ OKã€‚</p><p>æ ¹æ®å…ƒæ•°æ®çš„ä¸åŒï¼Œåˆ›å»ºå®¹å™¨çš„æ–¹å¼ä¹Ÿä¸åŒï¼Œä¸‹é¢å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œç®€å•ä»‹ç»ä¸‹åˆ›å»ºå®¹å™¨çš„å‡ ç§æ–¹å¼ï¼š</p><h4 id="Java-é…ç½®è·å–å…ƒæ•°æ®"><a href="#Java-é…ç½®è·å–å…ƒæ•°æ®" class="headerlink" title="Java é…ç½®è·å–å…ƒæ•°æ®"></a>Java é…ç½®è·å–å…ƒæ•°æ®</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfigApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line"></span><br><span class="line">context.register(JavaConfig.class);</span><br><span class="line">context.refresh();</span><br><span class="line"></span><br><span class="line">System.out.println(context.getBean(UserComponent.class));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Xml-è·å–å…ƒæ•°æ®"><a href="#Xml-è·å–å…ƒæ•°æ®" class="headerlink" title="Xml è·å–å…ƒæ•°æ®"></a>Xml è·å–å…ƒæ•°æ®</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlConfigApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;SpringConfig.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(context.getBean(<span class="string">&quot;bookService&quot;</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Groovy-è·å–å…ƒæ•°æ®"><a href="#Groovy-è·å–å…ƒæ•°æ®" class="headerlink" title="Groovy è·å–å…ƒæ•°æ®"></a>Groovy è·å–å…ƒæ•°æ®</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroovyConfigApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">GenericGroovyApplicationContext context = <span class="keyword">new</span> GenericGroovyApplicationContext(<span class="string">&quot;SpringConfig.groovy&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(context.getBean(NotesServiceImpl.class));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="GenericApplicationContext"><a href="#GenericApplicationContext" class="headerlink" title="GenericApplicationContext"></a>GenericApplicationContext</h4><p>ä¹Ÿå¯ä»¥ç›´æ¥åˆ›å»º <code>GenericApplicationContext</code> ç„¶ååœ¨åŠ è½½å…ƒæ•°æ®é…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">GenericApplicationContext context = <span class="keyword">new</span> GenericApplicationContext();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> XmlBeanDefinitionReader(context).loadBeanDefinitions(<span class="string">&quot;SpringConfig.xml&quot;</span>);</span><br><span class="line"><span class="keyword">new</span> GroovyBeanDefinitionReader(context).loadBeanDefinitions(<span class="string">&quot;SpringConfig.groovy&quot;</span>);</span><br><span class="line"></span><br><span class="line">context.refresh();</span><br><span class="line"></span><br><span class="line">System.out.println(context.getBean(<span class="string">&quot;bookService&quot;</span>));</span><br><span class="line">System.out.println(context.getBean(NotesServiceImpl.class));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/spring03-FyUebg.jpeg"></p><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº†å¸¸ç”¨çš„å‡ ç§å®¹å™¨çš„åˆ›å»ºï¼Œé…ç½®æ–‡ä»¶éƒ¨åˆ†å°±æ²¡æœ‰åœ¨æ–‡ç« ä¸­ä½“ç°äº†ï¼Œå¦‚æœæƒ³äº†è§£è¿™éƒ¨åˆ†ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚</p><h3 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h3><ul><li><a href="https://mp.weixin.qq.com/s/gDhJMSPSX2vz68p5X3juow">Spring æºç å­¦ä¹  01ï¼šæºç é˜…è¯»ç¯å¢ƒçš„æ­å»º</a></li><li><a href="https://mp.weixin.qq.com/s/YPDPU7ePtii0vlrynexb_w">Spring æºç å­¦ä¹  02ï¼šå…³äº Spring IoC å’Œ Bean çš„æ¦‚å¿µ</a></li><li><a href="https://mp.weixin.qq.com/s/BORxKatt9qs4rDgmAHbv_A">Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  02ï¼šå…³äº Spring IoC å’Œ Bean çš„æ¦‚å¿µ</title>
      <link href="2020/11/30/source-spring-02.html"/>
      <url>2020/11/30/source-spring-02.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»äº†å¦‚ä½•æ„å»ºæºç é˜…è¯»ç¯å¢ƒï¼Œæ—¢ç„¶æ„å»ºå¥½äº†æºç ç¯å¢ƒï¼Œæœ¬åœ°ä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œï¼Œé‚£å°±å¼€å§‹é˜…è¯»æºç å§ï¼</p><p>åœ¨é˜…è¯»æºç æ—¶ï¼Œä¼šå‚è€ƒ<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#spring-core">å®˜æ–¹æ–‡æ¡£</a>ï¼Œå¾ˆå¤šæ¦‚å¿µåœ¨å®˜ç½‘éƒ½å¯ä»¥å¾—åˆ°ç­”æ¡ˆï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´ä»¬å¯ä»¥ç»§ç»­é˜…è¯»ï¼Œå½“åšå¤ä¹ ï¼Œå†™çš„ä¸è¶³ä¹‹å¤„ï¼Œå¸Œæœ›å¤šå¤šæŒ‡å¯¼ã€‚</p><h3 id="IoC-å’Œ-DI"><a href="#IoC-å’Œ-DI" class="headerlink" title="IoC å’Œ DI"></a>IoC å’Œ DI</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/Cp1dfI-Yg6zuJ.png" alt="IoC æ¦‚å¿µ"></p><h4 id="IoC"><a href="#IoC" class="headerlink" title="IoC"></a>IoC</h4><p>IoCï¼ˆInversion of Controlï¼‰ï¼Œå³æ§åˆ¶åè½¬ã€‚</p><p>ä¹‹å‰æ˜¯åœ¨å¯¹è±¡å†…éƒ¨ new åˆ›å»ºå…¶ä»–å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ã€‚</p><p>è€Œç°åœ¨ Spring ä¸­æœ‰ä¸€ä¸ªå®¹å™¨å¯ä»¥åœ¨åˆ›å»ºç®¡ç†è¿™äº›å¯¹è±¡ï¼Œå¹¶ä¸”å°†å¯¹è±¡ä¾èµ–çš„å…¶ä»–å¯¹è±¡æ³¨å…¥åˆ°è¿™ä¸ªå¯¹è±¡ä¸­ï¼Œè¿™äº›å¯¹è±¡çš„åˆ›å»ºã€é”€æ¯éƒ½ç”± Spring è¿›è¡Œç®¡ç†ã€‚</p><p>ç›¸æ¯”ä»¥å‰æ¥è¯´ï¼Œä¸å†ç”±è‡ªå·±æ§åˆ¶å…¶ä»–å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«åšæ§åˆ¶åè½¬ã€‚è€Œè´Ÿè´£ç»Ÿä¸€ç®¡ç†è¿™äº›ç±»çš„å®¹å™¨å°±å«åš IoC å®¹å™¨ã€‚</p><h4 id="DI"><a href="#DI" class="headerlink" title="DI"></a>DI</h4><p><code>IoC is also known as dependency injection (DI).</code> </p><p>æ˜¯ä¸æ˜¯æ„Ÿè§‰å¥‡å¥‡æ€ªæ€ªçš„ï¼Œä¸ºä»€ä¹ˆè¯´ï¼š<code>IoC ä¹Ÿç§°ä¸º DI</code>ã€‚</p><p>å…¶å® IoC å’Œ DI æ˜¯åŒä¸€ä¸ªæ¦‚å¿µçš„ä¸åŒè§’åº¦æè¿°ã€‚</p><p>ä¾èµ–æ³¨å…¥æ˜¯æŒ‡ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ç”±å®¹å™¨åœ¨è¿è¡ŒæœŸå†³å®šï¼Œå½¢è±¡çš„è¯´ï¼Œå³ç”±å®¹å™¨åŠ¨æ€çš„å°†æŸä¸ªä¾èµ–å…³ç³»æ³¨å…¥åˆ°ç»„ä»¶ä¹‹ä¸­ã€‚</p><p>é€šè¿‡ä¾èµ–æ³¨å…¥æœºåˆ¶ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ç®€å•çš„é…ç½®ï¼Œè€Œæ— éœ€ä»»ä½•ä»£ç å°±å¯æŒ‡å®šç›®æ ‡éœ€è¦çš„èµ„æºï¼Œå®Œæˆè‡ªèº«çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸éœ€è¦å…³å¿ƒå…·ä½“çš„èµ„æºæ¥è‡ªä½•å¤„ï¼Œç”±è°å®ç°ã€‚</p><p>Spring æ˜¯é€šè¿‡ DI å®ç° IoC çš„ã€‚</p><h3 id="å®¹å™¨å’Œ-Bean"><a href="#å®¹å™¨å’Œ-Bean" class="headerlink" title="å®¹å™¨å’Œ Bean"></a>å®¹å™¨å’Œ Bean</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/4xZKqx-3YpFD2.png" alt="Spring IoC container and Bean"></p><p><code>Bean æ˜¯ä¸€ä¸ªç”± Spring IoC å®¹å™¨å®ä¾‹åŒ–ï¼Œç»„è£…å’Œç®¡ç†çš„å¯¹è±¡ã€‚</code></p><p>ç›¸ä¿¡å¤§å®¶éƒ½å†™è¿‡æˆ–è€…è§è¿‡ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»å®¹å™¨ä¸­è·å–å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/4/6 19:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomBeanFactory</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext ctx;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext ac)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ctx = ac;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctx.getBean(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯ä»å®¹å™¨ä¸­è·å–åˆ°æŒ‡å®šåç§°çš„ <code>Bean</code>ï¼Œè€Œå…¶ä¸­ <code>ApplicationContext</code> æ¥å£å…¶å®å°±æ˜¯ Spring IoC å®¹å™¨ã€‚</p><p>å½“ç„¶ <code>ApplicationContext</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæœ‰å¾ˆå¤šå®ç°ï¼Œè€Œå®ƒä¹Ÿç»§æ‰¿äº† <code>BeanFactory</code>ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/4PQoiE-WQT8uR.png" alt="BeanFactory or ApplicationContext"></p><p>è™½ç„¶ <code>BeanFactory</code> æ˜¯ IoC å®¹å™¨çš„æœ€åŸºæœ¬çš„å½¢å¼ï¼Œä½†æ˜¯ <code>ApplicationContext</code> å¯¹å…¶è¿›è¡Œäº†å¾ˆå¤šæ‰©å±•ï¼Œå¹¶å…·æœ‰ <code>BeanFactory</code> çš„æ‰€æœ‰åŠŸèƒ½ï¼Œé€šå¸¸å»ºè®®ä¼˜å…ˆä½¿ç”¨ <code>ApplicationContext</code>ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åœ¨é€šè¿‡<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#spring-core">Spring å®˜ç½‘</a> äº†è§£äº† IoC ã€DI ã€å®¹å™¨å’Œ Bean çš„æ¦‚å¿µåï¼Œå†ç»“åˆå¹³å¸¸çš„ä½¿ç”¨åŸºæœ¬ä¸Šå¯ä»¥æœ‰ä¸ªå¤§æ¦‚æµç¨‹ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/0hWvfR-K15LRP.png" alt="æµç¨‹çŒœæƒ³"></p><p>å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå¾ˆç²—ç•¥çš„çŒœæƒ³ï¼Œæ˜¯å¦æ­£ç¡®ï¼Œè¿˜æœ‰å¾…åé¢ç»§ç»­é˜…è¯»æºç ï¼Œç„¶åå»éªŒè¯ã€‚</p><h3 id="ç›¸å…³æ¨è"><a href="#ç›¸å…³æ¨è" class="headerlink" title="ç›¸å…³æ¨è"></a>ç›¸å…³æ¨è</h3><ul><li><a href="https://mp.weixin.qq.com/s/gDhJMSPSX2vz68p5X3juow">Spring æºç å­¦ä¹  01ï¼šæºç é˜…è¯»ç¯å¢ƒçš„æ­å»º</a></li><li><a href="https://mp.weixin.qq.com/s/BORxKatt9qs4rDgmAHbv_A">Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ</a></li><li><a href="https://mp.weixin.qq.com/s/ZJB-2WWeJFG7RQxaksNBuA">APP è«åå´©æºƒï¼Œå¼€å§‹ä»¥ä¸ºæ˜¯ Header ä¸­ name å¤§å°å†™çš„é”…ï¼Œæœ€åå‘ç°åŸæ¥æ˜¯å®¹å™¨çš„é”™</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring æºç å­¦ä¹  01ï¼šæºç é˜…è¯»ç¯å¢ƒçš„æ­å»º</title>
      <link href="2020/11/26/source-spring-build.html"/>
      <url>2020/11/26/source-spring-build.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><p>æœ¬æ–‡è®°å½•äº† Spring æºç ç¯å¢ƒçš„æ­å»ºæ–¹å¼ï¼Œä»¥åŠè¸©è¿‡çš„é‚£äº›å‘ï¼â€‹ å½“å‰ç‰ˆæœ¬ï¼š5.3.2-SNAPSHOTã€‚</p></blockquote><h3 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h3><ol><li>Git</li><li>JDK<ol><li>master åˆ†æ”¯éœ€è¦ JDK 11</li><li>5.2.x åˆ†æ”¯ï¼Œ JDK8 å³å¯</li></ol></li><li>Gradle 6.5.1</li><li>IDEA æœ€æ–° ï¼ˆ2020.2.3ï¼‰</li></ol><p>Spring æºç ä»“åº“åœ°å€ï¼š<a href="https://github.com/spring-projects/spring-framework">https://github.com/spring-projects/spring-framework</a></p><h3 id="ä¸‹è½½æºç "><a href="#ä¸‹è½½æºç " class="headerlink" title="ä¸‹è½½æºç "></a>ä¸‹è½½æºç </h3><ol><li>clone æºç </li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span>  https://github.com/spring-projects/spring-framework.git</span><br></pre></td></tr></table></figure><ol start="2"><li><p>ä½¿ç”¨ IDEA æ‰“å¼€</p><ol><li><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/nN2jwC-B9crax.png"></li><li><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/SmFKEX-Rikm9z.png"></li><li>ç­‰å¾… IDEA åŠ è½½å®Œæˆå³å¯ã€‚</li></ol></li></ol><p>æ³¨ï¼š ä¹Ÿå¯ä»¥æŒ‡å®š clone çš„åˆ†æ”¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> -b 5.2.x  https://github.com/spring-projects/spring-framework.git</span><br></pre></td></tr></table></figure><p>æˆ–è€…å…ˆ fork åˆ°è‡ªå·±çš„ä»“åº“ï¼Œç„¶åå† cloneã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/larIO8-qFY4Fo.png"></p><p>è¿™é‡Œæˆ‘æ˜¯ fork åˆ°æˆ‘çš„ä»“åº“ï¼Œç„¶åå† clone çš„ã€‚</p><p>å½“å‰ master åˆ†æ”¯ä»£è¡¨çš„ç‰ˆæœ¬ä¸º 5.3.2-SNAPSHOTã€‚</p><h3 id="æ‰§è¡Œæµ‹è¯•"><a href="#æ‰§è¡Œæµ‹è¯•" class="headerlink" title="æ‰§è¡Œæµ‹è¯•"></a>æ‰§è¡Œæµ‹è¯•</h3><ul><li>åœ¨é¡¹ç›®å³é”®åˆ›å»º <code>module</code></li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/qkYNup-hSgF5s.png"></p><ul><li>é€‰æ‹© <code>Gradle</code> <code>Java</code></li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/v9YDiM-0D64W2.png"></p><ul><li>åˆ›å»º module</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/iYepMg-WRomfs.png"></p><ul><li>åœ¨ build.gradle ä¸­æ·»åŠ é…ç½®</li></ul><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">compile(project(&quot;:spring-context&quot;))</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/SUhEs6-2JKywY.png"></p><ul><li>åˆ›å»ºæµ‹è¯•ç±»å¹¶æµ‹è¯•</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/O55vLL-XSueLY.png"></p><p>å…¶ä¸­ <code>UserComponent</code> æ·»åŠ äº† <code>@Component</code> æ³¨è§£ï¼Œ ç¨‹åºæ­£å¸¸æ‰§è¡Œåˆ™ä¸€åˆ‡ OKã€‚å¯ä»¥å¼€å§‹æ„‰å¿«çš„è°ƒè¯•ä»£ç äº†ã€‚</p><h3 id="é—®é¢˜æ€»ç»“"><a href="#é—®é¢˜æ€»ç»“" class="headerlink" title="é—®é¢˜æ€»ç»“"></a>é—®é¢˜æ€»ç»“</h3><h4 id="ç¼–è¯‘å¤±è´¥"><a href="#ç¼–è¯‘å¤±è´¥" class="headerlink" title="ç¼–è¯‘å¤±è´¥"></a>ç¼–è¯‘å¤±è´¥</h4><p>æœ‰å°ä¼™ä¼´ç›´æ¥ä¸‹è½½ zip åŒ…ï¼Œå¯èƒ½é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š(éå¸¸ä¸å»ºè®®ç›´æ¥ä¸‹è½½ zip åŒ…æ„å»ºï¼Œæƒ³çŸ¥é“åŸå› å¯ä»¥ç»§ç»­çœ‹ï¼Œæœ€åæˆ‘ä¹Ÿæ²¡æœ‰æ„å»ºæˆåŠŸï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡ clone æ„å»ºçš„ã€‚)</p><ol><li>æŠ¥é”™å¦‚ä¸‹ï¼š</li></ol><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">fatal: not a git repository (or any of the parent directories): .git</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL in 14s</span><br><span class="line">Build scan background action failed.</span><br><span class="line">org.gradle.process.internal.ExecException: Process &#x27;command &#x27;git&#x27;&#x27; finished with non-zero exit value 128</span><br><span class="line">    ... å…¶ä»–çœç•¥</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/4mqrY9-o9NJO6.png"></p><p>çœ‹æ„æ€æ˜¯æ²¡æœ‰ git é…ç½®ï¼Œé‚£å°±æ·»åŠ ä¸Šå§ï¼</p><ol start="2"><li>è¿™æ—¶å€™æƒ³ç€æ·»åŠ  git</li></ol><p><code>VCS</code> -&gt; <code>Enable Version Control Integration...</code> -&gt; å³ä¸Šè§’ <code>Reload All Gradle Projects</code></p><p>ä¾ç„¶æŠ¥é”™</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">fatal: Needed a single revision</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/zLWbqb-rkJFw4.png"></p><ol start="3"><li>æŸ¥è¯¢é—®é¢˜</li></ol><p>issues åœ°å€ï¼š<a href="https://github.com/spring-projects/spring-framework/issues/24467">https://github.com/spring-projects/spring-framework/issues/24467</a></p><p>å»ºè®®ä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> git@github.com:spring-projects/spring-framework.git</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/siVXre-hle4kw.png"></p><p>æ„æ€å°±æ˜¯ zip å‘è¡Œç‰ˆä¸»è¦æ˜¯ç”¨æ¥å…±äº«æºä»£ç ï¼Œä½†ä¸ä¸€å®šç”¨äºæ„å»ºå®ƒã€‚</p><ol start="4"><li>æœ€åæˆ‘é€‰æ‹©äº†ä½¿ç”¨ clone çš„æ–¹å¼ï¼Œç›´æ¥ clone ä¸‹æ¥ï¼Œç„¶å build é€šè¿‡ã€‚</li></ol><h4 id="ç¼ºå°‘-cglib-å’Œ-objenesis-åŒ…"><a href="#ç¼ºå°‘-cglib-å’Œ-objenesis-åŒ…" class="headerlink" title="ç¼ºå°‘ cglib å’Œ objenesis åŒ…"></a>ç¼ºå°‘ cglib å’Œ objenesis åŒ…</h4><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">Kotlin: warnings found and -Weeror specified</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/Xnip-2020-11-24-06-DhRwoS.png"></p><p>æ²¡æœ‰ <code>spring-cglib-repack</code> å’Œ <code>spring-objenesis-repack</code> åŒ…</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/2fNVjI-71xWmS.png"></p><p>æ‰§è¡Œè¿™ä¸¤ä¸ªå³å¯ã€‚</p><h4 id="æ‰¾ä¸åˆ°åŒ…-jdk-jfr"><a href="#æ‰¾ä¸åˆ°åŒ…-jdk-jfr" class="headerlink" title="æ‰¾ä¸åˆ°åŒ… jdk.jfr"></a>æ‰¾ä¸åˆ°åŒ… jdk.jfr</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.jfr.Category;</span><br><span class="line"><span class="keyword">import</span> jdk.jfr.Description;</span><br><span class="line"><span class="keyword">import</span> jdk.jfr.Event;</span><br><span class="line"><span class="keyword">import</span> jdk.jfr.Label;</span><br></pre></td></tr></table></figure><p>JDK å‡çº§ä¸º 11ã€‚å› ä¸ºæˆ‘æœ¬åœ°ä½¿ç”¨çš„æ˜¯ JDK8ï¼Œå‘ç°æŠ¥é”™ï¼Œjfr åŒ…éœ€è¦å‡çº§ JDK 11 æ‰æœ‰ã€‚</p><p>å¦‚æœä¸ç”Ÿæ•ˆï¼Œå¯ä»¥é€šè¿‡ï¼š</p><p>IDEA -&gt; <code>File</code> -&gt; <code>Project Structure</code> -&gt; <code>Project</code> æ£€æŸ¥ä¸‹æ˜¯å¦ä¿®æ”¹ä¸º JDK 11</p><p>å¿«æ·é”®ï¼š<code>âŒ˜ + ;</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ost9dI-pTohuz.png"></p><h4 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h4><ol><li>Spring ä»“åº“ï¼š<a href="https://github.com/spring-projects/spring-framework">https://github.com/spring-projects/spring-framework</a></li><li>Spring æ„å»ºæ–‡æ¡£ï¼š<a href="https://github.com/spring-projects/spring-framework/wiki/Build-from-Source">https://github.com/spring-projects/spring-framework/wiki/Build-from-Source</a></li></ol><h4 id="å†å²æ–‡ç« "><a href="#å†å²æ–‡ç« " class="headerlink" title="å†å²æ–‡ç« "></a>å†å²æ–‡ç« </h4><ul><li><a href="https://mp.weixin.qq.com/s/_z4KaFip3qz2fynviMYiRQ">ReentrantLock æºç ã€ç”»å›¾ä¸€èµ·çœ‹ä¸€çœ‹ï¼</a></li><li><a href="https://mp.weixin.qq.com/s/yIzAe3kb0HCphzm1Evv-Tw">ReentrantReadWriteLock çš„åŸç†ï¼</a></li><li><a href="https://mp.weixin.qq.com/s/BORxKatt9qs4rDgmAHbv_A">Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å·¥å…·å†Œã€‘- DocView ç°åœ¨æ”¯æŒè‡ªå®šä¹‰ Markdown æ¨¡ç‰ˆäº†ï¼</title>
      <link href="2020/11/23/doc-view-template.html"/>
      <url>2020/11/23/doc-view-template.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><p>æœ‰å°ä¼™ä¼´åé¦ˆè¯´å¸Œæœ›å¯ä»¥è‡ªå®šä¹‰ Markdown æ¨¡ç‰ˆï¼Œè¿™æ ·å°±å¯ä»¥å¯¼å‡ºè‡ªå·±æƒ³è¦çš„æ ·å¼äº†ï¼è¿™ä¸ªåŠŸèƒ½å¯ä»¥æœ‰ï¼Œæ¯•ç«Ÿå¤§å®¶ä¸å¯èƒ½éƒ½ç”Ÿæˆä¸€æ¨¡ä¸€æ ·çš„æ–‡æ¡£ã€‚ç°åœ¨æ¥ä¸€èµ·çœ‹çœ‹å¦‚ä½•å®ç°è‡ªå®šä¹‰æ¨¡ç‰ˆå§ï¼</p></blockquote><h4 id="è®¾ç½®æ¨¡ç‰ˆ"><a href="#è®¾ç½®æ¨¡ç‰ˆ" class="headerlink" title="è®¾ç½®æ¨¡ç‰ˆ"></a>è®¾ç½®æ¨¡ç‰ˆ</h4><p><code>Settings</code> -&gt; <code>Other Settings</code> -&gt; <code>Doc View</code> -&gt; <code>Markdown Template</code></p><p>æ‰“å¼€ä¹‹åå†…å®¹å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/Xnip-2020-11-23-59-asNWSp.png" alt="Xnip-2020-11-23-59-asNWSp"></p><p>æ¨¡ç‰ˆè¿™é‡Œåˆ†ä¸¤ä¸ª <code>Tab</code> åˆ†åˆ«æ˜¯ <code>Spring</code> ã€ <code>Dubbo</code> ã€‚</p><p>è¿™ä¸¤ä¸ªæ¨¡ç‰ˆå†…å®¹å°±ç¨å¾®æœ‰äº›åŒºåˆ«ï¼Œå¦‚æœè‡ªå®šä¹‰æ¨¡ç‰ˆï¼Œç›´æ¥ä¿®æ”¹ä¿å­˜å³å¯ã€‚</p><h4 id="æ¨¡ç‰ˆå˜é‡"><a href="#æ¨¡ç‰ˆå˜é‡" class="headerlink" title="æ¨¡ç‰ˆå˜é‡"></a>æ¨¡ç‰ˆå˜é‡</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/d3VlSJ-Hxz8Tj.png"></p><p>å…³äºæ¨¡ç‰ˆå˜é‡ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>velocity</code> å°†å˜é‡æ›¿æ¢ä¸ºæ–‡æœ¬ï¼Œå¦‚æœæœ‰å…¶ä»–æ–¹å¼ï¼Œæˆ–è€…è¯´æ˜¯ <code>IDEA</code> ç”¨çš„é‚£ç§æ–¹å¼ï¼Œå¸Œæœ›å¯ä»¥å‘Šè¯‰æˆ‘ã€‚æœ€å¥½å¯ä»¥æä¾›æºç ã€‚ </p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>éå¸¸æ„Ÿè°¢ <a href="https://github.com/lvgocc">lvgo</a> å°ä¼™ä¼´çš„å‚ä¸ã€‚</p><p>å¦‚æœå°ä¼™ä¼´ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°ä¸€äº› bug æˆ–è€…æœ‰å¥½çš„æ„è§å»ºè®®ï¼Œå¯ä»¥åœ¨ GitHub æäº¤ Issues ç•™è¨€æŒ‡å‡ºæ¥ã€‚</p><p>Doc View GitHubï¼š<a href="https://github.com/liuzhihang/doc-view">https://github.com/liuzhihang/doc-view</a></p><p>æœ€åï¼Œè®°å¾—è¦ <code>ä¸€é”®ä¸‰è¿</code>ï¼Œ æ¥ä¸ª <code>ã€åˆ†äº«ã€ç‚¹èµã€åœ¨çœ‹ã€‘</code>ï¼</p><h4 id="æ¨èæ–‡ç« "><a href="#æ¨èæ–‡ç« " class="headerlink" title="æ¨èæ–‡ç« "></a>æ¨èæ–‡ç« </h4><ul><li><a href="https://mp.weixin.qq.com/s/rOTm9Kv02xLZZVFzQXf7IA">Dubbo ç”Ÿæˆæ–‡æ¡£ï¼Œå¯¼å‡º Markdownï¼Œè¿™äº›åŠŸèƒ½ DocView ç°åœ¨éƒ½æœ‰äº†ï¼</a></li><li><a href="https://mp.weixin.qq.com/s/VgOHLQ_f4E8UlV9sQhyFpQ">å¤´å¤§ï¼å†™æ–‡æ¡£å¤ªéº»çƒ¦äº†ï¼å¿«æ¥è¯•è¯•è¿™æ¬¾ IDEA æ’ä»¶å•Šï¼çˆ½åˆ°é£èµ·~</a></li><li><a href="https://mp.weixin.qq.com/s/G8h5lg-d8SHZ2_ILBE04sQ">å°ä¼™ä¼´æƒ³å†™ä¸ª IDEA æ’ä»¶ä¹ˆï¼Ÿè¿™äº› API äº†è§£ä¸€ä¸‹ï¼</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> å·¥å…·å†Œ </category>
          
          <category> Doc View </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥å…·å†Œ </tag>
            
            <tag> Doc View </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å·¥å…·å†Œã€‘- Dubbo æ¥å£ï¼Œå¯¼å‡º Markdown ï¼Œè¿™äº›åŠŸèƒ½ DocView ç°åœ¨éƒ½æœ‰äº†ï¼</title>
      <link href="2020/11/19/doc-view-dubbo.html"/>
      <url>2020/11/19/doc-view-dubbo.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>è‡ªä» DocView å‘å¸ƒäº†ç®€é™‹çš„ç¬¬ä¸€ç‰ˆä¹‹åï¼Œå°±ä¸æ–­åœ°æœ‰å°ä¼™ä¼´æå»ºè®®æ„è§ç­‰ç­‰ï¼Œå¸Œæœ›æ‰©å±•å„ç§åŠŸèƒ½ã€‚è¿™ä¸ï¼Œæ—¶éš”ä¸¤å‘¨ï¼ŒDocView åˆå‘å¸ƒäº†æ–°ç‰ˆæœ¬ï¼Œæœ¬æ¬¡çš„æ›´æ–°ä¸»è¦æ¶‰åŠåˆ°æ”¯æŒ Dubboï¼Œä»¥åŠæ”¯æŒå¯¼å‡ºå•ä¸ªæ–‡æ¡£ä¸º Markdown æ–‡ä»¶ã€‚æ¥ä¸€èµ·çœ‹çœ‹æ–°åŠŸèƒ½å§ï¼</p></blockquote><h4 id="æ”¯æŒå¯¼å‡º-Markdown-æ–‡ä»¶"><a href="#æ”¯æŒå¯¼å‡º-Markdown-æ–‡ä»¶" class="headerlink" title="æ”¯æŒå¯¼å‡º Markdown æ–‡ä»¶"></a>æ”¯æŒå¯¼å‡º Markdown æ–‡ä»¶</h4><p>DocView åŸç‰ˆæœ¬å·²ç»æ”¯æŒå¤åˆ¶åˆ°å‰ªè´´æ¿çš„åŠŸèƒ½ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/uRAtpo-AJ2kyV.png" alt="åŸç‰ˆæœ¬"></p><p>è€Œåœ¨æ–°ç‰ˆæœ¬ä¸­å¢åŠ äº† <code>Export</code> æŒ‰é’®ï¼Œå¯ä»¥å°†å•ä¸ªæ–‡æ¡£å¯¼å‡ºä¸º Markdown æ–‡ä»¶ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/KLmzHE-Sxlxc6.png" alt="æ–°ç‰ˆæœ¬"></p><p>æ¥ä¸€å¼ åŠ¨å›¾ï¼Œå¤§å®¶çœ‹çœ‹æ•ˆæœï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/1111-l7NaTW.gif" alt="1111-l7NaTW"></p><p>å¯¼å‡ºçš„ Markdown æ–‡æœ¬å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/DJCp6X-saP6nE.png" alt="DJCp6X-saP6nE"></p><h4 id="æ”¯æŒ-Dubbo-æ¥å£"><a href="#æ”¯æŒ-Dubbo-æ¥å£" class="headerlink" title="æ”¯æŒ Dubbo æ¥å£"></a>æ”¯æŒ Dubbo æ¥å£</h4><p>ä¹‹å‰çš„ç‰ˆæœ¬æ˜¯ä¸æ”¯æŒ Dubbo æ¥å£çš„ï¼Œè€Œç°åœ¨çš„ç‰ˆæœ¬å¯ä»¥åœ¨ Dubbo æ¥å£é‡Œé¢ä½¿ç”¨ã€‚</p><p>å½“ç„¶è¿™é‡Œå¹¶æ²¡æœ‰æ ¡éªŒæ¥å£æ˜¯å¦ä¸º Dubbo æ¥å£ï¼Œåªæ˜¯æ ¡éªŒäº†ä¸‹æ˜¯å¦ä¸ºæ¥å£ã€‚æ‰€ä»¥è¯´å³ä½¿å…¶ä»–æ¥å£ä¹Ÿæ˜¯å¯ä»¥ç”Ÿæˆçš„ã€‚</p><p><strong>è¿™å—è¿˜æ˜¯éœ€è¦å®Œå–„çš„!</strong></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/S8M4fB-3ecWbP.png" alt="S8M4fB-3ecWbP"></p><h4 id="DocView-æ–‡æ¡£åœ°å€"><a href="#DocView-æ–‡æ¡£åœ°å€" class="headerlink" title="DocView æ–‡æ¡£åœ°å€"></a>DocView æ–‡æ¡£åœ°å€</h4><p>åœ¨é¢æ¿å·¦ä¸‹è§’çš„ <code>help</code> æŒ‰é’®ä¿®æ”¹äº†è·³è½¬åœ°å€ä¸ºï¼š<a href="http://docview.liuzhihang.com/">http://docview.liuzhihang.com/</a></p><p>åªæ˜¯ç²—ç•¥æ­å»ºäº†ä¸€ä¸ª DocView çš„è¯´æ˜æ–‡æ¡£ç½‘ç«™ï¼Œå°ä¼™ä¼´ä»¬å¯ä»¥å‘ç°è¿™ä¸ªç½‘ç«™è¿ logo éƒ½æ²¡æœ‰ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/IQNatL-uWWCqO.png" alt="IQNatL-uWWCqO"></p><h4 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h4><p>å½“ç„¶ä¹Ÿæœ‰ä¸€äº›å…¶ä»–çš„å°æ”¹åŠ¨ï¼Œæ¯”å¦‚è®¾ç½®é¡µé¢ï¼ˆä¾ç„¶ä¸æ”¯æŒè‡ªå®šä¹‰è®¾ç½®ï¼‰ã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/MJjOX4-pRQhfK.png" alt="MJjOX4-pRQhfK"></p><p>DocView è™½ç„¶æ”¯æŒäº†ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œä½†æ˜¯è·ç¦»å°ä¼™ä¼´ä»¬æœŸæœ›ä¸­çš„æ–‡æ¡£æ’ä»¶è¿˜æœ‰å¾ˆå¤šå¾ˆå¤šéœ€è¦è¿­ä»£çš„åŠŸèƒ½ã€‚</p><p>æ¯”å¦‚ï¼š</p><ul><li>æ‰¹é‡ç”Ÿæˆï¼ˆå½“å‰ä»…æ”¯æŒå•ä¸ªç±»æˆ–è€…æ–¹æ³•ï¼‰</li><li>æ‰¹é‡å¯¼å‡º</li><li>é¢æ¿æ”¯æŒæŸ¥çœ‹ Markdown æºæ–‡æœ¬</li><li>æ”¯æŒä» Swagger æ³¨è§£è·å–å­—æ®µç›¸å…³ä¿¡æ¯</li><li>æ”¯æŒ Setting è®¾ç½®</li><li>æ”¯æŒè‡ªå®šä¹‰æ¨¡ç‰ˆ</li><li>æ”¯æŒä¸Šä¼ çš„ YApi</li><li>æ”¯æŒå¯¼å‡ºå…¶ä»–ç±»å‹</li><li>â€¦</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/cx5PxU-gVxBmM.jpg" alt="cx5PxU-gVxBmM"></p><p>å—¯~ å¯èƒ½å¤§æ¦‚ä¹Ÿè®¸åº”è¯¥ä¼šéœ€è¦è¿­ä»£å¾ˆä¹…â€¦â€¦</p><p>ä¹Ÿç¡®å®æ˜¯ä¸ªäººèƒ½åŠ›å’Œç²¾åŠ›æœ‰é™ï¼Œå¦‚æœå°ä¼™ä¼´ä»¬æœ‰å…´è¶£ï¼Œå¯ä»¥æäº¤ PRã€‚</p><p>å½“ç„¶å¦‚æœå°ä¼™ä¼´ä»¬å‘ç°ä¸€äº› bug æˆ–è€…æœ‰å¥½çš„æ„è§å»ºè®®ï¼Œä¹Ÿå¯ä»¥ç•™è¨€æŒ‡å‡ºæ¥ã€‚</p><p>ç•™è¨€æ¨èå¤§å®¶åœ¨ GitHub æ Issuesã€‚</p><p>æœ€åå¦‚æœå°ä¼™ä¼´ä»¬è§‰å¾—æ’ä»¶ä¸é”™ï¼Œå¯ä»¥æ¨èç»™å‘¨å›´çš„æœ‹å‹åŒäº‹ï¼Œä¹Ÿè®°å¾— <code>ä¸€é”®ä¸‰è¿</code>ï¼Œ æ¥ä¸ª <code>ã€åˆ†äº«ã€ç‚¹èµã€å†çœ‹ã€‘</code>ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å·¥å…·å†Œ </category>
          
          <category> Doc View </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥å…·å†Œ </tag>
            
            <tag> Doc View </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Warning: Calling `brew list` to only list formulae is deprecated! Use `brew list --formula` instead.</title>
      <link href="2020/11/15/brew-list-warning.html"/>
      <url>2020/11/15/brew-list-warning.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><p>æœ€è¿‘ç»ˆç«¯æ€»æ˜¯å¼¹å‡ºè¿™ä¹ˆä¸€å¥è¯ï¼Œå’±ä¹Ÿä¸æ‡‚æ€ä¹ˆè§£å†³ã€‚</p><p>Google baidu ä¹ŸæŸ¥ä¸åˆ°é—®é¢˜ã€‚</p><p>å°ä¼™ä¼´å¸®å¿™çœ‹ä¸€ä¸‹ã€‚</p><p>æ¯æ¬¡æ–°æ‰“å¼€ç»ˆç«¯éƒ½ä¼šæœ‰è¿™ä¸ª Warning ã€‚</p><pre><code>Warning: Calling `brew list` to only list formulae is deprecated! Use `brew list --formula` instead.</code></pre><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/5eDhZb-ptj6gr.png" alt="5eDhZb-ptj6gr"></p><p>æœ€åè¢«é€¼æ— å¥ˆï¼Œåœ¨ V ç«™ å‘å¸–æ±‚åŠ©å°ä¼™ä¼´ï¼Œ ç»“æœè¿˜çœŸæ‰¾åˆ°äº†ç­”æ¡ˆ</p><h3 id="è§£å†³æ–¹å¼"><a href="#è§£å†³æ–¹å¼" class="headerlink" title="è§£å†³æ–¹å¼"></a>è§£å†³æ–¹å¼</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/HvJSlT-Q0oUVr.png" alt="HvJSlT-Q0oUVr"></p><p>æœ€åæ‰¾åˆ°é—®é¢˜æ‰€åœ¨ï¼Œæ˜¯å› ä¸ºæŒ‰ç…§ç½‘ä¸Šçš„æ•™ç¨‹å®‰è£…çš„ <code>Coreutils</code></p><p><code>~/.zshrc </code>é‡Œæ”¹ä¸€ä¸‹å³å¯ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/hAFz8B-HWsVNg.png" alt="hAFz8B-HWsVNg"></p><h3 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h3><p>å†™åˆ°è¿™é‡Œï¼Œå¾ˆå¤šå°ä¼™ä¼´åº”è¯¥å·²ç»çŸ¥é“é—®é¢˜æ‰€åœ¨äº†ï¼Œå¯èƒ½æœ‰çš„å°ä¼™ä¼´è¿˜ä¸çŸ¥é“æ€ä¹ˆè§£å†³ï¼š</p><ol><li><code>vim ~/.zshrc</code></li><li>æ‰¾åˆ°ä½¿ç”¨ <code>brew list</code> çš„åœ°æ–¹</li><li>å°† <code>brew list</code> æ”¹ä¸º <code>brew list --formula</code></li></ol><p>å¦‚æœè¿˜ä¸çŸ¥é“æ€ä¹ˆå¼„ï¼Œé‚£å¯ä»¥ç”¨ç¼–è¾‘å·¥å…·æ‰“å¼€<code> .zshrc</code> æ–‡ä»¶ï¼Œç„¶åæœç´¢æ‰¾åˆ° <code>brew list</code> ï¼Œç„¶åæ›¿æ¢ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> issue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> issue </tag>
            
            <tag> mac </tag>
            
            <tag> brew </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å·¥ä½œç¬”è®°ã€‘- Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ</title>
      <link href="2020/11/08/spring-self-call.html"/>
      <url>2020/11/08/spring-self-call.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>ç›¸ä¿¡å¤§å®¶éƒ½é‡åˆ°ä¸€ç§äº‹åŠ¡å¤±æ•ˆåœºæ™¯ï¼Œé‚£å°±æ˜¯ Spring è‡ªè°ƒç”¨ï¼Œå°±æ˜¯åœ¨ Service æ–¹æ³•å†…ï¼Œè°ƒç”¨å¦ä¸€ä¸ªåŠ  <code>@Transactional</code> æ³¨è§£çš„æ–¹æ³•ï¼Œå‘ç°äº‹åŠ¡å¤±æ•ˆï¼Œè¿™æ—¶å€™ä½ æ˜¯æ€ä¹ˆè§£å†³çš„å‘¢ï¼Ÿ</p></blockquote><h3 id="äº‹æƒ…å›é¡¾"><a href="#äº‹æƒ…å›é¡¾" class="headerlink" title="äº‹æƒ…å›é¡¾"></a>äº‹æƒ…å›é¡¾</h3><p>é‚£æ˜¯ä¸€ä¸ªæˆ‘å¿˜äº†å¤©æ°”å’‹æ ·çš„ä¸‹åˆï¼Œçªç„¶è¹¦å‡ºä¸€ä¸ªå°çº¢ç‚¹ï¼Œå—¯~ æŒºç€æ€¥çš„å°çº¢ç‚¹ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/3E8q0W-3Cg65u.png" alt="3E8q0W-3Cg65u"></p><p>åŸæ¥æ˜¯äº‹åŠ¡å¤±æ•ˆäº†ï¼</p><p>è«æ…Œï¼è«æ…Œï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/kRoqUW-MKbcBj.png" alt="kRoqUW-MKbcBj"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/KVdtlZ-F3jW3p.png" alt="KVdtlZ-F3jW3p"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/T4poZK-qyiLEV.png" alt="T4poZK-qyiLEV"></p><p>æœ€åå°ä¼™ä¼´é€‰æ‹©äº†æŠ½èµ°ï¼Œæ˜¯æˆ‘çš„å·¥å…·ç±»ä¸é¦™äº†ä¹ˆï¼Ÿ</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/zVf6LC-tLzseS.png" alt="zVf6LC-tLzseS"></p><p>å½“ç„¶æ•…äº‹çš„ç»“æœæ˜¯å®Œç¾çš„ï¼Œé—®é¢˜è§£å†³äº†ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/v3W8tg-VJEgZS.jpg" alt="v3W8tg-VJEgZS"></p><h3 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h3><p>åœ¨å¼€å‘ä¸­æ¶‰åŠåˆ°åŒæ—¶æ“ä½œå¤šä¸ªè¡¨çš„æ—¶å€™ï¼Œè¦ä¿è¯ä¸¤ä¸ªæ“ä½œè¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·å¤±è´¥ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°äº‹åŠ¡ã€‚</p><p>ç°åœ¨ä¸€èˆ¬ä½¿ç”¨çš„éƒ½æ˜¯åŸºäº <code>@Transactional</code> æ³¨è§£çš„<strong>å£°æ˜å¼äº‹åŠ¡</strong>ã€‚</p><p>è€Œäº‹åŠ¡ä½¿ç”¨è¿‡ç¨‹ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š</p><ol><li>äº‹åŠ¡åªèƒ½åº”ç”¨åˆ° public æ–¹æ³•ä¸Šæ‰ä¼šæœ‰æ•ˆï¼›</li><li>äº‹åŠ¡éœ€è¦ä»å¤–éƒ¨è°ƒç”¨ï¼ŒSpring è‡ªè°ƒç”¨ä¼šå¤±æ•ˆï¼›</li><li>å»ºè®®äº‹åŠ¡æ³¨è§£ @Transactional ä¸€èˆ¬æ·»åŠ åœ¨å®ç°ç±»ä¸Šã€‚</li></ol><p>å½“ç„¶è¿™å‡ å¥è¯ä¸æ˜¯è¯´æˆ‘çš„ï¼Œäººå®¶å®˜æ–¹æ–‡æ¡£å¯æ˜¯æ˜ç¡®è¯´æ˜çš„ï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/IlNXVn-uemNYF.png" alt="IlNXVn-uemNYF"></p><p>è¿™é‡Œå¯æ˜¯è¯´æ˜äº†<code>åº”ä»…å°† @Transactional æ³¨è§£åº”ç”¨äºå…·æœ‰å…¬å¼€å¯è§æ€§çš„æ–¹æ³•ã€‚å¦‚æœå¯¹å— protected, private oæˆ– package-visible ä¿®é¥°çš„æ–¹æ³•ä½¿ç”¨ï¼Œåˆ™ä¸ä¼šå¼•å‘ä»»ä½•é”™è¯¯ï¼Œä½†æ˜¯è¢«æ³¨è§£çš„æ–¹æ³•ä¸ä¼šæ˜¾ç¤ºå·²é…ç½®çš„äº‹åŠ¡è®¾ç½®ã€‚</code></p><p>è¯´ç™½äº†ï¼Œå°±æ˜¯ä½ ç”¨äº†ï¼Œä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯ä¸ç”Ÿæ•ˆï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/M5XTck-YnrPiu.png" alt="M5XTck-YnrPiu"></p><p>è‡³äºå»ºè®®åŠ åœ¨å®ç°ç±»ä¸Šï¼Œè¿™ä¸ªåªæ˜¯å»ºè®®ï¼Œä¸è¿‡å¦‚æœåŠ åœ¨æ¥å£ç±»æˆ–æ¥å£æ–¹æ³•ä¸Šæ—¶ï¼Œåªæœ‰é…ç½®åŸºäºæ¥å£çš„ä»£ç†æ‰ä¼šç”Ÿæ•ˆã€‚æ‰€ä»¥è¿™å—è¿˜æ˜¯è€è€å®å®çš„<code>åŠ åœ¨å®ç°ç±»æˆ–å®ç°ç±»æ–¹æ³•ä¸Š</code>å§ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/P28Ciu-4YvetS.png" alt="P28Ciu-4YvetS"></p><p>å› ä¸ºä»£ç†æ¨¡å¼åªæ‹¦æˆªé€šè¿‡ä»£ç†ä¼ å…¥çš„å¤–éƒ¨æ–¹æ³•è°ƒç”¨ï¼Œæ‰€ä»¥è‡ªè°ƒç”¨äº‹åŠ¡æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚</p><p>å®˜æ–¹çš„è§£é‡Šè¿˜æ˜¯æ¯”è¾ƒç®€å•æ˜äº†çš„ï¼Œè™½ç„¶æˆ‘çœ‹ä¸æ‡‚ï¼Œä½†æ˜¯ä¸å½±å“æˆ‘æˆªå›¾ã€‚</p><p>é‚£æˆ‘è¿˜æ˜¯å†æˆªä¸€ä¸ªå§â€¦â€¦</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/sBkeIz-80K1UE.png" alt="sBkeIz-80K1UE"></p><h3 id="å®é™…ä½¿ç”¨"><a href="#å®é™…ä½¿ç”¨" class="headerlink" title="å®é™…ä½¿ç”¨"></a>å®é™…ä½¿ç”¨</h3><p>ä½†æ˜¯åœ¨å¼€å‘ä¸­ï¼Œå°ä¼™ä¼´ä»¬å¾€å¾€ä¼šé‡åˆ°è¿™ç§æƒ…å†µï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/g1BG6s-BgQfOw.png" alt="g1BG6s-BgQfOw"></p><p>æœ¬æ¥<strong>è‡ªå·±å†™çš„</strong>ä»£ç å°±ä¸€å¨å¨çš„åˆè‡­åˆé•¿ï¼Œé‡Œé¢æœ‰å„ç§éªŒç­¾ã€éªŒå‚ã€æŸ¥è¯¢ã€éªŒè¯ç­‰ç­‰ï¼Œå°±æƒ³ç€æ¥ä¸ªäº‹åŠ¡ï¼Œè®©äº‹åŠ¡åŒ…è£¹çš„èŒƒå›´æœ€å°ï¼Œä»…ä»…åœ¨åŒæ—¶æ›´æ–°çš„æ—¶å€™åŠ ä¸Šäº‹åŠ¡å§ï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/38SYyX-gEXV58.png" alt="38SYyX-gEXV58"></p><p>è¿™ä¹ˆå†™ï¼Œå’¦~ IDEA æŠ¥é”™äº†ï¼Œå¥½åƒä¸èƒ½ <code>private</code> ä¿®é¥°ï¼Œé‚£æˆ‘æ”¹æˆ <code>public</code>ã€‚</p><p>å¾ˆæ˜¾ç„¶äº‹åŠ¡æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚</p><p>æŠŠæ›´æ–°çš„ä»£ç æ”¾åˆ°<code>åˆè‡­åˆé•¿</code>çš„ä»£ç é‡Œé¢ï¼Œè®©å®ƒå˜å¾—æ›´è‡­æ›´é•¿ï¼Œç„¶åç”¨ <code>@Transactional</code> æ³¨è§£ä¸€åŠ ã€‚å®Œç¾è§£å†³ï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/9r8ioC-W6kSbv.jpg" alt="9r8ioC-W6kSbv"></p><p>è¯·æ”¾è¿‡é‚£å¨ä»£ç å§ï¼æ¥çœ‹çœ‹ä¸‹é¢çš„åŠæ³•ã€‚</p><h4 id="è§£å†³æ–¹æ¡ˆ-1"><a href="#è§£å†³æ–¹æ¡ˆ-1" class="headerlink" title="è§£å†³æ–¹æ¡ˆ 1"></a>è§£å†³æ–¹æ¡ˆ 1</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/08fPAy-ee1X6A.png" alt="08fPAy-ee1X6A"></p><p>é‚£æˆ‘æ”¹æˆå¤–éƒ¨è°ƒç”¨ä¸å°±è¡Œäº†ä¹ˆï¼Ÿ</p><p>å†å£°æ˜ä¸€ä¸ª Serviceï¼ŒæŠŠæ›´æ–°è¡¨çš„é€»è¾‘æ”¾è¿‡å»ã€‚</p><p>æˆ‘ä¸€èˆ¬å°±å–œæ¬¢ä½¿ç”¨è¿™ä¸ªåŠæ³•ã€‚</p><h4 id="è§£å†³æ–¹æ¡ˆ-2"><a href="#è§£å†³æ–¹æ¡ˆ-2" class="headerlink" title="è§£å†³æ–¹æ¡ˆ 2"></a>è§£å†³æ–¹æ¡ˆ 2</h4><p>ä½¿ç”¨<code>ç¼–ç¨‹å¼äº‹åŠ¡</code>ï¼Œå‰é¢è¯´äº†ï¼Œä½¿ç”¨<code>å£°æ˜å¼äº‹åŠ¡</code>æ—¶ï¼Œåˆè¿™åˆé‚£ï¼Œæˆ‘æ¢ä¸€ç§æ€»å¯ä»¥å§ï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/yuJKad-LGJuVt.png" alt="yuJKad-LGJuVt"></p><p>ä½ çœ‹ï¼Œæˆ‘è¿˜æŠŠæ–¹æ³•æ”¹æˆ <code>private</code> ä¿®é¥°äº†ï¼Œäº‹åŠ¡ä¹Ÿç”Ÿæ•ˆã€‚å®Œç¾è§£å†³ï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/8orQs4-tgtQts.jpg" alt="8orQs4-tgtQts"></p><p>å…¶å®è¿™ä¸ªæ–¹æ³•ä¹Ÿå¾ˆä¸é”™å“¦ï¼</p><h4 id="è§£å†³æ–¹æ¡ˆ-3"><a href="#è§£å†³æ–¹æ¡ˆ-3" class="headerlink" title="è§£å†³æ–¹æ¡ˆ 3"></a>è§£å†³æ–¹æ¡ˆ 3</h4><p>åˆæƒ³ç”¨æ³¨è§£ï¼Œåˆæƒ³è‡ªè°ƒç”¨æ€ä¹ˆåŠï¼Ÿ</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/MBSeHo-E5RDuC.jpg" alt="MBSeHo-E5RDuC"></p><p>ä¸è¿‡â€¦ éº»çƒ¦ä¸€ç‚¹è¿˜æ˜¯å¯ä»¥çš„ã€‚</p><p>å’±ä»¬å¯ä»¥å‚è€ƒ<code>ç¼–ç¨‹å¼äº‹åŠ¡</code>çš„æ–¹å¼ï¼Œä¸å°±æ˜¯ä¸è®©è‡ªè°ƒç”¨ä¹ˆï¼Œæˆ‘è°ƒå¤–éƒ¨æ–¹æ³•ï¼Œç„¶åå¤–éƒ¨æ–¹æ³•å†ç»™æˆ‘è°ƒå›æ¥ä¸å°±å¯ä»¥äº†ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionalComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cell</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">required</span><span class="params">(Cell cell)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        cell.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯ä¸å°±å¯ä»¥é€šè¿‡ <code>TransactionalComponent</code> è°ƒç”¨äº†ä¹ˆï¼Œå¹¶ä¸”è¿˜å¯ä»¥ä½¿ç”¨ <code>lambda</code> è¡¨è¾¾å¼ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/y5bnw5-TMtjKN.png" alt="y5bnw5-TMtjKN"></p><p>å½“ç„¶åŸºäºè¿™ä¸ªç‰ˆæœ¬ä¹Ÿå¯ä»¥åšä¸€ä¸ªè¿­ä»£ï¼Œå°±æ˜¯ä½¿ç”¨é™æ€æ–¹æ³•è°ƒç”¨ï¼Œä¸ç”¨æ¯æ¬¡éƒ½ç”¨ <code>@Autowired</code> æ³¨å…¥ä¸€æ¬¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionalUtils</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> TransactionalComponent transactionalComponent;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> TransactionalComponent <span class="title">getTransactionalComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transactionalComponent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ä»å®¹å™¨ä¸­è·å– transactionalComponent</span></span><br><span class="line">            transactionalComponent = ApplicationContextUtils.getBean(TransactionalComponent.class);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> transactionalComponent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">required</span><span class="params">(TransactionalComponent.Cell cell)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        getTransactionalComponent().required(cell);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/awzH4i-JjJNp4.png" alt="awzH4i-JjJNp4"></p><p>è¿™æ ·é€šè¿‡å·¥å…·ç±» <code>TransactionalUtils</code> ä¾¿å¯ä»¥ç›´æ¥è°ƒç”¨é™æ€æ–¹æ³•çš„æ–¹å¼æ‰§è¡Œäº‹åŠ¡æ“ä½œã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸ºä»€ä¹ˆä¼šé‡åˆ°äº‹åŠ¡å¤±æ•ˆï¼Œä»¥åŠäº‹åŠ¡å¤±æ•ˆçš„é¿å…æ–¹å¼ï¼ŒåŒæ—¶æä¾›äº†ä¸‰ç§æ–¹å¼æ¥è§£å†³è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆçš„é—®é¢˜ã€‚ä¸è¶³ä¹‹å¤„ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚</p><h4 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h4><ol><li>Spring æ–‡æ¡£ï¼š<a href="https://docs.spring.io/spring-framework/docs/5.3.0/reference/html/data-access.html#transaction-declarative-annotations">https://docs.spring.io/spring-framework/docs/5.3.0/reference/html/data-access.html#transaction-declarative-annotations</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> å·¥ä½œç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥ä½œç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å·¥å…·å†Œã€‘- å†™æ–‡æ¡£å¤ªéº»çƒ¦ï¼Œè¯•è¯•è¿™æ¬¾ IDEA æ’ä»¶å§ï¼</title>
      <link href="2020/11/01/doc-view.html"/>
      <url>2020/11/01/doc-view.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>æ¯æ¬¡å¼€å‘å®Œæ–°é¡¹ç›®æˆ–è€…æ–°æ¥å£åŠŸèƒ½ç­‰ï¼Œç¬¬ä¸€ä»¶äº‹å°±æ˜¯æä¾›æ¥å£æ–‡æ¡£ã€‚è¯´åˆ°æ¥å£æ–‡æ¡£ï¼Œå½“ç„¶æ˜¯ç”¨ Markdown äº†ã€‚å„ç§å¤åˆ¶ç²˜è´´å­—æ®µï¼Œå¿…å¡«éå¿…å¡«ï¼Œå­—æ®µå¤‡æ³¨ï¼Œè¯·æ±‚è¿”å›ç¤ºä¾‹ç­‰ç­‰ã€‚ç®€ç›´æ˜¯æµªè´¹æ—¶é—´å“‡ã€‚æ‰€ä»¥æƒ³åˆ°äº†å¼€å‘ä¸€æ¬¾æ’ä»¶æ¥è§£å†³é‡å¤å¤åˆ¶æ–‡æ¡£çš„é—®é¢˜ã€‚ä¸‹é¢æ¥çœ‹æˆ‘ä»‹ç»ä»‹ç»è¿™æ¬¾æ’ä»¶ã€‚</p><p>PSï¼šæ’ä»¶æ¯”è¾ƒç®€é™‹ï¼Œè¿˜éœ€è¦ä¸æ–­è¿­ä»£ã€‚</p></blockquote><h2 id="ä¸ºä»€ä¹ˆå¼€å‘æ’ä»¶"><a href="#ä¸ºä»€ä¹ˆå¼€å‘æ’ä»¶" class="headerlink" title="ä¸ºä»€ä¹ˆå¼€å‘æ’ä»¶"></a>ä¸ºä»€ä¹ˆå¼€å‘æ’ä»¶</h2><p>æ¯æ¬¡åœ¨å¯¹å¤–æä¾›æ¥å£æ—¶éƒ½è¦å†™æ–‡æ¡£ï¼Œå„ç§éº»çƒ¦ï¼Œå¹¶ä¸”æ–‡æ¡£è€—è´¹äº†å¾ˆå¤§ä¸€éƒ¨åˆ†æ—¶é—´ã€‚ä¹Ÿä½¿ç”¨äº†ä¸€äº›æ–‡æ¡£å·¥å…·ï¼Œåœ¨çº¿å†™ä½œå·¥å…·ï¼Œæœ€ç»ˆè¿˜æ˜¯æ¯”è¾ƒå–œæ¬¢è‡ªå·±æ‰‹å†™æ–‡æ¡£ã€‚</p><h3 id="ä½¿ç”¨è¿‡çš„ç”Ÿæˆå·¥å…·"><a href="#ä½¿ç”¨è¿‡çš„ç”Ÿæˆå·¥å…·" class="headerlink" title="ä½¿ç”¨è¿‡çš„ç”Ÿæˆå·¥å…·"></a>ä½¿ç”¨è¿‡çš„ç”Ÿæˆå·¥å…·</h3><ol><li>Swagger ï¼š æ·»åŠ ä¾èµ–ï¼Œé…ç½®ç±»åŠæè¿°ä¿¡æ¯ï¼Œç„¶ååœ¨æ–¹æ³•åŠå®ä½“ä¸Šæ·»åŠ æ³¨è§£ï¼Œå¯åŠ¨é¡¹ç›®ä¾¿å¯ä»¥é€šè¿‡è®¿é—® <code>xxxx/swagger-ui.html</code> æŸ¥çœ‹æ¥å£æ–‡æ¡£ï¼›</li><li>API Doc ï¼šæ·»åŠ é…ç½®æ–‡ä»¶åŠæ³¨é‡Šï¼Œå®‰è£… <code>npm</code> å¹¶é€šè¿‡æ‰§è¡Œå‘½ä»¤ç”Ÿæˆæ–‡æ¡£ï¼›</li><li>SmartDoc ï¼šæ·»åŠ ä¾èµ–åŠæ³¨é‡Šåæ‰§è¡Œæµ‹è¯•ç±»ç”Ÿæˆæ–‡æ¡£ï¼›</li><li>API2DOC ï¼šæ·»åŠ ä¾èµ–ï¼Œå¼€å¯æ³¨è§£ï¼Œé€šè¿‡æ³¨è§£é…ç½®ç”Ÿæˆæ–‡æ¡£ã€‚</li></ol><p>ä¸Šé¢å››ç§æ–¹æ³•ï¼Œæ— ç–‘éƒ½éœ€è¦æ·»åŠ ä¾èµ–ï¼Œä½¿ç”¨æ³¨è§£ç­‰æ–¹å¼ï¼Œå¯ä»¥è¯´æœ‰ä¸€å®šçš„ä»£ç ä¾µå…¥æ€§ã€‚</p><h3 id="ä½¿ç”¨è¿‡çš„æ¥å£æ–‡æ¡£å·¥å…·"><a href="#ä½¿ç”¨è¿‡çš„æ¥å£æ–‡æ¡£å·¥å…·" class="headerlink" title="ä½¿ç”¨è¿‡çš„æ¥å£æ–‡æ¡£å·¥å…·"></a>ä½¿ç”¨è¿‡çš„æ¥å£æ–‡æ¡£å·¥å…·</h3><ol><li>ShowDoc ï¼šæ›¾ç»ä¸€æ®µæ—¶é—´å¾ˆå–œæ¬¢ç”¨è¿™ä¸ªï¼Œ Markdown è¯­æ³•ï¼Œæ–¹ä¾¿ç›´è§‚ã€‚ä¸è¿‡å°±æ˜¯è¦è‡ªå·±æ‰‹å†™ï¼›</li><li>YApi ï¼šç°åœ¨åœ¨ä½¿ç”¨ YApiï¼Œå¯ä»¥é€šè¿‡ Swagger å¯¼å…¥ï¼›</li><li>VS Code å†™ Markdown ï¼šç›´æ¥ç¦»çº¿å†™ Markdown ï¼Œå¯ä»¥å¯¼å‡º PDFã€Wordã€Htmlã€‚</li></ol><p>è‡ªå·±å†™æ–‡æ¡£æ¯”è¾ƒé‡å¤ï¼Œç¹çï¼Œä¸è¿‡ä¸ªäººæ¯”è¾ƒå–œæ¬¢ Markdown æ ¼å¼ã€‚ç®€æ´ç›´è§‚ã€‚å¹¶ä¸”é…åˆç€æˆ‘ä¹‹å‰å†™çš„ IDEA æ’ä»¶ <code>copy-as-json</code> å’Œ <code>Tookit</code> å°†å®ä½“å¤åˆ¶ä¸º json å­—ç¬¦ä¸²ï¼Œç”¨æ¥å¿«é€Ÿç”Ÿæˆè¯·æ±‚æ ·ä¾‹å’Œè¿”å›æ ·ä¾‹ï¼Œè¿˜æ˜¯å¯ä»¥å‡å°‘ä¸€å®šçš„å·¥ä½œé‡çš„ã€‚</p><h3 id="å…¶ä»–ä½¿ç”¨æ–¹å¼"><a href="#å…¶ä»–ä½¿ç”¨æ–¹å¼" class="headerlink" title="å…¶ä»–ä½¿ç”¨æ–¹å¼"></a>å…¶ä»–ä½¿ç”¨æ–¹å¼</h3><p>ä½¿ç”¨å„ç§åœ¨çº¿åä½œå·¥å…·ï¼Œè…¾è®¯æ–‡æ¡£ã€è¯­é›€ã€çŸ³å¢¨æ–‡æ¡£ã€‚ä½¿ç”¨ç¦»çº¿ç‰ˆæœ¬ PDFã€Wordã€Excel ç­‰ç­‰ã€‚ä¹Ÿæœ‰ä¸€äº›å…¶ä»–çš„æ–‡æ¡£å·¥å…·ï¼Œä¸è¿‡è‡ªå·±éƒ½æ²¡æœ‰ä½¿ç”¨è¿‡æˆ–è€…è°ƒç ”è¿‡äº†ã€‚</p><p>åŸºæœ¬ä¸Šè¿™äº›æ–‡æ¡£å·¥å…·è¦ä¹ˆé€šè¿‡ä»£ç ä¾µå…¥çš„æ–¹å¼ç”Ÿæˆæ–‡æ¡£ï¼Œè¦ä¹ˆè‡ªå·±æ‰‹æ’¸æ–‡æ¡£ã€‚æ€»ä½“æ¥è¯´å„æœ‰åƒç§‹ã€‚</p><h3 id="ä¸ªäººæ‰‹å†™æ›´æ–¹ä¾¿"><a href="#ä¸ªäººæ‰‹å†™æ›´æ–¹ä¾¿" class="headerlink" title="ä¸ªäººæ‰‹å†™æ›´æ–¹ä¾¿"></a>ä¸ªäººæ‰‹å†™æ›´æ–¹ä¾¿</h3><p><strong>ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„å°±æ˜¯æ‰‹å†™ Markdown ã€‚</strong></p><p>ä¸‹é¢æ˜¯ä¸¤å¹…å›¾ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/fWC7q0-bt3RuN.png" alt="ShowDoc å®˜æ–¹æ ·ä¾‹"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/Yh68js-evYsQS.png" alt="VS Code æ‰‹å†™æ–‡æ¡£"></p><p>æœ‰æ—¶å€™æ–‡æ¡£æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œå°±å†™çš„ç´¯äº†ã€‚å°¤å…¶æ˜¯æœ€è¿‘ä½¿ç”¨äº† <code>YApi</code> ï¼Œ ä¸ªäººæ„Ÿè§‰ä½¿ç”¨ <code>Swagger</code> ç„¶åå¯¼å…¥åˆ° <code>YApi</code> é‡Œé¢è¿˜æ˜¯æŒºæ–¹ä¾¿çš„ï¼Œçœæ—¶çœåŠ›ã€‚</p><p>åæ¥å°±æƒ³ï¼Œæ—¢ç„¶ <code>YApi</code> æä¾›æ¥å£ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥è‡ªå·±ç”Ÿæˆï¼Œç„¶åä¼ åˆ° <code>YApi</code> ä¸­å‘¢ï¼Ÿ</p><p>æ‰€ä»¥å°±å¼€å§‹ç€æ‰‹è¿™ä¸ªæ’ä»¶çš„å¼€å‘ã€‚</p><h2 id="ä½¿ç”¨åŠåŠŸèƒ½"><a href="#ä½¿ç”¨åŠåŠŸèƒ½" class="headerlink" title="ä½¿ç”¨åŠåŠŸèƒ½"></a>ä½¿ç”¨åŠåŠŸèƒ½</h2><p>æ—¢ç„¶å·²ç»å¼€å‘å¥½æœ€åŸºç¡€ç‰ˆæœ¬äº†ï¼Œå½“ç„¶ä¹Ÿå¾—ä»‹ç»ä¸‹ï¼Œé¦–å…ˆçœ‹å›¾ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/B9FzFw-9M24Py.png" alt="Doc View æ ·ä¾‹"></p><p>é€šè¿‡å›¾ç®€å•ä»‹ç»ä¸‹ä½¿ç”¨ä»¥åŠåŠŸèƒ½ï¼š</p><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼Œç›´æ¥åœ¨ <code>Controller</code> ç±»æˆ–è€… <code>Controller</code> ç±»çš„å…¬å…±éé™æ€æ–¹æ³•å†…å³é”®å”¤å‡ºèœå•ï¼Œå•æœº <code>Doc View</code> å³å¯ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/Gq0gn6-XnAfto.png"></p><p>åªèƒ½åœ¨ <code>Controller</code> ç±»æˆ–è€… <code>Controller</code> ç±»çš„å…¬å…±éé™æ€æ–¹æ³•å†…ä½¿ç”¨ã€‚è‡³äºä¸¤è€…çš„åŒºåˆ«ï¼Œåç»­ä¼šä»‹ç»ã€‚</p><p>è¿™é‡Œå¯èƒ½ä¼šæœ‰å°ä¼™ä¼´ä»¬å‘å‡ºç–‘é—®ï¼šDubbo æ¥å£ä¹Ÿè¦å†™æ–‡æ¡£ï¼Œéš¾é“ä¸å¯ä»¥ä¹ˆï¼Ÿ</p><p>å—¯~ å¯ä»¥ï¼ä½†æ˜¯ç°åœ¨ä¸æ”¯æŒ~</p><h3 id="åŠŸèƒ½"><a href="#åŠŸèƒ½" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h3><p>åŸºæœ¬åŠŸèƒ½å°±æ˜¯æˆªå›¾å±•ç¤ºçš„é‚£æ ·ã€‚</p><ol><li>å·¦ä¾§æ˜¾ç¤ºæ¥å£ååŠåˆ—è¡¨ï¼Œå³ä¾§å±•ç¤ºæ¥å£ä¿¡æ¯ï¼›</li><li>ç‚¹å‡» <code>Copy æŒ‰é’®</code> å°±ä¼šå°†å±•ç¤ºçš„ä¿¡æ¯åŸæœ¬å¯¹åº”çš„ Markdown æ–‡æœ¬å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼›</li><li>åœ¨ Class å†…éƒ¨ç‚¹å‡»ï¼Œç”Ÿæˆçš„å¦‚å›¾æ‰€ç¤ºçš„åˆ—è¡¨ï¼Œè€Œåœ¨æ–¹æ³•å†…å³é”®ç”Ÿæˆçš„æ˜¯åªæœ‰æœ¬æ–¹æ³•çš„ã€‚</li></ol><h3 id="ä½¿ç”¨è¯´æ˜"><a href="#ä½¿ç”¨è¯´æ˜" class="headerlink" title="ä½¿ç”¨è¯´æ˜"></a>ä½¿ç”¨è¯´æ˜</h3><p>Dubbo æ¥å£ï¼Œå½“å‰ç‰ˆæœ¬ä¸æ”¯æŒï¼Œæ‰€ä»¥ä¸‹é¢ä»‹ç»çš„å…¨éƒ½æ˜¯åœ¨ Class ä¸Šçš„ä½¿ç”¨ï¼š</p><h4 id="è¦ç”Ÿæˆæ–‡æ¡£ï¼Œéœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼Ÿ"><a href="#è¦ç”Ÿæˆæ–‡æ¡£ï¼Œéœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼Ÿ" class="headerlink" title="è¦ç”Ÿæˆæ–‡æ¡£ï¼Œéœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼Ÿ"></a>è¦ç”Ÿæˆæ–‡æ¡£ï¼Œéœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼Ÿ</h4><ol><li>ç›®æ ‡ç±»å†…éƒ¨æœ‰æ–¹æ³•ï¼›</li><li>ç±»å¿…é¡»æœ‰ç›¸å…³ <code>Spring</code> æ³¨è§£ã€‚<ol><li><code>org.springframework.stereotype.Controller</code> </li><li><code>org.springframework.web.bind.annotation.RestController</code></li></ol></li></ol><h4 id="ç”Ÿæˆæ–‡æ¡£ï¼Œæ¥å£æ–¹æ³•éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼Ÿ"><a href="#ç”Ÿæˆæ–‡æ¡£ï¼Œæ¥å£æ–¹æ³•éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼Ÿ" class="headerlink" title="ç”Ÿæˆæ–‡æ¡£ï¼Œæ¥å£æ–¹æ³•éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼Ÿ"></a>ç”Ÿæˆæ–‡æ¡£ï¼Œæ¥å£æ–¹æ³•éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼Ÿ</h4><p>æ–‡æ¡£çš„æ–¹æ³•ï¼š<code>Public</code> ä¿®é¥°ä¸”éé™æ€æ–¹æ³•ï¼ˆ<code>static</code> ä¿®é¥°ï¼‰ï¼Œæ–¹æ³•ä¸ŠåŒ…å«ä»¥ä¸‹æ³¨è§£ï¼š</p><ol><li><code>org.springframework.web.bind.annotation.GetMapping</code></li><li><code>org.springframework.web.bind.annotation.PostMapping</code></li><li><code>org.springframework.web.bind.annotation.GetMapping</code></li><li><code>org.springframework.web.bind.annotation.DeleteMapping</code></li><li><code>org.springframework.web.bind.annotation.PatchMapping</code></li><li><code>org.springframework.web.bind.annotation.RequestMapping</code></li></ol><h4 id="æ–‡æ¡£æ¨¡ç‰ˆæ˜¯å¦å¯ä»¥è®¾ç½®ï¼Ÿ"><a href="#æ–‡æ¡£æ¨¡ç‰ˆæ˜¯å¦å¯ä»¥è®¾ç½®ï¼Ÿ" class="headerlink" title="æ–‡æ¡£æ¨¡ç‰ˆæ˜¯å¦å¯ä»¥è®¾ç½®ï¼Ÿ"></a>æ–‡æ¡£æ¨¡ç‰ˆæ˜¯å¦å¯ä»¥è®¾ç½®ï¼Ÿ</h4><p>å½“å‰ç‰ˆæœ¬æ–‡æ¡£æ¨¡ç‰ˆåªæœ‰å±•ç¤ºçš„è¿™ä¸ªï¼Œä¸æ”¯æŒè‡ªå®šä¹‰æ¨¡ç‰ˆã€‚</p><h4 id="æ¥å£åç§°æ˜¯å¦‚ä½•è®¾ç½®çš„ï¼Ÿ"><a href="#æ¥å£åç§°æ˜¯å¦‚ä½•è®¾ç½®çš„ï¼Ÿ" class="headerlink" title="æ¥å£åç§°æ˜¯å¦‚ä½•è®¾ç½®çš„ï¼Ÿ"></a>æ¥å£åç§°æ˜¯å¦‚ä½•è®¾ç½®çš„ï¼Ÿ</h4><ol><li><p>æ¥å£åç§°é»˜è®¤å–å€¼å¦‚å›¾æˆªå›¾æ‰€ç¤º <code>ç±»å#æ–¹æ³•å</code>ï¼›</p><p> <img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/7LRtm9-LzXotO.png" alt="7LRtm9-LzXotO"></p></li><li><p>æ”¯æŒåœ¨æ³¨é‡Šä¸Šä½¿ç”¨ <code>@name</code> è®¾ç½®æ¥å£åã€‚</p><p> <img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/zdw5TG-QtZFyB.png" alt="zdw5TG-QtZFyB"></p></li></ol><h4 id="æ¥å£æè¿°æ˜¯ä»å“ªé‡Œè·å–çš„ï¼Ÿ"><a href="#æ¥å£æè¿°æ˜¯ä»å“ªé‡Œè·å–çš„ï¼Ÿ" class="headerlink" title="æ¥å£æè¿°æ˜¯ä»å“ªé‡Œè·å–çš„ï¼Ÿ"></a>æ¥å£æè¿°æ˜¯ä»å“ªé‡Œè·å–çš„ï¼Ÿ</h4><ol><li><p>æ¥å£æè¿°ç›´æ¥å–çš„æ–¹æ³•æ³¨é‡Šï¼›</p></li><li><p>å¦‚æœæœ‰ <code>@description</code> æ ‡ç­¾ï¼Œåˆ™ä¼šä¼˜å…ˆä½¿ç”¨æ ‡ç­¾å¯¹åº”çš„æè¿°ã€‚</p><p> <img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/pcZB5V-Tn33bX.png" alt="pcZB5V-Tn33bX"></p></li></ol><h4 id="è¯·æ±‚è·¯å¾„æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ"><a href="#è¯·æ±‚è·¯å¾„æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ" class="headerlink" title="è¯·æ±‚è·¯å¾„æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ"></a>è¯·æ±‚è·¯å¾„æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ</h4><p>å– <code>Class</code> å’Œ  <code>Method</code> ä¸Šçš„ path è¿›è¡Œæ‹¼è£…ç»„æˆã€‚</p><h4 id="è¯·æ±‚æ–¹å¼å¦‚ä½•è®¾ç½®ï¼Ÿ"><a href="#è¯·æ±‚æ–¹å¼å¦‚ä½•è®¾ç½®ï¼Ÿ" class="headerlink" title="è¯·æ±‚æ–¹å¼å¦‚ä½•è®¾ç½®ï¼Ÿ"></a>è¯·æ±‚æ–¹å¼å¦‚ä½•è®¾ç½®ï¼Ÿ</h4><p>æ ¹æ® <code>Method</code> ä¸Šçš„æ³¨è§£ç”Ÿæˆã€‚</p><h4 id="è¯·æ±‚å‚æ•°åŠè¯·æ±‚ç¤ºä¾‹çš„éœ€è¦è®¾ç½®ä»€ä¹ˆï¼Ÿ"><a href="#è¯·æ±‚å‚æ•°åŠè¯·æ±‚ç¤ºä¾‹çš„éœ€è¦è®¾ç½®ä»€ä¹ˆï¼Ÿ" class="headerlink" title="è¯·æ±‚å‚æ•°åŠè¯·æ±‚ç¤ºä¾‹çš„éœ€è¦è®¾ç½®ä»€ä¹ˆï¼Ÿ"></a>è¯·æ±‚å‚æ•°åŠè¯·æ±‚ç¤ºä¾‹çš„éœ€è¦è®¾ç½®ä»€ä¹ˆï¼Ÿ</h4><ol><li><p>æ ¹æ®æ˜¯å¦æœ‰ <code>@RequestBody</code> æ³¨è§£ï¼Œç”Ÿæˆè¯·æ±‚ Header æ˜¯å¦ä¸º json è¿˜æ˜¯ formã€‚åŒæ—¶ä¼šæ£€æµ‹è¯·æ±‚å‚æ•°ä¸­æ˜¯å¦æœ‰ <code>@RequestHeader</code> æ³¨è§£ï¼›</p><p> <img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/pQHnXo-C4oPfT.png" alt="Header"></p></li><li><p>å¯¹è±¡ç”Ÿæˆåˆ—è¡¨ï¼›</p></li><li><p>æ ¹æ®è¯·æ±‚æ˜¯ json è¿˜æ˜¯ form ç”Ÿæˆå¯¹åº”çš„è¯·æ±‚ç¤ºä¾‹ã€‚</p></li></ol><h4 id="è¿”å›å‚æ•°åŠè¿”å›ç¤ºä¾‹æ€ä¹ˆç”Ÿæˆï¼Ÿ"><a href="#è¿”å›å‚æ•°åŠè¿”å›ç¤ºä¾‹æ€ä¹ˆç”Ÿæˆï¼Ÿ" class="headerlink" title="è¿”å›å‚æ•°åŠè¿”å›ç¤ºä¾‹æ€ä¹ˆç”Ÿæˆï¼Ÿ"></a>è¿”å›å‚æ•°åŠè¿”å›ç¤ºä¾‹æ€ä¹ˆç”Ÿæˆï¼Ÿ</h4><p>æ”¯æŒå¯¹è±¡ï¼Œè¿”å›ç©ºï¼Œè¿”å›å¸¦æ³›å‹æ–¹å¼ã€‚è¿™é‡Œçš„æ³›å‹ä»…æ”¯æŒå•ä¸ªæ³›å‹ä¸”åç§°ä¸º <code>T</code>ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/9ML932-RbqIqV.png" alt="è¿”å›å¸¦æ³›å‹"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h3><p><strong>Q: <code>Doc View</code> æ’ä»¶å»å“ªé‡Œä¸‹è½½ï¼Ÿ</strong></p><p><strong>A:</strong> </p><ol><li>å¯ä»¥ç›´æ¥é€šè¿‡ IDEA æ’ä»¶ä»“åº“ï¼Œç›´æ¥æœç´¢åç§°å³å¯ï¼›</li><li>åœ¨ GitHub é€šè¿‡ Releases ä¸‹è½½ï¼›</li><li>å…³æ³¨å…¬ä¼—å·å¹¶å‘é€ <code>Doc View</code> ç›¸å…³å…³é”®å­—ï¼ˆdoc/doc viewï¼‰è·å–ã€‚</li></ol><p><strong>Q: <code>Doc View</code> æ˜¯å¦å¼€æºï¼Ÿ</strong></p><p><strong>A:</strong> æ˜¯çš„ã€‚å¼€æºåœ°å€ä¸ºï¼š<a href="https://github.com/liuzhihang/doc-view">https://github.com/liuzhihang/doc-view</a>ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´ï¼Œå¯ä»¥ç»™ä¸ª Star ï¼Œå¦‚æœæƒ³å¢åŠ ä¸€äº›åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥æ PRã€‚</p><h3 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h3><p>æ’ä»¶å¼€å‘ä»æœ€å¼€å§‹å¼€å‘åˆ°ä»Šå¤©å‘å¸ƒç¬¬ä¸€ç‰ˆï¼Œä¸­é—´ç»å†äº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œæ¯•ç«Ÿåªæ˜¯ä¸šä½™æ—¶é—´å¼€å‘ï¼Œå°±æ–­æ–­ç»­ç»­çš„å†™ï¼Œä¸è¿‡ç°åœ¨æœ€ç®€å•ç‰ˆæœ¬å·²ç»å¯ä»¥ä½¿ç”¨äº†ã€‚</p><p>ç›®å‰æ¥çœ‹ï¼Œåªæœ‰ä¸€ä¸ª <code>Copy</code> åŠŸèƒ½ï¼Œä¸è¿‡åŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³ä½¿ç”¨ã€‚è‡³äºå…¶ä»–çš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼šè‡ªå®šä¹‰æ¨¡ç‰ˆã€æ”¯æŒ Dubbo æ¥å£ã€é¢„è§ˆå¯¼å‡ºç­‰åŠŸèƒ½å°±éœ€è¦åç»­ä¸æ–­è¿­ä»£äº†ã€‚</p><p>ä¸ªäººå¼€å‘ç²¾åŠ›æœ‰é™ï¼Œå°ä¼™ä¼´åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°è‚¯å®šä¼šé‡åˆ° bugï¼Œæˆ–è€…æ˜¯æœ‰å…¶ä»–çš„åŠŸèƒ½åŠä½¿ç”¨å»ºè®®ï¼Œéƒ½å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åé¦ˆï¼š</p><ol><li>å…³æ³¨å…¬ä¼—å·ï¼šã€ åˆ˜å¿—èˆª ã€ é€šè¿‡è¯»è€…è®¨è®ºè¿›è¡Œç•™è¨€ï¼›</li><li>åœ¨ GitHub ä¸Šæ Issuesï¼›</li><li>åœ¨æ’ä»¶å¸®åŠ©é¡µé¢ç•™è¨€ï¼›</li><li>æ–‡ç« ç»“å°¾ç•™è¨€ï¼›</li></ol><p>æœ€åï¼Œæ„Ÿè°¢å°ä¼™ä¼´ä»¬çš„æ”¯æŒã€‚æ¬¢è¿ä¸‹è½½ä½“éªŒï¼Œå¹¶æå‡ºç›¸å…³å»ºè®®åŠæ„è§ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å·¥å…·å†Œ </category>
          
          <category> Doc View </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥å…·å†Œ </tag>
            
            <tag> Doc View </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- å†™æ—¶å¤åˆ¶é›†åˆ â€”â€” CopyOnWriteArrayList</title>
      <link href="2020/10/31/copyonwritearraylist.html"/>
      <url>2020/10/31/copyonwritearraylist.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>JUC ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªç³»åˆ—çš„ç±»ï¼Œéƒ½æ˜¯ CopyOnWriteXXX ï¼Œæ„æ€æ˜¯å†™æ—¶å¤åˆ¶ï¼Œè¿™ä¸ªç©¶ç«Ÿæ˜¯æ€ä¹ˆå›äº‹ï¼Ÿé‚£å°±ä»¥ CopyOnWriteArrayList ä¸ºåˆ‡å…¥ç‚¹ï¼Œä¸€èµ·äº†è§£å†™æ—¶å¤åˆ¶æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>ArrayList çš„ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å˜ä½“ï¼Œå…¶ä¸­æ‰€æœ‰å¯å˜æ“ä½œï¼ˆaddã€set ç­‰ç­‰ï¼‰éƒ½æ˜¯é€šè¿‡å¯¹åº•å±‚æ•°ç»„è¿›è¡Œä¸€æ¬¡æ–°çš„å¤åˆ¶æ¥å®ç°çš„ã€‚</p><p>åƒåå­—ä¸€æ ·ï¼Œæ¯æ¬¡è¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œéƒ½ä¼šè¿›è¡Œä¸€æ¬¡å¤åˆ¶ï¼Œå½“ç„¶ä¼šæœ‰å¾ˆå¤§çš„æ€§èƒ½æ¶ˆè€—ï¼Œä½†æ˜¯åœ¨æŸäº›ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œåˆä¼šæé«˜æ€§èƒ½ã€‚å…·ä½“æ˜¯æ€ä¹ˆæ“ä½œçš„ï¼Œé‚£å°±ä¸€æ­¥ä¸€æ­¥é˜…è¯»æºç ï¼Œç„¶åå†åšæ€»ç»“å½’çº³ã€‚</p><h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CopyOnWriteArrayListTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        CopyOnWriteArrayList&lt;String&gt; list = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ·»åŠ å…ƒç´ </span></span><br><span class="line">        list.add(<span class="string">&quot;liuzhihang&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç§»é™¤å…ƒç´ </span></span><br><span class="line">        list.remove(<span class="string">&quot;liuzhihang&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŸ¥çœ‹å…ƒç´ </span></span><br><span class="line">        String value0 = list.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éå†</span></span><br><span class="line">        Iterator&lt;String&gt; iterator = list.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            String next = iterator.next();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜ç–‘é—®"><a href="#é—®é¢˜ç–‘é—®" class="headerlink" title="é—®é¢˜ç–‘é—®"></a>é—®é¢˜ç–‘é—®</h4><ol><li>ä¸ºä»€ä¹ˆè¦å«å†™æ—¶å¤åˆ¶é›†åˆï¼Ÿ</li><li>CopyOnWriteArrayList å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>CopyOnWriteArrayList å’Œ ArrayList æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>CopyOnWriteArrayList å¤åˆ¶æ˜¯æ€ä¹ˆè¿›è¡Œå¤åˆ¶çš„ï¼Ÿ</li></ol><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/PRT4mY-DDwfkF.png" alt="PRT4mY-DDwfkF"></p><h4 id="å‚æ•°ä»‹ç»"><a href="#å‚æ•°ä»‹ç»" class="headerlink" title="å‚æ•°ä»‹ç»"></a>å‚æ•°ä»‹ç»</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CopyOnWriteArrayList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">RandomAccess</span>, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">8673264195747942595L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æ•°æ®æœ‰å˜åŠ¨æ—¶ä½¿ç”¨ */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">transient</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æ•°ç»„ åªèƒ½é€šè¿‡ getArray/setArray è®¿é—® */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Object[] array;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Object[] getArray() &#123;</span><br><span class="line">        <span class="keyword">return</span> array;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†æ•°ç»„æŒ‡å‘ä¼ å…¥çš„æ–°æ•°ç»„</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setArray</span><span class="params">(Object[] a)</span> </span>&#123;</span><br><span class="line">        array = a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡å‚æ•°å¯ä»¥äº†è§£åˆ°ä»¥ä¸‹å†…å®¹ï¼š</p><ol><li>åŸºäºæ•°ç»„å®ç°ï¼›</li><li>ä½¿ç”¨äº† ReentrantLock äº’æ–¥é”ã€‚</li></ol><h4 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setArray(<span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆå§‹åŒ– CopyOnWriteArrayList æ—¶ï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª Object çš„æ•°ç»„ã€‚</p><h4 id="add"><a href="#add" class="headerlink" title="add"></a>add</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰æ•°ç»„</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="keyword">int</span> len = elements.length;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œå¹¶å°†åŸæ•°ç»„æ•°æ®å¤åˆ¶åˆ°æ–°æ•°ç»„</span></span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// æ·»åŠ çš„æ–°å…ƒç´ åˆ°æ•°ç»„å°¾éƒ¨</span></span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        <span class="comment">// å°†æ•°ç»„æŒ‡å‘æ–°æ•°ç»„</span></span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>add æ–¹æ³•é€»è¾‘å¾ˆç®€å•ï¼š</p><ol><li>é€šè¿‡åŠ äº’æ–¥é”ï¼ˆReentrantLockï¼‰ä»è€Œä¿è¯åœ¨å†™çš„æ—¶å€™åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å†™ã€‚</li><li>æ–°å¢å…ƒç´ æ—¶ï¼Œå…ˆä½¿ç”¨ <code>Arrays.copyOf(elements, len + 1)</code> å¤åˆ¶å‡ºä¸€ä¸ªé•¿åº¦ +1 çš„æ–°æ•°ç»„ã€‚</li><li>æ·»åŠ å…ƒç´ åˆ°æ–°æ•°ç»„ã€‚</li><li>ç„¶åå†å°†åŸæ•°ç»„å¯¹è±¡æŒ‡å‘æ–°æ•°ç»„ã€‚</li></ol><p>ç”»å›¾å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/KCTNMP-kLOtFP.png" alt="KCTNMP-kLOtFP"></p><h4 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åŸæ•°ç»„</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="keyword">int</span> len = elements.length;</span><br><span class="line">        <span class="comment">// ç§»é™¤çš„å€¼</span></span><br><span class="line">        E oldValue = get(elements, index);</span><br><span class="line">        <span class="keyword">int</span> numMoved = len - index - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (numMoved == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// å¦‚æœç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">            <span class="comment">// ç›´æ¥å¤åˆ¶å‰é¢çš„å…ƒç´ å³å¯</span></span><br><span class="line">            setArray(Arrays.copyOf(elements, len - <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ç§»é™¤ä¸­é—´çš„å…ƒç´ ï¼Œè¿›è¡Œä¸¤æ¬¡å¤åˆ¶</span></span><br><span class="line">            Object[] newElements = <span class="keyword">new</span> Object[len - <span class="number">1</span>];</span><br><span class="line">            System.arraycopy(elements, <span class="number">0</span>, newElements, <span class="number">0</span>, index);</span><br><span class="line">            System.arraycopy(elements, index + <span class="number">1</span>, newElements, index,</span><br><span class="line">                                numMoved);</span><br><span class="line">            setArray(newElements);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>remove æ–¹æ³•ç›¸å¯¹å¤šäº†ä¸€äº›åˆ¤æ–­ï¼š</p><ol><li>é€šè¿‡åŠ äº’æ–¥é”ï¼ˆReentrantLockï¼‰ä»è€Œä¿è¯åœ¨å†™çš„æ—¶å€™åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç§»é™¤å…ƒç´ ã€‚</li><li>å¦‚æœç§»é™¤çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåˆ™ç›´æ¥å¤åˆ¶å‰é¢çš„å…ƒç´ åˆ°æ–°æ•°ç»„ï¼Œå¹¶æŒ‡å‘æ–°æ•°ç»„å³å¯ã€‚</li><li>å¦‚æœç§»é™¤çš„æ˜¯ä¸­é—´çš„å…ƒç´ ï¼Œåˆ™éœ€è¦è¿›è¡Œä¸¤æ¬¡å¤åˆ¶ï¼Œç„¶åæŒ‡å‘æ–°æ•°ç»„ã€‚</li></ol><p>ç”»å›¾å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/q3iE0c-AGgXfP.png" alt="q3iE0c-AGgXfP"></p><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> get(getArray(), index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>get æ–¹æ³•å¯ä»¥çœ‹å‡ºï¼š</p><ol><li>è·å–å…ƒç´ å¹¶æ²¡æœ‰è¿›è¡ŒåŠ é”ã€‚</li><li>ä»åŸæ•°ç»„è·å–çš„å…ƒç´ ã€‚</li></ol><p>æ‰€ä»¥å¹¶å‘æƒ…å†µä¸‹ï¼Œå¹¶ä¸èƒ½ä¿è¯å¾ˆåŠæ—¶çš„è¯»å–çš„åˆšæ’å…¥æˆ–è€…ç§»é™¤çš„å…ƒç´ ã€‚</p><h4 id="æ•°ç»„å¤åˆ¶"><a href="#æ•°ç»„å¤åˆ¶" class="headerlink" title="æ•°ç»„å¤åˆ¶"></a>æ•°ç»„å¤åˆ¶</h4><p>é€šè¿‡é˜…è¯» add å’Œ remove ç›¸å…³ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åœ¨æ•°ç»„å¤åˆ¶æ—¶ä½¿ç”¨äº† <code>Arrays.copyOf</code> å’Œ <code>System.arraycopy</code>ï¼Œè¿™ç›¸å½“äºä¸€ä¸ªä¼˜åŒ–æ–¹é¢å§ã€‚</p><p>æ¯•ç«Ÿæ•°ç»„å¤åˆ¶æ€»ä¸èƒ½æŠŠåŸæ•°ç»„éå†ä¸€éï¼ŒæŒ¨ç€èµ‹å€¼åˆ°æ–°æ•°ç»„é‡Œé¢å§ã€‚</p><p>é‚£æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Arrays</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…¶ä»–æ–¹æ³•çœç•¥ ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * original è¦å¤åˆ¶çš„æ•°ç»„</span></span><br><span class="line"><span class="comment">     * newLength æ–°æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T[] copyOf(T[] original, <span class="keyword">int</span> newLength) &#123;</span><br><span class="line">        <span class="keyword">return</span> (T[]) copyOf(original, newLength, original.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * original è¦å¤åˆ¶çš„æ•°ç»„</span></span><br><span class="line"><span class="comment">     * newLength æ–°æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T,U&gt; T[] copyOf(U[] original, <span class="keyword">int</span> newLength, Class&lt;? extends T[]&gt; newType) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œé•¿åº¦æ˜¯æŒ‡å®šçš„é•¿åº¦</span></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        T[] copy = ((Object)newType == (Object)Object[].class)</span><br><span class="line">            ? (T[]) <span class="keyword">new</span> Object[newLength]</span><br><span class="line">            <span class="comment">// åˆ›å»ºå…·æœ‰æŒ‡å®šçš„ç»„ä»¶ç±»å‹å’Œé•¿åº¦çš„æ–°æ•°ç»„</span></span><br><span class="line">            : (T[]) Array.newInstance(newType.getComponentType(), newLength);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è°ƒç”¨ System.arraycopy å¤åˆ¶æ•°ç»„</span></span><br><span class="line">        System.arraycopy(original, <span class="number">0</span>, copy, <span class="number">0</span>,</span><br><span class="line">                         Math.min(original.length, newLength));</span><br><span class="line">        <span class="keyword">return</span> copy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡é˜…è¯» <code>Arrays.copyOf</code> ç›¸å…³æºç ï¼Œå‘ç°å…¶å® <code>Arrays.copyOf</code> åº•å±‚ä¹Ÿæ˜¯è°ƒç”¨çš„ <code>System.arraycopy</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">System</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¶ä»–æ–¹æ³•çœç•¥ ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * src æºæ•°ç»„</span></span><br><span class="line"><span class="comment">     * srcPos æºæ•°ç»„èµ·å§‹ä½ç½®</span></span><br><span class="line"><span class="comment">     * dest ç›®æ ‡æ•°ç»„</span></span><br><span class="line"><span class="comment">     * destPos ç›®æ ‡æ•°ç»„çš„èµ·å§‹ä½ç½®</span></span><br><span class="line"><span class="comment">     * length è¦å¤åˆ¶çš„å…ƒç´ æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">arraycopy</span><span class="params">(Object src,  <span class="keyword">int</span>  srcPos,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Object dest, <span class="keyword">int</span> destPos,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">int</span> length)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>System.arraycopy</code> æ˜¯ä¸€ä¸ª <code>native</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯ JVM å†…éƒ¨å®ç°çš„ï¼Œå…·ä½“å¯ä»¥é˜…è¯»ç›¸å…³èµ„æ–™ã€‚è€Œä½¿ç”¨è¿™ç§æ–¹å¼è¦æ¯” <code>for</code> å¾ªç¯å’Œ <code>clone</code> è¦é«˜æ•ˆå¾ˆå¤šã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p><strong>Q: ä¸ºä»€ä¹ˆè¦å«å†™æ—¶å¤åˆ¶é›†åˆï¼Ÿ</strong></p><p><strong>A:</strong> å› ä¸ºåœ¨ addã€remove æ“ä½œæ—¶ä¼šå¤åˆ¶å‡ºæ¥ä¸€ä¸ªæ–°æ•°ç»„ã€‚</p><p><strong>Q: CopyOnWriteArrayList å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p><strong>A:</strong> åœ¨ addã€remove æ“ä½œæ—¶ä¼šè¿›è¡ŒåŠ é”ï¼Œç„¶åå¤åˆ¶å‡ºæ¥ä¸€ä¸ªæ–°æ•°ç»„ï¼Œæ“ä½œçš„éƒ½æ˜¯æ–°æ•°ç»„ï¼Œè€Œæ­¤æ—¶åŸæ•°ç»„æ˜¯å¯ä»¥æä¾›æŸ¥è¯¢çš„ã€‚å½“æ“ä½œç»“æŸä¹‹åï¼Œä¼šå°†å¯¹è±¡æŒ‡é’ˆæŒ‡å‘æ–°æ•°ç»„ã€‚</p><p><strong>Q: CopyOnWriteArrayList å’Œ ArrayList æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p><p><strong>A:</strong> CopyOnWriteArrayList åœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹å¯ä»¥æé«˜æ•ˆç‡ï¼Œè€Œ ArrayList åªæ˜¯æ™®é€šæ•°ç»„é›†åˆï¼Œå¹¶ä¸é€‚ç”¨äºå¹¶å‘åœºæ™¯ï¼Œè€Œå¦‚æœå¯¹ ArrayList åŠ é”ï¼Œåˆ™ä¼šå½±å“ä¸€éƒ¨åˆ†æ€§èƒ½ã€‚</p><p>åŒæ ·å¯¹ CopyOnWriteArrayList è€Œè¨€ï¼Œä»…èƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚å› ä¸ºåˆšå†™å…¥çš„æ•°æ®ï¼Œæ˜¯å†™åˆ°çš„å¤åˆ¶çš„æ•°ç»„ä¸­ï¼Œæ­¤æ—¶å¹¶ä¸èƒ½ç«‹å³æŸ¥è¯¢åˆ°ã€‚å¦‚æœè¦ä¿è¯å®æ—¶æ€§å¯ä»¥å°è¯•ä½¿ç”¨ <code>Collections.synchronizedList</code> æˆ–è€…åŠ é”ç­‰æ–¹å¼ã€‚</p><p><strong>Q: CopyOnWriteArrayList å¤åˆ¶æ˜¯æ€ä¹ˆè¿›è¡Œå¤åˆ¶çš„ï¼Ÿ</strong></p><p><strong>A:</strong> å†…éƒ¨ä½¿ç”¨çš„æ˜¯æœ¬åœ°æ–¹æ³• <code>System.arraycopy</code> è¿›è¡Œæ•°ç»„çš„å¤åˆ¶ã€‚</p><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>é€šè¿‡é˜…è¯» CopyOnWriteArrayList æºç ï¼Œäº†è§£åˆ°å†™æ—¶å¤åˆ¶æ˜¯çš„åŸç†ã€‚åŒæ—¶äº†è§£åˆ°å¯ä»¥ä½¿ç”¨ <code>System.arraycopy</code> çš„æ–¹å¼æé«˜æ•°ç»„å¤åˆ¶çš„æ•ˆç‡ã€‚</p><p>åŒæ · CopyOnWriteArrayList é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œæ»¡è¶³æœ€ç»ˆä¸€è‡´æ€§ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯æ•°æ®ä¿®æ”¹åŠæ—¶æŸ¥è¯¢åˆ°ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- éé˜»å¡çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ— â€”â€” ConcurrentLinkedQueue</title>
      <link href="2020/10/25/source-code-concurrentlinkedqueue.html"/>
      <url>2020/10/25/source-code-concurrentlinkedqueue.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>JUC ä¸‹é¢çš„ç›¸å…³æºç ç»§ç»­å¾€ä¸‹é˜…è¯»ï¼Œè¿™å°±çœ‹åˆ°äº†éé˜»å¡çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ— â€”â€” ConcurrentLinkedQueueï¼Œæ¥ä¸€èµ·çœ‹çœ‹å§ã€‚</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>åŸºäºé“¾æ¥èŠ‚ç‚¹çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œå¯¹å…ƒç´ FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰è¿›è¡Œæ’åºã€‚ é˜Ÿåˆ—çš„å¤´éƒ¨æ˜¯é˜Ÿåˆ—ä¸­æœ€é•¿æ—¶é—´çš„å…ƒç´ ï¼Œé˜Ÿåˆ—çš„å°¾éƒ¨æ˜¯é˜Ÿåˆ—ä¸­æœ€çŸ­æ—¶é—´çš„å…ƒç´ ã€‚ åœ¨é˜Ÿåˆ—çš„å°¾éƒ¨æ’å…¥æ–°å…ƒç´ ï¼Œé˜Ÿåˆ—æ£€ç´¢æ“ä½œè·å–é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ã€‚</p><p>å½“è®¸å¤šçº¿ç¨‹å…±äº«å¯¹å…¬å…±é›†åˆçš„è®¿é—® ConcurrentLinkedQueue æ˜¯ä¸€ä¸ªåˆé€‚çš„é€‰æ‹©ã€‚ ä¸å¤§å¤šæ•°å…¶ä»–å¹¶å‘é›†åˆå®ç°ä¸€æ ·ï¼Œæ­¤ç±»ä¸å…è®¸ä½¿ç”¨nullå…ƒç´ ã€‚</p><h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentLinkedQueueTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ConcurrentLinkedQueue&lt;String&gt; queue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†æŒ‡å®šå…ƒç´ æ’å…¥æ­¤é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚</span></span><br><span class="line">        queue.add(<span class="string">&quot;liuzhihang&quot;</span>);</span><br><span class="line">        <span class="comment">// å°†æŒ‡å®šå…ƒç´ æ’å…¥æ­¤é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚</span></span><br><span class="line">        queue.offer(<span class="string">&quot;liuzhihang&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–ä½†ä¸ç§»é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œé˜Ÿåˆ—ä¸ºç©ºè¿”å› nullã€‚</span></span><br><span class="line">        queue.peek();</span><br><span class="line">        <span class="comment">// è·å–å¹¶ç§»é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œæ­¤é˜Ÿåˆ—ä¸ºç©ºè¿”å› nullã€‚</span></span><br><span class="line">        queue.poll();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/LNKjGH-iwlqrt.png" alt="LNKjGH-iwlqrt"></p><h4 id="å‚æ•°ä»‹ç»"><a href="#å‚æ•°ä»‹ç»" class="headerlink" title="å‚æ•°ä»‹ç»"></a>å‚æ•°ä»‹ç»</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹ä¸­çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">volatile</span> E item;</span><br><span class="line">    <span class="comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node&lt;E&gt; next;</span><br><span class="line"></span><br><span class="line">    Node(E item) &#123;</span><br><span class="line">        UNSAFE.putObject(<span class="keyword">this</span>, itemOffset, item);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// CAS çš„æ–¹å¼è®¾ç½®èŠ‚ç‚¹å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">casItem</span><span class="params">(E cmp, E val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, itemOffset, cmp, val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lazySetNext</span><span class="params">(Node&lt;E&gt; val)</span> </span>&#123;</span><br><span class="line">        UNSAFE.putOrderedObject(<span class="keyword">this</span>, nextOffset, val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CAS çš„æ–¹å¼è®¾ç½®ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">casNext</span><span class="params">(Node&lt;E&gt; cmp, Node&lt;E&gt; val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, nextOffset, cmp, val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çœç•¥ â€¦â€¦</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ ConcurrentLinkedQueue å†…éƒ¨å«æœ‰ä¸€ä¸ªå†…éƒ¨ç±» Nodeï¼Œå¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™ä¸ªå†…éƒ¨ç±»ç”¨æ¥æ ‡è¯†é“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåœ¨ ConcurrentLinkedQueue ä¸­çš„é“¾è¡¨ä¸º<code>å•å‘é“¾è¡¨</code>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentLinkedQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Queue</span>&lt;<span class="title">E</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// å…¶ä»–çœç•¥</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤´ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; head;      </span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; tail;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤´å°¾èŠ‚ç‚¹ä½¿ç”¨ <code>volatile</code> ä¿®é¥°ï¼Œä¿è¯å†…å­˜å¯è§æ€§ã€‚</p><h4 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentLinkedQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    head = tail = <span class="keyword">new</span> Node&lt;E&gt;(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¤´å°¾èŠ‚ç‚¹éƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªç©ºèŠ‚ç‚¹ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ZzpJTa-lOE9g4.png" alt="ZzpJTa-lOE9g4"></p><h4 id="æ·»åŠ å…ƒç´ "><a href="#æ·»åŠ å…ƒç´ " class="headerlink" title="æ·»åŠ å…ƒç´ "></a>æ·»åŠ å…ƒç´ </h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> offer(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éªŒè¯æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    checkNotNull(e);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;E&gt;(e);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯å…¥é˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">// t æ˜¯å½“å‰å°¾èŠ‚ç‚¹ï¼Œp åˆå§‹ä¸º t</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;E&gt; t = tail, p = t;;) &#123;</span><br><span class="line">        <span class="comment">// q ä¸ºå°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        Node&lt;E&gt; q = p.next;</span><br><span class="line">        <span class="keyword">if</span> (q == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸ºç©ºï¼Œè¯´æ˜åé¢æ²¡æœ‰èŠ‚ç‚¹ï¼Œåˆ™ CAS è®¾ç½®å°¾èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (p.casNext(<span class="keyword">null</span>, newNode)) &#123;</span><br><span class="line">                <span class="comment">// æ­¤æ—¶ p.next æ˜¯ newNode</span></span><br><span class="line">                <span class="comment">// å¦‚æœ p ï¼= t è¯´æ˜æœ‰å¹¶å‘</span></span><br><span class="line">                <span class="keyword">if</span> (p != t) </span><br><span class="line">                    <span class="comment">// å…¶ä»–çº¿ç¨‹å·²ç»æ›´æ–°äº† tail</span></span><br><span class="line">                    <span class="comment">// q = p.next æ‰€ä»¥ q == null ä¸æ­£ç¡®äº†</span></span><br><span class="line">                    <span class="comment">// q å–åˆ°äº† t.next</span></span><br><span class="line">                    <span class="comment">// æ­¤æ—¶å°† tail æ›´æ–°ä¸º æ–°èŠ‚ç‚¹</span></span><br><span class="line">                    casTail(t, newNode);  <span class="comment">// Failure is OK.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Lost CAS race to another thread; re-read next</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œ poll ï¼Œæ“ä½œç§»é™¤å…ƒç´ ï¼Œå¯èƒ½ä¼šå¯¼è‡´ p == q </span></span><br><span class="line">        <span class="comment">// æ­¤æ—¶è¦é‡æ–°æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">            <span class="comment">// </span></span><br><span class="line">            p = (t != (t = tail)) ? t : head;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// æ£€æŸ¥ tail å¹¶æ›´æ–°</span></span><br><span class="line">            p = (p != t &amp;&amp; t != (t = tail)) ? t : q;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”»å›¾è¯´æ˜ï¼š</p><ul><li>å•çº¿ç¨‹æƒ…å†µä¸‹ï¼š</li></ul><ol><li>å½“æ‰§è¡Œåˆ° <code>Node&lt;E&gt; q = p.next;</code> æ—¶ï¼Œå½“å‰æƒ…å†µå¦‚å›¾æ‰€ç¤ºï¼š</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/QJ5fjB-QtmN7F.png" alt="QJ5fjB-QtmN7F"></p><ol start="2"><li>åˆ¤æ–­ <code>q == null</code>ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œæ­¤æ—¶ä¾¿ä¼šæ‰§è¡Œ <code>p.casNext(null, newNode)</code> ä½¿ç”¨ CAS è®¾ç½® p.nextã€‚</li><li>è®¾ç½®æˆåŠŸä¹‹åï¼Œ<code>p == t</code> æ²¡æœ‰å˜åŠ¨ï¼Œæ‰€ä»¥ç¨‹åºé€€å‡ºã€‚</li></ol><ul><li>å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼š</li></ul><ol><li>å½“æ‰§è¡Œåˆ° <code>Node&lt;E&gt; q = p.next;</code> æ—¶ï¼Œå½“å‰æƒ…å†µå¦‚å›¾æ‰€ç¤ºï¼š</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/QJ5fjB-QtmN7F.png" alt="QJ5fjB-QtmN7F"></p><ol start="2"><li>å¤šä¸ªçº¿ç¨‹æ‰§è¡Œ <code>p.casNext(null, newNode)</code> ä½¿ç”¨ CAS è®¾ç½® p.nextã€‚</li><li>A çº¿ç¨‹ CAS è®¾ç½®æˆåŠŸï¼š</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/u4O6mX-yQeaI6.png" alt="u4O6mX-yQeaI6"></p><ol start="4"><li>B çº¿ç¨‹ CAS æ‰§è¡Œå¤±è´¥ï¼Œ é‡æ–°å¾ªç¯ï¼Œä¼šæ‰§è¡Œåˆ° <code>p = (p != t &amp;&amp; t != (t = tail)) ? t : q</code>ã€‚</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/vkP5tp-jaUZOc.png" alt="vkP5tp-jaUZOc"></p><ol start="5"><li>å†æ¬¡å¾ªç¯å°±å¯ä»¥æˆåŠŸè®¾ç½®ä¸Šäº†ã€‚</li></ol><h4 id="è·å–å…ƒç´ "><a href="#è·å–å…ƒç´ " class="headerlink" title="è·å–å…ƒç´ "></a>è·å–å…ƒç´ </h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    restartFromHead:</span><br><span class="line">    <span class="comment">// æ— é™å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; h = head, p = h, q;;) &#123;</span><br><span class="line">            <span class="comment">// å¤´ç»“ç‚¹çš„ iterm</span></span><br><span class="line">            E item = p.item;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹å¦‚æœä¸ä¸º null CAS è®¾ç½®ä¸º null</span></span><br><span class="line">            <span class="keyword">if</span> (item != <span class="keyword">null</span> &amp;&amp; p.casItem(item, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="comment">// CAS æˆåŠŸ åˆ™æ ‡è®°ç§»é™¤</span></span><br><span class="line">                <span class="keyword">if</span> (p != h) <span class="comment">// hop two nodes at a time</span></span><br><span class="line">                    updateHead(h, ((q = p.next) != <span class="keyword">null</span>) ? q : p);</span><br><span class="line">                <span class="keyword">return</span> item;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å½“å‰é˜Ÿåˆ—æœªç©º è¿”å› null</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((q = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                updateHead(h, p);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è‡ªå¼•ç”¨äº†ï¼Œ é‡æ–°è¿›è¡Œå¾ªç¯</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">                <span class="keyword">continue</span> restartFromHead;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p = q;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”»å›¾è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>åœ¨æ‰§è¡Œå†…å±‚å¾ªç¯æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼š<code>E item = p.item;</code> æ­¤æ—¶ï¼Œiterm ä¸º nullï¼Œä¼š <code>updateHead(h, p)</code> å¹¶è¿”å› nullã€‚</li><li>å‡è®¾åŒæ—¶æœ‰å¹¶å‘æ’å…¥æ“ä½œï¼Œæ·»åŠ äº†ä¸€ä¸ªå…ƒç´ ï¼Œæ­¤æ—¶å¦‚å›¾æ‰€ç¤ºï¼š</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/zGeE4p-Udb3x0.png" alt="zGeE4p-Udb3x0"></p><p>è¿™æ—¶ä¼šæ‰§è¡Œæœ€åçš„ else å°† <code>p = q</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/KkcsgS-8RvW4W.png" alt="KkcsgS-8RvW4W"></p><ol start="3"><li>ç»§ç»­å¾ªç¯è·å– itemï¼Œå¹¶æ‰§è¡Œ <code>p.casItem(item, null)</code> ï¼Œ ç„¶ååˆ¤æ–­ <code>p != h</code>ï¼Œæ›´æ–° head å¹¶è¿”å› itemã€‚</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/mBNd6o-RS2hU0.png" alt="mBNd6o-RS2hU0"></p><p>è¿™é‡Œçš„æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œåªæ˜¯åˆ—ä¸¾ä¸€ç§ï¼Œå¦‚æœéœ€è¦å¯ä»¥è‡ªå·±å¤šåˆ—ä¸¾å‡ ç§ã€‚</p><p>è€ŒæŸ¥çœ‹å…ƒç´ çš„ä»£ç å’Œè·å–å…ƒç´ ä»£ç ç±»ä¼¼å°±ä¸å¤šä»‹ç»äº†ã€‚</p><h4 id="size-æ“ä½œ"><a href="#size-æ“ä½œ" class="headerlink" title="size æ“ä½œ"></a>size æ“ä½œ</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;E&gt; p = first(); p != <span class="keyword">null</span>; p = succ(p))</span><br><span class="line">        <span class="keyword">if</span> (p.item != <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">// Collection.size() spec says to max out</span></span><br><span class="line">            <span class="keyword">if</span> (++count == Integer.MAX_VALUE)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CAS æ²¡æœ‰åŠ é”ï¼Œæ‰€ä»¥ size æ˜¯ä¸å‡†ç¡®çš„ã€‚å¹¶ä¸” size ä¼šéå†ä¸€éåˆ—è¡¨ï¼Œæ¯”è¾ƒè€—è´¹æ€§èƒ½ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ConcurrentLinkedQueue åœ¨å·¥ä½œä¸­ä½¿ç”¨çš„ç›¸å¯¹è¾ƒå°‘ï¼Œæ‰€ä»¥é˜…è¯»ç›¸å…³æºç çš„æ—¶å€™ä¹Ÿåªæ˜¯å¤§æ¦‚çœ‹äº†ä¸€ä¸‹ï¼Œäº†è§£å¸¸ç”¨ APIï¼Œä»¥åŠåº•å±‚åŸç†ã€‚</p><p>ç®€å•æ€»ç»“å°±æ˜¯ä½¿ç”¨<strong>å•å‘é“¾è¡¨</strong>æ¥ä¿å­˜é˜Ÿåˆ—å…ƒç´ ï¼Œå†…éƒ¨ä½¿ç”¨éé˜»å¡çš„ CAS ç®—æ³•ï¼Œæ²¡æœ‰åŠ é”ã€‚æ‰€ä»¥è®¡ç®— size æ—¶å¯èƒ½ä¸å‡†ç¡®ï¼ŒåŒæ · size ä¼šéå†é“¾è¡¨ï¼Œæ‰€ä»¥å¹¶ä¸å»ºè®®ä½¿ç”¨ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å·¥ä½œç¬”è®°ã€‘- APP è«åå´©æºƒï¼Œå¼€å§‹ä»¥ä¸ºæ˜¯ Header ä¸­ name å¤§å°å†™çš„é”…ï¼Œæœ€åå‘ç°åŸæ¥æ˜¯å®¹å™¨çš„é”™ï¼</title>
      <link href="2020/10/19/header-name-case.html"/>
      <url>2020/10/19/header-name-case.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>éƒ¨ç½²æµ‹è¯•ï¼Œéƒ¨ç½²é¢„å‘å¸ƒï¼Œä¸€åˆ‡æµ‹è¯•å°±ç»ªï¼Œä¸Šç”Ÿäº§ã€‚</p><p>å‘å¸ƒç”Ÿäº§</p><p>é—ªé€€</p><p>Whatï¼Ÿï¼Ÿï¼Ÿ</p><p>é©¬ä¸Šå›æ»š</p><p>å¼€å§‹æ’æŸ¥</p><p>åç«¯ä¸€æ¨¡ä¸€æ ·çš„ä»£ç ï¼Œä¸æ˜¯ APP ç«¯çš„é—®é¢˜å§ã€‚å¯ APP ç«¯æ²¡æœ‰å‘ç‰ˆå•Šã€‚</p><p>â€¦â€¦ ä¸€ç•ªæ’æŸ¥</p><p>åŸæ¥æ˜¯ APP ç«¯æ‰“åŒ…ï¼Œæµ‹è¯•å’Œé¢„å‘å¸ƒåŒ… Header ä¼ çš„éƒ½æ˜¯ <code>Authorization</code> ï¼Œç”Ÿäº§ä¼ çš„æ˜¯ <code>authorization</code> ã€‚å°±æ˜¯å¤§å°å†™é—®é¢˜ï¼Œé‚£èµ¶ç´§æ”¹ã€‚</p></blockquote><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>é¦–é¡µæ¥å£åªæœ‰ç™»å½•æ‰å¯ä»¥è¿›å…¥ï¼Œå› ä¸ºé¦–é¡µè¦å±•ç¤ºè·å–ç”¨æˆ·è´¦æˆ·çš„ä¸€äº›ä¿¡æ¯ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ç»Ÿä¸€æ‹¦æˆªï¼Œä» Header ä¸­è·å– token åï¼Œä½¿ç”¨ token è·å–ç”¨æˆ·ä¿¡æ¯ã€‚</p><p>è€Œç°åœ¨è¦æ”¹ä¸ºç”¨æˆ·æœªç™»å½•ä¹Ÿå¯ä»¥æŸ¥çœ‹é¦–é¡µä¿¡æ¯ä¸­çš„å®£ä¼ æ–‡æ¡ˆç­‰ç­‰ï¼Œåªä¸è¿‡è´¦æˆ·ä¿¡æ¯ä¸æ˜¾ç¤ºã€‚</p><h4 id="åŸæµç¨‹"><a href="#åŸæµç¨‹" class="headerlink" title="åŸæµç¨‹"></a>åŸæµç¨‹</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/FiwOie-8ZLjgv.png" alt="FiwOie-8ZLjgv"></p><p>æ•´ä¸ªè¿‡ç¨‹ä»£ç åœ¨ <a href="https://mp.weixin.qq.com/s/8qY94y3w0Q2RRhkG7iUfOg">ThreadLocalåº•å±‚åŸç†</a> é‡Œé¢æœ‰æ‰€ä»‹ç»ã€‚è¿™é‡Œçœç•¥ä¸€éƒ¨åˆ†ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2, Exception arg3)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        LocalUserUtils.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯·æ±‚æ–¹æ³•æ˜¯å¦å­˜åœ¨æ³¨è§£</span></span><br><span class="line">        <span class="keyword">boolean</span> assignableFrom = handler.getClass().isAssignableFrom(HandlerMethod.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!assignableFrom) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CheckToken checkToken = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> HandlerMethod) &#123;</span><br><span class="line">            checkToken = ((HandlerMethod) handler).getMethodAnnotation(CheckToken.class);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ²¡æœ‰åŠ æ³¨è§£ ç›´æ¥æ”¾è¿‡</span></span><br><span class="line">        <span class="keyword">if</span> (checkToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»Headerä¸­è·å–Authorization</span></span><br><span class="line">        String authorization = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;header authorization : &#123;&#125;&quot;</span>, authorization);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(authorization)) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ä»Headerä¸­è·å–Authorizationå¤±è´¥&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> CustomExceptionEnum.NOT_HAVE_TOKEN.throwCustomException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…¶ä»–ä»£ç çœç•¥</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºè¿™é‡Œå¤§æ¦‚è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ˜¯ä½¿ç”¨æ‹¦æˆªå™¨æ‹¦æˆªè¯·æ±‚</li><li>å¦‚æœæ–¹æ³•æ²¡æœ‰ CheckToken æ³¨è§£ç›´æ¥æ”¾è¿‡</li><li>æœ‰ CheckToken æ³¨è§£ï¼Œåˆ™ä» request çš„ header ä¸­è·å– Authorization</li></ol><h4 id="æ–°éœ€æ±‚"><a href="#æ–°éœ€æ±‚" class="headerlink" title="æ–°éœ€æ±‚"></a>æ–°éœ€æ±‚</h4><p>è¿™é‡Œæƒ³åˆ°åªéœ€è¦æŠŠæ³¨è§£å»æ‰ï¼Œç„¶åä»è¯·æ±‚å‚æ•°ä¸­è·å– token å³å¯ã€‚è·å–åˆ°èµ°åŸé€»è¾‘ï¼Œè·å–ä¸åˆ°åˆ™åªè¿”å›å®£ä¼ æ–‡æ¡ˆç­‰ä¿¡æ¯ã€‚</p><h3 id="ä»-Header-ä¸­è·å–ä¿¡æ¯"><a href="#ä»-Header-ä¸­è·å–ä¿¡æ¯" class="headerlink" title="ä» Header ä¸­è·å–ä¿¡æ¯"></a>ä» Header ä¸­è·å–ä¿¡æ¯</h3><h4 id="ç›´æ¥è·å–è¯·æ±‚å¤´æŸä¸€ä¸ª-headerName"><a href="#ç›´æ¥è·å–è¯·æ±‚å¤´æŸä¸€ä¸ª-headerName" class="headerlink" title="ç›´æ¥è·å–è¯·æ±‚å¤´æŸä¸€ä¸ª headerName"></a>ç›´æ¥è·å–è¯·æ±‚å¤´æŸä¸€ä¸ª headerName</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/getAuthorizationByKey&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAuthorizationByKey</span><span class="params">(<span class="meta">@RequestHeader(&quot;Authorization&quot;)</span> String authorization)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;è·å– Authorization ---&gt;&#123;&#125;&quot;</span>, authorization);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> authorization;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨-Map-è·å–æ‰€æœ‰è¯·æ±‚å¤´"><a href="#ä½¿ç”¨-Map-è·å–æ‰€æœ‰è¯·æ±‚å¤´" class="headerlink" title="ä½¿ç”¨ Map è·å–æ‰€æœ‰è¯·æ±‚å¤´"></a>ä½¿ç”¨ Map è·å–æ‰€æœ‰è¯·æ±‚å¤´</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/getAuthorizationByMap&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAuthorizationByMap</span><span class="params">(<span class="meta">@RequestHeader</span> Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String authorization = map.get(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;è·å– Authorization ---&gt;&#123;&#125;&quot;</span>, authorization);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> authorization;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨-MultiValueMap-è·å–è¯·æ±‚å¤´"><a href="#ä½¿ç”¨-MultiValueMap-è·å–è¯·æ±‚å¤´" class="headerlink" title="ä½¿ç”¨ MultiValueMap è·å–è¯·æ±‚å¤´"></a>ä½¿ç”¨ MultiValueMap è·å–è¯·æ±‚å¤´</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/getAuthorizationByMultiValueMap&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAuthorizationByMultiValueMap</span><span class="params">(<span class="meta">@RequestHeader</span> MultiValueMap&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; authorization = map.get(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;è·å– Authorization ---&gt;&#123;&#125;&quot;</span>, authorization);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;SUCCESS&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨-HttpHeaders-è·å–è¯·æ±‚å¤´"><a href="#ä½¿ç”¨-HttpHeaders-è·å–è¯·æ±‚å¤´" class="headerlink" title="ä½¿ç”¨ HttpHeaders è·å–è¯·æ±‚å¤´"></a>ä½¿ç”¨ HttpHeaders è·å–è¯·æ±‚å¤´</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/getAuthorizationByHeaders&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAuthorizationByHeaders</span><span class="params">(<span class="meta">@RequestHeader</span> HttpHeaders headers)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; authorization = headers.get(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;è·å– Authorization ---&gt;&#123;&#125;&quot;</span>, authorization);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;SUCCESS&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨-HttpServletRequest-è·å–"><a href="#ä½¿ç”¨-HttpServletRequest-è·å–" class="headerlink" title="ä½¿ç”¨ HttpServletRequest è·å–"></a>ä½¿ç”¨ HttpServletRequest è·å–</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/getAuthorizationByServlet&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAuthorizationByServlet</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String authorization = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;è·å– Authorization ---&gt;&#123;&#125;&quot;</span>, authorization);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> authorization;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æµ‹è¯•æ–‡ä»¶"><a href="#æµ‹è¯•æ–‡ä»¶" class="headerlink" title="æµ‹è¯•æ–‡ä»¶"></a>æµ‹è¯•æ–‡ä»¶</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/dqAEES-LSudFy.png" alt="dqAEES-LSudFy"></p><p>ç»è¿‡æµ‹è¯•è¿™äº›éƒ½æ˜¯å¯ä»¥çš„ï¼Œæœ€ç»ˆé€‰æ‹©ä½¿ç”¨ Map æ¥æ”¶ Header ï¼Œç„¶åä» Map ä¸­è·å– Authorizationã€‚</p><blockquote><p>PS: å¯èƒ½æœ‰å°ä¼™ä¼´æµ‹è¯•ä¸è¿‡ï¼Œå‘ç°æ¥å—çš„ header é‡Œçš„ name å…¨éƒ½æ˜¯å°å†™äº†ï¼Œå¯ä»¥ç»§ç»­é˜…è¯»ã€‚<br>æºç åœ¨æ–‡æœ«ï¼Œä¹Ÿå¯ä»¥å…³æ³¨å…¬ä¼—å·ï¼Œå‘é€ headerName/4 è·å–ã€‚</p></blockquote><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/rXC2fS-cVftVR.jpg" alt="rXC2fS-cVftVR"></p><p>ä½ ä»¥ä¸ºäº‹æƒ…å¦‚æœåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œé‚£çœŸæ˜¯å¤ªå¤©çœŸäº†ã€‚</p><p>è¿™ä¸ï¼Œå‡ºç°äº†æ–‡ç« å¼€å¤´çš„æè¿°çš„åœºæ™¯ï¼Œèµ¶ç´§å›æ»šï¼Œç„¶åæ’æŸ¥é—®é¢˜ï¼Œæœ€åå®šä½åˆ°æ˜¯ Header çš„ name å¤§å°å†™é—®é¢˜ã€‚</p><h4 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h4><ol><li>ä¹‹å‰ APP ç«¯ä¹Ÿæ˜¯è¿™ä¹ˆä¼ çš„ï¼Œé‚£ä¸ºä»€ä¹ˆä½¿ç”¨æ‹¦æˆªå™¨æ˜¯æ­£å¸¸çš„å‘¢ï¼Ÿ</li><li>ä¸Šé¢çš„é‚£å‡ ç§æ–¹å¼æ˜¯ä¸æ˜¯éƒ½æ˜¯è¿™æ ·ï¼Ÿ</li><li>ä¸æ’é™¤ tomcat å‘ç°åŸæ¥éƒ½ä¼šè½¬æ¢ä¸ºå°å†™ï¼Œåˆæ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</li></ol><h3 id="æ¨¡æ‹Ÿæ’æŸ¥"><a href="#æ¨¡æ‹Ÿæ’æŸ¥" class="headerlink" title="æ¨¡æ‹Ÿæ’æŸ¥"></a>æ¨¡æ‹Ÿæ’æŸ¥</h3><h4 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h4><p>æ¨¡æ‹Ÿç”Ÿäº§é¦–å…ˆä½¿ç”¨ç›¸åŒçš„å®¹å™¨é…ç½®ï¼Œè¿™é‡Œæ’é™¤äº†å†…ç½®çš„ tomcat å®¹å™¨ï¼Œå¹¶ä¸”ä½¿ç”¨ undertow å®¹å™¨ã€‚</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Exclude the Tomcat dependency --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-undertow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨æ‹¦æˆªå™¨ä¼ å°å†™ä¸ºä»€ä¹ˆæ²¡æœ‰é—®é¢˜"><a href="#ä½¿ç”¨æ‹¦æˆªå™¨ä¼ å°å†™ä¸ºä»€ä¹ˆæ²¡æœ‰é—®é¢˜" class="headerlink" title="ä½¿ç”¨æ‹¦æˆªå™¨ä¼ å°å†™ä¸ºä»€ä¹ˆæ²¡æœ‰é—®é¢˜"></a>ä½¿ç”¨æ‹¦æˆªå™¨ä¼ å°å†™ä¸ºä»€ä¹ˆæ²¡æœ‰é—®é¢˜</h4><ul><li>ä¿®æ”¹ä½¿ç”¨å°å†™ <code>authorization</code></li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/BnwZnf-7AvYYg.png" alt="BnwZnf-7AvYYg"></p><ul><li>debug æ–­ç‚¹</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/OOjOyV-54K6Na.png" alt="OOjOyV-54K6Na"></p><p>ç¥å¥‡çš„ä¸€å¹•å‡ºç°äº†ï¼Œæ”¶åˆ°çš„ç¡®å®æ˜¯å°å†™ï¼Œä½†æ˜¯ <strong>request.getHeader(â€œAuthorizationâ€);</strong> å´å¯ä»¥è·å–åˆ° <code>authorization</code></p><ul><li>F7 ç»§ç»­å¾€é‡Œè·Ÿ</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/JwgnFS-cW3pJY.png" alt="JwgnFS-cW3pJY"></p><p><code>io.undertow.servlet.spec.HttpServletRequestImpl#getHeader</code> ç¬¬ 190 è¡Œï¼Œä» HeaderMap ä¸­è·å–ç¬¬ä¸€ä¸ªå…ƒç´ </p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/DnRSum-crs0Mb.png" alt="DnRSum-crs0Mb"></p><p><code>io.undertow.util.HeaderMap#getFirst</code> ç¬¬ 297 è¡Œï¼Œ é€šè¿‡ getEntry æ–¹æ³•è·å– header</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/C8lSGw-XxKDPW.png" alt="C8lSGw-XxKDPW"></p><p>ç»§ç»­è¿½è¸ªï¼Œå‘ç°åœ¨ <code>io.undertow.util.HeaderMap#getEntry(java.lang.String)</code> æ–¹æ³• 77~79 è¡Œçš„æ—¶å€™è·å–åˆ°äº† header ä¿¡æ¯ã€‚é‚£å°±çœ‹ä¸€ä¸‹è¿™å—çš„æºç å§ã€‚</p><p>åœ¨ä»”ç»†çœ‹ä¸€ä¸‹å‘ç°æ˜¯ 77 è¡Œ <code>final int hc = HttpString.hashCodeOf(headerName);</code> åœ¨è·å– name çš„ hashCode æ—¶ï¼Œè¿™é‡Œæ— è®ºå¤§å°å†™ï¼Œéƒ½æ˜¯åŒä¸€ä¸ª hashCodeã€‚è¿™å—ä»£ç å¦‚ä¸‹</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/3v1FVJ-MuPXUA.png" alt="3v1FVJ-MuPXUA"></p><p>higher æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">higher</span><span class="params">(<span class="keyword">byte</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> b &amp; (b &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; b &lt;= <span class="string">&#x27;z&#x27;</span> ? <span class="number">0xDF</span> : <span class="number">0xFF</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å—çš„å«ä¹‰</p><ol><li>å¦‚æœ b æ˜¯å°å†™å­—ç¬¦åˆ™ <code>b &amp; 0xDF</code></li><li>å¦‚æœ b æ˜¯å¤§å†™å­—ç¬¦åˆ™ <code>b &amp; 0xFF</code></li></ol><p>å¯¹ç…§ ASCII è¡¨ï¼Œå¤§å°å†™å­—æ¯ç›¸å·® 32 è€Œ 0xFF(255) å’Œ 0xDF(223) åŒæ ·ç›¸å·® 32ï¼Œæ‰€ä»¥é—®é¢˜å®šä½åˆ°äº†ã€‚header çš„ name æ— è®ºæ˜¯å¤§å†™è¿˜æ˜¯å°å†™ï¼Œéƒ½ä¼šæŸ¥å‡ºåŒä¸€ä¸ªå€¼ã€‚</p><p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥è¿™ä¹ˆä¼ </p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/VOOF8k-LoGjAf.png" alt="VOOF8k-LoGjAf"></p><p>è¿™æ ·çš„è¯è°åœ¨ä¸Šé¢ï¼ŒHeader ä¸­ä½¿ç”¨çš„ name å°±æ˜¯é‚£ä¸ªã€‚</p><h4 id="ä½¿ç”¨-Map-ä¸ºä»€ä¹ˆä¼šåŒºåˆ†å¤§å°å†™"><a href="#ä½¿ç”¨-Map-ä¸ºä»€ä¹ˆä¼šåŒºåˆ†å¤§å°å†™" class="headerlink" title="ä½¿ç”¨ Map ä¸ºä»€ä¹ˆä¼šåŒºåˆ†å¤§å°å†™"></a>ä½¿ç”¨ Map ä¸ºä»€ä¹ˆä¼šåŒºåˆ†å¤§å°å†™</h4><p>ä¼ å…¥çš„æ˜¯å¤§å†™</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">HttpServlet </span><br><span class="line">-&gt; DispatcherServlet#doDispatch </span><br><span class="line">-&gt; AbstractHandlerMethodAdapter#handle </span><br><span class="line">-&gt; RequestMappingHandlerAdapter#handleInternal </span><br><span class="line">-&gt; RequestMappingHandlerAdapter#invokeHandlerMethod </span><br><span class="line">-&gt; ServletInvocableHandlerMethod#invokeAndHandle</span><br><span class="line">-&gt; InvocableHandlerMethod#invokeForRequest (è§£æå‚æ•°å€¼)</span><br><span class="line">-&gt; InvocableHandlerMethod#getMethodArgumentValues</span><br><span class="line">-&gt; RequestHeaderMapMethodArgumentResolver#resolveArgument</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/dqAEES-LSudFy.png" alt="dqAEES-LSudFy"></p><p>å¦‚å›¾æ‰€ç¤º <code>String headerName = iterator.next();</code> name è¢«åŒºåˆ†å¤§å°å†™æ”¾åˆ°äº† LinkedHashMap ä¸­ï¼Œåç»­ä¼šåå°„è°ƒç”¨å¯¹åº”çš„ Controller æ–¹æ³•ã€‚</p><p>æ‰€ä»¥ä¹Ÿå°±å‡ºç°äº†æˆ‘æ‰€é‡åˆ°çš„é—®é¢˜ã€‚ </p><p>å½“ç„¶ç†è®ºä¸Š APP å®¢æˆ·ç«¯ä¸åº”è¯¥æµ‹è¯•å’Œé¢„å‘å¸ƒä½¿ç”¨å¤§å†™ï¼Œè€Œç”Ÿäº§ä½¿ç”¨å°å†™ã€‚</p><p>ä¸Šé¢é˜…è¯»çš„æºç åªæ˜¯ Spring å¯¹ Header çš„å¤„ç†ï¼ŒSpring åœ¨ <code>HttpServlet</code> æ”¶åˆ°è¯·æ±‚æ—¶ï¼ŒSpring æ²¡æœ‰å¯¹è¯·æ±‚ Header çš„ name å¤§å°å†™è¿›è¡Œè½¬æ¢ï¼Œåªæ˜¯åœ¨è·å–å¯¹åº” value çš„æ—¶å€™ï¼Œæ²¡æœ‰åŒºåˆ†å¤§å°å†™è¿›è¡Œè·å–ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/mpl3PK-m7dKAb.jpg"></p><h3 id="å®¹å™¨å¯¹-header-çš„å¤„ç†"><a href="#å®¹å™¨å¯¹-header-çš„å¤„ç†" class="headerlink" title="å®¹å™¨å¯¹ header çš„å¤„ç†"></a>å®¹å™¨å¯¹ header çš„å¤„ç†</h3><h5 id="undertow-å®¹å™¨çš„å¤„ç†"><a href="#undertow-å®¹å™¨çš„å¤„ç†" class="headerlink" title="undertow å®¹å™¨çš„å¤„ç†"></a>undertow å®¹å™¨çš„å¤„ç†</h5><ul><li>è¯·æ±‚å‚æ•°çš„å¤„ç†</li></ul><p>è¿™é‡Œå‘ç° undertow å¹¶æ²¡æœ‰å¯¹è¯·æ±‚å‚æ•°è¿›è¡Œå¤§å°å†™è½¬æ¢å¤„ç†æ“ä½œã€‚</p><ul><li>ä» HttpServletRequest è·å– header</li></ul><p>debug å‘ç°è°ƒç”¨çš„æ˜¯ <code>io.undertow.servlet.spec.HttpServletRequestImpl#getHeader</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸Šé¢çš„æ’æŸ¥è¿‡ç¨‹ã€‚</p><ul><li>ä» Headers ä¸­è·å– header</li></ul><p>é€šè¿‡ debug å‘ç° jetty è°ƒç”¨çš„æ˜¯ <code>org.springframework.http.HttpHeaders#get</code>ï¼Œç„¶åè°ƒç”¨ <code>org.springframework.util.MultiValueMapAdapter#get</code>ï¼Œç„¶åè°ƒç”¨ <code>org.springframework.util.LinkedCaseInsensitiveMap#get</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/nRw6xN-GkUqAN.png" alt="nRw6xN-GkUqAN"></p><p>è¿™é‡Œä¼šä¸åŒºåˆ†å¤§å°å†™</p><ul><li>ä» MultiValueMap è·å– header</li></ul><p>è¿™å— debug å‘ç°æ˜¯ç›´æ¥ä» <code>LinkedHashMap</code> è·å–çš„ï¼Œæ‰€ä»¥åŒºåˆ†äº†å¤§å°å†™ã€‚</p><h4 id="tomcat-å®¹å™¨çš„å¤„ç†"><a href="#tomcat-å®¹å™¨çš„å¤„ç†" class="headerlink" title="tomcat å®¹å™¨çš„å¤„ç†"></a>tomcat å®¹å™¨çš„å¤„ç†</h4><ul><li>è¯·æ±‚å‚æ•°çš„å¤„ç†</li></ul><p>è€Œå¦‚æœæ²¡æœ‰æ’é™¤çš„è¯ï¼Œå³ä½¿ç”¨å†…åµŒçš„ tomcat å®¹å™¨æ— è®ºä¼ é€’å¤§å†™è¿˜æ˜¯å°å†™ï¼Œæ¥æ”¶åˆ°çš„å…¨éƒ¨éƒ½æ˜¯å°å†™ï¼Œåˆæ˜¯æ€ä¹ˆä¸ªæƒ…å†µå‘¢ï¼Ÿ</p><p>é€šè¿‡ debug å‘ç°æ²¡æœ‰æ’é™¤ tomcat ä½¿ç”¨çš„æ˜¯ï¼Œåœ¨æ¥æ”¶è¯·æ±‚æ—¶ä½¿ç”¨çš„æ˜¯ <code>org.apache.coyote.http11.Http11Processor</code>ã€‚</p><p>åœ¨ <code>Http11Processor#service</code> æ–¹æ³•ä¸­</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/303mmp-6TczCR.png" alt="303mmp-6TczCR"></p><p>ç±» 284 è¡Œè´Ÿè´£å¤„ç†è§£æ header </p><p>è¿›å…¥ <code>org.apache.coyote.http11.Http11InputBuffer#parseHeaders</code> æ–¹æ³•</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/cqHTEZ-1E9mH7.png" alt="cqHTEZ-1E9mH7"></p><p>ç¬¬ 589 è¡Œ ï¼ˆDownload Sources åï¼‰ï¼Œé˜…è¯» <code>parseHeader</code> æ–¹æ³•</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/oEEbej-rMulR7.png" alt="oEEbej-rMulR7"></p><p>å‘ç°ä¼šå°†è¯·æ±‚ header çš„ name è½¬æ¢ä¸ºå°å†™</p><ul><li>ä» HttpServletRequest è·å– header</li></ul><p>å½“ä½¿ç”¨ tomcat å®¹å™¨æ—¶ï¼Œè°ƒç”¨ <code>org.apache.catalina.connector.RequestFacade#getHeader</code>ï¼Œ <code>org.apache.catalina.connector.Request#getHeader</code>ï¼Œ <code>org.apache.coyote.Request#getHeader</code> <code>org.apache.tomcat.util.http.MimeHeaders#getHeader</code> æœ€åè°ƒç”¨ <code>org.apache.tomcat.util.http.MimeHeaders#getValue</code> è·å– header </p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/qDJXXn-z6hTjZ.png" alt="qDJXXn-z6hTjZ"></p><p>è¿™é‡Œä¹Ÿä¼šå¿½ç•¥å¤§å°å†™åˆ¤æ–­</p><ul><li>ä» Headers è·å– header</li></ul><p>é€šè¿‡ debug å‘ç° tomcat å®¹å™¨ä¸‹è°ƒç”¨çš„æ˜¯ <code>org.springframework.http.HttpHeaders#get</code>ï¼Œç„¶åè°ƒç”¨ <code>org.springframework.util.MultiValueMapAdapter#get</code>ï¼Œç„¶åè°ƒç”¨ <code>org.springframework.util.LinkedCaseInsensitiveMap#get</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/nRw6xN-GkUqAN.png" alt="nRw6xN-GkUqAN"></p><p>è¿™é‡Œä¼šä¸åŒºåˆ†å¤§å°å†™</p><ul><li>ä» MultiValueMap è·å– header</li></ul><p>è¿™å— debug å‘ç°æ˜¯ç›´æ¥ä» <code>LinkedHashMap</code> è·å–çš„ï¼Œæ‰€ä»¥åŒºåˆ†äº†å¤§å°å†™ã€‚</p><h4 id="jetty-å®¹å™¨çš„å¤„ç†"><a href="#jetty-å®¹å™¨çš„å¤„ç†" class="headerlink" title="jetty å®¹å™¨çš„å¤„ç†"></a>jetty å®¹å™¨çš„å¤„ç†</h4><ul><li>è¯·æ±‚å‚æ•°çš„å¤„ç†</li></ul><p>å¦‚æœæ¢æˆ jetty å®¹å™¨çš„è¯</p><p>åœ¨ <code>org.eclipse.jetty.server.HttpConnection</code> ä¸­åˆä¼šå‘ç°æ— è®ºä¼ å…¥å¤§å†™è¿˜æ˜¯å°å†™éƒ½ä¼šè¢«è½¬æ¢ä¸ºé©¼å³°ã€‚</p><p>æºç å¯ä»¥é˜…è¯» <code>org.eclipse.jetty.http.HttpParser#parseFields</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/Q9KjmT-HSRusz.png" alt="Q9KjmT-HSRusz"></p><p>ä¼šè½¬æ¢ä¸ºé©¼å³°å‘½åæ³•ã€‚</p><ul><li>ä» HttpServletRequest è·å– header</li></ul><p>é€šè¿‡ debug å‘ç° jetty è°ƒç”¨çš„æ˜¯ <code>org.eclipse.jetty.server.Request#getHeader</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/H9onCc-uyaMMn.png" alt="H9onCc-uyaMMn"></p><p>jetty åœ¨è·å– header æ—¶ï¼Œä¼šè°ƒç”¨ <code>org.eclipse.jetty.http.HttpFields#get</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/BOkxFw-op6ZIV.png" alt="BOkxFw-op6ZIV"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ioe7pS-uNuRU6.png" alt="ioe7pS-uNuRU6"></p><p>åŸæ¥åœ¨è·å–çš„æ—¶å€™å¿½ç•¥äº†å¤§å°å†™</p><ul><li>ä» Headers è·å– header</li></ul><p>é€šè¿‡ debug å‘ç° jetty å®¹å™¨ä¸‹è°ƒç”¨çš„æ˜¯ <code>org.springframework.http.HttpHeaders#get</code>ï¼Œç„¶åè°ƒç”¨ <code>org.springframework.util.MultiValueMapAdapter#get</code>ï¼Œç„¶åè°ƒç”¨ <code>org.springframework.util.LinkedCaseInsensitiveMap#get</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/nRw6xN-GkUqAN.png" alt="nRw6xN-GkUqAN"></p><p>è¿™é‡Œä¼šä¸åŒºåˆ†å¤§å°å†™</p><ul><li>ä» MultiValueMap è·å–</li></ul><p>ä¹Ÿæ˜¯è°ƒç”¨çš„ <code>org.springframework.util.MultiValueMapAdapter#get</code> ç„¶åä¸åŒºåˆ†å¤§å°å†™ã€‚å’Œä» Headers ä¸­è·å–ç›¸åŒã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p><strong>Q: ä¸ºä»€ä¹ˆæ‹¦æˆªå™¨è·å– Authorization å¯ä»¥ä¸åŒºåˆ†å¤§å°å†™ï¼Ÿ</strong></p><p><strong>A:</strong> ä»æ‹¦æˆªå™¨è·å– Authorization å…¶å®å°±æ˜¯ä» <code>HttpServletRequest</code> ä¸­è·å–ï¼Œè¿™é‡Œæ— è®ºä½¿ç”¨ tomcat è¿˜æ˜¯ä½¿ç”¨ undertow æˆ–è€… jetty è·å– Header æ˜¯éƒ½æ˜¯å¿½ç•¥ headerName çš„å¤§å°å†™çš„ã€‚å…·ä½“å¯ä»¥é˜…è¯»ä¸Šé¢çš„æºç åˆ†æã€‚</p><p><strong>Q: è¿™ä¹ˆå¤šè·å– Header çš„æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong><br><strong>A:</strong></p><p>ä¸åŒçš„å®¹å™¨ä¸‹å®ç°æ–¹å¼ä¸åŒï¼Œè¿™é‡Œåˆ—è¡¨è¯´æ˜</p><table><thead><tr><th align="center"></th><th align="center">undertow</th><th align="center">tomcat</th><th align="center">jetty</th></tr></thead><tbody><tr><td align="center">è¯·æ±‚å‚æ•°å¤§å°å†™è½¬æ¢</td><td align="center">ä¸å˜</td><td align="center">å°å†™</td><td align="center">é©¼å³°</td></tr><tr><td align="center">ç›´æ¥è·å–è¯·æ±‚å¤´æŸä¸€ä¸ª headerName</td><td align="center">å¿½ç•¥å¤§å°å†™ï¼Œä¸èƒ½ä¸ºç©º</td><td align="center">å¿½ç•¥å¤§å°å†™ï¼Œä¸èƒ½ä¸ºç©º</td><td align="center">å¿½ç•¥å¤§å°å†™ï¼Œä¸èƒ½ä¸ºç©º</td></tr><tr><td align="center">ä½¿ç”¨ Map è·å–æ‰€æœ‰è¯·æ±‚å¤´</td><td align="center">Map çš„ key å’Œä¼ å…¥ headerName å¤§å°å†™çš„ä¸€è‡´ï¼Œä¿æŒä¸€è‡´å¯è·å–åˆ°</td><td align="center">Map çš„ key å…¨æ˜¯å°å†™ï¼Œéœ€è¦ä½¿ç”¨å°å†™headerName è·å–</td><td align="center">Map çš„ key æ˜¯é©¼å³°å‘½åæ³•ï¼Œè¦ä½¿ç”¨é©¼å³°å‘½åæ‰å¯ä»¥è·å–åˆ°</td></tr><tr><td align="center">ä½¿ç”¨ MultiValueMap è·å–è¯·æ±‚å¤´</td><td align="center">å®é™…æ˜¯ä» LinkedHashMap ä¸­è·å–ï¼ŒåŒºåˆ†å¤§å°å†™</td><td align="center">å®é™…æ˜¯ä» LinkedHashMap ä¸­è·å–ï¼ŒåŒºåˆ†å¤§å°å†™</td><td align="center">ä» LinkedCaseInsensitiveMap è·å–ï¼Œä¸åŒºåˆ†å¤§å°å†™</td></tr><tr><td align="center">ä½¿ç”¨ HttpHeaders è·å–è¯·æ±‚å¤´</td><td align="center">ä» LinkedCaseInsensitiveMap è·å–ï¼Œä¸åŒºåˆ†å¤§å°å†™</td><td align="center">ä» LinkedCaseInsensitiveMap è·å–ï¼Œä¸åŒºåˆ†å¤§å°å†™</td><td align="center">ä» LinkedCaseInsensitiveMap è·å–ï¼Œä¸åŒºåˆ†å¤§å°å†™</td></tr><tr><td align="center">ä½¿ç”¨ HttpServletRequest è·å–</td><td align="center">ä½¿ç”¨ HttpString.hashCodeOf(headerName) å¿½ç•¥äº†å¤§å°å†™</td><td align="center">è°ƒç”¨ MimeHeaders#getValue å¿½ç•¥äº†å¤§å°å†™</td><td align="center">HttpFields#get å¿½ç•¥äº†å¤§å°å†™</td></tr></tbody></table><p>é€šè¿‡è¡¨æ ¼å‘ç°ï¼Œå³ä½¿æ˜¯ä¸åŒçš„å®¹å™¨åœ¨ä½¿ç”¨ HttpHeaders è·å–è¯·æ±‚å¤´æ˜¯éƒ½æ˜¯è°ƒç”¨äº† Spring çš„ <code>LinkedCaseInsensitiveMap</code> è·å– headerï¼Œå¹¶ä¸”å†…éƒ¨å¿½ç•¥äº†å¤§å°å†™ï¼Œè¿™é‡Œæ¯”è¾ƒæ¨èä½¿ç”¨ã€‚</p><p>åŒæ ·ä½¿ç”¨ HttpServletRequest çš„æ–¹å¼è·å–ä¹Ÿæ¯”è¾ƒæ¨èã€‚</p><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>æœ¬æ–‡ä¸»è¦æ˜¯åˆ†æç”Ÿäº§é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œç„¶åå¼€å§‹æ¢ç©¶åŸå› ï¼Œå¼€å§‹çš„æ—¶å€™å‘ç°æ˜¯ Spring çš„åŸå› ï¼Œå› ä¸ºä½¿ç”¨ Map æ¥æ”¶æ—¶ï¼Œ headerName ä»€ä¹ˆæ ¼å¼å°±æ˜¯ä»€ä¹ˆæ ¼å¼ã€‚</p><p>åœ¨è‡ªå·±å†™ demo æ—¶åˆå‘ç°ï¼ŒåŸæ¥å’Œ Spring çš„å…³ç³»å¹¶ä¸å¤§ï¼Œæ˜¯å®¹å™¨çš„åŸå› ã€‚ä¸åŒçš„å®¹å™¨å¤„ç†æ–¹å¼ä¸åŒã€‚æ‰€ä»¥æ€»ç»“å‡ºæ¥ç›¸å…³æ–‡ç« ï¼Œä¾›å¤§å®¶å‚è€ƒï¼Œä¸è¶³ä¹‹å¤„ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚</p><h4 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h4><ol><li>æœ¬æ–‡æºç åœ°å€ï¼š<a href="https://github.com/liuzhihang/header-demo">https://github.com/liuzhihang/header-demo</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> å·¥ä½œç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥ä½œç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å·¥ä½œç¬”è®°ã€‘- å‡ è¡Œä»£ç è½»æ¾å®ç°è·¨ç³»ç»Ÿä¼ é€’ traceIdï¼Œå†ä¹Ÿä¸ç”¨æ‹…å¿ƒå¯¹ä¸ä¸Šæ—¥å¿—äº†ï¼</title>
      <link href="2020/10/18/log-trace-id.html"/>
      <url>2020/10/18/log-trace-id.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>æ–°é¡¹ç›®æŸ¥æ—¥å¿—å¤ªéº»çƒ¦ï¼Œå¤šå°æœºå™¨ä¹‹é—´æŸ¥æ¥æŸ¥å»ï¼Œè¿˜ä¸çŸ¥é“æ˜¯ä¸æ˜¯åŒä¸€ä¸ªè¯·æ±‚çš„ã€‚æ‰“å°æ—¥å¿—æ—¶ä½¿ç”¨ MDC åœ¨æ—¥å¿—ä¸Šæ·»åŠ ä¸€ä¸ª traceIdï¼Œé‚£è¿™ä¸ª traceId å¦‚ä½•è·¨ç³»ç»Ÿä¼ é€’å‘¢ï¼Ÿ</p></blockquote><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>åŒæ ·æ˜¯æ–°é¡¹ç›®å¼€å‘çš„ç¬”è®°ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯åˆ†å¸ƒå¼æ¶æ„ï¼Œæ¶‰åŠåˆ°å„ä¸ªç³»ç»Ÿä¹‹é—´çš„äº¤äº’</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/hHJYwn-b0KzBU.png" alt="hHJYwn-b0KzBU"></p><p>è¿™æ—¶å€™å°±ä¼šé‡åˆ°ä¸€ä¸ªå¾ˆå¸¸è§çš„é—®é¢˜ï¼š</p><ol><li>å•ä¸ªç³»ç»Ÿæ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œæ—¥å¿—åˆ†å¸ƒåœ¨å¤šå°æœåŠ¡å™¨ä¸Šï¼›</li><li>å¤šä¸ªç³»ç»Ÿçš„æ—¥å¿—åœ¨å¤šå°æœºå™¨ï¼Œä½†æ˜¯ä¸€æ¬¡è¯·æ±‚ï¼ŒæŸ¥æ—¥å¿—æ›´æ˜¯éš¾ä¸ŠåŠ éš¾ã€‚</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/53_b91a8fc194febf0f3d3edf032e6cf78d-dSqBDj.jpg" alt="53_b91a8fc194febf0f3d3edf032e6cf78d-dSqBDj"></p><h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><ol><li>ä½¿ç”¨ SkyWalking traceid è¿›è¡Œé“¾è·¯è¿½è¸ªï¼›</li><li>ä½¿ç”¨ Elastic APM çš„ trace.id è¿›è¡Œé“¾è·¯è¿½è¸ªï¼›</li><li>è‡ªå·±ç”Ÿæˆ traceId å¹¶ put åˆ° MDC é‡Œé¢ã€‚</li></ol><h3 id="MDC"><a href="#MDC" class="headerlink" title="MDC"></a>MDC</h3><p>MDCï¼ˆMapped Diagnostic Contextï¼‰æ˜¯ä¸€ä¸ªæ˜ å°„ï¼Œç”¨äºå­˜å‚¨è¿è¡Œä¸Šä¸‹æ–‡çš„ç‰¹å®šçº¿ç¨‹çš„ä¸Šä¸‹æ–‡æ•°æ®ã€‚å› æ­¤ï¼Œå¦‚æœä½¿ç”¨log4jè¿›è¡Œæ—¥å¿—è®°å½•ï¼Œåˆ™æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„MDCï¼Œè¯¥MDCå¯¹æ•´ä¸ªçº¿ç¨‹æ˜¯å…¨å±€çš„ã€‚å±äºè¯¥çº¿ç¨‹çš„ä»»ä½•ä»£ç éƒ½å¯ä»¥è½»æ¾è®¿é—®çº¿ç¨‹çš„MDCä¸­å­˜åœ¨çš„å€¼ã€‚</p><h4 id="å¦‚ä½•ä½¿ç”¨-MDC"><a href="#å¦‚ä½•ä½¿ç”¨-MDC" class="headerlink" title="å¦‚ä½•ä½¿ç”¨ MDC"></a>å¦‚ä½•ä½¿ç”¨ MDC</h4><ol><li>åœ¨ <strong>log4j2-spring.xml</strong> çš„æ—¥å¿—æ ¼å¼ä¸­æ·»åŠ  <code>%X&#123;traceId&#125;</code> é…ç½®ã€‚</li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_PATTERN&quot;</span>&gt;</span></span><br><span class="line">    [%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;]-[%t]-[%X&#123;traceId&#125;]-[%-5level]-[%c&#123;36&#125;:%L]-[%m]%n</span><br><span class="line"><span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_PATTERN_ERROR&quot;</span>&gt;</span></span><br><span class="line">    [%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;]-[%t]-[%X&#123;traceId&#125;]-[%-5level]-[%l:%M]-[%m]%n</span><br><span class="line"><span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- çœç•¥ --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--è¿™ä¸ªè¾“å‡ºæ§åˆ¶å°çš„é…ç½®--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_OUT&quot;</span> <span class="attr">follow</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--è¾“å‡ºæ—¥å¿—çš„æ ¼å¼--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>  <span class="attr">pattern</span>=<span class="string">&quot;$&#123;LOG_PATTERN&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>æ–°å¢æ‹¦æˆªå™¨</li></ol><p>æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œä» header ä¸­è·å– traceId ç„¶åæ”¾åˆ° MDC ä¸­ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™ç›´æ¥ç”¨ UUID ç”Ÿæˆä¸€ä¸ªã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRACE_ID = <span class="string">&quot;traceId&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception arg3)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView arg3)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String traceId = request.getHeader(TRACE_ID);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(traceId)) &#123;</span><br><span class="line">            MDC.put(TRACE_ID, UUID.randomUUID().toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            MDC.put(TRACE_ID, traceId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>é…ç½®æ‹¦æˆªå™¨</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LogInterceptor logInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(logInterceptor)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·¨æœåŠ¡ä¹‹é—´å¦‚ä½•ä¼ é€’-traceId"><a href="#è·¨æœåŠ¡ä¹‹é—´å¦‚ä½•ä¼ é€’-traceId" class="headerlink" title="è·¨æœåŠ¡ä¹‹é—´å¦‚ä½•ä¼ é€’ traceId"></a>è·¨æœåŠ¡ä¹‹é—´å¦‚ä½•ä¼ é€’ traceId</h4><ul><li>FeignClient</li></ul><p>å› ä¸ºè¿™è¾¹ä½¿ç”¨çš„æ˜¯ FeignClient è¿›è¡ŒæœåŠ¡ä¹‹é—´çš„è°ƒç”¨ï¼Œåªéœ€è¦æ–°å¢è¯·æ±‚æ‹¦æˆªå™¨å³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignInterceptor</span> <span class="keyword">implements</span> <span class="title">RequestInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRACE_ID = <span class="string">&quot;traceId&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestTemplate requestTemplate)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        requestTemplate.header(TRACE_ID, MDC.get(TRACE_ID));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Dubbo</li></ul><p>å¦‚æœæ˜¯ Dubbo å¯ä»¥é€šè¿‡æ‰©å±• Filter çš„æ–¹å¼ä¼ é€’ traceId</p><ol><li>ç¼–å†™ filter</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Activate(group = &#123;&quot;provider&quot;, &quot;consumer&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceIdFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        RpcContext rpcContext = RpcContext.getContext();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String traceId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rpcContext.isConsumerSide()) &#123;</span><br><span class="line"></span><br><span class="line">            traceId = MDC.get(<span class="string">&quot;traceId&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (traceId == <span class="keyword">null</span>) &#123;</span><br><span class="line">                traceId = UUID.randomUUID().toString();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rpcContext.setAttachment(<span class="string">&quot;traceId&quot;</span>, traceId);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rpcContext.isProviderSide()) &#123;</span><br><span class="line">            traceId = rpcContext.getAttachment(<span class="string">&quot;traceId&quot;</span>);</span><br><span class="line">            MDC.put(<span class="string">&quot;traceId&quot;</span>, traceId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> invoker.invoke(invocation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>æŒ‡å®š filter</li></ol><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">src</span><br><span class="line"> |-main</span><br><span class="line">    |-java</span><br><span class="line">        |-com</span><br><span class="line">            |-xxx</span><br><span class="line">                |-XxxFilter.java (å®ç°Filteræ¥å£)</span><br><span class="line">    |-resources</span><br><span class="line">        |-META-INF</span><br><span class="line">            |-dubbo</span><br><span class="line">                |-org.apache.dubbo.rpc.Filter (çº¯æ–‡æœ¬æ–‡ä»¶ï¼Œå†…å®¹ä¸ºï¼šxxx=com.xxx.XxxFilter)</span><br></pre></td></tr></table></figure><p>æˆªå›¾å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/STZ8hr-q8AmQ6.png" alt="STZ8hr-q8AmQ6"></p><p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/FKroew-oE1qSz.png" alt="FKroew-oE1qSz"></p><blockquote><p>dubbo filter ç›¸å…³æºç åœ°å€åœ¨æ–‡æœ«<br>ä¹Ÿå¯ä»¥å…³æ³¨å…¬ä¼—å·ï¼Œå‘é€ traceid è·å–</p></blockquote><h4 id="å…¶ä»–æ–¹å¼"><a href="#å…¶ä»–æ–¹å¼" class="headerlink" title="å…¶ä»–æ–¹å¼"></a>å…¶ä»–æ–¹å¼</h4><p>å½“ç„¶å¦‚æœå°ä¼™ä¼´ä»¬æœ‰ä½¿ç”¨ SkyWalking æˆ–è€… Elastic APM ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œæ³¨å…¥ï¼š</p><ol><li>SkyWalking</li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.skywalking<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apm-toolkit-log4j-2.x<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>&#123;project.release.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span></span></span><br></pre></td></tr></table></figure><p>ç„¶åå°† <code>[%traceId]</code> é…ç½®åœ¨ log4j2.xml æ–‡ä»¶çš„ pattern ä¸­å³å¯</p><ol start="2"><li><p>Elastic APM</p><ol><li>åœ¨å¯åŠ¨æ—¶æŒ‡å®š enable_log_correlation ä¸º true</li><li>å°† <code>%X&#123;trace.id&#125;</code> é…ç½®åœ¨ log4j2.xml æ–‡ä»¶çš„ pattern ä¸­</li></ol></li></ol><h3 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h3><h4 id="ç»Ÿä¸€æ—¥å¿—é‡‡é›†"><a href="#ç»Ÿä¸€æ—¥å¿—é‡‡é›†" class="headerlink" title="ç»Ÿä¸€æ—¥å¿—é‡‡é›†"></a>ç»Ÿä¸€æ—¥å¿—é‡‡é›†</h4><p>è™½ç„¶æœ‰äº† traceId å¯ä»¥è¿›è¡Œå…¨é“¾è·¯è¿½è¸ªæŸ¥è¯¢æ—¥å¿—ï¼Œä½†æ˜¯æ¯•ç«Ÿä¹Ÿæ˜¯åœ¨å¤šå°æœåŠ¡å™¨ä¸Šï¼Œä¸ºäº†æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œå¯ä»¥è€ƒè™‘å°†æ—¥å¿—æ±‡æ€»åˆ°ä¸€èµ·ã€‚</p><p>å¸¸ç”¨çš„ä½¿ç”¨æ–¹æ³•å°±æ˜¯åŸºäº ELK çš„æ—¥å¿—ç³»ç»Ÿï¼š</p><ol><li>ä½¿ç”¨ filebeat é‡‡é›†æ—¥å¿—æŠ¥é€åˆ° logstash</li><li>logstash è¿›è¡Œåˆ†è¯è¿‡æ»¤ç­‰å¤„ç†ï¼Œè¾“å‡ºåˆ° Elasticsearch</li><li>ä½¿ç”¨ Kinbana æˆ–è€…è‡ªå·±å¼€å‘çš„å¯è§†åŒ–å·¥å…·ä» Elasticsearch æŸ¥è¯¢æ—¥å¿—</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/aBn5LF-utuTLx.png" alt="aBn5LF-utuTLx"></p><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>æœ¬æ–‡ä¸»è¦è®°å½•è¿‘æœŸå¼€å‘è¿‡ç¨‹ä¸­çš„é‡åˆ°çš„ä¸€ç‚¹é—®é¢˜ï¼Œå¸Œæœ›å¯¹å°ä¼™ä¼´ä¹Ÿæœ‰æ‰€å¸®åŠ©ã€‚ä¸è¶³ä¹‹å¤„ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚å¦‚æœå°ä¼™ä¼´æœ‰å…¶ä»–çš„å»ºè®®æˆ–è€…è§‚ç‚¹æ¬¢è¿ç•™è¨€è®¨è®ºï¼Œå…±åŒè¿›æ­¥ã€‚</p><h4 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h4><ol><li>Log4j 2 APIï¼š<a href="https://logging.apache.org/log4j/2.x/manual/thread-context.html">https://logging.apache.org/log4j/2.x/manual/thread-context.html</a></li><li>SkyWalkingï¼š<a href="https://github.com/apache/skywalking/tree/master/docs/en/setup/service-agent/java-agent">https://github.com/apache/skywalking/tree/master/docs/en/setup/service-agent/java-agent</a></li><li>Elastic APMï¼š<a href="https://www.elastic.co/guide/en/apm/agent/java/current/log-correlation.html">https://www.elastic.co/guide/en/apm/agent/java/current/log-correlation.html</a></li><li>Dubbo filterï¼š<a href="http://dubbo.apache.org/zh-cn/docs/dev/impls/filter.html">http://dubbo.apache.org/zh-cn/docs/dev/impls/filter.html</a></li><li>æœ¬æ–‡ Dubbo filter demoï¼š<a href="https://github.com/liuzhihang/trace">https://github.com/liuzhihang/trace</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> å·¥ä½œç¬”è®° </category>
          
          <category> é“¾è·¯è¿½è¸ª </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥ä½œç¬”è®° </tag>
            
            <tag> é“¾è·¯è¿½è¸ª </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å·¥ä½œç¬”è®°ã€‘- è€å¤§é—®æˆ‘ï¼šâ€œå»ºè¡¨ä¸ºå•¥è¿˜è®¾ç½®ä¸ªè‡ªå¢ id ï¼Ÿç”¨æµæ°´å·å½“ä¸»é”®ä¸æ­£å¥½ä¹ˆï¼Ÿâ€</title>
      <link href="2020/10/11/work-trans-why-table-id.html"/>
      <url>2020/10/11/work-trans-why-table-id.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>åˆè¦å¼€å§‹æ–°é¡¹ç›®äº†ï¼Œä¸€é¡¿æ“ä½œçŒ›å¦‚è™ï¼Œæ¢³ç†æµç¨‹åŠ ç”»å›¾ã€‚è¿™ä¸ï¼Œå¼€å§‹å¯¹æµç¨‹åŠè¡¨ç»“æ„äº†ã€‚<br><br><br>æˆ‘ï¼šå§å•¦å§å•¦å§å•¦ â€¦â€¦<br>è€å¤§ï¼šè¿™ä¸ªå»ºè¡¨ä¸ºå•¥è¿˜è®¾ç½®ä¸ªè‡ªå¢ id ï¼Ÿç›´æ¥ç”¨æµæ°´å·ï¼ˆç”¨æˆ·å·/äº§å“å·ï¼‰å½“ä¸»é”®ä¸å°±è¡Œäº†ï¼Ÿ<br>æˆ‘ï¼šè¿™ä¸ªæ˜¯ DBA è§„å®šçš„ï¼Œåˆ›å»ºè¡¨ idã€create_timeã€update_time è¿™ä¸‰ä¸ªå­—æ®µéƒ½è¦æœ‰ã€‚ã€ŠJava å¼€å‘è§„èŒƒã€‹ä¹Ÿæ˜¯è¿™ä¹ˆè§„å®šçš„ã€‚<br>å°ä¼™ä¼´ï¼šï¼ˆé™„å’Œï¼‰æ˜¯çš„ï¼Œè§„å®šçš„æ˜¯è¿™æ ·çš„ï¼<br>è€å¤§ï¼šæµæ°´å·åœ¨ä½ è¿™æ˜¯å”¯ä¸€ç´¢å¼•å§ï¼Ÿè®¾ç½®æˆä¸»é”®ï¼Œè¿™æ ·å°±ä¸ç”¨ id äº†ï¼Œè¿˜å‡å°‘ä¸€æ¬¡å›è¡¨æŸ¥è¯¢ï¼Ÿ<br>æˆ‘ï¼šâ€¦â€¦ ï¼ˆè¯´çš„å¥½åƒå¾ˆæœ‰é“ç†ï¼Œå’±ä¹Ÿä¸æ•¢è¯´è¯ã€‚ï¼‰<br>è€å¤§ï¼šæ—¢ç„¶ä»–ä»¬è§„å®šäº†ï¼Œé‚£ä½ å›å»æŸ¥ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸ªè‡ªå¢ id ï¼Ÿ<br>æˆ‘ï¼šæå‡ºå°æœ¬æœ¬ï¼ˆå›å»æŸ¥èµ„æ–™~ï¼‰ã€‚</p></blockquote><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/why-id-8ZFv04.jpg" alt="why-id-8ZFv04"></p><h3 id="å»ºè¡¨è§„çº¦"><a href="#å»ºè¡¨è§„çº¦" class="headerlink" title="å»ºè¡¨è§„çº¦"></a>å»ºè¡¨è§„çº¦</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/create-db-id-Gv58zQ.png" alt="Java å¼€å‘æ‰‹å†Œ-åµ©å±±ç‰ˆ"></p><p>åœ¨å·¥ä½œä¸­ï¼Œåˆ›å»ºè¡¨çš„æ—¶å€™ï¼ŒDBA ä¹Ÿä¼šå®¡æ ¸ä¸€ä¸‹å»ºè¡¨ SQLï¼Œæ£€æŸ¥æ˜¯å¦ç¬¦åˆè§„èŒƒä»¥åŠå¸¸ç”¨å­—æ®µæ˜¯å¦è®¾ç½®ç´¢å¼•ã€‚</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`xxxx`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;è‡ªå¢ä¸»é”®&#x27;</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">current_timestamp</span>(<span class="number">3</span>) <span class="keyword">COMMENT</span> <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  <span class="string">`update_time`</span> datetime(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">current_timestamp</span>(<span class="number">3</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">current_timestamp</span>(<span class="number">3</span>) <span class="keyword">COMMENT</span> <span class="string">&#x27;æ›´æ–°æ—¶é—´&#x27;</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_create_time`</span> (<span class="string">`create_time`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_update_time`</span> (<span class="string">`update_time`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">5</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">&#x27;è¡¨æ³¨é‡Š&#x27;</span>;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åœ¨æˆ‘ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œæµæ°´å·éƒ½æ˜¯å•ç‹¬è®¾ç½®äº†ä¸€ä¸ªå­—æ®µï¼Œæ¯”å¦‚å« trans_noï¼Œä½†æ˜¯è¿™æ¬¡å°±é‡åˆ°äº†ç–‘é—®ï¼štrans_no æ—¢ç„¶æ˜¯å”¯ä¸€çš„ï¼Œé‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ trans_no å½“åš id å‘¢ï¼Ÿ</p><p>ä¸‹é¢å¼€å§‹é€šè¿‡æŸ¥é˜…ç›¸å…³èµ„æ–™ï¼Œä¸€æ­¥ä¸€æ­¥çš„äº†è§£æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/why-id-2-pMeutc.jpg" alt="why-id-2-pMeutc"></p><h3 id="ä¸»é”®"><a href="#ä¸»é”®" class="headerlink" title="ä¸»é”®"></a>ä¸»é”®</h3><h4 id="ä»€ä¹ˆæ˜¯ä¸»é”®"><a href="#ä»€ä¹ˆæ˜¯ä¸»é”®" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¸»é”®"></a>ä»€ä¹ˆæ˜¯ä¸»é”®</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/MySQL-primary-key-z64UFB.png" alt="MySQL-primary-key-z64UFB"></p><p><a href="https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_primary_key">https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_primary_key</a></p><p>è¿™æ®µå®šä¹‰å’±ä»¬ä¸»è¦å…³æ³¨æœ€åä¸€å¥ï¼š</p><blockquote><p>When choosing primary key values, consider using arbitrary values (aÂ <strong>synthetic key</strong>) rather than relying on values derived from some other source (aÂ <strong>natural key</strong>).</p></blockquote><p>æ„æ€æ˜¯åˆ›å»ºä¸»é”®çš„æ—¶å€™å°½é‡ä½¿ç”¨ MySQL è‡ªå¢ä¸»é”®è€Œä¸æ˜¯ä½¿ç”¨ä¸šåŠ¡ç”Ÿæˆçš„å€¼å½“åšä¸»é”®ã€‚</p><h4 id="ä¸»é”®çš„ç‰¹å¾"><a href="#ä¸»é”®çš„ç‰¹å¾" class="headerlink" title="ä¸»é”®çš„ç‰¹å¾"></a>ä¸»é”®çš„ç‰¹å¾</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/MySQL-primary-key-1-QDuU4H.png" alt="MySQL-primary-key-1-QDuU4H"></p><p>ç®€è€Œè¨€ä¹‹ï¼š</p><p>éç©ºã€å”¯ä¸€ã€å°‘æ›´æ”¹æˆ–ä¸æ›´æ”¹ ã€‚</p><h4 id="å¦‚ä½•æ·»åŠ ä¸»é”®"><a href="#å¦‚ä½•æ·»åŠ ä¸»é”®" class="headerlink" title="å¦‚ä½•æ·»åŠ ä¸»é”®"></a>å¦‚ä½•æ·»åŠ ä¸»é”®</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/hfPeDL-r5M5YU.png" alt="hfPeDL-r5M5YU"></p><p>å¯ä»¥åœ¨ create åˆ›å»ºè¡¨çš„æ—¶å€™æŒ‡å®šï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ alter è¯­å¥åé¢æ·»åŠ ä¸»é”®ï¼Œä¸è¿‡å®˜æ–¹å»ºè®®åœ¨åˆ›å»ºè¡¨æ—¶å°±æŒ‡å®šã€‚</p><h4 id="ä¸ºä»€ä¹ˆè¦æ·»åŠ ä¸»é”®"><a href="#ä¸ºä»€ä¹ˆè¦æ·»åŠ ä¸»é”®" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æ·»åŠ ä¸»é”®"></a>ä¸ºä»€ä¹ˆè¦æ·»åŠ ä¸»é”®</h4><ol><li>ä¸»é”®å¯ä»¥å”¯ä¸€æ ‡è¯†è¿™ä¸€è¡Œæ•°æ®ï¼Œä»è€Œä¿è¯åœ¨åˆ é™¤æ›´æ–°æ“ä½œæ—¶ï¼Œåªæ˜¯æ“ä½œè¿™ä¸€è¡Œæ•°æ®ã€‚</li><li>ç´¢å¼•éœ€è¦ï¼Œæ¯ä¸ª InnoDB è¡¨åˆæœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç´¢å¼•ï¼Œå³èšç°‡ç´¢å¼•ï¼Œç”¨æ¥å­˜å‚¨è¡Œæ•°æ®ã€‚é€šå¸¸ï¼Œèšç°‡ç´¢å¼•å’Œä¸»é”®åŒä¹‰ã€‚<ol><li>å£°æ˜ä¸»é”®ï¼ŒInnoDB ä¼šå°†ä¸»é”®ä½œä¸ºèšç°‡ç´¢å¼•ã€‚</li><li>æœªå£°æ˜æ—¶ï¼Œä¼šåœ¨ UNIQUE æ‰€æœ‰é”®åˆ—æ‰€åœ¨ä½ç½®æ‰¾åˆ°ç¬¬ä¸€ä¸ªç´¢å¼•ï¼ŒNOT NULL å¹¶å°†å…¶ä½œä¸ºèšç°‡ç´¢å¼•</li><li>æœªå£°æ˜ä¸”æ‰¾ä¸åˆ°åˆé€‚çš„ UNIQUE ç´¢å¼•ï¼Œåˆ™å†…éƒ¨ç”Ÿæˆä¸€ä¸ªéšè—çš„èšç°‡ç´¢å¼• GEN_CLUST_INDEXï¼Œè¿™ä¸ªéšè—çš„è¡Œ ID æ˜¯ 6 å­—èŠ‚ä¸”å•è°ƒå¢åŠ ã€‚</li></ol></li></ol><p>å›¾ -&gt; é‚£ä»€ä¹ˆæ˜¯ç´¢å¼•</p><h3 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h3><p>è¿™é‡Œä»…ä»‹ç» InnoDB å¼•æ“ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œå¹¶ä¸”ä»‹ç»çš„ç›¸å¯¹æ¯”è¾ƒç®€å•ã€‚</p><h4 id="ç´¢å¼•åˆ†ç±»"><a href="#ç´¢å¼•åˆ†ç±»" class="headerlink" title="ç´¢å¼•åˆ†ç±»"></a>ç´¢å¼•åˆ†ç±»</h4><ol><li>èšç°‡ç´¢å¼•ï¼šè¡¨å­˜å‚¨æ˜¯æ ¹æ®ä¸»é”®åˆ—çš„å€¼ç»„ç»‡çš„ï¼Œä»¥åŠ å¿«æ¶‰åŠä¸»é”®åˆ—çš„æŸ¥è¯¢å’Œæ’åºã€‚åœ¨ä»‹ç»ä¸»é”®æ—¶ä¹Ÿå¯¹èšç°‡ç´¢å¼•è¿›è¡Œäº†ä»‹ç»ã€‚</li><li>äºŒçº§ç´¢å¼•ï¼šä¹Ÿå¯ä»¥å«è¾…åŠ©ç´¢å¼•ï¼Œåœ¨è¾…åŠ©ç´¢å¼•ä¸­ä¼šè®°å½•å¯¹åº”çš„ä¸»é”®åˆ—ä»¥åŠè¾…åŠ©ç´¢å¼•åˆ—ã€‚æ ¹æ®è¾…åŠ©ç´¢å¼•è¿›è¡Œæœç´¢çš„æ—¶å€™ï¼Œä¼šå…ˆæ ¹æ®è¾…åŠ©ç´¢å¼•è·å–åˆ°å¯¹åº”çš„ä¸»é”®åˆ—ï¼Œç„¶åå†æ ¹æ®ä¸»é”®å»èšç°‡ç´¢å¼•é‡Œé¢æœç´¢ã€‚<strong>ä¸€èˆ¬ä¸å»ºè®®ä¸»é”®å¾ˆé•¿ï¼Œå› ä¸ºä¸»é”®å¾ˆé•¿è¾…åŠ©ç´¢å¼•å°±ä¼šä½¿ç”¨æ›´å¤šçš„ç©ºé—´ã€‚</strong></li></ol><blockquote><p><strong>è¡¥å……ï¼š</strong></p><p>å›è¡¨ï¼šå…ˆåœ¨äºŒçº§ç´¢å¼•æŸ¥è¯¢åˆ°å¯¹åº”çš„ä¸»é”®å€¼ï¼Œç„¶åæ ¹æ®ä¸»é”®å†å»èšç°‡ç´¢å¼•é‡Œé¢å–æŸ¥è¯¢ã€‚<br>ç´¢å¼•è¦†ç›–ï¼šäºŒçº§ç´¢å¼•è®°å½•äº†ä¸»é”®åˆ—å’ŒäºŒçº§ç´¢å¼•åˆ—ï¼Œå¦‚æœæˆ‘åªæŸ¥è¯¢ä¸»é”®åˆ—çš„å€¼å’ŒäºŒçº§ç´¢å¼•åˆ—çš„å€¼ï¼Œé‚£å°±ä¸éœ€è¦å›è¡¨äº†ã€‚</p></blockquote><h4 id="ç´¢å¼•çš„ç‰©ç†ç»“æ„"><a href="#ç´¢å¼•çš„ç‰©ç†ç»“æ„" class="headerlink" title="ç´¢å¼•çš„ç‰©ç†ç»“æ„"></a>ç´¢å¼•çš„ç‰©ç†ç»“æ„</h4><p>InnoDB ä½¿ç”¨çš„ B+ æ•°æ•°æ®ç»“æ„ï¼Œæ ¹æ®èšç°‡ç´¢å¼•å€¼ï¼ˆä¸»é”®/UNQIUE/æˆ–è€…è‡ªå·±ç”Ÿæˆï¼‰æ„å»ºä¸€é¢— B+ æ ‘ï¼Œå¶å­èŠ‚ç‚¹ä¸­å­˜æ”¾è¡Œè®°å½•æ•°æ®ï¼Œæ‰€ä»¥æ¯ä¸ªå¶å­èŠ‚ç‚¹ä¹Ÿå¯ä»¥å«æ•°æ®é¡µã€‚æ¯ä¸ªæ•°æ®é¡µå¤§å°é»˜è®¤ä¸º 16kï¼Œæ”¯æŒè‡ªå®šä¹‰ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/B+Tree-UgFQjS.png" alt="B+Tree-UgFQjS"></p><h4 id="æ•°æ®çš„æ’å…¥"><a href="#æ•°æ®çš„æ’å…¥" class="headerlink" title="æ•°æ®çš„æ’å…¥"></a>æ•°æ®çš„æ’å…¥</h4><p>å½“æ•°æ®æ’å…¥æ—¶ï¼ŒInnoDB ä¼šä½¿é¡µé¢ 1/16 ç©ºé—²ï¼Œä»¥å¤‡å°†æ¥æ’å…¥å’Œæ›´æ–°ç´¢å¼•è®°å½•ã€‚</p><ol><li>é¡ºåºæ’å…¥ï¼ˆå‡åºæˆ–é™åºï¼‰ï¼šä¼šå°†ç´¢å¼•é¡µå‰©ä½™çš„å¤§çº¦ 15/16 è£…æ»¡</li><li>éšæœºæ’å…¥ï¼šåªä¼šä½¿ç”¨å®¹é‡çš„ 1/2 åˆ° 15/16</li></ol><p>åœ¨éšæœºæ’å…¥ä¸­ï¼Œä¼šé¢‘ç¹çš„ç§»åŠ¨ã€åˆ†é¡µï¼Œä»è€Œé€ æˆå¤§é‡çš„ç¢ç‰‡ï¼Œå¹¶ä¸”ä½¿ç´¢å¼•æ ‘ä¸å¤Ÿç´§å‡‘ã€‚è€Œä½¿ç”¨é¡ºåºæ’å…¥çš„æ–¹å¼ï¼Œåˆ™æ•°æ®æ¯”è¾ƒç´§å‡‘ï¼Œæœ‰æ›´é«˜çš„ç©ºé—´åˆ©ç”¨ç‡ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p><strong>Q: ä»€ä¹ˆæ˜¯å›è¡¨å’Œç´¢å¼•è¦†ç›–ï¼Ÿ</strong></p><p><strong>A:</strong></p><ol><li>å›è¡¨ï¼šå…ˆåœ¨äºŒçº§ç´¢å¼•æŸ¥è¯¢åˆ°å¯¹åº”çš„ä¸»é”®å€¼ï¼Œç„¶åæ ¹æ®ä¸»é”®å†å»èšç°‡ç´¢å¼•é‡Œé¢å–æŸ¥è¯¢ã€‚</li><li>ç´¢å¼•è¦†ç›–ï¼šäºŒçº§ç´¢å¼•è®°å½•äº†ä¸»é”®åˆ—å’ŒäºŒçº§ç´¢å¼•åˆ—ï¼Œå¦‚æœæˆ‘åªæŸ¥è¯¢ä¸»é”®åˆ—çš„å€¼å’ŒäºŒçº§ç´¢å¼•åˆ—çš„å€¼ï¼Œé‚£å°±ä¸éœ€è¦å›è¡¨äº†ã€‚</li></ol><p><strong>Q: ä¸ºä»€ä¹ˆè¦è®¾ç½®è‡ªå¢ä¸»é”® id ï¼Ÿ</strong></p><p><strong>A:</strong></p><ol><li>å¯ä»¥å”¯ä¸€æ ‡è¯†ä¸€è¡Œæ•°æ®ï¼Œåœ¨ InnoDB æ„å»ºç´¢å¼•æ ‘çš„æ—¶å€™ä¼šä½¿ç”¨ä¸»é”®ã€‚</li><li>è‡ªå¢ id æ˜¯é¡ºåºçš„ï¼Œå¯ä»¥ä¿è¯ç´¢å¼•æ ‘ä¸Šçš„æ•°æ®æ¯”è¾ƒç´§å‡‘ï¼Œæœ‰æ›´é«˜çš„ç©ºé—´åˆ©ç”¨ç‡ä»¥åŠå‡å°‘æ•°æ®é¡µçš„åˆ†è£‚åˆå¹¶ç­‰æ“ä½œï¼Œæé«˜æ•ˆç‡ã€‚</li><li>ä¸€èˆ¬ä½¿ç”¨æ‰‹æœºå·ã€èº«ä»½è¯å·ä½œä¸ºä¸»é”®ç­‰å¹¶ä¸èƒ½ä¿è¯é¡ºåºæ€§ã€‚</li><li>æµæ°´å·ä¸€èˆ¬ç›¸å¯¹è¾ƒé•¿ï¼Œæ¯”å¦‚ 28 ä½ï¼Œ32 ä½ç­‰ï¼Œè¿‡é•¿çš„è¯ä¼šäºŒçº§ç´¢å¼•å ç”¨ç©ºé—´è¾ƒå¤šã€‚åŒæ—¶ä¸ºäº†ä¸šåŠ¡éœ€æ±‚ï¼Œæµæ°´å·å…·æœ‰ä¸€å®šçš„éšæœºæ€§ã€‚</li></ol><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>æœ¬æ–‡ä¸»è¦é€šè¿‡æŸ¥é˜…èµ„æ–™ï¼Œäº†è§£ä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸€ä¸ªå’Œä¸šåŠ¡æ— å…³çš„è‡ªå¢ id ç”¨æ¥å½“åšä¸»é”®ï¼Œå¾ˆå¤šå†…å®¹æ¯”è¾ƒæµ…æ˜¾ï¼Œæ¯”å¦‚ InnoDB çš„ B+ æ ‘ï¼Œé¡µåˆ†è£‚åŠé¡µåˆå¹¶ï¼Œæ’å…¥è¿‡ç¨‹ç­‰éƒ½æ²¡æœ‰è¿›è¡Œæ·±å…¥ç ”ç©¶ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥æ›´æ·±å…¥çš„ç ”ç©¶ä¸‹ã€‚</p><p>åŒæ—¶åœ¨å»ºè¡¨æ—¶é™¤äº†è¦è®¾ç½®ä¸€ä¸ªè‡ªå¢ id ç”¨æ¥å½“åšä¸»é”®ï¼Œå°ä¼™ä¼´ä»¬åœ¨ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­æ˜¯å¦ä¹Ÿä¼šé‡åˆ°ä¸€ç§æƒ…å†µï¼šç”¨æˆ·çš„æ³¨é”€ï¼Œæ•°æ®çš„åˆ é™¤ç­‰éƒ½æ˜¯è¿›è¡Œçš„é€»è¾‘åˆ é™¤ï¼Œè€Œä¸æ˜¯ç‰©ç†åˆ é™¤ã€‚</p><p>æœ¬ç¯‡æ–‡ç« ä»‹ç»æ¯”è¾ƒç®€é™‹ï¼Œä¸è¶³ä¹‹å¤„ï¼Œå¸Œæœ›å¤§å®¶å¤šå¤šæŒ‡æ­£ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å·¥ä½œç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥ä½œç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- åŸºäºé“¾è¡¨çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ— â€”â€” LinkedBlockingQueue</title>
      <link href="2020/10/04/source-code-linkedblockingqueue.html"/>
      <url>2020/10/04/source-code-linkedblockingqueue.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>ä¸Šä¸€èŠ‚çœ‹äº†åŸºäºæ•°æ®çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ— ArrayBlockingQueue çš„æºç ï¼Œé€šè¿‡é˜…è¯»æºç äº†è§£åˆ°åœ¨ ArrayBlockingQueue ä¸­å…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—æ“ä½œéƒ½æ˜¯ç”¨äº† ReentrantLock æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ä¸‹é¢å’±ä»¬çœ‹å¦ä¸€ç§æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼šLinkedBlockingQueueã€‚</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>ä¸€ä¸ªåŸºäºé“¾æ¥èŠ‚ç‚¹çš„ï¼Œå¯é€‰ç»‘å®šçš„ BlockingQueue é˜»å¡é˜Ÿåˆ—ã€‚</p><p>å¯¹å…ƒç´  FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰è¿›è¡Œæ’åºã€‚é˜Ÿåˆ—çš„å¤´éƒ¨æ˜¯å·²åœ¨é˜Ÿåˆ—ä¸­åœç•™æœ€é•¿æ—¶é—´çš„å…ƒç´ ã€‚é˜Ÿåˆ—çš„å°¾éƒ¨æ˜¯æœ€çŸ­æ—¶é—´å‡ºç°åœ¨é˜Ÿåˆ—ä¸­çš„å…ƒç´ ã€‚å°†æ–°å…ƒç´ æ’å…¥é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶æ£€ç´¢é˜Ÿåˆ—æ“ä½œè·å–é˜Ÿåˆ—å¼€å¤´çš„å…ƒç´ ã€‚</p><p>åŸºäºè¿è¡¨çš„é˜Ÿåˆ—é€šå¸¸å…·æœ‰æ¯”åŸºäºæ•°ç»„çš„é˜Ÿåˆ—æœ‰æ›´é«˜çš„ååé‡ï¼Œä½†æ˜¯å¤§å¤šæ•°å¹¶å‘åº”ç”¨ç¨‹åºä¸­çš„å¯é¢„æµ‹æ€§è¾ƒå·®ã€‚</p><h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedBlockingQueueTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LinkedBlockingQueue&lt;String&gt; QUEUE = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…¥é˜Ÿåˆ—</span></span><br><span class="line">        QUEUE.put(<span class="string">&quot;put å…¥é˜Ÿåˆ—, é˜Ÿåˆ—æ»¡åˆ™ä¼šé˜»å¡ç­‰å¾…&quot;</span>);</span><br><span class="line"></span><br><span class="line">        QUEUE.add(<span class="string">&quot;add å…¥é˜Ÿåˆ—, é˜Ÿåˆ—æ»¡åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸&quot;</span>);</span><br><span class="line"></span><br><span class="line">        QUEUE.offer(<span class="string">&quot;offer å…¥é˜Ÿåˆ—, é˜Ÿåˆ—æ»¡ä¼šè¿”å› false&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‡ºé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—ç©ºè¿”å› null</span></span><br><span class="line">        String poll = QUEUE.poll();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—ç©ºä¼šé˜»å¡ç­‰å¾…</span></span><br><span class="line">        String take = QUEUE.take();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»…ä»…çœ‹ä¸€ä¸‹æœ€æ—©å…¥é˜Ÿåˆ—çš„å…ƒç´ </span></span><br><span class="line">        String peek = QUEUE.peek();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜ç–‘é—®"><a href="#é—®é¢˜ç–‘é—®" class="headerlink" title="é—®é¢˜ç–‘é—®"></a>é—®é¢˜ç–‘é—®</h4><ol><li>LinkedBlockingQueue çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>LinkedBlockingQueue å’Œ ArrayBlockingQueue çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</li></ol><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/LinkedBlockingQueue-uml-Ma14n3.png" alt="LinkedBlockingQueue-uml-Ma14n3"></p><h4 id="å‚æ•°ä»‹ç»"><a href="#å‚æ•°ä»‹ç»" class="headerlink" title="å‚æ•°ä»‹ç»"></a>å‚æ•°ä»‹ç»</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    E item;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * One of:</span></span><br><span class="line"><span class="comment">    * - çœŸæ­£çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">    * - æœ‰å€¼ï¼Œè¡¨ç¤ºåç»§è€…æ˜¯head.next</span></span><br><span class="line"><span class="comment">    * - nullï¼Œè¡¨ç¤ºæ²¡æœ‰åç»§ï¼ˆè¿™æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼‰</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    Node&lt;E&gt; next;</span><br><span class="line"></span><br><span class="line">    Node(E x) &#123; item = x; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåœ¨ LinkedBlockingQueue ä¸­æœ‰ä¸€ä¸ªé™æ€å†…éƒ¨ç±» Node<E> æ”¯æŒæ³›å‹ï¼Œä¸‹é¢çœ‹ä¸‹å…¶ä»–å­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** åˆå§‹å®¹é‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¸ºInteger.MAX_VALUE */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> capacity;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å½“å‰å…ƒç´ æ•° */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* é“¾è¡¨å¤´</span></span><br><span class="line"><span class="comment">* ä¸å˜çš„æ˜¯: head.item == null</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; head;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* é“¾è¡¨å°¾</span></span><br><span class="line"><span class="comment">* ä¸å˜çš„æ˜¯: last.next == null</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node&lt;E&gt; last;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æ‰§è¡Œ take, poll ç­‰æ“ä½œéœ€è¦è·å–åˆ° takeLock */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** ç­‰å¾…æ‰§è¡Œ take æ“ä½œçš„çº¿ç¨‹ï¼Œä¼šæ”¾å…¥è¿™ä¸ªæ¡ä»¶é˜Ÿåˆ— */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty = takeLock.newCondition();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æ‰§è¡Œ put, offer ç­‰æ“ä½œéœ€è¦è·å–åˆ° putLock */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** ç­‰å¾…æ‰§è¡Œ put æ“ä½œçš„çº¿ç¨‹ï¼Œä¼šè¢«æ”¾å…¥è¿™ä¸ªæ¡ä»¶é˜Ÿåˆ— */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notFull = putLock.newCondition();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºæ—¶æŒ‡å®šå®¹é‡</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">    last = head = <span class="keyword">new</span> Node&lt;E&gt;(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é€šè¿‡æ„é€ å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œåœ¨åˆå§‹åŒ– LinkedBlockingQueue æ—¶ï¼Œå¦‚æœä¸ä¼ å…¥å®¹é‡åˆ™ä¼šé»˜è®¤æŒ‡å®š Integer.MAX_VALUEã€‚</p><h4 id="æ·»åŠ å…ƒç´ "><a href="#æ·»åŠ å…ƒç´ " class="headerlink" title="æ·»åŠ å…ƒç´ "></a>æ·»åŠ å…ƒç´ </h4><p>add æ–¹æ³•æ˜¯ç›´æ¥è°ƒç”¨çš„çˆ¶ç±» AbstractQueue çš„æ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨çš„ LinkedBlockingQueue è‡ªå·±å®ç°çš„ offer æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (offer(e))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Queue full&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦é˜…è¯»çš„è¿˜æ˜¯ LinkedBlockingQueue çš„ put å’Œ offer æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// æ’å…¥å…ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// Note: æ‰€æœ‰put / take / etcä¸­çš„çº¦å®šæ˜¯é¢„è®¾æœ¬åœ°å˜é‡</span></span><br><span class="line">    <span class="comment">// ä¿æŒè®¡æ•°ä¸ºè´Ÿè¡¨ç¤ºå¤±è´¥ï¼Œé™¤éç½®ä½ã€‚</span></span><br><span class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">    Node&lt;E&gt; node = <span class="keyword">new</span> Node&lt;E&gt;(e);</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</span><br><span class="line">    <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</span><br><span class="line">    putLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">       </span><br><span class="line">        <span class="comment">// å¦‚æœå·²ç»åˆ°æœ€å¤§å®¹é‡ï¼Œåˆ™ç­‰å¾… </span></span><br><span class="line">        <span class="keyword">while</span> (count.get() == capacity) &#123;</span><br><span class="line">            notFull.await();</span><br><span class="line">        &#125;</span><br><span class="line">        enqueue(node);</span><br><span class="line">        <span class="comment">// æ€»æ•°è¿›è¡Œå¢åŠ ï¼Œ è¿”å›çš„æ˜¯å…ˆå‰çš„å®¹é‡</span></span><br><span class="line">        c = count.getAndIncrement();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦å”¤é†’å…¥é˜Ÿåˆ—é˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">            notFull.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// å”¤é†’å› è°ƒç”¨ notEmpty çš„ await æ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">        signalNotEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸ºç©ºæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»åˆ°æœ€å¤§å®¹é‡ï¼Œè¿”å› false</span></span><br><span class="line">    <span class="keyword">if</span> (count.get() == capacity)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">    Node&lt;E&gt; node = <span class="keyword">new</span> Node&lt;E&gt;(e);</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</span><br><span class="line">    putLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (count.get() &lt; capacity) &#123;</span><br><span class="line">            enqueue(node);</span><br><span class="line">            c = count.getAndIncrement();</span><br><span class="line">            <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">                notFull.signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">        signalNotEmpty();</span><br><span class="line">    <span class="keyword">return</span> c &gt;= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢ä¸¤æ®µä»£ç å¯ä»¥çœ‹å‡º put å’Œ offer çš„æœ€å¤§åŒºåˆ«åœ¨äºæ˜¯å¦é˜»å¡ã€‚ put æ–¹æ³•å½“é˜Ÿåˆ—è¾¾åˆ°æŒ‡å®šå®¹é‡æ—¶ï¼Œä¼šé˜»å¡ï¼Œç­‰å¾…æœ‰å…ƒç´ å‡ºé˜Ÿåˆ—ã€‚è€Œ offer æ–¹æ³•ä¼šç›´æ¥è¿”å› falseã€‚</p><p>åŒæ—¶ä¸¤ä¸ªæ–¹æ³•æ“ä½œå…ƒç´ å…¥é˜Ÿåˆ—éƒ½æ˜¯è°ƒç”¨çš„ enqueue(node) æ–¹æ³•ï¼Œä¸‹é¢ä¸€èµ·çœ‹ä¸‹ enqueue æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Node&lt;E&gt; node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert putLock.isHeldByCurrentThread();</span></span><br><span class="line">    <span class="comment">// assert last.next == null;</span></span><br><span class="line">    last = last.next = node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ enqueue æ–¹æ³•ä¸­ï¼Œç›´æ¥æŒ‡å®šå½“å‰å°¾èŠ‚ç‚¹çš„ next ä¸ºä¼ å…¥çš„å…ƒç´ å³å¯ã€‚</p><h4 id="è·å–å…ƒç´ "><a href="#è·å–å…ƒç´ " class="headerlink" title="è·å–å…ƒç´ "></a>è·å–å…ƒç´ </h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—ä¸ºç©ºè¿”å› null</span></span><br><span class="line">    <span class="keyword">if</span> (count.get() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    E x = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">this</span>.takeLock;</span><br><span class="line">    takeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (count.get() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            x = dequeue();</span><br><span class="line">            <span class="comment">// å‡å°‘é˜Ÿåˆ—å…ƒç´ è®¡æ•°ï¼Œè¿”å›çš„æ˜¯æ—§å€¼</span></span><br><span class="line">            c = count.getAndDecrement();</span><br><span class="line">            <span class="keyword">if</span> (c &gt; <span class="number">1</span>)</span><br><span class="line">            <span class="comment">// æ—§å€¼å¤§äº 1 ï¼Œå°±æ˜¯å½“å‰å¤§äº 0</span></span><br><span class="line">            <span class="comment">// å”¤é†’è°ƒç”¨ notEmpty.await ç­‰å¾…çš„çº¿ç¨‹</span></span><br><span class="line">                notEmpty.signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c == capacity)</span><br><span class="line">        <span class="comment">// å¦‚æœæ—§å€¼ç­‰äº capacity è¯´æ˜å½“å‰ç©ºäº†ä¸€ä¸ªä½ç½®</span></span><br><span class="line">        signalNotFull();</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    E x;</span><br><span class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">this</span>.takeLock;</span><br><span class="line">    takeLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// é˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">while</span> (count.get() == <span class="number">0</span>) &#123;</span><br><span class="line">            notEmpty.await();</span><br><span class="line">        &#125;</span><br><span class="line">        x = dequeue();</span><br><span class="line">        c = count.getAndDecrement();</span><br><span class="line">        <span class="keyword">if</span> (c &gt; <span class="number">1</span>)</span><br><span class="line">            notEmpty.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c == capacity)</span><br><span class="line">        signalNotFull();</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡º poll å’Œ take æ–¹æ³•é€»è¾‘å¤§è‡´ç›¸åŒã€‚åŒºåˆ«å°±æ˜¯åœ¨å½“å‰é˜Ÿåˆ—ä¸ºç©ºæ—¶çš„å¤„ç†é€»è¾‘ã€‚poll åœ¨å½“å‰é˜Ÿåˆ—ä¸ºç©ºæ—¶è¿”å› nullï¼Œtake ä¼šé˜»å¡ç­‰å¾…ï¼ŒçŸ¥é“å½“å‰é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ ã€‚</p><p>poll å’Œ take éƒ½è¯•ç”¨ dequeue() æ–¹æ³•ä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">dequeue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert takeLock.isHeldByCurrentThread();</span></span><br><span class="line">    <span class="comment">// assert head.item == null;</span></span><br><span class="line">    Node&lt;E&gt; h = head;</span><br><span class="line">    Node&lt;E&gt; first = h.next;</span><br><span class="line">    h.next = h; <span class="comment">// help GC</span></span><br><span class="line">    head = first;</span><br><span class="line">    E x = first.item;</span><br><span class="line">    first.item = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dequeue() æ–¹æ³•é€»è¾‘å°±æ˜¯è·å–å¤´èŠ‚ç‚¹ï¼Œå¹¶å°† head æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><h4 id="æŸ¥çœ‹å…ƒç´ "><a href="#æŸ¥çœ‹å…ƒç´ " class="headerlink" title="æŸ¥çœ‹å…ƒç´ "></a>æŸ¥çœ‹å…ƒç´ </h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">peek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count.get() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">this</span>.takeLock;</span><br><span class="line">    takeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Node&lt;E&gt; first = head.next;</span><br><span class="line">        <span class="keyword">if</span> (first == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> first.item;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>peek() æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œç›´æ¥è·å– head çš„å…ƒç´ å€¼å³å¯ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p><strong>Q: LinkedBlockingQueue çš„å®ç°åŸç†ï¼Ÿ</strong></p><p><strong>A:</strong> LinkedBlockingQueue æ˜¯åŸºäºé“¾è¡¨å®ç°çš„ï¼Œå†…éƒ¨ä½¿ç”¨ ReentrantLock äº’æ–¥é”ï¼Œé˜²æ­¢å¹¶å‘æ”¾ç½®å…ƒç´ æˆ–è€…å–å‡ºå…ƒç´ çš„å†²çªé—®é¢˜ã€‚</p><ol><li>takeã€pollã€peek ç­‰ä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„æ“ä½œå…±ç”¨ takeLock é”ã€‚</li><li>addã€putã€offer ç­‰å‘é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ çš„æ“ä½œå…±åŒ putLock é”ã€‚</li><li>notEmpty å’Œ notFull æ˜¯ Condition ç±»å‹ï¼Œåœ¨ take å’Œ put æ“ä½œæ—¶ï¼Œå¦‚æœå¦‚æœé˜Ÿåˆ—ä¸ºç©ºæˆ–è€…é˜Ÿåˆ—å·²æ»¡ï¼Œä¼šè°ƒç”¨ç›¸åº”çš„ await å°†çº¿ç¨‹æ”¾å…¥æ¡ä»¶é˜Ÿåˆ—ã€‚</li></ol><p><strong>Q: å…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—æ–¹æ³•ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>add</td><td>æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡äº†ï¼Œæ·»åŠ å¤±è´¥æŠ›å‡ºé—äº§</td></tr><tr><td>offer</td><td>æ·»åŠ å…ƒç´ ï¼Œ é˜Ÿåˆ—æ»¡äº†ï¼Œæ·»åŠ å¤±è´¥ï¼Œè¿”å› false</td></tr><tr><td>put</td><td>æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡äº†ï¼Œé˜»å¡ç­‰å¾…</td></tr><tr><td></td><td></td></tr><tr><td>poll</td><td>å¼¹å‡ºå…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©ºåˆ™è¿”å› null</td></tr><tr><td>take</td><td>å¼¹å‡ºå…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©ºåˆ™ç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ </td></tr><tr><td></td><td></td></tr><tr><td>peek</td><td>æŸ¥çœ‹é˜Ÿåˆ—ä¸­æ”¾å…¥æœ€æ—©çš„ä¸€ä¸ªå…ƒç´ </td></tr></tbody></table><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>LinkedBlockingQueue ä½¿ç”¨å’Œ ArrayBlockingQueue å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå†…éƒ¨å®ç°éƒ½æ˜¯ä½¿ç”¨çš„ ReentrantLockï¼Œå¯ä»¥å¯¹ç…§ç€é˜…è¯»ã€‚åŒæ—¶ Condition è¿™å—ä¹Ÿéœ€è¦ç€é‡äº†è§£ä¸€ä¸‹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- AQS éƒ½çœ‹å®Œäº†ï¼ŒCondition åŸç†å¯ä¸èƒ½å°‘ï¼</title>
      <link href="2020/10/01/source-code-condition.html"/>
      <url>2020/10/01/source-code-condition.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>åœ¨ä»‹ç» AQS æ—¶ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå†…éƒ¨ç±»å«åš ConditionObjectï¼Œå½“æ—¶å¹¶æ²¡æœ‰è¿›è¡Œä»‹ç»ï¼Œå¹¶ä¸”åœ¨åç»­é˜…è¯»æºç æ—¶ï¼Œä¼šå‘ç°å¾ˆå¤šåœ°æ–¹ç”¨åˆ°äº† Condition ï¼Œè¿™æ—¶å°±ä¼šå¾ˆè¯§å¼‚ï¼Œè¿™ä¸ª Condition åˆ°åº•æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿé‚£ä»Šå¤©å°±é€šè¿‡é˜…è¯» Condition æºç ï¼Œä»è€Œå¼„æ¸…æ¥š Condition åˆ°åº•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿå½“ç„¶é˜…è¯»è¿™ç¯‡æ–‡ç« çš„æ—¶å€™å¸Œæœ›ä½ å·²ç»é˜…è¯»äº† AQSã€ReentrantLock ä»¥åŠ LockSupport çš„ç›¸å…³æ–‡ç« æˆ–è€…æœ‰ä¸€å®šçš„äº†è§£ï¼ˆ<del>å½“ç„¶å°ä¼™ä¼´ä¹Ÿå¯ä»¥ç›´æ¥è·³åˆ°æ–‡æœ«çœ‹æ€»ç»“</del>ï¼‰ã€‚</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>Object çš„ç›‘è§†å™¨æ–¹æ³•ï¼šwaitã€notifyã€notifyAll åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œåœ¨å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œå¿…é¡»å…ˆä½¿ç”¨ synchronized è·å–åˆ°é”ï¼Œç„¶åæ‰å¯ä»¥è°ƒç”¨ Object çš„ waitã€notifyã€‚</p><p>Condition çš„ä½¿ç”¨ï¼Œç›¸å½“äºç”¨ Lock æ›¿æ¢äº† synchronizedï¼Œç„¶åç”¨ Condition æ›¿æ¢ Object çš„ç›‘è§†å™¨æ–¹æ³•ã€‚</p><p>Conditionsï¼ˆä¹Ÿç§°ä¸ºæ¡ä»¶é˜Ÿåˆ—æˆ–æ¡ä»¶å˜é‡ï¼‰ä¸ºä¸€ç§çº¿ç¨‹æä¾›äº†ä¸€ç§æš‚åœæ‰§è¡Œï¼ˆç­‰å¾…ï¼‰ï¼Œç›´åˆ°å¦ä¸€çº¿ç¨‹é€šçŸ¥è¢«é˜»å¡çš„çº¿ç¨‹ï¼ŒæŸäº›çŠ¶æ€æ¡ä»¶ç°åœ¨å¯èƒ½ä¸ºçœŸã€‚</p><p>å› ä¸ºè®¿é—®åˆ°æ­¤å…±äº«çŠ¶æ€ä¿¡æ¯å‘ç”Ÿåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ï¼Œå› æ­¤å¿…é¡»å¯¹å…¶è¿›è¡Œä¿æŠ¤ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨æŸç§å½¢å¼çš„é”ã€‚ç­‰å¾…æ¡ä»¶æä¾›çš„å…³é”®å±æ€§æ˜¯å®ƒä»¥åŸå­åœ°é‡Šæ”¾äº†å…³è”çš„é”ï¼Œå¹¶ä¸”æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œå°±åƒ Object.wait ä¸€æ ·ã€‚</p><p>Condition å®ä¾‹æœ¬è´¨ä¸Šè¦ç»‘å®šåˆ°é”ã€‚ ä¸ºäº†è·å¾— Condition å®ä¾‹ï¼Œä¸€èˆ¬ä½¿ç”¨ Lock å®ä¾‹çš„ newCondition() æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">Condition con = lock.newCondition();</span><br></pre></td></tr></table></figure><h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundedBuffer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="comment">// condition å®ä¾‹ä¾èµ–äº lock å®ä¾‹</span></span><br><span class="line">    <span class="keyword">final</span> Condition notFull = lock.newCondition();</span><br><span class="line">    <span class="keyword">final</span> Condition notEmpty = lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">new</span> Object[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> putPtr, takePtr, count;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object x)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//  put æ—¶åˆ¤æ–­æ˜¯å¦å·²ç»æ»¡äº†</span></span><br><span class="line">            <span class="comment">// åˆ™çº¿ç¨‹åœ¨ notFull æ¡ä»¶ä¸Šæ’é˜Ÿé˜»å¡</span></span><br><span class="line">            <span class="keyword">while</span> (count == items.length) &#123;</span><br><span class="line">                notFull.await();</span><br><span class="line">            &#125;</span><br><span class="line">            items[putPtr] = x;</span><br><span class="line">            <span class="keyword">if</span> (++putPtr == items.length) &#123;</span><br><span class="line">                putPtr = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++count;</span><br><span class="line">            <span class="comment">// put æˆåŠŸä¹‹åï¼Œé˜Ÿåˆ—ä¸­æœ‰å…ƒç´ </span></span><br><span class="line">            <span class="comment">// å”¤é†’åœ¨ notEmpty æ¡ä»¶ä¸Šæ’é˜Ÿé˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">            notEmpty.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// take æ—¶ï¼Œå‘ç°ä¸ºç©º</span></span><br><span class="line">            <span class="comment">// åˆ™çº¿ç¨‹åœ¨ notEmpty çš„æ¡ä»¶ä¸Šæ’é˜Ÿé˜»å¡</span></span><br><span class="line">            <span class="keyword">while</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">                notEmpty.await();</span><br><span class="line">            &#125;</span><br><span class="line">            Object x = items[takePtr];</span><br><span class="line">            <span class="keyword">if</span> (++takePtr == items.length) &#123;</span><br><span class="line">                takePtr = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            --count;</span><br><span class="line">            <span class="comment">// take æˆåŠŸï¼Œé˜Ÿåˆ—ä¸å¯èƒ½æ˜¯æ»¡çš„</span></span><br><span class="line">            <span class="comment">// å”¤é†’åœ¨ notFull æ¡ä»¶ä¸Šæ’é˜Ÿé˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">            notFull.signal();</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯å®˜æ–¹æ–‡æ¡£çš„ä¸€ä¸ªä¾‹å­ï¼Œå®ç°äº†ä¸€ä¸ªç®€å•çš„ BlockingQueue ï¼Œçœ‹æ‡‚è¿™é‡Œï¼Œä¼šå‘ç°åœ¨<strong>åŒæ­¥é˜Ÿåˆ—</strong>ä¸­å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯ç”¨çš„è¿™ä¸ªé€»è¾‘ã€‚å¿…è¦çš„ä»£ç è¯´æ˜éƒ½å·²ç»åœ¨ä»£ç ä¸­è¿›è¡Œæ³¨é‡Šã€‚</p><h4 id="é—®é¢˜ç–‘é—®"><a href="#é—®é¢˜ç–‘é—®" class="headerlink" title="é—®é¢˜ç–‘é—®"></a>é—®é¢˜ç–‘é—®</h4><ol><li>Condition å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</li><li>Condition çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>Condition çš„ç­‰å¾…é˜Ÿåˆ—å’Œ AQS çš„åŒæ­¥é˜Ÿåˆ—æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ï¼Ÿ</li></ol><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/condition-uml-rMKuf3.png" alt="condition-uml-rMKuf3"></p><p>é€šè¿‡ UML å¯ä»¥çœ‹å‡ºï¼ŒCondition åªæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒçš„ä¸»è¦å®ç°é€»è¾‘æ˜¯åœ¨ AQS çš„å†…éƒ¨ç±» ConditionObject å®ç°çš„ã€‚ä¸‹é¢ä¸»è¦ä» await å’Œ signal ä¸¤ä¸ªæ–¹æ³•å…¥æ‰‹ï¼Œä»æºç äº†è§£ ConditionObjectã€‚</p><h4 id="åˆ›å»º-Condition"><a href="#åˆ›å»º-Condition" class="headerlink" title="åˆ›å»º Condition"></a>åˆ›å»º Condition</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">Condition con = lock.newCondition();</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬ä½¿ç”¨ lock.newCondition() åˆ›å»ºæ¡ä»¶å˜é‡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLock</span> <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Condition <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sync.newCondition();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Sync é›†æˆ AQS</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">final</span> ConditionObject <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ConditionObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯ ReentrantLock çš„æºç ï¼Œé‡Œé¢è°ƒç”¨çš„ sync.newCondition()ï¼ŒSync ç»§æ‰¿ AQSï¼Œå…¶å®å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª AQS å†…éƒ¨ç±»çš„ ConditionObject çš„å®ä¾‹ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ lock æ¯è°ƒç”¨ä¸€æ¬¡ <code>lock.newCondition()</code> éƒ½ä¼šæœ‰ä¸€ä¸ªæ–°çš„ ConditionObject å®ä¾‹ç”Ÿæˆï¼Œå°±æ˜¯è¯´ä¸€ä¸ª lock å¯ä»¥åˆ›å»ºå¤šä¸ª Condition å®ä¾‹ã€‚</p><h4 id="Condition-å‚æ•°"><a href="#Condition-å‚æ•°" class="headerlink" title="Condition å‚æ•°"></a>Condition å‚æ•°</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** æ¡ä»¶é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</span><br><span class="line"><span class="comment">/** æ¡ä»¶é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br></pre></td></tr></table></figure><h4 id="await-æ–¹æ³•"><a href="#await-æ–¹æ³•" class="headerlink" title="await æ–¹æ³•"></a>await æ–¹æ³•</h4><p>await æ–¹æ³•ï¼Œä¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œç›´åˆ°æ”¶åˆ°ä¿¡å·æˆ–è¢«ä¸­æ–­ã€‚</p><p>ä¸æ­¤ Condition ç›¸å…³è”çš„é”è¢«åŸå­é‡Šæ”¾ï¼Œå¹¶ä¸”å‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œå½“å‰çº¿ç¨‹è¢«ç¦ç”¨ï¼Œå¹¶ä¸”å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹å››ç§æƒ…å†µä¹‹ä¸€ï¼š</p><ol><li>å…¶ä»–ä¸€äº›çº¿ç¨‹è°ƒç”¨æ­¤ Condition çš„ signal æ–¹æ³•ï¼Œè€Œå½“å‰çº¿ç¨‹æ°å¥½è¢«é€‰æ‹©ä¸ºè¦å”¤é†’çš„çº¿ç¨‹ï¼›</li><li>å…¶ä»–ä¸€äº›çº¿ç¨‹è°ƒç”¨æ­¤ Condition çš„ signalAll æ–¹æ³•ï¼›</li><li>å…¶ä»–ä¸€äº›çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ï¼Œå¹¶æ”¯æŒä¸­æ–­çº¿ç¨‹æŒ‚èµ·ï¼›</li><li>å‘ç”Ÿè™šå‡å”¤é†’ã€‚</li></ol><p>åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œåœ¨æ­¤æ–¹æ³•å¯ä»¥è¿”å›ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹å¿…é¡»é‡æ–°è·å–ä¸æ­¤æ¡ä»¶å…³è”çš„é”ã€‚å½“çº¿ç¨‹è¿”å›æ—¶ï¼Œå¯ä»¥ä¿è¯ä¿æŒæ­¤é”ã€‚</p><p>ç°åœ¨æ¥çœ‹ AQS å†…éƒ¨çš„å®ç°é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// å“åº”ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°æ¡ä»¶é˜Ÿåˆ—å°¾éƒ¨ï¼ˆç­‰å¾…é˜Ÿåˆ—ï¼‰</span></span><br><span class="line">    <span class="comment">// å†…éƒ¨ä¼šåˆ›å»º Node.CONDITION ç±»å‹çš„ Node</span></span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å½“å‰çº¿ç¨‹è·å–çš„é”ï¼ˆé€šè¿‡æ“ä½œ state çš„å€¼ï¼‰</span></span><br><span class="line">    <span class="comment">// é‡Šæ”¾äº†é”å°±ä¼šè¢«é˜»å¡æŒ‚èµ·</span></span><br><span class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å·²ç»ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåˆ™è°ƒç”¨ park è®©å…¶åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­æŒ‚ç€</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ park é˜»å¡æŒ‚èµ·å½“å‰çº¿ç¨‹</span></span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// è¯´æ˜ signal è¢«è°ƒç”¨äº†æˆ–è€…çº¿ç¨‹è¢«ä¸­æ–­ï¼Œæ ¡éªŒä¸‹å”¤é†’åŸå› </span></span><br><span class="line">        <span class="comment">// å¦‚æœå› ä¸ºç»ˆç«¯è¢«å”¤é†’ï¼Œåˆ™è·³å‡ºå¾ªç¯</span></span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// while å¾ªç¯ç»“æŸï¼Œ çº¿ç¨‹å¼€å§‹æŠ¢é”</span></span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">    <span class="comment">// ç»Ÿä¸€å¤„ç†ä¸­æ–­çš„</span></span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>await æ–¹æ³•æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»º Node.CONDITION ç±»å‹çš„ Node å¹¶æ·»åŠ åˆ°æ¡ä»¶é˜Ÿåˆ—ï¼ˆConditionQueueï¼‰çš„å°¾éƒ¨ï¼›</li><li>é‡Šæ”¾å½“å‰çº¿ç¨‹è·å–çš„é”ï¼ˆé€šè¿‡æ“ä½œ state çš„å€¼ï¼‰</li><li>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ï¼ˆSyncQueueï¼‰ä¸­ï¼Œä¸åœ¨çš„è¯ä¼šä½¿ç”¨ park æŒ‚èµ·ã€‚</li><li>å¾ªç¯ç»“æŸä¹‹åï¼Œè¯´æ˜å·²ç»å·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ï¼ˆSyncQueueï¼‰ä¸­äº†ï¼Œåé¢ç­‰å¾…è·å–åˆ°é”ï¼Œç»§ç»­æ‰§è¡Œå³å¯ã€‚</li></ol><p>åœ¨è¿™é‡Œä¸€å®šè¦æŠŠæ¡ä»¶é˜Ÿåˆ—å’ŒåŒæ­¥é˜Ÿåˆ—è¿›è¡ŒåŒºåˆ†æ¸…æ¥šï¼ï¼</p><p>æ¡ä»¶é˜Ÿåˆ—/ç­‰å¾…é˜Ÿåˆ—ï¼šå³ Condition çš„é˜Ÿåˆ—<br>åŒæ­¥é˜Ÿåˆ—ï¼šAQS çš„é˜Ÿåˆ—ã€‚</p><p>ä¸‹é¢å¯¹ await é‡Œé¢é‡è¦æ–¹æ³•è¿›è¡Œé˜…è¯»ï¼š</p><ul><li>addConditionWaiter() æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node t = lastWaiter;</span><br><span class="line">    <span class="comment">// If lastWaiter is cancelled, clean out.</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å°¾èŠ‚ç‚¹çŠ¶æ€ï¼Œå¦‚æœè¢«å–æ¶ˆï¼Œåˆ™æ¸…é™¤æ‰€æœ‰è¢«å–æ¶ˆçš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œç±»å‹ä¸º Node.CONDITION</span></span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">    <span class="comment">// å°†æ–°èŠ‚ç‚¹æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>)</span><br><span class="line">        firstWaiter = node;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t.nextWaiter = node;</span><br><span class="line">    lastWaiter = node;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>addConditionWaiter æ–¹æ³•å¯ä»¥çœ‹å‡ºï¼Œåªæ˜¯åˆ›å»ºä¸€ä¸ªç±»å‹ä¸º Node.CONDITION çš„èŠ‚ç‚¹å¹¶æ”¾åˆ°æ¡ä»¶é˜Ÿåˆ—å°¾éƒ¨ã€‚åŒæ—¶é€šè¿‡è¿™æ®µä»£ç è¿˜å¯ä»¥å¾—å‡ºå…¶ä»–ç»“è®ºï¼š</p><ol><li>æ¡ä»¶é˜Ÿåˆ—å†…éƒ¨çš„ Nodeï¼Œåªç”¨åˆ°äº† threadã€waitStatusã€nextWaiter å±æ€§ï¼›</li><li>æ¡ä»¶é˜Ÿåˆ—æ˜¯å•å‘é˜Ÿåˆ—ã€‚</li></ol><p>ä½œä¸ºå¯¹æ¯”ï¼Œè¿™é‡ŒæŠŠæ¡ä»¶é˜Ÿåˆ—å’ŒåŒæ­¥é˜Ÿåˆ—åšå‡ºå¯¹æ¯”ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/condition-node-7yUQjE.png" alt="condition-node-7yUQjE"></p><p><a href="https://mp.weixin.qq.com/s/u-0aRcTTsQNzkkMhoJP0lQ">AQS</a> åŒæ­¥é˜Ÿåˆ—å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/condition-aqs-n5Fs85.png" alt="condition-aqs-n5Fs85"></p><p>å†æ¥çœ‹ä¸‹ Condition çš„æ¡ä»¶é˜Ÿåˆ—</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/condition-condition-A97bUS.png" alt="condition-condition-A97bUS"></p><p>waitStatus åœ¨ AQS ä¸­å·²ç»è¿›è¡Œäº†ä»‹ç»ï¼š</p><blockquote><ol><li>é»˜è®¤çŠ¶æ€ä¸º 0ï¼›</li><li>waitStatus &gt; 0 (CANCELLED 1) è¯´æ˜è¯¥èŠ‚ç‚¹è¶…æ—¶æˆ–è€…ä¸­æ–­äº†ï¼Œéœ€è¦ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼›</li><li>waitStatus = -1 SIGNAL å½“å‰çº¿ç¨‹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNALï¼Œåˆ™å½“å‰çº¿ç¨‹éœ€è¦é˜»å¡ï¼ˆunparkï¼‰ï¼›</li><li>waitStatus = -2 CONDITION -2 ï¼šè¯¥èŠ‚ç‚¹ç›®å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ï¼›</li><li>waitStatus = -3 PROPAGATE -3 ï¼šreleaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œåœ¨å…±äº«é”æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚</li></ol></blockquote><ul><li>fullyRelease æ–¹æ³• ï¼ˆAQSï¼‰</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullyRelease</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„ state</span></span><br><span class="line">        <span class="keyword">int</span> savedState = getState();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">            failed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> savedState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            node.waitStatus = Node.CANCELLED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fullyRelease æ–¹æ³•æ˜¯ç”± AQS æä¾›çš„ï¼Œé¦–å…ˆè·å–å½“å‰çš„ stateï¼Œç„¶åè°ƒç”¨ release æ–¹æ³•è¿›è¡Œé‡Šæ”¾é”ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>release æ–¹æ³•åœ¨ <a href="https://mp.weixin.qq.com/s/u-0aRcTTsQNzkkMhoJP0lQ">AQS</a> ä¸­åšäº†è¯¦ç»†çš„ä»‹ç»ã€‚å®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯é‡Šæ”¾é”ï¼Œå¹¶ä¸”éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ol><li>fullyRelease ä¼šä¸€æ¬¡æ€§é‡Šæ”¾æ‰€æœ‰çš„é”ï¼Œæ‰€ä»¥è¯´ä¸ç®¡é‡å…¥å¤šå°‘æ¬¡ï¼Œåœ¨è¿™é‡Œéƒ½ä¼šå…¨éƒ¨é‡Šæ”¾çš„ã€‚</li><li>è¿™é‡Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä¸»è¦æ˜¯åœ¨é‡Šæ”¾é”å¤±è´¥æ—¶ï¼Œè¿™æ—¶å°±ä¼šåœ¨ finally é‡Œé¢å°†èŠ‚ç‚¹çŠ¶æ€ç½®ä¸º Node.CANCELLEDã€‚</li></ol><ul><li>isOnSyncQueue(node)</li></ul><p>é€šè¿‡ä¸Šé¢çš„æµç¨‹ï¼ŒèŠ‚ç‚¹å·²ç»æ”¾åˆ°äº†<strong>æ¡ä»¶é˜Ÿåˆ—</strong>å¹¶ä¸”é‡Šæ”¾äº†æŒæœ‰çš„<strong>é”</strong>ï¼Œè€Œåå°±ä¼šæŒ‚èµ·é˜»å¡ï¼Œç›´åˆ° signal å”¤é†’ã€‚ä½†æ˜¯åœ¨æŒ‚èµ·æ—¶è¦ä¿è¯èŠ‚ç‚¹å·²ç»ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ï¼ˆSyncQueueï¼‰ä¸­äº†æ‰å¯ä»¥æŒ‚èµ·ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isOnSyncQueue</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹æ˜¯æ¡ä»¶é˜Ÿåˆ—èŠ‚ç‚¹ï¼Œæˆ–è€…ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (node.waitStatus == Node.CONDITION || node.prev == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (node.next != <span class="keyword">null</span>) <span class="comment">// If has successor, it must be on queue</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> findNodeFromTail(node);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä»å°¾éƒ¨å¼€å§‹éå†</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">findNodeFromTail</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    Node t = tail;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t == node)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        t = t.prev;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæ€»æ˜¯ä¸€ä¸ªæœ€åˆæ”¾ç½®åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼‰ç°åœ¨æ­£ç­‰å¾…åœ¨åŒæ­¥é˜Ÿåˆ—ä¸Šé‡æ–°è·å–ï¼Œåˆ™è¿”å›trueã€‚</p><p>è¿™æ®µä»£ç çš„ä¸»è¦ä½œç”¨åˆ¤æ–­èŠ‚ç‚¹æ˜¯ä¸æ˜¯åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœä¸åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåé¢æ‰ä¼šè°ƒç”¨ park è¿›è¡Œé˜»å¡å½“å‰çº¿ç¨‹ã€‚è¿™é‡Œå°±ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼šAQS çš„åŒæ­¥é˜Ÿåˆ—å’Œ Condition çš„æ¡ä»¶é˜Ÿåˆ—åº”è¯¥æ˜¯æ— å…³çš„ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¼šè¦ä¿è¯èŠ‚ç‚¹ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ä¹‹åæ‰å¯ä»¥è¿›è¡Œé˜»å¡ï¼Ÿå› ä¸º signal æˆ–è€… signalAll å”¤é†’èŠ‚ç‚¹ä¹‹åï¼ŒèŠ‚ç‚¹å°±ä¼šè¢«æ”¾åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚</p><p>çº¿ç¨‹åˆ°è¿™é‡Œå·²ç»è¢«é˜»å¡äº†ï¼Œå½“æœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨ signal æˆ–è€… signalAll æ—¶ï¼Œä¼šå”¤é†’å½“å‰çº¿ç¨‹ã€‚</p><p>è€Œåä¼šéªŒè¯æ˜¯å¦å› ä¸­æ–­å”¤é†’å½“å‰çº¿ç¨‹ï¼Œè¿™é‡Œå‡è®¾æ²¡æœ‰å‘ç”Ÿä¸­æ–­ã€‚é‚£ while å¾ªç¯çš„ isOnSyncQueue(Node node) å¿…ç„¶ä¼šè¿”å› true ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­äº†ã€‚</p><p>åç»­ä¼šè°ƒç”¨ <strong>acquireQueued(node, savedState)</strong> è¿›è¡Œè·å–é”ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æ‹¿åˆ°èµ„æº</span></span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸­æ–­çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// æ— é™å¾ªç¯</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">// å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œ è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ å¤´èŠ‚ç‚¹çš„ next å³çœŸå®çš„ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ ï¼ˆå› ä¸º head æ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼‰</span></span><br><span class="line">            <span class="comment">// ç„¶åå†å°è¯•è·å–èµ„æº</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">// è·å–æˆåŠŸä¹‹å å°†å¤´æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                setHead(node); </span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// p ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œ æˆ–è€… å¤´èŠ‚ç‚¹æœªèƒ½è·å–åˆ°èµ„æº ï¼ˆéå…¬å¹³æƒ…å†µä¸‹è¢«åˆ«çš„èŠ‚ç‚¹æŠ¢å ï¼‰ </span></span><br><span class="line">            <span class="comment">// åˆ¤æ–­ node æ˜¯å¦è¦è¢«é˜»å¡ï¼Œè·å–ä¸åˆ°é”å°±ä¼šä¸€ç›´é˜»å¡</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯ AQS çš„é€»è¾‘äº†ï¼ŒåŒæ ·å¯ä»¥é˜…è¯» <a href="https://mp.weixin.qq.com/s/u-0aRcTTsQNzkkMhoJP0lQ">AQS</a> çš„ç›¸å…³ä»‹ç»ã€‚</p><blockquote><ol><li>ä¸æ–­è·å–æœ¬èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸º headï¼Œå› ä¸º head æ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯ head èŠ‚ç‚¹ï¼Œåˆ™å½“å‰èŠ‚ç‚¹ä¸º <code>ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹&gt;</code>ï¼›</li><li>ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ä¸æ–­çš„å»è·å–èµ„æºï¼Œè·å–æˆåŠŸï¼Œåˆ™å°† head æŒ‡å‘å½“å‰èŠ‚ç‚¹ï¼›</li><li>å½“å‰èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œæˆ–è€… <code>tryAcquire(arg)</code> å¤±è´¥ï¼ˆå¤±è´¥å¯èƒ½æ˜¯éå…¬å¹³é”ï¼‰ã€‚è¿™æ—¶å€™éœ€è¦åˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€å†³å®š<code>å½“å‰èŠ‚ç‚¹æ˜¯å¦è¦è¢«é˜»å¡</code>ï¼ˆå‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€æ˜¯å¦ä¸º SIGNALï¼‰ã€‚</li></ol></blockquote><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“èŠ‚ç‚¹æ”¾åˆ° AQS çš„åŒæ­¥é˜Ÿåˆ—æ—¶ï¼Œä¹Ÿæ˜¯è¿›è¡Œäº‰æŠ¢èµ„æºï¼ŒåŒæ—¶è®¾ç½® <code>savedState</code> çš„å€¼ï¼Œè¿™ä¸ªå€¼åˆ™æ˜¯ä»£è¡¨å½“åˆé‡Šæ”¾é”çš„æ—¶å€™é‡Šæ”¾äº†å¤šå°‘é‡å…¥æ¬¡æ•°ã€‚</p><p>æ€»ä½“æµç¨‹ç”»å›¾å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/condition-await-q4EBQx.png" alt="condition-await-q4EBQx"></p><h4 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸ºå½“å‰æŒæœ‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    Node first = firstWaiter;</span><br><span class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// firstWaiter å¤´èŠ‚ç‚¹æŒ‡å‘æ¡ä»¶é˜Ÿåˆ—å¤´çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>)</span><br><span class="line">            lastWaiter = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// å°†åŸæ¥çš„å¤´èŠ‚ç‚¹å’ŒåŒæ­¥é˜Ÿåˆ—æ–­å¼€</span></span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp;</span><br><span class="line">                (first = firstWaiter) != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å·²ç»åœ¨ä¹‹å‰è¢«å–æ¶ˆäº†</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ enq æ·»åŠ åˆ° åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨</span></span><br><span class="line">    Node p = enq(node);</span><br><span class="line">    <span class="keyword">int</span> ws = p.waitStatus;</span><br><span class="line">    <span class="comment">// node çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ ä¿®æ”¹ä¸º SIGNAL è¿™æ ·åç»­å°±å¯ä»¥å”¤é†’è‡ªå·±äº†</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>enq åŒæ ·å¯ä»¥é˜…è¯» <a href="https://mp.weixin.qq.com/s/u-0aRcTTsQNzkkMhoJP0lQ">AQS</a> çš„ä»£ç  </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node t = tail;</span><br><span class="line">        <span class="comment">// å°¾èŠ‚ç‚¹ä¸ºç©º éœ€è¦åˆå§‹åŒ–å¤´èŠ‚ç‚¹ï¼Œæ­¤æ—¶å¤´å°¾èŠ‚ç‚¹æ˜¯ä¸€ä¸ª</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä¸ä¸ºç©º å¾ªç¯èµ‹å€¼</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ enq æ–¹æ³•å°†èŠ‚ç‚¹æ”¾åˆ° AQS çš„åŒæ­¥é˜Ÿåˆ—ä¹‹åï¼Œè¦å°† node çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ waitStatus è®¾ç½®ä¸º Node.SIGNALã€‚signalAll çš„ä»£ç ä¹Ÿæ˜¯ç±»ä¼¼ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p><strong>Q: Condition å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</strong></p><p><strong>A:</strong> Condition æ˜¯åŸºäº AQS å®ç°çš„ï¼ŒCondition çš„å®ç°ç±» ConditionObject æ˜¯ AQS çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œåœ¨é‡Œé¢å…±ç”¨äº†ä¸€éƒ¨åˆ† AQS çš„é€»è¾‘ã€‚</p><p><strong>Q: Condition çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p><strong>A:</strong> Condition å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—ï¼Œåœ¨è·å–é”çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹è°ƒç”¨ awaitï¼Œçº¿ç¨‹ä¼šè¢«æ”¾ç½®åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­å¹¶è¢«é˜»å¡ã€‚ç›´åˆ°è°ƒç”¨ signalã€signalAll å”¤é†’çº¿ç¨‹ï¼Œæ­¤åçº¿ç¨‹å”¤é†’ï¼Œä¼šæ”¾å…¥åˆ° AQS çš„åŒæ­¥é˜Ÿåˆ—ï¼Œå‚ä¸äº‰æŠ¢é”èµ„æºã€‚</p><p><strong>Q: Condition çš„ç­‰å¾…é˜Ÿåˆ—å’Œ AQS çš„åŒæ­¥é˜Ÿåˆ—æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ï¼Ÿ</strong><br><strong>A:</strong> Condition çš„ç­‰å¾…é˜Ÿåˆ—æ˜¯å•å‘é“¾è¡¨ï¼ŒAQS çš„æ˜¯åŒå‘é“¾è¡¨ã€‚äºŒè€…ä¹‹é—´å¹¶æ²¡æœ‰ä»€ä¹ˆæ˜ç¡®çš„è”ç³»ã€‚ä»…ä»…åœ¨èŠ‚ç‚¹ä»é˜»å¡çŠ¶æ€è¢«å”¤é†’åï¼Œä¼šä»ç­‰å¾…é˜Ÿåˆ—æŒªåˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚</p><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>æœ¬æ–‡ä¸»è¦æ˜¯é˜…è¯» Condition çš„ç›¸å…³ä»£ç ï¼Œä¸è¿‡çœç•¥äº†çº¿ç¨‹ä¸­æ–­ç­‰é€»è¾‘ã€‚æœ‰å…´è¶£çš„å°ä¼™ä¼´ã€‚å¯ä»¥æ›´æ·±å…¥çš„ç ”ç©¶ç›¸å…³çš„æºç ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- åŸºäºæ•°ç»„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ— â€”â€” ArrayBlockingQueue</title>
      <link href="2020/09/27/source-code-arrayblockingqueue.html"/>
      <url>2020/09/27/source-code-arrayblockingqueue.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>åœ¨é˜…è¯»å®Œå’Œ AQS ç›¸å…³çš„é”ä»¥åŠåŒæ­¥è¾…åŠ©å™¨ä¹‹åï¼Œæ¥ä¸€èµ·é˜…è¯» JUC ä¸‹çš„å’Œé˜Ÿåˆ—ç›¸å…³çš„æºç ã€‚å…ˆä»ç¬¬ä¸€ä¸ªå¼€å§‹ï¼šArrayBlockingQueueã€‚</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>ç”±æ•°ç»„æ”¯æŒçš„æœ‰ç•ŒBlockingQueueé˜»å¡é˜Ÿåˆ—ã€‚</p><p>è¿™ä¸ªé˜Ÿåˆ—çš„å‘½ä»¤å…ƒç´ FIFOï¼ˆå…ˆå…¥å…ˆå‡ºï¼‰ã€‚ é˜Ÿåˆ—çš„å¤´æ˜¯å…ƒç´ ä¸€ç›´åœ¨é˜Ÿåˆ—ä¸­æ—¶é—´æœ€é•¿ã€‚ é˜Ÿåˆ—çš„å°¾éƒ¨æ˜¯è¯¥å…ƒç´ å·²ç»åœ¨é˜Ÿåˆ—ä¸­çš„æ—¶é—´æœ€çŸ­ã€‚ æ–°å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶ä¸”é˜Ÿåˆ—æ£€ç´¢æ“ä½œè·å–åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨å…ƒç´ ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œæœ‰ç•Œç¼“å†²åŒºâ€ï¼Œåœ¨å…¶ä¸­ä¸€ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„ä¿æŒç”±ç”Ÿäº§è€…æ’å…¥å¹¶å—åˆ°æ¶ˆè´¹è€…çš„æå–çš„å…ƒç´ ã€‚ ä¸€æ—¦åˆ›å»ºï¼Œå®¹é‡ä¸èƒ½æ”¹å˜ã€‚ è¯•å›¾put ä¸€ä¸ªå…ƒç´ åˆ°ä¸€ä¸ªæ»¡çš„é˜Ÿåˆ—å°†å¯¼è‡´æ“ä½œé˜»å¡; è¯•å›¾ take ä»ç©ºé˜Ÿåˆ—ä¸€ä¸ªå…ƒç´ å°†ç±»ä¼¼åœ°é˜»å¡ã€‚</p><p>æ­¤ç±»æ”¯æŒè®¢è´­ç­‰å¾…ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹å¯é€‰çš„å…¬å¹³æ”¿ç­–ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé¡ºåºä¸èƒ½ä¿è¯ã€‚ ç„¶è€Œï¼Œé˜Ÿåˆ—å…¬å¹³è®¾ç½®ä¸ºæ„å»º true ä¿è¯çº¿ç¨‹ä»¥FIFOçš„é¡ºåºè¿›è¡Œè®¿é—®ã€‚ å…¬å¹³æ€§é€šå¸¸ä¼šé™ä½ååé‡ï¼Œä½†å‡å°‘äº†å¯å˜æ€§å’Œé¿å…é¥¥é¥¿ã€‚</p><h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayBlockingQueueTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ArrayBlockingQueue&lt;String&gt; QUEUE = <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch LATCH = <span class="keyword">new</span> CountDownLatch(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">2</span>, <span class="number">2</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">1024</span>),</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryBuilder().setNameFormat(<span class="string">&quot;Thread-pool-%d&quot;</span>).build(),</span><br><span class="line">                <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        pool.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line"></span><br><span class="line">                    QUEUE.put(<span class="string">&quot;é¸¡è›‹&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">                    System.out.println(<span class="string">&quot;put æ”¾å…¥å…ƒç´ &quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            LATCH.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        pool.submit(() -&gt; &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">500L</span>);</span><br><span class="line"></span><br><span class="line">                    String take = QUEUE.take();</span><br><span class="line"></span><br><span class="line">                    System.out.println(<span class="string">&quot;take = &quot;</span> + take);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            LATCH.countDown();</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LATCH.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        pool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>demo åªæ˜¯ä¸´æ—¶å†™çš„ä¸€ä¸ªï¼Œå¾ˆç®€å•çš„ç‰ˆæœ¬ã€‚</p><h4 id="é—®é¢˜ç–‘é—®"><a href="#é—®é¢˜ç–‘é—®" class="headerlink" title="é—®é¢˜ç–‘é—®"></a>é—®é¢˜ç–‘é—®</h4><ol><li>ArrayBlockingQueue çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>å…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—æ–¹æ³•ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</li></ol><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ArrayBlockingQueue-uml-37BHBp.png" alt="ArrayBlockingQueue-uml-37BHBp"></p><h4 id="å‚æ•°ä»‹ç»"><a href="#å‚æ•°ä»‹ç»" class="headerlink" title="å‚æ•°ä»‹ç»"></a>å‚æ•°ä»‹ç»</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/** æ•°ç»„ - å­˜å‚¨é˜Ÿåˆ—ä¸­çš„å…ƒç´  */</span></span><br><span class="line"><span class="keyword">final</span> Object[] items;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** ä¸‹ä¸€ä¸ª take, poll, peek or remove çš„ç´¢å¼• */</span></span><br><span class="line"><span class="keyword">int</span> takeIndex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** ä¸‹ä¸€ä¸ª put, offer, or add çš„ç´¢å¼• */</span></span><br><span class="line"><span class="keyword">int</span> putIndex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•° */</span></span><br><span class="line"><span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Main lock guarding all access */</span></span><br><span class="line"><span class="keyword">final</span> ReentrantLock lock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** take æ“ä½œæ—¶æ˜¯å¦ç­‰å¾… */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** put æ“ä½œæ—¶æ˜¯å¦ç­‰å¾… */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notFull;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(capacity, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‡å®šå®¹é‡ï¼ŒåŠæ˜¯å¦å…¬å¹³</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">this</span>.items = <span class="keyword">new</span> Object[capacity];</span><br><span class="line">    lock = <span class="keyword">new</span> ReentrantLock(fair);</span><br><span class="line">    notEmpty = lock.newCondition();</span><br><span class="line">    notFull =  lock.newCondition();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–çš„æ—¶å€™æ”¾å…¥å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">boolean</span> fair,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(capacity, fair);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock(); <span class="comment">// Lock only for visibility, not mutual exclusion</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (E e : c) &#123;</span><br><span class="line">                checkNotNull(e);</span><br><span class="line">                items[i++] = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">        count = i;</span><br><span class="line">        putIndex = (i == capacity) ? <span class="number">0</span> : i;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ å…ƒç´ "><a href="#æ·»åŠ å…ƒç´ " class="headerlink" title="æ·»åŠ å…ƒç´ "></a>æ·»åŠ å…ƒç´ </h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.add(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çˆ¶ç±»çš„æ–¹æ³•ï¼Œå…¶å®è°ƒç”¨çš„ä¹Ÿæ˜¯ offer</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (offer(e))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Queue full&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨é”</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (count == items.length)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            enqueue(e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ”¾å…¥å…ƒç´ ï¼Œ å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ç­‰å¾…</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (count == items.length)</span><br><span class="line">            notFull.await();</span><br><span class="line">        enqueue(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>add æ–¹æ³•ï¼šè°ƒç”¨çš„æ˜¯çˆ¶ç±» AbstractQueue çš„ add æ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨çš„æ˜¯ offer æ–¹æ³•ï¼Œå¦‚æœ offer è¿”å› falseï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li><li>offer æ–¹æ³•ï¼šæ ¡éªŒå…ƒç´ éç©ºï¼ŒåŠ äº’æ–¥é”ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™è¿”å› falseï¼Œå¦‚æœé˜Ÿåˆ—æœªæ»¡ï¼Œåˆ™è°ƒç”¨ enqueue æ–¹æ³•ï¼Œæ·»åŠ å…ƒç´ ã€‚</li><li>put æ–¹æ³•ï¼šæ ¡éªŒå…ƒç´ éç©ºï¼ŒåŠ äº’æ–¥é”ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¸€ç›´è‡ªæ—‹ç­‰å¾…ï¼Œé˜Ÿåˆ—æœªæ»¡åˆ™è°ƒç”¨ enqueue æ–¹æ³•ï¼Œæ·»åŠ å…ƒç´ ã€‚</li></ol><p>æ‰€ä»¥ä¸‹é¢è¿˜æ˜¯éœ€è¦çœ‹ä¸€ä¸‹ enqueue æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åªæœ‰åœ¨è·å–é”çš„æ—¶å€™æ‰å¯ä»¥è°ƒç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(E x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert lock.getHoldCount() == 1;</span></span><br><span class="line">    <span class="comment">// assert items[putIndex] == null;</span></span><br><span class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</span><br><span class="line">    <span class="comment">// putIndex ä¸‹ä¸€ä¸ª put, offer, or add çš„ç´¢å¼•</span></span><br><span class="line">    <span class="comment">// å¯¹å…¶è¿›è¡Œèµ‹å€¼ï¼Œç„¶åè¿›è¡Œ ++putIndex æ“ä½œ</span></span><br><span class="line">    items[putIndex] = x;</span><br><span class="line">    <span class="comment">// å¦‚æœç­‰äºé•¿åº¦ï¼Œåˆ™æŒ‡å®šä¸ºå¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (++putIndex == items.length)</span><br><span class="line">        putIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å¯¹å…ƒç´ æ•°è¿›è¡Œ ++</span></span><br><span class="line">    count++;</span><br><span class="line">    <span class="comment">// æœ‰å…ƒç´ å…¥é˜Ÿåˆ—ï¼Œå”¤é†’åœ¨ç­‰å¾…è·å–å…ƒç´ çš„çº¿ç¨‹</span></span><br><span class="line">    notEmpty.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·å–å…ƒç´ "><a href="#è·å–å…ƒç´ " class="headerlink" title="è·å–å…ƒç´ "></a>è·å–å…ƒç´ </h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (count == <span class="number">0</span>) ? <span class="keyword">null</span> : dequeue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (count == <span class="number">0</span>)</span><br><span class="line">            notEmpty.await();</span><br><span class="line">        <span class="keyword">return</span> dequeue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æºç å¯ä»¥çœ‹å‡ºï¼š</p><ol><li>pool å’Œ take éƒ½æ˜¯ä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ ï¼ŒäºŒè€…ä¸åŒçš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰å…ƒç´ æ—¶ï¼Œpoll æ–¹æ³•è¿”å› nullï¼Œè€Œ take æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°ä»é˜Ÿåˆ—ä¸­è·å–åˆ°å…ƒç´ ã€‚</li><li>poll å’Œ take æ–¹æ³•è·å–å…ƒç´ éƒ½æ˜¯è°ƒç”¨çš„ dequeue æ–¹æ³•ã€‚</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">dequeue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert lock.getHoldCount() == 1;</span></span><br><span class="line">    <span class="comment">// assert items[takeIndex] != null;</span></span><br><span class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="comment">// è·å–å…ƒç´ å¹¶å°†å…ƒç´ ç½®ä¸º null</span></span><br><span class="line">    E x = (E) items[takeIndex];</span><br><span class="line">    items[takeIndex] = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// takeIndex ä¸‹ä¸€ä¸ª take, poll, peek or remove çš„ç´¢å¼•</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸” å…ƒç´ æ•°å‡å°‘</span></span><br><span class="line">    <span class="keyword">if</span> (++takeIndex == items.length)</span><br><span class="line">        takeIndex = <span class="number">0</span>;</span><br><span class="line">    count--;</span><br><span class="line">    <span class="comment">// æ›´æ–°è¿­ä»£å™¨çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (itrs != <span class="keyword">null</span>)</span><br><span class="line">        itrs.elementDequeued();</span><br><span class="line">    <span class="comment">// å”¤é†’ç­‰å¾…æ”¾å…¥å…ƒç´ çš„çº¿ç¨‹</span></span><br><span class="line">    notFull.signal();</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹å…ƒç´ "><a href="#æŸ¥çœ‹å…ƒç´ " class="headerlink" title="æŸ¥çœ‹å…ƒç´ "></a>æŸ¥çœ‹å…ƒç´ </h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">peek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> itemAt(takeIndex); <span class="comment">// null when queue is empty</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p><strong>Q: ArrayBlockingQueue çš„å®ç°åŸç†ï¼Ÿ</strong></p><p><strong>A:</strong> ArrayBlockingQueue æ˜¯åŸºäºæ•°ç»„å®ç°çš„ï¼Œå†…éƒ¨ä½¿ç”¨ ReentrantLock äº’æ–¥é”ï¼Œé˜²æ­¢å¹¶å‘æ”¾ç½®å…ƒç´ æˆ–è€…å–å‡ºå…ƒç´ çš„å†²çªé—®é¢˜ã€‚</p><p><strong>Q: å…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—æ–¹æ³•ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>add</td><td>æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡äº†ï¼Œæ·»åŠ å¤±è´¥æŠ›å‡ºé—äº§</td></tr><tr><td>offer</td><td>æ·»åŠ å…ƒç´ ï¼Œ é˜Ÿåˆ—æ»¡äº†ï¼Œæ·»åŠ å¤±è´¥ï¼Œè¿”å› false</td></tr><tr><td>put</td><td>æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡äº†ï¼Œé˜»å¡ç­‰å¾…</td></tr><tr><td></td><td></td></tr><tr><td>poll</td><td>å¼¹å‡ºå…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©ºåˆ™è¿”å› null</td></tr><tr><td>take</td><td>å¼¹å‡ºå…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©ºåˆ™ç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ </td></tr><tr><td></td><td></td></tr><tr><td>peek</td><td>æŸ¥çœ‹é˜Ÿåˆ—ä¸­æ”¾å…¥æœ€æ—©çš„ä¸€ä¸ªå…ƒç´ </td></tr></tbody></table><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>ArrayBlockingQueue ä¸­ä½¿ç”¨äº† ReentrantLock äº’æ–¥é”ï¼Œåœ¨å…ƒç´ å…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—çš„æ—¶å€™éƒ½è¿›è¡Œäº†åŠ é”ï¼Œæ‰€ä»¥åŒæ—¶åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå…¥é˜Ÿåˆ—æˆ–è€…å‡ºé˜Ÿåˆ—ï¼Œä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- ä½¿ç”¨é€’å¢è®¡æ•°å™¨çš„çº¿ç¨‹åŒæ­¥å·¥å…· â€”â€” ä¿¡å·é‡ï¼Œå®ƒçš„åŸç†æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ</title>
      <link href="2020/09/21/source-code-semaphore.html"/>
      <url>2020/09/21/source-code-semaphore.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>åœ¨ JUC ä¸­çº¿ç¨‹åŒæ­¥å™¨é™¤äº† CountDownLatch å’Œ CycleBarrier ï¼Œè¿˜æœ‰ä¸€ä¸ªå«åš Semaphore ï¼ˆä¿¡å·é‡ï¼‰ï¼ŒåŒæ ·æ˜¯åŸºäº AQS å®ç°çš„ã€‚ä¸‹é¢æ¥çœ‹çœ‹ä¿¡å·é‡çš„å†…éƒ¨åŸç†ã€‚</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>ä¸€ä¸ªè®¡æ•°ä¿¡å·é‡ã€‚ ä»æ¦‚å¿µä¸Šè®²ï¼Œä¿¡å·é‡ç»´æŠ¤äº†ä¸€ç»„è®¸å¯ã€‚ å¦‚æœæœ‰å¿…è¦ï¼Œåœ¨è®¸å¯å¯ç”¨ä¹‹å‰è°ƒç”¨ acquire æ–¹æ³•ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è®¸å¯è¯å¯ç”¨ã€‚ è°ƒç”¨ release æ–¹æ³•ä¼šå¢åŠ äº†ä¸€ä¸ªè®¸å¯è¯ï¼Œä»è€Œé‡Šæ”¾è¢«é˜»å¡çš„çº¿ç¨‹ã€‚ </p><ol><li>å£°æ˜æ—¶æŒ‡å®šåˆå§‹è®¸å¯æ•°é‡ã€‚</li><li>è°ƒç”¨ acquire(int permits) æ–¹æ³•ï¼ŒæŒ‡å®šç›®æ ‡è®¸å¯æ•°é‡ã€‚</li><li>è°ƒç”¨ release(int permits) æ–¹æ³•ï¼Œå‘å¸ƒæŒ‡å®šçš„è®¸å¯æ•°é‡ã€‚</li></ol><p>åœ¨è®¸å¯æ•°é‡æ²¡æœ‰åˆ°è¾¾æŒ‡å®šç›®æ ‡æ•°é‡æ—¶ï¼Œè°ƒç”¨ acquire æ–¹æ³•çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚</p><h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Semaphore SEMAPHORE = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">5</span>, <span class="number">5</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">1024</span>),</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryBuilder().setNameFormat(<span class="string">&quot;Thread-pool-%d&quot;</span>).build(),</span><br><span class="line">                <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            pool.submit(() -&gt; &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span> + <span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;å½“å‰çº¿ç¨‹: &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; å‘å¸ƒä¸€ä¸ªè®¸å¯&quot;</span>);</span><br><span class="line">                SEMAPHORE.release(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;-----&gt; è¿™é‡Œæ˜¯ä¸»çº¿ç¨‹&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SEMAPHORE.acquire(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;-----&gt; ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line"></span><br><span class="line">        pool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-----&gt; è¿™é‡Œæ˜¯ä¸»çº¿ç¨‹</span><br><span class="line">å½“å‰çº¿ç¨‹: Thread-pool-2 å‘å¸ƒä¸€ä¸ªè®¸å¯</span><br><span class="line">å½“å‰çº¿ç¨‹: Thread-pool-4 å‘å¸ƒä¸€ä¸ªè®¸å¯</span><br><span class="line">å½“å‰çº¿ç¨‹: Thread-pool-1 å‘å¸ƒä¸€ä¸ªè®¸å¯</span><br><span class="line">å½“å‰çº¿ç¨‹: Thread-pool-0 å‘å¸ƒä¸€ä¸ªè®¸å¯</span><br><span class="line">å½“å‰çº¿ç¨‹: Thread-pool-3 å‘å¸ƒä¸€ä¸ªè®¸å¯</span><br><span class="line">-----&gt; ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯æ¨¡æ‹Ÿäº†ç±»ä¼¼ CountDownLatch çš„ç”¨æ³•ï¼Œ åœ¨å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚åªä¸è¿‡ Semaphore å’Œ CountDownLatch åŒºåˆ«æœ€å¤§çš„æ˜¯ï¼š</p><p>Semaphore æ˜¯ä»æŒ‡å®šæ•°å€¼å¼€å§‹å¢åŠ ï¼Œç›´åˆ°åˆ°è¾¾è®¸å¯æ•°é‡ï¼Œç„¶åè¢«é˜»å¡çº¿ç¨‹å¼€å§‹ç»§ç»­æ‰§è¡Œã€‚</p><p>CountDownLatch æ˜¯ä»æŒ‡å®šæ•°é‡çš„çº¿ç¨‹å¼€å§‹å‡å°‘ï¼Œç›´åˆ°ä¸º 0 æ—¶ï¼Œè¢«é˜»å¡çš„çº¿ç¨‹å¼€å§‹ç»§ç»­æ‰§è¡Œã€‚</p><p>å½“ç„¶è¿™åªæ˜¯æœ€ç®€å•çš„ç”¨æ³•ï¼Œé™¤æ­¤è®©ä¸»çº¿ç¨‹ç­‰å¾…ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥è®©å…¶ä»–çº¿ç¨‹ç­‰å¾…ï¼Œç„¶åå†å¼€å§‹æ‰§è¡Œã€‚</p><h4 id="é—®é¢˜ç–‘é—®"><a href="#é—®é¢˜ç–‘é—®" class="headerlink" title="é—®é¢˜ç–‘é—®"></a>é—®é¢˜ç–‘é—®</h4><ol><li>Semaphore å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</li><li>Semaphore å’Œ CountDownLatch æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li></ol><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/Semaphore-cover-iGaTzJ.png" alt="Semaphore-cover-iGaTzJ"></p><p>é€šè¿‡ç±»å›¾å¯ä»¥çœ‹å‡ºåœ¨ Semaphore é‡Œé¢æœ‰ä¸€ä¸ªé™æ€å†…éƒ¨ç±» Sync ç»§æ‰¿äº† AQSï¼ŒåŒæ—¶ä¸ºäº†åŒºåˆ†å…¬å¹³å’Œéå…¬å¹³çš„æƒ…å†µï¼ŒSync åˆ†åˆ«æœ‰ä¸¤ä¸ªå­ç±»ï¼šNonfairSync ã€FairSyncã€‚</p><p>ä¸‹é¢æ ¹æ®æ¡ˆä¾‹åˆ†åˆ«ä»æ„é€ å‡½æ•°ã€acquire()ã€release() å…¥æ‰‹ï¼Œä»è€Œäº†è§£å†…éƒ¨å®ç°åŸç†ã€‚</p><h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Semaphore</span><span class="params">(<span class="keyword">int</span> permits)</span> </span>&#123;</span><br><span class="line">    sync = <span class="keyword">new</span> NonfairSync(permits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–é»˜è®¤éå…¬å¹³é”ï¼Œ åŒæ—¶éœ€è¦ä¼ å…¥æŒ‡å®šè®¸å¯æ•°ï¼Œ å¯ä»¥çœ‹åˆ°è¿™å—ä»£ç æ˜¯è°ƒç”¨çš„ AQS çš„ setState(permits) æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2694183684443567898L</span>;</span><br><span class="line"></span><br><span class="line">    NonfairSync(<span class="keyword">int</span> permits) &#123;</span><br><span class="line">        <span class="keyword">super</span>(permits);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1192457210091910933L</span>;</span><br><span class="line"></span><br><span class="line">        Sync(<span class="keyword">int</span> permits) &#123;</span><br><span class="line">            setState(permits);</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>setState æ–¹æ³•å…¶å®å°±æ˜¯å¯¹ AQS çš„ state è¿›è¡Œèµ‹å€¼ã€‚</p><blockquote><p>è¡¥å……</p><ol><li>åœ¨ ReentrantLock ä¸­ state ä»£è¡¨åŠ é”çŠ¶æ€ï¼Œ0 æ²¡æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äºç­‰äº 1 å·²ç»æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äº 1 è¯´æ˜è¯¥è·å¾—é”çš„çº¿ç¨‹å¤šæ¬¡é‡å…¥ã€‚</li><li>åœ¨ ReentrantReadWriteLock ä¸­ state ä»£è¡¨é”çš„çŠ¶æ€ã€‚state ä¸º 0 ï¼Œæ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œstate çš„é«˜ 16 ä¸ºä»£è¡¨è¯»é”çŠ¶æ€ï¼Œä½ 16 ä¸ºä»£è¡¨å†™é”çŠ¶æ€ã€‚é€šè¿‡ä½è¿ç®—å¯ä»¥è·å–è¯»å†™é”çš„å®é™…å€¼ã€‚</li><li>è€Œåœ¨è¿™é‡Œ ï¼ˆCountDownLatchï¼‰åˆ™ä»£è¡¨é—¨é—©æˆ–è€…è¯´è®¡æ•°çš„å€¼ã€‚</li></ol></blockquote><p>å¦‚æœå¯¹ state æœ‰æ‰€é—å¿˜ï¼Œå¯ä»¥é˜…è¯»å‰é¢çš„ AQS ã€CAS ç›¸å…³ä»£ç ã€‚ state åœ¨è¿™é‡Œä»£è¡¨çš„æ˜¯ä¿¡å·é‡çš„è®¸å¯æ•°é‡ã€‚</p><h4 id="acquire"><a href="#acquire" class="headerlink" title="acquire()"></a>acquire()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> permits)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permits &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    sync.acquireSharedInterruptibly(permits);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>acquire() å’Œ acquire(int permits) è°ƒç”¨çš„éƒ½æ˜¯ sync.acquireSharedInterruptibly(permits) æ–¹æ³•ï¼Œåªä¸è¿‡ä¸€ä¸ªæ”¯æŒä¼ é€’å‚æ•°ï¼Œä¸€ä¸ªé»˜è®¤ä¸º 1ã€‚</p><p>acquireSharedInterruptibly æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯ Sync ç»§æ‰¿è‡ª AQS çš„ã€‚</p><p>è¿™å—å¯ä»¥é˜…è¯» AQS çš„æ–‡ç« ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Node node = addWaiter(Node.SHARED);</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="keyword">int</span> r = tryAcquireShared(arg);</span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>åœ¨å¤±è´¥åä¼šä½¿ç”¨ <code>doAcquireSharedInterruptibly(arg);</code> ä¸æ–­è·å–èµ„æºï¼›</li><li><code>final Node node = addWaiter(Node.SHARED);</code> ä¼šåˆ›å»ºèŠ‚ç‚¹ä»¥å…±äº«æ¨¡å¼æ”¾åˆ°é˜Ÿåˆ—é‡Œï¼›</li><li>åœ¨å¾ªç¯ä¸­ä¸æ–­åˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯ headï¼Œåˆ™å°è¯•è·å–å…±äº«èµ„æºï¼›</li><li>åœ¨å…±äº«æ¨¡å¼ä¸‹è·å–åˆ°èµ„æºåä¼šä½¿ç”¨ <code>setHeadAndPropagate(node, r);</code> è®¾ç½®å¤´èŠ‚ç‚¹ï¼ŒåŒæ—¶å”¤é†’åç»­èŠ‚ç‚¹ã€‚</li></ol><p>tryAcquireShared æ˜¯éœ€è¦å­ç±»å®ç°ï¼Œä¹Ÿå°±æ˜¯åœ¨ Semaphore.Sync çš„å®ç°ç±»ä¸­å®ç°äº†ï¼Œè¿™é‡Œä»¥ FairSync åšè®²è§£ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2014338818796000944L</span>;</span><br><span class="line"></span><br><span class="line">    FairSync(<span class="keyword">int</span> permits) &#123;</span><br><span class="line">        <span class="keyword">super</span>(permits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœå‰é¢æœ‰èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥è¿”å› -1 è¡¨ç¤ºå¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (hasQueuedPredecessors())</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰ä¿¡å·é‡</span></span><br><span class="line">            <span class="keyword">int</span> available = getState();</span><br><span class="line">            <span class="comment">// è·å–å½“å‰å‰©ä½™é‡</span></span><br><span class="line">            <span class="keyword">int</span> remaining = available - acquires;</span><br><span class="line">            <span class="comment">// å¦‚æœå°äº 0 æˆ–è€… CAS è®¾ç½®ä¿¡å·é‡æˆåŠŸ åˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">                compareAndSetState(available, remaining))</span><br><span class="line">                <span class="keyword">return</span> remaining;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">è€Œè¿™æ®µä»£ç çš„å«ä¹‰ï¼š</span><br><span class="line"><span class="number">1.</span> å¦‚æœå‰é¢æœ‰èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥é˜»å¡ï¼›</span><br><span class="line"><span class="number">2.</span> å¦‚æœå½“å‰å‰©ä½™ä¿¡å·é‡å°äº <span class="number">0</span> ï¼Œåˆ™è¿”å›è´Ÿå€¼ï¼Œç›´æ¥é˜»å¡ï¼›</span><br><span class="line"><span class="number">3.</span> å¦‚æœå½“å‰å‰©ä½™é‡å¤§äºç­‰äº <span class="number">0</span> ï¼Œä¼š CAS æ›´æ–°ä¿¡å·é‡ï¼Œå¹¶è¿”å›éè´Ÿæ•°ã€‚</span><br><span class="line"></span><br><span class="line">&gt;è¿™å—æ•°å€¼çš„å«ä¹‰ï¼Œåœ¨ AQS ä¸­å®šä¹‰äº†ï¼Œå«ä¹‰å¦‚ä¸‹ï¼š</span><br><span class="line"></span><br><span class="line">&gt;<span class="number">1.</span> å°äº <span class="number">0</span>: è¡¨ç¤ºå¤±è´¥ï¼›</span><br><span class="line">&gt;<span class="number">2.</span> ç­‰äº <span class="number">0</span>: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œä½†åç»­çš„èŠ‚ç‚¹ä¸èƒ½ä»¥å…±äº«æ¨¡å¼è·å–æˆåŠŸ; </span><br><span class="line">&gt;<span class="number">3.</span> å¤§äº <span class="number">0</span>: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œåç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¹Ÿå¯èƒ½ä¼šæˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåç»­ç­‰å¾…çº¿ç¨‹å¿…é¡»æ£€æŸ¥å¯ç”¨æ€§ã€‚</span><br><span class="line"></span><br><span class="line">#### release()</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> permits)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permits &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    sync.releaseShared(permits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘å¸ƒè®¸å¯è¯çš„ç»™å®šæ•°é‡ï¼Œè¯¥æ•°é‡å¢åŠ å¯ç”¨çš„è®¸å¯æ•°é‡ã€‚ çœ‹å…¶å†…éƒ¨è°ƒç”¨çš„æ˜¯ Sync çš„ releaseSharedï¼Œ å…¶å®å°±æ˜¯ AQS çš„å¯¹åº”æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå®ç°tryReleaseSharedè¿”å›trueï¼Œä»¥å…±äº«æ¨¡å¼é‡Šæ”¾èµ„æºã€‚ å…¶ä¸­çš„ tryReleaseShared éƒ¨åˆ†ç”± Semaphore.Sync ä¸­å®ç°ï¼Œé€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰ state</span></span><br><span class="line">        <span class="keyword">int</span> current = getState();</span><br><span class="line">        <span class="comment">// å¯¹ state è¿›è¡Œå¢åŠ </span></span><br><span class="line">        <span class="keyword">int</span> next = current + releases;</span><br><span class="line">        <span class="keyword">if</span> (next &lt; current) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum permit count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ CAS èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåœ¨ Semaphore çš„ release æ–¹æ³•ä¸­ä¸»è¦å°±æ˜¯å¯¹ state è¿›è¡Œå¢åŠ ï¼Œå¢åŠ æˆåŠŸåä¼šè°ƒç”¨ AQS çš„ doReleaseShared æ–¹æ³•å”¤é†’å¤´èŠ‚ç‚¹ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p><strong>Q: æ—¢ç„¶ Semaphore ä¹Ÿæ˜¯åŸºäº AQSï¼Œ é‚£åœ¨ Semaphore ä¸­ state çš„å«ä¹‰ä»£è¡¨ä»€ä¹ˆï¼Ÿ</strong><br><strong>A:</strong> åœ¨ Semaphore ä¸­ state ä»£è¡¨è®¸å¯æ•°é‡ï¼Œacquire æ–¹æ³•å½“è®¸å¯å°äºæŒ‡å®šæ•°é‡ä¼šé˜»å¡çº¿ç¨‹ï¼Œrelease æ–¹æ³•å¢åŠ è®¸å¯å½“è®¸å¯å¢åŠ æˆåŠŸåˆ™å”¤é†’é˜»å¡èŠ‚ç‚¹ã€‚</p><p><strong>Q: Semaphore åŸºäº AQS å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</strong><br><strong>A:</strong> </p><ol><li>åˆå§‹è®¾ç½® state çš„åˆå§‹å€¼ï¼Œå³åˆå§‹è®¸å¯æ•°é‡ã€‚</li><li>acquire æ–¹æ³•è®¾ç½®ç›®æ ‡æ•°é‡ï¼Œå½“ç›®æ ‡æ•°é‡å¤§äºå½“å‰æ•°é‡æ—¶ï¼Œä¼šé˜»å¡çº¿ç¨‹å¹¶å°†å…¶æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ã€‚æ­¤å¤„åŸºäº AQS å®ç°ã€‚</li><li>release å¯¹ state è¿›è¡Œå¢åŠ ï¼ŒæˆåŠŸåä¼šè°ƒç”¨ AQS çš„ doReleaseShared å”¤é†’å¤´ç»“ç‚¹ã€‚åŒæ ·æ˜¯åŸºäº AQS å®ç°ã€‚</li></ol><p><strong>Q: Semaphore å’Œ CountDownLatch æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong><br><strong>A:</strong> Semaphore çš„è®¡æ•°å™¨æ˜¯é€’åŠ çš„ï¼Œè€Œ CountDownLatch æ˜¯é€’å‡çš„ã€‚ç›¸åŒç‚¹å°±æ˜¯è®¡æ•°å™¨éƒ½ä¸å¯ä»¥é‡ç½®ã€‚</p><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>åœ¨é˜…è¯» Semaphore æºç è¿‡ç¨‹ä¸­ï¼Œå‘ç°å…¶ä¸»è¦åŠŸèƒ½éƒ½æ˜¯åŸºäº AQS å®ç°çš„ï¼Œå¯ä»¥å›é¡¾é˜…è¯» AQS çš„ç›¸å…³ç¬”è®°ã€‚åŒæ · Semaphore ä¹Ÿæ”¯æŒå…¬å¹³å’Œéå…¬å¹³æ¨¡å¼ï¼Œè¿™å—å°±éœ€è¦å°ä¼™ä¼´è‡ªå·±å»é˜…è¯»å•¦ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å·¥ä½œç¬”è®°ã€‘- ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ä¸ºä»€ä¹ˆäº¤æ˜“å’Œé€€æ¬¾è¦æ‹†å¼€ä¸åŒçš„è¡¨ï¼Ÿ</title>
      <link href="2020/09/19/work-trans-refund-table.html"/>
      <url>2020/09/19/work-trans-refund-table.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>è¿‘æœŸåšæ–°é¡¹ç›®ï¼Œåœ¨è®¾è®¡è¡¨ç»“æ„çš„æ—¶å€™ï¼Œçªç„¶æƒ³èµ·æ¥ä¹‹å‰é¢è¯•çš„æ—¶å€™é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œé‚£æ—¶å€™ä¹Ÿæ˜¯åˆå‡ºèŒ…åºï¼Œå¯¹å¾ˆå¤šä¸œè¥¿ä¸€çŸ¥åŠè§£ï¼ˆå½“ç„¶ç°åœ¨ä¹Ÿæ˜¯ï¼‰ï¼Œå½“æ—¶é‚£ä¸ªå°å“¥å“¥é—®æˆ‘ä¸ºä»€ä¹ˆäº¤æ˜“å’Œé€€æ¬¾è¦æ‹†æˆä¸¤ä¸ªè¡¨ï¼Ÿæ˜¯åŸºäºä»€ä¹ˆè€ƒè™‘ï¼Ÿæœ‰ä»€ä¹ˆå¥½å¤„å’Œä¼˜ç‚¹ä¹ˆï¼Ÿ</p></blockquote><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>é‚£æ˜¯ä¸€ä¸ªé£å’Œæ—¥ä¸½çš„ä¸‹åˆï¼Œå½“ç„¶ï¼Œé£å’Œæ—¥ä¸½çš„ä¸‹åˆåº”è¯¥é…ç‚¹å…¶ä»–çš„å½¢å®¹è¯ï¼Œå®åœ¨æ˜¯æˆ‘æ‰ç–å­¦æµ…ï¼Œåªèƒ½ç”¨è¿™ä¸ªè¯å……å½“äº†ä¸‹å¼€å¤´â€¦â€¦ ï¼ˆæ­¤å¤„çœç•¥å°äº”åƒå­—ï¼‰</p><p>èµ¶ç´§è¿›å…¥æ­£æ–‡ï¼</p><p>å› ä¸ºä¹‹å‰ä¸€ç›´åš<strong>èšåˆæ”¯ä»˜</strong>ï¼Œè€Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œä¹Ÿæ˜¯æ”¯ä»˜å’Œé€€æ¬¾è¡¨æ‹†å¼€çš„ï¼Œä¸€ç›´è¿™ä¹ˆç”¨ï¼Œå¹¶æ²¡æœ‰è§‰å¾—ä¸å¦¥ã€‚</p><p>æ¯”å¦‚ä¸€ä¸ªäº¤æ˜“è¡¨åŸºæœ¬å°±æ˜¯è¿™æ ·çš„ï¼š</p><table><thead><tr><th>å­—æ®µ</th><th>ç±»å‹</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>id</td><td>bigint</td><td>ä¸»é”® id</td></tr><tr><td>trans_id</td><td>varchar</td><td>äº¤æ˜“è®¢å•å·</td></tr><tr><td>trans_amount</td><td>bigint</td><td>è®¢å•é‡‘é¢</td></tr><tr><td>trans_status</td><td>tinyint</td><td>äº¤æ˜“çŠ¶æ€</td></tr><tr><td>â€¦â€¦</td><td>â€¦â€¦</td><td>â€¦â€¦</td></tr><tr><td>create_time</td><td>datetime</td><td>åˆ›å»ºæ—¶é—´</td></tr><tr><td>update_time</td><td>datetime</td><td>æ›´æ–°æ—¶é—´</td></tr></tbody></table><p>é€€æ¬¾è¡¨æ˜¯è¿™æ ·å­çš„ï¼š</p><table><thead><tr><th>å­—æ®µ</th><th>ç±»å‹</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>id</td><td>bigint</td><td>ä¸»é”® id</td></tr><tr><td>refund_id</td><td>varchar</td><td>é€€æ¬¾è®¢å•å·</td></tr><tr><td>origin_trans_id</td><td>varchar</td><td>åŸå§‹äº¤æ˜“è®¢å•å·</td></tr><tr><td>refund_status</td><td>tinyint</td><td>é€€æ¬¾çŠ¶æ€</td></tr><tr><td>refund_amount</td><td>bigint</td><td>é€€æ¬¾é‡‘é¢</td></tr><tr><td>â€¦â€¦</td><td>â€¦â€¦</td><td>â€¦â€¦</td></tr><tr><td>create_time</td><td>datetime</td><td>åˆ›å»ºæ—¶é—´</td></tr><tr><td>update_time</td><td>datetime</td><td>æ›´æ–°æ—¶é—´</td></tr></tbody></table><p>å¤§æ¦‚ä¸¤ä¸ªè¡¨å°±æ˜¯è¿™æ ·å­çš„å§ï¼åƒä¸€äº›å…¶ä»–å­—æ®µå°±å…ˆçœç•¥äº†ï¼Œå¹³å¸¸ç”¨ç€ä¹Ÿè§‰å¾—æ²¡ä»€ä¹ˆã€‚</p><p>ä½†æ˜¯æ°å¥½é‚£æ¬¡é‚£ä¸ªå°å“¥å“¥å°±é—®äº†è¿™ä¸ªé—®é¢˜ï¼Œæ”¯ä»˜å’Œé€€æ¬¾ä¸ºä»€ä¹ˆè¦åˆ†å¼€è®°å½•ï¼Ÿ</p><p>å½“æ—¶ä¹Ÿæ˜¯ç¡®å®æ˜¯å®åŠ›ä¸å…è®¸ï¼Œæˆ‘åªæ˜¯è¯´äº†å°±æ˜¯è¿™ä¹ˆç”¨çš„ï¼ŒæŠŠæ­£å‘æµç¨‹å’Œé€†å‘æµç¨‹æ‹†å¼€ï¼Œåˆ†å¼€å®ç°é€»è¾‘ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚</p><h3 id="ä¸ªäººè§è§£"><a href="#ä¸ªäººè§è§£" class="headerlink" title="ä¸ªäººè§è§£"></a>ä¸ªäººè§è§£</h3><p>è¿™é‡Œè¯´çš„ä¸ä»…ä»…æ˜¯äº¤æ˜“å’Œé€€æ¬¾ï¼ŒåŒæ—¶æ³›æŒ‡æ­£å‘äº¤æ˜“å’Œé€†å‘äº¤æ˜“ï¼Œæ¯”å¦‚å……å€¼å’Œæ¶ˆè´¹ï¼Œå€Ÿæ¬¾å’Œè´·æ¬¾ï¼Œè´¦æˆ·å‡ºè´¦å…¥è´¦ç­‰ç­‰ï¼Œä¸‹é¢ä»…è¯´è¯´ä¸ªäººè§è§£ï¼Œ<strong>åªåšè®¨è®º</strong>ï¼Œå¦‚æœå°ä¼™ä¼´æœ‰æ›´å¥½çš„è¯´æ³•ï¼Œå¸Œæœ›å¯ä»¥ç•™è¨€æŒ‡å‡ºï¼Œå…±åŒå­¦ä¹ ã€‚</p><h4 id="å¯¹è´¦éœ€è¦"><a href="#å¯¹è´¦éœ€è¦" class="headerlink" title="å¯¹è´¦éœ€è¦"></a>å¯¹è´¦éœ€è¦</h4><p>å¯¹è´¦æˆ·è€Œè¨€ï¼Œå‡ºæ¬¾è¡¨å’Œå…¥æ¬¾è¡¨æœ€åä¸¤æ–¹çš„é‡‘é¢æ˜¯èƒ½å¯¹çš„ä¸Šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>æ”¶æ”¯å¹³è¡¡</strong>ã€‚</p><p>å½“ç„¶è¿™ä¸ªè®°åœ¨ä¸€ä¸ªè¡¨é‡Œä¹Ÿæ˜¯å®Œå…¨å¯ä»¥çš„ã€‚æ¯•ç«Ÿå¯¹å‡ºå…¥è´¦åªæ˜¯æµæ°´æ²¡æœ‰çŠ¶æ€å˜åŒ–ï¼Œæ¯”å¦‚å‡ºè´¦ä¸­ï¼Œå…¥è´¦ä¸­ï¼Œç­‰ç­‰ï¼Œæµæ°´è¡¨å®Œå…¨å¯ä»¥è®°åœ¨ä¸€ä¸ªé‡Œé¢ï¼Œç„¶åç”¨å­—æ®µè¿›è¡Œæ ‡è¯†æ˜¯å‡ºè´¦è¿˜æ˜¯å…¥è´¦ã€‚</p><h4 id="æ‹†è¡¨éœ€è¦"><a href="#æ‹†è¡¨éœ€è¦" class="headerlink" title="æ‹†è¡¨éœ€è¦"></a>æ‹†è¡¨éœ€è¦</h4><p>åœ¨ç½‘ä¸Šçœ‹èµ„æ–™ç»å¸¸ä¼šè¯´<strong>åˆ†åº“åˆ†è¡¨</strong>ï¼Œè€Œåƒè®¢å•è¿™ç§ï¼ˆäº¤æ˜“/é€€æ¬¾ï¼‰å®Œå…¨ä¸¤ç§ä¸šåŠ¡ï¼Œä½¿ç”¨ä¸¤å¼ è¡¨ç›¸å¯¹è€Œè¨€æ¯”è¾ƒåˆé€‚ï¼Œæ¯•ç«Ÿ<strong>äº¤æ˜“</strong>çš„è®¢å•ç›¸æ¯”é€€æ¬¾è®¢å•è¦å¤šçš„å¤šã€‚</p><h4 id="å­—æ®µè®¾è®¡"><a href="#å­—æ®µè®¾è®¡" class="headerlink" title="å­—æ®µè®¾è®¡"></a>å­—æ®µè®¾è®¡</h4><p>äº¤æ˜“å’Œé€€æ¬¾æ˜¯å®Œå…¨ä¸åŒçš„ä¸¤ç§ä¸šåŠ¡ï¼Œä¸åƒè´¦æˆ·æµæ°´å°±æ˜¯èµ„é‡‘è®°å½•ã€‚</p><p>äº¤æ˜“é™¤äº†è®¢å•çŠ¶æ€è¿˜æœ‰ä¸€äº›äº¤æ˜“ä¿¡æ¯æ¯”å¦‚å•†æˆ·å·ã€ä¼˜æƒ é‡‘é¢ã€å®ä»˜é‡‘é¢ã€äº¤æ˜“æ¸ é“ã€å•†å“ id åç§°ã€å¤‡æ³¨ç­‰å„ç§ä¿¡æ¯ã€‚</p><p>é€€æ¬¾åˆ™æ˜¯æ ¹æ®åŸå•è¿›è¡Œé€€æ¬¾ï¼Œéœ€è¦è®°å½•åŸå§‹è®¢å•å·ã€é€€æ¬¾é‡‘é¢ï¼ˆéƒ¨åˆ†é€€æ¬¾ï¼‰ã€é€€æ¬¾ä¿¡æ¯ç­‰ã€‚</p><p>è™½ç„¶äº¤æ˜“å’Œé€€æ¬¾æ€»ä½“ä¸Šéƒ½åŒ…å« è®¢å•å·ã€çŠ¶æ€ã€é‡‘é¢ç­‰ï¼Œä½†æ˜¯å¦‚æœå¼ºè¡Œæ”¾åœ¨ä¸€ä¸ªè¡¨ï¼Œå°±ä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š</p><ol><li>å¾ˆå¤šå­—æ®µä¸ºç©ºçš„æƒ…å†µï¼Œæ¯”å¦‚äº¤æ˜“ä¸éœ€è¦åŸå§‹è®¢å•å·ï¼Œé€€æ¬¾éœ€è¦å­˜å‚¨åŸå§‹è®¢å•å·ã€‚æœ¬æ¥å¯ä»¥è®¾ç½®ç´¢å¼•æ¥æé«˜æŸ¥è¯¢æ•ˆç‡çš„å­—æ®µä¹Ÿä¸å¤ªåˆé€‚è®¾ç½®äº†ã€‚</li><li>çŠ¶æ€ä¹Ÿä¸ä¸€å®šå¯ä»¥å®Œå…¨å…¼å®¹ï¼Œåƒäº¤æ˜“çŠ¶æ€å’Œé€€æ¬¾çŠ¶æ€å°±å¾ˆéš¾äº’ç›¸å…¼å®¹ã€‚</li></ol><h4 id="å¼€å‘æ•ˆç‡"><a href="#å¼€å‘æ•ˆç‡" class="headerlink" title="å¼€å‘æ•ˆç‡"></a>å¼€å‘æ•ˆç‡</h4><p>äº¤æ˜“å’Œé€€æ¬¾åˆ†å¼€ä¹‹åï¼Œä¸¤ä¸ªäººè´Ÿè´£ä¸åŒçš„ä¸šåŠ¡è¿›è¡Œå¼€å‘ï¼ŒåŒ…æ‹¬ä¸šåŠ¡é€»è¾‘å’ŒæŸ¥è¯¢å±•ç¤ºã€‚å¦‚æœæ”¾åœ¨ä¸€èµ·ï¼Œå°±å¾ˆå¤šå­—æ®µä¸èƒ½ä¿è¯åˆ«äººçŸ¥é“æœ‰è¿˜æ˜¯æ²¡æœ‰ï¼Œæ˜¯å­˜å‚¨è¿˜æ˜¯ä¸å­˜å‚¨ï¼Œæ¯•ç«Ÿè¡¨é‡Œè®¾ç½®çš„éƒ½å¯ä»¥ä¸ºç©ºã€‚è¿™ç§æƒ…å†µä¸‹éœ€è¦å¾ˆå¤šæ²Ÿé€šï¼Œæˆ–è€…å¹²è„†ä¸€ä¸ªäººè¿›è¡Œå¼€å‘ã€‚</p><h4 id="è®¾è®¡æ¨¡å¼åŠåŸåˆ™"><a href="#è®¾è®¡æ¨¡å¼åŠåŸåˆ™" class="headerlink" title="è®¾è®¡æ¨¡å¼åŠåŸåˆ™"></a>è®¾è®¡æ¨¡å¼åŠåŸåˆ™</h4><p>å…¶ä»–ä»è®¾è®¡æ¨¡å¼åŠåŸåˆ™çš„è§’åº¦ä¸Šæ¥è¯´ï¼Œå¯ä»¥è¯´æ˜¯èŒè´£å•ä¸€ï¼Œå½“ç„¶å†é«˜å¤§ä¸Šåç†è®ºçš„æˆ‘è¿™å°±æ‰¯ä¸å‡ºæ¥äº†ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p><strong>Q: é‚£å‰ç«¯è¦å°†ä¸¤ç§ç”šè‡³å¤šç§åœ¨ä¸€ä¸ªåˆ—è¡¨å±•ç¤ºè¯¥å¦‚ä½•å¤„ç†ï¼Ÿ</strong></p><p><strong>A:</strong> åœ¨å¾ˆå¤š APP ä¸­å¤§å®¶çœ‹åˆ°çš„å¤šç§è®¢å•éƒ½æ˜¯åœ¨ä¸€ä¸ªåˆ—è¡¨é‡Œé¢å±•ç¤ºå‡ºæ¥çš„ï¼Œæ¯”å¦‚ï¼šæ”¯ä»˜å®çš„è´¦å•é¡µé¢ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœå‰ç«¯åˆ† tab é¡µï¼Œåˆ†å¼€å±•ç¤ºä¸åŒçš„ä¸šåŠ¡ï¼Œé‚£å¯¹åç«¯æ¥è¯´ç®€ç›´ä¸è¦å¤ªå‹å¥½ã€‚ä¸è¿‡å®é™…å¾€å¾€ä¸æ˜¯è¿™æ ·ï¼Œè¿™æ—¶å€™å°±éœ€è¦å°†è®¢å•ç»Ÿä¸€å­˜å‚¨ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/LDZJYc-IFUqcP.png" alt="LDZJYc-IFUqcP"></p><p>åœ¨è®¢å•æˆåŠŸçš„æ—¶å€™å­˜å‚¨åˆ°ä¸€ä¸ªå…¬å…±å­˜å‚¨ä¸­ï¼Œå¯ä»¥é€šè¿‡ MQ ç­‰ï¼Œå°†æ•°æ®ä¿é€åˆ°å¦ä¸€å¼ è¡¨/åº“ï¼Œæˆ–è€… ES ä¸­ç”¨æ¥å­˜å‚¨ã€‚è¿™æ ·è®¢å•æŸ¥è¯¢è¿˜å¯ä»¥å’Œä¸šåŠ¡é€»è¾‘çš„è¡¨/åº“åˆ†å¼€ã€‚ä¹Ÿå¯ä»¥é€šè¿‡ binlog è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œçš„æ–¹æ¡ˆåªåšå‚è€ƒã€‚</p><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>ä¹‹æ‰€ä»¥å†™è¿™ç¯‡æ–‡ç« ï¼Œä¹Ÿæ˜¯ä¸ºäº†æ€»ç»“ä¸€ä¸‹æœ€è¿‘å·¥ä½œä¸­é‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠå¤„ç†æ–¹æ³•ã€‚åŒæ—¶ä¸€ç¬é—´æƒ³èµ·æ¥äº†å¾ˆä¹…å‰é‡åˆ°çš„ç›¸åŒçš„é—®é¢˜ã€‚</p><p>å¦‚æœå°ä¼™ä¼´ä»¬è¿˜æœ‰åˆ«çš„çœ‹æ³•ï¼Œæ¬¢è¿ç•™è¨€ï¼Œå‘è¡¨è‡ªå·±çš„æ„è§åŠçœ‹æ³•ï¼Œå…±åŒè®¨è®ºã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å·¥ä½œç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥ä½œç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- CyclicBarrier ä¸å°±æ˜¯æ¯” CountDownLatch å¤šäº†ä¸ªå›ç¯ä¹ˆï¼Ÿ</title>
      <link href="2020/09/13/source-code-cyclicbarrier.html"/>
      <url>2020/09/13/source-code-cyclicbarrier.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>çœ‹å®Œ CountDownLatch æ­£å‡†å¤‡è¡¨ç¤ºä¸€ç•ªï¼Œçªç„¶çœ‹åˆ°äº†ä¸€ä¸ª CyclicBarrier â€”â€” å›ç¯å±éšœã€‚æ²ƒç‰¹ï¼Ÿå›ç¯è¿˜å±éšœï¼Ÿè¯´æ¯” CountDownLatch è¦å¤šä¸€ä¸ªå›ç¯ï¼Œé‚£å’±å¯å¾—ç§ä¸€ç§ï¼Œçœ‹ä¸€çœ‹äº†ï¼</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>ä¸€ä¸ªåŒæ­¥è¾…åŠ©ï¼Œå®ƒå…è®¸ä¸€ç»„çº¿ç¨‹çš„æ‰€æœ‰ç­‰å¾…å½¼æ­¤è¾¾æˆå…±åŒå±éšœç‚¹ã€‚ </p><p>CyclicBarrier åœ¨æ¶‰åŠå›ºå®šçº¿ç¨‹æ•°ä¸”å¿…é¡»ç­‰å¾…å½¼æ­¤çš„ç¨‹åºéå¸¸æœ‰ç”¨ã€‚ </p><p>è¯¥å±éšœè¢«ç§°ä¸ºå›ç¯å±éšœ ï¼Œå› ä¸ºå®ƒåœ¨ç­‰å¾…çš„çº¿ç¨‹è¢«é‡Šæ”¾åå¯ä»¥è¢«é‡æ–°åˆ©ç”¨ã€‚</p><p>CyclicBarrier æ”¯æŒä¸€ä¸ªå¯é€‰çš„ Runnable å‘½ä»¤ï¼Œè¯¥å‘½ä»¤åœ¨éšœç¢ä¸­çš„æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾ä¹‹åï¼Œä½†åœ¨é‡Šæ”¾ä»»ä½•çº¿ç¨‹ä¹‹å‰ï¼Œæ¯ä¸ªå±éšœç‚¹è¿è¡Œä¸€æ¬¡ã€‚</p><p>æ­¤å±éšœæ“ä½œå¯¹äºåœ¨ä»»ä½•ä¸€æ–¹ç»§ç»­ä¹‹å‰æ›´æ–°å…±äº«çŠ¶æ€å¾ˆæœ‰ç”¨ã€‚</p><p>é€šè¿‡ä¸Šé¢çš„æºç æ³¨é‡ŠåŸºæœ¬å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š</p><ol><li>CyclicBarrier å’Œ CountDownLatch ç±»ä¼¼ï¼Œä½†å®ƒæ˜¯ä¸€ç»„çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œçš„ä¸€ç»„æ“ä½œå®Œæˆä¸ºæ­¢ã€‚</li><li>CountDownLatch æ˜¯è®¡æ•°é€’å‡ï¼Œç»“æŸåå†è°ƒç”¨ await æˆ–è€… countdown éƒ½ä¼šç«‹å³è¿”å›ï¼Œä½†æ˜¯ CyclicBarrier å¯ä»¥é‡ç½®å±éšœã€‚</li><li>CyclicBarrier è¿˜å¯ä»¥ä¼ å…¥å‚æ•° Runnable ï¼ŒRunnable ä¼šåœ¨é‡Šæ”¾çº¿ç¨‹ä¹‹å‰æ‰§è¡Œã€‚</li></ol><h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><p>æ—¢ç„¶ä¸Šé¢æ€»ç»“äº†ä¸‰ä¸ªç»“è®ºï¼Œä¸‹é¢å½“ç„¶ä»ä¸‰ä¸ªæ–¹é¢æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨çš„ï¼š</p><p><strong>- å±éšœåŠŸèƒ½</strong> </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CyclicBarrier CYCLIC_BARRIER = <span class="keyword">new</span> CyclicBarrier(<span class="number">11</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> BrokenBarrierException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">10</span>, <span class="number">10</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">1024</span>),</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryBuilder().setNameFormat(<span class="string">&quot;Thread-pool-%d&quot;</span>).build(),</span><br><span class="line">                <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            pool.submit(() -&gt; &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; å¼€å§‹æ‰§è¡Œ&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; æ‰§è¡Œç»“æŸï¼Œå‡†å¤‡è°ƒç”¨ await&quot;</span>);</span><br><span class="line">                    CYCLIC_BARRIER.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹æ‰§è¡Œ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” &gt;&gt;&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        CYCLIC_BARRIER.await();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” &gt;&gt;&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        pool.shutdown();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢ä»£ç å…¶å®æ¨¡æ‹Ÿäº†ä¸ªç±»ä¼¼ CountDownLatch çš„åŠŸèƒ½ï¼Œè®©æ‰€æœ‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°éƒ½è°ƒç”¨ await ä¹‹åï¼Œå„ä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼ŒåŒæ—¶ä¸»çº¿ç¨‹ä¹Ÿç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p><p>ä¸è¿‡ç›¸å¯¹ CountDownLatch çš„æŒ‡å®šä¸€ä¸ªçº¿ç¨‹æˆ–å¤šä¸ªç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œç­‰å¾…çš„çº¿ç¨‹æ‰ç»§ç»­æ‰§è¡Œæ¥è¯´ï¼ŒCyclicBarrier ç›¸å¯¹æ¥è¯´è¿˜æ˜¯é€Šè‰²ã€‚</p><p>å·®åˆ«æ€»ç»“å¦‚ä¸‹ï¼š</p><ol><li>CountDownLatch æ˜¯æŒ‡å®šç­‰å¾…çš„çº¿ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹è¿›è¡Œ countDownï¼Œç­‰è®¡æ•°ä¸º 0 æ—¶ï¼Œç­‰å¾…çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚</li><li>CyclicBarrier æ˜¯ä¸€ç»„çº¿ç¨‹è°ƒç”¨ await è¿›è¡Œç­‰å¾…ï¼Œå½“æ‰€æœ‰çš„éƒ½è¿›å…¥ç­‰å¾…çš„æ—¶å€™ï¼Œè¿™ä¸€ç»„å°±ä¼šä¸€èµ·å†²ç ´å±éšœç»§ç»­æ‰§è¡Œã€‚</li></ol><p><strong>- å›ç¯åŠŸèƒ½</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CyclicBarrier CYCLIC_BARRIER = <span class="keyword">new</span> CyclicBarrier(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> BrokenBarrierException, InterruptedException </span>&#123;</span><br><span class="line">        </span><br><span class="line">        ExecutorService pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">5</span>, <span class="number">5</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">1024</span>),</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryBuilder().setNameFormat(<span class="string">&quot;Thread-pool-%d&quot;</span>).build(),</span><br><span class="line">                <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            pool.submit(() -&gt; &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; å¼€å§‹æ‰§è¡Œ&quot;</span>);</span><br><span class="line">                    CYCLIC_BARRIER.await();</span><br><span class="line"></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; å†²ç ´å±éšœ &gt;&gt;&gt; 1&quot;</span>);</span><br><span class="line">                    CYCLIC_BARRIER.await();</span><br><span class="line"></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; å†²ç ´å±éšœ &gt;&gt;&gt;&gt;&gt; 2&quot;</span>);</span><br><span class="line">                    CYCLIC_BARRIER.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://liuzhihang.com/oss/pic/article/carbon-gzpBD4.png" alt="carbon-gzpBD4"></p><p>ä¸Šé¢æ¼”ç¤ºçš„å›ç¯çš„ç”¨æ³•ã€‚</p><p><strong>- å›ç¯ Runnable</strong></p><p>è¿™å—åªéœ€è¦åœ¨å£°æ˜çš„ CyclicBarrier ä¿®æ”¹ä¸ºä»¥ä¸‹å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CyclicBarrier CYCLIC_BARRIER = <span class="keyword">new</span> CyclicBarrier(<span class="number">5</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œä¸€æ¬¡ Runnable &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœå¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://liuzhihang.com/oss/pic/article/carbon1-lHnKnA.png" alt="carbon1-lHnKnA"></p><p>å¯ä»¥çœ‹å‡ºåªæ˜¯åœ¨ä¸‹ä¸€ä¸ªè®¡æ•°å¼€å§‹ä¹‹å‰ï¼Œå…ˆæ‰§è¡Œ Runnable ã€‚è‡³äºæ˜¯ä¸æ˜¯åœ¨é‡Šæ”¾å±éšœä¹‹å‰ï¼Œé‚£å¾ˆå®¹æ˜“ï¼Œç›´æ¥ Debug èµ°ä¸€é­å°±çŸ¥é“äº†ï¼ä¸“é—¨å½•åˆ¶äº†ä¸ªè§†é¢‘ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://liuzhihang.com/oss/pic/article/cyclicBarrier-vl-5Bz3Xa.mov" alt="cyclicBarrier-vl-5Bz3Xa"></p><p>é€šè¿‡ debug å¯ä»¥çœ‹å‡º<strong>Runnable ä¼šåœ¨é‡Šæ”¾çº¿ç¨‹ä¹‹å‰æ‰§è¡Œ</strong>ã€‚</p><h4 id="é—®é¢˜ç–‘é—®ï¼Ÿ"><a href="#é—®é¢˜ç–‘é—®ï¼Ÿ" class="headerlink" title="é—®é¢˜ç–‘é—®ï¼Ÿ"></a>é—®é¢˜ç–‘é—®ï¼Ÿ</h4><ol><li>CyclicBarrier å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</li><li>CyclicBarrier çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>CyclicBarrier æ˜¯å¦‚ä½•å®ç°å›ç¯çš„ï¼Ÿ</li></ol><p>ä¸‹é¢å°±å¸¦ç€ç–‘é—®å»æºç é˜…è¯»ï¼Œä¸€æ¢ç©¶ç«Ÿï¼</p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://liuzhihang.com/oss/pic/article/CleanShot-2020-09-12-KFzaCR0G@2x-seVhre.png" alt="CleanShot-2020-09-12-KFzaCR0G@2x-seVhre"></p><p>é€šè¿‡ UML ä¹ä¸€çœ‹ï¼ŒCyclicBarrier å’Œ AQS å¹¶æ— ä»€ä¹ˆå…³ç³»ï¼Œé‚£ä¸‹é¢å¼€å§‹ä»<strong>å‚æ•°</strong>ã€<strong>æ„é€ å™¨</strong>ã€<strong>await()æ–¹æ³•</strong>åˆ†åˆ«çœ‹æºç ã€‚</p><h4 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrier</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å±éšœçš„æ¯æ¬¡ä½¿ç”¨éƒ½è¡¨ç¤ºä¸ºä¸€ä¸ªç”Ÿæˆå®ä¾‹ã€‚</span></span><br><span class="line"><span class="comment">     * broken è¡¨ç¤ºå±éšœæ˜¯å¦è¢«æ‰“ç ´ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Generation</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> broken = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** é” */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="comment">/** æ¡ä»¶ç­‰å¾…ï¼Œç›´åˆ°å±éšœ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition trip = lock.newCondition();</span><br><span class="line">    <span class="comment">/** ç­‰å¾…è®¡æ•° */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> parties;</span><br><span class="line">    <span class="comment">/* The command to run when tripped */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Runnable barrierCommand;</span><br><span class="line">    <span class="comment">/** å½“å‰ generation æ–°åˆ›å»ºçš„*/</span></span><br><span class="line">    <span class="keyword">private</span> Generation generation = <span class="keyword">new</span> Generation();</span><br><span class="line">    <span class="comment">/** ä»åœ¨ç­‰å¾…çš„ parties æ•°é‡ï¼Œé€’å‡ ä¸º 0 ä¼šé‡ç½® */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼š</p><p>å†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ªé™æ€ç±» Generation ï¼Œå®ƒæœ‰ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿé€šè¿‡æ³¨é‡Šäº†è§£åˆ°ï¼Œæ¯æ¬¡ä½¿ç”¨å±éšœçš„æ—¶å€™éƒ½ä¼šç”Ÿæˆï¼Œå…·ä½“æœ‰ä»€ä¹ˆç”¨ï¼Œå…¶å®å°±æ˜¯ç”¨æ¥æ ‡ç¤ºå±éšœæ˜¯å¦è¢«æ‰“ç ´ã€‚</p><p>å†…éƒ¨è¿˜æœ‰ä¸€ä¸ª parties è¡¨ç¤ºç­‰å¾…è®¡æ•°ï¼Œcount è¡¨ç¤ºä»åœ¨ç­‰å¾…çš„è®¡æ•°ã€‚</p><p>é‚£å°±ç»§ç»­å¾€ä¸‹çœ‹å§ï¼</p><h4 id="æ„é€ å™¨"><a href="#æ„é€ å™¨" class="headerlink" title="æ„é€ å™¨"></a>æ„é€ å™¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CyclicBarrier</span><span class="params">(<span class="keyword">int</span> parties, Runnable barrierAction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parties &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">this</span>.parties = parties;</span><br><span class="line">    <span class="keyword">this</span>.count = parties;</span><br><span class="line">    <span class="keyword">this</span>.barrierCommand = barrierAction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å…¥å‚æœ‰ä¸¤ä¸ªï¼š</p><ul><li>partiesï¼ˆç­‰å¾…è®¡æ•°ï¼‰ï¼šè®°å½•å¤šå°‘ä¸ªçº¿ç¨‹è°ƒç”¨ await ä¹‹åï¼Œæ‰ä¼šä¸€èµ·æ‰“ç ´å±éšœã€‚</li><li>barrierActionï¼šå†²ç ´å±éšœå‰æ‰§è¡Œçš„è¡Œä¸ºã€‚</li><li>ä½†æ˜¯ä¼šåŒæ—¶å¯¹ parties å’Œ count èµ‹å€¼ä¸ºä¼ å…¥çš„ partiesã€‚</li></ul><p>å•å‚æ•°æ„é€ ï¼Œå…¶å®å°±æ˜¯å°† barrierAction èµ‹å€¼ä¸º nullã€‚</p><h4 id="await-æ–¹æ³•"><a href="#await-æ–¹æ³•" class="headerlink" title="await() æ–¹æ³•"></a>await() æ–¹æ³•</h4><p>åœ¨ç¤ºä¾‹ä¸­ç”¨çš„ <strong>await()</strong> æ–¹æ³•ï¼Œ é‚£å°±ä» <strong>await()</strong> æ–¹æ³•å…¥æ‰‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dowait(<span class="keyword">false</span>, <span class="number">0L</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TimeoutException toe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(toe); <span class="comment">// cannot happen</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>await() æ‰æ˜¯é‡å¤´æˆï¼Œ å…ˆæ¥æ ¹æ®æºç æ³¨é‡Šï¼Œäº†è§£æ˜¯å¹²å˜›çš„ï¼Œçœ‹çœ‹ä½œè€…æ€ä¹ˆè®²ï¼š</p><ol><li>ç­‰åˆ°æ‰€æœ‰å„æ–¹éƒ½åœ¨æ­¤éšœç¢ä¸Šè°ƒç”¨awaitã€‚</li><li>å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æœ€ååˆ°è¾¾çš„çº¿ç¨‹ï¼Œåˆ™å‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„å°†å…¶ç¦ç”¨ï¼Œå¹¶ä½¿å…¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹æƒ…å†µä¹‹ä¸€ï¼š<ol><li>æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾ï¼›</li><li>å…¶ä»–ä¸€äº›çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ï¼›</li><li>å…¶ä»–ä¸€äº›çº¿ç¨‹ä¸­æ–­å…¶ä»–æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ä¹‹ä¸€ï¼›</li><li>ç­‰å¾…å±éšœçš„æ—¶å€™å…¶ä»–çº¿ç¨‹è¶…æ—¶ï¼›</li><li>å…¶ä»–ä¸€äº›çº¿ç¨‹åœ¨æ­¤å±éšœä¸Šè°ƒç”¨ resetã€‚</li></ol></li></ol><p>çœ‹åˆ°è¿™äº›ï¼Œå’±ä»¬æœ€æƒ³çœ‹çš„å½“ç„¶æ˜¯ 2.1 ï¼Œç­‰å¾…æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœï¼Œä¹‹åæ‰€æœ‰çš„çº¿ç¨‹ä¸€èµ·ç»§ç»­æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">dowait</span><span class="params">(<span class="keyword">boolean</span> timed, <span class="keyword">long</span> nanos)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException, BrokenBarrierException,</span></span><br><span class="line"><span class="function">            TimeoutException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨è¿™é‡Œç”¨åˆ°äº†è¿™ä¸ªä»£</span></span><br><span class="line">        <span class="keyword">final</span> Generation g = generation;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (g.broken)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BrokenBarrierException();</span><br><span class="line">        <span class="comment">// çº¿ç¨‹ç»ˆä¸­æ–­æ ‡ç¤º</span></span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            breakBarrier();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯¹è®¡æ•°è¿›è¡Œé€’å‡</span></span><br><span class="line">        <span class="keyword">int</span> index = --count;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ 0 åˆ™</span></span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;  <span class="comment">// tripped</span></span><br><span class="line">            <span class="keyword">boolean</span> ranAction = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> Runnable command = barrierCommand;</span><br><span class="line">                <span class="comment">// ä¸æ˜¯ null å…ˆæ‰§è¡Œè¡Œä¸º</span></span><br><span class="line">                <span class="keyword">if</span> (command != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">// è¿™é‡Œä¸æ˜¯æ–°å¼€çº¿ç¨‹</span></span><br><span class="line">                    command.run();</span><br><span class="line">                ranAction = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">// ä¸‹ä¸€ä»£</span></span><br><span class="line">                nextGeneration();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// ä»»åŠ¡æœªæˆåŠŸæ—¶ï¼Œå³ ranAction è¿˜æ˜¯ false æ‰“ç ´å±éšœ</span></span><br><span class="line">                <span class="keyword">if</span> (!ranAction)</span><br><span class="line">                    breakBarrier();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// loop until tripped, broken, interrupted, or timed out</span></span><br><span class="line">        <span class="comment">// è‡ªæ—‹</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">                <span class="keyword">if</span> (!timed)</span><br><span class="line">                <span class="comment">// è¿›å…¥ç­‰å¾…</span></span><br><span class="line">                    trip.await();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; <span class="number">0L</span>)</span><br><span class="line">                    nanos = trip.awaitNanos(nanos);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                <span class="keyword">if</span> (g == generation &amp;&amp; ! g.broken) &#123;</span><br><span class="line">                    breakBarrier();</span><br><span class="line">                    <span class="keyword">throw</span> ie;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (g.broken)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BrokenBarrierException();</span><br><span class="line">            <span class="comment">// å·²ç»ä¸‹ä¸€ä»£äº†</span></span><br><span class="line">            <span class="keyword">if</span> (g != generation)</span><br><span class="line">                <span class="keyword">return</span> index;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                breakBarrier();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€å¤§å¨ä»£ç ï¼Œå®Œå…¨æ²¡æœ‰çœ‹çš„æ¬²æœ›ï¼Œç›´æ¥åˆ’è¿‡å»å§ï¼</p><p>æ‰€ä»¥â€¦â€¦ ç›´æ¥çœ‹åˆ°äº†è¿™é‡Œå§ã€‚</p><p>ä»£ç è¿˜æ˜¯è¦é˜…è¯»çš„ï¼Œåˆ†å¼€æ¥çœ‹ï¼ˆå¼‚å¸¸æµç¨‹çœç•¥ï¼‰ï¼š</p><ol><li>ä½¿ç”¨äº† ReentrantLock äº’æ–¥é”ï¼Œå› æ­¤å¯¹ countã€broken çš„ä¿®æ”¹æ˜¯åŸå­æ€§çš„ã€‚</li><li>å¯¹ count è¿›è¡Œ â€“count æ“ä½œï¼Œè¿™æ ·å°±ç†è§£ä¸ºä»€ä¹ˆè¯´ count æ˜¯ä»åœ¨ç­‰å¾…çš„è®¡æ•°ï¼Œæˆ–è€…è¯´è¿˜æœ‰å¤šå°‘æ‰èƒ½åˆ°è¾¾å±éšœç‚¹ã€‚</li><li>å½“ count ä¸º 0 ï¼Œè¡¨ç¤ºåˆ°è¾¾å±éšœç‚¹äº†<ol><li><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://liuzhihang.com/oss/pic/article/cyclicbarrier-amQMu4.png" alt="cyclicbarrier-amQMu4"></li><li>command ä¸ä¸º nullï¼Œä¼šå…ˆæ‰§è¡Œ **command.run()**ï¼Œ å€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œå¹¶ä¸æ˜¯æ–°å¼€äº†ä¸ªçº¿ç¨‹ã€‚</li><li>**nextGeneration()**å¼€å§‹æ–°çš„ä¸‹ä¸€ä»£ï¼Œå³é‡ç½® count ä¸º partiesã€‚</li><li>åœ¨ finally é‡Œé¢ä½¿ç”¨ <strong>breakBarrier()</strong> æ‰“ç ´å±éšœã€‚</li></ol></li><li>å½“ count ä¸æ˜¯ 0<ol><li>è‡ªæ—‹ï¼Œç›´åˆ°æ˜¯ 0.</li></ol></li></ol><p>è¿™åé¢è¿˜æœ‰ä¸¤ä¸ªæ–¹æ³•ä¸èƒ½å°‘ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">nextGeneration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å”¤é†’çº¿ç¨‹</span></span><br><span class="line">    trip.signalAll();</span><br><span class="line">    <span class="comment">// æ›´æ–° count ä¸º parties</span></span><br><span class="line">    count = parties;</span><br><span class="line">    <span class="comment">// æ›´æ–° Generation</span></span><br><span class="line">    generation = <span class="keyword">new</span> Generation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ‰“ç ´å±éšœï¼Œå¹¶å”¤é†’å…¨éƒ¨</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">breakBarrier</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    generation.broken = <span class="keyword">true</span>;</span><br><span class="line">    count = parties;</span><br><span class="line">    trip.signalAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="reset"><a href="#reset" class="headerlink" title="reset()"></a>reset()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        breakBarrier();   <span class="comment">// break the current generation</span></span><br><span class="line">        nextGeneration(); <span class="comment">// start a new generation</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†å±éšœé‡ç½®ä¸ºå…¶åˆå§‹çŠ¶æ€ï¼Œreset() æ–¹æ³•å…¶å®è¿˜æ˜¯è°ƒç”¨çš„ breakBarrier() å’Œ nextGeneration()ï¼Œå‰è€…æ—¶æ‰“ç ´å½“å‰ä»£ï¼Œåè€…æ˜¯å¼€å§‹æ–°çš„ä¸€è½®ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><strong>Q: CyclicBarrier å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</strong><br><strong>A:</strong> é€šè¿‡é˜…è¯»æºç ï¼Œå…¶å®å‘ç°æ˜¯ä½¿ç”¨äº† ReentrantLock äº’æ–¥é” ä»¥åŠ Condition çš„ç­‰å¾…å”¤é†’åŠŸèƒ½ã€‚</p><p><strong>Q: CyclicBarrier çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</strong><br><strong>A:</strong> å†…éƒ¨å«æœ‰ä¸¤ä¸ªè®¡æ•°ï¼Œåˆ†åˆ«æ˜¯ parties å’Œ count ï¼Œåˆå§‹æ˜¯äºŒè€…ç›¸ç­‰ï¼Œå½“æœ‰çº¿ç¨‹è°ƒç”¨ await() æ—¶ï¼Œcount é€’å‡ï¼Œåªè¦ count ä¸ä¸º 0 ï¼Œ å°±ä¼šé˜»å¡çº¿ç¨‹ï¼Œç›´åˆ° count é€’å‡ä¸º 0 æ—¶ï¼Œæ­¤æ—¶ä¼šæ‰€æœ‰çº¿ç¨‹ä¸€èµ·é‡Šæ”¾ï¼ŒåŒæ—¶å°† count é‡ç½®ä¸º partiesã€‚</p><p><strong>Q: CyclicBarrier æ˜¯å¦‚ä½•å®ç°å›ç¯çš„ï¼Ÿ</strong><br><strong>A:</strong> ä½¿ç”¨ä¸¤ä¸ªè®¡æ•°ï¼Œcount é€’å‡ï¼Œå½“ count ä¸º 0 æ—¶ï¼Œä¼šé‡ç½®ä¸º partiesï¼Œä»è€Œè¾¾åˆ°å›ç¯æ•ˆæœã€‚</p><p><strong>Q: ä¸ºä»€ä¹ˆ count çš„ â€“count æ“ä½œæ²¡æœ‰ä½¿ç”¨ CASï¼Ÿ</strong><br><strong>A:</strong> å› ä¸ºå·²ç» lock.lock() äº†ï¼Œä½¿ç”¨äº† ReentrantLock é”èƒ½å¤Ÿä¿è¯ count çš„åŸå­æ€§ã€‚</p><h4 id="CyclicBarrier-å’Œ-CountDownLatch-çš„åŒºåˆ«"><a href="#CyclicBarrier-å’Œ-CountDownLatch-çš„åŒºåˆ«" class="headerlink" title="CyclicBarrier å’Œ CountDownLatch çš„åŒºåˆ«"></a>CyclicBarrier å’Œ CountDownLatch çš„åŒºåˆ«</h4><ol><li>å›ç¯ï¼šCyclicBarrier å¯ä»¥å›ç¯ï¼Œé‡æ–°è®¡æ•°ã€‚CountDownLatch åªèƒ½ä¸€è½®ã€‚</li><li>è®¡æ•°å™¨ï¼šCyclicBarrier çš„è®¡æ•°å™¨è‡ªå·±ç»´æŠ¤é€’å‡ï¼Œ CountDownLatch çš„è®¡æ•°å™¨ç»´æŠ¤åˆ™æ˜¯äº¤ç»™ä½¿ç”¨è€…ã€‚</li><li>é˜»å¡çº¿ç¨‹ï¼šCyclicBarrier é˜»å¡çš„æ˜¯è‡ªèº«ï¼Œå½“åˆ°è¾¾å±éšœåï¼Œæ‰€æœ‰è¢«é˜»å¡çš„çº¿ç¨‹ä¸€èµ·é‡Šæ”¾ã€‚CountDownLatch å¯ä»¥æŒ‡å®šé˜»å¡çº¿ç¨‹ã€‚</li></ol><h4 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h4><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† CyclicBarrier çš„å¸¸ç”¨æ–¹å¼ï¼Œé€šè¿‡æºç æ–¹å¼ï¼Œåˆ†æå¦‚ä½•è¾¾åˆ°å±éšœä»¥åŠå›ç¯çš„æ•ˆæœã€‚ä¸å¯¹ä¹‹å¤„ï¼Œè¯·å¤šæŒ‡æ­£ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å·¥å…·å†Œã€‘- ç»™å¤§å®¶ä»‹ç»ä¸‹ï¼Œè¿™æ˜¯æˆ‘çš„æµç¨‹å›¾è½¯ä»¶ â€”â€” draw.io</title>
      <link href="2020/09/06/source-tool-drawio.html"/>
      <url>2020/09/06/source-tool-drawio.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>ä¹‹å‰æ¨äº†ä¸€ç¯‡æ–‡ç« ã€Š<a href="https://mp.weixin.qq.com/s/Ktjcc_7XCPx6fU4Zn8Tmlg">åå¼ å›¾å¸¦å¤§å®¶çœ‹æ‡‚ ES åŸç† ï¼æ˜ç™½ä¸ºä»€ä¹ˆè¯´ï¼šES æ˜¯å‡†å®æ—¶çš„ï¼</a>ã€‹ï¼Œå¾ˆå¤šå°ä¼™ä¼´éƒ½æ¯”è¾ƒå¥½å¥‡åœ¨æ–‡ç« ä¸­çš„å›¾æ˜¯ç”¨çš„ä»€ä¹ˆç”»å›¾è½¯ä»¶ï¼Ÿçœ‹é‚£ä¹ˆæ˜æ˜¾çš„æ‰‹ç»˜é£æ ¼ï¼Œå½“ç„¶æ˜¯æ‰‹ç”»çš„å•¦ï¼ï¼ˆå¼€ç©ç¬‘ï¼‰ï¼Œå…¶å®æˆ‘ç”¨çš„æ˜¯ draw.io ï¼Œä¸‹é¢åˆ†äº«æˆ‘çš„ç”»å›¾è½¯ä»¶ â€”â€” draw.io ã€‚</p></blockquote><h3 id="ä¸ºä»€ä¹ˆéœ€è¦ç”»å›¾ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦ç”»å›¾ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ç”»å›¾ï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦ç”»å›¾ï¼Ÿ</h3><p>ä¿—è¯è¯´ï¼šâ€œä¸€å›¾é¡¶ç™¾å­—ï¼â€ï¼Œå¥½å§ï¼è¿™æ˜¯æˆ‘ç°æƒ³çš„ä¿—è¯ã€‚</p><p>åœ¨æ–°é¡¹ç›®å¼€å‘ï¼ŒæŠ€æœ¯åˆ†äº«ï¼Œé˜…è¯»ä»£ç ç¬”è®°ï¼Œæˆ–è€…é¢è¯•çš„æ—¶å€™ï¼Œç”»ä¸ªæµç¨‹å›¾ï¼Œæ¶æ„å›¾ç­‰ç­‰ï¼Œæ¯”è¾ƒç›´è§‚ï¼Œä¾¿äºç†è§£ç­‰ã€‚ä¼˜ç‚¹å•¥çš„å°±ä¸å¤šä»‹ç»äº†ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»æˆ‘çš„ç”»å›¾è½¯ä»¶ã€‚</p><h4 id="åŸºæœ¬è¦æ±‚"><a href="#åŸºæœ¬è¦æ±‚" class="headerlink" title="åŸºæœ¬è¦æ±‚"></a>åŸºæœ¬è¦æ±‚</h4><ol><li>å…è´¹</li><li>ä½¿ç”¨æ–¹ä¾¿</li><li>æ”¯æŒç¦»çº¿ä½¿ç”¨</li></ol><h4 id="ç”¨è¿‡çš„å…¶ä»–è½¯ä»¶"><a href="#ç”¨è¿‡çš„å…¶ä»–è½¯ä»¶" class="headerlink" title="ç”¨è¿‡çš„å…¶ä»–è½¯ä»¶"></a>ç”¨è¿‡çš„å…¶ä»–è½¯ä»¶</h4><ol><li>Visioï¼šä½¿ç”¨æ–¹ä¾¿ï¼Œåœ¨æœ€å¼€å§‹çš„æ—¶å€™å°±æ˜¯ä½¿ç”¨ Visioï¼Œä¸è¿‡åªèƒ½åœ¨ Win ç³»ç»Ÿä¸Šä½¿ç”¨ã€‚</li><li>ProcessOnï¼šåœ¨çº¿ç‰ˆï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œå¾ˆç®€æ´ã€‚ä¸ªäººå…è´¹ï¼Œä¸è¿‡é™åˆ¶æ–‡ä»¶æ•°é‡ã€‚</li><li>OmniGraffleï¼šMac å®¢æˆ·ç«¯ï¼Œæ”¶è´¹ï¼Œæœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œä¸è¿‡å¯¹æˆ‘æ¥è¯´æœ‰ç‚¹ç©ä¸ç†Ÿç»ƒã€‚</li><li>è¯­é›€ï¼šè¯­é›€ä¹Ÿæ”¯æŒç”»ç®€å•çš„æµç¨‹å›¾ã€‚</li><li>å…¶ä»–ä¸€äº›ï¼Œæš‚æ—¶æ²¡æƒ³èµ·æ¥çš„ã€‚</li></ol><p>ä½“éªŒäº†å¾ˆå¤šç”»å›¾è½¯ä»¶ï¼Œæœ€åè¿˜æ˜¯ï¼ˆæš‚æ—¶ï¼‰é€‰æ‹©äº† draw.io ã€‚ åŸå› å¾ˆç®€å•ï¼Œæ”¯æŒå¤šå¹³å°ï¼ˆç½‘é¡µ/Win/Mac/Linuxï¼‰ï¼Œå¼€æºå…è´¹ï¼Œæ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©å­˜å‚¨ä½ç½®ã€‚</p><p>ä¸‹é¢ç®€å•ä»‹ç»ä¸‹ draw.io</p><h3 id="draw-io"><a href="#draw-io" class="headerlink" title="draw.io"></a>draw.io</h3><h4 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h4><p>åœ¨çº¿ç‰ˆå¯ä»¥ç›´æ¥è®¿é—® <a href="https://draw.io/">https://draw.io</a> æˆ–è€… <a href="https://app.diagrams.net/">https://app.diagrams.net/</a> ä½¿ç”¨ï¼Œè¿›å»ä¹‹åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/draw-web-FlEHBo.png" alt="draw-web-FlEHBo"></p><p>å¯ä»¥é€‰æ‹©å­˜å‚¨ï¼Œå½“ç„¶ä¹Ÿæœ‰ç¦»çº¿ç‰ˆæœ¬ï¼Œå³ drawio-desktop ï¼Œä¸‹è½½åœ°å€ï¼š<a href="https://github.com/jgraph/drawio-desktop">https://github.com/jgraph/drawio-desktop</a></p><p>é€‰æ‹©å¯¹åº”çš„å¹³å°ä¸‹è½½å®‰è£…å³å¯ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/drawio-desktop-nj8Mpy.png" alt="drawio-desktop-nj8Mpy"></p><h4 id="è®¾ç½®è¯­è¨€"><a href="#è®¾ç½®è¯­è¨€" class="headerlink" title="è®¾ç½®è¯­è¨€"></a>è®¾ç½®è¯­è¨€</h4><p>æ‰“å¼€ app æˆ–è€… è¿›å…¥ app ä¹‹åå¯ä»¥è®¾ç½®è¯­è¨€ï¼Œå¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/drawio-desktop-1-sIyT2d.png" alt="drawio-desktop-1-sIyT2d"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/drawio-desktop-2-qmJ3XA.png" alt="drawio-desktop-2-qmJ3XA"></p><h4 id="ä½¿ç”¨-1"><a href="#ä½¿ç”¨-1" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h4><p>éƒ½å·²ç»åˆ°è¿™é‡Œäº†ï¼Œå°±ä¸ç”¨è¯´æ€ä¹ˆä½¿ç”¨çš„äº†å§ï¼ä¸‹é¢å±•ç¤ºä¹‹å‰ç”»çš„å›¾ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/draw-1-slJldy.png" alt="draw-1-slJldy"></p><h4 id="æ‰‹ç»˜é£æ ¼"><a href="#æ‰‹ç»˜é£æ ¼" class="headerlink" title="æ‰‹ç»˜é£æ ¼"></a>æ‰‹ç»˜é£æ ¼</h4><p>é‚£æ‰‹ç»˜é£æ ¼æ˜¯æ€ä¹ˆç”»çš„å‘¢ï¼Ÿ</p><p>ç§˜ç±å°±åœ¨å³ä¾§å·¥å…·æ ï¼Œé€‰ä¸­ Sketch é€‰é¡¹ï¼Œä¹‹åå›¾ç‰‡å°±ä¼šå˜ä¸ºæ‰‹ç»˜é£æ ¼çš„äº†ï¼</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/draw-2-smWIKE.png" alt="draw-2-smWIKE"></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†äº«æˆ‘å¸¸ç”¨çš„ç”»å›¾è½¯ä»¶ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥ä½¿ç”¨è¯•ä¸€ä¸‹ã€‚è½¯ä»¶ä¸‡ä¸‡åƒï¼Œè‡ªå·±ç”¨çš„é¡ºæ‰‹çš„æ‰æ˜¯æœ€é‡è¦çš„ã€‚ä¸è¿‡ draw.io è¿˜æ˜¯æ¯”è¾ƒæ¨èçš„ã€‚</p><p>åç»­æˆ‘ä¹Ÿä¼šåˆ†äº«ä¸€äº›å…¶ä»–è½¯ä»¶å·¥å…·ç­‰ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å…³æ³¨ä»¥ä¸‹ã€‚å¦‚æœæœ‰ä»€ä¹ˆæ¯”è¾ƒæœ‰è¶£æˆ–ç”Ÿäº§åŠ›è½¯ä»¶éƒ½å¯ä»¥ç»™æ¨èä¸‹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å·¥å…·å†Œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥å…·å†Œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- å¿«æ¥çœ‹çœ‹ï¼AQS å’Œ  CountDownLatch æœ‰æ€ä¹ˆæ ·çš„å…³ç³»ï¼Ÿ</title>
      <link href="2020/09/06/source-code-countdownlatch.html"/>
      <url>2020/09/06/source-code-countdownlatch.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>CountDownLatch ä¸€ä¸ªåŒæ­¥è¾…åŠ©å·¥å…·ï¼ŒåŒæ ·æ˜¯åŸºäº AQS å®ç°ï¼Œæœ¬ç¯‡æ–‡ä»¶ä¸»è¦æ˜¯ä»‹ç» CountDownLatch çš„ä½¿ç”¨ï¼Œä»¥åŠæºç ã€‚</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>ä¸€ä¸ªåŒæ­¥è¾…åŠ©å·¥å…·ï¼Œå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œçš„ä¸€ç»„æ“ä½œå®Œæˆä¸ºæ­¢</p><p>ä¸€ä¸ª CountDownLatch åˆå§‹åŒ–ä¸ºç»™å®šè®¡æ•°ã€‚ åœ¨ await æ–¹æ³•é˜»å¡ï¼Œè°ƒç”¨ countDown æ–¹æ³•ä¼šå‡å°‘è®¡æ•°ç›´åˆ°è¾¾åˆ°é›¶ï¼Œæ­¤åæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹è¢«é‡Šæ”¾ï¼Œä»»ä½•åç»­è°ƒç”¨ await éƒ½ä¼šç«‹å³è¿”å›ã€‚ è¿™æ˜¯ä¸€æ¬¡æ€§çš„ç°è±¡ - è®¡æ•°ä¸èƒ½å¤ä½ã€‚ å¦‚æœä½ éœ€è¦ä¸€ä¸ªç‰ˆæœ¬é‡ç½®è®¡æ•°ï¼Œè¯·è€ƒè™‘ä½¿ç”¨CyclicBarrier ã€‚</p><p>CountDownLatch æ˜¯ä¸€ç§é€šç”¨çš„åŒæ­¥å·¥å…·ï¼Œå¯ç”¨äºå¤šç§ç”¨é€”ã€‚ </p><ol><li>ç”¨ä½œä¸€ä¸ªç®€å•çš„å¼€/å…³é”å­˜å™¨ï¼Œæˆ–è€…é—¨ï¼šæ‰€æœ‰çº¿ç¨‹è°ƒç”¨awaitåœ¨é—¨å£ç­‰å¾…ï¼Œç›´åˆ°è¢«è°ƒç”¨ countDown çš„çº¿ç¨‹æ‰“å¼€ã€‚ </li><li>åˆå§‹åŒ–è®¡æ•°ä¸º N ï¼Œç”¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ° N ä¸ªçº¿ç¨‹å®ŒæˆæŸé¡¹æ“ä½œï¼Œæˆ–æŸäº›åŠ¨ä½œå·²ç»å®Œæˆ N æ¬¡ã€‚</li></ol><p>CountDownLatch ä¸€ä¸ªæœ‰ç”¨çš„å±æ€§æ˜¯ï¼Œå®ƒä¸è¦æ±‚è°ƒç”¨ countDown çº¿ç¨‹ç­‰å¾…è®¡æ•°åˆ°è¾¾é›¶ä¹‹å‰ç»§ç»­ï¼Œå®ƒåªæ˜¯é˜»æ­¢ä»»ä½•çº¿ç¨‹é€šè¿‡await ï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹å¯ä»¥é€šè¿‡ã€‚</p><h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><p>åœ¨æˆ‘ä¹‹å‰ CAS é‚£ç¯‡æ–‡ç« ã€Š<a href="https://mp.weixin.qq.com/s/nSZW-bZ_snQ0ZYyzeEBJiw">ä»JUCæºç çœ‹CASï¼Œæˆ‘åšäº†ä¸ªç¬”è®° â€¦â€¦</a>ã€‹ä¸­ä»‹ç» CAS ä¸¾ä¾‹æ—¶ä½¿ç”¨äº† CountDownLatchï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CasTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch LATCH = <span class="keyword">new</span> CountDownLatch(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> NUM_I = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> NUM_J = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger NUM_K = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService threadPool = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            threadPool.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                        NUM_I++;</span><br><span class="line">                        NUM_J++;</span><br><span class="line">                        NUM_K.incrementAndGet();</span><br><span class="line">                    &#125;</span><br><span class="line">                    LATCH.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        LATCH.await();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;NUM_I = &quot;</span> + NUM_I);</span><br><span class="line">        System.out.println(<span class="string">&quot;NUM_J = &quot;</span> + NUM_J);</span><br><span class="line">        System.out.println(<span class="string">&quot;NUM_K = &quot;</span> + NUM_K.get());</span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•ä»‹ç»ä¸‹è¿™æ®µä»£ç çš„ä¸»è¦é€»è¾‘åŠåŠŸèƒ½ï¼š</p><ol><li>CountDownLatch åˆå§‹åŒ–è®¡æ•°ä¸º 10 ã€‚</li><li>å¼€ 10 ä¸ªçº¿ç¨‹å»å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œä¸šåŠ¡é€»è¾‘ç»“æŸä¼šè°ƒç”¨ LATCH.countDown() å¯¹è®¡æ•°è¿›è¡Œ -1 æ“ä½œã€‚</li><li>åœ¨ LATCH.await() å¤„ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ° LATCH çš„å€¼ä¸º 0 ï¼Œå³ 10 ä¸ªçº¿ç¨‹ä¸šåŠ¡éƒ½å¤„ç†ç»“æŸã€‚</li><li>ç„¶åä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚</li></ol><h4 id="é—®é¢˜ç–‘é—®"><a href="#é—®é¢˜ç–‘é—®" class="headerlink" title="é—®é¢˜ç–‘é—®"></a>é—®é¢˜ç–‘é—®</h4><ol><li>CountDownLatch å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</li><li>CountDownLatch çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li></ol><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/uml-VAGlMb.png" alt="uml-VAGlMb"></p><p>é€šè¿‡ç±»å›¾å¯ä»¥çœ‹å‡ºï¼ŒCountDownLatch å†…éƒ¨å­˜åœ¨ä¸€ä¸ªé™æ€ç±» Syncï¼Œè€Œ Sync ç»§æ‰¿äº† AbstractQueuedSynchronizerã€‚å…·ä½“å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Œåˆ™ä¸‹é¢é€šè¿‡æºç å’Œç”»å›¾ä¸€æ­¥ä¸€æ­¥çš„è¿›è¡Œä»‹ç»ã€‚</p><h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CountDownLatch</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;count &lt; 0&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.sync = <span class="keyword">new</span> Sync(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆå§‹åŒ–æ„é€ å™¨å¯ä»¥çœ‹å‡ºï¼Œåœ¨ new åˆ›å»ºå¯¹è±¡æ—¶å¿…é¡»ä¼ é€’ä¸€ä¸ª int ç±»å‹çš„éè´Ÿæ•°ã€‚å®ç°é€»è¾‘å¯ä»¥çœ‹å‡ºï¼Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ª Sync å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4982264981922014374L</span>;</span><br><span class="line"></span><br><span class="line">    Sync(<span class="keyword">int</span> count) &#123;</span><br><span class="line">        setState(count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getState();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure><p>ä¹‹å‰åœ¨ä»‹ç» AQS æºç ä¸­å·²ç»ä»‹ç»äº† state çš„å«ä¹‰ï¼Œstate åœ¨ä¸åŒå­ç±»ä¸­ä»£è¡¨ä¸åŒçš„å«ä¹‰ã€‚</p><ol><li>åœ¨ ReentrantLock ä¸­ state ä»£è¡¨åŠ é”çŠ¶æ€ï¼Œ0 æ²¡æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äºç­‰äº 1 å·²ç»æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äº 1 è¯´æ˜è¯¥è·å¾—é”çš„çº¿ç¨‹å¤šæ¬¡é‡å…¥ã€‚</li><li>åœ¨ ReentrantReadWriteLock ä¸­ state ä»£è¡¨é”çš„çŠ¶æ€ã€‚state ä¸º 0 ï¼Œæ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œstate çš„é«˜ 16 ä¸ºä»£è¡¨è¯»é”çŠ¶æ€ï¼Œä½ 16 ä¸ºä»£è¡¨å†™é”çŠ¶æ€ã€‚é€šè¿‡ä½è¿ç®—å¯ä»¥è·å–è¯»å†™é”çš„å®é™…å€¼ã€‚</li><li>è€Œåœ¨è¿™é‡Œ ï¼ˆCountDownLatchï¼‰åˆ™ä»£è¡¨é—¨é—©æˆ–è€…è¯´è®¡æ•°çš„å€¼ã€‚</li></ol><h4 id="countDown"><a href="#countDown" class="headerlink" title="countDown"></a>countDown</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€’å‡é”å­˜å™¨çš„è®¡æ•°ï¼š</p><ul><li>å¦‚æœå½“å‰è®¡æ•°å¤§äºé›¶ï¼Œåˆ™é€’å‡ã€‚ </li><li>å¦‚æœè®¡æ•°åˆ°è¾¾é›¶ï¼Œåˆ™é‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚</li><li>å¦‚æœé‚£ä¹ˆå½“å‰è®¡æ•°ç­‰äºé›¶æ²¡æœ‰ä»»ä½•ååº”ã€‚</li></ul><p>æ­¤å¤„è°ƒç”¨çš„æ˜¯ AQS çš„ releaseShard() æ–¹æ³•ï¼Œé‡Šæ”¾å…±äº«èµ„æºã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AQS ä»£ç </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨ AQS é‡Šæ”¾å…±äº«èµ„æºæ–¹æ³•ä¸­ <strong>tryReleaseShared(arg)</strong> éƒ¨åˆ†æ˜¯åœ¨ CountDownLatch çš„å†…éƒ¨ç±» Sync ä¸­å®ç°çš„ï¼Œä»£ç éƒ¨åˆ†å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Decrement count; signal when transition to zero</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> nextc = c-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€’å‡æ›´æ–° state ï¼Œå¦‚æœ state ä¸º 0 åˆ™è¿”å› falseï¼Œå¦åˆ™è¿”å› true ã€‚</p><p>æ­¤æ—¶å†å¯¹ç…§ä¸Šé¢ AQS ä»£ç ï¼Œå‘ç°ï¼šå¦‚æœ tryReleaseShared è¿”å› true ï¼Œåˆ™ä¼šå”¤é†’åç»­èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œæ“ä½œã€‚æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ state ä¸ä¸º 0ï¼Œåˆ™ä¸ä¼šå”¤é†’åç»­èŠ‚ç‚¹ï¼Œç›´åˆ° state ä¸º 0 ã€‚</p><h4 id="await"><a href="#await" class="headerlink" title="await"></a>await</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°é”å­˜å™¨å€’è®¡æ•°è‡³é›¶ï¼Œé™¤éçº¿ç¨‹è¢«ä¸­æ–­ã€‚</p><ul><li><p>å¦‚æœå½“å‰è®¡æ•°ä¸ºé›¶ï¼Œåˆ™æ­¤æ–¹æ³•ç«‹å³è¿”å›ã€‚</p></li><li><p>å¦‚æœå½“å‰è®¡æ•°å¤§äºé›¶ï¼Œåˆ™å½“å‰çº¿ç¨‹ç”¨äºçº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œç¦ç”¨å¹¶ä¸€ç›´å¤„äºä¼‘çœ çŠ¶æ€çš„ä¸¤ä»¶äº‹æƒ…ä¹‹ä¸€å‘ç”Ÿï¼š</p><ul><li>å› è°ƒç”¨countDownæ–¹æ³•ä½¿è®¡æ•°è¾¾åˆ°0; </li><li>å…¶ä»–æŸäº›çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ã€‚</li></ul></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AQS å®šä¹‰äº† tryAcquireShared è¿”å›å€¼åˆ†ä¸º 3 ç§ï¼š</p><ol><li>å°äº 0: è¡¨ç¤ºå¤±è´¥ï¼›</li><li>ç­‰äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œä½†åç»­çš„èŠ‚ç‚¹ä¸èƒ½ä»¥å…±äº«æ¨¡å¼è·å–æˆåŠŸ; </li><li>å¤§äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œåç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¹Ÿå¯èƒ½ä¼šæˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåç»­ç­‰å¾…çº¿ç¨‹å¿…é¡»æ£€æŸ¥å¯ç”¨æ€§ã€‚</li></ol><p>å…¶ä¸­ tryAcquireShared åŒæ ·ç”± CountDownLatch çš„å†…éƒ¨ç±» Sync ä¸­å®ç°ï¼Œå†…éƒ¨é€»è¾‘ä¸»è¦æ˜¯åˆ¤æ–­ state çš„å€¼ï¼Œè¿›è¡Œè¿”å›ã€‚</p><p>åœ¨å†…éƒ¨å®ç°ä¸­è¿”å›çš„å€¼åªæœ‰ 1 å’Œ -1 ï¼Œè¯´æ˜åœ¨ state == 0 æ—¶ï¼Œè¿”å› 1 ï¼Œå³å”¤é†’åç»­èŠ‚ç‚¹ã€‚ä¸ç­‰äº 0 æ—¶ï¼Œä¼šé˜»å¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (getState() == <span class="number">0</span>) ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><strong>Q: CountDownLatch å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</strong></p><p><strong>A:</strong> CountDownLatch æ˜¯åŸºäº AQS çš„å…±äº«æ¨¡å¼å®ç°çš„ã€‚</p><p><strong>Q: CountDownLatch çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p><strong>A:</strong> å¯ä»¥å‚è€ƒä¸Šé¢çš„æºç è§£æï¼Œè¿›è¡Œæ€»ç»“ä»‹ç»ã€‚ CountDownLatch æ˜¯åŸºäº AQS å…±äº«æ¨¡å¼å®ç°çš„ï¼Œåœ¨åˆå§‹åŒ–æ—¶å¿…é¡»ä¼ å…¥è®¡æ•°ï¼Œè¯¥è®¡æ•°å®é™…ä¸Šæ˜¯ AQS çš„ state å€¼ã€‚åœ¨ countDown æ—¶å¯¹ state è¿›è¡Œé€’å‡ï¼Œåœ¨ å½“ state ä¸º 0 æ—¶ ä¼šå”¤é†’ AQS é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ç­‰å¾…çš„èŠ‚ç‚¹ ï¼ˆå› ä¸ºæ˜¯å…±äº«æ¨¡å¼ï¼‰ã€‚è€Œ await æ–¹æ³•æ˜¯åˆ¤æ–­ state çš„å€¼ï¼Œå¦‚æœä¸æ˜¯ 0 ï¼Œåˆ™æ‰€æœ‰çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­é˜»å¡ï¼Œç­‰å¾…å”¤é†’ã€‚</p><p><strong>Q: state åœ¨ä»£è¡¨çš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ</strong><br><strong>A:</strong> </p><ol><li>åœ¨ ReentrantLock ä¸­ state ä»£è¡¨åŠ é”çŠ¶æ€ï¼Œ0 æ²¡æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äºç­‰äº 1 å·²ç»æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äº 1 è¯´æ˜è¯¥è·å¾—é”çš„çº¿ç¨‹å¤šæ¬¡é‡å…¥ã€‚</li><li>åœ¨ ReentrantReadWriteLock ä¸­ state ä»£è¡¨é”çš„çŠ¶æ€ã€‚state ä¸º 0 ï¼Œæ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œstate çš„é«˜ 16 ä¸ºä»£è¡¨è¯»é”çŠ¶æ€ï¼Œä½ 16 ä¸ºä»£è¡¨å†™é”çŠ¶æ€ã€‚é€šè¿‡ä½è¿ç®—å¯ä»¥è·å–è¯»å†™é”çš„å®é™…å€¼ã€‚</li><li>è€Œåœ¨è¿™é‡Œ ï¼ˆCountDownLatchï¼‰åˆ™ä»£è¡¨é—¨é—©æˆ–è€…è¯´è®¡æ•°çš„å€¼ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Elasticsearch æŠ€æœ¯åˆ†äº«ã€‘â€”â€” åå¼ å›¾å¸¦å¤§å®¶çœ‹æ‡‚ ES åŸç† ï¼æ˜ç™½ä¸ºä»€ä¹ˆè¯´ï¼šES æ˜¯å‡†å®æ—¶çš„ï¼</title>
      <link href="2020/08/29/technology-sharing-es-5.html"/>
      <url>2020/08/29/technology-sharing-es-5.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>è¯´åˆ° Elasticsearch ï¼Œå…¶ä¸­æœ€æ˜æ˜¾çš„ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯ <em>near real-time</em> å‡†å®æ—¶ â€”â€” å½“æ–‡æ¡£å­˜å‚¨åœ¨Elasticsearchä¸­æ—¶ï¼Œå°†åœ¨1ç§’å†…ä»¥å‡ ä¹å®æ—¶çš„æ–¹å¼å¯¹å…¶è¿›è¡Œç´¢å¼•å’Œå®Œå…¨æœç´¢ã€‚é‚£ä¸ºä»€ä¹ˆè¯´ ES æ˜¯å‡†å®æ—¶çš„å‘¢ï¼Ÿ</p></blockquote><h3 id="Lucene-å’Œ-ES"><a href="#Lucene-å’Œ-ES" class="headerlink" title="Lucene å’Œ ES"></a>Lucene å’Œ ES</h3><h4 id="Lucene"><a href="#Lucene" class="headerlink" title="Lucene"></a>Lucene</h4><p>Lucene æ˜¯ Elasticsearchæ‰€åŸºäºçš„ Java åº“ï¼Œå®ƒå¼•å…¥äº†æŒ‰æ®µæœç´¢çš„æ¦‚å¿µã€‚</p><p>Segmentï¼š ä¹Ÿå«æ®µï¼Œç±»ä¼¼äºå€’æ’ç´¢å¼•ï¼Œç›¸å½“äºä¸€ä¸ªæ•°æ®é›†ã€‚</p><p>Commit pointï¼šæäº¤ç‚¹ï¼Œè®°å½•ç€æ‰€æœ‰å·²çŸ¥çš„æ®µã€‚</p><p>Lucene indexï¼š â€œa collection of segments plus a commit pointâ€ã€‚ç”±ä¸€å † Segment çš„é›†åˆåŠ ä¸Šä¸€ä¸ªæäº¤ç‚¹ç»„æˆã€‚</p><p>å¯¹äºä¸€ä¸ª Lucene index çš„ç»„æˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/lucene-woYwZZ.png" alt="lucene-woYwZZ"></p><h4 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h4><p>ä¸€ä¸ª Elasticsearch Index ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ª shard ï¼ˆåˆ†ç‰‡ï¼‰ ç»„æˆã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/es-shard-TjHfGE.png" alt="es-shard-TjHfGE"></p><p>è€Œ Lucene ä¸­çš„ Lucene index ç›¸å½“äº ES çš„ä¸€ä¸ª shardã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/es-shard-lucene-5CpsYR.png" alt="es-shard-lucene-5CpsYR"></p><h3 id="å†™å…¥è¿‡ç¨‹"><a href="#å†™å…¥è¿‡ç¨‹" class="headerlink" title="å†™å…¥è¿‡ç¨‹"></a>å†™å…¥è¿‡ç¨‹</h3><h4 id="å†™å…¥è¿‡ç¨‹-1-0-ï¼ˆä¸å®Œå–„ï¼‰"><a href="#å†™å…¥è¿‡ç¨‹-1-0-ï¼ˆä¸å®Œå–„ï¼‰" class="headerlink" title="å†™å…¥è¿‡ç¨‹ 1.0 ï¼ˆä¸å®Œå–„ï¼‰"></a>å†™å…¥è¿‡ç¨‹ 1.0 ï¼ˆä¸å®Œå–„ï¼‰</h4><ol><li>ä¸æ–­å°† Document å†™å…¥åˆ° In-memory buffer ï¼ˆå†…å­˜ç¼“å†²åŒºï¼‰ã€‚</li><li>å½“æ»¡è¶³ä¸€å®šæ¡ä»¶åå†…å­˜ç¼“å†²åŒºä¸­çš„ Documents åˆ·æ–°åˆ°ç£ç›˜ã€‚</li><li>ç”Ÿæˆæ–°çš„ segment ä»¥åŠä¸€ä¸ª Commit point æäº¤ç‚¹ã€‚</li><li>è¿™ä¸ª segment å°±å¯ä»¥åƒå…¶ä»– segment ä¸€æ ·è¢«è¯»å–äº†ã€‚</li></ol><p>ç”»å›¾å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/es-write-1-L60ip2.png" alt="es-write-1-L60ip2"></p><p>å°†æ–‡ä»¶åˆ·æ–°åˆ°ç£ç›˜æ˜¯éå¸¸è€—è´¹èµ„æºçš„ï¼Œè€Œä¸”åœ¨å†…å­˜ç¼“å†²åŒºå’Œç£ç›˜ä¸­é—´å­˜åœ¨ä¸€ä¸ªé«˜é€Ÿç¼“å­˜ï¼ˆcacheï¼‰ï¼Œä¸€æ—¦æ–‡ä»¶è¿›å…¥åˆ° cache å°±å¯ä»¥åƒç£ç›˜ä¸Šçš„ segment ä¸€æ ·è¢«è¯»å–äº†ã€‚</p><h4 id="å†™å…¥è¿‡ç¨‹-2-0"><a href="#å†™å…¥è¿‡ç¨‹-2-0" class="headerlink" title="å†™å…¥è¿‡ç¨‹ 2.0"></a>å†™å…¥è¿‡ç¨‹ 2.0</h4><ol><li>ä¸æ–­å°† Document å†™å…¥åˆ° In-memory buffer ï¼ˆå†…å­˜ç¼“å†²åŒºï¼‰ã€‚</li><li>å½“æ»¡è¶³ä¸€å®šæ¡ä»¶åå†…å­˜ç¼“å†²åŒºä¸­çš„ Documents åˆ·æ–°åˆ° é«˜é€Ÿç¼“å­˜ï¼ˆ<strong>cache</strong>ï¼‰ã€‚</li><li>ç”Ÿæˆæ–°çš„ segment ï¼Œè¿™ä¸ª segment è¿˜åœ¨ cache ä¸­ã€‚</li><li>è¿™æ—¶å€™è¿˜æ²¡æœ‰ commit ï¼Œä½†æ˜¯å·²ç»å¯ä»¥è¢«è¯»å–äº†ã€‚</li></ol><p>ç”»å›¾å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/es-write-2-CW97xV.png" alt="es-write-2-CW97xV"></p><p>æ•°æ®ä» buffer åˆ° cache çš„è¿‡ç¨‹æ˜¯å®šæœŸæ¯ç§’åˆ·æ–°ä¸€æ¬¡ã€‚æ‰€ä»¥æ–°å†™å…¥çš„ Document æœ€æ…¢ 1 ç§’å°±å¯ä»¥åœ¨ cache ä¸­è¢«æœç´¢åˆ°ã€‚</p><p>è€Œ Document ä» buffer åˆ° cache çš„è¿‡ç¨‹å«åš <strong>?refresh</strong> ã€‚ä¸€èˆ¬æ˜¯ 1 ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œä¸éœ€è¦è¿›è¡Œé¢å¤–ä¿®æ”¹ã€‚å½“ç„¶ï¼Œå¦‚æœæœ‰ä¿®æ”¹çš„éœ€è¦ï¼Œå¯ä»¥å‚è€ƒæ–‡æœ«çš„ç›¸å…³èµ„æ–™ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¯´ Elasticsearch æ˜¯<strong>å‡†å®æ—¶</strong>çš„ã€‚</p><p>ä½¿æ–‡æ¡£ç«‹å³å¯è§ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /test/_doc/1?refresh</span><br><span class="line">&#123;<span class="attr">&quot;test&quot;</span>: <span class="string">&quot;test&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ–è€…</span></span><br><span class="line">PUT /test/_doc/2?refresh=true</span><br><span class="line">&#123;<span class="attr">&quot;test&quot;</span>: <span class="string">&quot;test&quot;</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="Translog-äº‹åŠ¡æ—¥å¿—"><a href="#Translog-äº‹åŠ¡æ—¥å¿—" class="headerlink" title="Translog äº‹åŠ¡æ—¥å¿—"></a>Translog äº‹åŠ¡æ—¥å¿—</h4><p>æ­¤å¤„å¯ä»¥è”æƒ³ Mysql çš„ binlogï¼Œ ES ä¸­ä¹Ÿå­˜åœ¨ä¸€ä¸ª translog ç”¨æ¥å¤±è´¥æ¢å¤ã€‚</p><ol><li>Document ä¸æ–­å†™å…¥åˆ° In-memory bufferï¼Œæ­¤æ—¶ä¹Ÿä¼šè¿½åŠ  translogã€‚</li><li>å½“ buffer ä¸­çš„æ•°æ®æ¯ç§’ refresh åˆ° cache ä¸­æ—¶ï¼Œtranslog å¹¶æ²¡æœ‰è¿›å…¥åˆ°åˆ·æ–°åˆ°ç£ç›˜ï¼Œæ˜¯æŒç»­è¿½åŠ çš„ã€‚</li><li>translog æ¯éš” 5s ä¼š fsync åˆ°ç£ç›˜ã€‚</li><li>translog ä¼šç»§ç»­ç´¯åŠ å˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œå½“ translog å¤§åˆ°ä¸€å®šç¨‹åº¦æˆ–è€…æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œä¼šæ‰§è¡Œ flushã€‚</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/es-write-translog-1-L8RWwm.png" alt="es-write-translog-1-L8RWwm"></p><p>flush æ“ä½œä¼šåˆ†ä¸ºä»¥ä¸‹å‡ æ­¥æ‰§è¡Œï¼š</p><ol><li>buffer è¢«æ¸…ç©ºã€‚</li><li>è®°å½• commit pointã€‚</li><li>cache å†…çš„ segment è¢« fsync åˆ·æ–°åˆ°ç£ç›˜ã€‚</li><li>translog è¢«åˆ é™¤ã€‚</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/es-write-translog-2-BWnz3P.png" alt="es-write-translog-2-BWnz3P"></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š</p><ol><li>translog æ¯ 5s åˆ·æ–°ä¸€æ¬¡ç£ç›˜ï¼Œæ‰€ä»¥æ•…éšœé‡å¯ï¼Œå¯èƒ½ä¼šä¸¢å¤± 5s çš„æ•°æ®ã€‚</li><li>translog æ‰§è¡Œ flush æ“ä½œï¼Œé»˜è®¤ 30 åˆ†é’Ÿä¸€æ¬¡ï¼Œæˆ–è€… translog å¤ªå¤§ ä¹Ÿä¼šæ‰§è¡Œã€‚</li></ol><p>æ‰‹åŠ¨æ‰§è¡Œflushï¼š</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">POST /my-index-000001/_flush</span><br></pre></td></tr></table></figure><h3 id="åˆ é™¤å’Œæ›´æ–°"><a href="#åˆ é™¤å’Œæ›´æ–°" class="headerlink" title="åˆ é™¤å’Œæ›´æ–°"></a>åˆ é™¤å’Œæ›´æ–°</h3><p>segment ä¸å¯æ”¹å˜ï¼Œæ‰€ä»¥ docment å¹¶ä¸èƒ½ä»ä¹‹å‰çš„ segment ä¸­ç§»é™¤æˆ–æ›´æ–°ã€‚</p><p>æ‰€ä»¥æ¯æ¬¡ commitï¼Œ ç”Ÿæˆ commit point æ—¶ï¼Œä¼šæœ‰ä¸€ä¸ª .del æ–‡ä»¶ï¼Œé‡Œé¢ä¼šåˆ—å‡ºè¢«åˆ é™¤çš„ documentï¼ˆé€»è¾‘åˆ é™¤ï¼‰ã€‚<br>è€ŒæŸ¥è¯¢æ—¶ï¼Œè·å–åˆ°çš„ç»“æœåœ¨è¿”å›å‰ä¼šç»è¿‡ .del è¿‡æ»¤ã€‚</p><p>æ›´æ–°æ—¶ï¼Œä¹Ÿä¼šæ ‡è®°æ—§çš„ docment è¢«åˆ é™¤ï¼Œå†™å…¥åˆ° .del æ–‡ä»¶ï¼ŒåŒæ—¶ä¼šå†™å…¥ä¸€ä¸ªæ–°çš„æ–‡ä»¶ã€‚æ­¤æ—¶æŸ¥è¯¢ä¼šæŸ¥è¯¢åˆ°ä¸¤ä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œä½†åœ¨è¿”å›å‰ä¼šè¢«ç§»é™¤æ‰ä¸€ä¸ªã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/es-del-1-nc0mKK.png" alt="es-del-1-nc0mKK"></p><h3 id="segment-åˆå¹¶"><a href="#segment-åˆå¹¶" class="headerlink" title="segment åˆå¹¶"></a>segment åˆå¹¶</h3><p>æ¯ 1s æ‰§è¡Œä¸€æ¬¡ refresh éƒ½ä¼šå°†å†…å­˜ä¸­çš„æ•°æ®åˆ›å»ºä¸€ä¸ª segmentã€‚</p><p>segment æ•°ç›®å¤ªå¤šä¼šå¸¦æ¥è¾ƒå¤§çš„éº»çƒ¦ã€‚ æ¯ä¸€ä¸ª segment éƒ½ä¼šæ¶ˆè€—æ–‡ä»¶å¥æŸ„ã€å†…å­˜å’Œcpuè¿è¡Œå‘¨æœŸã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæ¯ä¸ªæœç´¢è¯·æ±‚éƒ½å¿…é¡»è½®æµæ£€æŸ¥æ¯ä¸ª segment ï¼›æ‰€ä»¥ segment è¶Šå¤šï¼Œæœç´¢ä¹Ÿå°±è¶Šæ…¢ã€‚</p><p>åœ¨ ES åå°ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œ segment åˆå¹¶ã€‚</p><ol><li>refreshæ“ä½œä¼šåˆ›å»ºæ–°çš„ segment å¹¶æ‰“å¼€ä»¥ä¾›æœç´¢ä½¿ç”¨ã€‚</li><li>åˆå¹¶è¿›ç¨‹é€‰æ‹©ä¸€å°éƒ¨åˆ†å¤§å°ç›¸ä¼¼çš„ segmentï¼Œå¹¶ä¸”åœ¨åå°å°†å®ƒä»¬åˆå¹¶åˆ°æ›´å¤§çš„ segment ä¸­ã€‚è¿™å¹¶ä¸ä¼šä¸­æ–­ç´¢å¼•å’Œæœç´¢ã€‚</li><li>å½“åˆå¹¶ç»“æŸï¼Œè€çš„ segment è¢«åˆ é™¤ è¯´æ˜åˆå¹¶å®Œæˆæ—¶çš„æ´»åŠ¨ï¼š<ol><li>æ–°çš„ segment è¢«åˆ·æ–°ï¼ˆflushï¼‰åˆ°äº†ç£ç›˜ã€‚  å†™å…¥ä¸€ä¸ªåŒ…å«æ–° segment ä¸”æ’é™¤æ—§çš„å’Œè¾ƒå°çš„ segmentçš„æ–° commit pointã€‚</li><li>æ–°çš„ segment è¢«æ‰“å¼€ç”¨æ¥æœç´¢ã€‚</li><li>è€çš„ segment è¢«åˆ é™¤ã€‚</li></ol></li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/segment-merge-55A1b6.png" alt="segment-merge-55A1b6"></p><p>ç‰©ç†åˆ é™¤ï¼š</p><p>åœ¨ segment merge è¿™å—ï¼Œé‚£äº›è¢«é€»è¾‘åˆ é™¤çš„ document æ‰ä¼šè¢«çœŸæ­£çš„ç‰©ç†åˆ é™¤ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ä¸»è¦ä»‹ç»äº†å†…éƒ¨å†™å…¥å’Œåˆ é™¤çš„è¿‡ç¨‹ï¼Œéœ€è¦äº†è§£ refreshã€fsyncã€flushã€.delã€segment merge ç­‰åè¯çš„å…·ä½“å«ä¹‰ã€‚</p><p>å®Œæ•´ç”»å›¾å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/all-FMAPTS.png" alt="all-FMAPTS"></p><p>ä»¥ä¸Šå°±æ˜¯ä¸ªäººåˆ†äº«çš„ ES ç›¸å…³çš„å†…å®¹ï¼Œä¸»è¦ç›®çš„æ˜¯ç»„å†…æŠ€æœ¯åˆ†äº«ï¼Œè¿›è¡Œæ‰«ç›²ã€‚ä¸å¯¹ä¹‹å¤„ï¼Œå¸Œæœ›å¤§å®¶ç•™è¨€æŒ‡æ­£ã€‚</p><h4 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h4><ol><li>å‡†å®æ—¶æœç´¢ï¼š <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/near-real-time.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.9/near-real-time.html</a></li><li>Refresh APIï¼š<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/indices-refresh.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.9/indices-refresh.html</a></li><li>Flush APIï¼š<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/indices-flush.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.9/indices-flush.html</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> å·¥ä½œç¬”è®° </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥ä½œç¬”è®° </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Elasticsearch æŠ€æœ¯åˆ†äº«ã€‘â€”â€” ES æŸ¥è¯¢æ£€ç´¢æ•°æ®çš„è¿‡ç¨‹ï¼Œæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ</title>
      <link href="2020/08/26/technology-sharing-es-4.html"/>
      <url>2020/08/26/technology-sharing-es-4.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>ES ä½¿ç”¨è¿‡ç¨‹ä¸­å¸¸ç”¨çš„å°±æ˜¯æŸ¥è¯¢ä»¥åŠæ£€ç´¢ï¼Œé‚£æŸ¥è¯¢å’Œæ£€ç´¢çš„è¿‡ç¨‹ï¼Œä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p></blockquote><h3 id="æŸ¥è¯¢æµç¨‹"><a href="#æŸ¥è¯¢æµç¨‹" class="headerlink" title="æŸ¥è¯¢æµç¨‹"></a>æŸ¥è¯¢æµç¨‹</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET my-index/_doc/0</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/fJmmvi-T7hz9J.png" alt="fJmmvi-T7hz9J"></p><ol><li>Client å°†è¯·æ±‚å‘é€åˆ°ä»»æ„èŠ‚ç‚¹ nodeï¼Œæ­¤æ—¶ node èŠ‚ç‚¹å°±æ˜¯<strong>åè°ƒèŠ‚ç‚¹</strong>ï¼ˆcoordinating nodeï¼‰ã€‚</li><li>åè°ƒèŠ‚ç‚¹å¯¹ id è¿›è¡Œè·¯ç”±ï¼Œä»è€Œåˆ¤æ–­è¯¥æ•°æ®åœ¨å“ªä¸ªshardã€‚</li><li>åœ¨ primary shard å’Œ replica shard ä¹‹é—´ éšæœºé€‰æ‹©ä¸€ä¸ªï¼Œè¯·æ±‚è·å– docã€‚</li><li>æ¥æ”¶è¯·æ±‚çš„èŠ‚ç‚¹ä¼šå°†æ•°æ®è¿”å›ç»™<strong>åè°ƒèŠ‚ç‚¹</strong>ï¼Œåè°ƒèŠ‚ç‚¹ä¼šå°†æ•°æ®è¿”å›ç»™Clientã€‚</li></ol><p>å¯ä»¥é€šè¿‡ preference å‚æ•°æŒ‡å®šæ‰§è¡Œæ“ä½œçš„èŠ‚ç‚¹æˆ–åˆ†ç‰‡ã€‚é»˜è®¤ä¸ºéšæœºã€‚</p><h3 id="æ£€ç´¢æµç¨‹"><a href="#æ£€ç´¢æµç¨‹" class="headerlink" title="æ£€ç´¢æµç¨‹"></a>æ£€ç´¢æµç¨‹</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET /my-index/_search </span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/w1lGEZ-TgHyvN.png" alt="w1lGEZ-TgHyvN"></p><ol><li>Client å°†è¯·æ±‚å‘é€åˆ°ä»»æ„èŠ‚ç‚¹ nodeï¼Œæ­¤æ—¶ node èŠ‚ç‚¹å°±æ˜¯<strong>åè°ƒèŠ‚ç‚¹</strong>ï¼ˆcoordinating nodeï¼‰</li><li>åè°ƒèŠ‚ç‚¹è¿›è¡Œåˆ†è¯ç­‰æ“ä½œåï¼Œå»æŸ¥è¯¢æ‰€æœ‰çš„ shard ï¼ˆprimary shard å’Œ replica shard é€‰æ‹©ä¸€ä¸ªï¼‰</li><li>æ‰€æœ‰ shard å°†æ»¡è¶³æ¡ä»¶çš„æ•°æ® id æ’åºå­—æ®µ ç­‰ä¿¡æ¯è¿”å›ç»™è·¯ç”±èŠ‚ç‚¹</li><li>è·¯ç”±èŠ‚ç‚¹é‡æ–°è¿›è¡Œæ’åºï¼Œæˆªå–æ•°æ®åï¼Œè·å–åˆ°çœŸæ­£éœ€è¦è¿”å›çš„æ•°æ®çš„ id</li><li>è·¯ç”±èŠ‚ç‚¹å†æ¬¡è¯·æ±‚å¯¹åº”çš„ shard ï¼ˆæ­¤æ—¶æœ‰ id äº†ï¼Œå¯ä»¥ç›´æ¥å®šä½åˆ°å¯¹åº”shardï¼‰</li><li>è·å–åˆ°å…¨é‡æ•°æ®ï¼Œè¿”å›ç»™ Client</li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ä¸»è¦ä»‹ç»äº† ES æŸ¥è¯¢ä»¥åŠæ£€ç´¢çš„æµç¨‹ï¼Œä¸è¶³åŠé”™è¯¯ä¹‹å¤„æ¬¢è¿æŒ‡æ­£ã€‚</p><h4 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h4><ol><li>åè°ƒèŠ‚ç‚¹ï¼š<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-node.html#coordinating-node">https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-node.html#coordinating-node</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> å·¥ä½œç¬”è®° </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥ä½œç¬”è®° </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Elasticsearch æŠ€æœ¯åˆ†äº«ã€‘â€”â€” Elasticsearch å­˜å‚¨ä¸€æ¡æ•°æ®ï¼Œ put è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ</title>
      <link href="2020/08/26/technology-sharing-es-3.html"/>
      <url>2020/08/26/technology-sharing-es-3.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>åœ¨å‰é¢å·²ç»ä»‹ç»äº† ES ä¸­å¸¸ç”¨çš„ä¸€äº›åè¯ï¼ŒçŸ¥é“äº†æ•°æ®æ˜¯å­˜å‚¨åœ¨ shard ä¸­çš„ï¼Œè€Œ index ä¼šæ˜ å°„ä¸€ä¸ªæˆ–è€…å¤šä¸ª shard ã€‚é‚£è¿™æ—¶å€™æˆ‘è¦å­˜å‚¨ä¸€æ¡æ•°æ®åˆ°æŸä¸ªç´¢å¼•ä¸‹ï¼Œè¿™æ¡æ•°æ®æ˜¯åœ¨å“ªä¸ª index ä¸‹çš„å‘¢ï¼Ÿ</p></blockquote><h3 id="ES-æ¼”ç¤º"><a href="#ES-æ¼”ç¤º" class="headerlink" title="ES æ¼”ç¤º"></a>ES æ¼”ç¤º</h3><p>ä¸€åˆ‡æŒ‰ç…§å®˜æ–¹æ•™ç¨‹ä½¿ç”¨ ä¸‰æ¡å‘½ä»¤ï¼Œåœ¨æœ¬æœºå¯åŠ¨ä¸‰ä¸ªèŠ‚ç‚¹ç»„è£…æˆä¼ªé›†ç¾¤ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~  % &gt; ./elasticsearch</span><br><span class="line"></span><br><span class="line">~  % &gt; ./elasticsearch -Epath.data=data2 -Epath.logs=log2</span><br><span class="line"></span><br><span class="line">~  % &gt; ./elasticsearch -Epath.data=data3 -Epath.logs=log3</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºç´¢å¼•"><a href="#åˆ›å»ºç´¢å¼•" class="headerlink" title="åˆ›å»ºç´¢å¼•"></a>åˆ›å»ºç´¢å¼•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X PUT <span class="string">&quot;localhost:9200/my-index-000001?pretty&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;settings&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;index&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;number_of_shards&quot;: 3,  </span></span><br><span class="line"><span class="string">      &quot;number_of_replicas&quot;: 2 </span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p>å½“å‰ç‰ˆæœ¬ 7.9</p><p>æ–‡æ¡£åœ°å€ï¼š<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html</a></p><p>ES é»˜è®¤ number_of_shards ä¸º 1<br>é»˜è®¤ number_of_replicas ä¸º 1ï¼Œå³ä¸€ä¸ªåˆ†ç‰‡åªæœ‰ä¸€ä¸ªå‰¯æœ¬</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/put-index-0-dyP7ph.png" alt="put-index-0-dyP7ph"></p><p>ä¸‹é¢å‘½ä»¤å¯ä»¥æŸ¥çœ‹ç´¢å¼•ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_cat/indices/my-index-000001?v&amp;s=index&amp;pretty&quot;</span></span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/put-index-1-VKKT73.png" alt="put-index-1-VKKT73"></p><h4 id="å­˜æ”¾æ•°æ®"><a href="#å­˜æ”¾æ•°æ®" class="headerlink" title="å­˜æ”¾æ•°æ®"></a>å­˜æ”¾æ•°æ®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X PUT <span class="string">&quot;localhost:9200/my-index-000001/_doc/0825?pretty&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;name&quot;: &quot;liuzhihang&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/put-1-vJVlLn.png" alt="put-1-vJVlLn"></p><h4 id="æŸ¥è¯¢æ•°æ®"><a href="#æŸ¥è¯¢æ•°æ®" class="headerlink" title="æŸ¥è¯¢æ•°æ®"></a>æŸ¥è¯¢æ•°æ®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/my-index-000001/_doc/0825?pretty&quot;</span></span><br></pre></td></tr></table></figure><p>æ–‡æ¡£åœ°å€ï¼š<br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-get.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-get.html</a></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/put-2-JwDffk.png" alt="put-2-JwDffk"></p><h3 id="ä¸€æ¡æ•°æ®è¯¥å­˜æ”¾åœ¨å“ªä¸ª-shard"><a href="#ä¸€æ¡æ•°æ®è¯¥å­˜æ”¾åœ¨å“ªä¸ª-shard" class="headerlink" title="ä¸€æ¡æ•°æ®è¯¥å­˜æ”¾åœ¨å“ªä¸ª shard"></a>ä¸€æ¡æ•°æ®è¯¥å­˜æ”¾åœ¨å“ªä¸ª shard</h3><p>é€šè¿‡å‘½ä»¤å¯ä»¥çœ‹å‡ºï¼šåœ¨å­˜æ”¾æ•°æ®æ—¶å¹¶æ²¡æœ‰æŒ‡å®šåˆ°å“ªä¸ª shardï¼Œé‚£æ•°æ®æ˜¯å­˜åœ¨å“ªé‡Œçš„å‘¢ï¼Ÿ</p><p>å½“ä¸€æ¡æ•°æ®è¿›æ¥ï¼Œä¼šé»˜è®¤ä¼šæ ¹æ® id åšè·¯ç”±</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shard &#x3D; hash(routing) % number_of_primary_shards</span><br></pre></td></tr></table></figure><p>ä»è€Œç¡®å®šå­˜æ”¾åœ¨å“ªä¸ª shardã€‚ routing é»˜è®¤æ˜¯ _idï¼Œ ä¹Ÿå¯ä»¥è®¾ç½®å…¶ä»–ã€‚</p><p>è¿™ä¸ª id å¯ä»¥è‡ªå·±æŒ‡å®šä¹Ÿå¯ä»¥ç³»ç»Ÿç»™ç”Ÿæˆ, å¦‚æœä¸æŒ‡å®šåˆ™ä¼šç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆã€‚</p><h3 id="put-ä¸€æ¡æ•°æ®çš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"><a href="#put-ä¸€æ¡æ•°æ®çš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ" class="headerlink" title="put ä¸€æ¡æ•°æ®çš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"></a>put ä¸€æ¡æ•°æ®çš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/OxOQ9V-S0Wt6P.png" alt="OxOQ9V-S0Wt6P"></p><p>å†™å…¥è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ</p><ol><li>åè°ƒé˜¶æ®µï¼šClient å®¢æˆ·ç«¯é€‰æ‹©ä¸€ä¸ª node å‘é€ put è¯·æ±‚ï¼Œæ­¤æ—¶å½“å‰èŠ‚ç‚¹å°±æ˜¯<strong>åè°ƒèŠ‚ç‚¹</strong>ï¼ˆcoordinating nodeï¼‰ã€‚åè°ƒèŠ‚ç‚¹æ ¹æ® document çš„ id è¿›è¡Œè·¯ç”±ï¼Œå°†è¯·æ±‚è½¬å‘ç»™å¯¹åº”çš„ nodeã€‚è¿™ä¸ª node ä¸Šçš„æ˜¯ primary shard ã€‚</li><li>ä¸»è¦é˜¶æ®µï¼šå¯¹åº”çš„ primary shard å¤„ç†è¯·æ±‚ï¼Œå†™å…¥æ•°æ® ï¼Œç„¶åå°†æ•°æ®åŒæ­¥åˆ° replica shardã€‚<ol><li>primary shard ä¼šéªŒè¯ä¼ å…¥çš„æ•°æ®ç»“æ„</li><li>æœ¬åœ°æ‰§è¡Œç›¸å…³æ“ä½œ</li><li>å°†æ“ä½œè½¬å‘ç»™ replica shard</li><li>å½“æ•°æ®å†™å…¥ primary shard å’Œ replica shard æˆåŠŸåï¼Œè·¯ç”±èŠ‚ç‚¹è¿”å›å“åº”ç»™ Clientã€‚</li></ol></li><li>å‰¯æœ¬é˜¶æ®µï¼šæ¯ä¸ª replica shard åœ¨è½¬å‘åï¼Œä¼šè¿›è¡Œæœ¬åœ°æ“ä½œã€‚</li></ol><p>åœ¨å†™æ“ä½œæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œåªéœ€è¦ primary shard å¤„äºæ´»è·ƒçŠ¶æ€å³å¯è¿›è¡Œæ“ä½œã€‚</p><p>åœ¨ç´¢å¼•è®¾ç½®æ—¶å¯ä»¥è®¾ç½®è¿™ä¸ªå±æ€§</p><p>index.write.wait_for_active_shards</p><p>é»˜è®¤æ˜¯ 1ï¼Œå³ primary shard å†™å…¥æˆåŠŸå³å¯è¿”å›ã€‚ </p><p>å¦‚æœè®¾ç½®ä¸º all åˆ™ç›¸å½“äº number_of_replicas+1  å°±æ˜¯ primary shard æ•°é‡ + replica shard æ•°é‡ã€‚ å°±æ˜¯éœ€è¦ç­‰å¾… primary shard å’Œ replica shard éƒ½å†™å…¥æˆåŠŸæ‰ç®—æˆåŠŸã€‚</p><p>å¯ä»¥é€šè¿‡ç´¢å¼•è®¾ç½®åŠ¨æ€è¦†ç›–æ­¤é»˜è®¤è®¾ç½®ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="å¦‚ä½•æŸ¥çœ‹æ•°æ®åœ¨å“ªä¸ª-shard-ä¸Šå‘¢ï¼Ÿ"><a href="#å¦‚ä½•æŸ¥çœ‹æ•°æ®åœ¨å“ªä¸ª-shard-ä¸Šå‘¢ï¼Ÿ" class="headerlink" title="å¦‚ä½•æŸ¥çœ‹æ•°æ®åœ¨å“ªä¸ª shard ä¸Šå‘¢ï¼Ÿ"></a>å¦‚ä½•æŸ¥çœ‹æ•°æ®åœ¨å“ªä¸ª shard ä¸Šå‘¢ï¼Ÿ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/my-index-000001/_search_shards?routing=0825&amp;pretty&quot;</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢å‘½ä»¤å¯ä»¥æŸ¥åˆ°æ•°æ® 0825 çš„æ‰€åœ¨ shardã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/put-index-3-JIP0zD.png" alt="put-index-3-JIP0zD"></p><h4 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h4><ol><li>ES åˆ›å»ºç´¢å¼•ï¼š<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html</a></li><li>ES æŸ¥è¯¢æ•°æ®ï¼š<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-get.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-get.html</a></li><li>ES æ£€ç´¢ shardï¼š<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-shards.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-shards.html</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> å·¥ä½œç¬”è®° </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥ä½œç¬”è®° </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Elasticsearch æŠ€æœ¯åˆ†äº«ã€‘â€”â€” ES å¸¸ç”¨åè¯åŠç»“æ„</title>
      <link href="2020/08/23/technology-sharing-es-2.html"/>
      <url>2020/08/23/technology-sharing-es-2.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>çœ‹å®Œä»€ä¹ˆæ˜¯ Elasticsearch ä»¥åŠäº†è§£åˆ°äº†å€’æ’ç´¢å¼•çš„æ¦‚å¿µï¼Œä¸‹é¢å°±ç†Ÿæ‚‰ä¸‹ ES ä¸­å¸¸ç”¨çš„ä¸€äº›åè¯ã€‚</p></blockquote><h3 id="å¸¸ç”¨æœ¯è¯­"><a href="#å¸¸ç”¨æœ¯è¯­" class="headerlink" title="å¸¸ç”¨æœ¯è¯­"></a>å¸¸ç”¨æœ¯è¯­</h3><table><thead><tr><th><strong>åè¯</strong></th><th><strong>è§£é‡Š</strong></th></tr></thead><tbody><tr><td><strong>cluster</strong></td><td>ä¸€ä¸ªæˆ–è€…å¤šä¸ª node æŒ‡å®šç›¸åŒçš„ cluster nameï¼Œåˆ™å®ƒä»¬ä¼šç»„æˆé›†ç¾¤ï¼Œå¹¶ä¸”è‡ªåŠ¨é€‰ä¸¾ masterï¼Œä»¥åŠåœ¨æ•…éšœæ—¶è‡ªåŠ¨é€‰ä¸¾ã€‚</td></tr><tr><td><strong>node</strong></td><td>èŠ‚ç‚¹æ˜¯å±äºé›†ç¾¤çš„Elasticsearchçš„è¿è¡Œå®ä¾‹ ã€‚åœ¨å¯åŠ¨æ—¶ï¼ŒèŠ‚ç‚¹å°†ä½¿ç”¨å•æ’­æ¥å‘ç°å…·æœ‰ç›¸åŒé›†ç¾¤åç§°çš„ç°æœ‰é›†ç¾¤ï¼Œå¹¶å°†å°è¯•åŠ å…¥è¯¥é›†ç¾¤ã€‚</td></tr><tr><td><strong>index</strong></td><td>ç±»ä¼¼å…³ç³»æ•°æ®åº“çš„è¡¨ï¼Œæ˜ å°„ä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸»åˆ†ç‰‡ï¼ŒåŒæ—¶æ‹¥æœ‰é›¶ä¸ªæˆ–å¤šä¸ªå‰¯æœ¬åˆ†ç‰‡ã€‚</td></tr><tr><td><strong>index alias</strong></td><td>ç´¢å¼•åˆ«åæ˜¯ç”¨äºå¼•ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªç°æœ‰ç´¢å¼•çš„è¾…åŠ©åç§°ã€‚å¤§å¤šæ•°Elasticsearch APIæ¥å—ç´¢å¼•åˆ«åä»£æ›¿ç´¢å¼•åç§°ã€‚</td></tr><tr><td><strong>mapping</strong></td><td>æ¯ä¸ª index éƒ½æœ‰ä¸€ä¸ª mapping ï¼Œå®šä¹‰ä¸€ä¸ª type ä»¥åŠè®¸å¤šç´¢å¼•èŒƒå›´çš„è®¾ç½®ã€‚mapping å¯ä»¥æ˜ç¡®å®šä¹‰ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸ºæ–‡æ¡£å»ºç«‹ç´¢å¼•åè‡ªåŠ¨ç”Ÿæˆã€‚</td></tr><tr><td><strong>shard</strong></td><td>åˆ†ç‰‡æ˜¯å•ä¸ªLuceneå®ä¾‹ã€‚æœ€å°çš„å·¥ä½œå•ä½ï¼Œç”±Elasticsearchè‡ªåŠ¨ç®¡ç†ã€‚ç´¢å¼•æ˜¯æŒ‡å‘ä¸»åˆ†ç‰‡å’Œå‰¯æœ¬åˆ†ç‰‡çš„é€»è¾‘å‘½åç©ºé—´ã€‚</td></tr><tr><td><strong>primary shard</strong></td><td>æ¯ä¸ªæ–‡æ¡£éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªä¸»åˆ†ç‰‡ä¸­ã€‚å½“æ‚¨ä¸ºæ–‡æ¡£å»ºç«‹ç´¢å¼•æ—¶ï¼Œå°†é¦–å…ˆåœ¨ä¸» shard ä¸Šå»ºç«‹ç´¢å¼•ï¼Œç„¶ååœ¨ä¸» shard çš„æ‰€æœ‰å‰¯æœ¬ä¸Šå»ºç«‹ç´¢å¼•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç´¢å¼•å…·æœ‰ä¸€ä¸ªä¸»åˆ†ç‰‡ã€‚æ‚¨å¯ä»¥æŒ‡å®šæ›´å¤šçš„ä¸»è¦åˆ†ç‰‡æ¥æ‰©å±• ç´¢å¼•å¯ä»¥å¤„ç†çš„æ–‡æ¡£æ•°é‡ã€‚åˆ›å»ºç´¢å¼•åï¼Œæ‚¨å°†æ— æ³•æ›´æ”¹ç´¢å¼•ä¸­çš„ä¸»è¦åˆ†ç‰‡æ•°é‡ã€‚ä½†æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨split APIå°†ç´¢å¼•æ‹†åˆ†ä¸ºæ–°ç´¢å¼• ã€‚</td></tr><tr><td><strong>replica shard</strong></td><td>æ¯ä¸ªä¸»åˆ†ç‰‡å¯ä»¥å…·æœ‰é›¶ä¸ªæˆ–å¤šä¸ªå‰¯æœ¬ã€‚å‰¯æœ¬æ˜¯ primary shard çš„å‰¯æœ¬ã€‚</td></tr><tr><td><strong>document</strong></td><td>document æ˜¯å­˜å‚¨åœ¨ Elasticsearch ä¸­çš„ JSON æ–‡æ¡£ã€‚æ¯ä¸ª document éƒ½å­˜å‚¨åœ¨ç´¢å¼•ä¸­ï¼Œå¹¶ä¸”æœ‰ type å’Œ idã€‚è¢«ç´¢å¼•çš„ JSON æ–‡æ¡£ å°†å­˜å‚¨åœ¨ _source å­—æ®µä¸­ï¼Œè¯¥å­—æ®µåœ¨è·å–æˆ–æœç´¢æ–‡æ¡£æ—¶é»˜è®¤è¿”å›ã€‚</td></tr><tr><td><strong>id</strong></td><td>æ¯ä¸ª document éƒ½æœ‰ä¸åŒçš„ idï¼Œæ²¡æœ‰æŒ‡å®šçš„è¯ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆã€‚</td></tr><tr><td><strong>field</strong></td><td>ä¸€ä¸ª document åŒ…å«å­—æ®µæˆ–é”®å€¼å¯¹çš„åˆ—è¡¨ã€‚å­—æ®µç±»ä¼¼äºå…³ç³»æ•°æ®åº“ä¸­è¡¨ä¸­çš„åˆ—ã€‚</td></tr><tr><td><strong>source field</strong></td><td>é»˜è®¤æƒ…å†µä¸‹ï¼Œç´¢å¼•çš„JSONæ–‡æ¡£å­˜å‚¨åœ¨ _source å­—æ®µä¸­ï¼Œå¹¶ä¸”å°†ç”±æ‰€æœ‰ get å’Œ search è¯·æ±‚è¿”å›ã€‚è¿™æ ·ï¼Œå¯ä»¥ç›´æ¥ä»æœç´¢ç»“æœä¸­è®¿é—®åŸå§‹å¯¹è±¡ï¼Œè€Œæ— éœ€æ‰§è¡Œç¬¬äºŒæ­¥æ¥ä» ID ä¸­æ£€ç´¢å¯¹è±¡ã€‚</td></tr></tbody></table><p>ç”»å›¾å‡ºæ¥å°±æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/CWbmcX-mPCKR6.png" alt="CWbmcX-mPCKR6"></p><h3 id="replica-shard-æœ‰ä»€ä¹ˆç”¨ï¼Ÿ"><a href="#replica-shard-æœ‰ä»€ä¹ˆç”¨ï¼Ÿ" class="headerlink" title="replica shard æœ‰ä»€ä¹ˆç”¨ï¼Ÿ"></a>replica shard æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</h3><ol><li><p>å¢åŠ æ•…éšœè½¬ç§»ï¼šå¦‚æœä¸»å‰¯æœ¬å‘ç”Ÿæ•…éšœï¼Œå‰¯æœ¬å‰¯æœ¬å¯ä»¥æå‡ä¸ºä¸»å‰¯æœ¬</p></li><li><p>æé«˜æ€§èƒ½ï¼šè·å–å’Œæœç´¢è¯·æ±‚å¯ä»¥ç”±ä¸»æˆ–å‰¯æœ¬åˆ†ç‰‡å¤„ç†ã€‚</p><p> é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªä¸»åˆ†ç‰‡éƒ½æœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œä½†æ˜¯å¯ä»¥åœ¨ç°æœ‰ç´¢å¼•ä¸ŠåŠ¨æ€æ›´æ”¹å‰¯æœ¬çš„æ•°é‡ã€‚å‰¯æœ¬åˆ†ç‰‡æ°¸è¿œä¸ä¼šä¸å…¶ä¸»åˆ†ç‰‡åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šå¯åŠ¨ã€‚</p></li></ol><p>é™¤äº†å®šä¹‰ç´¢å¼•åº”å…·æœ‰çš„ä¸»åˆ†ç‰‡å’Œå‰¯æœ¬åˆ†ç‰‡çš„æ•°é‡å¤–ï¼Œæ‚¨æ— éœ€ç›´æ¥å¼•ç”¨åˆ†ç‰‡ã€‚ç›¸åï¼Œæ‚¨çš„ä»£ç åº”ä»…å¤„ç†ç´¢å¼•ã€‚</p><p>Elasticsearch åœ¨ é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¹‹é—´åˆ†é…åˆ†ç‰‡ï¼Œå¹¶ä¸”åœ¨èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæˆ–æ·»åŠ æ–°èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è‡ªåŠ¨å°†åˆ†ç‰‡ä»ä¸€ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p>åˆ†ç‰‡ é»˜è®¤æ˜¯ 5ä¸ªï¼Œå‰¯æœ¬é»˜è®¤ä¸º 1ä¸ªã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è¿™ç¯‡æ–‡ç« ç®€å•ä»‹ç»äº† ES çš„å¸¸ç”¨åè¯ï¼Œå› ä¸ºåªæœ‰äº†è§£åˆ°è¿™äº›åè¯ï¼Œåœ¨å°ä¼™ä¼´è®¨è®º ES çš„æ—¶å€™ï¼Œæ‰ä¸ä¼šä¸€è„¸æ‡µé€¼ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å·¥ä½œç¬”è®° </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥ä½œç¬”è®° </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Elasticsearch æŠ€æœ¯åˆ†äº«ã€‘â€”â€” Elasticsearch ï¼Ÿå€’æ’ç´¢å¼•ï¼Ÿè¿™éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ</title>
      <link href="2020/08/18/technology-sharing-es-1.html"/>
      <url>2020/08/18/technology-sharing-es-1.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>é©å‘½åŒå¿—æ˜¯å—ç –ï¼Œå“ªé‡Œéœ€è¦å“ªé‡Œæ¬ï¼è¿™ä¸ï¼Œè€å¤§å‘è¯ï¼Œè¦æˆ‘åœ¨ç»„å†…åšä¸€ä¸ª Elasticsearch æŠ€æœ¯åˆ†äº«ã€‚è¿™ä¸è¯é¢˜ä¸€è½¬ï¼Œå¼€å§‹çœ‹èµ·æ¥ ES äº†ã€‚è™½ç„¶å¾ˆä¹…ä¹‹å‰ç”¨è¿‡ ELK åšè¿‡æ—¥å¿—ç›‘æ§ç³»ç»Ÿï¼Œä½†æ˜¯æ¯•ç«Ÿæ—¶éš”å·²ä¹…ï¼Œè¿˜æ˜¯å¾—ä»å¤´çœ‹èµ·ã€‚å½“ç„¶æ‰‹å¤´çš„æ´»ä¹Ÿä¸èƒ½åœï¼Œè¯ä¸å¤šè¯´ï¼Œå¼€å§‹åˆ†äº«ã€‚å…ˆçœ‹çœ‹ä»€ä¹ˆæ˜¯ ESï¼Ÿ</p></blockquote><h3 id="ä»€ä¹ˆæ˜¯ES"><a href="#ä»€ä¹ˆæ˜¯ES" class="headerlink" title="ä»€ä¹ˆæ˜¯ES"></a>ä»€ä¹ˆæ˜¯ES</h3><p>Elasticsearch æ˜¯åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ã€‚</p><p>Elasticsearch ä¸ºæ‰€æœ‰ç±»å‹çš„æ•°æ®æä¾›<strong>è¿‘å®æ—¶ï¼ˆnear real-timeï¼‰</strong>çš„æœç´¢å’Œåˆ†æã€‚</p><p>å¸¸ç”¨åœºæ™¯ï¼š</p><ol><li>ç½‘ç«™æœç´¢</li><li>ELK æ—¥å¿—é‡‡é›†ï¼Œå­˜å‚¨ï¼Œåˆ†æ</li><li>åœ°ç†ä¿¡æ¯ç³»ç»Ÿåˆ†æ</li></ol><p>åƒä¸‹å›¾ä¸­ä½¿ç”¨çš„è®¾è®¡ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/HiP4n4-mnRdVv.png" alt="HiP4n4-mnRdVv"></p><p>ç‰¹ç‚¹ï¼š</p><ol><li>ESæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨ï¼Œå­˜å‚¨çš„æ•°æ®éƒ½æ˜¯åºåˆ—åŒ–ä¸º JSON documents ã€‚</li><li>ä½¿ç”¨<strong>å€’æ’ç´¢å¼•</strong>å­˜å‚¨æ•°æ®ï¼Œå€’æ’ç´¢å¼•æ¯”è¾ƒé€‚åˆå…¨æ–‡æœ¬æœç´¢ã€‚</li><li>åŸºäº<strong>Apache Lucene</strong>æœç´¢å¼•æ“åº“ï¼Œå¯ä»¥å­˜å‚¨ï¼Œæ£€ç´¢æ–‡æ¡£åŠå…ƒæ•°æ®ã€‚</li><li>æ”¯æŒ JSON æ ·å¼çš„æŸ¥è¯¢è¯­è¨€â€”â€”Query DSLï¼Œä¹Ÿæ”¯æŒ SQL æ ·å¼çš„æŸ¥è¯¢ã€‚</li><li>é›†ç¾¤éƒ¨ç½²ï¼Œæ˜“äºæ‰©å±•ã€‚èŠ‚ç‚¹ï¼ˆnodeï¼‰åˆ†ç‰‡ï¼ˆshardï¼‰ï¼Œå°†æ–°çš„ node æ·»åŠ åˆ°é›†ç¾¤æ—¶ï¼ŒES ä¼šè‡ªåŠ¨è¿ç§» shard åˆ°æ–° node ä¸Šï¼Œé‡æ–°å¹³è¡¡é›†ç¾¤ã€‚<ol><li>shard åˆ†ä¸ºä¸¤ç§ ä¸»åˆ†ç‰‡ï¼ˆprimary shardï¼‰å’Œ å‰¯æœ¬åˆ†ç‰‡ ï¼ˆreplica shardï¼‰</li><li>replica shard å­˜æ”¾çš„æ˜¯ primary shard çš„å†—ä½™å‰¯æœ¬ â€”â€” å¯ä»¥é˜²æ­¢é›†ç¾¤æ•…éšœï¼Œæ•°æ®ä¸¢å¤±ï¼ŒåŒæ—¶å¯ä»¥æé«˜æœç´¢æˆ–æ£€ç´¢é€Ÿåº¦ã€‚</li><li>åœ¨åˆ›å»ºç´¢å¼•æ—¶ primary shard æ•°é‡æ˜¯å›ºå®šçš„ï¼Œè€Œreplica shard æ•°é‡æ˜¯å¯ä»¥æ›´æ”¹çš„ã€‚</li><li>åˆ†ç‰‡ç”±ç´¢å¼•é…ç½®ï¼Œåˆ†ç‰‡è¶Šå¤šï¼Œç»´æŠ¤ç´¢å¼•åˆ™å¼€é”€åˆ™è¶Šå¤§ï¼Œåˆ†ç‰‡å¤§å°è¶Šå¤§ï¼Œåˆ™ ES åœ¨å¢å‡èŠ‚ç‚¹é‡æ–°å¹³è¡¡é›†ç¾¤æ—¶ï¼Œåˆ†ç‰‡ç§»åŠ¨æ—¶é—´è¶Šé•¿ã€‚</li></ol></li><li>é›†ç¾¤æ¢å¤ï¼š è·¨é›†ç¾¤å¤åˆ¶ ï¼ˆCCRï¼‰ï¼Œå¯ä»¥è‡ªåŠ¨å°†ç´¢å¼•ä»ä¸»é›†ç¾¤åŒæ­¥åˆ°çƒ­å¤‡ä»½çš„è¾…åŠ©è¿œç¨‹é›†ç¾¤ã€‚</li></ol><h3 id="ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿ</h3><p>å€’æ’ç´¢å¼•ä¹Ÿå¯ä»¥æˆä¸ºåå‘ç´¢å¼•ã€‚</p><p>ä½œä¸ºå¼€å‘å’±ä»¬ç»å¸¸æ¥è§¦åˆ°çš„å°±æ˜¯ MySqlï¼Œå‡è®¾æœ‰ä¸€å †æŠ€æœ¯ä¹¦ç±ï¼Œå¹¶ä¸”å·²ç»ç¼–ä¸Šå·ã€‚</p><ol><li>Java å¹¶å‘ç¼–ç¨‹ä¹‹ç¾</li><li>Java å¼€å‘æ‰‹å†Œ</li><li>æ·±å…¥åˆ†å¸ƒå¼ç¼“å­˜</li><li>Java å¹¶å‘ç¨‹åºè®¾è®¡</li><li>ç®—æ³•</li><li>æ•°æ®ç»“æ„ä¸ç®—æ³•</li></ol><ul><li>å¦‚æœæ”¾åœ¨ MySql é‡Œé¢å°±æ˜¯è¿™æ ·</li></ul><table><thead><tr><th>id</th><th>book_name</th></tr></thead><tbody><tr><td>1</td><td>Java å¹¶å‘ç¼–ç¨‹ä¹‹ç¾</td></tr><tr><td>2</td><td>Java å¼€å‘æ‰‹å†Œ</td></tr><tr><td>3</td><td>æ·±å…¥åˆ†å¸ƒå¼ç¼“å­˜</td></tr><tr><td>4</td><td>Java å¹¶å‘ç¨‹åºè®¾è®¡</td></tr><tr><td>5</td><td>ç®—æ³•</td></tr><tr><td>6</td><td>æ•°æ®ç»“æ„ä¸ç®—æ³•</td></tr></tbody></table><p>æ­¤æ—¶æˆ‘æƒ³æŸ¥è¯¢æ‰€æœ‰å…³äº <strong>å¹¶å‘</strong> çš„ä¹¦ç±ã€‚</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table_book <span class="keyword">where</span> book_name <span class="keyword">like</span> %å¹¶å‘%;</span><br></pre></td></tr></table></figure><p>ç„¶åä¼šå¼€å§‹éå†è¡¨æ ¼ï¼ŒæŸ¥æ‰¾åˆ° 1å’Œ4ä¸¤æ¡è®°å½•ã€‚</p><ul><li>å¦‚æœæ˜¯å€’æ’ç´¢å¼•å¤„ç†çš„è¯</li></ul><p>é¦–å…ˆä¼šå°†æ¯ä¸ªåç§°è¿›è¡Œåˆ†è¯ï¼Œæ¯”å¦‚ <code>Java å¹¶å‘ç¼–ç¨‹ä¹‹ç¾</code> ä¼šè¢«åˆ†ä¸º <code>Java</code> <code>å¹¶å‘</code> <code>ç¼–ç¨‹</code> <code>ä¹‹</code> <code>ç¾</code>ã€‚<br>åˆ†è¯ç»“æŸä¹‹åæŒ‰ç…§è¯å…³è”ä¹¦ç±çš„ç¼–å·ã€‚</p><table><thead><tr><th>term</th><th>ids</th></tr></thead><tbody><tr><td>Java</td><td>1ã€2ã€4</td></tr><tr><td>å¹¶å‘</td><td>1ã€4</td></tr><tr><td>ç¼–ç¨‹</td><td>1</td></tr><tr><td>ç®—æ³•</td><td>5ã€6</td></tr><tr><td>åˆ†å¸ƒå¼</td><td>3</td></tr><tr><td>â€¦</td><td>â€¦</td></tr></tbody></table><p>åœ¨å€’æ’ç´¢å¼•ä¸­æœç´¢<strong>å¹¶å‘</strong>ï¼Œç„¶åè¿›è¡Œæ£€ç´¢ï¼Œå°±å¾ˆå®¹æ˜“å®šä½åˆ°å…³äº<strong>å¹¶å‘</strong>ä¹¦ç±çš„ç¼–å·ã€‚</p><h3 id="é‚£ä»€ä¹ˆæ˜¯-Luceneï¼Ÿ"><a href="#é‚£ä»€ä¹ˆæ˜¯-Luceneï¼Ÿ" class="headerlink" title="é‚£ä»€ä¹ˆæ˜¯ Luceneï¼Ÿ"></a>é‚£ä»€ä¹ˆæ˜¯ Luceneï¼Ÿ</h3><p>Lucene å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå¼€æºçš„ã€é«˜æ€§èƒ½ã€å¯ä¼¸ç¼©çš„ä¿¡æ¯æœç´¢åº“ã€‚ä½¿ç”¨ Java å¼€å‘ï¼Œå°è£…äº†å„ç§å€’æ’ç´¢å¼•å’Œæœç´¢çš„APIã€‚ç›¸å½“äºä¸€ä¸ªç»„ä»¶ã€‚</p><p>è€Œ ES å°±æ˜¯åœ¨ Lucene ä¹‹ä¸Šè¿›è¡Œçš„å¼€å‘ï¼Œä»è€Œå¯ä»¥<strong>é«˜å¯ç”¨</strong>ã€<strong>é›†ç¾¤éƒ¨ç½²</strong>ã€<strong>æ•…éšœè¿ç§»</strong>ã€<strong>å¤‡ä»½å®¹ç¾</strong>ç­‰ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å°±è¿™ä¹ˆå¤šï¼Œå…ˆçŸ¥é“ä¸ª ES æ˜¯å¹²å˜›çš„ã€‚åç»­å†æ…¢æ…¢çœ‹ã€æ…¢æ…¢æ€»ç»“ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å·¥ä½œç¬”è®° </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥ä½œç¬”è®° </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- é™¤äº†è¯»å†™é”ï¼ŒJUC ä¸‹é¢è¿˜æœ‰ä¸ª StampedLockï¼è¿˜ä¸è¿‡æ¥äº†è§£ä¸€ä¸‹ä¹ˆï¼Ÿ</title>
      <link href="2020/08/09/source-code-stamped-lock.html"/>
      <url>2020/08/09/source-code-stamped-lock.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>åœ¨äº†è§£å®Œ ReentrantLock å’Œ ReentrantReadWriteLock ä¹‹åï¼ŒæƒŠå¥‡çš„å‘ç° JUC ä¸‹è¿˜æœ‰ä¸€ä¸ª StampedLock ã€‚ æŸ¥é˜…èµ„æ–™å‘ç°æ˜¯ JDK8 æ–°å¢çš„ä¸€ä¸ªé”ã€‚ç°åœ¨å·²ç» JDK15 äº†ï¼ŒåŸè°…æˆ‘çš„å­¤é™‹å¯¡é—»ï¼Œå®åœ¨æ˜¯ä¸šåŠ¡å¼€å‘ä¸­ç”¨çš„å¤ªå°‘ã€‚é‚£è¡Œå§ï¼Œèµ¶ç´§æ¥çœ‹ä¸€ä¸‹ StampedLock åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæœ‰äº† ReentrantLock å’Œ ReentrantReadWriteLock ä¹‹åè¿˜è¦è®¾è®¡ä¸€ä¸ª StampedLock ï¼Ÿ</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><h4 id="å¾€æœŸå›é¡¾"><a href="#å¾€æœŸå›é¡¾" class="headerlink" title="å¾€æœŸå›é¡¾"></a>å¾€æœŸå›é¡¾</h4><p>åœ¨ä»‹ç» StampedLock ä¹‹å‰è¿˜æ˜¯å…ˆçœ‹ä¸€ä¸‹ ReentrantLock å’Œ ReentrantReadWriteLockã€‚</p><p>ReentrantLockï¼šäº’æ–¥é”ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æŒæœ‰ã€‚æ”¯æŒé”é‡å…¥ã€‚</p><p>ReentrantReadWriteLockï¼šè¯»å†™é”ï¼Œåˆ†ä¸ºè¯»é”å’Œå†™é”ï¼Œæ”¯æŒé‡å…¥ã€‚å…¶ä¸­è¯»è¯»å…±äº«ï¼Œå†™å†™ç‹¬å ï¼Œè¯»å†™äº’æ–¥ï¼Œå†™è¯»äº’æ–¥ã€‚æ”¯æŒé”é™çº§ï¼Œçº¿ç¨‹è·å–å†™é”åå¯ä»¥é™çº§ä¸ºè¯»é”ã€‚é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚</p><p>é‚£ä¸ºä»€ä¹ˆè¦è®¾è®¡ StampedLock å‘¢ï¼Ÿå…ˆæ¥çœ‹ä¸€ä¸‹æºç ä¸Šçš„æ³¨é‡Šï¼š</p><h4 id="StampedLock"><a href="#StampedLock" class="headerlink" title="StampedLock"></a>StampedLock</h4><p>åŸºäºåŠŸèƒ½çš„é”ï¼Œå…·æœ‰ä¸‰ç§æ¨¡å¼æ¥æ§åˆ¶è¯»/å†™è®¿é—®ã€‚StampedLockçš„çŠ¶æ€ç”±ç‰ˆæœ¬å’Œæ¨¡å¼ç»„æˆã€‚é”è·å–æ–¹æ³•è¿”å›ä¸€ä¸ª stamp ç”¨æ¥è¡¨ç¤ºå¹¶æ§åˆ¶é”çŠ¶æ€çš„è®¿é—®ï¼›è¿™äº›æ–¹æ³•çš„â€œtryâ€ç‰ˆæœ¬å¯èƒ½ä¼šè¿”å›ç‰¹æ®Šå€¼é›¶ï¼Œä»¥è¡¨ç¤ºæ— æ³•è·å–è®¿é—®æƒé™ã€‚<br>é”çš„é‡Šæ”¾å’Œè½¬æ¢æ–¹æ³•éœ€è¦ä½¿ç”¨ stamp ä½œä¸ºå‚æ•°ï¼Œå¦‚æœå®ƒä»¬ä¸é”çš„çŠ¶æ€ä¸åŒ¹é…ï¼Œåˆ™ä¼šå¤±è´¥ã€‚</p><p>ä¸‰ç§æ¨¡å¼æ˜¯ï¼šå†™é”ã€è¯»é”ã€ä¹è§‚è¯»é”ã€‚</p><p>å¹¶ä¸”å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p><ol><li>è·å–é”çš„æ—¶å€™ï¼ˆæ— è®ºè¯»é”è¿˜æ˜¯å†™é”æˆ–è€…ä¹è§‚è¯»é”ï¼‰éƒ½ä¼šè¿”å›ä¸€ä¸ª stampï¼Œåœ¨é‡Šæ”¾é”çš„æ—¶å€™éœ€è¦ä½¿ç”¨è¿™ä¸ª stampï¼›</li><li>æ”¯æŒä¸‰ç§æ¨¡å¼è½¬æ¢ï¼›</li><li>ä¸æ˜¯å¯é‡å…¥çš„ï¼Œæ‰€ä»¥è·å¾—é”çš„æ—¶å€™ï¼Œä¸è¦å°è¯•å†æ¬¡è·å–ã€‚</li></ol><h4 id="ä½¿ç”¨æ ·ä¾‹"><a href="#ä½¿ç”¨æ ·ä¾‹" class="headerlink" title="ä½¿ç”¨æ ·ä¾‹"></a>ä½¿ç”¨æ ·ä¾‹</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/8/6 15:27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Count</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> num;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StampedLock stampedLock = <span class="keyword">new</span> StampedLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨å†™é”ï¼Œåœ¨å¯¹ num è¿›è¡Œå†™å…¥çš„æ—¶å€™åŠ é”</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamp = stampedLock.writeLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            num += x;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            stampedLock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¹è§‚è¯»</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è·å–ä¹è§‚è¯»é”ï¼›è¿”å› stamp</span></span><br><span class="line">        <span class="keyword">long</span> stamp = stampedLock.tryOptimisticRead();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// validate éªŒè¯æ˜¯å¦è¢«å†™é”æŒæœ‰</span></span><br><span class="line">            <span class="comment">// æ²¡æœ‰è¢«å†™é”æŒæœ‰ï¼Œå¯ä»¥ç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> (!stampedLock.validate(stamp)) &#123;</span><br><span class="line">                <span class="comment">// è¢«å†™é”æŒæœ‰ï¼Œé‚£åªèƒ½è·å–è¯»é”</span></span><br><span class="line">                stamp = stampedLock.readLock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> num;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            stampedLock.unlockRead(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">convertWrite</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è¯»</span></span><br><span class="line">        <span class="keyword">long</span> stamp = stampedLock.readLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (num == x) &#123;</span><br><span class="line">                <span class="comment">// æ»¡è¶³æ¡ä»¶ï¼Œè½¬æ¢ä¸ºå†™é”</span></span><br><span class="line">                <span class="keyword">long</span> ws = stampedLock.tryConvertToWriteLock(stamp);</span><br><span class="line">                <span class="comment">// è½¬ä¸ºå†™é”æˆåŠŸ</span></span><br><span class="line">                <span class="keyword">if</span> (ws != <span class="number">0L</span>) &#123;</span><br><span class="line">                    stamp = ws;</span><br><span class="line">                    num = x;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// è½¬æ¢å¤±è´¥ï¼Œé‡Šæ”¾è¯»é”</span></span><br><span class="line">                    stampedLock.unlockRead(stamp);</span><br><span class="line">                    <span class="comment">// å†æ¬¡è·å–å†™é”</span></span><br><span class="line">                    stamp = stampedLock.writeLock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            stampedLock.unlock(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å†™é”ä½¿ç”¨æ–¹æ³•ä¸€æ ·ï¼›</li><li>ä¹è§‚è¯»ï¼Œå¯ä»¥å…ˆå»è¯»æ•°æ®ï¼Œå‘ç°æ²¡æœ‰æ”¹å˜å¯ä»¥è¿”å›ï¼Œå‘ç°æ”¹å˜äº†ï¼Œåˆ™é‡æ–°è·å–è¯»é”ï¼Œç„¶åå†è¿”å›ï¼›</li><li>è¯»é”å¯ä»¥å‡çº§ä¸ºå†™é”ï¼Œé€šè¿‡ tryConvertToWriteLock æ–¹æ³•ã€‚</li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/StampedLock-uml-Wq0Jz2.png" alt="StampedLock-uml-Wq0Jz2"></p><p>é€šè¿‡ UML å¯ä»¥çœ‹å‡º StampedLock å’Œ AQS å¹¶æ— ä»»ä½•å…³ç³»ã€‚</p><h4 id="StampedLock-å’Œ-ReentrantReadWriteLock-çš„åŒºåˆ«ï¼Ÿ"><a href="#StampedLock-å’Œ-ReentrantReadWriteLock-çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="StampedLock å’Œ ReentrantReadWriteLock çš„åŒºåˆ«ï¼Ÿ"></a>StampedLock å’Œ ReentrantReadWriteLock çš„åŒºåˆ«ï¼Ÿ</h4><ol><li>StampedLock ä¹Ÿæ˜¯è¯»å†™é”ï¼Œä½†æ˜¯å’Œ AQS æ²¡æœ‰å…³ç³»</li><li>StampedLock é™¤äº† è¯»é”å’Œå†™é”ï¼Œè¿˜æœ‰ä¸€ä¸ªä¹è§‚è¯»ã€‚</li><li>StampedLock çš„è¯»é”å¯ä»¥å‡çº§ä¸ºå†™é”ã€‚</li><li>StampedLock ä¸æ”¯æŒé”é‡å…¥ã€‚</li></ol><h4 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æœ¬æ–‡ä¸»è¦ä»‹ç» StampedLock çš„ç›¸å…³ä½¿ç”¨åŠå’Œ ReentrantReadWriteLock çš„åŒºåˆ«ã€‚</p><p>å› ä¸ºå·¥ä½œç¡®å®å¾ˆå°‘ä½¿ç”¨ï¼Œé˜…è¯»æºç ï¼Œå†…éƒ¨è‡ªæ—‹é€»è¾‘ç­‰æœ‰å¾ˆå¤šã€‚å¦‚æœä»‹ç»çš„è¯ä¼šç¯‡å¹…ç‰¹åˆ«é•¿ï¼Œè¿™é‡Œå°±çœç•¥äº†ã€‚æœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªå·±é˜…è¯»æºç ã€‚</p><p>å› ä¸º StampedLock æä¾›çš„ä¹è§‚è¯»é”æ”¯æŒï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹å¤šè¯»æƒ…å†µä¸‹ï¼Œæ€§èƒ½æ¯” ReentrantReadWriteLock è¦æ›´å¥½ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ StampedLock æ˜¯ä¸æ”¯æŒé”é‡å…¥çš„ã€‚</p><p>å¦ä¸€ä¸ªéœ€è¦è®°ä½çš„å°±æ˜¯ StampedLock å’Œ AQS å¹¶æ²¡æœ‰ä»€ä¹ˆå…³ç³»ï¼Œå®ƒæ˜¯åœ¨è‡ªå·±å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é˜»å¡é˜Ÿåˆ—ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IDEAæ’ä»¶å¼€å‘å¸¸ç”¨API</title>
      <link href="2020/08/01/idea-plugin-development-common-api.html"/>
      <url>2020/08/01/idea-plugin-development-common-api.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>åœ¨å¼€å‘Toolkitè¿‡ç¨‹ä¸­æŸ¥é˜…ç›¸å…³èµ„æ–™å’Œé˜…è¯»å…¶ä»–å¼€æºé¡¹ç›®æ€»ç»“çš„ä¸€äº›å¸¸ç”¨API.<br>æ•´ä½“å†…å®¹æ¥æºäºç½‘ç»œ, ä»¥åŠè‡ªå·±ä½¿ç”¨å¼€å‘Toolkitè¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°çš„.<br>æ€»ç»“çš„ä¸åˆ°ä½çš„åœ°æ–¹æ¬¢è¿æŒ‡æ­£.</p></blockquote><h3 id="AnActionæ“ä½œ"><a href="#AnActionæ“ä½œ" class="headerlink" title="AnActionæ“ä½œ"></a>AnActionæ“ä½œ</h3><ol><li>åˆ›å»ºActioné›†æˆ<code>AnAction</code>å¹¶å®ç°å…¶<code>actionPerformed</code>æ–¹æ³•. åœ¨æ–¹æ³•ä¸­å¯ä»¥è·å–åˆ°<code>AnActionEvent</code>å¯¹è±¡. ä»£ç å¦‚ä¸‹:</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonFormatAction</span> <span class="keyword">extends</span> <span class="title">AnAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(AnActionEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–å½“å‰projectå¯¹è±¡</span></span><br><span class="line">        Project project = event.getData(PlatformDataKeys.PROJECT);</span><br><span class="line">        <span class="comment">// è·å–å½“å‰ç¼–è¾‘çš„æ–‡ä»¶, å¯ä»¥è¿›è€Œè·å– PsiClass, PsiField å¯¹è±¡</span></span><br><span class="line">        PsiFile psiFile = event.getData(CommonDataKeys.PSI_FILE);</span><br><span class="line">        Editor editor = event.getData(CommonDataKeys.EDITOR);</span><br><span class="line">        <span class="comment">// è·å–Javaç±»æˆ–è€…æ¥å£</span></span><br><span class="line">        PsiClass psiClass = getTargetClass(editor, psiFile);</span><br><span class="line">        <span class="comment">// åˆ›å»ºå¹¶è°ƒèµ· DialogWrapper</span></span><br><span class="line">        DialogWrapper dialog = <span class="keyword">new</span> JsonFormat(project, psiFile, editor, psiClass);</span><br><span class="line">        dialog.show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="2"><li>å…¶ä»–æ–¹å¼</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–project. å†…éƒ¨è°ƒç”¨ getData(CommonDataKeys.PROJECT) = getDataContext().getData(CommonDataKeys.PROJECT)</span></span><br><span class="line">Project project = e.getProject();</span><br><span class="line"><span class="comment">// è·å–æ•°æ®ä¸Šä¸‹æ–‡</span></span><br><span class="line">DataContext dataContext = e.getDataContext();</span><br><span class="line"><span class="comment">// contextå¯ä»¥ä¹Ÿè·å–åˆ°å…¶ä»–ä¿¡æ¯, å…¥å‚ä¸º PlatformDataKeys å®šä¹‰çš„å­—æ®µ</span></span><br><span class="line">Project project1 = dataContext.getData(PlatformDataKeys.PROJECT);</span><br><span class="line">Editor editor = dataContext.getData(PlatformDataKeys.EDITOR);</span><br><span class="line">PsiFile psiFile = dataContext.getData(PlatformDataKeys.PSI_FILE);</span><br><span class="line">PsiElement psiElement = dataContext.getData(PlatformDataKeys.PSI_ELEMENT);</span><br><span class="line"><span class="comment">// è™šæ‹Ÿæ–‡ä»¶</span></span><br><span class="line">VirtualFile virtualFile = dataContext.getData(PlatformDataKeys.VIRTUAL_FILE);</span><br></pre></td></tr></table></figure><h3 id="è·å–PsiClass"><a href="#è·å–PsiClass" class="headerlink" title="è·å–PsiClass"></a>è·å–PsiClass</h3><p>PsiClassä¸ºjavaç±»æˆ–è€…æ¥å£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> PsiClass <span class="title">getTargetClass</span><span class="params">(Editor editor, PsiFile file)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> offset = editor.getCaretModel().getOffset();</span><br><span class="line">    PsiElement element = file.findElementAt(offset);</span><br><span class="line">    <span class="keyword">if</span> (element == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        PsiClass target = PsiTreeUtil.getParentOfType(element, PsiClass.class);</span><br><span class="line">        <span class="keyword">return</span> target <span class="keyword">instanceof</span> SyntheticElement ? <span class="keyword">null</span> : target;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Psixxxæ“ä½œ"><a href="#Psixxxæ“ä½œ" class="headerlink" title="Psixxxæ“ä½œ"></a>Psixxxæ“ä½œ</h3><h4 id="PsiClassæ“ä½œAPI"><a href="#PsiClassæ“ä½œAPI" class="headerlink" title="PsiClassæ“ä½œAPI"></a>PsiClassæ“ä½œAPI</h4><p>æºç æœ‰æ³¨é‡Šä¸”æ¯”è¾ƒæ¸…æ¥š, æ­¤å¤„ä»…è®°å½•æˆ‘ç”¨åˆ°çš„ä¸€éƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–å…¨ç±»å</span></span><br><span class="line">String qualifiedName = aClass.getQualifiedName();</span><br><span class="line"><span class="comment">// è·å–æ‰€æœ‰å­—æ®µ</span></span><br><span class="line">PsiField[] fields = aClass.getFields();</span><br></pre></td></tr></table></figure><h4 id="PsiFieldæ“ä½œ"><a href="#PsiFieldæ“ä½œ" class="headerlink" title="PsiFieldæ“ä½œ"></a>PsiFieldæ“ä½œ</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–å­—æ®µå</span></span><br><span class="line">String name = psiField.getName()</span><br></pre></td></tr></table></figure><h4 id="PsiElementæ“ä½œ"><a href="#PsiElementæ“ä½œ" class="headerlink" title="PsiElementæ“ä½œ"></a>PsiElementæ“ä½œ</h4><p>PsiClasså’ŒPsiFieldéƒ½å®ç°äº†PsiElement</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ é™¤</span></span><br><span class="line">element.delete()</span><br><span class="line"><span class="comment">// æ·»åŠ å…ƒç´ , å‘ä¸€ä¸ªç±»ä¸­æ·»åŠ æ–¹æ³•, å­—æ®µç­‰, ä¹Ÿå¯ä»¥è°ƒç”¨ addBefore, addAfter</span></span><br><span class="line">add(PsiElement element)</span><br></pre></td></tr></table></figure><h4 id="PsiTypeæ“ä½œ"><a href="#PsiTypeæ“ä½œ" class="headerlink" title="PsiTypeæ“ä½œ"></a>PsiTypeæ“ä½œ</h4><p>PsiTypeæ”¯æŒå¸¸ç”¨åŸºæœ¬ç±»å‹, ä½†æ˜¯å½“åˆ›å»ºå¯¹è±¡æ—¶åˆ™ä¸æ”¯æŒ.éœ€è¦è‡ªå·±åˆ›å»º</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PsiElementFactory psiElementFactory = JavaPsiFacade.getElementFactory(project);</span><br><span class="line"><span class="comment">// String ç±»å‹</span></span><br><span class="line">PsiType stringPsiType = psiElementFactory.createTypeFromText(<span class="string">&quot;java.lang.String&quot;</span>, <span class="keyword">null</span>)</span><br><span class="line"><span class="comment">// list</span></span><br><span class="line">PsiType listPsiType = psiElementFactory.createTypeFromText(<span class="string">&quot;java.util.List&lt;String&gt;&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰list</span></span><br><span class="line">PsiType typeFromText = psiElementFactory.createTypeFromText(<span class="string">&quot;java.util.List&lt;&quot;</span> + className + <span class="string">&quot;&gt;&quot;</span>, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–API"><a href="#å…¶ä»–API" class="headerlink" title="å…¶ä»–API"></a>å…¶ä»–API</h3><h4 id="XML-æ–‡ä»¶æ“ä½œ"><a href="#XML-æ–‡ä»¶æ“ä½œ" class="headerlink" title="XML æ–‡ä»¶æ“ä½œ"></a>XML æ–‡ä»¶æ“ä½œ</h4><p>å‚è€ƒåœ°å€ï¼š<a href="https://jetbrains.org/intellij/sdk/docs/reference_guide/frameworks_and_external_apis/xml_dom_api.html">https://jetbrains.org/intellij/sdk/docs/reference_guide/frameworks_and_external_apis/xml_dom_api.html</a></p><p>ä»¥ Mapper.xml ä¸¾ä¾‹å£°æ˜æ¥å£ï¼Œç»§æ‰¿ DomElementï¼Œå¹¶é…åˆ @Attributeã€@SubTag ã€@SubTagsList æ³¨è§£å®šä¹‰ä¸€ä¸ª xml modelï¼Œå…¶ä¸­éœ€è¦æ³¨æ„ @SubTagsList æ–¹æ³•è¦ä½¿ç”¨å¤æ•°å½¢å¼ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Mapper</span> <span class="keyword">extends</span> <span class="title">DomElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * namespace</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Attribute(&quot;namespace&quot;)</span></span><br><span class="line">    <span class="function">GenericAttributeValue&lt;String&gt; <span class="title">getNamespace</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * å¢åˆ æ”¹æŸ¥å¯¹åº”çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SubTagsList(&#123;&quot;select&quot;, &quot;insert&quot;, &quot;update&quot;, &quot;delete&quot;&#125;)</span></span><br><span class="line">    <span class="function">List&lt;Statement&gt; <span class="title">getStatements</span><span class="params">()</span></span>;</span><br><span class="line">â€‹</span><br><span class="line">    <span class="meta">@SubTagList(&quot;select&quot;)</span></span><br><span class="line">    <span class="function">List&lt;Select&gt; <span class="title">getSelects</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SubTagList(&quot;insert&quot;)</span></span><br><span class="line">    <span class="function">List&lt;Insert&gt; <span class="title">getInserts</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SubTagList(&quot;update&quot;)</span></span><br><span class="line">    <span class="function">List&lt;Update&gt; <span class="title">getUpdates</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SubTagList(&quot;delete&quot;)</span></span><br><span class="line">    <span class="function">List&lt;Delete&gt; <span class="title">getDeletes</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="æœç´¢æ–‡ä»¶"><a href="#æœç´¢æ–‡ä»¶" class="headerlink" title="æœç´¢æ–‡ä»¶"></a>æœç´¢æ–‡ä»¶</h4><p>æ¯”å¦‚æƒ³æœç´¢é¡¹ç›®ä¸­çš„æ‰€æœ‰ xml æ–‡ä»¶ï¼Œä¸Šé¢ä½¿ç”¨ Mapper æ¥å£å®šä¹‰äº† Mapper.xml çš„ç»“æ„ï¼Œå°±å¯ä»¥åˆ©ç”¨ DomService æœç´¢æ‰€æœ‰çš„ Mapper.xmlï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å½“å‰é¡¹ç›®çš„æ‰€æœ‰å…ƒç´  mapper, åˆ†åˆ«å¡«å…¥ç±»å‹, ä½œç”¨åŸŸ GlobalSearchScope</span></span><br><span class="line">List&lt;DomFileElement&lt;Mapper&gt;&gt; fileElements = DomService.getInstance().getFileElements(Mapper.class, project, GlobalSearchScope.allScope(project));</span><br></pre></td></tr></table></figure><h3 id="å†™å…¥æ–‡ä»¶"><a href="#å†™å…¥æ–‡ä»¶" class="headerlink" title="å†™å…¥æ–‡ä»¶"></a>å†™å…¥æ–‡ä»¶</h3><p>éœ€è¦è°ƒç”¨<code>WriteCommandAction</code>è¿›è¡Œå¼‚æ­¥å†™å…¥.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">WriteCommandAction.runWriteCommandAction(project, () -&gt; &#123;</span><br><span class="line">    doGenerate(psiClass, jsonObject);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="é€šçŸ¥"><a href="#é€šçŸ¥" class="headerlink" title="é€šçŸ¥"></a>é€šçŸ¥</h3><p>åœ¨æ“ä½œæˆåŠŸä¹‹åï¼Œåœ¨ IDEA å³ä¸‹è§’é€šçŸ¥ç”¨æˆ·ï¼Œä½¿ç”¨ NotificationGroup ç±»å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é™æ€å±æ€§</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> NotificationGroup NOTIFICATION_GROUP = <span class="keyword">new</span> NotificationGroup(<span class="string">&quot;Java2Json.NotificationGroup&quot;</span>, NotificationDisplayType.BALLOON, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åœ¨æ–¹æ³•ä¸­è°ƒç”¨</span></span><br><span class="line">    Notification success = NOTIFICATION_GROUP.createNotification(message, NotificationType.INFORMATION);</span><br><span class="line">    Notifications.Bus.notify(success, project);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥å®šä¹‰ä¸ºå·¥å…·ç±»ï¼Œå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¿›è¡Œæ¶ˆæ¯é€šçŸ¥å·¥å…·ç±»</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/2/28 18:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NotificationGroup notificationGroup = <span class="keyword">new</span> NotificationGroup(<span class="string">&quot;ApiDoc.NotificationGroup&quot;</span>, NotificationDisplayType.BALLOON, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">warnNotify</span><span class="params">(String message, Project project)</span> </span>&#123;</span><br><span class="line">        Notifications.Bus.notify(notificationGroup.createNotification(message, NotificationType.WARNING), project);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">infoNotify</span><span class="params">(String message, Project project)</span> </span>&#123;</span><br><span class="line">        Notifications.Bus.notify(notificationGroup.createNotification(message, NotificationType.INFORMATION), project);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">errorNotify</span><span class="params">(String message, Project project)</span> </span>&#123;</span><br><span class="line">        Notifications.Bus.notify(notificationGroup.createNotification(message, NotificationType.ERROR), project);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åŸºæœ¬ä¸Šå¸¸ç”¨çš„å°±æ˜¯è¿™äº›äº†ï¼Œä¹Ÿå¯ä»¥æŸ¥æ‰¾å®˜æ–¹æ–‡æ¡£ï¼Œå®˜æ–¹æ–‡æ¡£ç°åœ¨è¿˜æ˜¯æ¯”è¾ƒå…¨é¢çš„ï¼Œåœ°å€åœ¨ç›¸å…³èµ„æ–™ä¸­ã€‚ä¹Ÿå¯ä»¥ Clone Toolkit è¿™ä¸ªæ’ä»¶æºç ï¼Œæºç ä¸­æœ‰ä¸€äº›æ³¨é‡Šã€‚åœ¨å…¶ä»–ä¼˜ç§€çš„æ’ä»¶ä¸­ï¼ŒåŒæ ·å¯æœ‰ç›¸å…³ä½¿ç”¨æ–¹æ³•ã€‚</p><h4 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h4><ul><li>Toolkit: <a href="https://github.com/liuzhihang/toolkit">https://github.com/liuzhihang/toolkit</a></li><li>copy-as-json: <a href="https://github.com/liuzhihang/copy-as-json">https://github.com/liuzhihang/copy-as-json</a></li><li>IntelliJ Platform SDK: <a href="https://jetbrains.org/intellij/sdk/docs/intro/welcome.html">https://jetbrains.org/intellij/sdk/docs/intro/welcome.html</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> IDEA </category>
          
      </categories>
      
      
        <tags>
            
            <tag> plugin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å·¥å…·å†Œã€‘- IDEA æ’ä»¶æ‰¾ä¸åˆ°ï¼Ÿçœ‹è¿™é‡Œï¼é‚£å°±è‡ªå·±æ•²ä¸€ä¸ªï¼</title>
      <link href="2020/07/29/tool-book-copy-as-json.html"/>
      <url>2020/07/29/tool-book-copy-as-json.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>å¤§å®¶éƒ½ç»å¸¸ä½¿ç”¨ IDEA è¿›è¡Œå¼€å‘ï¼Œè‚¯å®šä¼šä½¿ç”¨ä¸€äº› IDEA æ’ä»¶ï¼Œæˆ‘ä¹‹å‰ä¹Ÿå†™è¿‡ä¸¤ä¸ªæ’ä»¶ï¼Œä¸è¿‡å·²ç»å¾ˆä¹…æ²¡æœ‰æ›´æ–°äº†ï¼Œå°±è®©å®ƒå…ˆæ”¾ç€å§ï¼</p><p>é‚£å°ä¼™ä¼´ä½ æ˜¯å¦æƒ³äº²æ‰‹å†™ä¸€ä¸ªæ’ä»¶ï¼Œæˆ–è€…ä½ æ˜¯å¦æœ‰ä¸€äº›æ’ä»¶çš„æƒ³æ³•ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°æ’ä»¶ã€‚é‚£å°±è‡ªå·±å®ç°ä¸€ä¸ªå§ï¼</p></blockquote><h3 id="åˆ›å»ºé¡¹ç›®"><a href="#åˆ›å»ºé¡¹ç›®" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h3><h4 id="ä½¿ç”¨-Gradle-åˆ›å»º"><a href="#ä½¿ç”¨-Gradle-åˆ›å»º" class="headerlink" title="ä½¿ç”¨ Gradle åˆ›å»º"></a>ä½¿ç”¨ Gradle åˆ›å»º</h4><p>å†™æ’ä»¶ï¼Œå…ˆä»åˆ›å»ºé¡¹ç›®å¼€å§‹ï¼š</p><p><code>File</code> -&gt; <code>New</code> -&gt; <code>Project...</code></p><ul><li>è¿™é‡Œä½¿ç”¨ Gradleï¼Œå…¶ä¸­ Java å·²ç»é»˜è®¤é€‰ä¸­ï¼Œå’±ä»¬å†é¢å¤–é€‰æ‹© <strong>IntelliJ Platform Plugin</strong>ã€‚</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/create-CS5lN3.png" alt="create-CS5lN3"></p><ul><li>ç‚¹å‡» <strong>Next</strong> ï¼Œç„¶åå¡«å†™é¡¹ç›®åç§°ï¼Œè·¯å¾„ç­‰é€‰é¡¹ã€‚</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/create2-rBTM8z.png" alt="create2-rBTM8z"></p><ul><li>é¡¹ç›®ç»“æ„</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/structure-oKmDur.png" alt="structure-oKmDur"></p><p><strong>build.gradle</strong> ä¸ºé¡¹ç›®é…ç½®æ–‡ä»¶ã€‚<br><strong>resources/META-INF/plugin.xml</strong> ä¸ºæ’ä»¶é…ç½®æ–‡ä»¶ã€‚</p><h4 id="ä½¿ç”¨-GitHub-æ¨¡ç‰ˆ"><a href="#ä½¿ç”¨-GitHub-æ¨¡ç‰ˆ" class="headerlink" title="ä½¿ç”¨ GitHub æ¨¡ç‰ˆ"></a>ä½¿ç”¨ GitHub æ¨¡ç‰ˆ</h4><ol><li>è®¿é—® <a href="https://github.com/JetBrains/intellij-platform-plugin-template">https://github.com/JetBrains/intellij-platform-plugin-template</a></li><li>ç‚¹å‡» <strong>Use this template</strong> åˆ›å»ºæ¨¡ç‰ˆã€‚<img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/use-this-template-Z9tfjX.png" alt="use-this-template-Z9tfjX"></li><li>Clone é¡¹ç›®åˆ°è‡ªå·±æœ¬åœ°ã€‚</li></ol><p>æ³¨ï¼šæ¨¡ç‰ˆç”Ÿæˆçš„é¡¹ç›®æ˜¯ä½¿ç”¨çš„ <strong>Kotlin</strong>ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„ç¬¬ä¸€ç§æ–¹å¼åˆ›å»ºã€‚</p><h3 id="å¼€å§‹å¼€å‘"><a href="#å¼€å§‹å¼€å‘" class="headerlink" title="å¼€å§‹å¼€å‘"></a>å¼€å§‹å¼€å‘</h3><h4 id="ä¿®æ”¹-build-gradle-é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹-build-gradle-é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ build.gradle é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹ build.gradle é…ç½®æ–‡ä»¶</h4><p>åŸå†…å®¹å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/build-gradle-K0gj4a.png" alt="build-gradle-K0gj4a"></p><p>ä¿®æ”¹åï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;org.jetbrains.intellij&#x27;</span> version <span class="string">&#x27;0.4.15&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group <span class="string">&#x27;com.liuzhihang.toolkit&#x27;</span></span><br><span class="line">version <span class="string">&#x27;1.0.2&#x27;</span></span><br><span class="line"></span><br><span class="line">sourceCompatibility = <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenLocal()</span><br><span class="line">    maven &#123; url <span class="string">&quot;https://maven.aliyun.com/repository/public&quot;</span> &#125;</span><br><span class="line">    mavenCentral()</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    testCompile group: <span class="string">&#x27;junit&#x27;</span>, name: <span class="string">&#x27;junit&#x27;</span>, version: <span class="string">&#x27;4.12&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// See https://github.com/JetBrains/gradle-intellij-plugin/</span></span><br><span class="line">intellij &#123;</span><br><span class="line">    version <span class="string">&#x27;2019.1.1&#x27;</span></span><br><span class="line">    pluginName <span class="string">&#x27;Copy as Json&#x27;</span></span><br><span class="line">    updateSinceUntilBuild <span class="keyword">false</span></span><br><span class="line">    sameSinceUntilBuild <span class="keyword">false</span></span><br><span class="line">&#125;</span><br><span class="line">patchPluginXml &#123;</span><br><span class="line">    pluginDescription(file(descriptionFile).text)</span><br><span class="line">    changeNotes(file(changesFile).text)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>ä¿®æ”¹ <strong>repositories</strong> ä½¿ç”¨é˜¿é‡Œäº‘</li><li>ä¿®æ”¹ <strong>patchPluginXml</strong> ä½¿ç”¨å¤–ç½®æ–‡ä»¶</li><li>åœ¨<strong>æ ¹ç›®å½•</strong>ä¸‹åˆ›å»º parts è·¯å¾„ï¼Œå¹¶åˆ›å»º <strong>changeNotes.html</strong>ã€<strong>pluginDescription.html</strong></li></ol><h4 id="ä¿®æ”¹-resources-META-INF-plugin-xml-æ’ä»¶ä¿¡æ¯"><a href="#ä¿®æ”¹-resources-META-INF-plugin-xml-æ’ä»¶ä¿¡æ¯" class="headerlink" title="ä¿®æ”¹ resources/META-INF/plugin.xml æ’ä»¶ä¿¡æ¯"></a>ä¿®æ”¹ resources/META-INF/plugin.xml æ’ä»¶ä¿¡æ¯</h4><p>åŸå†…å®¹å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/plugin-xml-AuzOSc.png" alt="plugin-xml-AuzOSc"></p><p>ä¿®æ”¹åï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">idea-plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>com.liuzhihang.toolkit.copyasjson<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Copy as Json<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vendor</span> <span class="attr">email</span>=<span class="string">&quot;liuzhihangs@qq.com&quot;</span> <span class="attr">url</span>=<span class="string">&quot;https://liuzhihang.com&quot;</span>&gt;</span>Liu ZhiHang<span class="tag">&lt;/<span class="name">vendor</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>&lt;![CDATA[ Description will be added by gradle build]]&gt;<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- please see http://www.jetbrains.org/intellij/sdk/docs/basics/getting_started/plugin_compatibility.html</span></span><br><span class="line"><span class="comment">         on how to target different products --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">depends</span>&gt;</span>com.intellij.modules.java<span class="tag">&lt;/<span class="name">depends</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">idea-version</span> <span class="attr">since-build</span>=<span class="string">&quot;181.00&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensions</span> <span class="attr">defaultExtensionNs</span>=<span class="string">&quot;com.intellij&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Add your extensions here --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">actions</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">actions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">idea-plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>plugin.xml è¯´æ˜ï¼š<a href="https://jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_configuration_file.html">https://jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_configuration_file.html</a></p><h4 id="åˆ›å»º-Action"><a href="#åˆ›å»º-Action" class="headerlink" title="åˆ›å»º Action"></a>åˆ›å»º Action</h4><ol><li><p>å…ˆåœ¨ main ä¸‹ åˆ›å»º java ç›®å½•ï¼ŒåŠåŒ…è·¯å¾„ã€‚</p></li><li><p><code>New</code> -&gt; <code>Plugin DevKit</code> -&gt; <code>Action</code>  <img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/new-action-Pbv61Y.png" alt="new-action-Pbv61Y"></p></li><li><p>è®¾ç½® Action çš„ <strong>id</strong> ã€<strong>Class Name</strong> ã€ <strong>description</strong> ã€ <strong>group</strong> åŠ<strong>å¿«æ·é”®</strong>ç­‰<img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/create-action-5rIhur.png" alt="create-action-5rIhur"></p></li><li><p>è¿™æ—¶å€™ä¼šå‘ç°åœ¨ plugin.xml ä¹Ÿæ’å…¥äº† <strong>action</strong>ã€‚</p></li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">actions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span> <span class="attr">id</span>=<span class="string">&quot;Toolkit.Json.CopyAsJsonAction&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.liuzhihang.toolkit.action.CopyAsJsonAction&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">text</span>=<span class="string">&quot;CopyAsJsonAction&quot;</span> <span class="attr">description</span>=<span class="string">&quot;Copy As Json&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">add-to-group</span> <span class="attr">group-id</span>=<span class="string">&quot;EditorTabsGroup&quot;</span> <span class="attr">anchor</span>=<span class="string">&quot;first&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">keyboard-shortcut</span> <span class="attr">keymap</span>=<span class="string">&quot;$default&quot;</span> <span class="attr">first-keystroke</span>=<span class="string">&quot;shift meta J&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">actions</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œå·²ç»ç»“æ„å®Œå…¨åˆ›å»ºå®Œæ¯•äº†ï¼Œä¸‹é¢å°†æ¼”ç¤ºæ’ä»¶ <strong>copy-as-json</strong> çš„å†…éƒ¨é€»è¾‘ã€‚å½“ç„¶è¿™å—ä¹Ÿå¯ä»¥ç›´æ¥è·³è¿‡ï¼Œé˜…è¯»æºç å³å¯ã€‚</p><p>æºç åœ°å€ï¼šæ–‡æœ«ç›¸å…³èµ„æ–™æˆ–å…¬ä¼—å·å‘é€ <strong>copy-as-json</strong> è·å–ã€‚</p><p>æ’ä»¶æ•ˆæœï¼šå°† JavaBean å¤åˆ¶ä¸º Json å­—ç¬¦ä¸²ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/demo-gNnhR9.gif" alt="demo-gNnhR9"></p><h4 id="å¼€å‘ç¬”è®°"><a href="#å¼€å‘ç¬”è®°" class="headerlink" title="å¼€å‘ç¬”è®°"></a>å¼€å‘ç¬”è®°</h4><p>é¦–å…ˆéœ€è¦çŸ¥é“ä¸€äº›å¸¸ç”¨çš„ APIï¼Œå¸¸ç”¨ API å¯ä»¥é˜…è¯»å®˜æ–¹æ–‡æ¡£æˆ–è€…å…³æ³¨å…¬ä¼—å·åé¢ä¼šæ¨é€ï¼Œè¿™é‡Œä»…ä»‹ç»ä¸€äº›åœ¨è¿™é‡Œç”¨åˆ°çš„ã€‚</p><ul><li>æ‰“å¼€ <strong>CopyAsJsonAction</strong> </li></ul><p>è¯¥ç±»ç»§æ‰¿å¹¶éœ€è¦å®ç° <strong>actionPerformed</strong> æ–¹æ³•ã€‚åœ¨ <strong>actionPerformed</strong> æ–¹æ³•ä¸­å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•è·å–åˆ°é¡¹ç›®ç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–é¡¹ç›®</span></span><br><span class="line">Project project = e.getData(PlatformDataKeys.PROJECT);</span><br><span class="line"><span class="comment">// è·å–Psiæ–‡ä»¶</span></span><br><span class="line">PsiFile psiFile = e.getData(CommonDataKeys.PSI_FILE);</span><br><span class="line"><span class="comment">// è·å–å½“å‰ç¼–è¾‘çš„æ–‡ä»¶</span></span><br><span class="line">Editor editor = e.getData(CommonDataKeys.EDITOR);</span><br></pre></td></tr></table></figure><ul><li>è·å–åˆ°å½“å‰ç¼–è¾‘çš„æ–‡ä»¶</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PsiClass <span class="title">getTargetClass</span><span class="params">(<span class="meta">@NotNull</span> Editor editor, <span class="meta">@NotNull</span> PsiFile file)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> offset = editor.getCaretModel().getOffset();</span><br><span class="line">    PsiElement element = file.findElementAt(offset);</span><br><span class="line">    <span class="keyword">if</span> (element != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰ç±»</span></span><br><span class="line">        PsiClass target = PsiTreeUtil.getParentOfType(element, PsiClass.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> target <span class="keyword">instanceof</span> SyntheticElement ? <span class="keyword">null</span> : target;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä»å½“å‰ç¼–è¾‘çš„æ–‡ä»¶é‡Œé¢è·å–åˆ°å­—æ®µ</li></ul><p>å°†å½“å‰ç¼–è¾‘çš„ JavaBean ä¸­çš„å­—æ®µæå–ï¼Œå¹¶è½¬æ¢ä¸º Mapã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String, Object&gt; fieldsMap = getFields(selectedClass);</span><br></pre></td></tr></table></figure><p>getFields æ–¹æ³•ç¯‡å¹…è¾ƒé•¿ï¼Œè¯·å‚è€ƒæºç ã€‚</p><ul><li>å°†å­—æ®µè½¬åŒ–æˆ Json å­—ç¬¦ä¸²ï¼Œå¹¶æ ¼å¼åŒ–</li></ul><p>ä½¿ç”¨ Gson å°† Map è½¬æ¢ä¸º Json å­—ç¬¦ä¸²ï¼Œå¹¶æ ¼å¼åŒ–ã€‚å…¶ä¸­æ ¼å¼åŒ–è‡ªå®šä¹‰äº†ç¼©è¿›ã€‚</p><p>è§ä»£ç ï¼š<code>com.liuzhihang.toolkit.utils.GsonFormatUtil</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Gson gson = <span class="keyword">new</span> GsonBuilder().create();</span><br><span class="line">String json = GsonFormatUtil.gsonFormat(gson, fieldsMap);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰ç¼©è¿›æ ¼å¼ String json = new GsonBuilder().setPrettyPrinting().create().toJson(fieldsMap);</span></span><br><span class="line">StringSelection selection = <span class="keyword">new</span> StringSelection(json);</span><br></pre></td></tr></table></figure><ul><li>å°† Json å­—ç¬¦ä¸²æ‹·è´åˆ°å‰ªè´´æ¿</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">StringSelection selection = <span class="keyword">new</span> StringSelection(json);</span><br><span class="line">Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();</span><br><span class="line">clipboard.setContents(selection, selection);</span><br></pre></td></tr></table></figure><ul><li>å‘å‡ºæç¤º success</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String message = <span class="string">&quot;Convert &quot;</span> + selectedClass.getName() + <span class="string">&quot; to JSON success, copied to clipboard.&quot;</span>;</span><br><span class="line">Notification success = NOTIFICATION_GROUP.createNotification(message, NotificationType.INFORMATION);</span><br><span class="line">Notifications.Bus.notify(success, project);</span><br></pre></td></tr></table></figure><h4 id="æµ‹è¯•è¿è¡Œ"><a href="#æµ‹è¯•è¿è¡Œ" class="headerlink" title="æµ‹è¯•è¿è¡Œ"></a>æµ‹è¯•è¿è¡Œ</h4><p>å³ä¾§ <code>Gradle</code> -&gt; <code>é€‰æ‹© intellij</code> -&gt; <code>ç‚¹å‡» runlde</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/run-GfscZn.png" alt="run-GfscZn"></p><h4 id="æ‰“åŒ…"><a href="#æ‰“åŒ…" class="headerlink" title="æ‰“åŒ…"></a>æ‰“åŒ…</h4><p>å³ä¾§ <code>Gradle</code> -&gt; é€‰æ‹© <code>intellij</code> -&gt; <code>ç‚¹å‡» buildPlugin</code></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/build-epNxlA.png" alt="build-epNxlA"></p><p>æ­¤æ—¶åœ¨é¡¹ç›®è·¯å¾„ä¸‹ä¼šç”Ÿæˆæ’ä»¶ï¼ŒæŠŠè¿™ä¸ªæ’ä»¶åŒ…å‘ç»™å°å…„å¼Ÿå®‰è£…ä½¿ç”¨å°±è¡Œäº†ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/build-1-2aX8za.png" alt="build-1-2aX8za"></p><h4 id="ä¸Šä¼ åˆ°-IDEA-æ’ä»¶åº“"><a href="#ä¸Šä¼ åˆ°-IDEA-æ’ä»¶åº“" class="headerlink" title="ä¸Šä¼ åˆ° IDEA æ’ä»¶åº“"></a>ä¸Šä¼ åˆ° IDEA æ’ä»¶åº“</h4><p>è®¿é—® <a href="https://plugins.jetbrains.com/">https://plugins.jetbrains.com/</a> åˆ›å»ºè´¦å·ï¼Œå°†æ’ä»¶åŒ…ä¸Šä¼ åˆ°ä»“åº“å³å¯ã€‚å½“ç„¶ä¹Ÿæœ‰å…¶ä»–çš„æ–¹å¼ï¼Œè¿™å—å°±æ²¡æœ‰ç ”ç©¶äº†ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é€šè¿‡ä¸Šé¢çš„æ–¹å¼å·²ç»ç®€å•å¼€å‘ä¸€ä¸ªæ’ä»¶äº†ï¼Œè¦é—®è¿™ä¸ªæ’ä»¶æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p><p>å…¶å®å°±æ˜¯åœ¨å†™æ–‡æ¡£ï¼Œæˆ–è€…æ¥å£è°ƒç”¨çš„æ—¶å€™ï¼Œç›´æ¥å°† Java Bean å¤åˆ¶ä¸º Json ä¸²ï¼Œçœè¿‡ä¸€ä¸ªä¸€ä¸ªæ•²ï¼Œç„¶åæ‰‹å†™ Json äº†ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/postman-7trAcJ.gif" alt="postman-7trAcJ"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/req111-JvWo5q.gif" alt="req111-JvWo5q"></p><h4 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h4><p>[1] IntelliJ Platform SDK DevGuideï¼š<a href="https://jetbrains.org/intellij/sdk/docs/intro/intellij_platform.html">https://jetbrains.org/intellij/sdk/docs/intro/intellij_platform.html</a><br>[2] JetBrains Plugins Repositoryï¼š<a href="https://plugins.jetbrains.com/">https://plugins.jetbrains.com/</a><br>[3] Toolkitï¼š <a href="https://github.com/liuzhihang/toolkit">https://github.com/liuzhihang/toolkit</a><br>[4] copy-as-jsonï¼š<a href="https://github.com/liuzhihang/copy-as-json">https://github.com/liuzhihang/copy-as-json</a><br>[5] copy-as-json æ’ä»¶åœ°å€ï¼š<a href="https://plugins.jetbrains.com/plugin/13606-copy-as-json">https://plugins.jetbrains.com/plugin/13606-copy-as-json</a></p>]]></content>
      
      
      <categories>
          
          <category> å·¥å…·å†Œ </category>
          
          <category> IDEA </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥å…·å†Œ </tag>
            
            <tag> IDEA </tag>
            
            <tag> plugin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- å¿«è¿›æ¥ï¼èŠ±å‡ åˆ†é’Ÿçœ‹ä¸€ä¸‹ ReentrantReadWriteLock çš„åŸç†ï¼</title>
      <link href="2020/07/27/source-code-reentrant-read-write-lock.html"/>
      <url>2020/07/27/source-code-reentrant-read-write-lock.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><br><p>åœ¨çœ‹å®Œ ReentrantLock ä¹‹åï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ ReentrantLock å·²ç»è¶³å¤Ÿä½¿ç”¨ï¼Œä½†æ˜¯å› ä¸º ReentrantLock æ˜¯ç‹¬å é”ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–è¯¥é”ï¼Œè€Œå¾ˆå¤šåº”ç”¨åœºæ™¯éƒ½æ˜¯è¯»å¤šå†™å°‘ï¼Œè¿™æ—¶å€™ä½¿ç”¨ ReentrantLock å°±ä¸å¤ªåˆé€‚äº†ã€‚è¯»å¤šå†™å°‘çš„åœºæ™¯è¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿåœ¨ JUC åŒ…ä¸‹åŒæ ·æä¾›äº†è¯»å†™é” ReentrantReadWriteLock æ¥åº”å¯¹è¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>æ”¯æŒç±»ä¼¼ ReentrantLock è¯­ä¹‰çš„ ReadWriteLock çš„å®ç°ã€‚</p><p>å…·æœ‰ä»¥ä¸‹å±æ€§ï¼š</p><ul><li><strong>è·å–é¡ºåº</strong></li></ul><p>æ­¤ç±»ä¸ä¼šå°†è¯»å–ä¼˜å…ˆæˆ–å†™å…¥ä¼˜å…ˆå¼ºåŠ ç»™é”è®¿é—®çš„æ’åºã€‚ä½†æ˜¯ï¼Œå®ƒç¡®å®æ”¯æŒå¯é€‰çš„<em>å…¬å¹³</em> ç­–ç•¥ã€‚</p><p>æ”¯æŒ<strong>å…¬å¹³æ¨¡å¼</strong>å’Œ<strong>éå…¬å¹³æ¨¡å¼</strong>ï¼Œé»˜è®¤ä¸º<strong>éå…¬å¹³æ¨¡å¼</strong>ã€‚</p><ul><li><strong>é‡å…¥</strong></li></ul><p>å…è®¸ reader å’Œ writer æŒ‰ç…§ <code>ReentrantLock</code> çš„æ ·å¼é‡æ–°è·å–è¯»é”æˆ–å†™é”ã€‚åœ¨å†™çº¿ç¨‹é‡Šæ”¾æŒæœ‰çš„æ‰€æœ‰å†™é”åï¼Œreader æ‰å…è®¸é‡å…¥ä½¿ç”¨å®ƒä»¬ã€‚æ­¤å¤–ï¼Œwriter å¯ä»¥è·å–è¯»é”ï¼Œä½†åè¿‡æ¥åˆ™ä¸æˆç«‹ã€‚</p><ul><li><strong>é”é™çº§</strong></li></ul><p>é‡å…¥è¿˜å…è®¸ä»å†™é”é™çº§ä¸ºè¯»é”ï¼Œé€šè¿‡å…ˆè·å–å†™é”ï¼Œç„¶åè·å–è¯»é”ï¼Œæœ€åé‡Šæ”¾å†™é”çš„æ–¹å¼é™çº§ã€‚ä½†æ˜¯ï¼Œä»è¯»é”å‡çº§åˆ°å†™é”æ˜¯<strong>ä¸å¯èƒ½çš„</strong>ã€‚</p><ul><li><strong>é”è·å–çš„ä¸­æ–­</strong></li></ul><p>è¯»é”å’Œå†™é”éƒ½æ”¯æŒé”è·å–æœŸé—´çš„ä¸­æ–­ã€‚</p><ul><li><strong><code>Condition</code> æ”¯æŒ</strong></li></ul><p>å†™é”æä¾›äº†ä¸€ä¸ª <code>Condition</code> å®ç°ï¼Œå¯¹äºå†™é”æ¥è¯´ï¼Œè¯¥å®ç°çš„æ–¹å¼ä¸ <code>ReentrantLock.newCondition()</code> æä¾›çš„ <code>Condition</code> å®ç°å¯¹ <code>ReentrantLock</code> æ‰€åšçš„è¡Œä¸ºç›¸åŒã€‚å½“ç„¶ï¼Œæ­¤ <code>Condition</code> åªèƒ½ç”¨äºå†™é”ã€‚è¯»é”ä¸æ”¯æŒ <code>Condition</code>ã€‚</p><ul><li><strong>ç›‘æµ‹</strong></li></ul><p>æ­¤ç±»æ”¯æŒä¸€äº›ç¡®å®šæ˜¯ä¿æŒé”è¿˜æ˜¯äº‰ç”¨é”çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•è®¾è®¡ç”¨äºç›‘è§†ç³»ç»ŸçŠ¶æ€ï¼Œè€Œä¸æ˜¯åŒæ­¥æ§åˆ¶ã€‚</p><p>é”æœ€å¤šæ”¯æŒ 65535 ä¸ªé€’å½’å†™é”å’Œ 65535 ä¸ªè¯»é”</p><p>ä»¥ä¸Šä¸º <em>Java Api å®˜æ–¹æ–‡æ¡£</em><sup>[1]</sup> çš„è§£é‡Šï¼Œæ€»ç»“ä¸€ä¸‹å†…å®¹å¦‚ä¸‹ï¼š</p><ol><li>æ”¯æŒéå…¬å¹³å’Œå…¬å¹³æ¨¡å¼ï¼Œé»˜è®¤ä¸ºéå…¬å¹³æ¨¡å¼ã€‚</li><li>æ”¯æŒé‡å…¥ï¼Œè¯»é”å¯ä»¥é‡å…¥è·å–è¯»é”ï¼Œå†™é”å¯ä»¥é‡å…¥è·å–å†™é”ï¼Œå†™é”å¯ä»¥è·å–è¯»é”ï¼Œè¯»é”ä¸å¯ä»¥è·å–å†™é”ã€‚</li><li>é”å¯ä»¥é™çº§ï¼Œä»å†™é”é™çº§ä¸ºè¯»é”ï¼Œä½†æ˜¯ä¸å¯èƒ½ä»è¯»é”å‡çº§åˆ°å†™é”ã€‚</li></ol><h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CachedData</span> </span>&#123;</span><br><span class="line">    Object data;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> cacheValid;</span><br><span class="line">    <span class="keyword">final</span> ReentrantReadWriteLock rwl = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">processCachedData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è¯»é”åŠ é”</span></span><br><span class="line">        rwl.readLock().lock();</span><br><span class="line">        <span class="keyword">if</span> (!cacheValid) &#123;</span><br><span class="line">            <span class="comment">// è·å–å†™é”ä¹‹å‰å¿…é¡»é‡Šæ”¾è¯»é”</span></span><br><span class="line">            rwl.readLock().unlock();</span><br><span class="line">            <span class="comment">// å†™é”åŠ é”</span></span><br><span class="line">            rwl.writeLock().lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// é‡æ–°æ£€æŸ¥çŠ¶æ€ï¼Œå› ä¸ºå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½</span></span><br><span class="line">                <span class="comment">// åœ¨æ‰§è¡Œæ“ä½œä¹‹å‰è·å–äº†å†™é”å®šå¹¶æ›´æ”¹äº†çŠ¶æ€</span></span><br><span class="line">                <span class="keyword">if</span> (!cacheValid) &#123;</span><br><span class="line">                    data = ...</span><br><span class="line">                    cacheValid = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// é€šè¿‡åœ¨é‡Šæ”¾å†™é”ä¹‹å‰è·å–è¯»é”æ¥é™çº§</span></span><br><span class="line">                rwl.readLock().lock();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                rwl.writeLock().unlock(); <span class="comment">// Unlock write, still hold read</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            use(data);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            rwl.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åªæ˜¯å®˜æ–¹æ–‡æ¡£æä¾›çš„ä¸€ä¸ª demoã€‚</p><h4 id="é—®é¢˜ç–‘é—®"><a href="#é—®é¢˜ç–‘é—®" class="headerlink" title="é—®é¢˜ç–‘é—®"></a>é—®é¢˜ç–‘é—®</h4><ol><li>åœ¨ ReentrantReadWriteLock ä¸­ state ä»£è¡¨ä»€ä¹ˆï¼Ÿ</li><li>çº¿ç¨‹è·å–é”çš„æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</li><li>è¯»é”å’Œå†™é”çš„å¯é‡å…¥æ€§æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</li><li>å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¢«é˜»å¡çš„åç»­æ“ä½œæ˜¯ä»€ä¹ˆï¼Ÿ</li><li>é”é™çº§æ˜¯æ€ä¹ˆé™çº§çš„ï¼Ÿ</li></ol><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="ä»£ç ç»“æ„"><a href="#ä»£ç ç»“æ„" class="headerlink" title="ä»£ç ç»“æ„"></a>ä»£ç ç»“æ„</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ReentrantReadWriteLock-uml-SQCZqu.png" alt="ReentrantReadWriteLock-uml-SQCZqu"></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantReadWriteLock</span> <span class="keyword">implements</span> <span class="title">ReadWriteLock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6992448646407690164L</span>;</span><br><span class="line">    <span class="comment">/** æä¾›è¯»é”çš„å†…éƒ¨ç±» */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.ReadLock readerLock;</span><br><span class="line">    <span class="comment">/** æä¾›å†™é”çš„å†…éƒ¨ç±» */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.WriteLock writerLock;</span><br><span class="line">    <span class="comment">/** æ‰§è¡Œæ‰€æœ‰åŒæ­¥æœºåˆ¶ */</span></span><br><span class="line">    <span class="keyword">final</span> Sync sync;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="state"><a href="#state" class="headerlink" title="state"></a>state</h4><p>ä¹‹å‰åœ¨é˜…è¯» ReentrantLock æºç çš„æ—¶å€™ state ä»£è¡¨äº†é”çš„çŠ¶æ€ï¼Œ0 è¡¨ç¤ºæ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œå¤§äº 1 è¡¨ç¤ºå·²ç»æœ‰çº¿ç¨‹æŒæœ‰é”åŠå…¶é‡å…¥çš„æ¬¡æ•°ã€‚è€Œåœ¨ ReentrantReadWriteLock æ˜¯è¯»å†™é”ï¼Œé‚£å°±éœ€è¦ä¿å­˜<strong>è¯»é”</strong>å’Œ<strong>å†™é”</strong>ä¸¤ç§çŠ¶æ€çš„ï¼Œé‚£æ˜¯æ€ä¹ˆæ ·è¡¨ç¤ºçš„å‘¢ï¼Ÿ</p><p>åœ¨ ReentrantReadWriteLock ä¸­åŒæ ·å­˜åœ¨ä¸€ä¸ª Sync ç»§æ‰¿äº† AbstractQueuedSynchronizerï¼Œä¹Ÿæ˜¯ FairSyncã€NonfairSync çš„çˆ¶ç±»ã€‚å†…éƒ¨å®šä¹‰äº† state çš„ä¸€äº›æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6317671515068378041L</span>;</span><br><span class="line">    <span class="comment">// ç§»ä½æ•°</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHARED_SHIFT   = <span class="number">16</span>;</span><br><span class="line">    <span class="comment">// å•ä½</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHARED_UNIT    = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT);</span><br><span class="line">    <span class="comment">// æœ€å¤§æ•°é‡ 1 &lt;&lt; 16 -&gt; 65536</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_COUNT      = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// è®¡ç®—ç‹¬å æ•°ä½¿ç”¨ 1 &lt;&lt; 16 -&gt; 65536</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXCLUSIVE_MASK = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›å…±äº«ä¿ç•™æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sharedCount</span><span class="params">(<span class="keyword">int</span> c)</span>    </span>&#123; <span class="keyword">return</span> c &gt;&gt;&gt; SHARED_SHIFT; &#125;</span><br><span class="line">    <span class="comment">// è¿”å›ç‹¬å ä¿ç•™æ•° </span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">exclusiveCount</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; <span class="keyword">return</span> c &amp; EXCLUSIVE_MASK; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨ AQS ä¸­å®šä¹‰ state ä¸º int ç±»å‹ï¼Œè€Œåœ¨ ReentrantReadWriteLock ä¸­ï¼Œå°† state çš„ é«˜ 16 ä½å’Œä½ 16 ä½æ‹†å¼€è¡¨ç¤ºè¯»å†™é”ã€‚å…¶ä¸­é«˜ 16 ä½è¡¨ç¤ºè¯»é”ï¼Œä½ 16 ä½è¡¨ç¤ºå†™é”ã€‚åˆ†åˆ«ä½¿ç”¨ sharedCount å’Œ exclusiveCount æ–¹æ³•è·å–è¯»é”å’Œå†™é”çš„å½“å‰çŠ¶æ€ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ReentrantReadWriteLock-state-JusW2l.png" alt="ReentrantReadWriteLock-state-JusW2l"></p><p>ä¸‹é¢åˆ†åˆ«ä»è¯»é”å’Œå†™é”çš„è§’åº¦æ¥çœ‹å¦‚ä½•è¿›è¡ŒåŠ é”å’Œé‡Šæ”¾é”çš„ï¼Ÿ</p><h4 id="ReadLock-lock"><a href="#ReadLock-lock" class="headerlink" title="ReadLock.lock"></a>ReadLock.lock</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadLock</span> </span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–è¯»å–é”ã€‚</span></span><br><span class="line"><span class="comment">     * å¦‚æœå†™é”æ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåˆ™è·å–è¯»é”å¹¶ç«‹å³è¿”å›ã€‚</span></span><br><span class="line"><span class="comment">     * å¦‚æœå†™é”ç”±å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåˆ™å‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œ</span></span><br><span class="line"><span class="comment">     * å½“å‰çº¿ç¨‹å°†è¢«ç¦ç”¨ï¼Œå¹¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°è·å–è¯»é”ä¸ºæ­¢ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ AQS è·å–å…±äº«èµ„æº</span></span><br><span class="line">        sync.acquireShared(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ReentrantReadWriteLock-AQS-Share-gTrD2e.png" alt="ReentrantReadWriteLock-AQS-Share-gTrD2e"></p><p>è·å–å…±äº«èµ„æºï¼Œè¿™å—ä½¿ç”¨çš„ AQS çš„é€»è¾‘ï¼Œå…¶ä¸­ tryAcquireShared(arg) æ˜¯åœ¨ ReentrantReadWriteLock.Sync ä¸­å®ç°çš„ã€‚å¹¶ä¸” AQS ä¸­æœ‰è§„å®šï¼ŒtryAcquireShared åˆ†ä¸ºä¸‰ç§è¿”å›å€¼ï¼š</p><ol><li>å°äº 0: è¡¨ç¤ºå¤±è´¥ï¼›</li><li>ç­‰äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œä½†åç»­çš„èŠ‚ç‚¹ä¸èƒ½ä»¥å…±äº«æ¨¡å¼è·å–æˆåŠŸ; </li><li>å¤§äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œåç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¹Ÿå¯èƒ½ä¼šæˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåç»­ç­‰å¾…çº¿ç¨‹å¿…é¡»æ£€æŸ¥å¯ç”¨æ€§ã€‚</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">        Thread current = Thread.currentThread();</span><br><span class="line">        <span class="comment">// è·å– state å€¼</span></span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="comment">// ç‹¬å è®¡æ•°ä¸ä¸º 0 ä¸” ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œ è¯´æ˜å·²ç»æœ‰å†™é”</span></span><br><span class="line">        <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp; getExclusiveOwnerThread() != current)</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// è·å–å…±äº«è®¡æ•°ï¼ˆè¯»é”è®¡æ•°ï¼‰</span></span><br><span class="line">        <span class="keyword">int</span> r = sharedCount(c);</span><br><span class="line">        <span class="comment">// ä¸éœ€è¦é˜»å¡è¯»é” &amp;&amp; å…±äº«è®¡æ•°å°äºæœ€å¤§å€¼ &amp;&amp; state æ›´æ–°æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (!readerShouldBlock() &amp;&amp; r &lt; MAX_COUNT &amp;&amp;</span><br><span class="line">            compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// å½“å‰è¯»é”è®¡æ•°ä¸º 0</span></span><br><span class="line">                <span class="comment">// firstReaderæ˜¯è·å¾—è¯»é”çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">                <span class="comment">// firstReaderHoldCountæ˜¯firstReaderçš„ä¿æŒè®¡æ•°</span></span><br><span class="line">                firstReader = current;</span><br><span class="line">                firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                <span class="comment">// è¯»é”é‡å…¥</span></span><br><span class="line">                firstReaderHoldCount++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å½“å‰ç¼“å­˜è®¡æ•°</span></span><br><span class="line">                HoldCounter rh = cachedHoldCounter;</span><br><span class="line">                <span class="comment">// å½“å‰çº¿ç¨‹æ²¡æœ‰è®¡æ•° æˆ–è€… æ²¡æœ‰åˆ›å»ºè®¡æ•°å™¨</span></span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                    <span class="comment">// åˆ›å»ºè®¡æ•°ï¼ŒåŸºäº ThreadLocal</span></span><br><span class="line">                    cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>) </span><br><span class="line">                    readHolds.set(rh);</span><br><span class="line">                <span class="comment">// è®¡æ•°ç´¯åŠ </span></span><br><span class="line">                rh.count++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å®Œæ•´åœ°è·å–å…±äº«é”æ–¹æ³•ï¼Œä½œä¸ºtryAcquireSharedæ–¹æ³•å› CASè·å–é”å¤±è´¥åçš„å¤„ç†ã€‚</span></span><br><span class="line">        <span class="comment">// å› ä¸ºå‰é¢å¯èƒ½å¤±è´¥ CAS å¤±è´¥ï¼Œ é˜Ÿåˆ—ç­–ç•¥å¤±è´¥ç­‰åŸå› ã€‚</span></span><br><span class="line">        <span class="keyword">return</span> fullTryAcquireShared(current);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å…ˆè·å– state ï¼Œé€šè¿‡ exclusiveCount æ–¹æ³•è·å–åˆ°å†™é”çš„è®¡æ•°å€¼ï¼Œä¸ä¸º 0 ä¸” ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œ è¯´æ˜å·²ç»æœ‰å†™é”ã€‚è¿”å› -1 å¤±è´¥ã€‚</li><li>é€šè¿‡ sharedCount è·å–è¯»é”è®¡æ•°ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦é˜»å¡ä»¥åŠæ˜¯å¦è¶…è¿‡ä¸Šé™åï¼Œä½¿ç”¨ CAS æ›´æ–° è¯»é”è®¡æ•°ã€‚</li><li>è®¾ç½®æˆ–æ›´æ–° firstReaderã€firstReaderHoldCountã€ cachedHoldCounterã€‚</li><li>æœ€åä¼šè¿›è¡Œå®Œæ•´çš„è·å–å…±äº«é”æ–¹æ³•ï¼Œä½œä¸ºä¹‹å‰è·å–å¤±è´¥çš„åç»­å¤„ç†æ–¹æ³•ã€‚</li></ol><p>firstReaderï¼šfirstReaderæ˜¯è·å¾—è¯»é”çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼›<br>firstReaderHoldCountï¼šfirstReaderHoldCountæ˜¯firstReaderçš„ä¿æŒè®¡æ•°ã€‚å³è·å¾—è¯»é”çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹çš„é‡å…¥æ¬¡æ•°ã€‚<br>cachedHoldCounterï¼šæœ€åä¸€ä¸ªè·å¾—è¯»é”çš„çº¿ç¨‹è·å¾—è¯»é”çš„é‡å…¥æ¬¡æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullTryAcquireShared</span><span class="params">(Thread current)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    HoldCounter rh = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// æ— é™å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="comment">// æ˜¯å¦æœ‰å†™é”</span></span><br><span class="line">        <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// æœ‰å†™é”ï¼Œä½†æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œç›´æ¥è¿”å›å¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (getExclusiveOwnerThread() != current)</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readerShouldBlock()) &#123;</span><br><span class="line">            <span class="comment">// éœ€è¦é˜»å¡</span></span><br><span class="line">            <span class="comment">// æ²¡æœ‰å†™é”ï¼Œç¡®ä¿æ²¡æœ‰é‡æ–°è·å–è¯»é”</span></span><br><span class="line">            <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                <span class="comment">// assert firstReaderHoldCount &gt; 0;</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å½“å‰çº¿ç¨‹çš„è¯»é”è®¡æ•° ThreadLocal ä¸­</span></span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    rh = cachedHoldCounter;</span><br><span class="line">                    <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current)) &#123;</span><br><span class="line">                        rh = readHolds.get();</span><br><span class="line">                        <span class="comment">// è®¡æ•°ç»“æŸï¼Œremove æ‰</span></span><br><span class="line">                        <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                            readHolds.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ä¸º 0 ç›´æ¥å¤±è´¥</span></span><br><span class="line">                <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ°è¾¾ä¸Šé™ æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (sharedCount(c) == MAX_COUNT)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// CAS è®¾ç½®è¯»é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sharedCount(c) == <span class="number">0</span>) &#123;</span><br><span class="line">                firstReader = current;</span><br><span class="line">                firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                firstReaderHoldCount++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="keyword">null</span>)</span><br><span class="line">                    rh = cachedHoldCounter;</span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                    rh = readHolds.get();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                    readHolds.set(rh);</span><br><span class="line">                rh.count++;</span><br><span class="line">                cachedHoldCounter = rh; <span class="comment">// cache for release</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>é¦–å…ˆä¼šä¸€ç›´å¾ªç¯</li><li>æœ‰å†™é”ï¼Œä½†æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œç›´æ¥è¿”å›å¤±è´¥ã€‚<strong>ä½†æ˜¯ï¼Œæœ‰å†™é”ï¼Œå¦‚æœæ˜¯å½“å‰çº¿ç¨‹ï¼Œæ˜¯ä¼šç»§ç»­æ‰§è¡Œçš„ã€‚</strong></li><li>è®¾ç½®æˆ–æ›´æ–° firstReaderã€firstReaderHoldCountã€ cachedHoldCounterã€‚</li></ol><p>å½“å­˜åœ¨å†™é”ï¼ˆç‹¬å é”ï¼‰æ—¶ï¼Œæ–¹æ³•ä¼šè¿”å› -1 å¤±è´¥ï¼Œåç»­ä¼šè°ƒç”¨ AQS çš„ doAcquireShared æ–¹æ³•ï¼Œå¾ªç¯è·å–èµ„æºã€‚doAcquireShared æ–¹æ³•ä¼šä¸æ–­å¾ªç¯ï¼Œå°è¯•è·å–è¯»é”ï¼Œä¸€æ—¦è·å–åˆ°è¯»é”ï¼Œå½“å‰èŠ‚ç‚¹ä¼šç«‹å³å”¤é†’åç»­èŠ‚ç‚¹ï¼Œåç»­èŠ‚ç‚¹å¼€å§‹å°è¯•è·å–è¯»é”ï¼Œä¾æ¬¡ä¼ æ’­ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ReentrantReadWriteLock-1-rl0DjC.png" alt="ReentrantReadWriteLock-1-rl0DjC"></p><h4 id="ReadLock-unlock"><a href="#ReadLock-unlock" class="headerlink" title="ReadLock.unlock"></a>ReadLock.unlock</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadLock</span> </span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ AQS çš„ releaseShared é‡Šæ”¾å…±äº«èµ„æºæ–¹æ³•ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ReadLock-unlock-LE7vUH.png" alt="ReadLock-unlock-LE7vUH"></p><p>å…¶ä¸­ tryReleaseShared æœ‰ ReadLock å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€ä¸ªçº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (firstReaderHoldCount == <span class="number">1</span>)</span><br><span class="line">            firstReader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            firstReaderHoldCount--;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€ä¸ªçº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œæ›´æ–°è‡ªå·±çš„ ThreadLocal é‡Œé¢çš„è®¡æ•°</span></span><br><span class="line">        HoldCounter rh = cachedHoldCounter;</span><br><span class="line">        <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">            rh = readHolds.get();</span><br><span class="line">        <span class="keyword">int</span> count = rh.count;</span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            readHolds.remove();</span><br><span class="line">            <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> unmatchedUnlockException();</span><br><span class="line">        &#125;</span><br><span class="line">        --rh.count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">int</span> nextc = c - SHARED_UNIT;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ CAS æ›´æ–° state</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="comment">// ä½†æ˜¯å¦‚æœç°åœ¨è¯»å’Œå†™é”éƒ½å·²é‡Šæ”¾ï¼Œ</span></span><br><span class="line">            <span class="comment">// å®ƒå¯èƒ½å…è®¸ç­‰å¾…çš„å†™ç¨‹åºç»§ç»­è¿›è¡Œã€‚</span></span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œç›´æ¥æ›´æ–°æŠ€æœ¯ï¼Œä¸æ˜¯åˆ™æ›´æ–°è‡ªå·± ThreadLocal é‡Œé¢ä¿å­˜çš„è®¡æ•°ã€‚</li><li>å¾ªç¯ï¼Œä½¿ç”¨ CAS æ›´æ–° state çš„å€¼ã€‚</li><li>å¦‚æœ state æ›´æ–°åçš„å€¼ä¸º 0ï¼Œè¯´æ˜æ²¡æœ‰çº¿ç¨‹æŒæœ‰è¯»é”æˆ–è€…å†™é”äº†ã€‚</li><li>å½“ state ä¸º 0ï¼Œæ­¤æ—¶ä¼šè°ƒç”¨ AQS çš„ doReleaseShared æ–¹æ³•ã€‚æ­¤æ—¶é˜Ÿåˆ—å¦‚æœæœ‰å†™é”ï¼Œé‚£å°±ä¼šè¢«å†™é”è·å–çš„é”ã€‚</li></ol><h4 id="WriteLock-lock"><a href="#WriteLock-lock" class="headerlink" title="WriteLock.lock"></a>WriteLock.lock</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WriteLock</span> </span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å†™å…¥é”ã€‚</span></span><br><span class="line"><span class="comment">     * å¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰è¯»é”æˆ–å†™é”ï¼Œä¼šç›´æ¥è¿”å›ï¼Œå¹¶å°†å†™é”è®¡æ•°è®¾ç½®ä¸º1ã€‚</span></span><br><span class="line"><span class="comment">     * å¦‚æœå½“å‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œåˆ™å°†å†™é”è®¡æ•° +1ï¼Œç„¶åè¿”å›ã€‚</span></span><br><span class="line"><span class="comment">     * å¦‚æœé”æ­£åœ¨è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œåˆ™å½“å‰çº¿ç¨‹ç”¨äºçº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œ</span></span><br><span class="line"><span class="comment">     * å½“å‰çº¿ç¨‹å°†è¢«ç¦ç”¨ï¼Œå¹¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°è·å–è¯»é”å¹¶å°†å†™é”è®¡æ•°è®¾ç½®ä¸º1ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/WriteLock.lock-wBuvUA.png" alt="WriteLock.lock-wBuvUA"></p><p>tryAcquire æ–¹æ³•ç”± Write è‡ªå·±å®ç°ï¼Œæ–¹å¼å’Œ ReentrantLock ç±»ä¼¼ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœè¯»é”è®¡æ•°ä¸ºéé›¶æˆ–å†™é”è®¡æ•°ä¸ºéé›¶ï¼Œå¹¶ä¸”æ‰€æœ‰è€…æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œåˆ™å¤±è´¥ã€‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœè®¡æ•°é¥±å’Œï¼Œåˆ™å¤±è´¥ã€‚åªæœ‰åœ¨countä¸ä¸ºé›¶æ—¶ï¼Œæ‰å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µã€‚</span></span><br><span class="line">    <span class="comment">// å¦åˆ™ï¼Œå¦‚æœè¯¥çº¿ç¨‹æ˜¯å¯é‡å…¥è·å–æˆ–é˜Ÿåˆ—ç­–ç•¥å…è®¸çš„è¯ï¼Œåˆ™æœ‰èµ„æ ¼è¿›è¡Œé”å®šã€‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯è¿™æ ·ï¼Œè¯·æ›´æ–°çŠ¶æ€å¹¶è®¾ç½®æ‰€æœ‰è€…ã€‚</span></span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">// å†™é”è®¡æ•°</span></span><br><span class="line">    <span class="keyword">int</span> w = exclusiveCount(c);</span><br><span class="line">    <span class="comment">// c ï¼= 0 è¯´æ˜æœ‰æœ‰çº¿ç¨‹è·å–é”äº†</span></span><br><span class="line">    <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// (Note: if c != 0 and w == 0 then shared count != 0)</span></span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå·±ï¼Œä¸æ˜¯è‡ªå·± è¿”å› false</span></span><br><span class="line">        <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æœ‰æ²¡æœ‰è¶…è¿‡ä¸Šé™</span></span><br><span class="line">        <span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// é‡å…¥</span></span><br><span class="line">        setState(c + acquires);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸éœ€è¦é˜»å¡ï¼Œæˆ–è€… CAS æ›´æ–° state å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (writerShouldBlock() || !compareAndSetState(c, c + acquires))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    setExclusiveOwnerThread(current);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è·å– state ï¼Œ å¦‚æœ state ä¸ä¸º 0 åˆ™åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹é‡å…¥è·å–ã€‚</li><li>state ä¸º 0 ï¼Œåˆ™å½“å‰çº¿ç¨‹ CAS æ›´æ–° stateï¼Œè·å–é”ã€‚</li><li>æ›´æ–°æˆåŠŸä¹‹åç»‘å®šå½“å‰çº¿ç¨‹ã€‚</li><li>å¦‚æœå¤±è´¥ä¼šç»§ç»­è°ƒç”¨ AQS çš„ acquireQueuedï¼Œå°†å½“å‰é˜»å¡æ”¾åœ¨ AQS é˜Ÿåˆ—ä¸­ã€‚AQS ä¼šä¸æ–­å¾ªç¯ï¼Œç­‰å¾…ä¸Šä¸€ä¸ªé”é‡Šæ”¾åï¼Œå°è¯•è·å¾—é”ã€‚</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ReentrantReadWriteLock-2-mQAgGL.png" alt="ReentrantReadWriteLock-2-mQAgGL"></p><h4 id="WriteLock-unlock"><a href="#WriteLock-unlock" class="headerlink" title="WriteLock.unlock"></a>WriteLock.unlock</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WriteLock</span> </span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹æ˜¯æ­¤é”çš„æŒæœ‰è€…ï¼Œåˆ™ä¿æŒè®¡æ•°é€’å‡ã€‚ </span></span><br><span class="line">    <span class="comment">// å¦‚æœä¿æŒç°åœ¨çš„è®¡æ•°ä¸ºé›¶ï¼Œåˆ™è§£é™¤é”å®šã€‚ </span></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æ­¤é”çš„æŒæœ‰è€…åˆ™IllegalMonitorStateExceptionå¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/Write-unlock-bwHAcw.png" alt="Write-unlock-bwHAcw"></p><p>åŒæ ·è¿™å—ä»£ç æ˜¯ä½¿ç”¨ AQS çš„é€»è¾‘ï¼ŒtryRelease éƒ¨åˆ†ç”± WriteLock è‡ªå·±å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="keyword">int</span> nextc = getState() - releases;</span><br><span class="line">    <span class="keyword">boolean</span> free = exclusiveCount(nextc) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (free)</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    setState(nextc);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å¦‚æœæ˜¯å½“å‰çº¿ç¨‹é‡å…¥ï¼Œæ‰£å‡é‡å…¥æ¬¡æ•°ã€‚</li><li>æ‰£å‡åå¦‚æœä¸º 0ï¼Œåˆ™è®¾ç½®é”æŒæœ‰çº¿ç¨‹ä¸º nullï¼Œæ›´æ–° state å€¼ã€‚AQS ä¼šå”¤é†’åç»­èŠ‚ç‚¹è·å–é”ã€‚</li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h4><p><strong>Qï¼š</strong>åœ¨ ReentrantReadWriteLock ä¸­ state ä»£è¡¨ä»€ä¹ˆï¼Ÿ</p><p><strong>Aï¼š</strong>state ä»£è¡¨é”çš„çŠ¶æ€ã€‚state ä¸º 0 ï¼Œæ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œstate çš„é«˜ 16 ä¸ºä»£è¡¨è¯»é”çŠ¶æ€ï¼Œä½ 16 ä¸ºä»£è¡¨å†™é”çŠ¶æ€ã€‚é€šè¿‡ä½è¿ç®—å¯ä»¥è·å–è¯»å†™é”çš„å®é™…å€¼ã€‚</p><p><strong>Qï¼š</strong>çº¿ç¨‹è·å–é”çš„æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</p><p><strong>Aï¼š</strong>å¯ä»¥å‚è€ƒä¸Šé¢çš„æºç ç¬”è®°ï¼Œä»¥åŠåé¢çš„æµç¨‹å›¾ã€‚</p><p><strong>Qï¼š</strong>è¯»é”å’Œå†™é”çš„å¯é‡å…¥æ€§æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</p><p><strong>Aï¼š</strong>åœ¨åŠ é”çš„æ—¶å€™ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™ç›´æ¥ç´¯åŠ è®¡æ•°ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šè¯»é”é‡å…¥è®¡æ•°ä½¿ç”¨çš„ ThreadLocal åœ¨çº¿ç¨‹ä¸­ç¼“å­˜è®¡æ•°ï¼Œè€Œå†™é”åˆ™ç›´æ¥ç”¨çš„ state è¿›è¡Œç´¯åŠ ï¼ˆå…¶å®å’Œ state ä½ 16 ä½è¿›è¡Œç´¯åŠ ä¸€æ ·ï¼‰ã€‚</p><p><strong>Qï¼š</strong>å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¢«é˜»å¡çš„åç»­æ“ä½œæ˜¯ä»€ä¹ˆï¼Ÿ</p><p><strong>Aï¼š</strong>è·å–å¤±è´¥ï¼Œä¼šæ”¾åˆ° AQS ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåœ¨é˜Ÿåˆ—ä¸­ä¸æ–­å¾ªç¯ï¼Œç›‘è§†å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸º head ï¼Œæ˜¯çš„è¯ï¼Œä¼šé‡æ–°å°è¯•è·å–é”ã€‚</p><p><strong>Qï¼š</strong>é”é™çº§æ˜¯æ€ä¹ˆé™çº§çš„ï¼Ÿ</p><p><strong>Aï¼š</strong> <img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/write-to-read-koAuqm.png" alt="write-to-read-koAuqm"><br>å¦‚å›¾ï¼Œåœ¨åœˆå‡ºéƒ¨åˆ† fullTryAcquireShared ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨è·å–è¯»é”çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œæ˜¯å¯ä»¥è·å–è¯»é”çš„ã€‚è¿™å—å°±æ˜¯æŒ‡é”é™çº§ï¼Œæ¯”å¦‚çº¿ç¨‹ A è·å–åˆ°äº†å†™é”ï¼Œå½“çº¿ç¨‹ A æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œå®ƒéœ€è¦è·å–å½“å‰æ•°æ®ï¼Œå‡è®¾ä¸æ”¯æŒé”é™çº§ï¼Œå°±ä¼šå¯¼è‡´ A é‡Šæ”¾å†™é”ï¼Œç„¶åå†æ¬¡è¯·æ±‚è¯»é”ã€‚è€Œåœ¨è¿™ä¸­é—´æ˜¯æœ‰å¯èƒ½è¢«å…¶ä»–é˜»å¡çš„çº¿ç¨‹è·å–åˆ°å†™é”çš„ã€‚ä»è€Œå¯¼è‡´çº¿ç¨‹ A åœ¨ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ•°æ®ä¸ä¸€è‡´ã€‚</p><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ol><li>ReentrantReadWriteLock è¯»å†™é”ï¼Œå†…éƒ¨å®ç°æ˜¯ ReadLock è¯»é” å’Œ WriteLock å†™é”ã€‚è¯»é”ï¼Œå…è®¸å…±äº«ï¼›å†™é”ï¼Œæ˜¯ç‹¬å é”ã€‚</li><li>è¯»å†™é”éƒ½æ”¯æŒé‡å…¥ï¼Œè¯»é”çš„é‡å…¥æ¬¡æ•°è®°å½•åœ¨çº¿ç¨‹ç»´æŠ¤çš„ ThreadLocal ä¸­ï¼Œå†™é”ç»´æŠ¤åœ¨ state ä¸Šï¼ˆä½ 16 ä½ï¼‰ã€‚</li><li>æ”¯æŒé”é™çº§ï¼Œä»å†™é”é™çº§ä¸ºè¯»é”ï¼Œé˜²æ­¢è„è¯»ã€‚</li><li>ReadLock å’Œ WriteLock éƒ½æ˜¯é€šè¿‡ AQS æ¥å®ç°çš„ã€‚è·å–é”å¤±è´¥åä¼šæ”¾åˆ° AQS ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåç»­ä¸æ–­å°è¯•è·å–é”ã€‚åŒºåˆ«åœ¨è¯»é”åªæœ‰å­˜åœ¨å†™é”çš„æ—¶å€™æ‰æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œå†™é”æ˜¯åªè¦å­˜åœ¨éå½“å‰çº¿ç¨‹é”ï¼ˆæ— è®ºå†™é”è¿˜æ˜¯è¯»é”ï¼‰éƒ½ä¼šæ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ã€‚<img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/read-write-different-gzNdCo.png" alt="read-write-different-gzNdCo"></li><li>é€šè¿‡æºç åˆ†æï¼Œå¯ä»¥å¾—å‡ºè¯»å†™é”é€‚åˆåœ¨<strong>è¯»å¤šå†™å°‘</strong>çš„åœºæ™¯ä¸­ä½¿ç”¨ã€‚</li></ol><h4 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h4><p>[1] Java Apiï¼š<a href="https://docs.oracle.com/javase/8/docs/api/overview-summary.html">https://docs.oracle.com/javase/8/docs/api/overview-summary.html</a></p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- ä¸èƒ½å†è¢«é—®ä½äº†ï¼ReentrantLock æºç ã€ç”»å›¾ä¸€èµ·çœ‹ä¸€çœ‹ï¼</title>
      <link href="2020/07/25/source-code-reentrant-lock.html"/>
      <url>2020/07/25/source-code-reentrant-lock.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>åœ¨é˜…è¯»å®Œ JUC åŒ…ä¸‹çš„ AQS æºç ä¹‹åï¼Œå…¶ä¸­æœ‰å¾ˆå¤šç–‘é—®ï¼Œæœ€å¤§çš„ç–‘é—®å°±æ˜¯ state ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå«ä¹‰ï¼Ÿå¹¶ä¸” AQS ä¸»è¦å®šä¹‰äº†é˜Ÿåˆ—çš„å‡ºå…¥ï¼Œä½†æ˜¯è·å–èµ„æºã€é‡Šæ”¾èµ„æºéƒ½æ˜¯äº¤ç»™å­ç±»å®ç°çš„ï¼Œé‚£å­ç±»æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä¸‹é¢å¼€å§‹äº†è§£ ReentrantLockã€‚ </p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>ä¸€ä¸ªå¯é‡å…¥çš„äº’æ–¥é”ä¸éšå¼ç›‘è§†å™¨é”synchronizedå…·æœ‰ç›¸åŒçš„åŸºæœ¬è¡Œä¸ºå’Œè¯­ä¹‰ï¼Œä½†åŠŸèƒ½æ›´å¼ºå¤§ã€‚</p><p>å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p><ol><li>äº’æ–¥æ€§ï¼šåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–åˆ°è¯¥é”ï¼Œæ­¤æ—¶å…¶ä»–çº¿ç¨‹è¯·æ±‚è·å–é”ï¼Œä¼šè¢«é˜»å¡ï¼Œç„¶åè¢«æ”¾åˆ°è¯¥é”å†…éƒ¨ç»´æŠ¤çš„ä¸€ä¸ª AQS é˜»å¡é˜Ÿåˆ—ä¸­ã€‚</li><li>å¯é‡å…¥æ€§ï¼šç»´æŠ¤ state å˜é‡ï¼Œåˆå§‹ä¸º 0ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”æ—¶ï¼Œstate ä½¿ç”¨ cas æ›´æ–°ä¸º 1ï¼Œæœ¬çº¿ç¨‹å†æ¬¡ç”³è¯·è·å–é”ï¼Œä¼šå¯¹ state è¿›è¡Œ CAS é€’å¢ï¼Œé‡å¤è·å–æ¬¡æ•°å³ stateï¼Œæœ€å¤šä¸º 2147483647 ã€‚è¯•å›¾è¶…å‡ºæ­¤é™åˆ¶ä¼šä»é”å®šæ–¹æ³•æŠ›å‡º Errorã€‚</li><li>å…¬å¹³/éå…¬å¹³æ€§ï¼šåœ¨åˆå§‹åŒ–æ—¶ï¼Œå¯ä»¥é€šè¿‡æ„é€ å™¨ä¼ å‚ï¼ŒæŒ‡å®šæ˜¯å¦ä¸ºå…¬å¹³é”ï¼Œè¿˜æ˜¯éå…¬å¹³é”ã€‚å½“è®¾ç½®ä¸º true æ—¶ï¼Œä¸ºå…¬å¹³é”ï¼Œçº¿ç¨‹äº‰ç”¨é”æ—¶ï¼Œä¼šå€¾å‘äºç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ã€‚</li></ol><h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.lock();  <span class="comment">// block until condition holds</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ... method body</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock()</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜ç–‘é—®ï¼Ÿ"><a href="#é—®é¢˜ç–‘é—®ï¼Ÿ" class="headerlink" title="é—®é¢˜ç–‘é—®ï¼Ÿ"></a>é—®é¢˜ç–‘é—®ï¼Ÿ</h4><p>é¦–å…ˆåœ¨é˜…è¯»æœ¬æ–‡æ—¶ï¼Œå¯¹ AQS æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œå¦‚æœä¸äº†è§£çš„è¯ï¼Œå¯ä»¥çœ‹ä»¥ä¸‹ä¹‹å‰çš„æ–‡ç« ã€‚<a href="">å›¾æ–‡è®²è§£ AQS</a></p><ol><li>åœ¨ AQS ä¸­ä»‹ç» state æ—¶ï¼Œè¯´ state å«ä¹‰ç”±å­ç±»è¿›è¡Œå®šä¹‰ï¼Œé‚£åœ¨ ReentrantLock ä¸­ state ä»£è¡¨ä»€ä¹ˆï¼Ÿ</li><li>ReentrantLock å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</li><li>çº¿ç¨‹æ˜¯å¦‚ä½•è·å–åˆ°é”çš„ï¼Ÿ</li><li>é”çš„å¯é‡å…¥æ€§æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</li><li>å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¢«é˜»å¡çš„åç»­æ“ä½œæ˜¯ä»€ä¹ˆï¼Ÿ</li><li>å…¬å¹³é”å’Œéå…¬å¹³é”æ˜¯å¦‚ä½•ä½“ç°çš„ï¼Ÿ</li><li>é”æ˜¯å¦‚ä½•é‡Šæ”¾çš„ï¼Ÿ</li></ol><p>å°†é€šè¿‡æºç åŠç”»å›¾çš„æ–¹å¼ï¼Œå›´ç»•ä¸Šé¢å‡ ä¸ªé—®é¢˜ï¼Œå±•å¼€é˜…è¯»å’Œåˆ†æã€‚</p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ReentrantLock-uml-DDnlDW.png" alt="ReentrantLock-uml-DDnlDW"></p><p>åŸºæœ¬ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼ŒReentrantLock ç±»å®ç°äº†æ¥å£ Lockï¼Œåœ¨æ¥å£ Lock ä¸­å®šä¹‰äº†ä½¿ç”¨é”æ—¶çš„æ–¹æ³•ï¼Œæ–¹æ³•åŠå«ä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–é”ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œä¼šé˜»å¡ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–é”ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œä¼šé˜»å¡ã€‚å“åº”ä¸­æ–­ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•è·å–é”ï¼Œå¦‚æœè·å–åˆ°ï¼Œè¿”å› trueï¼Œæ²¡æœ‰è·å–åˆ° è¿”å› false</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•è·å–é”ï¼Œæ²¡æœ‰æœ‰è·å–åˆ°ï¼Œä¼šç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œå“åº”ä¸­æ–­ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ ReentrantLock ä¹Ÿåªæ˜¯å®ç°äº† Lock æ¥å£ï¼Œå¹¶å®ç°äº†è¿™äº›æ–¹æ³•ï¼Œé‚£ ReentrantLock å’Œ AQS åˆ°åº•æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿè¿™å°±éœ€è¦çœ‹å†…éƒ¨å…·ä½“å¦‚ä½•å®ç°çš„äº†ã€‚</p><p>é€šè¿‡ä¸Šé¢ç±»å›¾å¯ä»¥çœ‹å‡ºï¼Œåœ¨ ReentrantLock ä¸­å«æœ‰ä¸¤ä¸ªå†…éƒ¨ç±»ï¼Œåˆ†åˆ«æ˜¯ NonfairSync FairSync è€Œå®ƒä¿©åˆå®ç°äº† æŠ½è±¡ç±» Syncï¼ŒæŠ½è±¡ç±» Sync ç»§æ‰¿äº† AbstractQueuedSynchronizer å³ AQSã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLock</span> <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”çš„åŒæ­¥æ§åˆ¶åŸºç¡€ç±»ã€‚ å­ç±»å…·ä½“åˆ°å…¬å¹³å’Œéå…¬å¹³çš„ç‰ˆæœ¬ã€‚ ä½¿ç”¨AQSçŠ¶æ€æ¥è¡¨ç¤ºæŒæœ‰è¯¥é”çš„æ•°é‡ã€‚</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123; </span><br><span class="line">        <span class="comment">// çœç•¥ ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123; </span><br><span class="line">        <span class="comment">// éå…¬å¹³é”é€»è¾‘ çœç•¥ ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123; </span><br><span class="line">        <span class="comment">// å…¬å¹³é”é€»è¾‘ çœç•¥ ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é»˜è®¤éå…¬å¹³é”</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync = <span class="keyword">new</span> NonfairSync();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ¹æ®ä¼ å‚æŒ‡å®šå…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ï¼Œtrue å…¬å¹³é”ï¼Œfalse éå…¬å¹³é”</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">        sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼š</p><ol><li>é”çš„åŸºæœ¬æ§åˆ¶æ˜¯ç”± NonfairSync å’Œ FairSync è¿›è¡Œæ§åˆ¶çš„ï¼Œè€Œå®ƒä¿©çš„çˆ¶ç±» Sync ç»§æ‰¿äº† AQS (AbstractQueuedSynchronizer)ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´æ˜ ReentrantLock çš„å®ç°å’Œ AQS æ˜¯æœ‰å…³çš„ã€‚</li><li>NonfairSync ä»£è¡¨éå…¬å¹³é”å®ç°é€»è¾‘ï¼ŒFairSync ä»£è¡¨å…¬å¹³é”å®ç°é€»è¾‘ã€‚</li><li>æ„é€ å™¨ä¼ å‚å¯ä»¥çœ‹å‡ºï¼Œåˆå§‹åŒ–æ—¶ï¼Œé»˜è®¤ä¸º NonfairSync éå…¬å¹³é”ã€‚ä¹Ÿå¯ä»¥æŒ‡å®šå£°æ˜ä¸ºå…¬å¹³é”æˆ–éå…¬å¹³é”ï¼Œä¼ å‚ true ä¸º å…¬å¹³é”ï¼Œfalse ä¸ºéå…¬å¹³é”ã€‚</li></ol><p>å…·ä½“ ReentrantLock å’Œ AQS çš„å…³ç³»æ˜¯æ€æ ·çš„ï¼Œå°±éœ€è¦é€šè¿‡åŠ é”çš„è¿‡ç¨‹æ¥åˆ†æäº†ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/878c841a671f102ddc2cdeae35faa4cc-pKLxAS.gif" alt="878c841a671f102ddc2cdeae35faa4cc-pKLxAS"></p><h4 id="lock"><a href="#lock" class="headerlink" title="lock"></a>lock</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ReentrantLock-lock-4apftk.png" alt="ReentrantLock-lock-4apftk"></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œé»˜è®¤å£°æ˜éå…¬å¹³é”ï¼Œlock æ–¹æ³•å†…éƒ¨è°ƒç”¨ <code>sync.lock();</code> æ­¤æ—¶åº”è¯¥æ˜¯ä½¿ç”¨çš„éå…¬å¹³é”å†…éƒ¨çš„ lock åŠ é”æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡ CAS è®¾ç½® state å€¼ 0 -&gt; 1</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        <span class="comment">// è®¾ç½®æˆåŠŸå½“å‰çº¿ç¨‹è·å–åˆ°äº†é”</span></span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// è®¾ç½®å¤±è´¥ï¼Œåˆ™è°ƒç”¨ AQS çš„æ–¹æ³•ï¼Œå°è¯•è·å–é”ã€‚</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>é¦–å…ˆä¼š ä½¿ç”¨ CAS æ›´æ–° state çš„å€¼ï¼Œ æ­¤æ—¶å°±ä¼šå‘ç°ï¼Œ state åœ¨è¿™é‡Œä»£è¡¨çš„é”çš„çŠ¶æ€ã€‚ 0 æœªåŠ é”ï¼Œ1 åŠ é”ã€‚</li><li>è®¾ç½®å¤±è´¥ï¼Œä¼šè°ƒç”¨ AQS çš„ acquire(1); æ–¹æ³•ã€‚</li></ol><p>å†çœ‹ä¸‹ AQS çš„ acquire ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// tryAcquire å°è¯•è·å– stateï¼Œè·å–å¤±è´¥åˆ™ä¼šåŠ å…¥åˆ°é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¹‹å‰åˆ†æ AQS æºç æ—¶ï¼Œå·²ç»ä»‹ç» tryAcquire æ˜¯å°è¯•è·å– state çš„å€¼ï¼ŒAQS ä¸­å¹¶ä¸æä¾›å¯ç”¨çš„æ–¹æ³•ï¼Œæ­¤å¤„æ˜¯ç”±å­ç±»å®ç°çš„ã€‚æ‰€ä»¥è¿™å—ä»£ç è¿˜æ˜¯åœ¨ NonfairSync ç±»ä¸­è‡ªå·±å®ç°çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="comment">// NonfairSync å®ç°</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// NonfairSync çš„çˆ¶ç±» Sync ä¸­æœ‰å®ç°</span></span><br><span class="line">    <span class="comment">// state ä¼ å‚æ˜¯ 1</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">        <span class="comment">// è·å– state</span></span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="comment">// å¦‚æœ c æ˜¯ 0 </span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ cas æ›´æ–°ä¸º 1</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                <span class="comment">// è®¾ç½®æŒæœ‰çº¿ç¨‹ä¸ºå½“å‰</span></span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰</span></span><br><span class="line">            <span class="comment">// å¯¹ state è¿›è¡Œç´¯åŠ </span></span><br><span class="line">            <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">            <span class="comment">// ä¸å…è®¸è¶…è¿‡ int çš„æœ€å¤§å€¼ 2147483647 + 1 = -2147483648</span></span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            <span class="comment">// è®¾ç½® state çš„å€¼</span></span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å½“å‰çº¿ç¨‹åŠ é”ï¼Œç›´æ¥ä½¿ç”¨ CAS æ–¹å¼å¯¹ state ä» 0 æ›´æ–°ä¸º 1ï¼Œæ›´æ–°æˆåŠŸï¼Œåˆ™è·å¾—é”ï¼Œæ›´æ–°å¤±è´¥ï¼Œåˆ™è·å–å¤±è´¥ã€‚</li><li>æ›´æ–°å¤±è´¥åä¼šè°ƒç”¨ AQS çš„ <code>acquire(1);</code> æ–¹æ³•ï¼Œ æ­¤å¤„ä¼ å‚ä¸º 1ã€‚</li><li>tryAcquire å†æ¬¡å°è¯•è·å–é”ã€‚<ol><li>state æ˜¯ 0ï¼Œå°è¯•è·å–ã€‚è·å–æˆåŠŸè¿”å› trueï¼›</li><li>state ä¸æ˜¯ 0ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹æŒæœ‰ï¼Œæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰åˆ™å¯¹ state è¿›è¡Œç´¯åŠ ã€‚</li></ol></li><li>tryAcquire è·å–é”å¤±è´¥ï¼Œåˆ™èµ° AQS çš„ acquireQueued é€»è¾‘ï¼Œåˆ›å»ºèŠ‚ç‚¹ï¼Œå¹¶åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚</li></ol><p>æµç¨‹ç”»å›¾å¦‚ä¸‹ï¼š</p><ul><li>åˆå§‹ä¸ºå•ä¸ªçº¿ç¨‹</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ReentrantLock-1-1ozuSU.png" alt="ReentrantLock-1-1ozuSU"></p><ul><li>æ­¤æ—¶å…¶ä»–çº¿ç¨‹æ¥è¯·æ±‚è·å–é”</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ReentrantLock-2-zO9REa.png" alt="ReentrantLock-2-zO9REa"></p><ul><li>åŠ é”æµç¨‹å›¾</li></ul><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ReentrantLock-nonfair-LcRGc7.png" alt="ReentrantLock-nonfair-LcRGc7"></p><h4 id="å†æ¥çœ‹ä¸‹å…¬å¹³é”æ˜¯å¦‚ä½•ä½“ç°çš„ï¼Ÿ"><a href="#å†æ¥çœ‹ä¸‹å…¬å¹³é”æ˜¯å¦‚ä½•ä½“ç°çš„ï¼Ÿ" class="headerlink" title="å†æ¥çœ‹ä¸‹å…¬å¹³é”æ˜¯å¦‚ä½•ä½“ç°çš„ï¼Ÿ"></a>å†æ¥çœ‹ä¸‹å…¬å¹³é”æ˜¯å¦‚ä½•ä½“ç°çš„ï¼Ÿ</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3000897897090466540L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æœ‰æ— èŠ‚ç‚¹æ’é˜Ÿ</span></span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‹‰å‡ºæ¥ä»£ç æ¯”è¾ƒä¸€ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/compare-UFOHD0.png" alt="compare-UFOHD0"></p><p>å¯ä»¥çœ‹å‡ºåœ¨å…¬å¹³é”ï¼ˆFairSyncï¼‰ä¸­å¤šäº†ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶</p><p><strong><code>!hasQueuedPredecessors()</code></strong></p><p>hasQueuedPredecessors æ–¹æ³•åœ¨ AQS ä¸­ï¼Œå¦‚æœæœ‰å½“å‰çº¿ç¨‹å‰é¢çš„çº¿ç¨‹æ’é˜Ÿè¿”å›trueï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ˜¯åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨æˆ–é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›falseã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedPredecessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Node t = tail; </span><br><span class="line">    Node h = head;</span><br><span class="line">    Node s;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp; ((s = h.next) == <span class="keyword">null</span> || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå½“å‰åŠ é”æ—¶å·²ç»æœ‰èŠ‚ç‚¹åœ¨æ’é˜Ÿï¼Œé‚£å°±å»èŠ‚ç‚¹å°¾éƒ¨æ’é˜Ÿï¼Œå¦åˆ™æ‰ä¼šå»æŠ¢å é”ã€‚</p><p>åˆ°è¿™é‡ŒåŸºæœ¬ä¸Šå·²ç»çŸ¥é“å…¬å¹³é”å’Œéå…¬å¹³é”çš„åŒºåˆ«äº†ï¼š</p><p>éå…¬å¹³é”ï¼šä¸ç®¡æœ‰æ²¡æœ‰èŠ‚ç‚¹åœ¨æ’é˜Ÿï¼Œéƒ½ä¼šè¯•å›¾å»è·å–é”ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œè¿›å…¥ acquire æ–¹æ³•ï¼Œè¿˜æ˜¯ä¼šè¯•å›¾è·å–ä¸€æ¬¡ï¼Œä¹‹åæ‰ä¼šè¿›å…¥é˜Ÿåˆ—ä¸­ã€‚<br>å…¬å¹³é”ï¼šå·²ç»æœ‰èŠ‚ç‚¹åœ¨æ’é˜Ÿï¼Œé‚£å°±è‡ªå·±å»èŠ‚ç‚¹åé¢æ’é˜Ÿã€‚</p><h4 id="tryLock"><a href="#tryLock" class="headerlink" title="tryLock"></a>tryLock</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sync.nonfairTryAcquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨çš„ Sync ä¸­çš„ nonfairTryAcquireï¼Œ å°è¯•è·å–é”ï¼Œè·å–å¤±è´¥ï¼Œå°±è¿”å› falseï¼Œè·å–åˆ°é”æˆ–è€…æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰é”åˆ™å¯¹ state ç´¯åŠ åéƒ½è¿”å› trueã€‚</p><h4 id="unlock"><a href="#unlock" class="headerlink" title="unlock"></a>unlock</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç° unlock ç›´æ¥è°ƒç”¨çš„ AQS çš„ release æ–¹æ³•ï¼Œè¿›è¡Œé‡Šæ”¾èµ„æºã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å—åœ¨ AQS ä¸­æœ‰ä»‹ç»ï¼Œä¹Ÿè¯´æ˜ tryRelease ç”±å­ç±»è¿›è¡Œå®ç°ï¼Œç°åœ¨åœ¨ ReentrantLock é‡ç‚¹å…³æ³¨ tryRelease çš„å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é‡Šæ”¾èµ„æºï¼Œä¼ å…¥å€¼ä¸º 1</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="keyword">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è·å–å½“å‰çš„ state è¿›è¡Œ -1 æ“ä½œï¼›</li><li>åˆ¤æ–­äº†ä¸‹å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºæŒæœ‰çº¿ç¨‹ï¼›</li><li>å¦‚æœé‡Šæ”¾å®Œä¹‹å state ä¸º 0 ï¼Œåˆ™è®¾ç½®æŒæœ‰çº¿ç¨‹ä¸º nullï¼›</li><li>æ›´æ–°å¹¶è¿”å› state çš„å€¼ã€‚</li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é€šè¿‡ä¸Šé¢çš„æºç åŠç”»å›¾ï¼ŒåŸºæœ¬ä¸Šå¯¹å¼€å§‹çš„é—®é¢˜å·²ç»æœ‰äº†ç­”æ¡ˆï¼š</p><p><strong>Q</strong>ï¼šåœ¨ AQS ä¸­ä»‹ç» state æ—¶ï¼Œè¯´ state å«ä¹‰ç”±å­ç±»è¿›è¡Œå®šä¹‰ï¼Œé‚£åœ¨ ReentrantLock ä¸­ state ä»£è¡¨ä»€ä¹ˆï¼Ÿ<br><strong>A</strong>ï¼šåœ¨ ReentrantLock ä¸­ state ä»£è¡¨åŠ é”çŠ¶æ€ï¼Œ0 æ²¡æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äºç­‰äº 1 å·²ç»æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äº 1 è¯´æ˜è¯¥è·å¾—é”çš„çº¿ç¨‹å¤šæ¬¡é‡å…¥ã€‚</p><p><strong>Q</strong>ï¼šReentrantLock å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ<br><strong>A</strong>ï¼šReentrantLock å†…éƒ¨åŸºäº AQS å®ç°ï¼Œæ— è®ºæ˜¯é”çŠ¶æ€ï¼Œè¿˜æ˜¯è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œé”é‡Šæ”¾ç­‰éƒ½æ˜¯åŸºäº AQS å®ç°ã€‚ReentrantLock çš„å…¬å¹³é”å’Œéå…¬å¹³é”éƒ½æ˜¯ NonfairSyncã€FairSync æ¥å®ç°çš„ï¼Œè€Œä»–ä»¬çš„çˆ¶ç±» Sync ç»§æ‰¿äº† AQSã€‚</p><p><strong>Q</strong>ï¼šçº¿ç¨‹æ˜¯å¦‚ä½•è·å–åˆ°é”çš„ï¼Ÿ<br><strong>A</strong>ï¼šçº¿ç¨‹é€šè¿‡ä¿®æ”¹ state å­—æ®µçš„çŠ¶æ€æ¥è·å–åˆ°é”ã€‚</p><p><strong>Q</strong>ï¼šé”çš„å¯é‡å…¥æ€§æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ<br><strong>A</strong>ï¼šå½“å‰çº¿ç¨‹å‘ç° state ä¸æ˜¯ 0 ï¼Œåˆ™è¯´æ˜æœ‰é”å·²ç»è¢«è·å–äº†ï¼Œæ­¤æ—¶ä¼šåˆ¤æ–­å½“å‰è·å–åˆ°é”çš„çº¿ç¨‹æ˜¯ä¸æ˜¯è‡ªå·±ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¯¹ state è¿›è¡Œç´¯åŠ ã€‚</p><p><strong>Q</strong>ï¼šå½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¢«é˜»å¡çš„åç»­æ“ä½œæ˜¯ä»€ä¹ˆï¼Ÿ<br><strong>A</strong>ï¼šè·å–å¤±è´¥ï¼Œä¼šæ”¾åˆ° AQS ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåœ¨é˜Ÿåˆ—ä¸­ä¸æ–­å¾ªç¯ï¼Œç›‘è§†å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸º head ï¼Œæ˜¯çš„è¯ï¼Œä¼šé‡æ–°å°è¯•è·å–é”ã€‚</p><p><strong>Q</strong>ï¼šå…¬å¹³é”å’Œéå…¬å¹³é”æ˜¯å¦‚ä½•ä½“ç°çš„ï¼Ÿ<br><strong>A</strong>ï¼šå…¬å¹³é”ä¸»è¦ä½“ç°åœ¨å¦‚æœå½“å‰é˜Ÿåˆ—ä¸­å·²ç»æœ‰æ’é˜Ÿçš„çº¿ç¨‹äº†ï¼Œåˆ™è‡ªå·±ç›´æ¥æ’åœ¨åé¢ã€‚éå…¬å¹³é”æ˜¯ä¸ç®¡å½“å‰é˜Ÿåˆ—éƒ½æ²¡æœ‰çº¿ç¨‹æ’é˜Ÿï¼Œéƒ½ä¼šç›´æ¥å°è¯•ä¿®æ”¹ state è·å–é”ã€‚</p><p><strong>Q</strong>ï¼šé”æ˜¯å¦‚ä½•é‡Šæ”¾çš„ï¼Ÿ<br><strong>A</strong>ï¼šé”é‡Šæ”¾èµ„æºï¼Œå³å°† state è¿›è¡Œ -1 æ“ä½œï¼Œå¦‚æœ -1 å state ä¸º 0ï¼Œåˆ™é‡Šæ”¾èŠ‚ç‚¹ï¼Œåç»­èŠ‚ç‚¹å°è¯•è·å–é”ã€‚æ­¤å¤„å¯ä»¥çœ‹ AQS ç›¸å…³é€»è¾‘ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å·¥ä½œç¬”è®°ã€‘- è€å¤§è¯´æ–°é¡¹ç›®çš„ç»“æ„å’Œ xxx é¡¹ç›®ä¸€æ ·å°±å¯ä»¥äº†ï¼Œæˆ‘ â€¦â€¦</title>
      <link href="2020/07/18/work-archetype.html"/>
      <url>2020/07/18/work-archetype.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>åˆè¦å¼€å‘æ–°é¡¹ç›®äº†ï¼Œè¿˜æ˜¯åˆ›å»ºæ–°é¡¹ç›®ï¼Œæ€ä¹ˆåŠï¼Ÿè€å¤§è¯´æŒ‰ç…§ xxx é¡¹ç›®çš„ç»“æ„åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®å°±å¯ä»¥äº†ã€‚</p></blockquote><p>åœ¨å·¥ä½œä¸­ç»å¸¸æœ‰æ–°é¡¹ç›®éœ€è¦åˆ›å»ºï¼Œæ­¤æ—¶å°±ä¼šæœ‰ä¸‰ç§å¸¸ç”¨çš„æ–¹å¼</p><p><strong>CC å¤§æ³•</strong> æ–°å»ºé¡¹ç›®ï¼Œç„¶åæ‰¾åˆ°ä¹‹å‰çš„å„ç§å·¥å…·ç±»ï¼Œå¤åˆ¶ç²˜è´´è¿›æ¥ï¼Œæ­¤æ—¶è¿˜ä¸ä¸€å®šèƒ½è·‘èµ·æ¥ï¼Œç„¶åå†è¿›è¡Œå„ç§è°ƒè¯•ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-cc-45VBU1.png" alt="archetype-cc-45VBU1"></p><p><strong>CD å¤§æ³•</strong> å¤åˆ¶è€é¡¹ç›®ï¼Œç„¶åæ”¹ module åå­—ï¼Œä¾èµ–åå­—ï¼Œåˆ é™¤è€ä»£ç ï¼Œå½“ç„¶ä¹Ÿä¸ä¸€å®šèƒ½è·‘èµ·æ¥ï¼Œæ­¤æ—¶å†è¿›è¡Œå„ç§è°ƒè¯•ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-cc1-SPx1ct.png" alt="archetype-cc1-SPx1ct"></p><p>å½“ç„¶ï¼Œè¿™é‡Œè‚¯å®šä¸æ˜¯ä½¿ç”¨è¿™ä¸¤ç§åŠæ³•ï¼Œä¸‹é¢å’±ä»¬ä»‹ç»ä¸€ç§æ›´ç®€æ´çš„æ–¹å¼ï¼Œä½¿ç”¨ maven archetype ç”Ÿæˆé¡¹ç›®æ¨¡ç‰ˆï¼Œä¸€é”®åˆ›å»ºé¡¹ç›®ã€‚</p><p>Actionï¼ï¼ï¼</p><h3 id="ä»€ä¹ˆæ˜¯-Archetype-ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-Archetype-ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ Archetype ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ Archetype ï¼Ÿ</h3><p>ç®€è€Œè¨€ä¹‹ï¼ŒArchetype æ˜¯ Maven é¡¹ç›®æ¨¡æ¿å·¥å…·ç®±ã€‚</p><p><em>An archetype is defined as an original pattern or model from which all other things of the same kind are made.</em> </p><p>åŸå‹è¢«å®šä¹‰ä¸ºåŸå§‹æ ·å¼æˆ–æ¨¡å‹ï¼Œä»ä¸­å¯ä»¥åˆ¶æˆæ‰€æœ‰å…¶ä»–åŒç±»é¡¹ç›®ã€‚</p><p>å®˜æ–¹è§£é‡Šï¼Œç®€æ´æ˜äº†ï¼Œå°±æ˜¯ä½¿ç”¨å·²æœ‰çš„é¡¹ç›®ï¼Œç”Ÿæˆä¸€ä¸ªæ¨¡ç‰ˆã€‚ä»¥åä½¿ç”¨è¿™ä¸ªæ¨¡ç‰ˆå°±å¯ä»¥å¿«é€Ÿç”Ÿæˆç»“æ„ç›¸åŒçš„é¡¹ç›®äº†ã€‚åœ¨å›¢é˜Ÿå¼€å‘ä¸­å¾ˆæœ‰ç”¨ã€‚</p><p>å…¶å®å°±æ˜¯å®˜æ–¹è§£é‡Šï¼Œåœ°å€è´´ä¸Šæ¥ï¼š<a href="http://maven.apache.org/archetype/maven-archetype-plugin/index.html">http://maven.apache.org/archetype/maven-archetype-plugin/index.html</a></p><p>ä¸‹é¢ä½¿ç”¨ IDEA ä½œä¸ºæ¼”ç¤ºå·¥å…·ï¼Œä¸€æ­¥ä¸€æ­¥å¼€å§‹ä»‹ç»ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/8e83e6d78b16698fb19762806acadd1c-ZXYM5I.jpg" alt="8e83e6d78b16698fb19762806acadd1c-ZXYM5I"></p><h3 id="å‡†å¤‡æ¨¡ç‰ˆé¡¹ç›®"><a href="#å‡†å¤‡æ¨¡ç‰ˆé¡¹ç›®" class="headerlink" title="å‡†å¤‡æ¨¡ç‰ˆé¡¹ç›®"></a>å‡†å¤‡æ¨¡ç‰ˆé¡¹ç›®</h3><p>è¿™é‡Œè¿˜æ˜¯è¦æœ‰ä¸€ä¸ªæ¨¡ç‰ˆé¡¹ç›®ï¼Œæ¯”å¦‚è¿™æ ·ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype1-lZkrqX.png" alt="archetype1-lZkrqX"></p><p>è¿™æ˜¯ä¸€ä¸ªå¤š module é¡¹ç›®ï¼Œä¸€ä¸ªç®€å•çš„ demo</p><ol><li>ä½¿ç”¨äº† nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼›</li><li>fegin ä½œä¸ºè°ƒç”¨å·¥å…·ï¼›</li><li>æœ‰é€šç”¨æ ¡éªŒ token å·¥å…·ç±»ï¼›</li><li>å‡è®¾é‡Œé¢ä¹Ÿæœ‰ä¸€äº›å…¬å¸çš„å…¬å…±é…ç½®ï¼ˆMQï¼Œé“¾è·¯ç›‘æ§ï¼Œç»Ÿä¸€æ—¥å¿—ç­‰ï¼‰ã€‚</li></ol><p>å½“ç„¶è¿™ä¸ªé¡¹ç›®æ˜¯å¯ä»¥è·‘èµ·æ¥çš„ã€‚æ–°åˆ›å»ºçš„é¡¹ç›®ä¹Ÿæ˜¯è¿™ä¸ªæ¨¡ç‰ˆã€‚</p><h3 id="è¿›å…¥ä¸»é¢˜"><a href="#è¿›å…¥ä¸»é¢˜" class="headerlink" title="è¿›å…¥ä¸»é¢˜"></a>è¿›å…¥ä¸»é¢˜</h3><h4 id="ä½¿ç”¨å‘½ä»¤"><a href="#ä½¿ç”¨å‘½ä»¤" class="headerlink" title="ä½¿ç”¨å‘½ä»¤"></a>ä½¿ç”¨å‘½ä»¤</h4><p>**archetype:generate **</p><p>è¿™æ ·æ˜¯åŸºäºå½“å‰é¡¹ç›®ç”Ÿæˆï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å®˜ç½‘çš„ç”¨æ³•åˆ†åˆ«æŒ‡å®šå‚æ•°</p><ol><li><strong>mvn archetype:generate</strong> ç„¶åä¸€æ­¥ä¸€æ­¥æŒ‰ç…§æç¤ºè¾“å…¥ï¼›</li><li>ä¸€æ¬¡æ€§è¾“å…¥ï¼Œå…¶ä¸­ <code>DarchetypeGroupId</code> <code>ã€DarchetypeArtifactId</code> <code>ã€DarchetypeVersion</code> ä¸ºç”Ÿæˆçš„ Archetype é¡¹ç›®çš„ç»„ç»‡ç‰ˆæœ¬ã€‚</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn archetype:generate                                  \</span><br><span class="line">  -DarchetypeGroupId=&lt;archetype-groupId&gt;                \</span><br><span class="line">  -DarchetypeArtifactId=&lt;archetype-artifactId&gt;          \</span><br><span class="line">  -DarchetypeVersion=&lt;archetype-version&gt;                \</span><br><span class="line">  -DgroupId=&lt;my.groupid&gt;                                \</span><br><span class="line">  -DartifactId=&lt;my-artifactId&gt;</span><br></pre></td></tr></table></figure><p>é«˜çº§ç”¨æ³• <strong>mvn clean archetype:create-from-project</strong></p><p>æ‰§è¡Œå›¾ç¤ºå¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-iterm-GONbvt.png" alt="archetype-iterm-GONbvt"></p><p>æ‰§è¡Œåè¿”å› IDEA æŸ¥çœ‹é¡¹ç›®ï¼Œåœ¨ <code>target/generated-sources</code> ç›®å½•ä¸‹çš„ <code>archetype</code> å³ç”Ÿæˆçš„é¡¹ç›®æ¨¡ç‰ˆã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-afer-term-vP3Tz3.png" alt="archetype-afer-term-vP3Tz3"></p><p>ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p><ol><li>main/resources/archetype-resourcesï¼šé¡¹ç›®çš„æ¨¡ç‰ˆï¼Œç”Ÿæˆæ–°é¡¹ç›®ï¼Œå°±æ˜¯æ ¹æ®è¿™å—çš„ä»£ç è¿›è¡Œç”Ÿæˆçš„ã€‚<ol><li>.idea æ— ç”¨ï¼Œåˆ é™¤æ‰ã€‚</li><li>__rootArtifactId__xxx é¡¹ç›®çš„å„ä¸ª module</li></ol></li><li>main/resources/META-INF/maven/archetype-metadata.xmlï¼šæ¨¡ç‰ˆå·¥ç¨‹çš„å…ƒæ•°æ®é…ç½®ã€‚</li></ol><p>å¯ä»¥æŠŠ archetype æ‹·å‡ºå»ï¼Œè¿™æ˜¯ä¸€ä¸ªå•ç‹¬çš„å·¥ç¨‹æ¨¡ç‰ˆï¼Œæ‹·å‡ºå»ä¹‹åï¼Œä½¿ç”¨ IDEA æ‰“å¼€ã€‚</p><p>ä¸‹é¢å¼€å§‹ä»‹ç» archetype é‡Œé¢éƒ½æœ‰ä»€ä¹ˆã€‚</p><h3 id="archetype-æ¨¡ç‰ˆé¡¹ç›®ä»‹ç»"><a href="#archetype-æ¨¡ç‰ˆé¡¹ç›®ä»‹ç»" class="headerlink" title="archetype æ¨¡ç‰ˆé¡¹ç›®ä»‹ç»"></a>archetype æ¨¡ç‰ˆé¡¹ç›®ä»‹ç»</h3><p>ä½¿ç”¨ IDEA æ‰“å¼€ä¹‹åå‘ç°ï¼Œè¿˜æ˜¯ä¸€ä¸ª Maven é¡¹ç›®ã€‚</p><h4 id="archetype-resources"><a href="#archetype-resources" class="headerlink" title="archetype-resources"></a>archetype-resources</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-structure-xUdYE2.png" alt="archetype-structure-xUdYE2"></p><p>æ‰“å¼€ pom æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢ <code>$&#123;groupId&#125;</code> ã€ <code>$&#123;artifactId&#125;</code> ã€<code>$&#123;version&#125;</code> ä½¿ç”¨å ä½ç¬¦æŒ‡å®šçš„ç»„ç»‡ç‰ˆæœ¬ï¼Œè¿™äº›å°±æ˜¯æ–°åˆ›å»ºé¡¹ç›®æ—¶æŒ‡å®šçš„ã€‚</p><h4 id="archetype-metadata-xml"><a href="#archetype-metadata-xml" class="headerlink" title="archetype-metadata.xml"></a>archetype-metadata.xml</h4><p>archetype-metadata.xml é‡Œé¢ä¸ºå…ƒæ•°æ®é…ç½®ã€‚</p><ul><li>fileSetï¼šç”¨æ¥ç”Ÿæˆä¸€äº›é¡¹ç›®ä¸­çš„æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶æˆ–ç›®å½•åç§°åŒ…å« <code>__property__</code> æ¨¡å¼ï¼Œåˆ™å°†å…¶æ›¿æ¢ä¸ºç›¸åº”çš„å±æ€§å€¼ã€‚</li></ul><table><thead><tr><th>å±æ€§</th><th>ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>filtered</td><td>boolean</td><td>è¿‡æ»¤æ–‡é›†ï¼Œå°†æŒ‡å®šæ–‡ä»¶ç›´æ¥å¤åˆ¶ä¸éœ€è¦ä¿®æ”¹ã€‚<strong>é»˜è®¤å€¼ä¸ºï¼šfalseã€‚</strong></td></tr><tr><td>packaged</td><td>boolean</td><td>æ‰“åŒ…æ–‡ä»¶ï¼ŒæŒ‡å®šæ–‡ä»¶å°†åœ¨packageå±æ€§ä¹‹å‰çš„ç›®å½•ç»“æ„ä¸­ç”Ÿæˆ/å¤åˆ¶ã€‚å®ƒä»¬å¯ä»¥æ˜¯éæ‰“åŒ…çš„ï¼Œè¿™æ„å‘³ç€æ‰€é€‰æ–‡ä»¶å°†åœ¨æ²¡æœ‰è¯¥å‰ç¼€çš„æƒ…å†µä¸‹ç”Ÿæˆ/å¤åˆ¶ã€‚<strong>é»˜è®¤å€¼ä¸ºï¼šfalseã€‚</strong></td></tr><tr><td>encoding</td><td>String</td><td>è¿‡æ»¤å†…å®¹æ—¶ä½¿ç”¨çš„ç¼–ç ã€‚</td></tr></tbody></table><p>fileSet åŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š</p><table><thead><tr><th>å…ƒç´ </th><th>ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>directory</td><td>String</td><td>ç”Ÿæˆé¡¹ç›®æ–‡ä»¶çš„ç›®å½•</td></tr><tr><td>includes/include*</td><td>List<String></td><td>åŒ…å«æ–‡ä»¶</td></tr><tr><td>excludes/exclude*</td><td>List<String></td><td>æ’é™¤æ–‡ä»¶</td></tr></tbody></table><p>å› ä¸ºç”Ÿæˆé¡¹ç›®ä¸éœ€è¦ .idea *.iml æ–‡ä»¶ï¼Œæ‰€ä»¥ç›´æ¥åˆ é™¤ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-metadata1-iVIvLq.png" alt="archetype-metadata1-iVIvLq"></p><ul><li>module å°±æ˜¯è¦ç”Ÿæˆçš„é¡¹ç›®ä¸€å…±å‡ ä¸ª module</li></ul><table><thead><tr><th>å±æ€§</th><th>ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>id</td><td>String</td><td>The moduleâ€™s artifactId.</td></tr><tr><td>dir</td><td>String</td><td>The moduleâ€™s directory.</td></tr><tr><td>name</td><td>String</td><td>The moduleâ€™s name.</td></tr></tbody></table><table><thead><tr><th>å…ƒç´ </th><th>ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>fileSets/fileSet*</td><td>List<FileSet></td><td>æ–‡ä»¶</td></tr><tr><td>modules/module*</td><td>List<ModuleDescriptor></td><td>æ¨¡å—</td></tr></tbody></table><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-metadata2-HCnJqd.png" alt="archetype-metadata2-HCnJqd"></p><p>å¯ä»¥çœ‹å‡ºé‡Œé¢å°±æ˜¯è‡ªå·±çš„é¡¹ç›®æ¨¡ç‰ˆã€‚</p><p><code>__rootArtifactId__-controller</code> åœ¨ç”Ÿæˆçš„æ—¶å€™ï¼Œå°±ä¼šæ ¹æ®ä¼ å…¥çš„ artifactId ç”ŸæˆæŒ‡å®šçš„ module åå­—ã€‚</p><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><ol><li>clean install </li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-clean-install-zbua0z.png" alt="archetype-clean-install-zbua0z"></p><ol start="2"><li>IDEA Add Archetype</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-maven-b3sZ6a.png" alt="archetype-maven-b3sZ6a"></p><ol start="3"><li>é€‰æ‹©ä½¿ç”¨ Archetype ç”Ÿæˆæ–°é¡¹ç›®</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-maven2-HDnFc4.png" alt="archetype-maven2-HDnFc4"></p><ol start="4"><li>å¡«å†™æ–°ç”Ÿæˆé¡¹ç›®çš„åå­—ç­‰</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-maven3-sbJlI1.png" alt="archetype-maven3-sbJlI1"></p><ol start="5"><li>ç”Ÿæˆæ–°é¡¹ç›®</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-generate-5GUrpu.png" alt="archetype-generate-5GUrpu"></p><h3 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h3><p><strong>Q:</strong> å¦‚ä½•è‡ªå®šä¹‰åŒ…è·¯å¾„ï¼Ÿ</p><p><strong>A:</strong> å¯ä»¥ä½¿ç”¨ <code>requiredProperties</code> è‡ªå®šä¹‰å‚æ•°ã€‚é€šè¿‡ä¼ å…¥è‡ªå®šä¹‰çš„å‚æ•°ï¼Œæ¥ç”Ÿæˆè‡ªå®šçš„åŒ…è·¯å¾„ã€‚</p><p>æ¯”å¦‚å‘ç°æ–°ç”Ÿæˆé¡¹ç›®çš„åŒ…è·¯å¾„éƒ½æ˜¯ <code>com.liuzhihang.archetype</code>ï¼Œè¿™æ ·è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œæ¯ä¸ªé¡¹ç›®æœ‰æ¯ä¸ªé¡¹ç›®è‡ªå·±çš„åŒ…è·¯å¾„ã€‚åªéœ€è¦åšä»¥ä¸‹ä¿®æ”¹ï¼š</p><ol><li>å°† <code>requiredProperties</code> æ·»åŠ åˆ°é¡¹ç›®ä¸­ï¼Œç„¶åæ·»åŠ æ–°å˜é‡ <code>middlePackage</code>ã€‚</li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">requiredProperties</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--ä½¿ç”¨archetypeæ—¶å€™å¿…é¡»è¦æ±‚è¾“å…¥çš„å‚æ•°--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">requiredProperty</span> <span class="attr">key</span>=<span class="string">&quot;groupId&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--å¯ä»¥è®¾ç½®é»˜è®¤å€¼ï¼Œä½¿ç”¨archetypeä¼šä½¿ç”¨é»˜è®¤å€¼--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">defaultValue</span>&gt;</span>com.liuzhihang<span class="tag">&lt;/<span class="name">defaultValue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">requiredProperty</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">requiredProperty</span> <span class="attr">key</span>=<span class="string">&quot;package&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">defaultValue</span>&gt;</span>com.liuzhihang<span class="tag">&lt;/<span class="name">defaultValue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">requiredProperty</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">requiredProperty</span> <span class="attr">key</span>=<span class="string">&quot;middlePackage&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">defaultValue</span>&gt;</span>$&#123;rootArtifactId&#125;<span class="tag">&lt;/<span class="name">defaultValue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">requiredProperty</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">requiredProperties</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>ä¿®æ”¹æ¨¡ç‰ˆçš„æ–‡ä»¶å</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-middle-mH0Gzf.png" alt="archetype-middle-mH0Gzf"></p><p>å¦‚æœæ–‡ä»¶æˆ–ç›®å½•åç§°åŒ…å« <code>__property__</code> æ¨¡å¼ï¼Œåˆ™å°†å…¶æ›¿æ¢ä¸ºç›¸åº”çš„å±æ€§å€¼ã€‚åˆ°è¿™é‡Œè¿˜ä¸è¡Œï¼Œå› ä¸ºç”Ÿæˆçš„åŒ…åè¿˜æ²¡æ”¹ã€‚</p><ol start="3"><li>ä¿®æ”¹å†…éƒ¨æ–‡ä»¶çš„åŒ…è·¯å¾„ã€‚åŒ…æ‹¬ <strong>.java</strong> ã€** .xml** ã€** .properties** ç­‰ã€‚</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-change-middle-3C0Msb.png" alt="archetype-change-middle-3C0Msb"></p><ol start="4"><li>é‡æ–° clean install</li></ol><p>æ³¨ï¼šæ­¤æ—¶å¯èƒ½ä¼šæŠ¥é”™ï¼Œéœ€è¦åœ¨ <code>src/test/resources/projects/basic/archetype.properties</code> ä¸‹æ·»åŠ  <code>middlePackage=basic</code> å†é‡æ–°å°è¯•ä¸‹ã€‚</p><p>åœ¨ç”Ÿæˆæ—¶æ³¨æ„æŒ‡å®š <code>middlePackage</code> å±æ€§ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-middle-1-r8qOco.png" alt="archetype-middle-1-r8qOco"></p><p><strong>Q:</strong> æˆ‘æƒ³è‡ªå®šä¹‰ Application çš„åå­—æ€ä¹ˆå¼„ï¼Ÿ</p><p><strong>A:</strong> åŒæ ·ä½¿ç”¨ <code>requiredProperties</code> è‡ªå®šä¹‰å‚æ•°ã€‚</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">requiredProperty</span> <span class="attr">key</span>=<span class="string">&quot;appName&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">requiredProperty</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-app-name-Vt9Xj3.png" alt="archetype-app-name-Vt9Xj3"></p><p>å½“ç„¶ä¹Ÿå¯ä»¥èµ·ä¸€ä¸ªé€šç”¨çš„åå­—ã€‚</p><p><strong>Q:</strong> åˆ«çš„å°ä¼™ä¼´æ€ä¹ˆç”¨ï¼Ÿ</p><p><strong>A:</strong> å½“ç„¶æ˜¯ deploy åˆ°ç§æœäº†ï¼Œ åœ¨ pom é‡Œé¢æ·»åŠ å¦‚ä¸‹é…ç½®ï¼ŒæŒ‡å®šè‡ªå·±å…¬å¸çš„ç§æœã€‚deploy ï¼Œè¿™æ ·å°±å¯ä»¥å’Œå°ä¼™ä¼´ä¸€èµ·æ„‰å¿«çš„ä½¿ç”¨å•¦ã€‚</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- è¿œç¨‹ä»“åº“ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus Release Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://liuzhihang.com:xxxx/repository/maven-releases/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus Snapshot Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://liuzhihang.com:xxxx/repository/maven-snapshots/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>Q:</strong> æˆ‘è¦æ€ä¹ˆä» IDEA åˆ é™¤ Archetype â€‹ï¼Ÿ</p><p><strong>A:</strong> è¿™ä¹ˆå¥½ç”¨æ€ä¹ˆèˆå¾—åˆ é™¤â€‹å‘¢ï¼Ÿåªè¦æ‰¾åˆ°ä»¥ä¸‹è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">liuzhihang % &gt; <span class="built_in">pwd</span></span><br><span class="line">/Users/liuzhihang/Library/Caches/JetBrains/IntelliJIdea2020.1/Maven/Indices</span><br></pre></td></tr></table></figure><p>é‡Œé¢æœ‰ä¸€ä¸ª <code>UserArchetypes.xmlâ€‹</code>ï¼Œ æ‰“å¼€ï¼Œåˆ é™¤æ‰é‡Œé¢çš„ archetype å°±è¡Œã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/archetype-delete-ZyQULu.png" alt="archetype-delete-ZyQULu"></p><h4 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h4><p>Maven Archetype æ–‡æ¡£ï¼š<a href="http://maven.apache.org/archetype/maven-archetype-plugin/index.html">http://maven.apache.org/archetype/maven-archetype-plugin/index.html</a></p><p>ä»£ç åœ°å€ï¼š<a href="https://github.com/liuzhihang/archetype-demo">https://github.com/liuzhihang/archetype-demo</a></p>]]></content>
      
      
      <categories>
          
          <category> å·¥ä½œç¬”è®° </category>
          
          <category> Archetype </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥ä½œç¬”è®° </tag>
            
            <tag> Archetype </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- åˆ«èµ°ï¼è¿™é‡Œæœ‰ä¸ªç¬”è®°ï¼šå›¾æ–‡è®²è§£ AQS ï¼Œä¸€èµ·çœ‹çœ‹ AQS çš„æºç â€¦â€¦(å›¾æ–‡è¾ƒé•¿)</title>
      <link href="2020/07/12/source-code-aqs.html"/>
      <url>2020/07/12/source-code-aqs.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>AbstractQueuedSynchronizer æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œç®€ç§° AQS ã€‚æ˜¯åœ¨ JUC åŒ…ä¸‹é¢ä¸€ä¸ªéå¸¸é‡è¦çš„åŸºç¡€ç»„ä»¶ï¼ŒJUC åŒ…ä¸‹é¢çš„å¹¶å‘é” <code>ReentrantLock</code> <code>CountDownLatch</code> ç­‰éƒ½æ˜¯åŸºäº AQS å®ç°çš„ã€‚æ‰€ä»¥æƒ³è¿›ä¸€æ­¥ç ”ç©¶é”çš„åº•å±‚åŸç†ï¼Œéå¸¸æœ‰å¿…è¦å…ˆäº†è§£ AQS çš„åŸç†ã€‚</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>å…ˆçœ‹ä¸‹ AQS çš„ç±»å›¾ç»“æ„ï¼Œä»¥åŠæºç æ³¨é‡Šï¼Œæœ‰ä¸€å®šçš„å¤§æ¦‚äº†è§£ä¹‹åå†ä»æºç å…¥æ‰‹ï¼Œä¸€æ­¥ä¸€æ­¥ç ”ç©¶å®ƒçš„åº•å±‚åŸç†ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/aqs.png" alt="aqs"></p><p>â€œ æºç æ³¨é‡Š</p><p>æä¾›äº†å®ç°é˜»å¡é”å’Œç›¸å…³åŒæ­¥å™¨ä¾é å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰ç­‰å¾…é˜Ÿåˆ—ï¼ˆä¿¡å·é‡ï¼Œäº‹ä»¶ç­‰ï¼‰çš„æ¡†æ¶ã€‚ æ­¤ç±»ä¸­è®¾è®¡äº†ä¸€ä¸ªå¯¹å¤§å¤šæ•°åŸºäº AQS çš„åŒæ­¥å™¨æœ‰ç”¨çš„åŸå­å˜é‡æ¥è¡¨ç¤ºçŠ¶æ€ï¼ˆstateï¼‰ã€‚ å­ç±»å¿…é¡»å®šä¹‰ protected æ–¹æ³•æ¥ä¿®æ”¹è¿™ä¸ª stateï¼Œå¹¶ä¸”å®šä¹‰ state å€¼åœ¨å¯¹è±¡ä¸­çš„å…·ä½“å«ä¹‰æ˜¯ acquired æˆ– releasedã€‚ è€ƒè™‘åˆ°è¿™äº›ï¼Œåœ¨è¿™ä¸ªç±»ä¸­çš„å…¶ä»–æ–¹æ³•å¯ä»¥å®ç°æ‰€æœ‰æ’é˜Ÿå’Œé˜»å¡æœºåˆ¶ã€‚ å­ç±»å¯ä»¥ä¿æŒå…¶ä»–çŠ¶æ€å­—æ®µï¼Œä½†åªèƒ½ä½¿ç”¨æ–¹æ³• getState ã€setState å’Œ compareAndSetState ä»¥åŸå­æ–¹å¼æ›´æ–° state ã€‚</p><p>å­ç±»åº”è¢«å®šä¹‰ä¸ºç”¨äºå®ç°å…¶å°é—­ç±»çš„åŒæ­¥æ€§èƒ½çš„éå…¬å…±å†…éƒ¨è¾…åŠ©ç±»ã€‚ ç±»AbstractQueuedSynchronizeræ²¡æœ‰å®ç°ä»»ä½•åŒæ­¥æ¥å£ã€‚ ç›¸åï¼Œå®ƒå®šä¹‰äº†ä¸€äº›æ–¹æ³•ï¼Œå¦‚ acquireInterruptibly å¯ä»¥é€šè¿‡å…·ä½“çš„é”å’Œç›¸å…³åŒæ­¥å™¨æ¥è°ƒç”¨é€‚å½“å±¥è¡Œå…¶å…¬å…±æ–¹æ³•ã€‚</p><p>æ­¤ç±»æ”¯æŒç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ã€‚ åœ¨ç‹¬å æ¨¡å¼ä¸‹ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½è·å–æˆåŠŸï¼Œå…±äº«æ¨¡å¼ä¸‹å¯ä»¥ï¼ˆä½†ä¸ä¸€å®šï¼‰è·å–æˆåŠŸã€‚ æ­¤ç±»ä¸â€œç†è§£â€ï¼Œåœ¨æœºæ¢°æ„ä¹‰ä¸Šè¿™äº›ä¸åŒçš„æ˜¯ï¼Œå½“å…±äº«æ¨¡å¼è·å–æˆåŠŸï¼Œåˆ™ä¸‹ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ä¹Ÿå¿…é¡»ç¡®å®šå®ƒæ˜¯å¦èƒ½å¤Ÿè·å–ã€‚ çº¿ç¨‹åœ¨ä¸åŒæ¨¡å¼ä¸‹çš„ç­‰å¾…å…±äº«ç›¸åŒçš„FIFOé˜Ÿåˆ—ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ç°å­ç±»åªæ”¯æŒå…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œä½†åŒæ—¶ä½¿ç”¨ä¸¤ç§æ¨¡å¼ä¹Ÿå¯ä»¥ï¼Œä¾‹å¦‚ReadWriteLock ã€‚ ä»…å…±äº«æ¨¡å¼ä¸éœ€è¦å®šä¹‰æ”¯æŒæœªä½¿ç”¨çš„æ¨¡å¼çš„æ–¹æ³•çš„å­ç±»ã€‚</p><p>è¿™ä¸ªç±»ä¸­å®šä¹‰äº†åµŒå¥—ç±» AbstractQueuedSynchronizer.ConditionObject ï¼Œå¯ç”¨äºä½œä¸ºä¸€ä¸ª Condition ç”±å­ç±»å®ç°ï¼Œå¹¶ä½¿ç”¨ isHeldExclusively æ–¹æ³•è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯å¦ä»¥ç‹¬å æ–¹å¼è¿›è¡Œï¼Œrelease()ã€ getState() acquire() æ–¹æ³•ç”¨äºæ“ä½œ state åŸå­å˜é‡ã€‚</p><p>æ­¤ç±»æä¾›æ£€æŸ¥å’Œç›‘è§†å†…éƒ¨é˜Ÿåˆ—çš„æ–¹æ³•ï¼Œä»¥åŠç±»ä¼¼æ–¹æ³•çš„æ¡ä»¶å¯¹è±¡ã€‚ æ ¹æ®éœ€è¦è¿›ä½¿ç”¨ä»¥ç”¨äºå®ƒä»¬çš„åŒæ­¥æœºåˆ¶ã€‚</p><p>è¦ä½¿ç”¨è¿™ä¸ªç±»ç”¨ä½œåŒæ­¥çš„åŸºç¡€ä¸Šï¼Œéœ€è¦é‡æ–°å®šä¹‰ä»¥ä¸‹æ–¹æ³•ï¼Œå¦‚ä½¿ç”¨ï¼Œé€šè¿‡æ£€æŸ¥å’Œæˆ–ä¿®æ”¹ getState ã€setState æˆ– compareAndSetState æ–¹æ³•ï¼š</p><p>tryAcquire<br>tryRelease<br>tryAcquireShared<br>tryReleaseShared<br>isHeldExclusively</p><p>â€œ</p><p>é€šè¿‡ä¸Šé¢çš„æ³¨é‡Šå¯ä»¥å¾—å‡ºå¤§æ¦‚çš„å°è±¡ï¼š</p><ol><li>å†…éƒ¨ä¾é å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰ ç­‰å¾…é˜Ÿåˆ—ã€‚</li><li>å­˜åœ¨ state è¡¨ç¤ºçŠ¶æ€ä¿¡æ¯ã€‚state å€¼åªèƒ½ç”¨ getState ã€setState å’Œ compareAndSetState æ–¹æ³•ä»¥åŸå­æ–¹å¼æ›´æ–°ã€‚</li><li>æ”¯æŒç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼Œä½†å…·ä½“éœ€è¦å­ç±»å®ç°å…·ä½“æ”¯æŒå“ªç§æ¨¡å¼ã€‚</li><li>åµŒå¥— AbstractQueuedSynchronizer.ConditionObject å¯ä»¥ä½œä¸º Condition ç”±å­ç±»å®ç°ã€‚</li><li>å­ç±»éœ€è¦é‡æ–°å®šä¹‰  tryAcquireã€tryReleaseã€tryAcquireSharedã€tryReleaseSharedã€isHeldExclusively æ–¹æ³•ã€‚</li></ol><h3 id="é˜Ÿåˆ—èŠ‚ç‚¹-Node"><a href="#é˜Ÿåˆ—èŠ‚ç‚¹-Node" class="headerlink" title="é˜Ÿåˆ—èŠ‚ç‚¹ Node"></a>é˜Ÿåˆ—èŠ‚ç‚¹ Node</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/node-1P32mR.png" alt="node-1P32mR"></p><p>NodeèŠ‚ç‚¹ï¼ŒåŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š</p><table><thead><tr><th>å…ƒç´ </th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>prev</td><td>ä¸Šä¸€ä¸ªèŠ‚ç‚¹</td></tr><tr><td>next</td><td>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</td></tr><tr><td>thread</td><td>æŒæœ‰çº¿ç¨‹</td></tr><tr><td>waitStatus</td><td>èŠ‚ç‚¹çŠ¶æ€</td></tr><tr><td>nextWaiter</td><td>ä¸‹ä¸€ä¸ªå¤„äº CONDITION çŠ¶æ€çš„èŠ‚ç‚¹</td></tr></tbody></table><p>ç»„åˆæˆç­‰å¾…é˜Ÿåˆ—åˆ™å¦‚ä¸‹ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/node-fifo.png" alt="node-fifo"></p><p>ä¸‹é¢æ˜¯ç­‰å¾…é˜Ÿåˆ—èŠ‚ç‚¹çš„ Node å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹æ­£åœ¨å…±äº«æ¨¡å¼ä¸‹ç­‰å¾…çš„æ ‡è®°</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node SHARED = <span class="keyword">new</span> Node();</span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºèŠ‚ç‚¹æ­£åœ¨ä»¥ç‹¬å æ¨¡å¼ç­‰å¾…çš„æ ‡è®°</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node EXCLUSIVE = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºçº¿ç¨‹å·²å–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºåç»­çº¿ç¨‹éœ€è¦å”¤é†’</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL    = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºçº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONDITION = -<span class="number">2</span>;</span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºä¸‹ä¸€æ¬¡acquireSharedåº”è¯¥æ— æ¡ä»¶ä¼ æ’­</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROPAGATE = -<span class="number">3</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * çŠ¶æ€å­—æ®µï¼Œä»…ä½¿ç”¨ä»¥ä¸‹å€¼</span></span><br><span class="line"><span class="comment">     * SIGNAL -1 ï¼šå½“å‰èŠ‚ç‚¹é‡Šæ”¾æˆ–è€…å–æ¶ˆæ—¶ï¼Œå¿…é¡» unpark ä»–çš„åç»­èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">     * CANCELLED 1 ï¼šç”±äºè¶…æ—¶ï¼ˆtimeoutï¼‰æˆ–ä¸­æ–­ï¼ˆinterruptï¼‰ï¼Œè¯¥èŠ‚ç‚¹è¢«å–æ¶ˆã€‚èŠ‚ç‚¹æ°¸è¿œä¸ä¼šç¦»å¼€æ­¤çŠ¶æ€ã€‚ç‰¹åˆ«æ˜¯ï¼Œå…·æœ‰å–æ¶ˆèŠ‚ç‚¹çš„çº¿ç¨‹æ°¸è¿œä¸ä¼šå†æ¬¡é˜»å¡ã€‚</span></span><br><span class="line"><span class="comment">     * CONDITION -2 ï¼šè¯¥èŠ‚ç‚¹ç›®å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ã€‚ ä½†å®ƒä¸ä¼šè¢«ç”¨ä½œåŒæ­¥é˜Ÿåˆ—èŠ‚ç‚¹ï¼Œç›´åˆ°è½¬ç§»ï¼Œè½¬ç§»æ—¶çš„çŠ¶æ€å°†è¢«è®¾ç½®ä¸º 0 ã€‚</span></span><br><span class="line"><span class="comment">     * PROPAGATE -3 ï¼šreleaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ </span></span><br><span class="line"><span class="comment">     * 0ï¼šéƒ½ä¸æ˜¯</span></span><br><span class="line"><span class="comment">     * å€¼ä»¥æ•°å­—è¡¨ç¤ºä»¥ç®€åŒ–ä½¿ç”¨ï¼Œå¤§å¤šæ•°æ—¶å€™å¯ä»¥æ£€æŸ¥ç¬¦å·ï¼ˆæ˜¯å¦å¤§äº0ï¼‰ä»¥ç®€åŒ–ä½¿ç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹æŒæœ‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é“¾æ¥ä¸‹ä¸€ä¸ªç­‰å¾…æ¡ä»¶èŠ‚ç‚¹ï¼Œæˆ–ç‰¹æ®Šå€¼å…±äº«</span></span><br><span class="line">    Node nextWaiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹æ˜¯å¦å¤„äº å…±äº«çŠ¶æ€ æ˜¯ï¼Œ è¿”å› true</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nextWaiter == SHARED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ ä½¿ç”¨æ—¶ å‰ä¸€ä¸ªèŠ‚ç‚¹ä¸èƒ½ä¸ºç©º</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> Node <span class="title">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">        Node p = prev;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node() &#123;    <span class="comment">// Used to establish initial head or SHARED marker</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, Node mode) &#123;     <span class="comment">// Used by addWaiter</span></span><br><span class="line">        <span class="keyword">this</span>.nextWaiter = mode;</span><br><span class="line">        <span class="keyword">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, <span class="keyword">int</span> waitStatus) &#123; <span class="comment">// Used by Condition</span></span><br><span class="line">        <span class="keyword">this</span>.waitStatus = waitStatus;</span><br><span class="line">        <span class="keyword">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Node èŠ‚ç‚¹ä¸­éœ€è¦é‡ç‚¹å…³æ³¨ waitStatus</p><ol><li>é»˜è®¤çŠ¶æ€ä¸º 0ï¼›</li><li>waitStatus &gt; 0 (CANCELLED 1) è¯´æ˜è¯¥èŠ‚ç‚¹è¶…æ—¶æˆ–è€…ä¸­æ–­äº†ï¼Œéœ€è¦ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼›</li><li>waitStatus = -1 SIGNAL å½“å‰çº¿ç¨‹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNALï¼Œåˆ™å½“å‰çº¿ç¨‹éœ€è¦é˜»å¡ï¼ˆunparkï¼‰ï¼›</li><li>waitStatus = -2 CONDITION -2 ï¼šè¯¥èŠ‚ç‚¹ç›®å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ï¼›</li><li>waitStatus = -3 PROPAGATE -3 ï¼šreleaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œåœ¨å…±äº«é”æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚</li></ol><p>äº†è§£å®Œ Node çš„ç»“æ„ä¹‹åï¼Œå†äº†è§£ä¸‹ AQS ç»“æ„ï¼Œå¹¶ä»å¸¸ç”¨æ–¹æ³•å…¥æ‰‹ï¼Œé€æ­¥äº†è§£å…·ä½“å®ç°é€»è¾‘ã€‚</p><h3 id="AbstractQueuedSynchronizer"><a href="#AbstractQueuedSynchronizer" class="headerlink" title="AbstractQueuedSynchronizer"></a>AbstractQueuedSynchronizer</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractQueuedSynchronizer</span> <span class="keyword">extends</span> <span class="title">AbstractOwnableSynchronizer</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…é˜Ÿåˆ—çš„å¤´ï¼Œå»¶è¿Ÿåˆå§‹åŒ–ã€‚ é™¤äº†åˆå§‹åŒ–ï¼Œå®ƒæ˜¯ä»…ç»ç”±æ–¹æ³•setHeadä¿®æ”¹ã€‚ æ³¨æ„ï¼šå¦‚æœå¤´å­˜åœ¨ï¼Œå…¶waitStatusä¿è¯ä¸ä¼šæ˜¯ CANCELLED çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå»¶è¿Ÿåˆå§‹åŒ–ã€‚ ä»…åœ¨ä¿®æ”¹é€šè¿‡æ–¹æ³•ENQæ·»åŠ æ–°èŠ‚ç‚¹ç­‰å¾…ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒæ­¥çŠ¶æ€ </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–çŠ¶æ€</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®çŠ¶æ€å€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">int</span> newState)</span> </span>&#123;</span><br><span class="line">        state = newState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸå­æ›´æ–°çŠ¶æ€å€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetState</span><span class="params">(<span class="keyword">int</span> expect, <span class="keyword">int</span> update)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// See below for intrinsics setup to support this</span></span><br><span class="line">        <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, stateOffset, expect, update);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ AQS ä¸­ä¸»è¦å‚æ•°ä¸ºï¼š</p><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>head</td><td>ç­‰å¾…é˜Ÿåˆ—å¤´</td></tr><tr><td>tail</td><td>ç­‰å¾…é˜Ÿåˆ—å°¾</td></tr><tr><td>state</td><td>åŒæ­¥çŠ¶æ€</td></tr></tbody></table><p>é€šè¿‡æ³¨é‡Šäº†è§£åˆ°ï¼Œåœ¨ AQS é‡Œä¸»è¦åˆ†ä¸ºä¸¤ç§æ“ä½œæ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯ï¼šç‹¬å æ¨¡å¼ã€å…±äº«æ¨¡å¼ï¼Œä¸‹é¢åˆ†åˆ«ä»ä¸¤ä¸ªä¸åŒçš„è§’åº¦å»åˆ†ææºç ã€‚</p><table><thead><tr><th>æ“ä½œ</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>acquire</td><td>ä»¥ç‹¬å æ¨¡å¼è·å–ï¼Œå¿½ç•¥ä¸­æ–­ã€‚ é€šè¿‡è°ƒç”¨è‡³å°‘ä¸€æ¬¡å®æ–½tryAcquire ï¼Œåœ¨æˆåŠŸæ—¶è¿”å›ã€‚ å¦åˆ™ï¼Œçº¿ç¨‹æ’é˜Ÿï¼Œå¯èƒ½é‡å¤æŸ¥å°å’Œè§£å°ï¼Œè°ƒç”¨tryAcquireç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚ è¿™ç§æ–¹æ³•å¯ä»¥ç”¨æ¥å®ç°æ–¹æ³•Lock.lock ã€‚</td></tr><tr><td>release</td><td>ä»¥ç‹¬å æ¨¡å¼é‡Šæ”¾ã€‚ é€šè¿‡ç–é€šä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œå¦‚æœå®ç°tryReleaseè¿”å›trueã€‚ è¿™ç§æ–¹æ³•å¯ä»¥ç”¨æ¥å®ç°æ–¹æ³•Lock.unlock ã€‚</td></tr><tr><td>acquireShared</td><td>è·å–åœ¨å…±äº«æ¨¡å¼ä¸‹ï¼Œå¿½ç•¥ä¸­æ–­ã€‚ é€šè¿‡è‡³å°‘ä¸€æ¬¡ç¬¬ä¸€è°ƒç”¨å®ç°tryAcquireShared ï¼Œåœ¨æˆåŠŸæ—¶è¿”å›ã€‚ å¦åˆ™ï¼Œçº¿ç¨‹æ’é˜Ÿï¼Œå¯èƒ½é‡å¤æŸ¥å°å’Œè§£å°ï¼Œè°ƒç”¨tryAcquireSharedç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚</td></tr><tr><td>releaseShared</td><td>ä»¥å…±äº«æ¨¡å¼é‡Šæ”¾ã€‚ é€šè¿‡ç–é€šä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œå¦‚æœå®ç°tryReleaseSharedè¿”å›trueã€‚</td></tr></tbody></table><p>æ— è®ºæ˜¯å…±äº«æ¨¡å¼è¿˜æ˜¯ç‹¬å æ¨¡å¼åœ¨è¿™é‡Œé¢éƒ½ä¼šç”¨åˆ° addWaiter æ–¹æ³•ï¼Œå°†å½“å‰çº¿ç¨‹åŠæ¨¡å¼åˆ›å»ºæ’é˜ŸèŠ‚ç‚¹ã€‚</p><h4 id="ç‹¬å æ¨¡å¼"><a href="#ç‹¬å æ¨¡å¼" class="headerlink" title="ç‹¬å æ¨¡å¼"></a>ç‹¬å æ¨¡å¼</h4><h5 id="è·å–ç‹¬å èµ„æº-acquire"><a href="#è·å–ç‹¬å èµ„æº-acquire" class="headerlink" title="è·å–ç‹¬å èµ„æº acquire"></a>è·å–ç‹¬å èµ„æº acquire</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// tryAcquire å°è¯•è·å– stateï¼Œè·å–å¤±è´¥åˆ™ä¼šåŠ å…¥åˆ°é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç‹¬å æ¨¡å¼ä¸‹ä¼šå°è¯•è·å– stateï¼Œå½“è·å–å¤±è´¥æ—¶ä¼šè°ƒç”¨ acquireQueued(addWaiter(Node.EXCLUSIVE), arg)ã€‚</p><ol><li>tryAcquire(arg)ï¼Œå°è¯•è·å– state è¿™å—ç”±å­ç±»è‡ªå·±å®ç°ï¼Œä¸åŒçš„å­ç±»é€»è¾‘ä¸åŒï¼Œè¿™å—åœ¨ä»‹ç»å­ç±»ä»£ç æ—¶ä¼šè¯´æ˜ã€‚</li><li>è·å– state å¤±è´¥åï¼Œä¼šè¿›è¡Œ acquireQueued(addWaiter(Node.EXCLUSIVE), arg)ï¼Œè¿™å—ä»£ç å¯ä»¥æ‹†åˆ†ä¸ºä¸¤å—ï¼šaddWaiter(Node.EXCLUSIVE)ï¼ŒacquireQueued(node, arg)ã€‚</li><li>addWaiter(Node.EXCLUSIVE) è¿”å›çš„æ˜¯å½“å‰æ–°åˆ›å»ºçš„èŠ‚ç‚¹ã€‚</li><li>acquireQueued(node, arg) çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œä½¿ç”¨ addWaiter(Node.EXCLUSIVE) æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œ acquireQueued(node, arg) ä½¿ç”¨å¾ªç¯ï¼Œä¸æ–­çš„ä¸ºé˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹å»å°è¯•è·å–èµ„æºï¼Œç›´åˆ°è·å–æˆåŠŸæˆ–è€…è¢«ä¸­æ–­ã€‚</li></ol><p>æ€»ç»“è·å–èµ„æºä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol><li>å°è¯•è·å–èµ„æº</li><li>å…¥é˜Ÿåˆ—</li><li>å‡ºé˜Ÿåˆ—</li></ol><p>å°è¯•è·å–èµ„æº <code>tryAcquire(arg)</code>ï¼Œç”±å­ç±»å®ç°ï¼Œé‚£ä¸‹é¢åˆ™ç€æ‰‹åˆ†åˆ«åˆ†æ <code>å…¥é˜Ÿåˆ—</code>ã€<code>å‡ºé˜Ÿåˆ—</code>ã€‚</p><h6 id="å…¥é˜Ÿåˆ—ï¼šaddWaiter-Node-EXCLUSIVE"><a href="#å…¥é˜Ÿåˆ—ï¼šaddWaiter-Node-EXCLUSIVE" class="headerlink" title="å…¥é˜Ÿåˆ—ï¼šaddWaiter(Node.EXCLUSIVE)"></a>å…¥é˜Ÿåˆ—ï¼šaddWaiter(Node.EXCLUSIVE)</h6><p>ä½¿ç”¨ <code>addWaiter(Node.EXCLUSIVE)</code> æ–¹æ³•å°†èŠ‚ç‚¹æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>æ ¹æ®ä¼ å…¥çš„æ¨¡å¼åˆ›å»ºèŠ‚ç‚¹</li><li>åˆ¤æ–­å°¾èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™éœ€è¦ä½¿ç”¨ <code>enq(node)</code> æ–¹æ³•åˆå§‹åŒ–èŠ‚ç‚¹ï¼Œå­˜åœ¨åˆ™ç›´æ¥<code>å°è¯•</code>æ’å…¥å°¾éƒ¨ã€‚</li><li><code>å°è¯•</code>æ’å…¥å°¾éƒ¨æ—¶ä½¿ç”¨ CAS æ’å…¥ï¼Œé˜²æ­¢å¹¶å‘æƒ…å†µï¼Œå¦‚æœæ’å…¥å¤±è´¥ï¼Œä¼šè°ƒç”¨ <code>enq(node)</code> è‡ªæ—‹ç›´åˆ°æ’å…¥ã€‚</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// å®šä½åˆ°é˜Ÿåˆ—æœ«å°¾çš„ node</span></span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ–°èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ æŒ‡å‘å°¾èŠ‚ç‚¹</span></span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ CAS è®¾ç½®å°¾èŠ‚ç‚¹ï¼Œtail å¦‚æœç­‰äº pred åˆ™æ›´æ–°ä¸º node</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            <span class="comment">// æ›´æ–°æˆåŠŸåˆ™å°† pred çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘ node</span></span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°¾èŠ‚ç‚¹æ²¡æœ‰åˆå§‹åŒ–ï¼Œæˆ–ç«äº‰å¤±è´¥ï¼Œè‡ªæ—‹</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * tailOffset ä¹Ÿå°±æ˜¯æˆå‘˜å˜é‡ tail çš„å€¼</span></span><br><span class="line"><span class="comment"> * æ­¤å¤„ç›¸å½“äºï¼šæ¯”è¾ƒ tail çš„å€¼å’Œ expect çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œ ç›¸ç­‰åˆ™æ›´æ–°ä¸º update</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetTail</span><span class="params">(Node expect, Node update)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapObject(<span class="keyword">this</span>, tailOffset, expect, update);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetHead</span><span class="params">(Node update)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.compareAndSwapObject(<span class="keyword">this</span>, headOffset, <span class="keyword">null</span>, update);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node t = tail;</span><br><span class="line">        <span class="comment">// å°¾èŠ‚ç‚¹ä¸ºç©º éœ€è¦åˆå§‹åŒ–å¤´èŠ‚ç‚¹ï¼Œæ­¤æ—¶å¤´å°¾èŠ‚ç‚¹æ˜¯ä¸€ä¸ª</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä¸ä¸ºç©º å¾ªç¯èµ‹å€¼</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹å®Œä»£ç å’Œæ³¨é‡Šè‚¯å®šè¿˜æ˜¯æœ‰ç‚¹æ¨¡ç³Šï¼Œç°åœ¨ç”¨å›¾ä¸€æ­¥ä¸€æ­¥è¿›è¡Œè¯´æ˜ã€‚</p><p>å› ä¸ºæ ¹æ®<code>åˆå§‹å°¾èŠ‚ç‚¹æ˜¯å¦ä¸ºç©º</code>åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œè¿™é‡Œä½¿ç”¨ä¸¤å¹…å›¾ï¼š</p><ol><li>ç¬¬ä¸€å¹…ä¸ºç¬¬ä¸€æ¬¡æ·»åŠ èŠ‚ç‚¹ï¼Œæ­¤æ—¶ head ä¼šå»¶è¿Ÿåˆå§‹åŒ–ï¼›</li><li>ç¬¬äºŒå¹…å›¾ä¸ºå·²ç»å­˜åœ¨é˜Ÿåˆ—ï¼Œè¿›è¡Œæ’å…¥èŠ‚ç‚¹ï¼›</li><li>æ³¨æ„çœ‹ä»£ç ï¼Œenq æ–¹æ³•è¿”å›çš„æ˜¯<code>ä¹‹å‰çš„å°¾èŠ‚ç‚¹</code>ï¼›</li><li>addWaiter æ–¹æ³• è¿”å›çš„æ˜¯<code>å½“å‰æ’å…¥çš„æ–°åˆ›å»ºçš„èŠ‚ç‚¹</code>ã€‚</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/aqs-addwaiter-1.png" alt="aqs-addwaiter-1"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/cas-add-waiter-02.png" alt="cas-add-waiter-02"></p><p>èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹åï¼Œè¿”å›å½“å‰èŠ‚ç‚¹ï¼Œè€Œä¸‹ä¸€æ­¥åˆ™éœ€è¦è°ƒç”¨æ–¹æ³• <code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code> ä¸æ–­çš„å»è·å–èµ„æºã€‚</p><h6 id="å‡ºé˜Ÿåˆ—ï¼šacquireQueued-addWaiter-Node-EXCLUSIVE-arg"><a href="#å‡ºé˜Ÿåˆ—ï¼šacquireQueued-addWaiter-Node-EXCLUSIVE-arg" class="headerlink" title="å‡ºé˜Ÿåˆ—ï¼šacquireQueued(addWaiter(Node.EXCLUSIVE), arg)"></a>å‡ºé˜Ÿåˆ—ï¼šacquireQueued(addWaiter(Node.EXCLUSIVE), arg)</h6><p>æ–¹æ³•ä¼šé€šè¿‡å¾ªç¯ä¸æ–­å°è¯•è·å–æ‹¿åˆ°èµ„æºï¼Œç›´åˆ°æˆåŠŸã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æ‹¿åˆ°èµ„æº</span></span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸­æ–­çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// æ— é™å¾ªç¯</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">// å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œ è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ å¤´èŠ‚ç‚¹çš„ next å³çœŸå®çš„ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ ï¼ˆå› ä¸º head æ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼‰</span></span><br><span class="line">            <span class="comment">// ç„¶åå†å°è¯•è·å–èµ„æº</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">// è·å–æˆåŠŸä¹‹å å°†å¤´æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                setHead(node); </span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// p ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œ æˆ–è€… å¤´èŠ‚ç‚¹æœªèƒ½è·å–åˆ°èµ„æº ï¼ˆéå…¬å¹³æƒ…å†µä¸‹è¢«åˆ«çš„èŠ‚ç‚¹æŠ¢å ï¼‰ </span></span><br><span class="line">            <span class="comment">// åˆ¤æ–­ node æ˜¯å¦è¦è¢«é˜»å¡ï¼Œ</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>ä¸æ–­è·å–æœ¬èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸º headï¼Œå› ä¸º head æ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯ head èŠ‚ç‚¹ï¼Œåˆ™å½“å‰èŠ‚ç‚¹ä¸º <code>ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹</code>ï¼›</li><li>ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ä¸æ–­çš„å»è·å–èµ„æºï¼Œè·å–æˆåŠŸï¼Œåˆ™å°† head æŒ‡å‘å½“å‰èŠ‚ç‚¹ï¼›</li><li>å½“å‰èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œæˆ–è€… <code>tryAcquire(arg)</code> å¤±è´¥ï¼ˆå¤±è´¥å¯èƒ½æ˜¯éå…¬å¹³é”ï¼‰ã€‚è¿™æ—¶å€™éœ€è¦åˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€å†³å®š<code>å½“å‰èŠ‚ç‚¹æ˜¯å¦è¦è¢«é˜»å¡</code>ï¼ˆå‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€æ˜¯å¦ä¸º SIGNALï¼‰ã€‚</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦åº”è¯¥è¢«é˜»å¡</span></span><br><span class="line"><span class="comment"> * SIGNAL -1 ï¼šå½“å‰èŠ‚ç‚¹é‡Šæ”¾æˆ–è€…å–æ¶ˆæ—¶ï¼Œå¿…é¡» unpark ä»–çš„åç»­èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment"> * CANCELLED 1 ï¼šç”±äºè¶…æ—¶ï¼ˆtimeoutï¼‰æˆ–ä¸­æ–­ï¼ˆinterruptï¼‰ï¼Œè¯¥èŠ‚ç‚¹è¢«å–æ¶ˆã€‚èŠ‚ç‚¹æ°¸è¿œä¸ä¼šç¦»å¼€æ­¤çŠ¶æ€ã€‚ç‰¹åˆ«æ˜¯ï¼Œå…·æœ‰å–æ¶ˆèŠ‚ç‚¹çš„çº¿ç¨‹æ°¸è¿œä¸ä¼šå†æ¬¡é˜»å¡ã€‚</span></span><br><span class="line"><span class="comment"> * CONDITION -2 ï¼šè¯¥èŠ‚ç‚¹ç›®å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ã€‚ ä½†å®ƒä¸ä¼šè¢«ç”¨ä½œåŒæ­¥é˜Ÿåˆ—èŠ‚ç‚¹ï¼Œç›´åˆ°è½¬ç§»ï¼Œè½¬ç§»æ—¶çš„çŠ¶æ€å°†è¢«è®¾ç½®ä¸º 0 ã€‚</span></span><br><span class="line"><span class="comment"> * PROPAGATE -3 ï¼šreleaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ </span></span><br><span class="line"><span class="comment"> * 0ï¼šéƒ½ä¸æ˜¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">    <span class="comment">// å‰ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦ unpark åç»­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹å¤„äºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// å°†å–æ¶ˆçš„èŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­ç§»é™¤</span></span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®å‰ä¸€ä¸ªèŠ‚ç‚¹ä¸º SIGNAL çŠ¶æ€</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>shouldParkAfterFailedAcquire</code> æ–¹æ³•ä¸­ï¼Œä¼šåˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼ŒåŒæ—¶å–æ¶ˆåœ¨é˜Ÿåˆ—ä¸­å½“å‰èŠ‚ç‚¹å‰é¢æ— æ•ˆçš„èŠ‚ç‚¹ã€‚</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/aqs-acquire.png" alt="aqs-acquire"></p><p>å†ç»§ç»­é˜…è¯» å‡ºé˜Ÿåˆ— acquireQueued æ–¹æ³•ï¼Œå‘ç°æœ‰ä¸€ä¸ª finally ä¼šåˆ¤æ–­çŠ¶æ€åæ‰§è¡Œ <code>cancelAcquire(node);</code> ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æµç¨‹å›¾ä¸­ä¸‹é¢çš„çº¢è‰²æ–¹å—ã€‚</p><h6 id="cancelAcquire-Node-node"><a href="#cancelAcquire-Node-node" class="headerlink" title="cancelAcquire(Node node)"></a>cancelAcquire(Node node)</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æ‹¿åˆ°èµ„æº</span></span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// çœç•¥</span></span><br><span class="line">        <span class="comment">// åœ¨ finally ä¼šå°†å½“å‰èŠ‚ç‚¹ç½®ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹ä¸å­˜åœ¨ ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å–æ¶ˆèŠ‚ç‚¹å…³è”çº¿ç¨‹</span></span><br><span class="line">    node.thread = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·³è¿‡å·²ç»å–æ¶ˆçš„èŠ‚ç‚¹ï¼Œè·å–å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„æœ‰æ•ˆèŠ‚ç‚¹</span></span><br><span class="line">    Node pred = node.prev;</span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„æœ‰æ•ˆèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    Node predNext = pred.next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå–æ¶ˆ</span></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹å¦‚æœæ˜¯å°¾èŠ‚ç‚¹ï¼Œåˆ™å°†æœ€åä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹ï¼Œå¹¶å°† predNext è®¾ç½®ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> ws;</span><br><span class="line">        <span class="comment">// pred ä¸æ˜¯å¤´èŠ‚ç‚¹(node çš„ä¸Šä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹ ä¸æ˜¯ head) &amp;&amp; ï¼ˆ predçš„çŠ¶æ€æ˜¯ SIGNAL ||  pred çš„çŠ¶æ€è®¾ç½®ä¸º SIGNAL æˆåŠŸ ï¼‰ &amp;&amp; pred çš„ç»‘å®šçº¿ç¨‹ä¸ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp; </span><br><span class="line">        ((ws = pred.waitStatus) == Node.SIGNAL || (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp; </span><br><span class="line">        pred.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">            Node next = node.next;</span><br><span class="line">            <span class="comment">// åç»§èŠ‚ç‚¹ä¸ä¸ºç©º ä¸” çŠ¶æ€æœ‰æ•ˆ å°† pred çš„ åç»§èŠ‚ç‚¹è®¾ç½®ä¸º å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// node çš„ä¸Šä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹ æ˜¯ headï¼Œ æˆ–è€…å…¶ä»–æƒ…å†µ å”¤é†’å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹</span></span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        node.next = node; <span class="comment">// help GC</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// å°†èŠ‚ç‚¹çŠ¶æ€æ›´æ–°ä¸º 0 </span></span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ ä¸€èˆ¬æ˜¯ä¸‹ä¸€ä¸ªèŠ‚ç‚¹åº”è¯¥å°±æ˜¯éœ€è¦å”¤é†’çš„èŠ‚ç‚¹ï¼Œå³é¢å‘è¯ä¹¦ã€‚</span></span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="comment">// å¤§äº 0  CANCELLED ï¼š çº¿ç¨‹å·²å–æ¶ˆ</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯æœ‰å¯èƒ½ åç»§èŠ‚ç‚¹ ä¸ºç©ºæˆ–è€…è¢«å–æ¶ˆäº†ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// ä»å°¾èŠ‚ç‚¹å¼€å§‹éå†ï¼Œç›´åˆ°å®šä½åˆ° t.waitStatus &lt;= 0 çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// å®šä½åˆ°åå¹¶ä¸ä¼šåœæ­¢ï¼Œä¼šç»§ç»­æ‰§è¡Œï¼Œç›¸å½“äºæ‰¾åˆ°æœ€å¼€å§‹çš„é‚£ä¸ªéœ€è¦å”¤é†’çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// t.waitStatus &lt;= 0 ï¼š SIGNALï¼ˆ -1 åç»­çº¿ç¨‹éœ€è¦é‡Šæ”¾ï¼‰ </span></span><br><span class="line">        <span class="comment">//                     CONDITION ï¼ˆ -2 çº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¡ä»¶ï¼‰ </span></span><br><span class="line">        <span class="comment">//                     PROPAGATE ï¼ˆ -3 releaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å®šä½åˆ°éœ€è¦å”¤é†’çš„èŠ‚ç‚¹å è¿›è¡Œ unpark</span></span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æµç¨‹åˆ†æï¼š</p><ol><li>æ‰¾åˆ°å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªéæ— æ•ˆèŠ‚ç‚¹ predï¼›</li><li>å½“å‰èŠ‚ç‚¹å¦‚æœæ˜¯å°¾èŠ‚ç‚¹ï¼Œåˆ™å°†æœ€åä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹ï¼Œå¹¶å°† predNext è®¾ç½®ä¸ºç©ºï¼›</li><li>pred ä¸æ˜¯å¤´èŠ‚ç‚¹ &amp;&amp; ï¼ˆ predçš„çŠ¶æ€æ˜¯ SIGNAL ||  pred çš„çŠ¶æ€è®¾ç½®ä¸º SIGNAL æˆåŠŸ ï¼‰ &amp;&amp; pred çš„ç»‘å®šçº¿ç¨‹ä¸ä¸ºç©ºï¼›</li><li>å…¶ä»–æƒ…å†µã€‚</li></ol><p>ä¸‹é¢åˆ†åˆ«ç”»å›¾ï¼š</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/1-RD0LEx.png" alt="1-RD0LEx"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/2-PHY9bi.png" alt="2-PHY9bi"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/3-rOnnvu.png" alt="3-rOnnvu"></p><p><strong>Q: é€šè¿‡å›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œåªæ“ä½œäº† next æŒ‡é’ˆï¼Œä½†æ˜¯æ²¡æœ‰æ“ä½œ prev æŒ‡é’ˆï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</strong></p><p><strong>A:</strong> åœ¨ <code>å‡ºé˜Ÿåˆ—ï¼šacquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code> æ–¹æ³•ä¸­ï¼Œ<code>shouldParkAfterFailedAcquire</code> æ–¹æ³•ä¼šåˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼ŒåŒæ—¶å–æ¶ˆåœ¨é˜Ÿåˆ—ä¸­å½“å‰èŠ‚ç‚¹å‰é¢æ— æ•ˆçš„èŠ‚ç‚¹ã€‚è¿™æ—¶å€™ä¼šç§»é™¤ä¹‹å‰çš„æ— æ•ˆèŠ‚ç‚¹ï¼Œæ­¤å¤„ä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢æŒ‡å‘ä¸€ä¸ªå·²ç»è¢«ç§»é™¤çš„èŠ‚ç‚¹ã€‚åŒæ—¶ä¿è¯ prev çš„ç¨³å®šï¼Œæœ‰åˆ©äºä» tail å¼€å§‹éå†åˆ—è¡¨ï¼Œè¿™å—åœ¨ <code>unparkSuccessor(node);</code> ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°æ˜¯ä»åå¾€å‰è¡¨é‡Œåˆ—è¡¨ã€‚</p><p><strong>Q: unparkSuccessor(Node node) ä¸ºä»€ä¹ˆä»åå¾€å‰éå†ï¼Ÿ</strong></p><p><strong>A:</strong></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/AQS-8IDBPX.png" alt="AQS-8IDBPX"></p><p>åœ¨ <code>addWaiter(Node.EXCLUSIVE)</code> æ’å…¥æ–°èŠ‚ç‚¹æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ <code>å°¾æ’æ³•</code>ï¼Œçœ‹çº¢æ¡†éƒ¨åˆ†ï¼Œæ­¤æ—¶æœ‰å¯èƒ½è¿˜æœªæŒ‡å‘nextã€‚</p><p><strong>Q: node.next = node; è¿™å—å¯¼è‡´ headä¸æ˜¯æŒ‡å‘æœ€æ–°èŠ‚ç‚¹ï¼Œé“¾è¡¨ä¸å°±æ–­äº†ä¹ˆï¼Ÿ</strong><br><strong>Aï¼š</strong> acquireQueued æ–¹æ³•ä»‹ç»ä¸­ï¼Œé‡Œé¢æœ‰ä¸ªå¾ªç¯ï¼Œä¼šä¸æ–­å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸä¹‹åä¼šè®¾ç½®ä¸º headã€‚å¹¶ä¸”åœ¨ shouldParkAfterFailedAcquire ä¸­ä¹Ÿä¼šæ¸…é™¤å½“å‰èŠ‚ç‚¹å‰çš„æ— æ•ˆèŠ‚ç‚¹ã€‚</p><h5 id="é‡Šæ”¾ç‹¬å èµ„æº-release"><a href="#é‡Šæ”¾ç‹¬å èµ„æº-release" class="headerlink" title="é‡Šæ”¾ç‹¬å èµ„æº release"></a>é‡Šæ”¾ç‹¬å èµ„æº release</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ç‹¬å æ¨¡å¼é‡Šæ”¾ã€‚ é€šè¿‡é‡Šæ”¾ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œå¦‚æœå®ç°tryReleaseè¿”å›trueã€‚ è¿™ç§æ–¹æ³•å¯ä»¥ç”¨æ¥å®ç°æ–¹æ³•Lock.unlock ã€‚</p><ol><li>tryRelease(arg) æ“ä½œé‡Šæ”¾èµ„æºï¼ŒåŒæ ·æ˜¯ç”±å­ç±»å®ç°ï¼Œåé¢ä»‹ç»å­ç±»æ—¶ä¼šè¿›è¡Œè¯´æ˜ã€‚è¿”å› true è¯´æ˜èµ„æºç°åœ¨å·²ç»æ²¡æœ‰çº¿ç¨‹æŒæœ‰äº†ï¼Œå…¶ä»–èŠ‚ç‚¹å¯ä»¥å°è¯•è·å–ï¼›</li><li>é‡Šæ”¾æˆåŠŸï¼Œä¸” head != null &amp;&amp; h.waitStatus != 0, ä¼šç»§ç»­æ‰§è¡Œ unparkSuccessor(h)ï¼›</li><li>è¿™å—ä¼šçœ‹åˆ° åªè¦ tryRelease(arg) æ“ä½œé‡Šæ”¾èµ„æºæˆåŠŸï¼Œ åé¢æ— è®ºæ‰§è¡Œæ˜¯å¦æˆåŠŸï¼Œéƒ½ä¼šè¿”å› trueï¼ŒunparkSuccessor(h) ç›¸å½“äºåªæ˜¯é™„åŠ æ“ä½œã€‚</li></ol><h4 id="å…±äº«æ¨¡å¼"><a href="#å…±äº«æ¨¡å¼" class="headerlink" title="å…±äº«æ¨¡å¼"></a>å…±äº«æ¨¡å¼</h4><h5 id="è·å–å…±äº«èµ„æº-acquireShared"><a href="#è·å–å…±äº«èµ„æº-acquireShared" class="headerlink" title="è·å–å…±äº«èµ„æº acquireShared"></a>è·å–å…±äº«èµ„æº acquireShared</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°äº 0 è¡¨ç¤ºè·å–èµ„æºå¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°èŠ‚ç‚¹ æ­¤å¤„æ˜¯å…±äº«èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node node = addWaiter(Node.SHARED);</span><br><span class="line">    <span class="comment">// æ ¹æ®æ˜¯å¦æ‹¿åˆ°èµ„æº åˆ¤æ–­æ˜¯å¦éœ€è¦å–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è¿”å›å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="comment">// å†æ¬¡å°è¯•è·å–å…±äº«èµ„æº</span></span><br><span class="line">                <span class="keyword">int</span> r = tryAcquireShared(arg);</span><br><span class="line">                <span class="comment">// è¡¨ç¤ºè·å–æˆåŠŸ</span></span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// è®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ å¹¶å°è¯•å”¤é†’åç»­èŠ‚ç‚¹</span></span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    <span class="comment">// é‡Šæ”¾å¤´èŠ‚ç‚¹ GC ä¼šå›æ”¶</span></span><br><span class="line">                    p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    <span class="keyword">if</span> (interrupted)</span><br><span class="line">                        selfInterrupt();</span><br><span class="line">                    failed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>tryAcquireShared(arg)ï¼Œå°è¯•è·å–èµ„æºï¼Œè¿™å—ç”±å­ç±»å®ç°ï¼›</li><li>è¿”å›å€¼åˆ†ä¸º 3 ç§ï¼š<ol><li>å°äº 0: è¡¨ç¤ºå¤±è´¥ï¼›</li><li>ç­‰äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œä½†åç»­çš„èŠ‚ç‚¹ä¸èƒ½ä»¥å…±äº«æ¨¡å¼è·å–æˆåŠŸ; </li><li>å¤§äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œåç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¹Ÿå¯èƒ½ä¼šæˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåç»­ç­‰å¾…çº¿ç¨‹å¿…é¡»æ£€æŸ¥å¯ç”¨æ€§ã€‚</li></ol></li><li>åœ¨å¤±è´¥åä¼šä½¿ç”¨ <code>doAcquireShared(arg);</code> ä¸æ–­è·å–èµ„æºï¼›</li><li><code>final Node node = addWaiter(Node.SHARED);</code> åŒæ ·ä¼šåˆ›å»ºèŠ‚ç‚¹ï¼›</li><li>åœ¨å¾ªç¯ä¸­ä¸æ–­åˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹å¦‚æœæ˜¯ headï¼Œåˆ™å°è¯•è·å–èµ„æºï¼›</li><li>åœ¨å…±äº«æ¨¡å¼ä¸‹è·å–åˆ°èµ„æºåä¼šä½¿ç”¨ <code>setHeadAndPropagate(node, r);</code> è®¾ç½®å¤´èŠ‚ç‚¹ï¼ŒåŒæ—¶å”¤é†’åç»­èŠ‚ç‚¹ã€‚</li></ol><h6 id="è®¾ç½®å¤´èŠ‚ç‚¹ï¼Œå¹¶ä¼ æ’­å”¤é†’åç»­èŠ‚ç‚¹"><a href="#è®¾ç½®å¤´èŠ‚ç‚¹ï¼Œå¹¶ä¼ æ’­å”¤é†’åç»­èŠ‚ç‚¹" class="headerlink" title="è®¾ç½®å¤´èŠ‚ç‚¹ï¼Œå¹¶ä¼ æ’­å”¤é†’åç»­èŠ‚ç‚¹"></a>è®¾ç½®å¤´èŠ‚ç‚¹ï¼Œå¹¶ä¼ æ’­å”¤é†’åç»­èŠ‚ç‚¹</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// node æ˜¯å½“å‰èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">// propagate æ˜¯ å‰ä¸€æ­¥ tryAcquireShared çš„è¿”å›å€¼ è¿›æ¥æ—¶ &gt;=0</span></span><br><span class="line"><span class="comment">// å¤§äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œåç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¹Ÿå¯èƒ½ä¼šæˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåç»­ç­‰å¾…çº¿ç¨‹å¿…é¡»æ£€æŸ¥å¯ç”¨æ€§ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setHeadAndPropagate</span><span class="params">(Node node, <span class="keyword">int</span> propagate)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è®°å½•ä¸‹å½“å‰å¤´èŠ‚ç‚¹</span></span><br><span class="line">    Node h = head; <span class="comment">// Record old head for check below</span></span><br><span class="line">    <span class="comment">// è®¾ç½®ä¼ å…¥ node ä¸ºå¤´èŠ‚ç‚¹</span></span><br><span class="line">    setHead(node);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ¡ä»¶ï¼Œå”¤é†’åç»­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// propagate &gt; 0 æœ‰åç»­èµ„æº</span></span><br><span class="line">    <span class="comment">// h == null æ—§çš„å¤´èŠ‚ç‚¹ å› ä¸ºå‰é¢ addWaiterï¼Œ è‚¯å®šä¸ä¼šä¸ºç©ºï¼Œåº”è¯¥æ˜¯é˜²æ­¢ h.waitStatus &lt; 0 ç©ºæŒ‡é’ˆçš„å†™æ³•</span></span><br><span class="line">    <span class="comment">// (h = head) == null å½“å‰çš„ å¤´èŠ‚ç‚¹ï¼Œå†åˆ¤æ–­çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// waitStatus &lt; 0 åç»­èŠ‚ç‚¹å°±éœ€è¦è¢«å”¤é†’</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">        (h = head) == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        Node s = node.next;</span><br><span class="line">        <span class="comment">// åç»­èŠ‚ç‚¹ä¸ºå…±äº«ï¼Œåˆ™éœ€è¦å”¤é†’</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.isShared())</span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="doReleaseShared-é‡Šæ”¾å…±äº«èµ„æº"><a href="#doReleaseShared-é‡Šæ”¾å…±äº«èµ„æº" class="headerlink" title="doReleaseShared() é‡Šæ”¾å…±äº«èµ„æº"></a>doReleaseShared() é‡Šæ”¾å…±äº«èµ„æº</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReleaseShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// ä»å¤´å¼€å§‹</span></span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå°±æ˜¯åˆšåˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="keyword">int</span> ws = h.waitStatus;</span><br><span class="line">            <span class="comment">// SIGNALï¼ˆ -1 åç»­çº¿ç¨‹éœ€è¦é‡Šæ”¾ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="comment">// å°†ç­‰å¾…çŠ¶æ€æ›´æ–°ä¸º 0 å¦‚æœå¤±è´¥ï¼Œä¼šå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;            <span class="comment">// loop to recheck cases</span></span><br><span class="line">                <span class="comment">// å”¤é†’åç»­èŠ‚ç‚¹ï¼Œ åŒæ—¶å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸º å–æ¶ˆ</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœçŠ¶æ€æ˜¯ 0 åˆ™ä¼šæ›´æ–°çŠ¶æ€ä¸º PROPAGATE</span></span><br><span class="line">            <span class="comment">// PROPAGATE ï¼ˆ -3 releaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp; !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;                <span class="comment">// loop on failed CAS</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­å¤´èŠ‚ç‚¹æœ‰æ²¡æœ‰å˜åŒ–ï¼Œæœ‰å˜åŒ– æ˜¯å› ä¸ºç«äº‰ï¼Œåˆ«çš„çº¿ç¨‹è·å–åˆ°äº†é”ï¼Œä¼šç»§ç»­å¾ªç¯</span></span><br><span class="line">        <span class="comment">// æ²¡æœ‰å˜åŒ–ç›´æ¥ç»“æŸ</span></span><br><span class="line">        <span class="keyword">if</span> (h == head)                   <span class="comment">// loop if head changed</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>ä»å¤´èŠ‚ç‚¹å¼€å§‹è¿›è¡Œï¼Œå¦‚æœ h != null &amp;&amp; h != tail è¯´æ˜é˜Ÿåˆ—ä¸æ˜¯ç©ºæˆ–è€…åˆšåˆå§‹åŒ–ï¼›</li><li>èŠ‚ç‚¹çŠ¶æ€ä¸º SIGNALï¼ˆ -1 ï¼‰è¯´æ˜åç»­çº¿ç¨‹éœ€è¦é‡Šæ”¾ï¼›</li><li>ä¼šæ›´æ”¹å½“å‰èŠ‚ç‚¹çŠ¶æ€ï¼ŒæˆåŠŸåå”¤é†’åç»­èŠ‚ç‚¹ï¼Œå¤±è´¥åˆ™ç»§ç»­å¾ªç¯ï¼›</li><li>èŠ‚ç‚¹çŠ¶æ€å¦‚æœæ˜¯ 0 åˆ™æ›´æ–°ä¸º PROPAGATEï¼Œä¼šå°†çŠ¶æ€ä¼ æ’­ã€‚</li></ol><h5 id="é‡Šæ”¾å…±äº«èµ„æº-releaseShared"><a href="#é‡Šæ”¾å…±äº«èµ„æº-releaseShared" class="headerlink" title="é‡Šæ”¾å…±äº«èµ„æº releaseShared"></a>é‡Šæ”¾å…±äº«èµ„æº releaseShared</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾å…±äº«èµ„æº</span></span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥å…±äº«æ¨¡å¼é‡Šæ”¾ã€‚ é€šè¿‡é‡Šæ”¾ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œå¦‚æœå®ç°tryReleaseSharedè¿”å›trueã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><strong>Q: AQS åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</strong><br><strong>A:</strong> AQS å†…éƒ¨æä¾›äº†ä¸€ä¸ªå…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰åŒå‘ç­‰å¾…é˜Ÿåˆ—ï¼Œå†…éƒ¨ä¾é  Node å®ç°ï¼Œå¹¶æä¾›äº†åœ¨<code>ç‹¬å æ¨¡å¼</code>å’Œ<code>å…±äº«æ¨¡å¼</code>ä¸‹çš„å‡ºå…¥é˜Ÿåˆ—çš„å…¬å…±æ–¹æ³•ã€‚è€Œå…³äºçŠ¶æ€ä¿¡æ¯ state çš„å®šä¹‰æ˜¯ç”±å­ç±»å®ç°ã€‚tryAcquireã€tryReleaseã€tryAcquireSharedã€tryReleaseSharedç­‰å°è¯•è·å–èµ„æºæ“ä½œéƒ½æ˜¯ç”±å­ç±»è¿›è¡Œå®šä¹‰å’Œå®ç°çš„ã€‚è€Œ AQS ä¸­æä¾›äº†å­ç±»è·å–èµ„æºä¹‹åçš„ç›¸å…³æ“ä½œï¼ŒåŒ…æ‹¬èŠ‚ç‚¹ Node çš„å‡ºå…¥é˜Ÿåˆ—ï¼Œè‡ªæ—‹è·å–èµ„æºç­‰ç­‰ã€‚</p><p><strong>Q: AQS è·å–èµ„æºå¤±è´¥åä¼šå¦‚ä½•æ“ä½œï¼Ÿ</strong><br><strong>A:</strong> çº¿ç¨‹è·å–èµ„æºå¤±è´¥åï¼Œä¼šæ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåœ¨é˜Ÿåˆ—ä¸­ä¼šä¸æ–­å°è¯•è·å–èµ„æºï¼ˆè‡ªæ—‹ï¼‰ï¼Œè¯´æ˜çº¿ç¨‹åªæ˜¯è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œåé¢è¿˜æ˜¯å¯ä»¥å†æ¬¡è·å–èµ„æºçš„ã€‚</p><p><strong>Q: AQS ç­‰å¾…é˜Ÿåˆ—çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ</strong><br><strong>A:</strong> CLHå˜ä½“çš„å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰åŒå‘ç­‰å¾…é˜Ÿåˆ—ã€‚ï¼ˆCLHé”æ˜¯ä¸€ä¸ªè‡ªæ—‹é”ã€‚èƒ½ç¡®ä¿æ— é¥¥é¥¿æ€§ã€‚æä¾›å…ˆæ¥å…ˆæœåŠ¡çš„å…¬å¹³æ€§ã€‚æ˜¯ä¸€ç§åŸºäºé“¾è¡¨çš„å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ï¼Œç”³è¯·çº¿ç¨‹ä»…ä»…åœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œå®ƒä¸æ–­è½®è¯¢å‰é©±çš„çŠ¶æ€ï¼Œå¦‚æœå‘ç°å‰é©±é‡Šæ”¾äº†é”å°±ç»“æŸè‡ªæ—‹ã€‚ï¼‰</p><p><strong>Q: AQS ç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹å¦‚ä½•è·å–è·å–å’Œé‡Šæ”¾èµ„æºçš„ï¼Ÿ</strong><br><strong>A:</strong> å¯ä»¥çœ‹ä¸‹<code>ç‹¬å æ¨¡å¼</code>ä¸­çš„è®²è¿°è¿‡ç¨‹ï¼Œé€šè¿‡ä»£ç æ¢³ç†ã€‚</p><p>æœ¬æ–‡åˆ†åˆ«ä» <code>ç‹¬å æ¨¡å¼</code> å’Œ <code>å…±äº«æ¨¡å¼</code>ä»‹ç»çš„ AQS åŸºæœ¬é€»è¾‘ï¼Œå¹¶é€šè¿‡æºç å’Œä½œå›¾ç†è§£åŸºæœ¬æ€è·¯ã€‚ä½†æ˜¯å¹¶æ²¡æœ‰å¯¹éœ€è¦å­ç±»å®ç°çš„ä¸šåŠ¡é€»è¾‘åšä»‹ç»ã€‚è¿™å—ä¼šåœ¨åé¢ä»‹ç» <code>ReentrantLock</code>ã€<code>CountDownLatch</code> ç­‰å­ç±»çš„æ—¶å€™åšä»‹ç»ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- JUC åŒ…ä¸‹å·¥å…·ç±»ï¼Œå®ƒçš„åå­—å« LockSupport ï¼ä½ é€ ä¹ˆï¼Ÿ</title>
      <link href="2020/07/05/source-code-locksupport.html"/>
      <url>2020/07/05/source-code-locksupport.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>LockSupport æ˜¯ JUC ä¸­å¸¸ç”¨çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œä¸»è¦ä½œç”¨æ˜¯æŒ‚èµ·å’Œå”¤é†’çº¿ç¨‹ã€‚åœ¨é˜…è¯» JUC æºç ä¸­ç»å¸¸çœ‹åˆ°ï¼Œæ‰€ä»¥å¾ˆæœ‰å¿…è¦äº†è§£ä¸€ä¸‹ã€‚</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><blockquote><p>åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»ã€‚Basic thread blocking primitives for creating locks and other synchronization classes.</p></blockquote><blockquote><p>LockSupport ç±»æ¯ä¸ªä½¿ç”¨å®ƒçš„çº¿ç¨‹å…³è”ä¸€ä¸ªè®¸å¯ï¼ˆåœ¨æ„ä¹‰ä¸Šçš„Semaphoreç±»ï¼‰ã€‚ å¦‚æœè®¸å¯å¯ç”¨ï¼Œè°ƒç”¨ park å°†ç«‹å³è¿”å›ï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­æ¶ˆè´¹å®ƒ; å¦åˆ™å¯èƒ½é˜»å¡ã€‚å¦‚æœè®¸å¯ä¸æ˜¯å¯ç”¨ï¼Œå¯ä»¥è°ƒç”¨ unpark ä½¿å¾—è®¸å¯å¯ç”¨ã€‚ï¼ˆä½†ä¸Semaphoreä¸åŒï¼Œè®¸å¯ä¸èƒ½ç´¯ç§¯ã€‚æœ€å¤šæœ‰ä¸€ä¸ªã€‚ï¼‰</p><p>æ–¹æ³• park å’Œ unpark æä¾›äº†é˜»å¡çš„æœ‰æ•ˆæ‰‹æ®µå’Œè§£é”çº¿ç¨‹ä¸ä¼šé‡åˆ°æ­»é”é—®é¢˜ï¼Œè€Œ Thread.suspend å’Œ Thread.resume æ˜¯ä¸èƒ½ç”¨äºè¿™ç§ç›®çš„ï¼šå› ä¸ºè®¸å¯çš„å­˜åœ¨ï¼Œä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ park å’Œå¦ä¸€ä¸ªçº¿ç¨‹è¯•å›¾ unpark å®ƒä¹‹é—´çš„ç«äº‰å°†ä¿æŒæ´»æ€§ã€‚ æ­¤å¤–ï¼Œå¦‚æœè°ƒç”¨è€…çº¿ç¨‹è¢«ä¸­æ–­ï¼Œpark å°†è¿”å›ï¼Œå¹¶ä¸”æ”¯æŒè®¾ç½®è¶…æ—¶ã€‚ è¯¥ park æ–¹æ³•ä¹Ÿå¯èƒ½è¿”å›åœ¨å…¶ä»–ä»»ä½•æ—¶é—´ï¼Œâ€œæ¯«æ— ç†ç”±â€ï¼Œå› æ­¤é€šå¸¸å¿…é¡»åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è°ƒç”¨çš„è¿”å›åé‡æ–°æ£€æŸ¥æ¡ä»¶ã€‚ åœ¨è¿™ä¸ªæ„ä¹‰ä¸Šparkä½œä¸ºâ€œå¿™ç¢Œç­‰å¾…â€ä¸ä¼šæµªè´¹å¤ªå¤šçš„æ—¶é—´è‡ªæ—‹çš„ä¼˜åŒ–ï¼Œä½†å¿…é¡»ä»¥é…å¯¹ unpark ä½¿ç”¨ã€‚</p><p>è¿™ä¸‰ç§å½¢å¼çš„ park è¿˜æ”¯æŒ blocker å¯¹è±¡å‚æ•°ã€‚è€Œçº¿ç¨‹è¢«é˜»å¡æ—¶æ˜¯å…è®¸ä½¿ç”¨ç›‘æµ‹å’Œè¯Šæ–­å·¥å…·ï¼Œä»¥ç¡®å®šçº¿ç¨‹è¢«é˜»å¡çš„åŸå› ã€‚ï¼ˆè¯Šæ–­å·¥å…·å¯ä»¥ä½¿ç”¨getBlocker(Thread) æ–¹æ³• ã€‚ï¼‰åŒæ—¶æ¨èä½¿ç”¨å¸¦æœ‰ blocker å‚æ•°çš„ parkæ–¹æ³•ï¼Œé€šå¸¸åšæ³•æ˜¯ blocker è¢«è®¾ç½®ä¸º this ã€‚</p></blockquote><p>ä¸Šé¢çš„æ„æ€æ€»ç»“ä¸‹æ¥ä¸ªäººç†è§£æ˜¯ï¼š</p><ol><li>è®¸å¯ï¼ˆpermitï¼‰çš„ä¸Šé™æ˜¯1ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰ 0 æˆ– 1 ã€‚</li><li>park: æ²¡æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 0 ï¼Œè°ƒç”¨ park ä¼šé˜»å¡ï¼›æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 1 ï¼Œ è°ƒç”¨ park ä¼šæ‰£é™¤ä¸€ä¸ªè®¸å¯ï¼Œç„¶åè¿”å›ã€‚</li><li>unparkï¼šæ²¡æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 0 ï¼Œè°ƒç”¨ unpark ä¼šå¢åŠ ä¸€ä¸ªè®¸å¯ï¼Œå› ä¸ºè®¸å¯ä¸Šé™æ˜¯ 1 ï¼Œ æ‰€ä»¥è°ƒç”¨å¤šæ¬¡ä¹Ÿåªä¼šä¸º 1 ä¸ªã€‚</li><li>çº¿ç¨‹åˆå§‹çš„æ—¶å€™æ˜¯æ²¡æœ‰è®¸å¯çš„ã€‚</li><li>park çš„å½“å‰çº¿ç¨‹å¦‚æœè¢«ä¸­æ–­ï¼Œä¼šç«‹å³è¿”å›ï¼Œå¹¶ä¸ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚</li><li>park æ–¹æ³•çš„è°ƒç”¨ä¸€èˆ¬è¦æ”¾åœ¨ä¸€ä¸ªå¾ªç¯åˆ¤æ–­ä½“é‡Œé¢ã€‚</li></ol><p>å¤§æ¦‚å¦‚å›¾æ‰€ç¤ºï¼š</p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/rGm1AX.png" align=center /><p>ä¸‹é¢æ˜¯æºç æ³¨é‡Šä¸­çš„æ¡ˆä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FIFO ç‹¬å é”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FIFOMutex</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean locked = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Thread&gt; waiters = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;Thread&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">boolean</span> wasInterrupted = <span class="keyword">false</span>;</span><br><span class="line">     Thread current = Thread.currentThread();</span><br><span class="line">     waiters.add(current);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Block while not first in queue or cannot acquire lock</span></span><br><span class="line">     <span class="comment">// ä¸åœ¨é˜Ÿåˆ—å¤´ï¼Œæˆ–è€…é”è¢«å ç”¨ï¼Œåˆ™é˜»å¡ï¼Œ å°±æ˜¯åªæœ‰é˜Ÿåˆ—å¤´çš„å¯ä»¥è·å¾—é”</span></span><br><span class="line">     <span class="keyword">while</span> (waiters.peek() != current || !locked.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">       LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">       <span class="keyword">if</span> (Thread.interrupted()) <span class="comment">// ignore interrupts while waiting</span></span><br><span class="line">         wasInterrupted = <span class="keyword">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     waiters.remove();</span><br><span class="line">     <span class="keyword">if</span> (wasInterrupted)          <span class="comment">// reassert interrupt status on exit</span></span><br><span class="line">       current.interrupt();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     locked.set(<span class="keyword">false</span>);</span><br><span class="line">     LockSupport.unpark(waiters.peek());</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><h4 id="çº¿ç¨‹åˆå§‹æœ‰æ²¡æœ‰è®¸å¯ï¼Ÿ"><a href="#çº¿ç¨‹åˆå§‹æœ‰æ²¡æœ‰è®¸å¯ï¼Ÿ" class="headerlink" title="çº¿ç¨‹åˆå§‹æœ‰æ²¡æœ‰è®¸å¯ï¼Ÿ"></a>çº¿ç¨‹åˆå§‹æœ‰æ²¡æœ‰è®¸å¯ï¼Ÿ</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockSupportTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;å¼€å§‹æ‰§è¡Œâ€¦â€¦&quot;</span>);</span><br><span class="line"></span><br><span class="line">        LockSupport.park();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;LockSupport park ä¹‹åâ€¦â€¦&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æ‰§è¡Œåä¼šå‘ç°ï¼Œä»£ç åœ¨ park å¤„é˜»å¡ã€‚è¯´æ˜ï¼Œçº¿ç¨‹åˆå§‹æ˜¯æ²¡æœ‰è®¸å¯çš„ã€‚</li></ol><h4 id="æ·»åŠ è®¸å¯å¹¶æ¶ˆè€—è®¸å¯"><a href="#æ·»åŠ è®¸å¯å¹¶æ¶ˆè€—è®¸å¯" class="headerlink" title="æ·»åŠ è®¸å¯å¹¶æ¶ˆè€—è®¸å¯"></a>æ·»åŠ è®¸å¯å¹¶æ¶ˆè€—è®¸å¯</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockSupportTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;å¼€å§‹æ‰§è¡Œâ€¦â€¦&quot;</span>);</span><br><span class="line"></span><br><span class="line">        LockSupport.unpark(Thread.currentThread());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œ - park&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        LockSupport.park();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;LockSupport park ä¹‹åâ€¦â€¦&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockSupportTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;å¼€å§‹æ‰§è¡Œ park&quot;</span>);</span><br><span class="line">                LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;æ‰§è¡Œ park ç»“æŸ&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        thread.start();</span><br><span class="line">        <span class="comment">// ä¿è¯ ä¸Šé¢çº¿ç¨‹å…ˆæ‰§è¡Œï¼Œç„¶åå†ä¸»çº¿ç¨‹</span></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;å¼€å§‹æ‰§è¡Œ unpark(thread)&quot;</span>);</span><br><span class="line">        LockSupport.unpark(thread);</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œ unpark(thread) ç»“æŸ&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢ç¤ºä¾‹å¯ä»¥çœ‹å‡ºï¼š</p><ol><li>æ‰§è¡Œ unpark å¯ä»¥è¿›è¡Œç»™äºˆæŒ‡å®šçº¿ç¨‹ä¸€ä¸ªè¯ä¹¦ã€‚</li><li>çº¿ç¨‹å½“å‰è¢« park é˜»å¡ï¼Œæ­¤æ—¶ç»™äºˆè¯ä¹¦ä¹‹åï¼Œ park ä¼šæ¶ˆè€—è¯ä¹¦ï¼Œç„¶åç»§ç»­æ‰§è¡Œã€‚</li></ol><h4 id="è®¸å¯ä¸Šé™ä¸º-1"><a href="#è®¸å¯ä¸Šé™ä¸º-1" class="headerlink" title="è®¸å¯ä¸Šé™ä¸º 1"></a>è®¸å¯ä¸Šé™ä¸º 1</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockSupportTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;unpark 1æ¬¡&quot;</span>);</span><br><span class="line">        LockSupport.unpark(Thread.currentThread());</span><br><span class="line">        System.out.println(<span class="string">&quot;unpark 2æ¬¡&quot;</span>);</span><br><span class="line">        LockSupport.unpark(Thread.currentThread());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œ - park 1 æ¬¡&quot;</span>);</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œ - park 2 æ¬¡&quot;</span>);</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;LockSupport park ä¹‹åâ€¦â€¦&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>çº¿ç¨‹é˜»å¡ï¼Œå¯ä»¥çœ‹å‡º permit åªèƒ½æœ‰ä¸€ä¸ª</li></ol><h4 id="ä¸­æ–­å¯ä»¥ä½¿-park-ç»§ç»­æ‰§è¡Œå¹¶ä¸ä¼šæŠ›å‡ºå¼‚å¸¸"><a href="#ä¸­æ–­å¯ä»¥ä½¿-park-ç»§ç»­æ‰§è¡Œå¹¶ä¸ä¼šæŠ›å‡ºå¼‚å¸¸" class="headerlink" title="ä¸­æ–­å¯ä»¥ä½¿ park ç»§ç»­æ‰§è¡Œå¹¶ä¸ä¼šæŠ›å‡ºå¼‚å¸¸"></a>ä¸­æ–­å¯ä»¥ä½¿ park ç»§ç»­æ‰§è¡Œå¹¶ä¸ä¼šæŠ›å‡ºå¼‚å¸¸</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockSupportTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;å¼€å§‹æ‰§è¡Œ park&quot;</span>);</span><br><span class="line">                LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;æ‰§è¡Œ park ç»“æŸ&quot;</span>);</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;å¼€å§‹æ‰§è¡Œ park ç¬¬äºŒæ¬¡&quot;</span>);</span><br><span class="line">                LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;æ‰§è¡Œ park ç¬¬äºŒæ¬¡ ç»“æŸ&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            thread.start();</span><br><span class="line">            <span class="comment">// ä¿è¯ ä¸Šé¢çº¿ç¨‹å…ˆæ‰§è¡Œï¼Œç„¶åå†ä¸»çº¿ç¨‹</span></span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;å¼€å§‹æ‰§è¡Œ unpark(thread)&quot;</span>);</span><br><span class="line">            <span class="comment">// LockSupport.unpark(thread);</span></span><br><span class="line">            thread.interrupt();</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰§è¡Œ unpark(thread) ç»“æŸ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">/Library/Java/JavaVirtualMachines/jdk1.8.0_221.jdk/Contents/Home/bin/java ...</span><br><span class="line">çº¿ç¨‹ Thread-0å¼€å§‹æ‰§è¡Œ park</span><br><span class="line">å¼€å§‹æ‰§è¡Œ unpark(thread)</span><br><span class="line">çº¿ç¨‹ Thread-0æ‰§è¡Œ park ç»“æŸ</span><br><span class="line">çº¿ç¨‹ Thread-0å¼€å§‹æ‰§è¡Œ park ç¬¬äºŒæ¬¡</span><br><span class="line">çº¿ç¨‹ Thread-0æ‰§è¡Œ park ç¬¬äºŒæ¬¡ ç»“æŸ</span><br><span class="line">æ‰§è¡Œ unpark(thread) ç»“æŸ</span><br></pre></td></tr></table></figure><ol><li>å¯ä»¥çœ‹å‡ºçº¿ç¨‹ä¸­æ–­ï¼Œpark ä¼šç»§ç»­æ‰§è¡Œï¼Œå¹¶ä¸”æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ã€‚</li><li>thread.interrupt(); è°ƒç”¨ä¹‹åï¼Œ è®¾ç½®çº¿ç¨‹ä¸­æ–­æ ‡ç¤ºï¼Œunpark æ²¡æœ‰æ¸…é™¤ä¸­æ–­æ ‡ç¤ºï¼Œç¬¬äºŒä¸ª park ä¹Ÿä¼šç»§ç»­æ‰§è¡Œã€‚</li></ol><h4 id="ä½¿ç”¨è¯Šæ–­å·¥å…·"><a href="#ä½¿ç”¨è¯Šæ–­å·¥å…·" class="headerlink" title="ä½¿ç”¨è¯Šæ–­å·¥å…·"></a>ä½¿ç”¨è¯Šæ–­å·¥å…·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">liuzhihang % &gt; jps</span><br><span class="line">76690 LockSupportTest</span><br><span class="line">77130 Jps</span><br><span class="line">liuzhihang % &gt; jstack 77265</span><br><span class="line">...</span><br><span class="line"><span class="string">&quot;main&quot;</span> <span class="comment">#1 prio=5 os_prio=31 tid=0x00007f7f3e80a000 nid=0xe03 waiting on condition [0x000070000dfcd000]</span></span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">        at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:304)</span><br><span class="line">        at com.liuzhihang.source.LockSupportTest.main(LockSupportTest.java:14)</span><br></pre></td></tr></table></figure><ol><li>ä¸­é—´çœç•¥éƒ¨åˆ†ï¼Œä½†æ˜¯å¯ä»¥çœ‹å‡ºçº¿ç¨‹è¿›å…¥ <code>WAITING</code> çŠ¶æ€</li></ol><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸ºçº¿ç¨‹ thread è®¾ç½®ä¸€ä¸ªè®¸å¯</span></span><br><span class="line"><span class="comment">     * æ— è®¸å¯ï¼Œåˆ™æ·»åŠ ä¸€ä¸ªè®¸å¯ï¼Œæœ‰è®¸å¯ï¼Œåˆ™ä¸æ·»åŠ </span></span><br><span class="line"><span class="comment">     * å¦‚æœçº¿ç¨‹å› ä¸º park è¢«é˜»å¡ï¼Œ æ·»åŠ è®¸å¯ä¹‹åï¼Œä¼šè§£é™¤é˜»å¡çŠ¶æ€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unpark</span><span class="params">(Thread thread)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (thread != <span class="keyword">null</span>)</span><br><span class="line">            UNSAFE.unpark(thread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ‰è®¸å¯ï¼Œåˆ™ä½¿ç”¨è¯¥è®¸å¯</span></span><br><span class="line"><span class="comment">     * æ²¡æœ‰è®¸å¯ï¼Œé˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°è·å¾—è®¸å¯</span></span><br><span class="line"><span class="comment">     * ä¼ é€’ blocker æ˜¯ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨è¯Šæ–­å·¥å…·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">park</span><span class="params">(Object blocker)</span> </span>&#123;</span><br><span class="line">        Thread t = Thread.currentThread();</span><br><span class="line">        setBlocker(t, blocker);</span><br><span class="line">        UNSAFE.park(<span class="keyword">false</span>, <span class="number">0L</span>);</span><br><span class="line">        setBlocker(t, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®çº¿ç¨‹çš„ blocker å±æ€§</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setBlocker</span><span class="params">(Thread t, Object arg)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Even though volatile, hotspot doesn&#x27;t need a write barrier here.</span></span><br><span class="line">        UNSAFE.putObject(t, parkBlockerOffset, arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LockSupport çš„ park unpark æ–¹æ³•ï¼Œå®é™…è°ƒç”¨çš„æ˜¯åº•å±‚ Unsafe ç±»çš„ native æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Unsafe</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">unpark</span><span class="params">(Object var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">park</span><span class="params">(<span class="keyword">boolean</span> var1, <span class="keyword">long</span> var2)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶è°ƒç”¨äº† Unsafe åˆ°æ­¤å¤„è‚¯å®šä¸èƒ½å–„ç½¢ç”˜ä¼‘ã€‚</p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ffecad2c8644bab7d152be118c31722d.jpg" align=center /><h4 id="hotspot-æºç "><a href="#hotspot-æºç " class="headerlink" title="hotspot æºç "></a>hotspot æºç </h4><p>è¿™å—æ˜¯ä¸‹è½½çš„å®˜æ–¹åŒ…ä¸­çš„æºç ï¼Œé˜…è¯»å¹¶æŸ¥é˜…èµ„æ–™äº†è§£çš„å¤§æ¦‚é€»è¾‘ï¼Œä¸æ¸…æ¥šä¹‹å¤„ï¼Œå¸Œæœ›æŒ‡å¯¼å‡ºæ¥ã€‚</p><p>ä¹Ÿå¯ä»¥ç›´æ¥è·³è¿‡ç›´æ¥çœ‹ç»“è®ºã€‚</p><p>æŸ¥çœ‹jdkæºç <br><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/5a83b7215107/src/share/vm/runtime/park.hpp">http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/5a83b7215107/src/share/vm/runtime/park.hpp</a></p><p>è¿™å—åœ¨ä»¥ os_linux ä»£ç ä¸ºä¾‹<br><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/5a83b7215107/src/os/linux/vm/os_linux.cpp">http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/5a83b7215107/src/os/linux/vm/os_linux.cpp</a></p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/c-parker.png" align=center /><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/c-park.png" align=center /><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/c-unpark.png" align=center /><ol><li>åœ¨åº•å±‚ç»´æŠ¤äº†ä¸€ä¸ª <code>_counter</code> é€šè¿‡æ›´æ–° <code>_counter</code> çš„å€¼æ¥æ ‡ç¤ºæ˜¯å¦æœ‰è¯æ˜ã€‚</li><li>åœ¨ park æ—¶ï¼Œåˆ¤æ–­ <code>_counter</code> ä¸º 0ï¼Œåˆ™é˜»å¡ç­‰å¾…ï¼Œä¸º 1 åˆ™è·å¾—æ›´æ–°ä¸º 0 å¹¶è¿”å›ã€‚</li><li>åœ¨ unpark æ—¶ï¼Œåˆ¤æ–­ <code>_counter</code> ä¸º 0ï¼Œåˆ™ç»™äºˆå‡­è¯ï¼Œå¹¶å”¤é†’çº¿ç¨‹ï¼Œä¸º 1 åˆ™ç›´æ¥è¿”å›ã€‚</li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ€»ç»“ä¹Ÿæ˜¯å’Œé¢„æƒ³çš„æ˜¯ç›¸åŒçš„ã€‚</p><ol><li>è®¸å¯ï¼ˆpermitï¼‰çš„ä¸Šé™æ˜¯1ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰ 0 æˆ– 1 ã€‚</li><li>park: æ²¡æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 0 ï¼Œè°ƒç”¨ park ä¼šé˜»å¡ï¼›æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 1 ï¼Œ è°ƒç”¨ park ä¼šæ‰£é™¤ä¸€ä¸ªè®¸å¯ï¼Œç„¶åè¿”å›ã€‚</li><li>unparkï¼šæ²¡æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 0 ï¼Œè°ƒç”¨ unpark ä¼šå¢åŠ ä¸€ä¸ªè®¸å¯ï¼Œå› ä¸ºè®¸å¯ä¸Šé™æ˜¯ 1 ï¼Œ æ‰€ä»¥è°ƒç”¨å¤šæ¬¡ä¹Ÿåªä¼šä¸º 1 ä¸ªã€‚</li><li>çº¿ç¨‹åˆå§‹çš„æ—¶å€™æ˜¯æ²¡æœ‰è®¸å¯çš„ã€‚</li><li>park çš„å½“å‰çº¿ç¨‹å¦‚æœè¢«ä¸­æ–­ï¼Œä¼šç«‹å³è¿”å›ï¼Œå¹¶ä¸ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚</li></ol><h4 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h4><ul><li>park/unpark å’Œ wait/notify åŒºåˆ«</li></ul><ol><li>park é˜»å¡å½“å‰çº¿ç¨‹ï¼Œunpark å”¤é†’æŒ‡å®šçº¿ç¨‹ã€‚</li><li>wait() éœ€è¦ç»“åˆé”ä½¿ç”¨ï¼Œå¹¶é‡Šæ”¾é”èµ„æºï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œåˆ™éœ€è¦ notify() å”¤é†’ã€‚è€Œ notify() æ˜¯éšæœºå”¤é†’çº¿ç¨‹ã€‚ </li></ol>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- JDK 8 æ–°å¢çš„ LongAdderï¼Œå¾—è¿‡æ¥çœ‹ä¸€ä¸‹ï¼</title>
      <link href="2020/06/28/source-code-longadder.html"/>
      <url>2020/06/28/source-code-longadder.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>åœ¨ä»‹ç» AtomicInteger æ—¶ï¼Œå·²ç»è¯´æ˜åœ¨é«˜å¹¶å‘ä¸‹å¤§é‡çº¿ç¨‹å»ç«äº‰æ›´æ–°åŒä¸€ä¸ªåŸå­å˜é‡æ—¶ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ›´æ–°æˆåŠŸï¼Œå…¶ä»–çš„çº¿ç¨‹åœ¨ç«äº‰å¤±è´¥åï¼Œåªèƒ½ä¸€ç›´å¾ªç¯ï¼Œä¸æ–­çš„è¿›è¡Œ CAS å°è¯•ï¼Œä»è€Œæµªè´¹äº† CPU èµ„æºã€‚è€Œåœ¨ JDK 8 ä¸­æ–°å¢äº† LongAdder ç”¨æ¥è§£å†³é«˜å¹¶å‘ä¸‹å˜é‡çš„åŸå­æ“ä½œã€‚ä¸‹é¢åŒæ ·é€šè¿‡é˜…è¯»æºç æ¥äº†è§£ LongAdder ã€‚</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>ä¸€ä¸ªæˆ–å¤šä¸ªå˜é‡å…±åŒç»´æŒåˆå€¼ä¸º 0 æ€»å’Œã€‚ å½“è·¨çº¿ç¨‹ç«äº‰æ›´æ–°æ—¶ï¼Œå˜é‡é›†å¯ä»¥åŠ¨æ€å¢é•¿ä»¥å‡å°‘ç«äº‰ã€‚ æ–¹æ³• sum è¿”å›å½“å‰å˜é‡é›†çš„æ€»å’Œã€‚</p><p>å½“å¤šä¸ªçº¿ç¨‹æ›´æ–°æ—¶ï¼Œè¿™ä¸ªç±»æ˜¯é€šå¸¸ä¼˜é€‰ AtomicLong ï¼Œæ¯”å¦‚ç”¨äºæ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼Œä¸ç”¨äºç»†ç²’åº¦åŒæ­¥æ§åˆ¶çš„å…±åŒæ€»å’Œã€‚ åœ¨ä½æ›´æ–°ç«äº‰ï¼Œè¿™ä¸¤ä¸ªç±»å…·æœ‰ç›¸ä¼¼çš„ç‰¹å¾ã€‚ ä½†åœ¨é«˜æ›´æ–°ç«äº‰æ—¶ï¼Œä½¿ç”¨ LongAdder æ€§èƒ½è¦é«˜äº AtomicLongï¼ŒåŒæ ·è¦æ¶ˆè€—æ›´é«˜çš„ç©ºé—´ä¸ºä»£ä»·ã€‚</p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/longadder-uml.png" align=center /><p>LongAdder ç»§æ‰¿äº† Striped64ï¼Œå†…éƒ¨ç»´æŠ¤ä¸€ä¸ª Cells æ•°ç»„ï¼Œç›¸å½“äºå¤šä¸ª Cell å˜é‡ï¼Œ æ¯ä¸ª Cell é‡Œé¢éƒ½æœ‰ä¸€ä¸ªåˆå§‹å€¼ä¸º 0 çš„ long å‹å˜é‡ã€‚</p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="Cell-ç±»"><a href="#Cell-ç±»" class="headerlink" title="Cell ç±»"></a>Cell ç±»</h4><p>Cell ç±» æ˜¯ Striped64 çš„é™æ€å†…éƒ¨ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Cell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">    Cell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">cas</span><span class="params">(<span class="keyword">long</span> cmp, <span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, valueOffset, cmp, val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unsafe mechanics</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            Class&lt;?&gt; ak = Cell.class;</span><br><span class="line">            valueOffset = UNSAFE.objectFieldOffset</span><br><span class="line">                (ak.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>Cell ä½¿ç”¨ @sun.misc.Contended æ³¨è§£ã€‚</li><li>å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªè¢« volatile ä¿®é¥°çš„ long å‹ value ã€‚</li><li>æä¾› cas æ–¹æ³•ï¼Œæ›´æ–°valueã€‚</li></ol><p>å…¶ä¸­ @sun.misc.Contended æ³¨è§£ä½œç”¨æ˜¯ä¸ºäº†å‡å°‘ç¼“å­˜äº‰ç”¨ã€‚ä»€ä¹ˆæ˜¯ç¼“å­˜äº‰ç”¨ï¼Œè¿™é‡Œåªåšä¸‹ç®€è¦ä»‹ç»ã€‚</p><blockquote><p>ä¼ªå…±äº«<br>CPU å­˜åœ¨å¤šçº§ç¼“å­˜ï¼Œå…¶ä¸­æœ€å°å­˜å‚¨å•å…ƒæ˜¯ Cache Lineï¼Œæ¯ä¸ª Cache Line èƒ½å­˜å‚¨ 64 ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚<br>åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼ŒA B ä¸¤ä¸ªçº¿ç¨‹æ•°æ®å¦‚æœè¢«å­˜å‚¨åˆ°åŒä¸€ä¸ª Cache Line ä¸Šï¼Œæ­¤æ—¶ A B æ›´æ–°å„è‡ªçš„æ•°æ®ï¼Œå°±ä¼šå‘ç”Ÿç¼“å­˜äº‰ç”¨ï¼Œå¯¼è‡´å¤šä¸ªçº¿ç¨‹ä¹‹é—´ç›¸äº’ç‰µåˆ¶ï¼Œå˜æˆäº†ä¸²è¡Œç¨‹åºï¼Œé™ä½äº†å¹¶å‘ã€‚<br>@sun.misc.Contended æ³¨è§£ï¼Œåˆ™å¯ä»¥ä¿è¯è¯¥å˜é‡ç‹¬å ä¸€ä¸ª Cache Lineã€‚<br>è¯¦ç»†å¯å‚è€ƒï¼š<a href="http://openjdk.java.net/jeps/142">http://openjdk.java.net/jeps/142</a></p></blockquote><h4 id="Striped64-æ ¸å¿ƒå±æ€§"><a href="#Striped64-æ ¸å¿ƒå±æ€§" class="headerlink" title="Striped64 æ ¸å¿ƒå±æ€§"></a>Striped64 æ ¸å¿ƒå±æ€§</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Striped64</span> <span class="keyword">extends</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** CPU çš„æ•°é‡ï¼Œä»¥é™åˆ¶è¡¨å¤§å° */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NCPU = Runtime.getRuntime().availableProcessors();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cell æ•°ç»„ï¼Œå½“éç©ºæ—¶ï¼Œå¤§å°æ˜¯ 2 çš„å¹‚ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">volatile</span> Cell[] cells;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base å€¼ï¼Œåœ¨æ— äº‰ç”¨æ—¶ä½¿ç”¨ï¼Œè¡¨åˆå§‹åŒ–ç«èµ›æœŸé—´çš„åå¤‡ã€‚ä½¿ç”¨ CAS æ›´æ–° </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> base;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è°ƒæ•´å¤§å°å’Œåˆ›å»ºCellsæ—¶è‡ªæ—‹é”ï¼ˆé€šè¿‡CASé”å®šï¼‰ä½¿ç”¨ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Striped64 ç±»ä¸»è¦æä¾›ä»¥ä¸‹å‡ ä¸ªå±æ€§ï¼š</p><ol><li>NCPUï¼šCPU çš„æ•°é‡ï¼Œä»¥é™åˆ¶è¡¨å¤§å°ã€‚</li><li>cellsï¼šCell[] cell æ•°ç»„ï¼Œå½“éç©ºæ—¶ï¼Œå¤§å°æ˜¯ 2 çš„å¹‚ã€‚</li><li>baseï¼šlong å‹ï¼ŒBase å€¼ï¼Œåœ¨æ— äº‰ç”¨æ—¶ä½¿ç”¨ï¼Œè¡¨åˆå§‹åŒ–ç«èµ›æœŸé—´çš„åå¤‡ã€‚ä½¿ç”¨ CAS æ›´æ–°ã€‚</li><li>cellsBusyï¼šè°ƒæ•´å¤§å°å’Œåˆ›å»ºCellsæ—¶è‡ªæ—‹é”ï¼ˆé€šè¿‡CASé”å®šï¼‰ä½¿ç”¨ã€‚</li></ol><p>ä¸‹é¢çœ‹æ˜¯è¿›å…¥æ ¸å¿ƒé€»è¾‘ï¼š</p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/uFCfpw.gif" align=center /><h4 id="LongAdder-add"><a href="#LongAdder-add" class="headerlink" title="LongAdder#add"></a>LongAdder#add</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LongAdder</span> <span class="keyword">extends</span> <span class="title">Striped64</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">long</span> x)</span> </span>&#123;</span><br><span class="line">        Cell[] as; <span class="keyword">long</span> b, v; <span class="keyword">int</span> m; Cell a;</span><br><span class="line">        <span class="comment">// cells æ˜¯ æ•°ç»„ï¼Œbase æ˜¯åŸºç¡€å€¼</span></span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> || !casBase(b = base, b + x)) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">                (a = as[getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">                !(uncontended = a.cas(v = a.value, v + x)))</span><br><span class="line">                longAccumulate(x, <span class="keyword">null</span>, uncontended);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Striped64</span> <span class="keyword">extends</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ CAS æ›´æ–° BASE çš„å€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">casBase</span><span class="params">(<span class="keyword">long</span> cmp, <span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, BASE, cmp, val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›å½“å‰çº¿ç¨‹çš„æ¢æµ‹å€¼ã€‚ ç”±äºåŒ…è£…é™åˆ¶ï¼Œä»ThreadLocalRandomå¤åˆ¶</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getProbe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.getInt(Thread.currentThread(), PROBE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/longadder-add.png" align=center /><ol><li>é¦–å…ˆä¼šå¯¹ Base å€¼è¿›è¡Œ CAS æ›´æ–°ï¼Œå½“ Base å‘ç”Ÿç«äº‰æ—¶ï¼Œ ä¼šæ›´æ–°æ•°ç»„å†…çš„ Cell ã€‚</li><li>æ•°ç»„æœªåˆå§‹åŒ–ï¼ŒCell æœªåˆå§‹åŒ–ï¼Œ Cell æ›´æ–°å¤±è´¥ï¼Œå³ Cell ä¹Ÿå‘ç”Ÿç«äº‰æ—¶ï¼Œä¼šè°ƒç”¨ Striped64 çš„ longAccumulate æ–¹æ³•ã€‚</li></ol><h4 id="Striped64-longAccumulate"><a href="#Striped64-longAccumulate" class="headerlink" title="Striped64#longAccumulate"></a>Striped64#longAccumulate</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Striped64</span> <span class="keyword">extends</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * x è¦å¢åŠ çš„å€¼</span></span><br><span class="line"><span class="comment">     * wasUncontended æœ‰æ²¡æœ‰å‘ç”Ÿç«äº‰ </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">longAccumulate</span><span class="params">(<span class="keyword">long</span> x, LongBinaryOperator fn, <span class="keyword">boolean</span> wasUncontended)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> h;</span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹æœ‰æ— åˆå§‹åŒ–çº¿ç¨‹æ¢æµ‹å€¼ï¼Œ ç»™å½“å‰çº¿ç¨‹ç”Ÿæˆä¸€ä¸ª é 0 æ¢æµ‹å€¼</span></span><br><span class="line">        <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">            ThreadLocalRandom.current(); <span class="comment">// force initialization</span></span><br><span class="line">            h = getProbe();</span><br><span class="line">            wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> collide = <span class="keyword">false</span>;                <span class="comment">// True if last slot nonempty</span></span><br><span class="line">        <span class="comment">// å¾ªç¯</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            Cell[] as; Cell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">            <span class="comment">// æ•°ç»„ä¸ä¸ºç©ºåˆ‡æ•°ç»„é•¿åº¦å¤§äº 0</span></span><br><span class="line">            <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// (n - 1) &amp; h è·å–åˆ°ç´¢å¼•ï¼Œç´¢å¼•å¤„ cell æ˜¯å¦ä¸º nullï¼Œ cellæœªåˆå§‹åŒ–</span></span><br><span class="line">                <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­ cellsBusy æ˜¯å¦ä¸º 0</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;       <span class="comment">// Try to attach new Cell</span></span><br><span class="line">                        Cell r = <span class="keyword">new</span> Cell(x);   <span class="comment">// Optimistically create</span></span><br><span class="line">                        <span class="comment">// cellsBusy == 0 ä¸” ä½¿ç”¨ casCellsBusy æ–¹æ³•å°†å…¶æ›´æ–°ä¸º 1ï¼Œå¤±è´¥ä¼šç»§ç»­å¾ªç¯</span></span><br><span class="line">                        <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                            <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">try</span> &#123;               <span class="comment">// Recheck under lock</span></span><br><span class="line">                                Cell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                                <span class="comment">// é‡æ–°æ£€æŸ¥çŠ¶æ€ å¹¶åˆ›å»º</span></span><br><span class="line">                                <span class="keyword">if</span> ((rs = cells) != <span class="keyword">null</span> &amp;&amp; (m = rs.length) &gt; <span class="number">0</span> &amp;&amp; rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    rs[j] = r;</span><br><span class="line">                                    created = <span class="keyword">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                <span class="comment">// åˆ›å»ºå®Œæˆä¹‹åï¼Œ æ”¹å› cellsBusy å€¼</span></span><br><span class="line">                                cellsBusy = <span class="number">0</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (created)</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="comment">// æœªåˆ›å»ºç»§ç»­å¾ªç¯</span></span><br><span class="line">                            <span class="keyword">continue</span>;           <span class="comment">// Slot is now non-empty</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    collide = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ä¼ å…¥çš„ wasUncontended ä¸º false å³å‘ç”Ÿç¢°æ’äº†ï¼Œ ä¿®æ”¹ä¸ºæœªç¢°æ’ï¼Œ æ­¤å¤„ä¼šç»§ç»­å¾ªç¯ï¼Œèµ°åˆ°ä¸‹ä¸€æ­¥ï¼Œç›¸å½“äºä¼šä¸€ç›´å¾ªç¯è¿™ä¸ª cell</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)       <span class="comment">// CAS already known to fail</span></span><br><span class="line">                    wasUncontended = <span class="keyword">true</span>;      <span class="comment">// Continue after rehash</span></span><br><span class="line">                <span class="comment">// cas æ›´æ–° cell çš„ valueï¼Œ æˆåŠŸåˆ™è¿”å›</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="keyword">null</span>) ? v + x : fn.applyAsLong(v, x))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// æ•°ç»„åˆ°æœ€å¤§é•¿åº¦ å³å¤§äºç­‰äº CPU æ•°é‡ï¼Œ æˆ–è€… cells æ•°ç»„è¢«æ”¹å˜ï¼Œ</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as)</span><br><span class="line">                    collide = <span class="keyword">false</span>;            <span class="comment">// At max size or stale</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                    collide = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">// ä¹è§‚é” è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (cells == as) &#123;      <span class="comment">// Expand table unless stale</span></span><br><span class="line">                            Cell[] rs = <span class="keyword">new</span> Cell[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                                rs[i] = as[i];</span><br><span class="line">                            cells = rs;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        cellsBusy = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    collide = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å½“å‰æ¢é’ˆå€¼ä¸èƒ½æ“ä½œæˆåŠŸï¼Œåˆ™é‡æ–°è®¾ç½®ä¸€ä¸ªè¿›è¡Œå°è¯•</span></span><br><span class="line">                h = advanceProbe(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰åŠ  cellsBusy ä¹è§‚é” ä¸” æ²¡æœ‰åˆå§‹åŒ–ï¼Œä¸”è·å¾—é”æˆåŠŸï¼ˆæ­¤æ—¶ cellsBusy == 1ï¼‰</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> init = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;                           <span class="comment">// Initialize table</span></span><br><span class="line">                    <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">                        Cell[] rs = <span class="keyword">new</span> Cell[<span class="number">2</span>];</span><br><span class="line">                        rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> Cell(x);</span><br><span class="line">                        cells = rs;</span><br><span class="line">                        init = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (init)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°è¯•åœ¨baseä¸Šç´¯åŠ </span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="keyword">null</span>) ? v + x : fn.applyAsLong(v, x))))</span><br><span class="line">                <span class="keyword">break</span>;                          <span class="comment">// Fall back on using base</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>longAccumulate æ–¹æ³•ä¸€å…±æœ‰ä¸‰ç§æƒ…å†µ</p><ol><li><code>(as = cells) != null &amp;&amp; (n = as.length) &gt; 0</code> æ•°ç»„ä¸ä¸ºç©ºä¸”é•¿åº¦å¤§äº 0 ã€‚<ol><li>è·å–ç´¢å¼•å¤„çš„ cell ï¼Œ cell ä¸ºç©ºåˆ™è¿›è¡Œåˆå§‹åŒ–ã€‚</li><li>cell ä¸ä¸ºç©ºï¼Œä½¿ç”¨ cas æ›´æ–°ï¼Œ æˆåŠŸ <code>break;</code> è·³å‡ºå¾ªç¯ï¼Œ å¤±è´¥åˆ™è¿˜åœ¨å¾ªç¯å†…ï¼Œä¼šä¸€ç›´å°è¯•ã€‚</li><li>collide æŒ‡æ˜¯å¦å‘ç”Ÿå†²çªï¼Œå†²çªåä¼šè¿›è¡Œé‡è¯•ã€‚</li><li>å†²çªåä¼šå°è¯•è·å¾—é”å¹¶è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹é•¿åº¦ä¸ºåŸæ¥çš„ 2 å€ï¼Œç„¶åç»§ç»­é‡è¯•ã€‚</li><li>è·å¾—é”å¤±è´¥ï¼ˆè¯´æ˜å…¶ä»–çº¿ç¨‹åœ¨æ‰©å®¹ï¼‰ä¼šé‡æ–°è¿›è¡Œè®¡ç®—æ¢é’ˆå€¼ã€‚</li></ol></li><li><code>cellsBusy == 0 &amp;&amp; cells == as &amp;&amp; casCellsBusy()</code> æ•°ç»„ä¸ºç©ºï¼Œè·å¾—ä¹è§‚é”æˆåŠŸã€‚<ol><li>ç›´æ¥åˆå§‹åŒ–æ•°ç»„ã€‚</li><li>åˆå§‹æ•°ç»„é•¿åº¦ä¸º 2 ã€‚</li></ol></li><li><code>casBase(v = base, ((fn == null) ? v + x : fn.applyAsLong(v, x)))</code> è·å¾—ä¹è§‚é”å¤±è´¥ã€‚<ol><li>è¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹åœ¨åˆå§‹åŒ–æ•°ç»„ï¼Œç›´æ¥ CAS æ›´æ–° base ã€‚</li></ol></li></ol><h4 id="LongAdder-sum"><a href="#LongAdder-sum" class="headerlink" title="LongAdder#sum"></a>LongAdder#sum</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LongAdder</span> <span class="keyword">extends</span> <span class="title">Striped64</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Cell[] as = cells; Cell a;</span><br><span class="line">        <span class="keyword">long</span> sum = base;</span><br><span class="line">        <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                    sum += a.value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æ•°ç»„ä¸ºç©ºï¼Œè¯´æ˜æ²¡æœ‰å‘ç”Ÿç«äº‰ï¼Œç›´æ¥è¿”å› base ã€‚</li><li>æ•°ç»„ä¸ä¸ºç©ºï¼Œè¯´æ˜å‘ç”Ÿç«äº‰ï¼Œç´¯åŠ  cell çš„ value å’Œ base çš„å’Œè¿›è¡Œè¿”å›ã€‚</li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="åŸºæœ¬æµç¨‹"><a href="#åŸºæœ¬æµç¨‹" class="headerlink" title="åŸºæœ¬æµç¨‹"></a>åŸºæœ¬æµç¨‹</h4><ol><li>LongAdder ç»§æ‰¿äº† Striped64ï¼Œå†…éƒ¨ç»´æŠ¤ä¸€ä¸ª Cells æ•°ç»„ï¼Œç›¸å½“äºå¤šä¸ª Cell å˜é‡ï¼Œ æ¯ä¸ª Cell é‡Œé¢éƒ½æœ‰ä¸€ä¸ªåˆå§‹å€¼ä¸º 0 çš„ long å‹å˜é‡ã€‚</li><li>æœªå‘ç”Ÿç«äº‰æ—¶ï¼ˆCells æ•°ç»„æœªåˆå§‹åŒ–ï¼‰ï¼Œæ˜¯å¯¹ base å˜é‡è¿›è¡ŒåŸå­æ“ä½œã€‚</li><li>å‘ç”Ÿç«äº‰æ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹è‡ªå·±çš„ Cell å˜é‡çš„ value è¿›è¡ŒåŸå­æ“ä½œã€‚</li></ol><h4 id="å¦‚ä½•ç¡®å®šå“ªä¸ªçº¿ç¨‹æ“ä½œå“ªä¸ª-cellï¼Ÿ"><a href="#å¦‚ä½•ç¡®å®šå“ªä¸ªçº¿ç¨‹æ“ä½œå“ªä¸ª-cellï¼Ÿ" class="headerlink" title="å¦‚ä½•ç¡®å®šå“ªä¸ªçº¿ç¨‹æ“ä½œå“ªä¸ª cellï¼Ÿ"></a>å¦‚ä½•ç¡®å®šå“ªä¸ªçº¿ç¨‹æ“ä½œå“ªä¸ª cellï¼Ÿ</h4><p>é€šè¿‡ <code>getProbe()</code> æ–¹æ³•è·å–è¯¥çº¿ç¨‹çš„æ¢æµ‹å€¼ï¼Œç„¶åå’Œæ•°ç»„é•¿åº¦ <code>n - 1</code> åš <code>&amp;</code> æ“ä½œ (n - 1) &amp; h ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getProbe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> UNSAFE.getInt(Thread.currentThread(), PROBE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Cells-æ•°ç»„åˆå§‹åŒ–åŠæ‰©å®¹ï¼Ÿ"><a href="#Cells-æ•°ç»„åˆå§‹åŒ–åŠæ‰©å®¹ï¼Ÿ" class="headerlink" title="Cells æ•°ç»„åˆå§‹åŒ–åŠæ‰©å®¹ï¼Ÿ"></a>Cells æ•°ç»„åˆå§‹åŒ–åŠæ‰©å®¹ï¼Ÿ</h4><p>åˆå§‹åŒ–æ‰©å®¹æ—¶ä¼šåˆ¤æ–­ <code>cellsBusy</code>ï¼Œ cellsBusy ä½¿ç”¨ <code>volatile</code> ä¿®é¥°ï¼Œä¿è¯çº¿ç¨‹è§å¯è§æ€§ï¼ŒåŒæ—¶ä½¿ç”¨ CAS è¿›è¡Œæ›´æ–°ã€‚ 0 è¡¨ç¤ºç©ºé—²ï¼Œ1 è¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–æˆ–æ‰©å®¹ã€‚</p><p>åˆå§‹åŒ–æ—¶ä¼šåˆ›å»ºé•¿åº¦ä¸º 2 çš„ Cell æ•°ç»„ã€‚æ‰©å®¹æ˜¯åˆ›å»ºä¸€ä¸ªé•¿åº¦æ˜¯åŸæ•°ç»„é•¿åº¦ 2 å€çš„æ–°æ•°ç»„ï¼Œå¹¶å¾ªç¯èµ‹å€¼ã€‚</p><p>å¦‚æœçº¿ç¨‹è®¿é—®åˆ†é…çš„ Cell å…ƒç´ æœ‰å†²çªåï¼Œä¼šä½¿ç”¨ <code>advanceProbe()</code> æ–¹æ³•é‡æ–°è·å–æ¢æµ‹å€¼ï¼Œå†æ¬¡è¿›è¡Œå°è¯•ã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h4><p>åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œéœ€è¦ç›¸å¯¹é«˜çš„æ€§èƒ½ï¼ŒåŒæ—¶æ•°æ®å‡†ç¡®æ€§è¦æ±‚ä¸é«˜ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ LongAdderã€‚</p><p>å½“è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¹¶å…è®¸ä¸€å®šçš„æ€§èƒ½æŸè€—æ—¶ï¼Œå¹¶å¯¹æ•°æ®å‡†ç¡®æ€§è¦æ±‚è¾ƒé«˜ï¼Œä¼˜å…ˆä½¿ç”¨ AtomicLongã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- è¯·ä»‹ç»ä¸‹ä½ äº†è§£çš„ThreadLocalï¼Œå®ƒçš„åº•å±‚åŸç†ï¼</title>
      <link href="2020/06/21/source-code-threadlocal.html"/>
      <url>2020/06/21/source-code-threadlocal.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>å‰è¨€</strong></p><p>ä¸šåŠ¡å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨ ThreadLocal æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ç­‰çº¿ç¨‹ç§æœ‰å¯¹è±¡â€¦ ThreadLocal å†…éƒ¨æ„é€ æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿå¸¸è¯´çš„å†…å­˜æ³„éœ²åˆæ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</p><p>å…¬ä¼—å·ï¼šliuzhihangs ï¼Œè®°å½•å·¥ä½œå­¦ä¹ ä¸­çš„æŠ€æœ¯ã€å¼€å‘åŠæºç ç¬”è®°ï¼›æ—¶ä¸æ—¶åˆ†äº«ä¸€äº›ç”Ÿæ´»ä¸­çš„è§é—»æ„Ÿæ‚Ÿã€‚æ¬¢è¿å¤§ä½¬æ¥æŒ‡å¯¼ï¼</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><blockquote><p>ThreadLocal ç±»æä¾›äº†çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚å’Œæ­£å¸¸å¯¹è±¡ä¸åŒçš„æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—® get()ã€set() æ–¹æ³•ï¼Œè·å–ç‹¬å±äºè‡ªå·±çš„å‰¯æœ¬ã€‚ ThreadLocal å®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œå¹¶ä¸”å…¶çŠ¶æ€å’Œçº¿ç¨‹å…³è”ã€‚<br>æ¯ä¸ªçº¿ç¨‹éƒ½ä¿æŒå¯¹å…¶çº¿ç¨‹å±€éƒ¨å˜é‡å‰¯æœ¬çš„éšå¼å¼•ç”¨ï¼Œåªè¦çº¿ç¨‹æ˜¯æ´»åŠ¨çš„å¹¶ä¸” ThreadLocal å®ä¾‹è®¿é—®; ä¸€ä¸ªçº¿ç¨‹æ¶ˆå¤±ä¹‹åï¼Œæ‰€æœ‰çš„çº¿ç¨‹å±€éƒ¨å®ä¾‹çš„å‰¯æœ¬éƒ½ä¼šè¢«åƒåœ¾å›æ”¶ï¼ˆé™¤éå­˜åœ¨å¯¹è¿™äº›å‰¯æœ¬çš„å…¶ä»–å¼•ç”¨ï¼‰ã€‚</p></blockquote><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>æœ‰è¿™ä¹ˆä¸€ç§ä½¿ç”¨åœºæ™¯ï¼Œæ”¶åˆ° web è¯·æ±‚ï¼Œå…ˆè¿›è¡Œ token éªŒè¯ï¼Œè€Œè¿™ä¸ª tokenï¼Œå¯ä»¥è§£æå‡ºç”¨æˆ· user çš„ä¿¡æ¯ã€‚æ‰€ä»¥æˆ‘è¿™è¾¹ä¸€èˆ¬æ˜¯è¿™æ ·ä½¿ç”¨çš„ï¼š</p><ol><li>è‡ªå®šä¹‰æ³¨è§£ï¼Œ <code>@CheckToken</code> ï¼Œ æ ‡è¯†è¯¥æ–¹æ³•éœ€è¦æ ¡éªŒ tokenã€‚</li><li>åœ¨ <code>Interceptor</code>ï¼ˆæ‹¦æˆªå™¨ï¼‰ä¸­æ£€æŸ¥ï¼Œå¦‚æœæ–¹æ³•æœ‰ <code>@CheckToken</code> æ³¨è§£åˆ™æ ¡éªŒ tokenã€‚</li><li>ä»Headerä¸­è·å– <code>Authorization</code> ï¼Œè¯·æ±‚ç¬¬ä¸‰æ–¹æˆ–è€…è‡ªå·±çš„é€»è¾‘æ ¡éªŒ token ï¼Œå¹¶è§£ææˆ userã€‚</li><li>å°†useræ”¾åˆ°<code>ThreadLocal</code>ä¸­ã€‚</li><li>controllerã€service åœ¨åç»­ä½¿ç”¨ä¸­ï¼Œ å¦‚æœéœ€è¦ user ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥ä» <code>ThreadLocal</code> ä¸­è·å–ã€‚</li><li>ä½¿ç”¨ç»“æŸåè¿›è¡Œremoveã€‚</li></ol><h4 id="ä»£ç å¦‚ä¸‹ï¼š"><a href="#ä»£ç å¦‚ä¸‹ï¼š" class="headerlink" title="ä»£ç å¦‚ä¸‹ï¼š"></a>ä»£ç å¦‚ä¸‹ï¼š</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalUserUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·ä¿¡æ¯ä¿å­˜è‡³ ThreadLocal ä¸­</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;User&gt; USER_THREAD_LOCAL = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        USER_THREAD_LOCAL.set(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> USER_THREAD_LOCAL.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        USER_THREAD_LOCAL.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. åŠ ä¸Šæ³¨è§£ CheckToken</span></span><br><span class="line"><span class="comment"> * åªæœ‰æ–¹æ³•ï¼Œ ç±»å¿½ç•¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CheckToken</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/doXxx&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result&lt;Resp&gt; <span class="title">doXxx</span><span class="params">(<span class="meta">@RequestBody</span> Req req)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Resp resp = xxxService.doXxx(req);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result.success(resp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 2. 3. 4.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2, Exception arg3)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        LocalUserUtils.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// è¯·æ±‚æ–¹æ³•æ˜¯å¦å­˜åœ¨æ³¨è§£</span></span><br><span class="line">        <span class="keyword">boolean</span> assignableFrom = handler.getClass().isAssignableFrom(HandlerMethod.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!assignableFrom) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CheckToken checkToken = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> HandlerMethod) &#123;</span><br><span class="line">            checkToken = ((HandlerMethod) handler).getMethodAnnotation(CheckToken.class);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ²¡æœ‰åŠ æ³¨è§£ ç›´æ¥æ”¾è¿‡</span></span><br><span class="line">        <span class="keyword">if</span> (checkToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»Headerä¸­è·å–Authorization</span></span><br><span class="line">        String authorization = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;header authorization : &#123;&#125;&quot;</span>, authorization);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(authorization)) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ä»Headerä¸­è·å–Authorizationå¤±è´¥&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> CustomExceptionEnum.NOT_HAVE_TOKEN.throwCustomException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        User user = xxxUserService.checkAuthorization(authorization);</span><br><span class="line">        <span class="comment">// æ”¾åˆ°</span></span><br><span class="line">        LocalUserUtils.set(user);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 5. ä½¿ç”¨</span></span><br><span class="line"><span class="comment"> * åªæœ‰æ–¹æ³•ï¼Œ ç±»å¿½ç•¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Resp <span class="title">doXxx</span><span class="params">(Req req)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    User user = LocalUserUtils.get();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do something ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/640.jpeg"  div align=center /><h4 id="æŠ›å‡ºé—®é¢˜"><a href="#æŠ›å‡ºé—®é¢˜" class="headerlink" title="æŠ›å‡ºé—®é¢˜"></a>æŠ›å‡ºé—®é¢˜</h4><ol><li>ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆå¼ºåˆ¶ä½¿ç”¨åå¿…é¡»removeï¼Ÿ</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/19.png" alt="19"></p><p>å›¾ | é˜¿é‡Œå·´å·´ - Javaå¼€å‘æ‰‹å†Œï¼ˆæˆªå›¾ï¼‰</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/6.png" alt="6"></p><p>å›¾ | é˜¿é‡Œå·´å·´ - Javaå¼€å‘æ‰‹å†Œï¼ˆæˆªå›¾ï¼‰</p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Thread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// çœç•¥ ...</span></span><br><span class="line"></span><br><span class="line">    ThreadLocal.ThreadLocalMap threadLocals = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    ThreadLocal.ThreadLocalMap inheritableThreadLocals = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çœç•¥ ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡º <code>Thread</code> å¯¹è±¡ä¸­å£°æ˜äº† <code>ThreadLocal.ThreadLocalMap</code> å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ <code>ThreadLocal. ThreadLocalMap</code> å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨çº¿ç¨‹ä¹‹é—´æ˜¯äº’ç›¸<code>éš”ç¦»</code>çš„ã€‚</p><h4 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h4><p>ThreadLocalåˆ™æ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼ŒåŒæ—¶æä¾› <code>set()</code>ã€<code>get()</code>ã€<code>remove()</code> ç­‰<code>é™æ€</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocal</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿ç¨‹æœ¬åœ°hashCode</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> threadLocalHashCode = nextHashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹å‰¯æœ¬ä¸­çš„å€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®å½“å‰çº¿ç¨‹çš„æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å¤åˆ¶åˆ°æŒ‡å®šçš„å€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="comment">// åˆ é™¤å½“å‰çº¿ç¨‹çš„æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="comment">// ThreadLocalMapåªæ˜¯ç”¨æ¥ç»´æŒçº¿ç¨‹æœ¬åœ°å€¼çš„å®šåˆ¶Map</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalMap</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="set-T-value-æ–¹æ³•"><a href="#set-T-value-æ–¹æ³•" class="headerlink" title="set(T value)æ–¹æ³•"></a>set(T value)æ–¹æ³•</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ threadLocals å±æ€§</span></span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">// å­˜åœ¨åˆ™èµ‹å€¼</span></span><br><span class="line">        map.set(<span class="keyword">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨åˆ™ç›´æ¥åˆ›å»º</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ ¹æ®çº¿ç¨‹è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap</span></span><br><span class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆ›å»ºThreadLocalMap å¹¶èµ‹å€¼ç»™å½“å‰çº¿ç¨‹çš„threadLocalså­—æ®µ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</span><br><span class="line">    t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1.<code>Thread.currentThread()</code> å…ˆè·å–åˆ°å½“å‰çº¿ç¨‹ã€‚<br>2. è·å–å½“å‰çº¿ç¨‹çš„ <code>threadLocals</code> å±æ€§ï¼Œå³ <code>ThreadLocalMap</code>ã€‚<br>3. åˆ¤æ–­ Map æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™èµ‹å€¼ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºå¯¹è±¡ã€‚</p><h5 id="get-æ–¹æ³•"><a href="#get-æ–¹æ³•" class="headerlink" title="get()æ–¹æ³•"></a>get()æ–¹æ³•</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ threadLocals å±æ€§</span></span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="comment">// mapä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®å½“å‰ThreadLocalè·å–çš„ThreadLocalMapçš„EntryèŠ‚ç‚¹</span></span><br><span class="line">        ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–èŠ‚ç‚¹çš„value å¹¶è¿”å›</span></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            T result = (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®åˆå§‹å€¼å¹¶è¿”å› ï¼ˆnullï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>1.<code>Thread.currentThread()</code> å…ˆè·å–åˆ°å½“å‰çº¿ç¨‹ã€‚<br>2. è·å–å½“å‰çº¿ç¨‹çš„ <code>threadLocals</code> å±æ€§ï¼Œå³ <code>ThreadLocalMap</code> ã€‚<br>3. åˆ¤æ–­ Map ä¸ä¸ºç©ºï¼Œæ ¹æ®å½“å‰ <code>ThreadLocal</code> å¯¹è±¡è·å– <code>ThreadLocalMap.Entry</code> èŠ‚ç‚¹, ä»èŠ‚ç‚¹ä¸­è·å– valueã€‚<br>4.<code>ThreadLocalMap</code> ä¸ºç©ºæˆ–è€… <code>ThreadLocalMap.Entry</code> ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ– ThreadLocalMap å¹¶è¿”å›ã€‚</p><h5 id="remove-æ–¹æ³•"><a href="#remove-æ–¹æ³•" class="headerlink" title="remove()æ–¹æ³•"></a>remove()æ–¹æ³•</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap</span></span><br><span class="line">    ThreadLocalMap m = getMap(Thread.currentThread());</span><br><span class="line">    <span class="comment">// ä¸ä¸ºç©ºï¼Œ ä»ThreadLocalMapä¸­ç§»é™¤è¯¥å±æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (m != <span class="keyword">null</span>)</span><br><span class="line">        m.remove(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é˜…è¯» <code>set()</code>ã€<code>get()</code>ã€<code>remove()</code> çš„æºç ä¹‹åå‘ç°åé¢å…¶å®æ˜¯æ“ä½œçš„ <code>ThreadLocalMap</code>, ä¸»è¦è¿˜æ˜¯æ“ä½œçš„ <code>ThreadLocalMap</code> çš„ <code>set()</code>ã€<code>getEntry()</code>ã€<code>remove()</code> ä»¥åŠæ„é€ å‡½æ•°ã€‚ä¸‹é¢çœ‹æ˜¯çœ‹ ThreadLocalMap çš„æºç ã€‚</p><h4 id="ThreadLocalMap"><a href="#ThreadLocalMap" class="headerlink" title="ThreadLocalMap"></a>ThreadLocalMap</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalMap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * EntryèŠ‚ç‚¹ç»§æ‰¿WeakReferenceæ˜¯å¼±å¼•ç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="comment">/** ä¸æ­¤ThreadLocalå…³è”çš„å€¼ã€‚ */</span></span><br><span class="line">        Object value;</span><br><span class="line"></span><br><span class="line">        Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">            <span class="keyword">super</span>(k);</span><br><span class="line">            value = v;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå§‹å®¹é‡-å¿…é¡»æ˜¯2çš„å¹‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INITIAL_CAPACITY = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¨ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´å¤§å°. table.lengthå¿…é¡»å§‹ç»ˆä¸º2çš„å¹‚.</span></span><br><span class="line">    <span class="keyword">private</span> ThreadLocal.ThreadLocalMap.Entry[] table;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¨ä¸­çš„æ¡ç›®æ•°ã€‚ </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰©å®¹é˜ˆå€¼  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> threshold; <span class="comment">// Default to 0</span></span><br><span class="line">    <span class="comment">// è®¾ç½®é˜€å€¼ä¸ºé•¿åº¦çš„ 2/3   </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setThreshold</span><span class="params">(<span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">        threshold = len * <span class="number">2</span> / <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">    ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®ThreadLocalè·å–èŠ‚ç‚¹Entry</span></span><br><span class="line">    <span class="keyword">private</span> ThreadLocal.ThreadLocalMap.<span class="function">Entry <span class="title">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set ThreadLocalMapçš„k-v</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»é™¤å½“å‰å€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>Entry ç»§æ‰¿äº† <code>WeakReference&lt;ThreadLocal&lt;?&gt;</code> ä¹Ÿå°±æ„å‘³ç€ï¼Œ <code>Entry èŠ‚ç‚¹çš„ key æ˜¯å¼±å¼•ç”¨</code>ã€‚</li><li>Entry å¯¹è±¡çš„keyå¼±å¼•ç”¨ï¼ŒæŒ‡å‘çš„æ˜¯ <code>ThreadLocal</code> å¯¹è±¡ã€‚</li><li>çº¿ç¨‹å¯¹è±¡æ‰§è¡Œå®Œæ¯•ï¼Œçº¿ç¨‹å¯¹è±¡å†…å®ä¾‹å±æ€§ä¼šè¢«å›æ”¶ï¼Œæ­¤æ—¶çº¿ç¨‹å†… <code>ThreadLocal</code> å¯¹è±¡çš„<code>å¼•ç”¨</code>è¢«ç½®ä¸º <code>null</code> ï¼Œå³ Entry çš„ <code>key</code> ä¸º <code>null</code>, key ä¼šè¢«åƒåœ¾å›æ”¶ã€‚</li><li>ThreadLocal å¯¹è±¡é€šå¸¸ä¸ºç§æœ‰é™æ€å˜é‡ï¼Œ ç”Ÿå‘½å‘¨æœŸä¸ä¼šè‡³å°‘ä¸ä¼šéšç€çº¿ç¨‹æŠ€æœ¯è€Œç»“æŸã€‚</li><li>ThreadLocal å¯¹è±¡å­˜åœ¨ï¼Œå¹¶ä¸” <code>Entryçš„ key == null &amp;&amp; value != null</code> ï¼Œè¿™æ—¶å°±ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚</li></ol><ul><li>å°è¡¥å……</li></ul><ol><li>å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">å¼ºå¼•ç”¨ï¼ˆStrongReferenceï¼‰ï¼šæœ€å¸¸è§ï¼Œç›´æ¥ new Object(); åˆ›å»ºçš„å³ä¸ºå¼ºå¼•ç”¨ã€‚å½“å†…å­˜ç©ºé—´ä¸è¶³ï¼ŒJavaè™šæ‹Ÿæœºå®æ„¿æŠ›å‡º OOMï¼Œä¹Ÿä¸æ„¿æ„éšæ„å›æ”¶å…·æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡æ¥è§£å†³å†…å­˜ä¸è¶³é—®é¢˜ã€‚</span><br><span class="line">è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰ï¼šå†…å­˜è¶³å¤Ÿï¼Œåƒåœ¾å›æ”¶å™¨ä¸ä¼šå›æ”¶è½¯å¼•ç”¨å¯¹è±¡ï¼›å†…å­˜ä¸è¶³æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šå›æ”¶ã€‚</span><br><span class="line">å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰ï¼šåƒåœ¾å›æ”¶å™¨çº¿ç¨‹ï¼Œå‘ç°å°±ä¼šå›æ”¶ã€‚</span><br><span class="line">è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰ï¼šä»»ä½•æ—¶å€™éƒ½æœ‰å¯èƒ½è¢«åƒåœ¾å›æ”¶ï¼Œå¿…é¡»å¼•ç”¨é˜Ÿåˆ—è”åˆä½¿ç”¨ã€‚</span><br></pre></td></tr></table></figure></li><li>å†…å­˜æ³„éœ²ï¼š<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">å†…å­˜æ³„æ¼ï¼ˆMemory leakï¼‰æ˜¯åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œç”±äºç–å¿½æˆ–é”™è¯¯é€ æˆç¨‹åºæœªèƒ½é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚å†…å­˜æ³„æ¼å¹¶éæŒ‡å†…å­˜åœ¨ç‰©ç†ä¸Šçš„æ¶ˆå¤±ï¼Œè€Œæ˜¯åº”ç”¨ç¨‹åºåˆ†é…æŸæ®µå†…å­˜åï¼Œç”±äºè®¾è®¡é”™è¯¯ï¼Œå¯¼è‡´åœ¨é‡Šæ”¾è¯¥æ®µå†…å­˜ä¹‹å‰å°±å¤±å»äº†å¯¹è¯¥æ®µå†…å­˜çš„æ§åˆ¶ï¼Œä»è€Œé€ æˆäº†å†…å­˜çš„æµªè´¹ã€‚</span><br><span class="line">â€”â€” ç»´åŸºç™¾ç§‘</span><br></pre></td></tr></table></figure></li></ol><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/SJPSIU.jpg"  div align=center /><h5 id="æ„é€ å‡½æ•°åŠhashè®¡ç®—"><a href="#æ„é€ å‡½æ•°åŠhashè®¡ç®—" class="headerlink" title="æ„é€ å‡½æ•°åŠhashè®¡ç®—"></a>æ„é€ å‡½æ•°åŠhashè®¡ç®—</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–Entryæ•°ç»„ï¼Œ é•¿åº¦ä¸º16</span></span><br><span class="line">    table = <span class="keyword">new</span> Entry[INITIAL_CAPACITY];</span><br><span class="line">    <span class="comment">// è·å–keyçš„hashCodeï¼Œå¹¶è®¡ç®—å‡ºåœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œ</span></span><br><span class="line">    <span class="comment">// é•¿åº¦æ˜¯ 2çš„å¹‚çš„æƒ…å†µä¸‹ï¼Œå–æ¨¡ a % b == a &amp; (b - 1)</span></span><br><span class="line">    <span class="keyword">int</span> i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line">    table[i] = <span class="keyword">new</span> Entry(firstKey, firstValue);</span><br><span class="line">    <span class="comment">// è®¾ç½®æ•°ç»„å…ƒç´ æ•°</span></span><br><span class="line">    size = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// è®¾ç½®æ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">    setThreshold(INITIAL_CAPACITY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>threadLocalHashCode æ˜¯ ThreadLocal çš„é™æ€å±æ€§ï¼Œé€šè¿‡ nextHashCode æ–¹æ³•è·å–ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> threadLocalHashCode = nextHashCode();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¢«èµ‹äºˆäº†æ¥ä¸‹æ¥çš„å“ˆå¸Œç ã€‚ åŸå­æ›´æ–°ã€‚ ä»é›¶å¼€å§‹ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger nextHashCode = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_INCREMENT = <span class="number">0x61c88647</span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nextHashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¿”å›ä¸‹ä¸€ä¸ªhashç ï¼Œé€šè¿‡æ­¥é•¿ 0x61c88647 ç´¯åŠ ç”Ÿæˆï¼Œè¿™å—æ³¨é‡Šè¯´æ˜æ˜¯æœ€ä½³å“ˆå¸Œå€¼</span></span><br><span class="line">    <span class="keyword">return</span> nextHashCode.getAndAdd(HASH_INCREMENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>åˆå§‹åŒ–æ•°ç»„ï¼Œé•¿åº¦16ã€‚</li><li>è®¡ç®— key çš„ hashCodeï¼Œå¯¹2çš„å¹‚å–æ¨¡ã€‚</li><li>è®¾ç½®å…ƒç´ ï¼Œå…ƒç´ æ•°åŠæ‰©å®¹é˜ˆå€¼ã€‚</li></ol><p>hashCode é€šè¿‡æ­¥é•¿ 0x61c88647 ç´¯åŠ ç”Ÿæˆï¼Œ å¹¶ä¸”ä½¿ç”¨äº† AtomicIntegerï¼Œä¿è¯åŸå­æ€§ã€‚</p><h5 id="set-æ–¹æ³•"><a href="#set-æ–¹æ³•" class="headerlink" title="set()æ–¹æ³•"></a>set()æ–¹æ³•</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line">    <span class="comment">// hashcodeå–æ¨¡æ±‚æ•°ç»„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ•°ç»„ä¸­å¯¹åº”çš„ä½ç½®ï¼Œ é‡ç‚¹å…³æ³¨ e = tab[i = nextIndex(i, len)]</span></span><br><span class="line">    <span class="keyword">for</span> (Entry e = tab[i]; e != <span class="keyword">null</span>; e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="comment">// è·å–key</span></span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="comment">// key å­˜åœ¨åˆ™è¦†ç›–</span></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// key ä¸å­˜åœ¨åˆ™èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</span><br><span class="line">            replaceStaleEntry(key, value, i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ­¤æ—¶ e == null ç›´æ¥æ‰§åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">    tab[i] = <span class="keyword">new</span> Entry(key, value);</span><br><span class="line">    <span class="keyword">int</span> sz = ++size;</span><br><span class="line">    <span class="comment">// cleanSomeSlots å¾ªç¯æ•°ç»„ æŸ¥æ‰¾å…¨éƒ¨key==nullçš„Entry</span></span><br><span class="line">    <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">        rehash();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è·å–å¾ªç¯ Entry æ•°ç»„ï¼Œè·å– tab[i] å¤„çš„ eï¼Œ e != null ç»§ç»­å¾ªç¯<ol><li>æ­¤æ—¶å‘ç° e çš„ key ä¸å­˜åœ¨ï¼Œå¹¶ä¸”ä¸æ˜¯ null ï¼ˆhashå†²çªäº†ã€‚ï¼‰</li><li>é‚£å°±é€šè¿‡ e = tab[i = nextIndex(i, len)]) ç»§ç»­è·å–ä¸‹ä¸€ä¸ª iï¼Œå¹¶è·å–æ–°çš„ tab[i] å¤„çš„ eã€‚</li><li>èµ‹å€¼æ›¿æ¢å€¼ç»“æŸç»“æŸå¹¶è¿”å›ã€‚</li></ol></li><li>e == null ç»“æŸå¾ªç¯ã€‚</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸‹ä¸€ä¸ªindexï¼Œå¦‚æœ i + 1 &lt; len ç›´æ¥è¿”å›ä¸‹ä¸€ä¸ªä½ç½®  </span></span><br><span class="line"><span class="comment">// å¦‚æœ i + 1 &gt;= len åˆ™è¿”å› 0ï¼Œ ä»å¤´å¼€å§‹ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nextIndex</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((i + <span class="number">1</span> &lt; len) ? i + <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">prevIndex</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((i - <span class="number">1</span> &gt;= <span class="number">0</span>) ? i - <span class="number">1</span> : len - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>è¿™å—åˆ©ç”¨ç¯å½¢è®¾è®¡ï¼Œå¦‚æœé•¿åº¦åˆ°è¾¾æ•°ç»„é•¿åº¦ï¼Œåˆ™ä»å¼€å¤´å¼€å§‹ç»§ç»­æŸ¥æ‰¾ã€‚</li><li>int i = key.threadLocalHashCode &amp; (len-1); æ±‚å‡ºç´¢å¼•ï¼Œå¹¶ä¸æ˜¯ä»0å¼€å§‹çš„ã€‚</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * staleSlot ä¸ºå½“å‰ç´¢å¼•ä½ç½®ï¼Œ å¹¶ä¸”å½“å‰ç´¢å¼•ä½ç½®çš„ k == null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceStaleEntry</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value, <span class="keyword">int</span> staleSlot)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line">    Entry e;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éœ€è¦æ¸…é™¤çš„ entry çš„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">int</span> slotToExpunge = staleSlot;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯è·å–åˆ°ä¸Šä¸€ä¸ª key==null çš„èŠ‚ç‚¹åŠå…¶ç´¢å¼•ï¼Œæœ‰å¯èƒ½è¿˜æ˜¯è‡ªå·±</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = prevIndex(staleSlot, len); (e = tab[i]) != <span class="keyword">null</span>; i = prevIndex(i, len))</span><br><span class="line">        <span class="keyword">if</span> (e.get() == <span class="keyword">null</span>)</span><br><span class="line">            slotToExpunge = i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»§ç»­ä¸Šä¸€å±‚çš„å¾ªç¯ï¼ŒæŸ¥æ‰¾ä¸‹ä¸€ä¸ª k == key çš„èŠ‚ç‚¹ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = nextIndex(staleSlot, len); (e = tab[i]) != <span class="keyword">null</span>; i = nextIndex(i, len)) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            <span class="comment">// key ç›¸ç­‰ åˆ™ç›´æ¥èµ‹å€¼</span></span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="comment">// å¹¶ä¸”å°† æ­¤å¤„çš„ entryæ›¿æ¢ä¸º tab[staleSlot]</span></span><br><span class="line">            tab[i] = tab[staleSlot];</span><br><span class="line">            tab[staleSlot] = e;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœå‘ç°è¦æ¸…é™¤çš„ entryå’Œä¼ å…¥çš„åœ¨ä¸€ä¸ªä½ç½®ä¸Šï¼Œ åˆ™ç›´æ¥èµ‹å€¼</span></span><br><span class="line">            <span class="keyword">if</span> (slotToExpunge == staleSlot)</span><br><span class="line">                slotToExpunge = i;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ¸…é™¤æ‰è¿‡æœŸçš„ expungeStaleEntry(slotToExpunge) ä¼šæ¸…é™¤ entryçš„valueï¼Œå°†å…¶è®¾ç½®ä¸ºnullå¹¶å°†å…¶è®¾ç½®ä¸ºnullï¼Œ å¹¶è¿”å›ä¸‹ä¸€ä¸ªéœ€è¦æ¸…é™¤çš„entryçš„ç´¢å¼•ä½ç½®</span></span><br><span class="line">            <span class="comment">// cleanSomeSlots å¾ªç¯æ•°ç»„ æŸ¥æ‰¾å…¨éƒ¨key==nullçš„Entry</span></span><br><span class="line">            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœå‘åæ‰«ææ²¡æœ‰æ‰¾åˆ°ï¼Œå¹¶ä¸”å·²ç»åˆ°ç¬¬åˆå§‹ä¼ å…¥çš„ç´¢å¼•ä½ç½®å¤„äº†</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span> &amp;&amp; slotToExpunge == staleSlot)</span><br><span class="line">            slotToExpunge = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ²¡æ‰¾åˆ°ï¼Œ ç›´æ¥å°†æ—§å€¼ Entry è®¾ç½®ä¸º null å¹¶æŒ‡å‘æ–°åˆ›å»ºçš„Entry</span></span><br><span class="line">    tab[staleSlot].value = <span class="keyword">null</span>;</span><br><span class="line">    tab[staleSlot] = <span class="keyword">new</span> Entry(key, value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»“æŸä¹‹åå‘ç°è¦æ¸…æ¥šçš„ keyçš„ç´¢å¼• ä¸ç­‰äºå½“å‰ä¼ å…¥çš„ç´¢å¼•ï¼Œ è¯´æ˜è¿˜æœ‰å…¶ä»–éœ€è¦æ¸…é™¤ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (slotToExpunge != staleSlot)</span><br><span class="line">        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>è¿™é‡Œå­˜åœ¨ä¸‰ä¸ªå±æ€§ keyï¼Œ valueï¼Œä»¥åŠ staleSlotï¼Œ staleSlotèŠ‚ç‚¹çš„ Entry != null ä½†æ˜¯ k == nullã€‚</li><li>å‘å‰æ‰«æè·å–åˆ°ä¸Šä¸€ä¸ª  Entry != null ä½†æ˜¯ k == null çš„èŠ‚ç‚¹åŠå…¶ç´¢å¼•, èµ‹å€¼ç»™ slotToExpungeï¼Œ æ²¡æœ‰æ‰«æåˆ°çš„è¯ slotToExpunge è¿˜æ˜¯ç­‰äº staleSlotã€‚</li><li>å‘åæ‰«æ Entry != null çš„èŠ‚ç‚¹ï¼Œå› ä¸ºåœ¨ set æ–¹æ³•ä¸­ï¼Œ åé¢è¿˜æœ‰ä¸€æ®µæ•°ç»„æ²¡æœ‰éå†ã€‚<ol><li>å‘ç° key ç›¸ç­‰çš„EntryèŠ‚ç‚¹äº†ï¼Œ ç›´æ¥èµ‹å€¼ï¼Œç„¶åæ¸…é™¤å…¶ä»– Entry != null ä½†æ˜¯ k == null çš„èŠ‚ç‚¹ï¼Œ å¹¶è¿”å›ã€‚</li><li>æ²¡æœ‰æ‰¾åˆ°keyç›¸ç­‰çš„èŠ‚ç‚¹ï¼Œä½†æ˜¯æ‰¾åˆ°äº†ä¸‹ä¸€ä¸ª Entry != null ä½†æ˜¯ k == nullï¼Œ ä¸”æ­¤æ—¶ slotToExpunge æœªå‘ç”Ÿå˜åŒ–ï¼Œè¿˜æ˜¯æŒ‡å‘ staleSlotï¼Œ åˆ™ i èµ‹å€¼ç»™ slotToExpungeã€‚</li></ol></li><li>å‘åæ‰«ææ²¡æœ‰æ‰«æåˆ°ï¼Œåˆ™ç›´æ¥å¯¹å½“å‰èŠ‚ç‚¹ï¼ˆç´¢å¼•å€¼ä¸ºstaleSlotï¼‰çš„èŠ‚ç‚¹çš„valueè®¾ç½®ä¸ºnullï¼Œå¹¶æŒ‡å‘æ–°valueã€‚</li><li>ç»“æŸä¹‹åå‘ç° slotToExpunge è¢«æ”¹å˜äº†ï¼Œ è¯´æ˜è¿˜æœ‰å…¶ä»–çš„è¦æ¸…é™¤ã€‚</li></ol><h5 id="getEntry-æ–¹æ³•"><a href="#getEntry-æ–¹æ³•" class="headerlink" title="getEntry()æ–¹æ³•"></a>getEntry()æ–¹æ³•</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// hashcodeå–æ¨¡æ±‚æ•°ç»„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</span><br><span class="line">    Entry e = table[i];</span><br><span class="line">    <span class="keyword">if</span> (e != <span class="keyword">null</span> &amp;&amp; e.get() == key)</span><br><span class="line">        <span class="comment">// å­˜åœ¨åˆ™è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">return</span> getEntryAfterMiss(key, i, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="keyword">int</span> i, Entry e)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="keyword">if</span> (k == key)</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">// key å·²ç» == null äº† æ¸…é™¤ä¸€ä¸‹ value</span></span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// ç»§ç»­è·å–ä¸‹ä¸€ä¸ª</span></span><br><span class="line">            i = nextIndex(i, len);</span><br><span class="line">        e = tab[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>hashcode å–æ¨¡æ±‚æ•°ç»„ç´¢å¼•ã€‚</li><li>ç´¢å¼•å¤„è·å–åˆ° Entry åˆ™ç›´æ¥è¿”å›ã€‚</li><li>è·å–ä¸åˆ°æˆ–è€…è·å–åˆ°çš„ Entry key ä¸ç›¸ç­‰æ—¶ï¼Œæœ‰å¯èƒ½æ˜¯å› ä¸º hash å†²çªï¼Œè¢«æ”¾åˆ°åˆ«çš„åœ°æ–¹ï¼Œ è°ƒç”¨ getEntryAfterMiss æ–¹æ³•ã€‚</li><li>getEntryAfterMiss æ–¹æ³•ä¸­ã€‚<ol><li>e == null  è¿”å›nullã€‚</li><li>e != null  åˆ¤æ–­keyï¼Œ keyç›¸ç­‰è¿”å› Entryï¼Œ key == nullï¼Œ é‚£å°±éœ€è¦æ¸…é™¤è¿™ä¸ªèŠ‚ç‚¹ï¼Œç„¶åç»§ç»­æŒ‰ç…§ <code>nextIndex(i, len)</code> æ–¹æ³•æ‰¾ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li></ol></li></ol><h4 id="remove-æ–¹æ³•-1"><a href="#remove-æ–¹æ³•-1" class="headerlink" title="remove()æ–¹æ³•"></a>remove()æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line">    <span class="comment">// hashcode å–æ¨¡æ±‚æ•°ç»„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// æ¸…é™¤å½“å‰èŠ‚ç‚¹çš„value</span></span><br><span class="line">    <span class="keyword">for</span> (Entry e = tab[i]; e != <span class="keyword">null</span>; e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.get() == key) &#123;</span><br><span class="line">            <span class="comment">// æ¸…æ¥šå¯¹è±¡å¼•ç”¨</span></span><br><span class="line">            e.clear();</span><br><span class="line">            <span class="comment">// value æŒ‡å‘ null</span></span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.referent = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>hashcode å–æ¨¡æ±‚æ•°ç»„ç´¢å¼•ã€‚</li><li>å¾ªç¯æŸ¥æ‰¾æ•°ç»„ï¼Œå°†å½“å‰ key çš„ Entry çš„å¼•ç”¨ï¼Œå°† value è®¾ç½®ä¸º nullï¼Œ åé¢ä¼šè¢«åƒåœ¾å›æ”¶æ‰ã€‚</li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ"></a>ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ</h4><p>ThreadLocal çš„ get()ã€set()ã€remove()æ–¹æ³•ä¸­éƒ½æœ‰ <code>Thread t = Thread.currentThread();</code> æ“ä½œçš„å…¶å®æ˜¯æœ¬çº¿ç¨‹ï¼Œè·å–æœ¬çº¿ç¨‹çš„ThreadLocalMapã€‚</p><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ ThreadLocalï¼Œå¹¶ä¸”æ˜¯å°† value å­˜æ”¾åœ¨ä¸€ä¸ªä»¥ ThreadLocal ä¸º key çš„ ThreadLocalMap ä¸­çš„ã€‚æ‰€ä»¥çº¿ç¨‹é—´éš”ç¦»ã€‚</p><h4 id="ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ"></a>ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ</h4><p>Javaå¼€å‘æ‰‹å†Œå·²ç»ç»™å‡ºè¯´æ˜ï¼Œè¿˜æœ‰å°±æ˜¯ï¼Œå¦‚æœ ThreadLocal è®¾ç½®ä¸ºéé™æ€ï¼Œé‚£å°±æ˜¯æŸä¸ªçº¿ç¨‹çš„å®ä¾‹ç±»ï¼Œè¿™æ ·çš„è¯å°±ä¼šå¤±å»äº†çº¿ç¨‹å…±äº«çš„æœ¬è´¨å±æ€§ã€‚</p><h4 id="ä¸ºä»€ä¹ˆå¼ºåˆ¶å¿…é¡»æ—¶å€™åremove-ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå¼ºåˆ¶å¿…é¡»æ—¶å€™åremove-ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå¼ºåˆ¶å¿…é¡»æ—¶å€™åremove()ï¼Ÿ"></a>ä¸ºä»€ä¹ˆå¼ºåˆ¶å¿…é¡»æ—¶å€™åremove()ï¼Ÿ</h4><p>è¿™å—å¯ä»¥å’Œå†…å­˜æ³„éœ²ä¸€å—è¯´æ˜ï¼Œ é€šè¿‡ä¸Šé¢çš„ <code>ThreadLocalMap</code> å¤„å…³äºå¼±å¼•ç”¨çš„è®²è§£å·²ç»è¯´æ˜ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚è‡³äºå¦‚ä½•è§£å†³ä¹Ÿç»™å‡ºäº†ç­”æ¡ˆï¼š</p><p>1.<code>set()</code> æ—¶æ¸…é™¤ Entry != null &amp;&amp; key == null çš„èŠ‚ç‚¹ï¼Œ å°†å…¶ value è®¾ç½®ä¸º nullã€‚<br>2.<code>getEntry()</code> æ—¶æ¸…é™¤<code>å½“å‰ key åˆ° nextIndex(i, len)==null ä¹‹é—´çš„</code> Entry != null &amp;&amp; key == null çš„èŠ‚ç‚¹ï¼Œ å°†å…¶ value è®¾ç½®ä¸º nullã€‚<br>3.<code>remove()</code> æ—¶æ¸…é™¤<code>æŒ‡å®škey</code>çš„ Entry != null &amp;&amp; key == null çš„èŠ‚ç‚¹ï¼Œ å°†å…¶ value è®¾ç½®ä¸º nullã€‚</p><p>ä¹‹æ‰€ä»¥ä½¿ç”¨remove()ï¼Œè¿˜æ˜¯ä¸ºäº†è§£å†³å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚</p><h4 id="Last"><a href="#Last" class="headerlink" title="Last"></a>Last</h4><ol><li>ä½¿ç”¨æ—¶æ³¨æ„å£°æ˜ä¸º <code>private static final</code>ã€‚</li><li>ä½¿ç”¨åè¦ <code>remove()</code>ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- ä»JUCæºç çœ‹CASï¼Œæˆ‘åšäº†ä¸ªç¬”è®° ......</title>
      <link href="2020/06/12/source-code-cas.html"/>
      <url>2020/06/12/source-code-cas.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>å‰è¨€<br>JUCåŒ…ä¸‹å¤§é‡ä½¿ç”¨äº†CASï¼Œå·¥ä½œå’Œé¢è¯•ä¸­ä¹Ÿç»å¸¸é‡åˆ°CASï¼ŒåŒ…æ‹¬è¯´åˆ°ä¹è§‚é”ï¼Œä¹Ÿä¸å¯é¿å…çš„æƒ³èµ·CASï¼Œé‚£CASç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿ</p></blockquote><h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>è¯´åˆ°CASï¼ŒåŸºæœ¬ä¸Šéƒ½ä¼šæƒ³åˆ°ä¹è§‚é”ã€AtomicIntegerã€Unsafe â€¦ </p><p>å½“ç„¶ä¹Ÿæœ‰å¯èƒ½å•¥ä¹Ÿæ²¡æƒ³åˆ°ï¼</p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/zoi3eG.jpg" div align=center /><p>ä¸ç®¡ä½ ä»¬æ€ä¹ˆæƒ³ï¼Œ æˆ‘ç¬¬ä¸€å°è±¡æ˜¯ä¹è§‚é”ï¼Œæ¯•ç«Ÿåšäº¤æ˜“æ›´æ–°äº¤æ˜“çŠ¶æ€ç»å¸¸ç”¨åˆ°ä¹è§‚é”ï¼Œå°±è‡ªç„¶æƒ³åˆ°è¿™ä¸ªSQLï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> trans_order </span><br><span class="line"><span class="keyword">set</span> order_status = <span class="number">1</span> </span><br><span class="line"><span class="keyword">where</span> order_no = <span class="string">&#x27;xxxxxxxxxxx&#x27;</span> <span class="keyword">and</span> order_status = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯ setå’Œwhereé‡Œé¢éƒ½æºå¸¦order_statusã€‚</p><p>é‚£ä»€ä¹ˆæ˜¯CASï¼Ÿ</p><p>CASå°±æ˜¯<code>Compare-and-Swap</code>ï¼Œå³æ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œåœ¨å¹¶å‘ç®—æ³•æ—¶å¸¸ç”¨ï¼Œå¹¶ä¸”åœ¨JUCï¼ˆjava.util.concurrentï¼‰åŒ…ä¸‹å¾ˆå¤šç±»éƒ½ä½¿ç”¨äº†CASã€‚</p><p>éå¸¸å¸¸è§çš„é—®é¢˜å°±æ˜¯å¤šçº¿ç¨‹æ“ä½œi++é—®é¢˜ã€‚ä¸€èˆ¬è§£å†³åŠæ³•å°±æ˜¯æ·»åŠ  synchronized å…³é”®å­—ä¿®é¥°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ AtomicInteger ä»£ç ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CasTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch LATCH = <span class="keyword">new</span> CountDownLatch(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> NUM_I = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> NUM_J = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger NUM_K = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService threadPool = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            threadPool.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                        NUM_I++;</span><br><span class="line">                        NUM_J++;</span><br><span class="line">                        NUM_K.incrementAndGet();</span><br><span class="line">                    &#125;</span><br><span class="line">                    LATCH.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        LATCH.await();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;NUM_I = &quot;</span> + NUM_I);</span><br><span class="line">        System.out.println(<span class="string">&quot;NUM_J = &quot;</span> + NUM_J);</span><br><span class="line">        System.out.println(<span class="string">&quot;NUM_K = &quot;</span> + NUM_K.get());</span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å°±ä»<code>AtomicInteger</code>å¼€å§‹äº†è§£CASã€‚</p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicInteger</span> <span class="keyword">extends</span> <span class="title">Number</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6214790243416807050L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup to use Unsafe.compareAndSwapInt for updates</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            valueOffset = unsafe.objectFieldOffset</span><br><span class="line">                (AtomicInteger.class.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Error(ex); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">incrementAndGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">decrementAndGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, -<span class="number">1</span>) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºé‡Œé¢ä½¿ç”¨äº†<code>Unsafe</code>ç±»ä¸‹çš„<code>getAndAddInt</code>æ–¹æ³•ï¼Œ<code>Unsafe</code>ç±»å¾ˆå¤šæ–¹æ³•æ˜¯æœ¬åœ°ï¼ˆnativeï¼‰æ–¹æ³•ï¼Œä¸»è¦æ˜¯ç¡¬ä»¶çº§åˆ«çš„<code>åŸå­æ“ä½œ</code>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> var1 å½“å‰å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> var2 å½“å‰å¯¹è±¡åœ¨å†…å­˜åç§»é‡ï¼ŒUnsafeå¯ä»¥æ ¹æ®å†…å­˜åç§»åœ°å€è·å–æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> var4 æ“ä½œå€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndAddInt</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">int</span> var4)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> var5;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–åœ¨var1åœ¨å†…å­˜çš„å€¼</span></span><br><span class="line">        var5 = <span class="keyword">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">        <span class="comment">// å°†var1èµ‹å€¼ä¸ºvar5+var4ï¼Œ èµ‹å€¼æ—¶ä¼šåˆ¤æ–­var1æ˜¯å¦ä¸ºvar5</span></span><br><span class="line">    &#125; <span class="keyword">while</span>(!<span class="keyword">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var5;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åŸå­æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapInt</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">int</span> var4, <span class="keyword">int</span> var5)</span></span>;</span><br></pre></td></tr></table></figure><p>è‡³äº compareAndSwapInt çš„åˆ†æå°±å¿½ç•¥äº†ã€‚ </p><p>çœ‹å®Œä»£ç è¿‡ç¨‹å…¶å®å°±æ˜¯ï¼š</p><ol><li>æ¯”è¾ƒvar1çš„å€¼æ˜¯å¦ä¸ºvar4ï¼Œæ˜¯çš„è¯å°†var1æ›´æ–°ä¸ºvar5ã€‚</li><li>å¦‚æœä¸æ˜¯çš„è¯å°±ä¸€ç›´å¾ªç¯ï¼Œç›´åˆ°var1æ˜¯var4ã€‚</li></ol><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/3E5FDF0D-875A-4CD0-9B75-61D01ACBCD50_4_5005_c.jpeg"  div align=center /><h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/iyLlPP.png"  div align=center /><ol><li>è¿™è¦æ˜¯ä¸€ç›´è·å–ä¸åˆ°ï¼Œå²‚ä¸æ˜¯ä¸€ç›´å¾ªç¯ã€‚çº¿ç¨‹å¤šçš„æƒ…å†µä¸‹ï¼Œä¼šè‡ªæ—‹å¾ˆé•¿æ—¶é—´ï¼Œå¯¼è‡´æµªè´¹èµ„æºã€‚</li><li>ä½ æ›´æ–°äº†ï¼Œ æˆ‘åˆç»™ä½ æ›´æ–°å›å»äº†ï¼Œä½ ä¹Ÿä¸çŸ¥é“ã€‚ABAé—®é¢˜ï¼æ¯”å¦‚åƒè¿™æ ·ï¼ŒAæƒ³æ›´æ–°å€¼ä¸ºaï¼Œè¿˜æœªæŠ¢åˆ°èµ„æºï¼Œè¿™æ—¶å€™Bè¿›è¡Œäº†æ›´æ–°ï¼Œå°†å¯¹è±¡æ›´æ–°ä¸ºäº†bï¼Œç„¶ååˆé©¬ä¸Šæ›´æ–°å›äº†aï¼Œ è¿™æ—¶å€™Aæ˜¯ä»€ä¹ˆéƒ½ä¸çŸ¥é“çš„ã€‚</li></ol><p>ä»¥ä¹è§‚é”ä¸¾ä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 0 -&gt; 1</span></span><br><span class="line"><span class="keyword">update</span> trans_order </span><br><span class="line"><span class="keyword">set</span> order_status = <span class="number">1</span> </span><br><span class="line"><span class="keyword">where</span> order_no = <span class="string">&#x27;xxxxxxxxxxx&#x27;</span> <span class="keyword">and</span> order_status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 1 -&gt; 0</span></span><br><span class="line"><span class="keyword">update</span> trans_order </span><br><span class="line"><span class="keyword">set</span> order_status = <span class="number">1</span> </span><br><span class="line"><span class="keyword">where</span> order_no = <span class="string">&#x27;xxxxxxxxxxx&#x27;</span> <span class="keyword">and</span> order_status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 0 -&gt; 1</span></span><br><span class="line"><span class="keyword">update</span> trans_order </span><br><span class="line"><span class="keyword">set</span> order_status = <span class="number">1</span> </span><br><span class="line"><span class="keyword">where</span> order_no = <span class="string">&#x27;xxxxxxxxxxx&#x27;</span> <span class="keyword">and</span> order_status = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•å¯ä»¥æ·»åŠ versionè¿›è¡Œç‰ˆæœ¬å·æ§åˆ¶ã€‚</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 0 -&gt; 1</span></span><br><span class="line"><span class="keyword">update</span> trans_order </span><br><span class="line"><span class="keyword">set</span> order_status = <span class="number">1</span> </span><br><span class="line"><span class="keyword">where</span> order_no = <span class="string">&#x27;xxxxxxxxxxx&#x27;</span> <span class="keyword">and</span> order_status = <span class="number">0</span> <span class="keyword">and</span> <span class="keyword">version</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 1 -&gt; 0</span></span><br><span class="line"><span class="keyword">update</span> trans_order </span><br><span class="line"><span class="keyword">set</span> order_status = <span class="number">1</span> </span><br><span class="line"><span class="keyword">where</span> order_no = <span class="string">&#x27;xxxxxxxxxxx&#x27;</span> <span class="keyword">and</span> order_status = <span class="number">0</span> <span class="keyword">and</span> <span class="keyword">version</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 0 -&gt; 1</span></span><br><span class="line"><span class="keyword">update</span> trans_order </span><br><span class="line"><span class="keyword">set</span> order_status = <span class="number">1</span> </span><br><span class="line"><span class="keyword">where</span> order_no = <span class="string">&#x27;xxxxxxxxxxx&#x27;</span> <span class="keyword">and</span> order_status = <span class="number">0</span> <span class="keyword">and</span> <span class="keyword">version</span> = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­å¯ä»¥çœ‹ <code>AtomicStampedReference</code> ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»¥åŸå­æ–¹å¼è®¾ç½®è¯¥å¼•ç”¨å’Œæ ‡å¿—ç»™å®šçš„æ›´æ–°å€¼çš„å€¼ï¼Œ</span></span><br><span class="line"><span class="comment"> * å¦‚æœå½“å‰å¼•ç”¨==é¢„æœŸçš„å¼•ç”¨ï¼Œå¹¶ä¸”å½“å‰æ ‡å¿—==é¢„æœŸæ ‡å¿—ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> expectedReference é¢„æœŸå¼•ç”¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newReference æ›´æ–°çš„å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> expectedStamp é¢„æœŸæ ‡å¿—</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newStamp æ›´æ–°çš„æ ‡å¿—</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if successful</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(V   expectedReference,</span></span></span><br><span class="line"><span class="function"><span class="params">                                V   newReference,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">int</span> expectedStamp,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">int</span> newStamp)</span> </span>&#123;</span><br><span class="line">    Pair&lt;V&gt; current = pair;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">        expectedReference == current.reference &amp;&amp;</span><br><span class="line">        expectedStamp == current.stamp &amp;&amp;</span><br><span class="line">        ((newReference == current.reference &amp;&amp;</span><br><span class="line">            newStamp == current.stamp) ||</span><br><span class="line">            casPair(current, Pair.of(newReference, newStamp)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯é¢å¤–å¢åŠ ä¸€ä¸ªæ ‡å¿—ï¼ˆ<code>stamp</code>ï¼‰æ¥é˜²æ­¢ABAçš„é—®é¢˜ï¼Œ ç±»ä¼¼ä¹è§‚é”çš„versionã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- HashMapçº¢é»‘æ ‘</title>
      <link href="2020/05/25/source-code-hashmap-red-black-tree.html"/>
      <url>2020/05/25/source-code-hashmap-red-black-tree.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>å‰è¨€<br>åœ¨é˜…è¯»HashMapæºç æ—¶ï¼Œä¼šå‘ç°åœ¨HashMapä¸­ä½¿ç”¨äº†çº¢é»‘æ ‘ï¼Œæ‰€ä»¥éœ€è¦å…ˆäº†è§£ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Œä»¥åŠå…¶åŸç†ã€‚ä»è€Œå†è¿›ä¸€æ­¥é˜…è¯»HashMapä¸­çš„é“¾è¡¨åˆ°çº¢é»‘æ ‘çš„è½¬æ¢ï¼Œçº¢é»‘æ ‘çš„å¢åˆ èŠ‚ç‚¹ç­‰ã€‚</p></blockquote><blockquote><ol><li>ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿ</li><li>åœ¨HashMapä¸­æ˜¯æ€ä¹ˆåº”ç”¨çš„ï¼Ÿ</li></ol></blockquote><h3 id="ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿ</h3><blockquote><p>çº¢é»‘æ ‘ï¼ˆè‹±è¯­ï¼šRedâ€“black treeï¼‰æ˜¯ä¸€ç§è‡ªå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ˜¯åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ç”¨åˆ°çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå…¸å‹çš„ç”¨é€”æ˜¯å®ç°å…³è”æ•°ç»„ã€‚å®ƒåœ¨1972å¹´ç”±é²é“å¤«Â·è´å°”å‘æ˜ï¼Œè¢«ç§°ä¸ºâ€å¯¹ç§°äºŒå‰Bæ ‘â€ï¼Œå®ƒç°ä»£çš„åå­—æºäºLeo J. Guibaså’ŒRobert Sedgewickäº1978å¹´å†™çš„ä¸€ç¯‡è®ºæ–‡ã€‚çº¢é»‘æ ‘çš„ç»“æ„å¤æ‚ï¼Œä½†å®ƒçš„æ“ä½œæœ‰ç€è‰¯å¥½çš„æœ€åæƒ…å†µè¿è¡Œæ—¶é—´ï¼Œå¹¶ä¸”åœ¨å®è·µä¸­é«˜æ•ˆï¼šå®ƒå¯ä»¥åœ¨O(logN)æ—¶é—´å†…å®ŒæˆæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤ï¼Œè¿™é‡Œçš„næ˜¯æ ‘ä¸­å…ƒç´ çš„æ•°ç›®ã€‚</p></blockquote><h3 id="çº¢é»‘æ ‘çš„æ€§è´¨"><a href="#çº¢é»‘æ ‘çš„æ€§è´¨" class="headerlink" title="çº¢é»‘æ ‘çš„æ€§è´¨"></a>çº¢é»‘æ ‘çš„æ€§è´¨</h3><p>çº¢é»‘æ ‘æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½å¸¦æœ‰é¢œè‰²å±æ€§çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œé¢œè‰²ä¸ºçº¢è‰²æˆ–é»‘è‰²ã€‚åœ¨äºŒå‰æŸ¥æ‰¾æ ‘å¼ºåˆ¶ä¸€èˆ¬è¦æ±‚ä»¥å¤–ï¼Œå¯¹äºä»»ä½•æœ‰æ•ˆçš„çº¢é»‘æ ‘æˆ‘ä»¬å¢åŠ äº†å¦‚ä¸‹çš„é¢å¤–è¦æ±‚ï¼š</p><ol><li>èŠ‚ç‚¹æ˜¯çº¢è‰²æˆ–é»‘è‰²ã€‚</li><li>æ ¹æ˜¯é»‘è‰²ã€‚</li><li>æ‰€æœ‰å¶å­éƒ½æ˜¯é»‘è‰²ï¼ˆå¶å­æ˜¯NILèŠ‚ç‚¹ï¼‰ã€‚</li><li>æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹å¿…é¡»æœ‰ä¸¤ä¸ªé»‘è‰²çš„å­èŠ‚ç‚¹ã€‚ï¼ˆä»æ¯ä¸ªå¶å­åˆ°æ ¹çš„æ‰€æœ‰è·¯å¾„ä¸Šä¸èƒ½æœ‰ä¸¤ä¸ªè¿ç»­çš„çº¢è‰²èŠ‚ç‚¹ã€‚ï¼‰</li><li>ä»ä»»ä¸€èŠ‚ç‚¹åˆ°å…¶æ¯ä¸ªå¶å­çš„æ‰€æœ‰ç®€å•è·¯å¾„éƒ½åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ã€‚</li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/red-black-tree001.jpeg" alt="çº¢é»‘æ ‘001"></p><h3 id="çº¢é»‘æ ‘æ“ä½œ"><a href="#çº¢é»‘æ ‘æ“ä½œ" class="headerlink" title="çº¢é»‘æ ‘æ“ä½œ"></a>çº¢é»‘æ ‘æ“ä½œ</h3><h4 id="å·¦æ—‹ã€å³æ—‹"><a href="#å·¦æ—‹ã€å³æ—‹" class="headerlink" title="å·¦æ—‹ã€å³æ—‹"></a>å·¦æ—‹ã€å³æ—‹</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/krck8S.gif" alt="krck8S"></p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/OUd2GL.gif" alt="OUd2GL"></p><h4 id="æ’å…¥"><a href="#æ’å…¥" class="headerlink" title="æ’å…¥"></a>æ’å…¥</h4><ol><li>ä»¥äºŒå‰æŸ¥æ‰¾æ ‘çš„æ–¹æ³•å¢åŠ èŠ‚ç‚¹</li><li>æ–°æ’å…¥èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼ˆå¦‚æœè®¾ä¸ºé»‘è‰²ï¼Œå°±ä¼šå¯¼è‡´æ ¹åˆ°å¶å­çš„è·¯å¾„ä¸Šæœ‰ä¸€æ¡è·¯ä¸Šï¼Œå¤šä¸€ä¸ªé¢å¤–çš„é»‘èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ˜¯å¾ˆéš¾è°ƒæ•´çš„ã€‚ä½†æ˜¯è®¾ä¸ºçº¢è‰²èŠ‚ç‚¹åï¼Œå¯èƒ½ä¼šå¯¼è‡´å‡ºç°ä¸¤ä¸ªè¿ç»­çº¢è‰²èŠ‚ç‚¹çš„å†²çªï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡é¢œè‰²è°ƒæ¢ï¼ˆcolor flipsï¼‰å’Œæ ‘æ—‹è½¬æ¥è°ƒæ•´ã€‚ï¼‰</li></ol><p>æ³¨æ„ï¼š</p><ol><li>æ€§è´¨1å’Œæ€§è´¨3æ˜¯æ°¸è¿œä¿æŒç€çš„ã€‚</li><li>æ€§è´¨4åªåœ¨å¢åŠ çº¢è‰²èŠ‚ç‚¹ã€é‡ç»˜é»‘è‰²èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œæˆ–åšæ—‹è½¬æ—¶å—åˆ°å¨èƒã€‚</li><li>æ€§è´¨5åªåœ¨å¢åŠ é»‘è‰²èŠ‚ç‚¹ã€é‡ç»˜çº¢è‰²èŠ‚ç‚¹ä¸ºé»‘è‰²ï¼Œæˆ–åšæ—‹è½¬æ—¶å—åˆ°å¨èƒã€‚</li></ol><p>æ’å…¥æ—¶ä¼šé‡åˆ°ä»¥ä¸‹äº”ç§æƒ…å½¢ï¼š</p><blockquote><p>æƒ…å½¢1ï¼šæ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹<br>æƒ…å½¢2ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²<br>æƒ…å½¢3ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²<br>æƒ…å½¢4ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²æˆ–ç¼ºçœï¼Œæ–°èŠ‚ç‚¹æ˜¯å³å­èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹åˆæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹<br>æƒ…å½¢5ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²æˆ–ç¼ºçœï¼Œæ–°èŠ‚ç‚¹æ˜¯å·¦å­èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹åˆæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ã€‚</p></blockquote><ul><li>æƒ…å½¢1ï¼š</li></ul><p>æ“ä½œï¼šæ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹<br>è¿åæ€§è´¨2ï¼šâ€ æ ¹æ˜¯é»‘è‰²ã€‚ â€œ<br>æƒ…å½¢ï¼šç›´æ¥æ’å…¥çº¢è‰²èŠ‚ç‚¹ï¼Œç„¶åè¿›è¡ŒæŸ“è‰²ä¸ºé»‘è‰²</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/red-black-tree1.gif" alt="çº¢é»‘æ ‘1"></p><ul><li>æƒ…å½¢2ï¼š</li></ul><p>æ“ä½œï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²<br>æœªè¿åæ€§è´¨<br>æƒ…å½¢ï¼šç›´æ¥æ’å…¥</p><ul><li>æƒ…å½¢3ï¼š</li></ul><p>æ“ä½œï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²<br>è¿åæ€§è´¨4ï¼šâ€ æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹å¿…é¡»æœ‰ä¸¤ä¸ªé»‘è‰²çš„å­èŠ‚ç‚¹ã€‚ â€œ<br>æƒ…å½¢ï¼šå°†ç¥–çˆ¶èŠ‚ç‚¹æŸ“è‰²ï¼Œç¥–çˆ¶èŠ‚ç‚¹æŸ“è‰²åå†è¿›è¡Œé‡æ–°åˆ¤æ–­è¿›è¡ŒæŸ“è‰²æˆ–æ—‹è½¬</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/red-black-tree3.gif" alt="çº¢é»‘æ ‘3"></p><ul><li>æƒ…å½¢4ï¼š</li></ul><p>æ“ä½œï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²æˆ–ç¼ºçœï¼Œæ–°èŠ‚ç‚¹æ˜¯å³å­èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹åˆæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹<br>è¿åæ€§è´¨4ï¼šâ€ æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹å¿…é¡»æœ‰ä¸¤ä¸ªé»‘è‰²çš„å­èŠ‚ç‚¹ã€‚ â€œ<br>æƒ…å½¢ï¼šè¿›è¡Œå·¦æ—‹ï¼Œæ—‹è½¬åçˆ¶èŠ‚ç‚¹å˜æˆå·¦å­èŠ‚ç‚¹ï¼Œæ–°èŠ‚ç‚¹å˜æˆçˆ¶èŠ‚ç‚¹ï¼Œç„¶åé‡æ–°åˆ¤æ–­è¿›è¡ŒæŸ“è‰²æˆ–æ—‹è½¬</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/red-black-tree4.gif" alt="çº¢é»‘æ ‘4"></p><ul><li>æƒ…å½¢5ï¼š</li></ul><p>æ“ä½œï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²æˆ–ç¼ºçœï¼Œæ–°èŠ‚ç‚¹æ˜¯å·¦å­èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹åˆæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ã€‚<br>è¿åæ€§è´¨4ï¼šâ€ æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹å¿…é¡»æœ‰ä¸¤ä¸ªé»‘è‰²çš„å­èŠ‚ç‚¹ã€‚ â€œ<br>æƒ…å½¢ï¼šçˆ¶èŠ‚ç‚¹æŸ“è‰²ä¸ºé»‘è‰²ï¼Œè¿›è¡Œå³æ—‹ï¼Œç¥–çˆ¶èŠ‚ç‚¹å˜ä¸ºå³å­èŠ‚ç‚¹ï¼Œç„¶åé‡æ–°åˆ¤æ–­è¿›è¡ŒæŸ“è‰²æˆ–æ—‹è½¬</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/red-black-tree5.gif" alt="çº¢é»‘æ ‘5"></p><h3 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h3><h4 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">    TreeNode&lt;K,V&gt; left;</span><br><span class="line">    TreeNode&lt;K,V&gt; right;</span><br><span class="line">    TreeNode&lt;K,V&gt; prev;    <span class="comment">// needed to unlink next upon deletion</span></span><br><span class="line">    <span class="keyword">boolean</span> red;</span><br><span class="line">    <span class="comment">// ... çœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¸‰ä¸ªå‚æ•°"><a href="#ä¸‰ä¸ªå‚æ•°" class="headerlink" title="ä¸‰ä¸ªå‚æ•°"></a>ä¸‰ä¸ªå‚æ•°</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é“¾è¡¨è½¬ä¸ºæ ‘é˜ˆå€¼ã€‚ </span></span><br><span class="line"><span class="comment"> * å¤§äºç­‰äº8æ—¶ï¼Œä¼šè½¬æ¢ä¸ºæ ‘ã€‚ </span></span><br><span class="line"><span class="comment"> * 8 æ˜¯ç»¼åˆæ€§èƒ½è€ƒè™‘ç¡®å®šçš„å€¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»æ ‘è½¬æ¢ä¸ºé“¾è¡¨çš„é˜ˆå€¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœ€å°æ ‘å½¢åŒ–å®¹é‡ï¼Œåªæœ‰å“ˆå¸Œè¡¨å…ƒç´ æ•°åˆ°è¾¾64æ‰ä¼šè¿›è¡Œæ ‘è½¬æ¢</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br></pre></td></tr></table></figure><h4 id="é“¾è¡¨è½¬çº¢é»‘æ ‘-treeifyBin"><a href="#é“¾è¡¨è½¬çº¢é»‘æ ‘-treeifyBin" class="headerlink" title="é“¾è¡¨è½¬çº¢é»‘æ ‘-treeifyBin"></a>é“¾è¡¨è½¬çº¢é»‘æ ‘-treeifyBin</h4><ol><li>æ•°ç»„ï¼ˆå“ˆå¸Œè¡¨ï¼‰é•¿åº¦åˆ°è¾¾64</li><li>å½“é“¾è¡¨é•¿åº¦å¤§äºç­‰äº8æ˜¯ä¼šå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> hash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, index; Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="comment">// æ•°ç»„ä¸ºnullæˆ–è€…æ•°ç»„é•¿åº¦å°äºMIN_TREEIFY_CAPACITYï¼ˆ64ï¼‰æ—¶ï¼Œè¿›è¡Œæ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">        resize();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((e = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¤´å°¾èŠ‚ç‚¹ hd-å¤´ tl-å°¾</span></span><br><span class="line">        TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºæ ‘èŠ‚ç‚¹ Node -&gt; TreeNode</span></span><br><span class="line">            <span class="comment">// å¾ªç¯æ‰§è¡Œå®Œä¹‹åå¾—åˆ°çš„æ˜¯åŒå‘é“¾è¡¨</span></span><br><span class="line">            TreeNode&lt;K,V&gt; p = replacementTreeNode(e, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</span><br><span class="line">                hd = p;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                p.prev = tl;</span><br><span class="line">                tl.next = p;</span><br><span class="line">            &#125;</span><br><span class="line">            tl = p;</span><br><span class="line">        &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// æ­¤æ—¶å¾—åˆ°çš„ä»…ä»…æ˜¯åŒå‘é“¾è¡¨</span></span><br><span class="line">        <span class="comment">// æŒ‡é’ˆæŒ‡å‘é“¾è¡¨å¤´</span></span><br><span class="line">        <span class="keyword">if</span> ((tab[index] = hd) != <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">// å°†åŒå‘é“¾è¡¨è½¬æ¢ä¸ºæ ‘</span></span><br><span class="line">            hd.treeify(tab);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeify</span><span class="params">(Node&lt;K,V&gt;[] tab)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; root = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; x = <span class="keyword">this</span>, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">        next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">        x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æƒ…å½¢1ï¼šæ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            x.parent = <span class="keyword">null</span>;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            root = x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹çš„ key å’Œ hash</span></span><br><span class="line">            K k = x.key;</span><br><span class="line">            <span class="keyword">int</span> h = x.hash;</span><br><span class="line">            Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// å†æ¬¡å¾ªç¯</span></span><br><span class="line">            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">                <span class="keyword">int</span> dir, ph;</span><br><span class="line">                <span class="comment">// å†…å±‚å¾ªç¯çš„key</span></span><br><span class="line">                K pk = p.key;</span><br><span class="line">                <span class="comment">// å½“å‰èŠ‚ç‚¹çš„hashå’Œå†…å±‚å¾ªç¯çš„hashå€¼ä½œæ¯”è¾ƒ</span></span><br><span class="line">                <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                    <span class="comment">// &lt; 0 leftæŸ¥æ‰¾</span></span><br><span class="line">                    dir = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                    <span class="comment">// &gt; 0 right æŸ¥æ‰¾</span></span><br><span class="line">                    dir = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                            (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                            (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">// æ¯”è¾ƒå¯¹è±¡</span></span><br><span class="line">                    dir = tieBreakOrder(k, pk);</span><br><span class="line"></span><br><span class="line">                TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                <span class="comment">// dir &lt;= 0 åˆ™èµ° leftæŸ¥æ‰¾ &gt; 0 åˆ™èµ° rightæŸ¥æ‰¾</span></span><br><span class="line">                <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.parent = xp;</span><br><span class="line">                    <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                        xp.left = x;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        xp.right = x;</span><br><span class="line">                    <span class="comment">// æ­£å¼è½¬æ¢ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">                    root = balanceInsertion(root, x);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    moveRootToFront(tab, root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// root æ ¹èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">// x è¦æ“ä½œçš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">balanceInsertion</span><span class="params">(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">    x.red = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// xpï¼šxçš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// xppï¼šxçš„ç¥–çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// xpplï¼šxç¥–çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// xpprï¼šxç¥–çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; xp, xpp, xppl, xppr;;) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æƒ…å½¢1ï¼š çˆ¶èŠ‚ç‚¹ä¸ºnullï¼Œ ç›´æ¥ç½®ä¸ºæ ¹</span></span><br><span class="line">        <span class="keyword">if</span> ((xp = x.parent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// çˆ¶èŠ‚ç‚¹é»‘è‰² æˆ–è€… ç¥–çˆ¶èŠ‚ç‚¹ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="comment">// æƒ…å½¢2ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!xp.red || (xpp = xp.parent) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (xp == (xppl = xpp.left)) &#123;</span><br><span class="line">            <span class="comment">// ç¥–çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸ä¸ºç©ºä¸”æ˜¯çº¢è‰²</span></span><br><span class="line">            <span class="comment">// æƒ…å½¢3ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²</span></span><br><span class="line">            <span class="keyword">if</span> ((xppr = xpp.right) != <span class="keyword">null</span> &amp;&amp; xppr.red) &#123;</span><br><span class="line">                xppr.red = <span class="keyword">false</span>; <span class="comment">//ç¥–çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰²</span></span><br><span class="line">                xp.red = <span class="keyword">false</span>; <span class="comment">// çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰²</span></span><br><span class="line">                xpp.red = <span class="keyword">true</span>; <span class="comment">// ç¥–çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºçº¢è‰²</span></span><br><span class="line">                x = xpp; <span class="comment">// ç»§ç»­æ“ä½œç¥–çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ—‹è½¬</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ–°æ’å…¥çš„æ˜¯å³å­èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (x == xp.right) &#123;</span><br><span class="line">                    <span class="comment">// æ’å…¥çš„xæ˜¯çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œ è¿›è¡Œå·¦æ—‹</span></span><br><span class="line">                    root = rotateLeft(root, x = xp);</span><br><span class="line">                    xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰²</span></span><br><span class="line">                    xp.red = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="comment">// å³æ—‹</span></span><br><span class="line">                        root = rotateRight(root, xpp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ç¥–çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸ä¸ºç©ºä¸”ä¸ºçº¢è‰²</span></span><br><span class="line">            <span class="keyword">if</span> (xppl != <span class="keyword">null</span> &amp;&amp; xppl.red) &#123;</span><br><span class="line">                xppl.red = <span class="keyword">false</span>; <span class="comment">// ç¥–çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰²</span></span><br><span class="line">                xp.red = <span class="keyword">false</span>; <span class="comment">// çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰²</span></span><br><span class="line">                xpp.red = <span class="keyword">true</span>; <span class="comment">// ç¥–çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºçº¢è‰²</span></span><br><span class="line">                x = xpp; <span class="comment">// ç»§ç»­æ“ä½œç¥–çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ—‹è½¬</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (x == xp.left) &#123;</span><br><span class="line">                    root = rotateRight(root, x = xp);</span><br><span class="line">                    xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    xp.red = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                        root = rotateLeft(root, xpp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- HashMapæ‰©å®¹</title>
      <link href="2020/05/17/source-code-hashmap-resize.html"/>
      <url>2020/05/17/source-code-hashmap-resize.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>æè¿°ä¸‹HashMap put(k,v)çš„æµç¨‹ï¼Ÿ<br>å®ƒçš„æ‰©å®¹æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</p></blockquote><h3 id="HashMap-put-k-v-æµç¨‹"><a href="#HashMap-put-k-v-æµç¨‹" class="headerlink" title="HashMap put(k,v)æµç¨‹"></a>HashMap put(k,v)æµç¨‹</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/3pSob4.png" alt="3pSob4"></p><ol><li>é€šè¿‡hash(keyæ–¹æ³•)è·å–åˆ°keyçš„hashå€¼</li><li>è°ƒç”¨putæ–¹æ³•, å°†valueå­˜æ”¾åˆ°æŒ‡å®šçš„ä½ç½®<ol><li>æ ¹æ®hashå€¼ç¡®å®šå½“å‰keyæ‰€åœ¨nodeæ•°ç»„çš„ç´¢å¼• <code>(n - 1) &amp; hash</code></li><li>å¦‚æœnode[i]==null åˆ™ç›´æ¥åˆ›å»ºæ–°æ•°ç»„</li><li>å¦‚æœnode[i]!=null<ol><li>åˆ¤æ–­ å½“å‰nodeçš„å¤´ç»“ç‚¹çš„ hashå’Œkeyæ˜¯å¦éƒ½ç›¸ç­‰, ç›¸ç­‰åˆ™éœ€è¦æ“ä½œçš„å°±æ˜¯è¯¥node</li><li>åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºTreeNodeï¼Œå¯¹TreeNodeè¿›è¡Œæ“ä½œï¼Œå¹¶è¿”å›ç»“æœe</li><li>å¦‚æœæ˜¯é“¾è¡¨åˆ™éå†é“¾è¡¨ï¼Œkeyå­˜åœ¨åˆ™è¿”å›èŠ‚ç‚¹eï¼Œä¸å­˜åœ¨åˆ™èµ‹å€¼</li><li>åˆ¤æ–­èŠ‚ç‚¹eæœ‰æ²¡æœ‰è¢«èµ‹å€¼ï¼Œè¦†ç›–æ—§å€¼</li></ol></li><li>hashMap sizeè¿›è¡ŒåŠ 1ï¼ŒåŒæ—¶åˆ¤æ–­væ–°sizeæ˜¯å¦å¤§äºæ‰©å®¹é˜ˆå€¼ä»è€Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹</li></ol></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å£°æ˜Nodeæ•°ç»„tab, NodeèŠ‚ç‚¹</span></span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">        <span class="comment">// å¯¹tabæ•°ç»„èµ‹å€¼ä¸ºå½“å‰HashMapçš„table, å¹¶åˆ¤æ–­æ˜¯å¦ä¸ºç©º, æˆ–è€…é•¿åº¦ä¸º0</span></span><br><span class="line">        <span class="comment">// ä¸º0è¿›è¡Œåˆ™resize()æ•°ç»„, å¹¶å¯¹ nèµ‹å€¼ä¸ºå½“å‰tabçš„é•¿åº¦</span></span><br><span class="line">        <span class="comment">// resize() å¯¹HashMapçš„tableæ‰©å®¹, å¹¶è¿”å›æ‰©å®¹åçš„æ–°æ•°ç»„</span></span><br><span class="line">        <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            n = (tab = resize()).length;</span><br><span class="line">        <span class="comment">// å¯¹ node p è¿›è¡Œèµ‹å€¼, æ•°ç»„æ‰€åœ¨ä½ç½® å³ node p å¦‚æœæ˜¯null åˆ™ç›´æ¥èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">            tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// p ä¸ä¸ºnull, å£°æ˜ node e, key k</span></span><br><span class="line">            Node&lt;K,V&gt; e; K k;</span><br><span class="line">            <span class="comment">// å¦‚æœhashå€¼ç›¸ç­‰ä¸”keyç›¸ç­‰, ç›´æ¥å°† e èµ‹å€¼ä¸ºå½“å‰nodeçš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">                ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                e = p;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯çº¢é»‘æ ‘, åˆ™å¯¹æ ‘è¿›è¡Œæ“ä½œ, è¿”å›èŠ‚ç‚¹e</span></span><br><span class="line">                e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¯¹é“¾è¡¨è¿›è¡Œéå†, æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                    <span class="comment">// å°† e èµ‹å€¼ä¸º  å¤´èŠ‚ç‚¹pçš„next, å¦‚æœä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºnull</span></span><br><span class="line">                    <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// å¯¹èŠ‚ç‚¹è¿›è¡Œèµ‹å€¼</span></span><br><span class="line">                        p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                        <span class="comment">// å¦‚æœé•¿åº¦åˆ°è¾¾æ•°è½¬æ¢é˜ˆå€¼, åˆ™éœ€è¦è½¬æ¢ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">                        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                            treeifyBin(tab, hash);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¦‚æœeèŠ‚ç‚¹çš„hashç›¸ç­‰, keyç›¸ç­‰, åˆ™ ç›´æ¥è·³å‡ºå¾ªç¯ e å·²ç»è¢«èµ‹å€¼ä¸º p.next</span></span><br><span class="line">                    <span class="comment">// æ­¤æ—¶eèŠ‚ç‚¹çš„valueæ²¡æœ‰è¢«èµ‹å€¼</span></span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                        ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">// æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹, ç»§ç»­éå†</span></span><br><span class="line">                    p = e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">                V oldValue = e.value;</span><br><span class="line">                <span class="comment">// å¯¹æ—§å€¼è¿›è¡Œè¦†ç›–, å¹¶è¿”å›æ—§å€¼</span></span><br><span class="line">                <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                    e.value = value;</span><br><span class="line">                afterNodeAccess(e);</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ++modCount;</span><br><span class="line">        <span class="comment">// æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line">        <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">            resize();</span><br><span class="line">        afterNodeInsertion(evict);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="resize-æ‰©å®¹è¿‡ç¨‹"><a href="#resize-æ‰©å®¹è¿‡ç¨‹" class="headerlink" title="resize()æ‰©å®¹è¿‡ç¨‹"></a>resize()æ‰©å®¹è¿‡ç¨‹</h3><ol><li>JDK 1.7 æ‰©å®¹æµç¨‹, æ¯æ¬¡éƒ½éœ€è¦æ•°ç»„æ‰©å®¹å, é“¾è¡¨éœ€è¦é‡æ–°è®¡ç®—åœ¨æ–°æ•°ç»„çš„ä½ç½®</li><li>JDK 1.8 ä¸éœ€è¦é‡æ–°è®¡ç®— (ä¼˜åŒ–ç‚¹)<ol><li>æ•°ç»„ä¸‹æ ‡: (n - 1) &amp; hash å³æ•°ç»„é•¿åº¦-1 &amp; keyçš„hash</li><li>æ‰©å®¹åçš„æ•°ç»„ä¸‹æ ‡: ((n &lt;&lt; 1) - 1) &amp; hash ç›¸å½“äºåœ¨ é«˜ä½1ä¹‹å‰åŠ äº†ä¸ª1</li></ol></li></ol><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/GRQHSY.png" alt="GRQHSY"></p><p>å¦‚å›¾æ‰€ç¤º, çœŸæ­£å‘ç”Ÿå½±å“çš„æ˜¯æ–°å¢çš„é‚£ä¸€ä½(çº¢è‰²ç®­å¤´æ‰€æŒ‡), æ‰€ä»¥ oldCap &amp; hash å®Œå…¨å¯ä»¥åˆ¤æ–­è¯¥å€¼æ˜¯æ”¾åœ¨æ—§ç´¢å¼•å€¼çš„ä½ç½®è¿˜æ˜¯æ”¾åœ¨æ—§ç´¢å¼•å€¼+æ—§æ•°ç»„é•¿åº¦çš„ä½ç½®</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    <span class="comment">// æ—§æ•°ç»„</span></span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="comment">// æ—§æ•°ç»„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="comment">// æ—§çš„æ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="comment">// æ–°çš„æ•°ç»„é•¿åº¦å’Œæ–°æ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// æ—§æ•°ç»„å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ–°æ•°ç»„é•¿åº¦ä¸ºæ—§æ•°ç»„é•¿åº¦çš„2å€</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            <span class="comment">// æ‰©å®¹é˜ˆå€¼æ˜¯æ—§æ‰©å®¹é˜ˆå€¼çš„2å€</span></span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ—§æ•°ç»„ä¸å­˜åœ¨, ç›¸å½“äºé¦–æ¬¡put(K, V)æ—¶, å°†æ•°ç»„é•¿åº¦ç½®ä¸ºæ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">        <span class="comment">// æ—§æ•°ç»„ä¸å­˜åœ¨, new HashMap()æœªæŒ‡å®šé•¿åº¦, åˆæ¬¡put(K, V), è®¾ç½®ä¸ºé»˜è®¤å€¼</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ–°çš„æ‰©å®¹é˜ˆå€¼æ˜¯0, åˆ™å°†æ‰©å®¹é˜ˆå€¼è®¾ç½®ä¸º æ–°æ•°ç»„é•¿åº¦*è´Ÿè½½å› å­</span></span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯¹å…¨å±€çš„æ‰©å®¹é˜ˆå€¼è¿›è¡Œèµ‹å€¼</span></span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°æ•°ç»„, é•¿åº¦ä¸ºæ–°é•¿åº¦, å³åŸæ•°ç»„é•¿åº¦çš„2å€</span></span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    <span class="comment">// å°†tableå¤åˆ¶ä¸ºæ–°æ•°ç»„</span></span><br><span class="line">    table = newTab;</span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¯¹æ—§æ•°ç»„è¿›è¡Œéå†</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="comment">// æ—§èŠ‚ç‚¹nodeèµ‹å€¼</span></span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                <span class="comment">// åªæœ‰å¤´ç»“ç‚¹, ç›´æ¥è®¡ç®—æ–°çš„ä½ç½®å¹¶èµ‹å€¼</span></span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="comment">// æ ‘å•ç‹¬å¤„ç†</span></span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="comment">// nextèŠ‚ç‚¹</span></span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="comment">// èŠ‚ç‚¹hashä¸æ—§æ•°ç»„é•¿åº¦ &amp; çš„ç»“æœæ¥å†³å®šå…ƒç´ æ‰€åœ¨ä½ç½®, å‚è€ƒä¸Šé¢å›¾ç¤ºæ‰€è®²</span></span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// åœ¨å…ƒç´¢å¼•å‡ºåˆ›å»ºæ–°é“¾è¡¨</span></span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// æ–°ç´¢å¼•å‡ºåˆ›å»ºé“¾è¡¨</span></span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="comment">// ç´¢å¼•jå¤„ç›´æ¥èµ‹å€¼</span></span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="comment">// ç´¢å¼• j + è€æ•°ç»„é•¿åº¦ä½ç½®å­˜æ”¾hiHead</span></span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JDKæºç ç¬”è®°ã€‘- HashMapçš„åˆå§‹åŒ–</title>
      <link href="2020/05/11/source-code-hashmap-init.html"/>
      <url>2020/05/11/source-code-hashmap-init.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>HashMapåˆå§‹åŒ–å‚æ•°éƒ½æ˜¯ä»€ä¹ˆï¼Ÿé»˜è®¤æ˜¯å¤šå°‘ï¼Ÿ<br>ä¸ºä»€ä¹ˆå»ºè®®åˆå§‹åŒ–è®¾ç½®å®¹é‡ï¼Ÿ<br>tableSizeForæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ<br>å¦‚ä½•è·å–åˆ°ä¸€ä¸ªkeyçš„hashå€¼ï¼ŸåŠè®¡ç®—ä¸‹æ ‡ï¼Ÿ</p></blockquote><h3 id="HashMapåˆå§‹åŒ–å‚æ•°éƒ½æ˜¯ä»€ä¹ˆï¼Ÿé»˜è®¤æ˜¯å¤šå°‘ï¼Ÿ"><a href="#HashMapåˆå§‹åŒ–å‚æ•°éƒ½æ˜¯ä»€ä¹ˆï¼Ÿé»˜è®¤æ˜¯å¤šå°‘ï¼Ÿ" class="headerlink" title="HashMapåˆå§‹åŒ–å‚æ•°éƒ½æ˜¯ä»€ä¹ˆï¼Ÿé»˜è®¤æ˜¯å¤šå°‘ï¼Ÿ"></a>HashMapåˆå§‹åŒ–å‚æ•°éƒ½æ˜¯ä»€ä¹ˆï¼Ÿé»˜è®¤æ˜¯å¤šå°‘ï¼Ÿ</h3><p>HashMapåˆå§‹åŒ–å‚æ•°åˆ†åˆ«æ˜¯åˆå§‹å®¹é‡å’Œè´Ÿè½½å› å­ã€‚</p><p>åˆå§‹å®¹é‡(threshold)ï¼šé»˜è®¤ 16ï¼Œ å¿…é¡»æ˜¯2çš„å¹‚ï¼Œ æœ€å¤§å®¹é‡ä¸º 1 &lt;&lt; 30</p><p>è´Ÿè½½å› å­(loadFactor)ï¼šæ˜¯æŒ‡å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ï¼Œå½“å“ˆå¸Œè¡¨çš„é•¿åº¦å¤§äº<code>capacity * loadFactor</code>æ—¶ä¼šè¿›è¡Œæ‰©å®¹ï¼Œé»˜è®¤ 0.75f</p><h3 id="ä¸ºä»€ä¹ˆå»ºè®®åˆå§‹åŒ–è®¾ç½®å®¹é‡"><a href="#ä¸ºä»€ä¹ˆå»ºè®®åˆå§‹åŒ–è®¾ç½®å®¹é‡" class="headerlink" title="ä¸ºä»€ä¹ˆå»ºè®®åˆå§‹åŒ–è®¾ç½®å®¹é‡"></a>ä¸ºä»€ä¹ˆå»ºè®®åˆå§‹åŒ–è®¾ç½®å®¹é‡</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/3aQLYq.png" alt="3aQLYq"></p><p>è¿™å—æ¶‰åŠåˆ°HashMapçš„æ‰©å®¹ï¼Œ åœ¨<code>é˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œ</code>ä¸­å·²ç»è¯´æ˜äº†åŸå› ã€‚ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘é¢‘ç¹çš„æ‰©å®¹é€ æˆçš„èµ„æºæŸè€—ã€‚</p><h3 id="tableSizeForæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"><a href="#tableSizeForæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ" class="headerlink" title="tableSizeForæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"></a>tableSizeForæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</h3><p>åˆå§‹åŒ–HashMapæ—¶, å¦‚æœä¼ å…¥åˆå§‹å®¹é‡, åœ¨åˆå§‹åŒ–æ—¶ä¼šè°ƒç”¨ <code>tableSizeFor(initialCapacity)</code> æ–¹æ³•å¯»æ‰¾å¤§äºç­‰äºå½“å‰å€¼çš„ä¸‹ä¸€ä¸ª2çš„å¹‚å€¼.</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = cap - <span class="number">1</span>; <span class="comment">//  -1æ“ä½œ, é˜²æ­¢å½“capæ­£å¥½æ˜¯2çš„å¹‚æ—¶çš„å¤„ç†</span></span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>; <span class="comment">// næ— ç¬¦å·å³ç§»1ä½, ç„¶åå’Œnåš | è¿ç®—, (1|0=1 1|1=1 0|0=0 0|1=1)</span></span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>; <span class="comment">// næ— ç¬¦å·å³ç§»2ä½, ç„¶åå’Œnåš | è¿ç®—,</span></span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>; <span class="comment">// næ— ç¬¦å·å³ç§»4ä½, ç„¶åå’Œnåš | è¿ç®—,</span></span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>; <span class="comment">// næ— ç¬¦å·å³ç§»8ä½, ç„¶åå’Œnåš | è¿ç®—,</span></span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>; <span class="comment">// næ— ç¬¦å·å³ç§»16ä½, ç„¶åå’Œnåš | è¿ç®—,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åè·å¾—çš„ç»“æœä¸º cap-1çš„ä¸‹ä¸€ä¸ª2çš„å¹‚å€¼-1, åªéœ€è¦å¯¹n+1å³å¯</span></span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å‡è®¾capå€¼ä¸º100, å³0110 0100</li><li>capçš„ä¸‹ä¸€ä¸ª2çš„å¹‚ä¸º 0111 1111 å³ 1000 0000</li><li>0000 = 0111 1111 + 1</li><li>åªéœ€è¦è€ƒè™‘å°† é¦–ä¸ªä¸º1çš„æœ€é«˜ä½ä¹‹åçš„å€¼ç½®ä¸º1, ç„¶å+1å³å¯</li><li>ä¸ºé˜²æ­¢capæœ¬æ¥å°±æ˜¯2çš„å¹‚, åˆ™éœ€è¦å…ˆè¿›è¡Œå‡ä¸€æ“ä½œ</li></ol><p>å¦‚å›¾æ‰€ç¤º:<br><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/51Xhtj.png" alt="51Xhtj"></p><p>æœ€åæ‰§è¡Œçš„ç»“æœè¿›è¡ŒåŠ 1å³å¯</p><h3 id="å¦‚ä½•è·å–åˆ°ä¸€ä¸ªkeyçš„hashå€¼ï¼Ÿ"><a href="#å¦‚ä½•è·å–åˆ°ä¸€ä¸ªkeyçš„hashå€¼ï¼Ÿ" class="headerlink" title="å¦‚ä½•è·å–åˆ°ä¸€ä¸ªkeyçš„hashå€¼ï¼Ÿ"></a>å¦‚ä½•è·å–åˆ°ä¸€ä¸ªkeyçš„hashå€¼ï¼Ÿ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="comment">// keyçš„hashCode ^ ä¸Šè‡ªå·±çš„é«˜16ä½ï¼Œ å¦‚æœæ˜¯nullçš„è¯åˆ™hashä¸º0</span></span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–åˆ°äº†hashå€¼ï¼Œ é‚£å¦‚ä½•è®¡ç®—åœ¨æ•°ç»„çš„é‚£ä¸ªä½ç½®å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// nä¸ºæ•°ç»„é•¿åº¦  æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">i = (n - <span class="number">1</span>) &amp; hash</span><br></pre></td></tr></table></figure><p>æ•°ç»„é•¿åº¦éƒ½æ˜¯ 2çš„å¹‚<br>å‡è®¾ n = 1 &gt;&gt; x<br>åˆ™ n - 1 åˆ™è¡¨ç¤º ä¸€ä¸ªä½xä½å…¨ä¸º1çš„æ•°</p><p>(n - 1) &amp; hash åˆ™ç›¸å½“äº ä¸€ä¸ªä½xä½å…¨ä¸º1çš„æ•°å’Œhashåš&amp;æ“ä½œ.</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/OAZssV.png" alt="OAZssV"></p><p>é€šè¿‡å›¾å¯ä»¥çœ‹å‡º, å‚ä¸è¿ç®—çš„åªæœ‰ä½xä½, ç›¸å½“äºä¹‹å‰çš„æ‰€æœ‰å€¼éƒ½ä¸ä¼šæœ‰æ•ˆ. æ‰€ä»¥å‰é¢çš„hash(key) å°†key.hashCode()é«˜ä½16ä½åš^æ“ä½œ, å¯ä»¥ä¿è¯, é«˜ä½16ä½éƒ½èƒ½å‚ä¸è¿ç®—.ä¸€å®šç¨‹åº¦ä¸Šé¿å…hashç¢°æ’.åœ¨æºç æ³¨é‡Šä¸­å·²ç»è¯´æ˜, æ˜¯è‚¯å®šä¼šæœ‰ç¢°æ’, ä½†æ˜¯è¿™æ˜¯æƒè¡¡ä¹‹åçš„ç»“æœ.</p>]]></content>
      
      
      <categories>
          
          <category> æºç ç¬”è®° </category>
          
          <category> JDK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç ç¬”è®° </tag>
            
            <tag> JDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>markdownä»£ç æŠ˜å </title>
      <link href="2020/04/20/markdown-code-folding.html"/>
      <url>2020/04/20/markdown-code-folding.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="æ•ˆæœå±•ç¤º"><a href="#æ•ˆæœå±•ç¤º" class="headerlink" title="æ•ˆæœå±•ç¤º"></a>æ•ˆæœå±•ç¤º</h3><h4 id="æŠ˜å å†…å®¹"><a href="#æŠ˜å å†…å®¹" class="headerlink" title="æŠ˜å å†…å®¹"></a>æŠ˜å å†…å®¹</h4><details><summary>æŠ˜å å†…å®¹</summary>åœ¨markdownä¸­æŠ˜å ä¸€éƒ¨åˆ†å†…å®¹, ç‚¹å‡»å¯ä»¥å±•å¼€.</details><h4 id="æŠ˜å ä»£ç "><a href="#æŠ˜å ä»£ç " class="headerlink" title="æŠ˜å ä»£ç "></a>æŠ˜å ä»£ç </h4><details><summary>æŠ˜å ä»£ç </summary><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;HelloWorld&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><h3 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h3><p>ä½¿ç”¨html</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">details</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">summary</span>&gt;</span>æŠ˜å å†…å®¹<span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line">åœ¨markdownä¸­æŠ˜å ä¸€éƒ¨åˆ†å†…å®¹, ç‚¹å‡»å¯ä»¥å±•å¼€.</span><br><span class="line"><span class="tag">&lt;/<span class="name">details</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">summary</span>&gt;</span>æŠ˜å ä»£ç <span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> ä»£ç å—</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">details</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> markdown </category>
          
      </categories>
      
      
        <tags>
            
            <tag> markdown </tag>
            
            <tag> å°æŠ€å·§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é›ªèŠ±ç®—æ³•</title>
      <link href="2020/04/13/snowflake-algorithm.html"/>
      <url>2020/04/13/snowflake-algorithm.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>ç®€å•ä»‹ç»ä¸‹é›ªèŠ±ç®—æ³•, ä»¥åŠJavaç‰ˆé›ªèŠ±ç®—æ³•çš„ä»£ç .<br>ä»…ä»…æ˜¯ä¸€ä¸ªæœ€ç®€å•ç‰ˆæœ¬, æ›´æ·±å±‚æ¬¡çš„æŒ‡é’ˆå›æ‹¨ç­‰. ç›¸å½“äºåœ¨å¼€å‘è¿‡æˆåŠŸå¯ä»¥å…ˆä½¿ç”¨.<br>å°½é‡è¿˜æ˜¯ä½¿ç”¨ç»Ÿä¸€çš„åˆ†å¸ƒå¼æµæ°´å·ç”Ÿæˆç³»ç»Ÿ, ä¿è¯æµæ°´å·å…¨å±€å”¯ä¸€.</p></blockquote><h3 id="é›ªèŠ±ç®—æ³•"><a href="#é›ªèŠ±ç®—æ³•" class="headerlink" title="é›ªèŠ±ç®—æ³•"></a>é›ªèŠ±ç®—æ³•</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0 0000000000 0000000000 0000000000 0000000000 0 00000 00000 000000000000</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨64ä½longå‹æ•°å­—ä½œä¸ºå…¨å±€å”¯ä¸€id<br>1ä½ æ— æ„ä¹‰ 0<br>41ä½ æ—¶é—´æˆ³<br>5ä½ æœºæˆ¿id<br>5ä½ æœºå™¨id<br>12ä½è‡ªå¢åºå· è¡¨ç¤ºåŒä¸€æ—¶é—´åŒä¸€æœºæˆ¿åŒä¸€æœºå™¨ç”Ÿæˆçš„åºåˆ—å·</p><ol><li><p>ç¬¬ä¸€ä½ä¸ºä»€ä¹ˆæ— æ„ä¹‰<br> äºŒè¿›åˆ¶ä¸­ ç¬¬ä¸€ä½ä»£è¡¨ç¬¦å·ä½, é»˜è®¤ 0 è¡¨ç¤ºç”Ÿæˆçš„åºåˆ—å·ä¸ºæ­£æ•°</p></li><li><p>41ä½æ—¶é—´æˆ³<br> 41ä½æœ€å¤§èƒ½è¡¨ç¤º 2^41-1 çš„æ•°å­—. æ¯«ç§’å€¼ 69.7å¹´<br> (2^41-1)/1000/60/60/24</p><p> å½“æ—¶é—´å¤§äº69.7å³æ—¶é—´æˆ³å·®å€¼å¤§äº 2199023255551, ä¼šå¼€å§‹å‡ºç°è´Ÿå€¼æµæ°´å·</p></li><li><p>10ä½<br> æœºæˆ¿id+æœºå™¨id 2^10 1024å°æœºå™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½†æ˜¯ä½¿ç”¨ä¸­ä¸å¯èƒ½æ¯éƒ¨ç½²ä¸€å°æœºå™¨éƒ½æ”¹ä¸‹ç¼–å·, æ‰€ä»¥æˆ‘åšå‡ºä»¥ä¸‹æ”¹åŠ¨</span></span><br><span class="line"><span class="comment">// 8ä½æœºå™¨å·(æœ€å¤§256) 2ä½æœºæˆ¿å·</span></span><br><span class="line"><span class="comment">// æœºå™¨å·ä½¿ç”¨IPåœ°å€åä¸‰ä½ æœºæˆ¿id é»˜è®¤1</span></span><br><span class="line"><span class="comment">// åªéœ€è¦ç¡®ä¿æœºå™¨çš„ipåä¸‰ä½ä¸åŒå³å¯</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MACHINE_BIT = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DATA_CENTER_BIT = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DATA_CENTER_ID = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> address;</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    InetAddress localIp = IpUtils.getLocalIp();</span><br><span class="line">    address = localIp.getAddress()[<span class="number">3</span>] &amp; <span class="number">0xff</span>;</span><br><span class="line">    log.info(<span class="string">&quot;å½“å‰ç³»ç»Ÿçš„ address ä¸º: &#123;&#125;&quot;</span>, address);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>12ä½åºåˆ—å·<br> è¡¨ç¤ºåŒä¸€æ¯«ç§’å†…ç”Ÿæˆçš„id 2^12-1 ä¸ªæ­£æ•´æ•°</p></li></ol><p>SnowFlakeæ¯ç§’èƒ½å¤Ÿäº§ç”Ÿ26ä¸‡IDå·¦å³</p><p>ä¼˜ç‚¹:<br>ç”ŸæˆIDæ—¶ä¸ä¾èµ–äºDBï¼Œå®Œå…¨åœ¨å†…å­˜ç”Ÿæˆï¼Œé«˜æ€§èƒ½é«˜å¯ç”¨ã€‚<br>IDå‘ˆè¶‹åŠ¿é€’å¢ï¼Œåç»­æ’å…¥ç´¢å¼•æ ‘çš„æ—¶å€™æ€§èƒ½è¾ƒå¥½ã€‚<br>ç¼ºç‚¹:<br>ä¾èµ–äºç³»ç»Ÿæ—¶é’Ÿçš„ä¸€è‡´æ€§ã€‚å¦‚æœæŸå°æœºå™¨çš„ç³»ç»Ÿæ—¶é’Ÿå›æ‹¨ï¼Œæœ‰å¯èƒ½é€ æˆIDå†²çªï¼Œæˆ–è€…IDä¹±åº</p><h3 id="SerialNumber"><a href="#SerialNumber" class="headerlink" title="SerialNumber"></a>SerialNumber</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialNumber</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ·å§‹çš„æ—¶é—´æˆ³ 2018-01-01 00:00:00</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> START_STAMP = <span class="number">1514736000000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¯ä¸€éƒ¨åˆ†å ç”¨çš„ä½æ•°</span></span><br><span class="line"><span class="comment">     * åºåˆ—å· å ç”¨ä½æ•° 12 ä½ (åŒä¸€æ¯«ç§’å†…ç”Ÿæˆçš„id 2^12-1 ä¸ªæ­£æ•´æ•°)</span></span><br><span class="line"><span class="comment">     * æœºå™¨æ ‡è¯†  å ç”¨ä½æ•° 8 ä½ (ä¸€èˆ¬æ˜¯ä½¿ç”¨5ä½)</span></span><br><span class="line"><span class="comment">     * æ•°æ®ä¸­å¿ƒ å ç”¨ä½æ•° 2 ä½ (ä¸€èˆ¬æ˜¯ä½¿ç”¨5ä½)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SEQUENCE_BIT = <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MACHINE_BIT = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DATA_CENTER_BIT = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¯ä¸€éƒ¨åˆ†çš„æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_DATA_CENTER_NUM = ~(-<span class="number">1L</span> &lt;&lt; DATA_CENTER_BIT);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_MACHINE_NUM = ~(-<span class="number">1L</span> &lt;&lt; MACHINE_BIT);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_SEQUENCE = ~(-<span class="number">1L</span> &lt;&lt; SEQUENCE_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¯ä¸€éƒ¨åˆ†å‘å·¦çš„ä½ç§»</span></span><br><span class="line"><span class="comment">     * æœºå™¨Idå·¦ç§»12ä½ (SEQUENCE_BIT = 12)</span></span><br><span class="line"><span class="comment">     * æ•°æ®ä¸­å¿ƒå·¦ç§»20ä½ (SEQUENCE_BIT + MACHINE_BIT = 12 + 8)</span></span><br><span class="line"><span class="comment">     * æ—¶é—´æˆ³å·¦ç§»22ä½ (DATA_CENTER_LEFT + DATA_CENTER_BIT = 12 + 8 + 2)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MACHINE_LEFT = SEQUENCE_BIT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DATA_CENTER_LEFT = SEQUENCE_BIT + MACHINE_BIT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TIME_STAMP_LEFT = DATA_CENTER_LEFT + DATA_CENTER_BIT;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ•°æ®ä¸­å¿ƒ æœºå™¨æ ‡è¯† åºåˆ—å· ä¸Šä¸€æ¬¡æ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment">     * æ•°æ®ä¸­å¿ƒæ ‡è¯†å’Œæœºå™¨æ ‡è¯†ä¸€èˆ¬æ˜¯å¤–éƒ¨ä¼ å…¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DATA_CENTER_ID = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> address;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sequence = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastStamp = -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern(<span class="string">&quot;yyMMdd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">      InetAddress localIp = IpUtils.getLocalIp();</span><br><span class="line">      address = localIp.getAddress()[<span class="number">3</span>] &amp; <span class="number">0xff</span>;</span><br><span class="line">      log.info(<span class="string">&quot;å½“å‰ç³»ç»Ÿçš„ address ä¸º: &#123;&#125;&quot;</span>, address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * äº§ç”Ÿä¸‹ä¸€ä¸ªID</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">nextId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> currStamp = getNewStamp();</span><br><span class="line">        <span class="keyword">if</span> (currStamp &lt; lastStamp) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Clock moved backwards.  Refusing to generate id&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currStamp == lastStamp) &#123;</span><br><span class="line">            <span class="comment">// ç›¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·è‡ªå¢ (sequence + 1) &amp; (~(-1L &lt;&lt; SEQUENCE_BIT))</span></span><br><span class="line">            sequence = (sequence + <span class="number">1</span>) &amp; MAX_SEQUENCE;</span><br><span class="line">            <span class="comment">// åŒä¸€æ¯«ç§’çš„åºåˆ—æ•°å·²ç»è¾¾åˆ°æœ€å¤§</span></span><br><span class="line">            <span class="keyword">if</span> (sequence == <span class="number">0L</span>) &#123;</span><br><span class="line">                currStamp = getNextMill();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·ç½®ä¸º0</span></span><br><span class="line">            sequence = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastStamp = currStamp;</span><br><span class="line">        <span class="comment">// æ—¶é—´æˆ³éƒ¨åˆ† æ•°æ®ä¸­å¿ƒéƒ¨åˆ† æœºå™¨æ ‡è¯†éƒ¨åˆ† åºåˆ—å·éƒ¨åˆ†</span></span><br><span class="line">        <span class="keyword">return</span> (currStamp - START_STAMP) &lt;&lt; TIME_STAMP_LEFT | DATA_CENTER_ID &lt;&lt; DATA_CENTER_LEFT</span><br><span class="line">            | address &lt;&lt; MACHINE_LEFT | sequence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getNextMill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> mill = getNewStamp();</span><br><span class="line">        <span class="keyword">while</span> (mill &lt;= lastStamp) &#123;</span><br><span class="line">            mill = getNewStamp();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getNewStamp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="IpUtils"><a href="#IpUtils" class="headerlink" title="IpUtils"></a>IpUtils</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/12/19 16:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IpUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InetAddress <span class="title">getLocalIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Enumeration&lt;NetworkInterface&gt; e = NetworkInterface.getNetworkInterfaces(); e.hasMoreElements(); ) &#123;</span><br><span class="line">                NetworkInterface item = e.nextElement();</span><br><span class="line">                <span class="keyword">for</span> (InterfaceAddress address : item.getInterfaceAddresses()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (item.isLoopback() || !item.isUp()) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (address.getAddress() <span class="keyword">instanceof</span> Inet4Address) &#123;</span><br><span class="line">                        <span class="keyword">return</span> address.getAddress();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> InetAddress.getLocalHost();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SocketException | UnknownHostException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
            <tag> æµæ°´å· </tag>
            
            <tag> é›ªèŠ±ç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¡¹ç›®å¯åŠ¨å¤±è´¥:java.lang.NoClassDefFoundError</title>
      <link href="2020/04/12/no-class-def-found-error-rule-configuration.html"/>
      <url>2020/04/12/no-class-def-found-error-rule-configuration.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>è¿‘æœŸé‡åˆ°ä¸€ä¸ªå¾ˆä¹…æ²¡æœ‰å¯åŠ¨è¿‡çš„é¡¹ç›®, ç„¶åå¯åŠ¨å¤±è´¥, æŠ¥ java.lang.NoClassDefFoundError, ç°åœ¨è®°å½•é—®é¢˜æ’æŸ¥æƒ…å†µ.</p></blockquote><h4 id="é”™è¯¯ä»£ç "><a href="#é”™è¯¯ä»£ç " class="headerlink" title="é”™è¯¯ä»£ç "></a>é”™è¯¯ä»£ç </h4><ul><li>é”™è¯¯ä»£ç è¾ƒé•¿, å¯ä»¥æ”¶ç¼©, ç›´æ¥çœ‹æ’æŸ¥</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Error starting ApplicationContext. To display the conditions report re-run your application with &#39;debug&#39; enabled.]</span><br><span class="line">[2020-04-10 13:26:11.478]-[main]-[]-[ERROR]-[org.springframework.boot.SpringApplication:821]-[Application run failed]</span><br><span class="line">org.springframework.context.ApplicationContextException: Unable to start web server; nested exception is org.springframework.boot.web.server.WebServerException: Unable to start embedded Tomcat</span><br><span class="line">        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh(ServletWebServerApplicationContext.java:155) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:543) ~[spring-context-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE]</span><br><span class="line">        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:140) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:742) [spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:389) [spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:311) [spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1213) [spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1202) [spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at com.opay.im.WebApplication.main(WebApplication.java:32) [classes!&#x2F;:1.0-SNAPSHOT]</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_221]</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_221]</span><br><span class="line">        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_221]</span><br><span class="line">        at java.lang.reflect.Method.invoke(Method.java:498) ~[?:1.8.0_221]</span><br><span class="line">        at org.springframework.boot.loader.MainMethodRunner.run(MainMethodRunner.java:48) [opay-im-web-1.0-SNAPSHOT.jar:1.0-SNAPSHOT]</span><br><span class="line">        at org.springframework.boot.loader.Launcher.launch(Launcher.java:87) [opay-im-web-1.0-SNAPSHOT.jar:1.0-SNAPSHOT]</span><br><span class="line">        at org.springframework.boot.loader.Launcher.launch(Launcher.java:50) [opay-im-web-1.0-SNAPSHOT.jar:1.0-SNAPSHOT]</span><br><span class="line">        at org.springframework.boot.loader.JarLauncher.main(JarLauncher.java:58) [opay-im-web-1.0-SNAPSHOT.jar:1.0-SNAPSHOT]</span><br><span class="line">Caused by: org.springframework.boot.web.server.WebServerException: Unable to start embedded Tomcat</span><br><span class="line">        at org.springframework.boot.web.embedded.tomcat.TomcatWebServer.initialize(TomcatWebServer.java:124) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.web.embedded.tomcat.TomcatWebServer.&lt;init&gt;(TomcatWebServer.java:86) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory.getTomcatWebServer(TomcatServletWebServerFactory.java:414) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory.getWebServer(TomcatServletWebServerFactory.java:178) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.createWebServer(ServletWebServerApplicationContext.java:179) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh(ServletWebServerApplicationContext.java:152) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        ... 16 more</span><br><span class="line">Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;servletEndpointRegistrar&#39; defined in class path resource [org&#x2F;springframework&#x2F;boot&#x2F;actuate&#x2F;autoconfigure&#x2F;endpoint&#x2F;web&#x2F;ServletEndpointManagementContextConfiguration$WebMvcServletEndpointManagementContextConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.springframework.boot.actuate.endpoint.web.ServletEndpointRegistrar]: Factory method &#39;servletEndpointRegistrar&#39; threw exception; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &#39;healthEndpoint&#39; defined in class path resource [org&#x2F;springframework&#x2F;boot&#x2F;actuate&#x2F;autoconfigure&#x2F;health&#x2F;HealthEndpointConfiguration.class]: Unsatisfied dependency expressed through method &#39;healthEndpoint&#39; parameter 1; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;healthIndicatorRegistry&#39; defined in class path resource [org&#x2F;springframework&#x2F;boot&#x2F;actuate&#x2F;autoconfigure&#x2F;health&#x2F;HealthIndicatorAutoConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.springframework.boot.actuate.health.HealthIndicatorRegistry]: Factory method &#39;healthIndicatorRegistry&#39; threw exception; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &#39;org.springframework.boot.actuate.autoconfigure.jdbc.DataSourceHealthIndicatorAutoConfiguration&#39;: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &#39;dataSource&#39; defined in class path resource [com&#x2F;opay&#x2F;im&#x2F;config&#x2F;DatabaseConfig.class]: Unsatisfied dependency expressed through method &#39;dataSource&#39; parameter 0; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;defaultDataSource&#39; defined in class path resource [com&#x2F;opay&#x2F;im&#x2F;config&#x2F;DatabaseConfig.class]: Initialization of bean failed; nested exception is java.lang.NoClassDefFoundError: org&#x2F;apache&#x2F;shardingsphere&#x2F;api&#x2F;config&#x2F;RuleConfiguration</span><br><span class="line">        at org.springframework.beans.factory.support.ConstructorResolver.instantiate(ConstructorResolver.java:627) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE]</span><br><span class="line">        at org.springframework.beans.factory.support.ConstructorResolver.instantiateUsingFactoryMethod(ConstructorResolver.java:607) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE]</span><br><span class="line">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.instantiateUsingFactoryMethod(AbstractAutowireCapableBeanFactory.java:1321) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE]</span><br><span class="line">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1160) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE]</span><br><span class="line">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:555) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE]</span><br><span class="line">        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:515) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE]</span><br><span class="line">        at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:320) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE]</span><br><span class="line">        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:222) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE]</span><br><span class="line">        at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:318) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE]</span><br><span class="line">        at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:204) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE]</span><br><span class="line">        at org.springframework.boot.web.servlet.ServletContextInitializerBeans.getOrderedBeansOfType(ServletContextInitializerBeans.java:211) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.web.servlet.ServletContextInitializerBeans.getOrderedBeansOfType(ServletContextInitializerBeans.java:202) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.web.servlet.ServletContextInitializerBeans.addServletContextInitializerBeans(ServletContextInitializerBeans.java:96) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.web.servlet.ServletContextInitializerBeans.&lt;init&gt;(ServletContextInitializerBeans.java:85) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line">        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.getServletContextInitializerBeans(ServletWebServerApplicationContext.java:252) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜å®šä½"><a href="#é—®é¢˜å®šä½" class="headerlink" title="é—®é¢˜å®šä½"></a>é—®é¢˜å®šä½</h4><ol><li>å¼€å§‹æ’æŸ¥æ˜¯å› ä¸ºç¼ºå°‘ <code>sharding-core-api-4.0.0-RC2.2-1.8.jar</code> åŒ…ä¸‹çš„ä¸€ä¸ªæ–‡ä»¶, ä½†æ˜¯æœ¬åœ°æ˜¯æœ‰çš„</li><li>æœ¬åœ°å¯ä»¥å¯åŠ¨</li><li>æœåŠ¡å™¨å¯åŠ¨å¤±è´¥, å¯èƒ½æ˜¯jaråŒ…ç¼ºå°‘</li><li>æœ€åç»“æœå‘ç° sharding-core-api-4.0.0-RC2.2-1.8.jar æ˜¯é€šè¿‡å…¬å¸å°è£…çš„ä¸€ä¸ªåŒ…ä¼ é€’è¿›æ¥çš„, è€Œå°è£…çš„é‚£ä¸ªjaråŒ…åœ¨ç§æœä¸Šå·²ç»è¢«åˆ é™¤äº†. <del>åˆ é™¤åŸå› </del></li></ol>]]></content>
      
      
      <categories>
          
          <category> issue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> error </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Macåˆ›å»ºdataç›®å½•å¤±è´¥</title>
      <link href="2020/01/05/mac-create-data-directory-failed.html"/>
      <url>2020/01/05/mac-create-data-directory-failed.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h4><blockquote><p>éƒ¨åˆ†é¡¹ç›®logæ—¥å¿—è¾“å‡ºè·¯å¾„ä¸º /data/log, å‘ç°æ— æ³•åˆ›å»ºç›®å½•<br>é”™è¯¯ä¿¡æ¯: <code>mkdir: cannot create directory â€˜dataâ€™: Read-only file system</code></p></blockquote><h4 id="è§£å†³æ–¹å¼"><a href="#è§£å†³æ–¹å¼" class="headerlink" title="è§£å†³æ–¹å¼"></a>è§£å†³æ–¹å¼</h4><h5 id="å…³é—­SPI"><a href="#å…³é—­SPI" class="headerlink" title="å…³é—­SPI"></a>å…³é—­SPI</h5><ol><li>é‡å¯ æŒ‰ä½CMD+Rè¿›å…¥æ¢å¤æ¨¡å¼</li><li>æ‰“å¼€ç»ˆç«¯<br><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/mac-spi.jpg" alt="spiå…³é—­"></li><li>ç»ˆç«¯è¾“å…¥å‘½ä»¤ï¼šcsrutil disable</li></ol><h5 id="æŒ‚è½½data"><a href="#æŒ‚è½½data" class="headerlink" title="æŒ‚è½½data"></a>æŒ‚è½½data</h5><ol><li>åœ¨ç”¨æˆ·ç›®å½•(å¯ä»¥è‡ªå·±æ‰¾ä¸€ä¸ªç›®å½•ä¸‹åˆ›å»ºdata)</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~  % &gt; <span class="built_in">cd</span> ~</span><br><span class="line">~  % &gt; mkdir data</span><br></pre></td></tr></table></figure><ol start="2"><li>æ‰§è¡Œ <code>sudo mount -uw /</code> é‡æ–°æŒ‚è½½æ ¹ç›®å½•</li><li>å»ºç«‹è½¯é“¾<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo ln -s /Users/liuzhihang/data /data</span><br></pre></td></tr></table></figure></li><li>ä¹‹åå¯ä»¥é‡å¯å†æ‰“å¼€spiäº†<br><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/mac-spi2.png" alt="spiå…³é—­"></li></ol>]]></content>
      
      
      <categories>
          
          <category> issue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> issue </tag>
            
            <tag> mac </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexoä¸­æ’å…¥Bilibiliè§†é¢‘</title>
      <link href="2019/09/14/hexo-inserts-bilibili-video.html"/>
      <url>2019/09/14/hexo-inserts-bilibili-video.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>ä¿®æ”¹materyä¸»é¢˜é¦–é¡µæ˜¾ç¤ºè§†é¢‘ä¸ºBilibiliè§†é¢‘</p><p>åœ¨Markdownæ’å…¥Bilibiliè§†é¢‘, å¹¶è®¾ç½®å¤§å°.</p></blockquote><h3 id="é¦–å…ˆæ‰¾åˆ°åˆ†äº«åµŒå…¥ä»£ç "><a href="#é¦–å…ˆæ‰¾åˆ°åˆ†äº«åµŒå…¥ä»£ç " class="headerlink" title="é¦–å…ˆæ‰¾åˆ°åˆ†äº«åµŒå…¥ä»£ç "></a>é¦–å…ˆæ‰¾åˆ°åˆ†äº«åµŒå…¥ä»£ç </h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://i.loli.net/2019/10/10/di3Cxcr9VLvjqM6.png" alt="Bilibiliåˆ†äº«æˆªå›¾"></p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;//player.bilibili.com/player.html?aid=17963687&amp;cid=29326684&amp;page=1&quot;</span> <span class="attr">scrolling</span>=<span class="string">&quot;no&quot;</span> <span class="attr">border</span>=<span class="string">&quot;0&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;no&quot;</span> <span class="attr">framespacing</span>=<span class="string">&quot;0&quot;</span> <span class="attr">allowfullscreen</span>=<span class="string">&quot;true&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åœ¨markdownä¸­ä½¿ç”¨åµŒå…¥ä»£ç "><a href="#åœ¨markdownä¸­ä½¿ç”¨åµŒå…¥ä»£ç " class="headerlink" title="åœ¨markdownä¸­ä½¿ç”¨åµŒå…¥ä»£ç "></a>åœ¨markdownä¸­ä½¿ç”¨åµŒå…¥ä»£ç </h3><iframe src="//player.bilibili.com/player.html?aid=17963687&cid=29326684&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><h3 id="è°ƒæ•´å¤§å°å’Œå±…ä¸­ç­‰"><a href="#è°ƒæ•´å¤§å°å’Œå±…ä¸­ç­‰" class="headerlink" title="è°ƒæ•´å¤§å°å’Œå±…ä¸­ç­‰"></a>è°ƒæ•´å¤§å°å’Œå±…ä¸­ç­‰</h3><p><a href="https://www.w3school.com.cn/tags/tag_iframe.asp">iframeæ ‡ç­¾å±æ€§è®¾ç½®</a></p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    è°ƒæ•´å¤§å°: width=&quot;xxx&quot; height=&quot;xxx&quot;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;//player.bilibili.com/player.html?aid=17963687&amp;cid=29326684&amp;page=1&quot;</span>  <span class="attr">width</span>=<span class="string">&quot;600&quot;</span> <span class="attr">height</span>=<span class="string">&quot;400&quot;</span>  <span class="attr">scrolling</span>=<span class="string">&quot;no&quot;</span> <span class="attr">border</span>=<span class="string">&quot;0&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;no&quot;</span> <span class="attr">framespacing</span>=<span class="string">&quot;0&quot;</span> <span class="attr">allowfullscreen</span>=<span class="string">&quot;true&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><iframe src="//player.bilibili.com/player.html?aid=17963687&cid=29326684&page=1" width="700" height="480"  scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><h3 id="è®¾ç½®è‡ªé€‚åº”"><a href="#è®¾ç½®è‡ªé€‚åº”" class="headerlink" title="è®¾ç½®è‡ªé€‚åº”"></a>è®¾ç½®è‡ªé€‚åº”</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;position: relative; width: 100%; height: 0; padding-bottom: 75%;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;//player.bilibili.com/player.html?aid=17963687&amp;cid=29326684&amp;page=1&quot;</span>  <span class="attr">scrolling</span>=<span class="string">&quot;no&quot;</span> <span class="attr">border</span>=<span class="string">&quot;0&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;no&quot;</span> <span class="attr">framespacing</span>=<span class="string">&quot;0&quot;</span> <span class="attr">allowfullscreen</span>=<span class="string">&quot;true&quot;</span> <span class="attr">style</span>=<span class="string">&quot;position: absolute; width: 100%; height: 100%; left: 0; top: 0;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;">    <iframe src="//player.bilibili.com/player.html?aid=17963687&cid=29326684&page=1"  scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"></iframe></div><h3 id="matery-ä¸»é¢˜ä¿®æ”¹é¦–é¡µå±•ç¤ºè§†é¢‘"><a href="#matery-ä¸»é¢˜ä¿®æ”¹é¦–é¡µå±•ç¤ºè§†é¢‘" class="headerlink" title="matery ä¸»é¢˜ä¿®æ”¹é¦–é¡µå±•ç¤ºè§†é¢‘"></a>matery ä¸»é¢˜ä¿®æ”¹é¦–é¡µå±•ç¤ºè§†é¢‘</h3><p>æ‰¾åˆ° /themes/hexo-theme-matery/layout/_widget/video.ejs å°†ç¬¬åä¸€è¡Œå·¦å³ä»£ç æ”¹æˆBilibiliè§†é¢‘å³å¯, å¼•å…¥çš„ script å¯ä»¥åˆ æ‰.</p><p>ä¿®æ”¹åå¦‚ä¸‹.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;video-player&quot;</span>&gt;</span><br><span class="line">    &lt;% <span class="keyword">if</span> (theme.video.showTitle) &#123; %&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;title center-align&quot;</span>&gt;</span><br><span class="line">            &lt;i <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;fas fa-video-camera&quot;</span>&gt;&lt;/i&gt;&amp;nbsp;&amp;nbsp;&lt;%- theme.video.title %&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;row&quot;</span>&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;col l8 offset-l2 m10 offset-m1 s12&quot;</span>&gt;</span><br><span class="line">            &lt;div id=<span class="string">&quot;dplayer&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;dplayer-video&quot;</span>&gt;</span><br><span class="line">                &lt;div style=<span class="string">&quot;position: relative; width: 100%; height: 0; padding-bottom: 75%;&quot;</span>&gt;</span><br><span class="line">                    &lt;iframe src=<span class="string">&quot;//player.bilibili.com/player.html?aid=16316393&amp;cid=26620787&amp;page=1&quot;</span>  scrolling=<span class="string">&quot;no&quot;</span> border=<span class="string">&quot;0&quot;</span> frameborder=<span class="string">&quot;no&quot;</span> framespacing=<span class="string">&quot;0&quot;</span> allowfullscreen=<span class="string">&quot;true&quot;</span> style=<span class="string">&quot;position: absolute; width: 100%; height: 100%; left: 0; top: 0;&quot;</span>&gt;&lt;/iframe&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redisåˆ†å¸ƒå¼é”çš„ç”Ÿäº§é—®é¢˜è§£å†³æ–¹æ¡ˆ</title>
      <link href="2019/08/18/redis-distributed-lock-production-problem-solution.html"/>
      <url>2019/08/18/redis-distributed-lock-production-problem-solution.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>Javaè¿›é˜¶è®­ç»ƒè¥å­¦ä¹ ç¬”è®°<br>è¯¾ç¨‹: <a href="https://apppukyptrl1086.pc.xiaoe-tech.com/detail/p_5d3110c3c0e9d_FnmTTtj4/6">Javaè¿›é˜¶è®­ç»ƒè¥</a><br>è€å¸ˆ: ä¸­åçŸ³æ‰<br>é‚€è¯·ç : <a href="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/IMG_0340_phrrry.jpg">äºŒç»´ç </a></p></blockquote><h3 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h3><pre><code>SET KEY VALUE TIME NXDEL KEY</code></pre><p>ä¸€èˆ¬ä½¿ç”¨ NX, åªæœ‰åœ¨é”ä¸å­˜åœ¨çš„æ—¶å€™æ‰åŠ é”æˆåŠŸ, è®¾ç½®æ—¶é—´æ˜¯ä¸ºäº†é”æ°¸è¿œå¾—ä¸åˆ°é‡Šæ”¾</p><h3 id="å­˜åœ¨é—®é¢˜åŠè§£å†³æ–¹æ³•"><a href="#å­˜åœ¨é—®é¢˜åŠè§£å†³æ–¹æ³•" class="headerlink" title="å­˜åœ¨é—®é¢˜åŠè§£å†³æ–¹æ³•"></a>å­˜åœ¨é—®é¢˜åŠè§£å†³æ–¹æ³•</h3><ol><li><p>AåŠ é”, Bé‡Šæ”¾</p><p> æ–¹æ³•: Redisson åœ¨tryLockæ—¶</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">long</span> threadId = Thread.currentThread().getId();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getLockName</span><span class="params">(<span class="keyword">long</span> threadId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> id + <span class="string">&quot;:&quot;</span> + threadId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// id ä¸º UUID</span></span><br></pre></td></tr></table></figure><p> ä¼šå°†å½“å‰ uuId+çº¿ç¨‹idå†™å…¥åˆ°é”ä¿¡æ¯ä¸­, unlockæ—¶ä¼šæ ¡éªŒæ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹</p></li><li><p>A locké”ä½ä¹‹å, è®¾ç½®äº†æ—¶é—´, ä½†æ˜¯åœ¨æ—¶é—´å†…æœªå®Œæˆ, å¯¼è‡´é”è‡ªåŠ¨é‡Šæ”¾, ç„¶åBè·å–é”åŒæ—¶è¿›è¡Œæ“ä½œ</p><p> æ–¹æ³•: Redisson åœ¨lockæ—¶ä¼šå¯åŠ¨å¼‚æ­¥çº¿ç¨‹, è‡ªåŠ¨å»¶æœŸ, æ—¶é—´ä¸º lockWatchdogTimeout(é»˜è®¤30s)</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Timeout task = commandExecutor.getConnectionManager().newTimeout(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">    çœç•¥...</span><br><span class="line">&#125;, internalLockLeaseTime / <span class="number">3</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> çœ‹æºç æ˜¯å»¶æ—¶ 1/3çš„æ—¶é—´åå¼€å§‹, å°±æ˜¯æ¯æ¬¡1/3æ—¶é—´çš„æ—¶å€™å»¶æœŸä¸€æ¬¡. è¿™æ ·ç†è§£ä¸çŸ¥é“å¯¹ä¸å¯¹</p></li><li><p>ä¸»ä»ä¸‹, A åŠ é” Master æˆåŠŸåæœªåŒæ­¥ç»™Slave ä¾¿å®•æœº, å¯¼è‡´ Bå‘ç°æœªåŠ é”<br> æ–¹æ³•: å¯ä»¥ä¿®æ”¹æºç , åŒæ—¶åŠ é”Master-Slave æ‰ç®—åŠ é”æˆåŠŸ</p></li><li><p>é›†ç¾¤çŠ¶æ€ä¸‹å¯ä»¥å‚è€ƒRedLock(çº¢é”), åŠ é”å¤šå°æœºå™¨, å¤šæ•°æˆåŠŸæ‰ç®—æˆåŠŸ(locks.size()/2 + 1)</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedissonRedLock</span> <span class="keyword">extends</span> <span class="title">RedissonMultiLock</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedissonRedLock</span><span class="params">(RLock... locks)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(locks);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•è½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡</title>
      <link href="2019/08/17/how-to-land-the-final-consistency-transaction.html"/>
      <url>2019/08/17/how-to-land-the-final-consistency-transaction.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>Javaè¿›é˜¶è®­ç»ƒè¥å­¦ä¹ ç¬”è®°<br>è¯¾ç¨‹: <a href="https://apppukyptrl1086.pc.xiaoe-tech.com/detail/p_5d3110c3c0e9d_FnmTTtj4/6">Javaè¿›é˜¶è®­ç»ƒè¥</a><br>è€å¸ˆ: ä¸­åçŸ³æ‰<br>é‚€è¯·ç : <a href="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/IMG_0340_phrrry.jpg">äºŒç»´ç </a></p></blockquote><h3 id="ä½œä¸šï¼šå¦‚æœå¯¹è‡ªå·±çš„ç³»ç»Ÿè½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ï¼Œå¦‚ä½•è½åœ°å®ç°ï¼Ÿ"><a href="#ä½œä¸šï¼šå¦‚æœå¯¹è‡ªå·±çš„ç³»ç»Ÿè½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ï¼Œå¦‚ä½•è½åœ°å®ç°ï¼Ÿ" class="headerlink" title="ä½œä¸šï¼šå¦‚æœå¯¹è‡ªå·±çš„ç³»ç»Ÿè½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ï¼Œå¦‚ä½•è½åœ°å®ç°ï¼Ÿ"></a>ä½œä¸šï¼šå¦‚æœå¯¹è‡ªå·±çš„ç³»ç»Ÿè½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ï¼Œå¦‚ä½•è½åœ°å®ç°ï¼Ÿ</h3><ol><li>é¦–å…ˆç†Ÿæ‚‰è‡ªå·±è´Ÿè´£çš„ä¸šåŠ¡, ç†Ÿæ‚‰ç³»ç»Ÿé—´äº¤äº’æµç¨‹, å“ªäº›å¯ä»¥å¼‚æ­¥, å“ªäº›æ˜¯å¿…é¡»åŒæ­¥</li><li>å¼‚æ­¥çš„æ—¶å€™è¦è€ƒè™‘æ˜¯å¦éœ€è¦ä¸€è‡´æ€§, å½“å‰ç³»ç»Ÿé€šçŸ¥æµç¨‹å¦‚å›¾</li></ol><h3 id="å¦‚ä½•è½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡"><a href="#å¦‚ä½•è½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡" class="headerlink" title="å¦‚ä½•è½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡"></a>å¦‚ä½•è½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/0812-task.png" alt="æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡æ–¹æ¡ˆ"></p><h3 id="æ ¹æ®è¯¾ç¨‹æ€è€ƒæœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ä¿®æ”¹"><a href="#æ ¹æ®è¯¾ç¨‹æ€è€ƒæœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ä¿®æ”¹" class="headerlink" title="æ ¹æ®è¯¾ç¨‹æ€è€ƒæœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ä¿®æ”¹:"></a>æ ¹æ®è¯¾ç¨‹æ€è€ƒæœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ä¿®æ”¹:</h3><ol><li>åœ¨æ”¶åˆ°äº¤æ˜“è¯·æ±‚, æˆåŠŸæ—¶å¯ä»¥ commit half message</li><li>åŒæ—¶ éœ€è¦å®ç° checkæ–¹æ³•, ä¾›RocketMQå›è°ƒ, æ£€æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€</li><li>åœ¨äº¤æ˜“æˆåŠŸæˆ–å¤±è´¥æ—¶å†è¿›è¡Œcommitæˆ–rollback</li><li>rollbackæ¶ˆæ¯ RocketMQä¼šå®šæœŸåˆ é™¤</li><li>é€šçŸ¥ç³»ç»Ÿæ”¶åˆ°æ¶ˆæ¯å­˜å‚¨åˆ°æœ¬åœ°å¹¶é€šçŸ¥å•†æˆ·</li></ol><h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><p>ä½†æ˜¯è€ƒè™‘åˆ°åœ¨è¿™è¾¹ç³»ç»Ÿå®Œå…¨æ²¡æœ‰å¿…è¦å¢åŠ äº‹åŠ¡, å› ä¸ºå‘é€æ¶ˆæ¯åˆ°MQæ˜¯åœ¨äº¤æ˜“ç»“æŸå, ç›´æ¥ç”¨ä¸€ä¸ªå­—æ®µåˆ¤æ–­çŠ¶æ€, ç„¶åç”¨å®šæ—¶ä¿è¯æŠ•é€’åˆ°MQå³å¯.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RocketMQçš„ä¸¤æ®µæäº¤ half message</span><br><span class="line">æ‰§è¡Œæµç¨‹</span><br><span class="line">æ ¹æ®æµç¨‹ç»“æœ: commit&#x2F;rockback</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ”¹æˆ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æ‰§è¡Œæµç¨‹</span><br><span class="line">RocketMQ send(æ™®é€šæ¶ˆæ¯)</span><br></pre></td></tr></table></figure><p>åœ¨è¿™è¾¹çš„ä½¿ç”¨åœºæ™¯ä¸­, å› ä¸ºæäº¤äº† half message ä¹Ÿä¸ä¼šå‘é€æ¶ˆæ¯, ç­‰åˆ°æµç¨‹æ‰§è¡Œç»“æŸäº†, ç„¶åä½¿ç”¨sendå‘é€æ™®é€šæ¶ˆæ¯å³å¯.</p>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>äº¤æ˜“ç³»ç»Ÿæ¶æ„å›¾</title>
      <link href="2019/08/10/trading-system-architecture.html"/>
      <url>2019/08/10/trading-system-architecture.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>Javaè¿›é˜¶è®­ç»ƒè¥å­¦ä¹ ç¬”è®°<br>è¯¾ç¨‹: <a href="https://apppukyptrl1086.pc.xiaoe-tech.com/detail/p_5d3110c3c0e9d_FnmTTtj4/6">Javaè¿›é˜¶è®­ç»ƒè¥</a><br>è€å¸ˆ: ä¸­åçŸ³æ‰<br>é‚€è¯·ç : <a href="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/IMG_0340_phrrry.jpg">äºŒç»´ç </a></p></blockquote><h3 id="äº¤æ˜“ç³»ç»Ÿæ¶æ„"><a href="#äº¤æ˜“ç³»ç»Ÿæ¶æ„" class="headerlink" title="äº¤æ˜“ç³»ç»Ÿæ¶æ„"></a>äº¤æ˜“ç³»ç»Ÿæ¶æ„</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/0806-task.png" alt="äº¤æ˜“ç³»ç»Ÿæ¶æ„"></p><h3 id="è¯·æ±‚æµç¨‹"><a href="#è¯·æ±‚æµç¨‹" class="headerlink" title="è¯·æ±‚æµç¨‹:"></a>è¯·æ±‚æµç¨‹:</h3><ol><li>è¯·æ±‚é¦–å…ˆåˆ°SLB(é˜¿é‡Œäº‘)ç»è¿‡è´Ÿè½½å‡è¡¡å, åˆ°Nginx</li><li>Nginxåšç®€å•è´Ÿè½½å‡è¡¡åå‘ç»™äº¤æ˜“APIç³»ç»Ÿ, 4C8G * 5 ECS(é˜¿é‡Œäº‘)</li><li>äº¤æ˜“ä¼šæ ¹æ®è¯·æ±‚å‚æ•°, è·¯ç”±åˆ°å„ä¸ªå­ç³»ç»Ÿ, ä½¿ç”¨dubbo</li><li>å­ç³»ç»Ÿæ”¶åˆ°è¯·æ±‚, è¯·æ±‚é£æ§ç³»ç»Ÿæ ¡éªŒé£æ§</li><li>è¯·æ±‚åº”ç”¨ä¸­å¿ƒè·å–åº”ç”¨å‚æ•° (appId, appKeyç­‰)</li><li>æ‹¼è£…æŠ¥æ–‡,è¯·æ±‚æ¸ é“ç³»ç»Ÿ</li><li>è¿”å›ä¿¡æ¯</li></ol><h3 id="æ—¥å¿—æŠ¥é€æµç¨‹"><a href="#æ—¥å¿—æŠ¥é€æµç¨‹" class="headerlink" title="æ—¥å¿—æŠ¥é€æµç¨‹"></a>æ—¥å¿—æŠ¥é€æµç¨‹</h3><ol><li>äº¤æ˜“æˆåŠŸæŠ¥é€æ¸…ç»“ç®—, æŠ¥é€æ•°æ®ä¸­å¿ƒ</li><li>filebeatæ‹‰å–æ—¥å¿—, æŠ¥é€kafka, å› filebeatå‡çº§ åŒæ—¶å­˜åœ¨5.xå’Œ6.x éœ€è¦åŠ ä¸­é—´ä¸€å±‚, ä¹‹å‰æ˜¯ç›´æ¥æŠ¥logstash</li><li>logstashå¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤ç„¶åæ ¹æ®type åˆ†åˆ«ä¿é€åˆ° elasticsearchå’Œredis</li><li>ç›‘æ§ç³»ç»Ÿç›‘æ§redisé˜Ÿåˆ—æ•°æ®, æ»¡è¶³è§„åˆ™, æŠ¥è­¦(å‘æ¶ˆæ¯åˆ°é€šçŸ¥ç³»ç»Ÿ)</li><li>ç›‘æ§ç³»ç»Ÿå¯¹esæ•°æ®è¿›è¡Œè¿‡æ»¤, æ”¾åˆ°mysql, ç”¨æ¥å±•ç¤ºå•†æˆ·, æ¸ é“çš„äº¤æ˜“å˜åŒ–ç­‰ä¿¡æ¯</li><li>kibana(ç›´æ¥ç”¨çš„kibana)æä¾›ç»™æŠ€æœ¯æ”¯æŒæŸ¥è¯¢æ—¥å¿—. esæ•°æ®ä¼šå®šæœŸåˆ é™¤, ä¿ç•™15-30å¤©çš„æ•°æ®, ä»…ä»…æŠ€æœ¯æ”¯æŒç”¨, ä¸éœ€è¦æ•ˆç‡å¾ˆé«˜, æ‰€ä»¥æœºå™¨é…ç½®ç›¸å¯¹è¾ƒå·®.</li></ol><h3 id="æ‰©å®¹æ–¹æ¡ˆ"><a href="#æ‰©å®¹æ–¹æ¡ˆ" class="headerlink" title="æ‰©å®¹æ–¹æ¡ˆ"></a>æ‰©å®¹æ–¹æ¡ˆ</h3><p>å…¬å¸ä½“é‡è¾ƒå°, QPSé«˜å³°æœŸä¹Ÿå°±500å·¦å³, TPSé«˜å³°æœŸåœ¨100~200, æ‰€ä»¥åŸºæœ¬æ²¡æœ‰é‡åˆ°é—®é¢˜.<br>ä¹‹å‰æœ‰è¿‡ä¸€æ®µæ—¶é—´å…¬ä¼—å·æ”¯ä»˜äº¤æ˜“é‡è¾ƒå¤§, ä¸»è¦åšæ³•æ˜¯å¢åŠ å…¬ä¼—å·æœºå™¨, åŒæ—¶å¢åŠ APIç³»ç»Ÿæœºå™¨.<br>å‡å¦‚äº¤æ˜“é‡æé«˜, ä¸€èˆ¬åº”å¯¹å°±æ˜¯å¢åŠ æœºå™¨, å’Œæé«˜æœºå™¨é…ç½®, åŸºæœ¬ä¸Šéƒ½å¯ä»¥åº”å¯¹.</p><h3 id="å­˜åœ¨é—®é¢˜"><a href="#å­˜åœ¨é—®é¢˜" class="headerlink" title="å­˜åœ¨é—®é¢˜"></a>å­˜åœ¨é—®é¢˜</h3><p>å®šæ—¶ç³»ç»Ÿæ˜¯ä»…ä»…é€šè¿‡dubboå‘é€è°ƒç”¨è¯·æ±‚, æ²¡æœ‰ä¸šåŠ¡é€»è¾‘. æ‰€ä»¥å•ä½“åŸºæœ¬æ²¡æœ‰é‡åˆ°æŒ‚æ‰. ä¹Ÿåœ¨è€ƒè™‘åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡.</p>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudæ¶æ„åŸç†å›¾</title>
      <link href="2019/08/04/springcloud-architecture-schematic.html"/>
      <url>2019/08/04/springcloud-architecture-schematic.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>Javaè¿›é˜¶è®­ç»ƒè¥å­¦ä¹ ç¬”è®°<br>è¯¾ç¨‹: <a href="https://apppukyptrl1086.pc.xiaoe-tech.com/detail/p_5d3110c3c0e9d_FnmTTtj4/6">Javaè¿›é˜¶è®­ç»ƒè¥</a><br>è€å¸ˆ: ä¸­åçŸ³æ‰<br>é‚€è¯·ç : <a href="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/IMG_0340_phrrry.jpg">äºŒç»´ç </a></p></blockquote><h3 id="springcloud-é€šä¿¡åŸç†"><a href="#springcloud-é€šä¿¡åŸç†" class="headerlink" title="springcloud é€šä¿¡åŸç†"></a>springcloud é€šä¿¡åŸç†</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/0731-task.png" alt="é€šä¿¡åŸç†"></p><h3 id="1-Eureka-é›†ç¾¤"><a href="#1-Eureka-é›†ç¾¤" class="headerlink" title="1. Eureka é›†ç¾¤"></a>1. Eureka é›†ç¾¤</h3><ol><li>Eurekaå¯åŠ¨å, ä¼šå‘å…¶ä»–èŠ‚ç‚¹æ³¨å†Œ, ç›¸äº’ç›´æ¥è§†ä¸º peer, å¹¶äº’ç›¸åŒæ­¥æ³¨å†Œä¿¡æ¯.</li></ol><h3 id="2-ç¼“å­˜æœºåˆ¶"><a href="#2-ç¼“å­˜æœºåˆ¶" class="headerlink" title="2. ç¼“å­˜æœºåˆ¶"></a>2. ç¼“å­˜æœºåˆ¶</h3><p>Eurekaå­˜åœ¨ä¸‰ä¸ªmap: registryã€readWriteCacheMapã€readOnlyCacheMap</p><p>registry: CurrentHashMap å®æ—¶æ›´æ–°<br>readWriteCacheMap: Guava Cache/LoadingCache     ä¹Ÿæ˜¯å®æ—¶æ›´æ–°<br>readOnlyCacheMap: CurrentHashMap 30ç§’åŒæ­¥ readWriteCacheMapä¸€æ¬¡</p><h3 id="3-æœåŠ¡æ³¨å†Œ"><a href="#3-æœåŠ¡æ³¨å†Œ" class="headerlink" title="3. æœåŠ¡æ³¨å†Œ"></a>3. æœåŠ¡æ³¨å†Œ</h3><p>æœåŠ¡æ³¨å†Œåæ¯30så‘é€ä¸€æ¬¡å¿ƒè·³(renew)<br>å®¢æˆ·ç«¯æ¯30ç§’è¯·æ³¨å†Œä¸­å¿ƒè·å–ä¸€æ¬¡é…ç½®, å¹¶å­˜åˆ°æœ¬åœ°å†…å­˜ä¸­</p><p>æ³¨å†Œä¸­å¿ƒä¼šå®šæ—¶æ£€æŸ¥å¿ƒè·³, è¿ç»­æ²¡æœ‰3ä¸ªå›è¸¢æ‰æœåŠ¡</p>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dubboåº•å±‚åŸç†æ¶æ„å›¾</title>
      <link href="2019/08/03/dubbo-bottom-structure-diagram.html"/>
      <url>2019/08/03/dubbo-bottom-structure-diagram.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>Javaè¿›é˜¶è®­ç»ƒè¥å­¦ä¹ ç¬”è®°<br>è¯¾ç¨‹: <a href="https://apppukyptrl1086.pc.xiaoe-tech.com/detail/p_5d3110c3c0e9d_FnmTTtj4/6">Javaè¿›é˜¶è®­ç»ƒè¥</a><br>è€å¸ˆ: ä¸­åçŸ³æ‰<br>é‚€è¯·ç : <a href="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/IMG_0340_phrrry.jpg">äºŒç»´ç </a></p></blockquote><h4 id="æ“ä½œæµç¨‹å›¾"><a href="#æ“ä½œæµç¨‹å›¾" class="headerlink" title="æ“ä½œæµç¨‹å›¾"></a>æ“ä½œæµç¨‹å›¾</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/0730-task.png" alt="æ“ä½œæµç¨‹"></p><h4 id="1-æœåŠ¡æ³¨å†Œ-æ•…éšœåŠä¸‹çº¿"><a href="#1-æœåŠ¡æ³¨å†Œ-æ•…éšœåŠä¸‹çº¿" class="headerlink" title="1. æœåŠ¡æ³¨å†Œ, æ•…éšœåŠä¸‹çº¿"></a>1. æœåŠ¡æ³¨å†Œ, æ•…éšœåŠä¸‹çº¿</h4><ol><li>æ³¨å†Œ: providerå’ŒconsumeråŒæ—¶åœ¨zkä¸Šæ³¨å†Œä¸´æ—¶èŠ‚ç‚¹, åŒæ—¶consumerè®¢é˜…zk /dubbo/**/providers provideråœ°å€, providerså‘ç”Ÿå˜åŒ–, zkè‡ªåŠ¨æ¨é€ç»™consumer</li></ol><p>zkä¸Šç»“æ„å¦‚ä¸‹</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ls /dubbo/cn.xxx.xxxService</span><br><span class="line"></span><br><span class="line">[consumers, routers, providers, configurators]</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[consumer:&#x2F;&#x2F;æœºå™¨ip&#x2F;æ¥å£?application&#x3D;æœåŠ¡å&amp;category&#x3D;consumers&amp;check&#x3D;false&amp;default.check&#x3D;false&amp;default.group&#x3D;beta&amp;default.timeout&#x3D;5000&amp;default.version&#x3D;1.0.0&amp;dubbo&#x3D;2.6.2&amp;interface&#x3D;æ¥å£&amp;methods&#x3D;æ–¹æ³•1,æ–¹æ³•2&amp;pid&#x3D;7828&amp;revision&#x3D;0.0.1&amp;side&#x3D;consumer&amp;timestamp&#x3D;1556173624632]</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[dubbo:&#x2F;&#x2F;æœºå™¨1ip:ç«¯å£&#x2F;æ¥å£?anyhost&#x3D;true&amp;application&#x3D;WalletOrderApplicationConsumer&amp;delay&#x3D;2000&amp;dubbo&#x3D;2.5.3&amp;group&#x3D;beta&amp;heartbeat&#x3D;10000&amp;interface&#x3D;æ¥å£&amp;methods&#x3D;æ–¹æ³•1,æ–¹æ³•2&amp;pid&#x3D;22419&amp;retries&#x3D;0&amp;revision&#x3D;1.0.0&amp;side&#x3D;provider&amp;timeout&#x3D;10000&amp;timestamp&#x3D;1564743170669&amp;version&#x3D;1.0.0,</span><br><span class="line">dubbo:&#x2F;&#x2F;æœºå™¨2ip:ç«¯å£&#x2F;æ¥å£?anyhost&#x3D;true&amp;application&#x3D;WalletOrderApplicationConsumer&amp;delay&#x3D;2000&amp;dubbo&#x3D;2.5.3&amp;group&#x3D;beta&amp;heartbeat&#x3D;10000&amp;interface&#x3D;cn.ipaynow.webank.wallet.order.api.provider.DataCenterTaskService&amp;methods&#x3D;syncRechargesRefund,syncTrans,syncTransCancel,syncTransRefunds,syncRecharges&amp;pid&#x3D;16801&amp;retries&#x3D;0&amp;revision&#x3D;0.0.1&amp;side&#x3D;provider&amp;timeout&#x3D;10000&amp;timestamp&#x3D;1563792977340&amp;version&#x3D;1.0.0]</span><br></pre></td></tr></table></figure><ol start="2"><li>æ•…éšœ: zkè‡ªåŠ¨åˆ é™¤ä¸´æ—¶èŠ‚ç‚¹</li><li>ä¸‹çº¿: å–æ¶ˆæ³¨å†Œ, ä¸»åŠ¨åˆ é™¤èŠ‚ç‚¹</li></ol><h4 id="2-Proxy-åŠ¨æ€ä»£ç†"><a href="#2-Proxy-åŠ¨æ€ä»£ç†" class="headerlink" title="2. Proxy åŠ¨æ€ä»£ç†"></a>2. Proxy åŠ¨æ€ä»£ç†</h4><p>æ ¹æ®é…ç½®çš„æ¥å£, ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡, ä½¿ç”¨ JDK + JAVAASSIST æ–¹å¼</p><ol><li><p>åœ¨æœåŠ¡æä¾›ç«¯ï¼Œå°†æœåŠ¡çš„å…·ä½“å®ç°ç±»è½¬ä¸ºInvoker</p></li><li><p>åœ¨æ¶ˆè´¹ç«¯ï¼Œé€šè¿‡ getProxy(Invoker<T> invoker)å°†invokerè½¬ä¸ºå®¢æˆ·ç«¯éœ€è¦çš„æ¥å£</p></li><li><p>Invokerå°è£…äº†Provideråœ°å€åŠServiceæ¥å£ä¿¡æ¯</p></li></ol><h4 id="3-Cluster-é›†ç¾¤å±‚"><a href="#3-Cluster-é›†ç¾¤å±‚" class="headerlink" title="3. Cluster é›†ç¾¤å±‚"></a>3. Cluster é›†ç¾¤å±‚</h4><p>è·å–åˆ°è¦è°ƒç”¨çš„Invoker</p><ol><li>å¤šä¸ªæœåŠ¡ç«¯ä¼šæœ‰å¤šä¸ª Invokerå¯¹è±¡, ç»„åˆæˆDirectory, Directoryåœ¨zkæ¨é€ProviderèŠ‚ç‚¹å˜æ›´æ—¶, ä¼šå‘ç”Ÿå˜åŒ–</li><li>Router, æŒ‰ç…§è·¯ç”±è§„åˆ™é€‰å‡ºæœ¬æ¬¡å¯ä»¥è°ƒç”¨çš„ Directoryå­é›†,  zkæ³¨å†Œä¸­å¿ƒ routersèŠ‚ç‚¹ä¸‹é…ç½®</li><li>LoadBalance ä»å­é›†ä¸­æŒ‰ç…§è´Ÿè½½å‡è¡¡é€‰å‡ºæœ¬æ¬¡è°ƒç”¨<ol><li>Random LoadBalance éšæœº</li><li>RoundRobin LoadBalance è½®è¯¢</li><li>LeastActive LoadBalance æœ€å°‘æ´»è·ƒ</li><li>ConsistentHash LoadBalance ä¸€è‡´æ€§å“ˆå¸Œ</li></ol></li><li>å®¹é”™<ol><li>Failover Cluster å¤±è´¥è‡ªåŠ¨åˆ‡æ¢ï¼Œå½“å‡ºç°å¤±è´¥ï¼Œé‡è¯•å…¶å®ƒæœåŠ¡å™¨ã€‚é€šå¸¸ç”¨äºè¯»æ“ä½œï¼Œä½†é‡è¯•ä¼šå¸¦æ¥æ›´é•¿å»¶è¿Ÿã€‚å¯é€šè¿‡ retries=â€2â€³ æ¥è®¾ç½®é‡è¯•æ¬¡æ•°(ä¸å«ç¬¬ä¸€æ¬¡)ã€‚</li><li>Failfast Clusterï¼šå¿«é€Ÿå¤±è´¥ï¼Œåªå‘èµ·ä¸€æ¬¡è°ƒç”¨ï¼Œå¤±è´¥ç«‹å³æŠ¥é”™ã€‚é€šå¸¸ç”¨äºéå¹‚ç­‰æ€§çš„å†™æ“ä½œï¼Œæ¯”å¦‚æ–°å¢è®°å½•ã€‚</li><li>Failsafe Clusterï¼šå¤±è´¥å®‰å…¨ï¼Œå‡ºç°å¼‚å¸¸æ—¶ï¼Œç›´æ¥å¿½ç•¥ã€‚é€šå¸¸ç”¨äºå†™å…¥å®¡è®¡æ—¥å¿—ç­‰æ“ä½œã€‚</li><li>Failback Clusterï¼šå¤±è´¥è‡ªåŠ¨æ¢å¤ï¼Œåå°è®°å½•å¤±è´¥è¯·æ±‚ï¼Œå®šæ—¶é‡å‘ã€‚é€šå¸¸ç”¨äºæ¶ˆæ¯é€šçŸ¥æ“ä½œã€‚</li><li>Forking Clusterï¼šå¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡å™¨ï¼Œåªè¦ä¸€ä¸ªæˆåŠŸå³è¿”å›ã€‚é€šå¸¸ç”¨äºå®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„è¯»æ“ä½œï¼Œä½†éœ€è¦æµªè´¹æ›´å¤šæœåŠ¡èµ„æºã€‚å¯é€šè¿‡ forks=â€2â€³ æ¥è®¾ç½®æœ€å¤§å¹¶è¡Œæ•°ã€‚</li></ol></li></ol><h4 id="4-Protocol-è¿œç¨‹è°ƒç”¨å±‚"><a href="#4-Protocol-è¿œç¨‹è°ƒç”¨å±‚" class="headerlink" title="4. Protocol è¿œç¨‹è°ƒç”¨å±‚"></a>4. Protocol è¿œç¨‹è°ƒç”¨å±‚</h4><p>åŒ…å«ä¸¤ä¸ªæ¥å£, åˆ†åˆ«æ˜¯ æš´éœ²æœåŠ¡(export) å’Œ å¼•ç”¨æœåŠ¡(refer) åˆ†åˆ«å¯¹åº”provider å’Œ consumer<br>é€‰æ‹©é€šä¿¡åè®® dubbo, hessian, httpç­‰</p><h4 id="5-Exchange-æ•°æ®äº¤æ¢å±‚"><a href="#5-Exchange-æ•°æ®äº¤æ¢å±‚" class="headerlink" title="5. Exchange æ•°æ®äº¤æ¢å±‚"></a>5. Exchange æ•°æ®äº¤æ¢å±‚</h4><p>å°†è¯·æ±‚ä¿¡æ¯å°è£…ä¸ºRequest, ç„¶åå‘é€ç»™ Transportå±‚, å¹¶å°†è¿”å›ä¿¡æ¯å°è£…ä¸ºResponse</p><h4 id="6-Transport-ç½‘ç»œä¼ è¾“å±‚"><a href="#6-Transport-ç½‘ç»œä¼ è¾“å±‚" class="headerlink" title="6. Transport ç½‘ç»œä¼ è¾“å±‚"></a>6. Transport ç½‘ç»œä¼ è¾“å±‚</h4><p>ä½¿ç”¨nettyæˆ–minaè¿›è¡Œç½‘ç»œé€šä¿¡</p><h4 id="7-serialize-åºåˆ—åŒ–å±‚"><a href="#7-serialize-åºåˆ—åŒ–å±‚" class="headerlink" title="7. serialize åºåˆ—åŒ–å±‚"></a>7. serialize åºåˆ—åŒ–å±‚</h4><p>å°†è¯·æ±‚æŠ¥æ–‡å’Œè¿”å›æŠ¥æ–‡è®°æ€§åºåˆ—åŒ–å’Œååºåˆ—åŒ–</p><h4 id="8-provideræ”¶åˆ°è¯·æ±‚åå…ˆè¿›è¡Œååºåˆ—åŒ–-ç„¶ååœ¨è§£æè¯·æ±‚-é€šè¿‡åŠ¨æ€ä»£ç†è°ƒç”¨ç›¸åº”æ–¹æ³•"><a href="#8-provideræ”¶åˆ°è¯·æ±‚åå…ˆè¿›è¡Œååºåˆ—åŒ–-ç„¶ååœ¨è§£æè¯·æ±‚-é€šè¿‡åŠ¨æ€ä»£ç†è°ƒç”¨ç›¸åº”æ–¹æ³•" class="headerlink" title="8. provideræ”¶åˆ°è¯·æ±‚åå…ˆè¿›è¡Œååºåˆ—åŒ–, ç„¶ååœ¨è§£æè¯·æ±‚, é€šè¿‡åŠ¨æ€ä»£ç†è°ƒç”¨ç›¸åº”æ–¹æ³•"></a>8. provideræ”¶åˆ°è¯·æ±‚åå…ˆè¿›è¡Œååºåˆ—åŒ–, ç„¶ååœ¨è§£æè¯·æ±‚, é€šè¿‡åŠ¨æ€ä»£ç†è°ƒç”¨ç›¸åº”æ–¹æ³•</h4>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBooté¡¹ç›®ä¸­ä½¿ç”¨SpringSecurityå’ŒJWTåšæƒé™è®¤è¯</title>
      <link href="2019/07/22/springsecurity-jwt-springboot-project.html"/>
      <url>2019/07/22/springsecurity-jwt-springboot-project.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><blockquote><p>å‰æ®µæ—¶é—´åšäº†ä¸€ä¸ªé¡¹ç›®, å› ä¸ºæ¶‰åŠåˆ°æƒé™è®¤è¯, æ‰€ä»¥åˆ†åˆ«è°ƒç ”äº† SpringSecurity å’Œ Apache Shiro. æœ€åé€‰æ‹©ä½¿ç”¨äº† SpringSecurity + JWTåšæƒé™è®¤è¯,  ç°åœ¨é¡¹ç›®å·²ç»ç»“æŸ, æ€»ç›¸å…³ç¬”è®°.<br>é¡¹ç›®ä¸‹è½½åœ°å€ <a href="https://github.com/liuzhihang/jwt-demo">jwt-demo</a></p></blockquote><ol><li>ä½¿ç”¨JWTç”Ÿæˆtoken</li><li>tokenå­˜å‚¨åœ¨æ•°æ®åº“ä¸­</li><li>ä½¿ç”¨ application/json ç™»å½•</li><li>ä½¿ç”¨æ‰‹æœºå·è¿›è¡Œç™»å½•</li><li>URIåŠ¨æ€æ‹¦æˆª</li></ol><h2 id="é…ç½®è¿‡ç¨‹"><a href="#é…ç½®è¿‡ç¨‹" class="headerlink" title="é…ç½®è¿‡ç¨‹"></a>é…ç½®è¿‡ç¨‹</h2><h3 id="æ·»åŠ ä¾èµ–"><a href="#æ·»åŠ ä¾èµ–" class="headerlink" title="æ·»åŠ ä¾èµ–"></a>æ·»åŠ ä¾èµ–</h3><ol><li>åˆ†åˆ«æ·»åŠ  SpringSecurity JWT å’Œ fastjson ä¾èµ–</li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--json--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.60<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åŸºç¡€å‡†å¤‡å¯¹è±¡"><a href="#åŸºç¡€å‡†å¤‡å¯¹è±¡" class="headerlink" title="åŸºç¡€å‡†å¤‡å¯¹è±¡"></a>åŸºç¡€å‡†å¤‡å¯¹è±¡</h3><ul><li>ä¸»è¦æ˜¯åœ¨<strong>ç”¨æˆ·ç™»å½•æˆåŠŸhandle</strong>æ—¶ä½¿ç”¨JWTç”ŸæˆTokenè¿”å›ç»™å®¢æˆ·ç«¯.</li></ul><h4 id="åŸºç¡€ä½¿ç”¨dto"><a href="#åŸºç¡€ä½¿ç”¨dto" class="headerlink" title="åŸºç¡€ä½¿ç”¨dto"></a>åŸºç¡€ä½¿ç”¨dto</h4><p>è¯·æ±‚è¿”å›åŸºç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseReqDto</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String version;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseRespDto</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String resultCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String resultMsg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String resultTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç™»å½•è¯·æ±‚è¿”å›å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginReqDto</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginRespDto</span> <span class="keyword">extends</span> <span class="title">BaseRespDto</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç”¨äºéªŒè¯çš„ç”¨æˆ·"><a href="#ç”¨äºéªŒè¯çš„ç”¨æˆ·" class="headerlink" title="ç”¨äºéªŒè¯çš„ç”¨æˆ·"></a>ç”¨äºéªŒè¯çš„ç”¨æˆ·</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.demo.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·ä¿¡æ¯æ ¡éªŒéªŒè¯ç </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailsImpl</span> <span class="keyword">implements</span> <span class="title">UserDetails</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯†ç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æƒé™é›†åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;? extends GrantedAuthority&gt; authorities;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthorities</span><span class="params">(Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.authorities = authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç”¨æˆ·æœªç™»å½•handle"><a href="#ç”¨æˆ·æœªç™»å½•handle" class="headerlink" title="ç”¨æˆ·æœªç™»å½•handle"></a>ç”¨æˆ·æœªç™»å½•handle</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·ç™»å½•è®¤è¯, æœªç™»å½•è¿”å›ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-06-04 13:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationEntryPointImpl</span> <span class="keyword">implements</span> <span class="title">AuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMMddHHmmss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        LoginRespDto respDto = <span class="keyword">new</span> LoginRespDto();</span><br><span class="line">        respDto.setResultCode(<span class="string">&quot;0001&quot;</span>);</span><br><span class="line">        respDto.setResultMsg(<span class="string">&quot;ç”¨æˆ·æœªç™»å½•&quot;</span>);</span><br><span class="line">        respDto.setResultTime(LocalDateTime.now().format(FORMATTER));</span><br><span class="line"></span><br><span class="line">        response.getWriter().write(JSON.toJSONString(respDto));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="ç”¨æˆ·ç™»å½•éªŒè¯å¤±è´¥handle"><a href="#ç”¨æˆ·ç™»å½•éªŒè¯å¤±è´¥handle" class="headerlink" title="ç”¨æˆ·ç™»å½•éªŒè¯å¤±è´¥handle"></a>ç”¨æˆ·ç™»å½•éªŒè¯å¤±è´¥handle</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·ç™»å½•è®¤è¯å¤±è´¥è¿”å›çš„ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-06-04 13:57</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationFailureHandlerImpl</span> <span class="keyword">implements</span> <span class="title">AuthenticationFailureHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMMddHHmmss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        LoginRespDto respDto = <span class="keyword">new</span> LoginRespDto();</span><br><span class="line">        respDto.setResultCode(<span class="string">&quot;0001&quot;</span>);</span><br><span class="line">        respDto.setResultMsg(<span class="string">&quot;ç”¨æˆ·ç™»å½•è®¤è¯å¤±è´¥&quot;</span>);</span><br><span class="line">        respDto.setResultTime(LocalDateTime.now().format(FORMATTER));</span><br><span class="line"></span><br><span class="line">        response.getWriter().write(JSON.toJSONString(respDto));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç”¨æˆ·æ— æƒè®¿é—®handle"><a href="#ç”¨æˆ·æ— æƒè®¿é—®handle" class="headerlink" title="ç”¨æˆ·æ— æƒè®¿é—®handle"></a>ç”¨æˆ·æ— æƒè®¿é—®handle</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å½“ç”¨æˆ·è®¿é—®æ— æƒé™é¡µé¢æ—¶, è¿”å›ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-06-04 14:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessDeniedHandlerImpl</span> <span class="keyword">implements</span> <span class="title">AccessDeniedHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMMddHHmmss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        LoginRespDto respDto = <span class="keyword">new</span> LoginRespDto();</span><br><span class="line">        respDto.setResultCode(<span class="string">&quot;0002&quot;</span>);</span><br><span class="line">        respDto.setResultMsg(<span class="string">&quot;ç”¨æˆ·æ— æƒè®¿é—®&quot;</span>);</span><br><span class="line">        respDto.setResultTime(LocalDateTime.now().format(FORMATTER));</span><br><span class="line"></span><br><span class="line">        response.getWriter().write(JSON.toJSONString(respDto));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="ç”¨æˆ·ç™»å½•æˆåŠŸhandle"><a href="#ç”¨æˆ·ç™»å½•æˆåŠŸhandle" class="headerlink" title="ç”¨æˆ·ç™»å½•æˆåŠŸhandle"></a>ç”¨æˆ·ç™»å½•æˆåŠŸhandle</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åçš„è¿”å›ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-06-04 14:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationSuccessHandlerImpl</span> <span class="keyword">implements</span> <span class="title">AuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMMddHHmmss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenUtil jwtTokenUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Authentication authentication)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        UserDetailsImpl userDetails = (UserDetailsImpl) authentication.getPrincipal();</span><br><span class="line"></span><br><span class="line">        String jwtToken = jwtTokenUtil.generateToken(userDetails);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŠŠç”Ÿæˆçš„tokenæ›´æ–°åˆ°æ•°æ®åº“ä¸­</span></span><br><span class="line">        <span class="comment">// æ›´æ–°DBæ“ä½œ ...</span></span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        LoginRespDto respDto = <span class="keyword">new</span> LoginRespDto();</span><br><span class="line">        respDto.setToken(jwtToken);</span><br><span class="line">        respDto.setResultCode(<span class="string">&quot;0000&quot;</span>);</span><br><span class="line">        respDto.setResultMsg(<span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);</span><br><span class="line">        respDto.setResultTime(LocalDateTime.now().format(FORMATTER));</span><br><span class="line"></span><br><span class="line">        response.getWriter().write(JSON.toJSONString(respDto));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="JwtTokenUtil"><a href="#JwtTokenUtil" class="headerlink" title="JwtTokenUtil"></a>JwtTokenUtil</h2><p>ä¸»è¦ç”¨æ¥ç”Ÿæˆtokenå’Œé€šè¿‡tokenè§£æå¯¹è±¡ç­‰æ“ä½œ.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.demo.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.liuzhihang.demo.bean.UserDetailsImpl;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨ java-jwt jwtç±»åº“</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-06-05 09:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtTokenUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SignatureAlgorithm SIGN_TYPE = SignatureAlgorithm.HS256;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SECRET = <span class="string">&quot;jwt-secret&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JWTè¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> EXPIRED_TIME = <span class="number">7</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * claims ä¸ºè‡ªå®šä¹‰çš„ç§æœ‰å£°æ˜, è¦æ”¾åœ¨å‰é¢</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆtoken</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">generateToken</span><span class="params">(UserDetails userDetails)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> instantNow = Instant.now().toEpochMilli();</span><br><span class="line"></span><br><span class="line">        Claims claims = Jwts.claims();</span><br><span class="line">        claims.put(Claims.SUBJECT, userDetails.getUsername());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Jwts.builder().setClaims(claims).setIssuedAt(<span class="keyword">new</span> Date(instantNow))</span><br><span class="line">                .setExpiration(<span class="keyword">new</span> Date(instantNow + EXPIRED_TIME))</span><br><span class="line">                .signWith(SIGN_TYPE, SECRET).compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * claims ä¸ºè‡ªå®šä¹‰çš„ç§æœ‰å£°æ˜, è¦æ”¾åœ¨å‰é¢</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆtoken</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">generateToken</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> instantNow = Instant.now().toEpochMilli();</span><br><span class="line"></span><br><span class="line">        Claims claims = Jwts.claims();</span><br><span class="line">        claims.put(Claims.SUBJECT, userName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Jwts.builder().setClaims(claims).setIssuedAt(<span class="keyword">new</span> Date(instantNow))</span><br><span class="line">                .setExpiration(<span class="keyword">new</span> Date(instantNow + EXPIRED_TIME))</span><br><span class="line">                .signWith(SIGN_TYPE, SECRET).compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†tokenè§£æ, æ˜ å°„ä¸º UserDetails</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwtToken</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">getUserDetailsFromToken</span><span class="params">(String jwtToken)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Claims claimsFromToken = getClaimsFromToken(jwtToken);</span><br><span class="line"></span><br><span class="line">        String userName = claimsFromToken.get(Claims.SUBJECT, String.class);</span><br><span class="line"></span><br><span class="line">        UserDetailsImpl userDetails = <span class="keyword">new</span> UserDetailsImpl();</span><br><span class="line">        userDetails.setUsername(userName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userDetails;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éªŒè¯token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">validateToken</span><span class="params">(String token, UserDetails userDetails)</span> </span>&#123;</span><br><span class="line">        UserDetailsImpl user = (UserDetailsImpl) userDetails;</span><br><span class="line">        String username = getPhoneNoFromToken(token);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (username.equals(user.getUsername()) &amp;&amp; !isTokenExpired(token));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ·æ–°ä»¤ç‰Œ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token åŸä»¤ç‰Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ–°ä»¤ç‰Œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">refreshToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        String refreshedToken;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Claims claims = getClaimsFromToken(token);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> instantNow = Instant.now().toEpochMilli();</span><br><span class="line"></span><br><span class="line">            refreshedToken = Jwts.builder().setClaims(claims).setIssuedAt(<span class="keyword">new</span> Date(instantNow))</span><br><span class="line">                    .setExpiration(<span class="keyword">new</span> Date(instantNow + EXPIRED_TIME))</span><br><span class="line">                    .signWith(SIGN_TYPE, SECRET).compact();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            refreshedToken = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> refreshedToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–tokenæ˜¯å¦è¿‡æœŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">isTokenExpired</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        Date expiration = getExpirationDateFromToken(token);</span><br><span class="line">        <span class="keyword">return</span> expiration.before(<span class="keyword">new</span> Date());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®tokenè·å–username</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPhoneNoFromToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getClaimsFromToken(token).getSubject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–tokençš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getExpirationDateFromToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getClaimsFromToken(token).getExpiration();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è§£æJWT</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Claims <span class="title">getClaimsFromToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Jwts.parser().setSigningKey(SECRET).parseClaimsJws(token).getBody();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="WebSecurityConfig-æ ¸å¿ƒé…ç½®"><a href="#WebSecurityConfig-æ ¸å¿ƒé…ç½®" class="headerlink" title="WebSecurityConfig æ ¸å¿ƒé…ç½®"></a>WebSecurityConfig æ ¸å¿ƒé…ç½®</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.liuzhihang.demo.filter.CustomizeAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> com.liuzhihang.demo.filter.JwtPerTokenFilter;</span><br><span class="line"><span class="keyword">import</span> com.liuzhihang.demo.service.UserDetailServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.access.AccessDeniedHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.AuthenticationFailureHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.AuthenticationSuccessHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-06-03 14:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailServiceImpl userDetailServiceImpl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JwtPerTokenFilter jwtPerTokenFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;authenticationEntryPointImpl&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationEntryPoint authenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;authenticationSuccessHandlerImpl&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSuccessHandler authenticationSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;authenticationFailureHandlerImpl&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;accessDeniedHandlerImpl&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> AccessDeniedHandler accessDeniedHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºç”¨äºè®¤è¯æˆæƒçš„ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureUserInfo</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ”¾å…¥è‡ªå·±çš„è®¤è¯æˆæƒç”¨æˆ·, å†…éƒ¨é€»è¾‘éœ€è¦è‡ªå·±å®ç°</span></span><br><span class="line">        <span class="comment">// UserDetailServiceImpl implements UserDetailsService</span></span><br><span class="line">        auth.userDetailsService(userDetailServiceImpl);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                <span class="comment">// ä½¿ç”¨JWT, å…³é—­session</span></span><br><span class="line">                .csrf().disable().sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line"></span><br><span class="line">                .and().httpBasic().authenticationEntryPoint(authenticationEntryPoint)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ç™»å½•çš„æƒé™, æˆåŠŸè¿”å›ä¿¡æ¯, å¤±è´¥è¿”å›ä¿¡æ¯</span></span><br><span class="line">                .and().formLogin().permitAll()</span><br><span class="line"></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// é…ç½®url æƒé™ antMatchers: åŒ¹é…url æƒé™</span></span><br><span class="line">                .and().authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/getVersion&quot;</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                <span class="comment">// å…¶ä»–éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®</span></span><br><span class="line">                .anyRequest().access(<span class="string">&quot;@dynamicAuthorityService.hasPermission(request,authentication)&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è®¿é—®æ— æƒé™ location æ—¶</span></span><br><span class="line">                .and().exceptionHandling().accessDeniedHandler(accessDeniedHandler)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è‡ªå®šä¹‰è¿‡æ»¤</span></span><br><span class="line">                .and().addFilterAt(customAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">                .addFilterBefore(jwtPerTokenFilter, UsernamePasswordAuthenticationFilter.class)</span><br><span class="line"></span><br><span class="line">                .headers().cacheControl();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯†ç åŠ å¯†å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * BCryptPasswordEncoderï¼šç›¸åŒçš„å¯†ç æ˜æ–‡æ¯æ¬¡ç”Ÿæˆçš„å¯†æ–‡éƒ½ä¸åŒï¼Œå®‰å…¨æ€§æ›´é«˜</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">CustomizeAuthenticationFilter <span class="title">customAuthenticationFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        CustomizeAuthenticationFilter filter = <span class="keyword">new</span> CustomizeAuthenticationFilter();</span><br><span class="line">        filter.setAuthenticationSuccessHandler(authenticationSuccessHandler);</span><br><span class="line">        filter.setAuthenticationFailureHandler(authenticationFailureHandler);</span><br><span class="line">        filter.setAuthenticationManager(authenticationManagerBean());</span><br><span class="line">        <span class="keyword">return</span> filter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ç™»å½•æ ¡éªŒè¿‡ç¨‹"><a href="#ç™»å½•æ ¡éªŒè¿‡ç¨‹" class="headerlink" title="ç™»å½•æ ¡éªŒè¿‡ç¨‹"></a>ç™»å½•æ ¡éªŒè¿‡ç¨‹</h2><div class="mermaid">graph TD;    A(è¯·æ±‚ç™»å½•) --&gt; B(CustomizeAuthenticationFilter#attemptAuthentication è§£æè¯·æ±‚çš„json);    B --&gt; C(UserDetailServiceImpl#loadUserByUsername éªŒè¯ç”¨æˆ·åå¯†ç );    C --&gt; D(AuthenticationSuccessHandlerImpl#onAuthenticationSuccess æ„å»ºè¿”å›å‚æ•° åŒ…æ‹¬token);    D --&gt; E(è¿”å›ç»“æœ)</div><h3 id="è‡ªå®šä¹‰æ‹¦æˆªå™¨è§£æ-json-æŠ¥æ–‡"><a href="#è‡ªå®šä¹‰æ‹¦æˆªå™¨è§£æ-json-æŠ¥æ–‡" class="headerlink" title="è‡ªå®šä¹‰æ‹¦æˆªå™¨è§£æ json æŠ¥æ–‡"></a>è‡ªå®šä¹‰æ‹¦æˆªå™¨è§£æ json æŠ¥æ–‡</h3><p>å‰ç«¯è¯·æ±‚ç™»å½•æŠ¥æ–‡ç±»å‹ä¸º application/json éœ€è¦åç«¯å¢åŠ æ‹¦æˆªå™¨, å¯¹ç™»å½•è¯·æ±‚æŠ¥æ–‡è¿›è¡Œè§£æ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.demo.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationServiceException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰æ‹¦æˆªå™¨, é‡å†™UsernamePasswordAuthenticationFilter ä»è€Œå¯ä»¥å¤„ç† application/json ä¸­çš„jsonè¯·æ±‚æŠ¥æ–‡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-06-12 19:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizeAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">UsernamePasswordAuthenticationFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// attempt Authentication when Content-Type is json</span></span><br><span class="line">        <span class="keyword">if</span> (request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_UTF8_VALUE)</span><br><span class="line">            || request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_VALUE)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                BufferedReader br = request.getReader();</span><br><span class="line">                String str;</span><br><span class="line">                StringBuilder jsonStr = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="keyword">while</span> ((str = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    jsonStr.append(str);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                log.info(<span class="string">&quot;æœ¬æ¬¡ç™»å½•è¯·æ±‚å‚æ•°:&#123;&#125;&quot;</span>, jsonStr);</span><br><span class="line"></span><br><span class="line">                JSONObject jsonObject = JSON.parseObject(jsonStr.toString());</span><br><span class="line"></span><br><span class="line">                UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(</span><br><span class="line">                    jsonObject.getString(<span class="string">&quot;username&quot;</span>), jsonObject.getString(<span class="string">&quot;password&quot;</span>));</span><br><span class="line">                setDetails(request, authRequest);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;ç”¨æˆ·ç™»å½•, è¯·æ±‚å‚æ•° ä¸æ­£ç¡®&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(<span class="string">&quot;è·å–æŠ¥æ–‡è¯·æ±‚å‚æ•°å¤±è´¥&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;ç”¨æˆ·ç™»å½•, è¯·æ±‚æŠ¥æ–‡æ ¼å¼ ä¸æ­£ç¡®&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(<span class="string">&quot;è¯·æ±‚æŠ¥æ–‡, è½¬æ¢Jsonå¤±è´¥&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ç”¨æˆ·ç™»å½•, contentType ä¸æ­£ç¡®&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(</span><br><span class="line">                <span class="string">&quot;è¯·æ±‚ contentType ä¸æ­£ç¡®, è¯·ä½¿ç”¨ application/json;charset=UTF-8 æˆ–è€… application/json;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ç”¨æˆ·è®¤è¯æ¨¡å—"><a href="#ç”¨æˆ·è®¤è¯æ¨¡å—" class="headerlink" title="ç”¨æˆ·è®¤è¯æ¨¡å—"></a>ç”¨æˆ·è®¤è¯æ¨¡å—</h3><ul><li>æ ¹æ®è·å–åˆ°çš„usernameä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°å¯†ç , å°†ç”¨æˆ·åå¯†ç èµ‹å€¼ç»™UserDetailså¯¹è±¡, è¿”å›å…¶ä»–çš„æ¡†æ¶ä¼šè¿›è¡Œæ ¡éªŒ</li><li>è¿™è¾¹ä½¿ç”¨ä¸­æ˜¯ä½¿ç”¨çš„æ‰‹æœºå·+éªŒè¯ç ç™»å½•, æ‰€ä»¥ ä¸Šé¢jsonè§£æçš„ä¹Ÿæ˜¯ phoneNo+verificationCode</li><li>åœ¨è¿™å— usernameä»…ä»…ä»£æŒ‡ç™»å½•å, å¯ä»¥æ˜¯æ‰‹æœºå·å¯ä»¥æ˜¯åˆ«çš„.</li><li>è¿™è¾¹ä½¿ç”¨ä¸­éªŒè¯ç æ˜¯ä»redisä¸­è·å–çš„. è·å–ä¸åˆ°è¿”å›å¤±è´¥, è·å–åˆ°å’Œä¼ é€’çš„ä¸ä¸€è‡´ä¹Ÿç®—å¤±è´¥.</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.demo.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.liuzhihang.demo.bean.UserDetailsImpl;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component(&quot;userDetailServiceImpl&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æ¥éªŒè¯ç™»å½•åæ˜¯å¦æœ‰æƒé™è¿›è¡Œç™»å½•</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * å¯ä»¥é€šè¿‡æ•°æ®åº“è¿›è¡Œæ ¡éªŒ ä¹Ÿå¯ä»¥é€šè¿‡redis ç­‰ç­‰</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UsernameNotFoundException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        UserDetailsImpl userDetailsImpl = <span class="keyword">new</span> UserDetailsImpl();</span><br><span class="line">        userDetailsImpl.setUsername(<span class="string">&quot;liuzhihang&quot;</span>);</span><br><span class="line">        userDetailsImpl.setPassword(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">&quot;123456789&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> userDetailsImpl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="è¯·æ±‚æ ¡éªŒè¿‡ç¨‹"><a href="#è¯·æ±‚æ ¡éªŒè¿‡ç¨‹" class="headerlink" title="è¯·æ±‚æ ¡éªŒè¿‡ç¨‹"></a>è¯·æ±‚æ ¡éªŒè¿‡ç¨‹</h2><div class="mermaid">graph TD;    A(è¯·æ±‚æ¥å£) --&gt; B(JwtPerTokenFilter#doFilterInternal éªŒè¯Headerä¸­çš„token);    B --&gt; C(DynamicAuthorityService#hasPermission éªŒè¯æœ‰æ²¡æœ‰è¯·æ±‚urlæƒé™);    C --&gt; D(å¤„ç†é€»è¾‘);    D --&gt; E(è¿”å›ç»“æœ)</div><h3 id="JWTTokenæ‹¦æˆªå™¨"><a href="#JWTTokenæ‹¦æˆªå™¨" class="headerlink" title="JWTTokenæ‹¦æˆªå™¨"></a>JWTTokenæ‹¦æˆªå™¨</h3><p>ä¸»è¦æ˜¯æ‹¦æˆªè¯·æ±‚, éªŒè¯Headerä¸­çš„tokenæ˜¯å¦æ­£ç¡®</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.demo.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.liuzhihang.demo.utils.JwtTokenUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-06-05 09:09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtPerTokenFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenUtil jwtTokenUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­˜æ”¾Tokençš„Header Key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_STRING = <span class="string">&quot;token&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String token = request.getHeader(HEADER_STRING);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != token &amp;&amp; !jwtTokenUtil.isTokenExpired(token)) &#123;</span><br><span class="line">            UserDetails userDetails = jwtTokenUtil.getUserDetailsFromToken(token);</span><br><span class="line">            String username = userDetails.getUsername();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (username != <span class="keyword">null</span> &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// é€šè¿‡ username æŸ¥è¯¢æ•°æ®åº“ è·å–token ç„¶åå’Œåº“ä¸­tokenä½œæ¯”è¾ƒ</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (username.equals(<span class="string">&quot;liuzhihang&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                    UsernamePasswordAuthenticationToken authentication =</span><br><span class="line">                            <span class="keyword">new</span> UsernamePasswordAuthenticationToken(userDetails, <span class="keyword">null</span>, userDetails.getAuthorities());</span><br><span class="line">                    authentication.setDetails(<span class="keyword">new</span> WebAuthenticationDetailsSource().buildDetails(request));</span><br><span class="line">                    SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="URIåŠ¨æ€æ ¡éªŒ"><a href="#URIåŠ¨æ€æ ¡éªŒ" class="headerlink" title="URIåŠ¨æ€æ ¡éªŒ"></a>URIåŠ¨æ€æ ¡éªŒ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.demo.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŠ¨æ€æƒé™è®¤è¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-06-25 15:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component(value = &quot;dynamicAuthorityService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicAuthorityService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(HttpServletRequest request, Authentication authentication)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object principal = authentication.getPrincipal();</span><br><span class="line">            <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> UserDetails &amp;&amp; authentication <span class="keyword">instanceof</span> UsernamePasswordAuthenticationToken) &#123;</span><br><span class="line">                <span class="comment">// æœ¬æ¬¡è¯·æ±‚çš„uri</span></span><br><span class="line">                String uri = request.getRequestURI();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">                UserDetails userDetails = (UserDetails) principal;</span><br><span class="line"></span><br><span class="line">                String username = userDetails.getUsername();</span><br><span class="line">                log.info(<span class="string">&quot;æœ¬æ¬¡ç”¨æˆ·è¯·æ±‚è®¤è¯, username:&#123;&#125;, uri:&#123;&#125;&quot;</span>, username, uri);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä»æ•°æ®åº“å–é€»è¾‘</span></span><br><span class="line">                <span class="keyword">if</span> (username.equals(<span class="string">&quot;liuzhihang&quot;</span>))&#123;</span><br><span class="line">                    Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">                    set.add(<span class="string">&quot;/homeInfo&quot;</span>);</span><br><span class="line">                    set.add(<span class="string">&quot;/getAllUser&quot;</span>);</span><br><span class="line">                    set.add(<span class="string">&quot;/editUserInfo&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (set.contains(uri)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ç”¨æˆ·è¯·æ±‚ç™»å½•, uri:&#123;&#125; error&quot;</span>, request.getRequestURI(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>è„šæœ¬åœ¨ <a href="https://github.com/liuzhihang/jwt-demo/blob/master/src/test/java/ReqTest.http">httpclientè„šæœ¬</a></p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">POST localhost:8080/login</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;: &quot;liuzhihang&quot;,</span><br><span class="line">  &quot;password&quot;: &quot;123456789&quot;</span><br><span class="line">&#125;</span><br><span class="line">### è¯·æ±‚æ¥å£è„šæœ¬</span><br><span class="line"></span><br><span class="line">POST localhost:8080/homeInfo</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="attribute">token</span>: eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJsaXV6aGloYW5nIiwiaWF0IjoxNTY5MDI1NjY4LCJleHAiOjE1Njk2MzA0Njh9.Kot_uLnwtcq-t5o4x3V-xBnpf-mKEi7OV2eAfgMCKLk</span><br><span class="line">###</span><br></pre></td></tr></table></figure><p>è¿”å›:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;resultCode&quot;</span>: <span class="string">&quot;0000&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;resultMsg&quot;</span>: <span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;resultTime&quot;</span>: <span class="string">&quot;20190920191038&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJsaXV6aGloYW5nIiwiaWF0IjoxNTY4OTc3ODM4LCJleHAiOjE1Njk1ODI2Mzh9.MAS9VkFdCF3agkCgTtc0VzPMFjY42vFyIvAEzkSeAfs&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/larger5/article/details/81063438">å‰åç«¯åˆ†ç¦» SpringBoot + SpringSecurity + JWT + RBAC å®ç°ç”¨æˆ·æ— çŠ¶æ€è¯·æ±‚éªŒè¯</a></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JWT </tag>
            
            <tag> SpringSecurity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitalkä½¿ç”¨MD5ç”ŸæˆId</title>
      <link href="2019/07/20/gitalk-uses-md5-to-generate-an-id.html"/>
      <url>2019/07/20/gitalk-uses-md5-to-generate-an-id.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>Gitalké»˜è®¤ä½¿ç”¨: location.pathname ä½œä¸º gitalk çš„id, ä½†æ˜¯location.pathå¿…é¡»å°äº50ä½åˆ‡æ¢ä¸»é¢˜æ—¶, æ¯ä¸ªä¸»é¢˜ä½¿ç”¨çš„å¤„ç†æ–¹å¼éƒ½ä¸ç›¸åŒ, æœ‰å¯èƒ½ä¼šå¯¼è‡´æ¢äº†ä¸»é¢˜, å‘ç°ä¹‹å‰çš„è¯„è®ºä¸è§äº†, ä¸‹é¢ä»‹ç»ä½¿ç”¨MD5ä½œä¸ºid, åŒæ—¶åœ¨æ¢ä¸»é¢˜æ—¶ä¸€å®šè¦ä¿®æ”¹è¿™ä¸ªidçš„è§„åˆ™.</p></blockquote><h3 id="Gitalkä½¿ç”¨"><a href="#Gitalkä½¿ç”¨" class="headerlink" title="Gitalkä½¿ç”¨"></a>Gitalkä½¿ç”¨</h3><p>ä½¿ç”¨<a href="https://github.com/gitalk/gitalk/blob/master/readme-cn.md">Gitalk</a>æ–¹æ³•:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> gitalk = <span class="keyword">new</span> Gitalk(&#123;</span><br><span class="line">  clientID: <span class="string">&#x27;GitHub Application Client ID&#x27;</span>,</span><br><span class="line">  clientSecret: <span class="string">&#x27;GitHub Application Client Secret&#x27;</span>,</span><br><span class="line">  repo: <span class="string">&#x27;GitHub repo&#x27;</span>,</span><br><span class="line">  owner: <span class="string">&#x27;GitHub repo owner&#x27;</span>,</span><br><span class="line">  admin: [<span class="string">&#x27;GitHub repo owner and collaborators, only these guys can initialize github issues&#x27;</span>],</span><br><span class="line">  id: location.pathname,      <span class="comment">// Ensure uniqueness and length less than 50</span></span><br><span class="line">  distractionFreeMode: <span class="literal">false</span>  <span class="comment">// Facebook-like distraction free mode</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">gitalk.render(<span class="string">&#x27;gitalk-container&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨MD5ç”Ÿæˆid"><a href="#ä½¿ç”¨MD5ç”Ÿæˆid" class="headerlink" title="ä½¿ç”¨MD5ç”Ÿæˆid"></a>ä½¿ç”¨MD5ç”Ÿæˆid</h3><ol><li>å¼•å…¥js</li></ol><p><a href="https://github.com/blueimp/JavaScript-MD5">MD5</a> js ä¸‹è½½åœ°å€</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;js/md5.min.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><ol start="2"><li>ä¿®æ”¹js</li></ol><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">var</span> gitalk_id = md5(location.pathname)</span><br><span class="line">    <span class="keyword">if</span> (&lt;%- page.comments_type == <span class="string">&#x27;404&#x27;</span>   %&gt;) &#123;</span><br><span class="line">        gitalk_id = md5(<span class="string">&#x27;https://liuzhihang.com/404&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> gitalk = <span class="keyword">new</span> Gitalk(&#123;</span><br><span class="line">        clientID: <span class="string">&#x27;&lt;%- theme.gitalk.oauth.clientId %&gt;&#x27;</span>,</span><br><span class="line">        clientSecret: <span class="string">&#x27;&lt;%- theme.gitalk.oauth.clientSecret %&gt;&#x27;</span>,</span><br><span class="line">        repo: <span class="string">&#x27;&lt;%- theme.gitalk.repo %&gt;&#x27;</span>,</span><br><span class="line">        owner: <span class="string">&#x27;&lt;%- theme.gitalk.owner %&gt;&#x27;</span>,</span><br><span class="line">        admin: &lt;%- <span class="built_in">JSON</span>.stringify(theme.gitalk.admin) %&gt;,</span><br><span class="line">        id: gitalk_id,</span><br><span class="line">        distractionFreeMode: <span class="literal">false</span>  <span class="comment">// Facebook-like distraction free mode</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    gitalk.render(<span class="string">&#x27;gitalk-container&#x27;</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IDEAæ’ä»¶--Toolkit</title>
      <link href="2019/05/11/idea-plugin-toolkit.html"/>
      <url>2019/05/11/idea-plugin-toolkit.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Toolkit"><a href="#Toolkit" class="headerlink" title="Toolkit"></a>Toolkit</h1><div><a href="https://plugins.jetbrains.com/plugin/12384-toolkit"><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://img.shields.io/jetbrains/plugin/v/12384-toolkit.svg" alt="JetBrains Plugins"></a><a href="https://plugins.jetbrains.com/plugin/12384-toolkit/versions"><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="http://phpstorm.espend.de/badge/12384/version" alt="Version"></a><a href="https://plugins.jetbrains.com/plugin/12384-toolkit"><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://img.shields.io/jetbrains/plugin/d/12384-toolkit.svg" alt="Downloads"></a><a href="https://github.com/liuzhihang/toolkit/blob/master/LICENSE"><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://img.shields.io/badge/license-MIT-red.svg" alt="License"></a></div><p>ä¸€ä¸ªå°å·¥å…·åŒ…, æš‚æ—¶è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½éœ€è¦æ‰©å±•.</p><h2 id="ç‰¹å¾"><a href="#ç‰¹å¾" class="headerlink" title="ç‰¹å¾"></a>ç‰¹å¾</h2><ul><li>Mybatis<ul><li>é€šè¿‡ä¾§æ ç®­å¤´åœ¨ MyBatis XMLæ–‡ä»¶å’Œ Mapperæ–‡ä»¶ä¹‹é—´ç›¸äº’è·³è½¬</li><li>mapperæ–‡ä»¶idç®€å•æ£€æŸ¥</li></ul></li><li>Json<ul><li>JavaBeanå¤åˆ¶ä¸ºJsonå­—ç¬¦ä¸²</li><li>Jsonå­—ç¬¦ä¸²æ ¼å¼åŒ–</li><li>Jsonå­—ç¬¦ä¸²è½¬æ¢ä¸ºJavaBean</li><li>Jsonå‹ç¼©</li></ul></li><li>XML: Xmlæ ¼å¼åŒ–</li></ul><h2 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h2><ul><li>æ–‡æœ«æ¼”ç¤º</li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><ul><li><p><strong>åœ¨çº¿å®‰è£…:</strong></p><ul><li><code>File</code> -&gt; <code>Setting</code> -&gt; <code>Plugins</code> -&gt; æœç´¢ <code>Toolkit</code></li></ul></li><li><p><strong>æ‰‹åŠ¨å®‰è£…:</strong></p><ul><li><a href="https://github.com/liuzhihang/toolkit/releases">ä¸‹è½½æ’ä»¶</a> -&gt; <code>File</code> -&gt; <code>Setting</code> -&gt; <code>Plugins</code> -&gt; <code>Install Plugin from Disk...</code></li></ul></li></ul><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><ul><li>å³é”®èœå•é€‰æ‹© <code>Tookit</code></li></ul><h2 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h2><h2 id="v1-0-7-2020-02-27"><a href="#v1-0-7-2020-02-27" class="headerlink" title="v1.0.7 (2020-02-27)"></a><a href="https://github.com/liuzhihang/toolkit/releases/tag/v1.0.7">v1.0.7</a> (2020-02-27)</h2><ul><li>ä¿®æ”¹ä½¿ç”¨åŒ…è£…ç±»å‹</li></ul><p><a href="./doc/ChangeNotes.md">æŸ¥çœ‹æ›´å¤šå†å²æ›´æ–°è®°å½•</a></p><h2 id="æ„Ÿè°¢"><a href="#æ„Ÿè°¢" class="headerlink" title="æ„Ÿè°¢"></a>æ„Ÿè°¢</h2><h5 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis:"></a>MyBatis:</h5><p>&emsp;mybatis support: <a href="https://github.com/zhaoqin102/mybatis-support">https://github.com/zhaoqin102/mybatis-support</a></p><p>&emsp;free-idea-mybatis: <a href="https://github.com/wuzhizhan/free-idea-mybatis">https://github.com/wuzhizhan/free-idea-mybatis</a></p><h5 id="Json"><a href="#Json" class="headerlink" title="Json:"></a>Json:</h5><p>&emsp;GsonFormat: <a href="https://github.com/zzz40500/GsonFormat">https://github.com/zzz40500/GsonFormat</a></p><h2 id="æœ¬å·¥å…·ä½¿ç”¨-JetBrains-IDEA-è¿›è¡Œå¼€å‘"><a href="#æœ¬å·¥å…·ä½¿ç”¨-JetBrains-IDEA-è¿›è¡Œå¼€å‘" class="headerlink" title="æœ¬å·¥å…·ä½¿ç”¨ JetBrains IDEA è¿›è¡Œå¼€å‘"></a>æœ¬å·¥å…·ä½¿ç”¨ JetBrains IDEA è¿›è¡Œå¼€å‘</h2><p><a href="https://www.jetbrains.com/?from=Toolkit"><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/toolkit/jetbrains-logo.png" width="20%" height="20%"></a><a href="https://www.jetbrains.com/?from=Toolkit"><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/toolkit/idea-logo.png" width="20%" height="20%"> </a></p><h2 id="æ¼”ç¤º-1"><a href="#æ¼”ç¤º-1" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h2><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/toolkit/copy-as-json.png" alt="copy-as-json"><br><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/toolkit/gif.gif" alt="gif"></p>]]></content>
      
      
      <categories>
          
          <category> IDEA </category>
          
      </categories>
      
      
        <tags>
            
            <tag> plugin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>elasticsearch cat API</title>
      <link href="2019/03/14/elasticsearch-cat-api.html"/>
      <url>2019/03/14/elasticsearch-cat-api.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="cat-API"><a href="#cat-API" class="headerlink" title="cat API"></a>cat API</h4><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cat.html">å®˜æ–¹åœ°å€</a></p><blockquote><p>GET /_cat/XXX?v<br>GET /_cat/XXX?v&amp;format=json</p></blockquote><p>v æ˜¯æŒ‡å¸¦ç€åˆ—ä¿¡æ¯</p><p>æ”¯æŒæŒ‡å®šè¿”å›å†…å®¹çš„æ ¼å¼ é»˜è®¤ä¸ºtext</p><p>?format=text(json/smile/yaml/cbor)</p><a id="more"></a><h5 id="æŸ¥çœ‹èŠ‚ç‚¹åˆ«å"><a href="#æŸ¥çœ‹èŠ‚ç‚¹åˆ«å" class="headerlink" title="æŸ¥çœ‹èŠ‚ç‚¹åˆ«å"></a>æŸ¥çœ‹èŠ‚ç‚¹åˆ«å</h5><blockquote><p>GET /_cat/aliases?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/aliases?vâ€</p></blockquote><h5 id="æ¯ä¸ªèŠ‚ç‚¹åˆ†é…äº†å‡ ä¸ªshardï¼Œå¯¹ç£ç›˜çš„å ç”¨ç©ºé—´å¤§å°ï¼Œä½¿ç”¨ç‡"><a href="#æ¯ä¸ªèŠ‚ç‚¹åˆ†é…äº†å‡ ä¸ªshardï¼Œå¯¹ç£ç›˜çš„å ç”¨ç©ºé—´å¤§å°ï¼Œä½¿ç”¨ç‡" class="headerlink" title="æ¯ä¸ªèŠ‚ç‚¹åˆ†é…äº†å‡ ä¸ªshardï¼Œå¯¹ç£ç›˜çš„å ç”¨ç©ºé—´å¤§å°ï¼Œä½¿ç”¨ç‡"></a>æ¯ä¸ªèŠ‚ç‚¹åˆ†é…äº†å‡ ä¸ªshardï¼Œå¯¹ç£ç›˜çš„å ç”¨ç©ºé—´å¤§å°ï¼Œä½¿ç”¨ç‡</h5><blockquote><p>GET /_cat/allocation?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/allocation?vâ€</p></blockquote><h5 id="ç¾¤é›†æˆ–å•ä¸ªç´¢å¼•çš„documentè®¡æ•°"><a href="#ç¾¤é›†æˆ–å•ä¸ªç´¢å¼•çš„documentè®¡æ•°" class="headerlink" title="ç¾¤é›†æˆ–å•ä¸ªç´¢å¼•çš„documentè®¡æ•°"></a>ç¾¤é›†æˆ–å•ä¸ªç´¢å¼•çš„documentè®¡æ•°</h5><blockquote><p>GET /_cat/count?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/count?v</p><p>GET /_cat/count/index_name?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/count/index_name?vâ€</p></blockquote><h5 id="æ˜¾ç¤ºé›†ç¾¤ä¸­æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ä¸Šfielddataå½“å‰æ­£åœ¨ä½¿ç”¨çš„å †å†…å­˜é‡"><a href="#æ˜¾ç¤ºé›†ç¾¤ä¸­æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ä¸Šfielddataå½“å‰æ­£åœ¨ä½¿ç”¨çš„å †å†…å­˜é‡" class="headerlink" title="æ˜¾ç¤ºé›†ç¾¤ä¸­æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ä¸Šfielddataå½“å‰æ­£åœ¨ä½¿ç”¨çš„å †å†…å­˜é‡"></a>æ˜¾ç¤ºé›†ç¾¤ä¸­æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ä¸Šfielddataå½“å‰æ­£åœ¨ä½¿ç”¨çš„å †å†…å­˜é‡</h5><blockquote><p>GET /_cat/fielddata?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/fielddata?vâ€</p></blockquote><h5 id="æŸ¥çœ‹é›†ç¾¤å¥åº·æƒ…å†µ"><a href="#æŸ¥çœ‹é›†ç¾¤å¥åº·æƒ…å†µ" class="headerlink" title="æŸ¥çœ‹é›†ç¾¤å¥åº·æƒ…å†µ"></a>æŸ¥çœ‹é›†ç¾¤å¥åº·æƒ…å†µ</h5><blockquote><p>GET /_cat/health?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/health?vâ€</p></blockquote><h5 id="æŸ¥çœ‹ç´¢å¼•çš„ä¿¡æ¯"><a href="#æŸ¥çœ‹ç´¢å¼•çš„ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹ç´¢å¼•çš„ä¿¡æ¯"></a>æŸ¥çœ‹ç´¢å¼•çš„ä¿¡æ¯</h5><blockquote><p>GET _cat/indices?v<br>GET _cat/indices/index_name?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/indices/twi*?v&amp;s=indexâ€</p></blockquote><h5 id="æŸ¥çœ‹masterä¿¡æ¯"><a href="#æŸ¥çœ‹masterä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹masterä¿¡æ¯"></a>æŸ¥çœ‹masterä¿¡æ¯</h5><blockquote><p>GET /_cat/master?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/master?vâ€</p></blockquote><h5 id="æŸ¥çœ‹nodeä¿¡æ¯"><a href="#æŸ¥çœ‹nodeä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹nodeä¿¡æ¯"></a>æŸ¥çœ‹nodeä¿¡æ¯</h5><blockquote><p>GET /_cat/nodes?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/nodes?vâ€</p></blockquote><h5 id="å½“å‰pendingæ²¡æ‰§è¡Œå®Œçš„taskçš„å…·ä½“æƒ…å†µï¼Œæ‰§è¡Œçš„æ˜¯ä»€ä¹ˆæ“ä½œ"><a href="#å½“å‰pendingæ²¡æ‰§è¡Œå®Œçš„taskçš„å…·ä½“æƒ…å†µï¼Œæ‰§è¡Œçš„æ˜¯ä»€ä¹ˆæ“ä½œ" class="headerlink" title="å½“å‰pendingæ²¡æ‰§è¡Œå®Œçš„taskçš„å…·ä½“æƒ…å†µï¼Œæ‰§è¡Œçš„æ˜¯ä»€ä¹ˆæ“ä½œ"></a>å½“å‰pendingæ²¡æ‰§è¡Œå®Œçš„taskçš„å…·ä½“æƒ…å†µï¼Œæ‰§è¡Œçš„æ˜¯ä»€ä¹ˆæ“ä½œ</h5><blockquote><p>åˆ›å»ºç´¢å¼•ï¼Œæ›´æ–°æ˜ å°„ï¼Œåˆ†é…æˆ–å¤±è´¥åˆ†ç‰‡çš„åˆ—è¡¨<br>GET /_cat/pending_tasks?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/pending_tasks?vâ€</p></blockquote><h5 id="æŸ¥çœ‹å®‰è£…çš„æ’ä»¶"><a href="#æŸ¥çœ‹å®‰è£…çš„æ’ä»¶" class="headerlink" title="æŸ¥çœ‹å®‰è£…çš„æ’ä»¶"></a>æŸ¥çœ‹å®‰è£…çš„æ’ä»¶</h5><blockquote><p>GET /_cat/plugins?v&amp;s=component&amp;h=name,component,version,description<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/plugins?v&amp;s=component&amp;h=name,component,version,descriptionâ€</p></blockquote><h5 id="shard-recoveryæ¢å¤çš„è¿‡ç¨‹æƒ…å†µ"><a href="#shard-recoveryæ¢å¤çš„è¿‡ç¨‹æƒ…å†µ" class="headerlink" title="shard recoveryæ¢å¤çš„è¿‡ç¨‹æƒ…å†µ"></a>shard recoveryæ¢å¤çš„è¿‡ç¨‹æƒ…å†µ</h5><blockquote><p>GET /_cat/recovery?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/recovery?vâ€</p></blockquote><h5 id="æŸ¥çœ‹åœ¨ç¾¤é›†ä¸­æ³¨å†Œçš„å¿«ç…§å­˜å‚¨åº“"><a href="#æŸ¥çœ‹åœ¨ç¾¤é›†ä¸­æ³¨å†Œçš„å¿«ç…§å­˜å‚¨åº“" class="headerlink" title="æŸ¥çœ‹åœ¨ç¾¤é›†ä¸­æ³¨å†Œçš„å¿«ç…§å­˜å‚¨åº“"></a>æŸ¥çœ‹åœ¨ç¾¤é›†ä¸­æ³¨å†Œçš„å¿«ç…§å­˜å‚¨åº“</h5><blockquote><p>GET /_cat/repositories?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/repositories?v</p></blockquote><h5 id="æŸ¥çœ‹çº¿ç¨‹æ± ä½¿ç”¨"><a href="#æŸ¥çœ‹çº¿ç¨‹æ± ä½¿ç”¨" class="headerlink" title="æŸ¥çœ‹çº¿ç¨‹æ± ä½¿ç”¨"></a>æŸ¥çœ‹çº¿ç¨‹æ± ä½¿ç”¨</h5><blockquote><p>GET /_cat/thread_pool<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/thread_poolâ€</p></blockquote><h5 id="æŸ¥çœ‹shardæƒ…å†µ"><a href="#æŸ¥çœ‹shardæƒ…å†µ" class="headerlink" title="æŸ¥çœ‹shardæƒ…å†µ"></a>æŸ¥çœ‹shardæƒ…å†µ</h5><blockquote><p>GET _cat/shards?v<br>GET _cat/shards/index_name?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/shards/index_name?v</p></blockquote><h5 id="ç´¢å¼•segmentæ–‡ä»¶çš„æƒ…å†µï¼Œåœ¨å“ªä¸ªnodeä¸Šï¼Œæœ‰å¤šå°‘ä¸ªdocumentï¼Œå ç”¨äº†å¤šå°‘ç£ç›˜ç©ºé—´ï¼Œæœ‰å¤šå°‘æ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæ˜¯å¦å¯ä»¥æœç´¢"><a href="#ç´¢å¼•segmentæ–‡ä»¶çš„æƒ…å†µï¼Œåœ¨å“ªä¸ªnodeä¸Šï¼Œæœ‰å¤šå°‘ä¸ªdocumentï¼Œå ç”¨äº†å¤šå°‘ç£ç›˜ç©ºé—´ï¼Œæœ‰å¤šå°‘æ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæ˜¯å¦å¯ä»¥æœç´¢" class="headerlink" title="ç´¢å¼•segmentæ–‡ä»¶çš„æƒ…å†µï¼Œåœ¨å“ªä¸ªnodeä¸Šï¼Œæœ‰å¤šå°‘ä¸ªdocumentï¼Œå ç”¨äº†å¤šå°‘ç£ç›˜ç©ºé—´ï¼Œæœ‰å¤šå°‘æ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæ˜¯å¦å¯ä»¥æœç´¢"></a>ç´¢å¼•segmentæ–‡ä»¶çš„æƒ…å†µï¼Œåœ¨å“ªä¸ªnodeä¸Šï¼Œæœ‰å¤šå°‘ä¸ªdocumentï¼Œå ç”¨äº†å¤šå°‘ç£ç›˜ç©ºé—´ï¼Œæœ‰å¤šå°‘æ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæ˜¯å¦å¯ä»¥æœç´¢</h5><blockquote><p>GET /_cat/segments?v<br>GET _cat/segments/index_name?v<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/segments/index_name?v</p></blockquote><h5 id="æŸ¥çœ‹tempalte"><a href="#æŸ¥çœ‹tempalte" class="headerlink" title="æŸ¥çœ‹tempalte"></a>æŸ¥çœ‹tempalte</h5><blockquote><p>GET /_cat/templates?v&amp;s=name<br>curl -X GET â€œ192.168.xxx.xxx:9200/_cat/templates?v&amp;s=nameâ€</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸ºä»€ä¹ˆesé›†ç¾¤è‡³å°‘éœ€è¦ä¸‰ä¸ªèŠ‚ç‚¹</title>
      <link href="2019/03/13/why-does-the-es-cluster-require-at-least-three-nodes.html"/>
      <url>2019/03/13/why-does-the-es-cluster-require-at-least-three-nodes.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="elasticsearché›†ç¾¤"><a href="#elasticsearché›†ç¾¤" class="headerlink" title="elasticsearché›†ç¾¤"></a>elasticsearché›†ç¾¤</h4><div class="mermaid">graph LR;    A(Master Node) --- B(Data Node);    A --- C(Data Node);    B --- C;</div><p>Master: åœ¨Elasticsearchä¸­Masterä»…ä»…è´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€</p><blockquote><ol><li>åˆ›å»ºæˆ–åˆ é™¤ç´¢å¼•</li><li>è·Ÿè¸ªå“ªäº›èŠ‚ç‚¹æ˜¯é›†ç¾¤çš„ä¸€éƒ¨åˆ†</li><li>å†³å®šå°†å“ªäº›ç¢ç‰‡åˆ†é…ç»™å“ªä¸ªèŠ‚ç‚¹</li><li>ç­‰é›†ç¾¤èŒƒå›´çš„æ“ä½œ</li></ol></blockquote><p>ä¸Šé¢çš„ä¸€äº›é›†ç¾¤ä¿¡æ¯, æ˜¯ç”±MasterèŠ‚ç‚¹è¿›è¡Œç»´æŠ¤, ä½†æ˜¯ Masterä¹Ÿä¼šæŠŠèŠ‚ç‚¹ä¿¡æ¯, åŒæ­¥ç»™å…¶ä»–èŠ‚ç‚¹, ä½†æ˜¯åªæœ‰masterèŠ‚ç‚¹å¯ä»¥ä¿®æ”¹.</p><a id="more"></a><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html">ç‚¹å‡»æŸ¥çœ‹ElasticsearchèŠ‚ç‚¹ä»‹ç»</a></p><h4 id="ä¸ºä»€ä¹ˆè¦è‡³å°‘ä¸‰ä¸ªèŠ‚ç‚¹"><a href="#ä¸ºä»€ä¹ˆè¦è‡³å°‘ä¸‰ä¸ªèŠ‚ç‚¹" class="headerlink" title="ä¸ºä»€ä¹ˆè¦è‡³å°‘ä¸‰ä¸ªèŠ‚ç‚¹"></a>ä¸ºä»€ä¹ˆè¦è‡³å°‘ä¸‰ä¸ªèŠ‚ç‚¹</h4><p>é¦–å…ˆæŸ¥çœ‹ Elasticsearch çš„é…ç½®æ–‡ä»¶, å¦‚ä¸‹:<br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-zen.html">Zen Discovery å®˜æ–¹ä»‹ç»</a></p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¼ é€’åˆå§‹ä¸»æœºåˆ—è¡¨ï¼Œä»¥ä¾¿åœ¨å¯åŠ¨æ–°èŠ‚ç‚¹æ—¶æ‰§è¡Œå‘ç°</span></span><br><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span> [<span class="string">&quot;192.168.xxx.xxx:9300&quot;</span>, <span class="string">&quot;192.168.xxx.xxx:9300&quot;</span>]</span><br><span class="line"><span class="comment"># é€‰ä¸¾Masteæ—¶éœ€è¦çš„èŠ‚ç‚¹æ•° (total number of master-eligible nodes / 2 + 1) é˜²æ­¢â€œé˜²æ­¢è„‘è£‚â€</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="comment"># ä¸€ä¸ªèŠ‚ç‚¹å¤šä¹…pingä¸€æ¬¡ï¼Œé»˜è®¤1s</span></span><br><span class="line"><span class="attr">discovery.zen.fd.ping_interval:</span> <span class="string">1s</span></span><br><span class="line"><span class="comment"># ç­‰å¾…pingè¿”å›æ—¶é—´ï¼Œé»˜è®¤30s</span></span><br><span class="line"><span class="attr">discovery.zen.fd.ping_timeout:</span> <span class="string">30s</span></span><br><span class="line"><span class="comment"># pingè¶…æ—¶é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤3æ¬¡</span></span><br><span class="line"><span class="attr">discovery.zen.fd.ping_retries:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><pre><code>discovery.zen.minimum_master_nodes: 2</code></pre><p>å…¶ä¸­ minimum_master_nodes é…ç½®æ˜¯ä¸ºäº†é˜²æ­¢è„‘è£‚</p><h5 id="å‡è®¾-Elasticsearch-æœ‰ä¸¤ä¸ªèŠ‚ç‚¹"><a href="#å‡è®¾-Elasticsearch-æœ‰ä¸¤ä¸ªèŠ‚ç‚¹" class="headerlink" title="å‡è®¾ Elasticsearch æœ‰ä¸¤ä¸ªèŠ‚ç‚¹"></a>å‡è®¾ Elasticsearch æœ‰ä¸¤ä¸ªèŠ‚ç‚¹</h5><div class="mermaid">graph LR;    A(Master Node) --- B(Data Node);</div><div class="mermaid">graph LR;    A(Master Node) -.X.- B(Data Node);</div><ol><li><p>discovery.zen.minimum_master_nodes: 1</p><blockquote><p>æ­¤æ—¶å‡ºç°ç½‘ç»œæ³¢åŠ¨, å¯¼è‡´ Aâ€”B ä¹‹é—´çŸ­æš‚æ–­å¼€è¿æ¥,  æ ¹æ®é€‰ä¸¾è§„åˆ™, Bå°†è‡ªå·±é€‰ä¸¾ä¸º Master, å½“ç½‘ç»œæ³¢åŠ¨ç»“æŸ, å°±ä¼šå‡ºç°ä¸¤ä¸ªMasterçš„æƒ…å†µ.</p></blockquote> <div class="mermaid">graph LR;    A(Master Node å®•æœº) --- B(Data Node);</div></li></ol><ol start="2"><li>discovery.zen.minimum_master_nodes: 2<blockquote><p>Master å‡ºç°æ•…éšœ, åˆ™ B å°†æ°¸è¿œä¸å¯èƒ½å°†è‡ªå·±é€‰æ‹©ä¸º Master</p></blockquote></li></ol><h5 id="Elasticsearch-æœ‰ä¸‰ä¸ªèŠ‚ç‚¹"><a href="#Elasticsearch-æœ‰ä¸‰ä¸ªèŠ‚ç‚¹" class="headerlink" title="Elasticsearch æœ‰ä¸‰ä¸ªèŠ‚ç‚¹"></a>Elasticsearch æœ‰ä¸‰ä¸ªèŠ‚ç‚¹</h5><p>ä¸‰èŠ‚ç‚¹é…ç½®: discovery.zen.minimum_master_nodes: 2</p><div class="mermaid">graph LR;    A(Master Node) -.X.- B(Data Node);    A -.X.- C(Data Node);    B --- C;</div><p>å‡ºç°ç½‘ç»œæ³¢åŠ¨ A èŠ‚ç‚¹ å’Œ åˆ«çš„èŠ‚ç‚¹çŸ­æš‚æ–­å¼€è¿æ¥</p><div class="mermaid">graph LR;    A(Master Node -&gt; Data Node) -.X.- B(Data Node -&gt; Master Node);    A -.X.- C(Data Node);    B --- C;</div><p>AèŠ‚ç‚¹é™çº§, Bå’ŒC è¿›è¡Œé€‰ä¸¾, æ­¤å¤„æ¨¡æ‹Ÿé€‰ä¸¾Bä¸º Master Node</p><div class="mermaid">graph LR;    A(Data Node) --- B(Master Node);    A --- C(Data Node);    B --- C;</div><p>ç½‘ç»œæ¢å¤åçš„èŠ‚ç‚¹çŠ¶å†µ.</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>ä»¥ä¸Šå¯ä»¥çœ‹å‡º, é€šè¿‡é…ç½® minimum_master_nodes æ¥é˜²æ­¢å‡ºç°è„‘è£‚<br>åŒæ—¶åœ¨ç”Ÿäº§è¿‡ç¨‹ä¸­, ä¸ºäº†å°½é‡ä¿æŒé›†ç¾¤é«˜å¯ç”¨, è‡³å°‘éœ€è¦ä¸‰å°æœºå™¨æ­å»ºé›†ç¾¤</p>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch æ•°æ®å†™å…¥æµç¨‹</title>
      <link href="2019/03/12/elasticsearch-data-writing-process.html"/>
      <url>2019/03/12/elasticsearch-data-writing-process.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="ç®€å•æµç¨‹"><a href="#ç®€å•æµç¨‹" class="headerlink" title="ç®€å•æµç¨‹"></a>ç®€å•æµç¨‹</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="/resources/image/elk/elasticsearch-writing-process.png" alt="elasticsearchå†™å…¥è¿‡ç¨‹"></p><ol><li><p>å®¢æˆ·ç«¯éšæœºé€‰æ‹©ä¸€ä¸ªnodeå‘é€æ•°æ®, æ­¤æ—¶è¯¥nodeä¸ºåè°ƒèŠ‚ç‚¹(coordinating node)<br> 1.1. coordinating node é€šè¿‡ _idè®¡ç®—å‡ºè¯¥documentåœ¨å“ªä¸ªshardä¸Š, å‡è®¾ä¸ºshard0, è®¡ç®—æ–¹å¼å¦‚ä¸‹:</p><blockquote><p>hash(_id) % number_of_primary_shards</p></blockquote><p> 1.2. node æ ¹æ® cluster state è·å–åˆ° shard0 åœ¨ node1 ä¸Š</p><a id="more"></a></li><li><p>å°†æ¶ˆæ¯å‘é€åˆ° node1 çš„ P0 ä¸Š</p></li><li><p>P0 æ”¶åˆ°æ•°æ®å, å°†æ•°æ®åŒæ­¥åˆ° è‡ªå·±çš„ replica shard R0ä¸Š</p></li><li><p>P0 å’Œ R0 éƒ½å¤„ç†å®Œæ¯•, æ‰ä¼šè¿”å›å®¢æˆ·ç«¯æˆåŠŸ</p></li></ol><blockquote><p>Px ä¸º primary shard<br>Rx ä¸º replica shard<br>å½“å®¢æˆ·ç«¯è¯·æ±‚ä¸ºæŸ¥è¯¢æ—¶, è·¯ç”±åˆ°ä»»æ„ shard(primary shard æˆ–è€… replica shard) æŸ¥è¯¢åˆ°æ•°æ®å³å¯è¿”å›.</p></blockquote><h4 id="è¯¦ç»†æµç¨‹"><a href="#è¯¦ç»†æµç¨‹" class="headerlink" title="è¯¦ç»†æµç¨‹"></a>è¯¦ç»†æµç¨‹</h4><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="/resources/image/elk/elasticsearch-writing-detailed-process.png" alt="elasticsearch-writing-detailed-process"></p><ol><li>P0æ”¶åˆ°document, åŒæ—¶å°†æ•°æ®å†™å…¥åˆ° å†…å­˜bufferå’Œtranslogä¸­</li><li>æ¯éš”1sæˆ–bufferæ»¡æ—¶, bufferä¸­çš„æ•°æ®ä¼š refresh åˆ°segmentä¸­, è€Œåè¿›å…¥os cache, ä¸€æ—¦segmentè¿›å…¥åˆ° cacheä¸­,å…¶ä¸­çš„æ•°æ®, åˆ™å¯ä»¥è¢«æœç´¢åˆ°<blockquote><p>refresh æ—¶é—´å¯ä»¥æ‰‹åŠ¨è®¾ç½®, ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘ refresh</p></blockquote></li><li>æ¸…ç©ºbuffer, translogä¸å¤„ç†</li><li>é‡å¤1-3æ“ä½œ, translogä¸æ–­å¢å¤§, translogæ¯éš”30åˆ†é’Ÿ,æˆ–å¤§åˆ°ä¸€å®šé‡æ—¶, ä¼šè§¦å‘commitæ“ä½œ</li><li>å°†bufferä¸­å†…å®¹åˆ·æ–°åˆ°segmentä¸­, å¹¶æ¸…ç©ºbuffer</li><li>å°†ä¸€ä¸ªcommit point å†™å…¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­, æ ‡è¯†æ­¤æ¬¡commit å¯¹åº”çš„ segment</li><li>æ‰§è¡Œ fsync å°† os cache ä¸­çš„æ•°æ®å¼ºåˆ¶åˆ·æ–°åˆ°ç£ç›˜æ–‡ä»¶ä¸­</li><li>åˆ é™¤ translog æ–‡ä»¶</li></ol><h5 id="åˆ é™¤å’Œæ›´æ–°æ“ä½œ"><a href="#åˆ é™¤å’Œæ›´æ–°æ“ä½œ" class="headerlink" title="åˆ é™¤å’Œæ›´æ–°æ“ä½œ"></a>åˆ é™¤å’Œæ›´æ–°æ“ä½œ</h5><blockquote><p>åœ¨commitæ—¶, å¦‚æœæ“ä½œä¸ºåˆ é™¤, ç”Ÿæˆä¸€ä¸ª .delæ–‡ä»¶, å…¶ä¸­å°†è¯¥documentæ ‡è®°ä½deleted, å¹¶ä¸æ˜¯çœŸæ­£çš„ç‰©ç†åˆ é™¤, æ­¤æ—¶å¦‚æœæœ‰æŸ¥è¯¢è¯·æ±‚, ä¼šå…ˆæŸ¥è¯¢ .delæ–‡ä»¶ä¸­æ˜¯å¦æœ‰è¯¥è®°å½•, å¦‚æœæœ‰, åˆ™å›å¤ä¸å­˜åœ¨.<br>åœ¨commitæ—¶, å¦‚æœä¸ºæ›´æ–°æ“ä½œ, åˆ™æ˜¯å°†åŸdocumentæ ‡è®°ä½deleted, åŒæ—¶å†™å…¥ä¸€æ¡æ–°æ•°æ®</p></blockquote><h5 id="æœåŠ¡å®•æœºé‡å¯-translog-æ—¥å¿—ä½œç”¨"><a href="#æœåŠ¡å®•æœºé‡å¯-translog-æ—¥å¿—ä½œç”¨" class="headerlink" title="æœåŠ¡å®•æœºé‡å¯, translog æ—¥å¿—ä½œç”¨"></a>æœåŠ¡å®•æœºé‡å¯, translog æ—¥å¿—ä½œç”¨</h5><blockquote><p>translogæ˜¯å…ˆå†™å…¥åˆ° os cacheä¸­, ç„¶åæ¯éš”5så†™å…¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­, å‡å¦‚æœåŠ¡å®•æ‰, å¯èƒ½ä¼šå¤±å»5sæ•°æ®, ä¹Ÿå¯ä»¥ä¿®æ”¹å†™å…¥ç£ç›˜çš„æ—¶æœº, ä½†æ˜¯å¯èƒ½ä¼šå½±å“æ€§èƒ½<br>translogä¸­è®°å½•çš„æ˜¯æ•°æ®æ“ä½œä¿¡æ¯, åœ¨æœåŠ¡å®•æœºé‡å¯æ—¶, ä¼šè¯»å–translogç£ç›˜æ–‡ä»¶, ç„¶åå°†translogä¸­çš„æ•°æ®é‡æ–°æ¢å¤åˆ° segmentä¸­, ç„¶åè¿›è¡Œåç»­æ“ä½œ</p></blockquote><h5 id="segment-merge-è¿‡ç¨‹"><a href="#segment-merge-è¿‡ç¨‹" class="headerlink" title="segment merge è¿‡ç¨‹"></a>segment merge è¿‡ç¨‹</h5><blockquote><p>segment æŒç»­ç”Ÿæˆ, ä¼šå¯¼è‡´ segmentä¸æ–­å˜å¤š, å ç”¨<a href="https://baike.baidu.com/item/%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84">æ–‡ä»¶å¥æŸ„</a>, cpuèµ„æºç­‰ç­‰<br>esåå°æœ‰ä¸€ä¸ªä¸“é—¨çš„ç¨‹åºè´Ÿè´£åˆå¹¶segment, å°†å°çš„ segment åˆæˆå¤§çš„segment, åŒæ—¶å†™ä¸€ä¸ªcommit point, æ ‡è¯† æ–°çš„segment file.<br>æ‰“å¼€æ–°çš„segmentä¾›æŸ¥è¯¢ä½¿ç”¨, åˆ é™¤æ—§çš„ segment<br>segment åˆå¹¶è¿‡ç¨‹ä¸­, è¢«æ ‡è®°ä½ deleted çš„document ä¸ä¼šè¢«åˆå¹¶. å³: åœ¨åˆå¹¶ segmentæ—¶, æ‰å°† document çœŸæ­£ç‰©ç†åˆ é™¤<br>åˆå¹¶çš„segment å¯ä»¥ä½¿ç£ç›˜ä¸Šå·²ç»commitçš„ç´¢å¼• ä¹Ÿå¯ä»¥æ˜¯å†…å­˜ä¸­è¿˜æœªcommitçš„ç´¢å¼•</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>logstash inputå¤šä¸ªkafkaå¼‚å¸¸</title>
      <link href="2019/03/04/logstash-input-multiple-kafka-exceptions.html"/>
      <url>2019/03/04/logstash-input-multiple-kafka-exceptions.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h5 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h5><div class="mermaid">graph LR;    filebeat --&gt; logstash;    log4j --&gt; logstash;    logstash --&gt; es;</div><p>filebeat å’Œ log4j appender åŒæ—¶åˆ° kafka, logstashåœ¨å¯åŠ¨æ—¶æŠ¥é”™, é”™è¯¯å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">javax.management.InstanceAlreadyExistsException: kafka.consumer:type&#x3D;app-info,id&#x3D;logstash-0</span><br></pre></td></tr></table></figure><a id="more"></a><h5 id="é—®é¢˜åŸå› åŠè§£å†³"><a href="#é—®é¢˜åŸå› åŠè§£å†³" class="headerlink" title="é—®é¢˜åŸå› åŠè§£å†³"></a>é—®é¢˜åŸå› åŠè§£å†³</h5><p>input æ¶ˆè´¹kafkaæ—¶, åˆ†åˆ«æŒ‡å®šä¸åŒçš„ client_id.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kafka &#123;</span><br><span class="line">        bootstrap_servers &#x3D;&gt; [&quot;192.168.103.43:9092&quot;] # æ³¨æ„è¿™é‡Œé…ç½®çš„kafkaçš„brokeråœ°å€ä¸æ˜¯zkçš„åœ°å€</span><br><span class="line">        client_id &#x3D;&gt; &quot;kafka_client_1&quot;</span><br><span class="line">        group_id &#x3D;&gt; &quot;logstash&quot;</span><br><span class="line">        topics &#x3D;&gt; [&quot;ipaynow_log&quot;]  # kafka topic åç§°</span><br><span class="line">        consumer_threads &#x3D;&gt; 5</span><br><span class="line">        decorate_events &#x3D;&gt; true</span><br><span class="line">        type &#x3D;&gt; &quot;string&quot;</span><br><span class="line">        codec &#x3D;&gt; &quot;json&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kafka &#123;</span><br><span class="line">        bootstrap_servers &#x3D;&gt; [&quot;192.168.103.43:9092&quot;] # æ³¨æ„è¿™é‡Œé…ç½®çš„kafkaçš„brokeråœ°å€ä¸æ˜¯zkçš„åœ°å€</span><br><span class="line">        client_id &#x3D;&gt; &quot;kafka_client_2&quot;</span><br><span class="line">        group_id &#x3D;&gt; &quot;logstash&quot;</span><br><span class="line">        topics &#x3D;&gt; [&quot;ipaynow-hunter&quot;]  # kafka topic åç§°</span><br><span class="line">        consumer_threads &#x3D;&gt; 5</span><br><span class="line">        decorate_events &#x3D;&gt; true</span><br><span class="line">        type &#x3D;&gt; &quot;string&quot;</span><br><span class="line">        codec &#x3D;&gt; plain &#123; charset&#x3D;&gt;&quot;UTF-8&quot; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> issue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¨‹åºæ— å¼‚å¸¸ä¸­æ–­</title>
      <link href="2019/02/15/no-abnormal-interruption-of-the-program.html"/>
      <url>2019/02/15/no-abnormal-interruption-of-the-program.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h4><ol><li>ç¨‹åºæ‰§è¡Œåˆ°æŸä¸€å¤„ä¹‹ååœé¡¿, ä¸èƒ½ç»§ç»­æ‰§è¡Œ, ä¸æŠ›å‡ºå¼‚å¸¸, æ— è¿”å›å€¼</li><li>æœ¬åœ°æµ‹è¯•æ­£å¸¸</li><li>debugå¯ä»¥æ­£å¸¸æ‰§è¡Œ</li><li>æ“ä½œä¸ºå…¥åº“ä¹‹å‰, åˆ›å»ºå¯¹è±¡, æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„setæ“ä½œ</li></ol><blockquote><p>payInfoExtra.setToAccType(agPayReqDto.getToAccType().getValue());</p><p>å…¶ä¸­getæ“ä½œè·å–çš„ä¸ºä¸€ä¸ªæšä¸¾, ä¸»è¦æ“ä½œä¸ºä»æšä¸¾ä¸­è·å–value setåˆ°å¦ä¸€ä¸ªå¯¹è±¡ä¸­</p></blockquote><a id="more"></a><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AccTypeEnum <span class="title">getToAccType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> toAccType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜åŸå› åŠè§£å†³"><a href="#é—®é¢˜åŸå› åŠè§£å†³" class="headerlink" title="é—®é¢˜åŸå› åŠè§£å†³"></a>é—®é¢˜åŸå› åŠè§£å†³</h4><p>å°ä¼™ä¼´åœ¨ä»–ä»¬é¡¹ç›®ä¸­å¤ç”¨æœ¬é¡¹ç›®ä¸­çš„æšä¸¾ç±», æ²¡æœ‰ä¿®æ”¹åŒ…åç±»å, ä½†æ˜¯æŠŠæšä¸¾ä¸­valueå­—æ®µä» byteæ”¹æˆäº†String, åŒæ—¶æ”¾åœ¨äº†ä¾èµ–ä¸­, æä¾›ç»™æˆ‘ä»¬ä½¿ç”¨.<br>è§£å†³æ–¹æ¡ˆå°±å¾ˆç®€å•äº†, è®©å°ä¼™ä¼´ä¿®æ”¹åŒ…åç±»åå°±å¯ä»¥äº†.<br>åŸæšä¸¾ç±»å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">AccTypeEnum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    PRI((<span class="keyword">byte</span>) <span class="number">0</span>, <span class="string">&quot;å¯¹ç§&quot;</span>),</span><br><span class="line">    PUB((<span class="keyword">byte</span>) <span class="number">1</span>, <span class="string">&quot;å¯¹å…¬&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span> value;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> issue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> issue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>skywalking5é›†ç¾¤éƒ¨ç½²</title>
      <link href="2018/12/27/skywalking5-cluster-deployment.html"/>
      <url>2018/12/27/skywalking5-cluster-deployment.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="å‡†å¤‡ç¯å¢ƒ"><a href="#å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡ç¯å¢ƒ"></a>å‡†å¤‡ç¯å¢ƒ</h4><ol><li>skywalking-5.0.0-GA</li><li>zookeeper-3.4.10</li><li>elasticsearch-5.6.14</li></ol><p>ä¸‹è½½åœ°å€å¦‚ä¸‹:</p><pre><code>skywalking: http://skywalking.apache.org/downloads/zookeeper: http://mirrors.hust.edu.cn/apache/zookeeper/elasticsearch: https://www.elastic.co/downloads/past-releases</code></pre><a id="more"></a><h4 id="å®‰è£…zké›†ç¾¤"><a href="#å®‰è£…zké›†ç¾¤" class="headerlink" title="å®‰è£…zké›†ç¾¤"></a>å®‰è£…zké›†ç¾¤</h4><ol><li>ä¸‹è½½å¹¶è§£å‹zk<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://mirrors.hust.edu.cn/apache/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz</span><br><span class="line">tar -xvf zookeeper-3.4.10.tar.gz</span><br></pre></td></tr></table></figure></li><li>ä¿®æ”¹é…ç½®æ–‡ä»¶<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> zookeeper-3.4.10/conf/</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">vim zoo.cfg</span><br></pre></td></tr></table></figure></li><li>å†…å®¹å¦‚ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/opt/<span class="built_in">export</span>/app/zookeeper-3.4.10/data</span><br><span class="line">clientPort=2181</span><br><span class="line">server.1=192.168.***.236:2888:3888</span><br><span class="line">server.2=192.168.***.237:2888:3888</span><br></pre></td></tr></table></figure></li><li>å†™å…¥é›†ç¾¤myid<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /opt/<span class="built_in">export</span>/app/zookeeper-3.4.10/data/myid</span><br><span class="line"><span class="comment"># å¦ä¸€å°æœºå™¨åˆ™å†™å…¥2</span></span><br></pre></td></tr></table></figure></li><li>zkåŸºæœ¬å‘½ä»¤<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœ¨zkçš„binç›®å½•ä¸‹</span></span><br><span class="line"><span class="comment"># å¯åŠ¨</span></span><br><span class="line">./zkServer.sh start</span><br><span class="line"><span class="comment"># åœæ­¢</span></span><br><span class="line">./zkServer.sh stop</span><br><span class="line"><span class="comment"># æŸ¥çœ‹çŠ¶æ€</span></span><br><span class="line">./zkServer.sh status</span><br><span class="line"><span class="comment"># æŸ¥çœ‹zkçš„èŠ‚ç‚¹</span></span><br><span class="line">./zkCli.sh</span><br><span class="line"><span class="comment"># è¿æ¥åä½¿ç”¨ ls / å‘½ä»¤æŸ¥çœ‹</span></span><br><span class="line">ls /skywalking</span><br></pre></td></tr></table></figure></li></ol><h4 id="å®‰è£…esé›†ç¾¤"><a href="#å®‰è£…esé›†ç¾¤" class="headerlink" title="å®‰è£…esé›†ç¾¤"></a>å®‰è£…esé›†ç¾¤</h4><ol><li>ä¸‹è½½å¹¶è§£å‹es<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.14.tar.gz</span><br><span class="line">tar -xvf elasticsearch-5.6.14.tar.gz</span><br></pre></td></tr></table></figure></li><li>ä¿®æ”¹é…ç½®æ–‡ä»¶<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> elasticsearch-5.6.14/config/</span><br><span class="line">vim elasticsearch.yml</span><br></pre></td></tr></table></figure></li><li>å†…å®¹å¦‚ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cluster.name: CollectorDBCluster</span><br><span class="line">node.name: node-1</span><br><span class="line">path.data: /opt/<span class="built_in">export</span>/app/elasticsearch-5.6.14/data</span><br><span class="line">path.logs: /opt/<span class="built_in">export</span>/app/elasticsearch-5.6.14/logs</span><br><span class="line">network.host: 192.168.***.234</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">&quot;192.168.***.234:9300&quot;</span>, <span class="string">&quot;192.168.***.235:9300&quot;</span>]</span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">bootstrap.memory_lock: <span class="literal">false</span></span><br><span class="line">bootstrap.system_call_filter: <span class="literal">false</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹ä¸ŠæŠ¥æ•°æ®çº¿ç¨‹æ± å¤§å°</span></span><br><span class="line">thread_pool.bulk.queue_size: 1000</span><br></pre></td></tr></table></figure></li><li>å¸¸ç”¨å‘½ä»¤<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åå°å¯åŠ¨</span></span><br><span class="line">bin/elasticsearch -d</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰ç´¢å¼•</span></span><br><span class="line">curl -XDELETE 192.168.***.234:9200/*</span><br></pre></td></tr></table></figure></li></ol><h4 id="å®‰è£…skywalking"><a href="#å®‰è£…skywalking" class="headerlink" title="å®‰è£…skywalking"></a>å®‰è£…skywalking</h4><p>â˜ <a href="https://github.com/apache/incubator-skywalking/blob/v5.0.0-GA/docs/cn/Deploy-backend-in-cluster-mode-CN.md">å®˜æ–¹åœ°å€</a></p><ol><li>ä¸‹è½½å¹¶è§£å‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://mirrors.shu.edu.cn/apache/incubator/skywalking/5.0.0-GA/apache-skywalking-apm-incubating-5.0.0-GA.tar.gz</span><br><span class="line">tar -xvf apache-skywalking-apm-incubating-5.0.0-GA.tar.gz</span><br><span class="line">mv apache-skywalking-apm-incubating-5.0.0-GA skywalking-5.0.0-GA</span><br></pre></td></tr></table></figure></li><li>ä¿®æ”¹é…ç½®<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> skywalking-5.0.0-GA/config/</span><br><span class="line">vim application.yml</span><br></pre></td></tr></table></figure></li><li>ä¿®æ”¹å†…å®¹å¦‚ä¸‹<ol><li>é›†ç¾¤é…ç½® <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cluster:</span><br><span class="line">    zookeeper:</span><br><span class="line">        hostPort: 192.168.***.236:2181,192.168.***.237:2181</span><br><span class="line">        sessionTimeout: 100000</span><br></pre></td></tr></table></figure></li><li>esé…ç½® <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">storage:</span><br><span class="line">    elasticsearch:</span><br><span class="line">        clusterName: CollectorDBCluster</span><br><span class="line">        clusterTransportSniffer: <span class="literal">true</span></span><br><span class="line">        clusterNodes: 192.168.***.234:9300,192.168.***.235:9300</span><br><span class="line">        <span class="comment"># å…¶ä»–é…ç½®</span></span><br></pre></td></tr></table></figure></li><li>å…¶ä»–é…ç½® <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hosté…ç½®ä¿®æ”¹</span></span><br><span class="line">host: 192.168.***.236</span><br></pre></td></tr></table></figure></li></ol></li><li>ä¿®æ”¹webappé…ç½®<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim webapp/webapp.yml</span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">collector:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/graphql</span></span><br><span class="line">    <span class="attr">ribbon:</span></span><br><span class="line">        <span class="attr">ReadTimeout:</span> <span class="number">10000</span></span><br><span class="line">        <span class="attr">listOfServers:</span> <span class="number">192.168</span><span class="string">.**.236:10800,192.168.**.237:10800</span></span><br></pre></td></tr></table></figure></li><li>å¸¸ç”¨å‘½ä»¤<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨collector+webUI</span></span><br><span class="line">bin/startup.sh</span><br><span class="line"><span class="comment"># åªå¯åŠ¨collectoræˆ–webUI</span></span><br><span class="line">bin/collectorService.sh</span><br><span class="line">bin/webappService.sh</span><br></pre></td></tr></table></figure></li><li>æ¢é’ˆä½¿ç”¨<br> â˜ <a href="https://github.com/apache/incubator-skywalking/blob/v5.0.0-GA/docs/cn/Deploy-skywalking-agent-CN.md">å®˜æ–¹åœ°å€</a><pre><code> java -javaagent:/path/to/skywalking-agent/skywalking-agent.jar -jar yourApp.jar</code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> skywalking </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
            <tag> skywalking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>logstashæ—¶é—´æˆ³å·®8ä¸ªå°æ—¶</title>
      <link href="2018/12/20/logstash-timestamp-difference-8-hours.html"/>
      <url>2018/12/20/logstash-timestamp-difference-8-hours.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="é—®é¢˜è¯´æ˜"><a href="#é—®é¢˜è¯´æ˜" class="headerlink" title="é—®é¢˜è¯´æ˜"></a>é—®é¢˜è¯´æ˜</h4><p>åŸå§‹é…ç½®:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">elasticsearch &#123;</span><br><span class="line">        # manage_template &#x3D;&gt; false</span><br><span class="line">        template_overwrite &#x3D;&gt; true</span><br><span class="line">        template &#x3D;&gt; &quot;&#x2F;opt&#x2F;export&#x2F;app&#x2F;logstash-6.4.2&#x2F;bin&#x2F;dynamic_templates.json&quot;</span><br><span class="line">        user &#x3D;&gt; xxxxxxx</span><br><span class="line">        password &#x3D;&gt; xxxxxxx</span><br><span class="line">        index &#x3D;&gt; &quot;%&#123;sys_name&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">        hosts &#x3D;&gt; [&quot;172.19.3.51:9200&quot;,&quot;172.19.3.52:9200&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨logstashè¾“å‡ºå†…å®¹è¦esä¸­æ—¶, æŒ‡å®šindexä¸ºç³»ç»Ÿåç§°+æ—¶é—´(å¹´æœˆæ—¥), æ—¶é—´ä¼šè‡ªåŠ¨åŒ¹é…â€˜@timestampâ€™å­—æ®µå¹¶æ ¼å¼åŒ–, ä½†æ˜¯åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­, å‘ç°åœ¨ä¸Šåˆå…«ç‚¹ä¹‹å‰çš„æ¶ˆæ¯ä¼šè¢«åˆ›å»ºåˆ°æ˜¨å¤©çš„ç´¢å¼•é‡Œé¢.æŸ¥é˜…ç›¸å…³èµ„æ–™, æœ‰ä»‹ç»åœ¨æ—¶é—´æˆ³ä¸Šé¢å¢åŠ 8ä¸ªå°æ—¶çš„æ–¹å¼, ä¹Ÿå¯ä»¥ä½¿ç”¨. è¿™é‡Œç»“åˆè‡ªå·±ä¸šåŠ¡ä½¿ç”¨çš„å…¶ä»–æ–¹å¼.</p><a id="more"></a><h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><ol><li><p>ä¸»è¦æŠ¥é€å†…å®¹ä¸ºfilebeatçš„æ—¥å¿—ä¿¡æ¯, æ—¥å¿—ç»Ÿä¸€æœ‰æ—¶é—´æˆ³, æ ¼å¼å¦‚ä¸‹:</p><pre><code> [trans-mediapay]-[2018-12-19 02:00:00:187]-[queryThreadPool-14]-[]-[WeBankServiceImpl.java:101]-[INFO ]-[æµ‹è¯•2ç‚¹çš„æ—¥å¿—]</code></pre></li><li><p>è§£ææ—¶é—´æˆ³çš„æ—¶é—´</p><ol><li>å…ˆåŒ¹é…æ•´ä½“æ—¥å¿—, è·å–â€™log_timeâ€™å­—æ®µ</li><li>åŒ¹é…â€™log_timeâ€™å­—æ®µ</li><li>ç”Ÿæˆå…ƒæ•°æ® â€˜[@metadata][index_suffix]â€™<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">#  æ—¥å¿—èšåˆä½¿ç”¨å…¨é‡é…ç½®</span></span><br><span class="line">grok &#123;</span><br><span class="line">match =&gt; &#123;</span><br><span class="line"><span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;\[%&#123;DATA:sys_name&#125;\]-\[%&#123;DATA:log_time&#125;\]-\[%&#123;DATA:thread_name&#125;\]-\[%&#123;DATA:trace_id&#125;\]-\[%&#123;DATA:class_name&#125;\]-\[%&#123;DATA:log_level&#125;\]-%&#123;GREEDYDATA:log_msg&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">grok&#123;</span><br><span class="line">        match =&gt; &#123; <span class="string">&quot;log_time&quot;</span> =&gt; [<span class="string">&quot;%&#123;INT:index_year&#125;-%&#123;INT:index_mouth&#125;-%&#123;INT:index_day&#125;&quot;</span>]&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">    <span class="comment"># ä½¿ç”¨å…ƒæ•°æ® [@metadata][index_suffix]</span></span><br><span class="line">add_field =&gt; &#123; <span class="string">&quot;[@metadata][index_suffix]&quot;</span> =&gt; <span class="string">&quot;%&#123;index_year&#125;.%&#123;index_mouth&#125;.%&#123;index_day&#125;&quot;</span> &#125;</span><br><span class="line">        remove_field =&gt; [<span class="string">&quot;host&quot;</span>,<span class="string">&quot;beat&quot;</span>,<span class="string">&quot;tags&quot;</span>,<span class="string">&quot;[beat][name]&quot;</span>,<span class="string">&quot;[beat][version]&quot;</span>,<span class="string">&quot;prospector&quot;</span>,<span class="string">&quot;@version&quot;</span>,<span class="string">&quot;offset&quot;</span>,<span class="string">&quot;input&quot;</span>,<span class="string">&quot;y_index&quot;</span>,<span class="string">&quot;M_index&quot;</span>,<span class="string">&quot;d_index&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>è¾“å‡ºæ—¶ä½¿ç”¨å…ƒæ•°æ®, è¯¥å­—æ®µä¸ä¼šå‡ºç°åœ¨esçš„å­—æ®µä¸­</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">elasticsearch &#123;</span><br><span class="line">        <span class="comment"># manage_template =&gt; false</span></span><br><span class="line">        template_overwrite =&gt; <span class="literal">true</span></span><br><span class="line">        template =&gt; <span class="string">&quot;/opt/export/app/logstash-6.4.2/bin/dynamic_templates.json&quot;</span></span><br><span class="line">        user =&gt; xxxxxxx</span><br><span class="line">        password =&gt; xxxxxxx</span><br><span class="line">        index =&gt; <span class="string">&quot;%&#123;sys_name&#125;-%&#123;[@metadata][index_suffix]&#125;&quot;</span></span><br><span class="line">        hosts =&gt; [<span class="string">&quot;xxxx:9200&quot;</span>,<span class="string">&quot;xxxx:9200&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> issue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è·å–IPå’Œbyteè½¬longé‡åˆ°çš„å°é—®é¢˜</title>
      <link href="2018/12/10/get-the-small-problem-encountered-by-ip-and-byte-to-long.html"/>
      <url>2018/12/10/get-the-small-problem-encountered-by-ip-and-byte-to-long.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>å› ä¸ºä¸šåŠ¡éœ€æ±‚æ–°é¡¹ç›®çš„æµæ°´å·ç³»ç»Ÿä» â€˜æ•°æ®åº“è‡ªå¢æ­¥é•¿+åˆ†æ®µå¼é”â€™ æ¢æˆä½¿ç”¨ <a href="https://github.com/liuzhihang/tool_demo/blob/master/src/main/java/com/ipaynow/tool/snowflake/SnowFlake.java">é›ªèŠ±æµæ°´å·</a>, ä¿®æ”¹æœºå™¨æ ‡è¯†å’Œæ•°æ®ä¸­å¿ƒå­—æ®µä¸ºè‡ªåŠ¨è·å–ipåä¸‰ä½, äººå·¥ä¿è¯ipåä¸‰ä½ä¸ç›¸åŒ</p><h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><p><a href="https://github.com/liuzhihang/tool_demo/blob/master/src/main/java/com/ipaynow/tool/snowflake/SnowFlakeSerial.java">é›ªèŠ±æµæ°´å· - æ”¹é€ ç‰ˆ</a></p><p>ä¿®æ”¹å†…å®¹å¦‚ä¸‹:<br>åˆ é™¤æ„é€ , ä¿®æ”¹æ•°æ®ä½æ•°, æ·»åŠ é™æ€ä»£ç å—</p><a id="more"></a><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MACHINE_BIT = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> DATA_CENTER_BIT = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InetAddress localHost = InetAddress.getLocalHost();</span><br><span class="line">        address = localHost.getAddress()[<span class="number">3</span>] &amp; <span class="number">0xff</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;å½“å‰ç³»ç»Ÿçš„ address ä¸º: &quot;</span> + address);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;DATA_CENTER_ID can&#x27;t be greater than MAX_DATA_CENTER_NUM or less than 0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h4><h5 id="æœåŠ¡å™¨é…ç½®host"><a href="#æœåŠ¡å™¨é…ç½®host" class="headerlink" title="æœåŠ¡å™¨é…ç½®host"></a>æœåŠ¡å™¨é…ç½®host</h5><p>æœåŠ¡å™¨å¯¹åº”çš„ hostname éœ€è¦é…ç½®ipåœ°å€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat /etc/hosts</span><br></pre></td></tr></table></figure><h5 id="byte-è½¬æ¢-longéœ€è¦-amp-0xff"><a href="#byte-è½¬æ¢-longéœ€è¦-amp-0xff" class="headerlink" title="byte è½¬æ¢ longéœ€è¦ &amp; 0xff"></a>byte è½¬æ¢ longéœ€è¦ &amp; 0xff</h5><p>å½“è·å–ipå¤§äº127æ—¶è½¬æ¢å‡ºæ¥ä¸ºè´Ÿå€¼, æ‰€ä»¥éœ€è¦ &amp; 0xff</p>]]></content>
      
      
      <categories>
          
          <category> issue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºLinkHashMapçš„LRUç¼“å­˜æ·˜æ±°</title>
      <link href="2018/11/19/elimination-of-lru-cache-based-on-linkhashmap.html"/>
      <url>2018/11/19/elimination-of-lru-cache-based-on-linkhashmap.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h5 id="LRUç¼“å­˜æ·˜æ±°"><a href="#LRUç¼“å­˜æ·˜æ±°" class="headerlink" title="LRUç¼“å­˜æ·˜æ±°"></a>LRUç¼“å­˜æ·˜æ±°</h5><p>LRUç¼“å­˜æ·˜æ±°æ˜¯redisä¸­çš„ä¸€ç§æ·˜æ±°ç­–ç•¥, å½“å†…å­˜å¤§å°ä¸è¶³ä»¥å­˜æ”¾æ•°æ®æ—¶, æ­¤æ—¶å­˜å…¥æ–°æ•°æ®, å°†åˆ é™¤è¾ƒæ—©å­˜å…¥çš„æ•°æ®.<br>åœ¨dubboä¸­ä½¿ç”¨LRUæ¥ç¼“å­˜ hostName.<br>åœ¨mysqlä¸­ä½¿ç”¨LRUæ¥ç¼“å­˜ serverSideStatementCheckCache å’Œ serverSideStatementCache.</p><h5 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ipaynow.tool.lru;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŸºäºLinkedHashMap LRU ç¼“å­˜æ·˜æ±°, ä»¥ä¸‹æ¡†æ¶ä¸­éƒ½æœ‰ä½¿ç”¨</span></span><br><span class="line"><span class="comment"> * dubbo com.alibaba.dubbo.common.utils.LRUCache</span></span><br><span class="line"><span class="comment"> * com.mysql.jdbc.util.LRUCache</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/11/20 10:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LRULinkedHashMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®æœ€å¤§å®¹é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> maxCapacity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAX_CAPACITY = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRULinkedHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.maxCapacity = DEFAULT_MAX_CAPACITY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRULinkedHashMap</span><span class="params">(<span class="keyword">int</span> maxCapacity)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// accessOrderè®¾ç½®ä¸ºtrue æŒ‰ç…§æ—¶é—´æ’åº</span></span><br><span class="line">        <span class="keyword">super</span>(maxCapacity, DEFAULT_LOAD_FACTOR, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.maxCapacity = maxCapacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“é“¾è¡¨é•¿åº¦å¤§äºæœ€å¤§å®¹é‡æ—¶ åˆ é™¤æœ€æ—§çš„å…ƒç´ </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;K, V&gt; eldest)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> size() &gt; maxCapacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsKey</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.containsKey(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.get(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.put(key, value);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.remove(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.size();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">super</span>.clear();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaxCapacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> maxCapacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxCapacity</span><span class="params">(<span class="keyword">int</span> maxCapacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.maxCapacity = maxCapacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="æµ‹è¯•ä»£ç åŠç»“æœ"><a href="#æµ‹è¯•ä»£ç åŠç»“æœ" class="headerlink" title="æµ‹è¯•ä»£ç åŠç»“æœ"></a>æµ‹è¯•ä»£ç åŠç»“æœ</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ipaynow.tool.lru;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/11/20 10:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LRUTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        LRULinkedHashMap&lt;String, String&gt; map = <span class="keyword">new</span> LRULinkedHashMap&lt;&gt;(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            map.put(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss SSS&quot;</span>)), <span class="string">&quot;value&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iterator = map.entrySet().iterator(); iterator.hasNext(); ) &#123;</span><br><span class="line">            Map.Entry&lt;String, String&gt; entry = iterator.next();</span><br><span class="line">            String key = entry.getKey();</span><br><span class="line">            String value = entry.getValue();</span><br><span class="line">            System.out.println(key + <span class="string">&quot;------------&quot;</span> + value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ§åˆ¶å°è¾“å‡ºç»“æœ:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2018-11-20 11:13:21 398------------value5</span><br><span class="line">2018-11-20 11:13:22 399------------value6</span><br><span class="line">2018-11-20 11:13:23 400------------value7</span><br><span class="line">2018-11-20 11:13:24 400------------value8</span><br><span class="line">2018-11-20 11:13:25 400------------value9</span><br><span class="line"></span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
          <category> cache </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
            <tag> cache </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ELKå¸¸ç”¨å¯åŠ¨å‘½ä»¤</title>
      <link href="2018/10/29/elk-common-start-command.html"/>
      <url>2018/10/29/elk-common-start-command.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="elasticsearchå¯åŠ¨å‘½ä»¤"><a href="#elasticsearchå¯åŠ¨å‘½ä»¤" class="headerlink" title="elasticsearchå¯åŠ¨å‘½ä»¤"></a>elasticsearchå¯åŠ¨å‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å‰å°å¯åŠ¨ å…³é—­çª—å£è¿æ¥åè‡ªåŠ¨é€€å‡º</span></span><br><span class="line">./bin/elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="comment"># åå°å¯åŠ¨</span></span><br><span class="line">./bin/elasticsearch  -d</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="logstashå¯åŠ¨å‘½ä»¤"><a href="#logstashå¯åŠ¨å‘½ä»¤" class="headerlink" title="logstashå¯åŠ¨å‘½ä»¤"></a>logstashå¯åŠ¨å‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å‰å°å¯åŠ¨ -f åé¢ä¸ºé…ç½®æ–‡ä»¶</span></span><br><span class="line">./logstash -f logstash.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># åå°å¯åŠ¨</span></span><br><span class="line">nohup ./logstash -f logstash.conf &amp;</span><br></pre></td></tr></table></figure><h4 id="kibanaå¯åŠ¨å‘½ä»¤"><a href="#kibanaå¯åŠ¨å‘½ä»¤" class="headerlink" title="kibanaå¯åŠ¨å‘½ä»¤"></a>kibanaå¯åŠ¨å‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å‰å°å¯åŠ¨</span></span><br><span class="line">./bin/kibana</span><br><span class="line"></span><br><span class="line"><span class="comment"># åå°å¯åŠ¨</span></span><br><span class="line">./bin/kibana &amp;</span><br></pre></td></tr></table></figure><h5 id="kibanaåœæ­¢å‘½ä»¤"><a href="#kibanaåœæ­¢å‘½ä»¤" class="headerlink" title="kibanaåœæ­¢å‘½ä»¤"></a>kibanaåœæ­¢å‘½ä»¤</h5><p>å½“ps -ef | grep kibana æŸ¥ä¸åˆ°æ—¶ å¯ä»¥<br>lsof -i:5601<br>kill -9 çº¿ç¨‹</p><h4 id="filebeatå¯åŠ¨å‘½ä»¤"><a href="#filebeatå¯åŠ¨å‘½ä»¤" class="headerlink" title="filebeatå¯åŠ¨å‘½ä»¤"></a>filebeatå¯åŠ¨å‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å‰å°å¯åŠ¨</span></span><br><span class="line">./filebeat -e -c filebeat.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># åå°å¯åŠ¨ ä¸è¾“å‡ºæ—¥å¿—/è¾“å‡ºæ—¥å¿—</span></span><br><span class="line">nohup ./filebeat -e -c filebeat.yml &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">nohup ./filebeat -e -c filebeat.yml &gt; filebeat.log &amp;</span><br></pre></td></tr></table></figure><h5 id="jaråŒ…å¯åŠ¨å‘½ä»¤"><a href="#jaråŒ…å¯åŠ¨å‘½ä»¤" class="headerlink" title="jaråŒ…å¯åŠ¨å‘½ä»¤"></a>jaråŒ…å¯åŠ¨å‘½ä»¤</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å‰å°å¯åŠ¨</span></span><br><span class="line">java -jar server.ja</span><br><span class="line"></span><br><span class="line"><span class="comment"># åå°å¯åŠ¨</span></span><br><span class="line">nohup java -jar server.jar &amp;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>search-guard-6 é…ç½®ç”¨æˆ·</title>
      <link href="2018/10/24/searchguard6-configuration-user.html"/>
      <url>2018/10/24/searchguard6-configuration-user.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="search-guard-é…ç½®ç”¨æˆ·"><a href="#search-guard-é…ç½®ç”¨æˆ·" class="headerlink" title="search-guard é…ç½®ç”¨æˆ·"></a>search-guard é…ç½®ç”¨æˆ·</h4><p>è·¯å¾„: /opt/export/app/elasticsearch-6.4.2/plugins/search-guard-6/sgconfig</p><h5 id="ç”Ÿæˆå¯†ç "><a href="#ç”Ÿæˆå¯†ç " class="headerlink" title="ç”Ÿæˆå¯†ç "></a>ç”Ÿæˆå¯†ç </h5><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤, è¾“å…¥æ˜æ–‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">plugins/search-guard-6/tools/hasher.sh -p mycleartextpassword</span><br></pre></td></tr></table></figure><a id="more"></a><h5 id="1-é…ç½®ç”¨æˆ·åŠå¯†ç "><a href="#1-é…ç½®ç”¨æˆ·åŠå¯†ç " class="headerlink" title="1. é…ç½®ç”¨æˆ·åŠå¯†ç "></a>1. é…ç½®ç”¨æˆ·åŠå¯†ç </h5><p>æ–‡ä»¶: sg_internal_users.yml</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">zhangsan:</span></span><br><span class="line">  <span class="attr">hash:</span> <span class="string">$2y$12$yKXk785zSTtB3kE7g.XnbOPrc690g9JE50Znwum924i2M/xYGG4qq</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">trans_group</span></span><br></pre></td></tr></table></figure><p>æ ¼å¼:</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">å§“å:</span></span><br><span class="line">  <span class="string">å¯†ç :</span> <span class="string">XXXX(æ˜æ–‡çš„hash,</span> <span class="string">ä½¿ç”¨search-guardçš„å·¥å…·ç”Ÿæˆ)</span></span><br><span class="line">  <span class="string">è§’è‰²:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">è§’è‰²åç§°</span></span><br></pre></td></tr></table></figure><h5 id="2-é…ç½®æƒé™"><a href="#2-é…ç½®æƒé™" class="headerlink" title="2. é…ç½®æƒé™"></a>2. é…ç½®æƒé™</h5><p>æ–‡ä»¶: sg_roles.xml</p><p>é…ç½®â€™?kibanaâ€™ åŠâ€™?kibana-6â€™ æƒé™æ˜¯ä¸ºäº†ä¿è¯ç”¨æˆ·åœ¨kibanaä¸­èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨kibana</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">sg_trans_group:</span></span><br><span class="line">  <span class="attr">cluster:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cluster:monitor/nodes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cluster:monitor/health</span></span><br><span class="line">  <span class="attr">indices:</span></span><br><span class="line">    <span class="attr">&#x27;log-system&#x27;:</span></span><br><span class="line">      <span class="string">&#x27;*&#x27;</span><span class="string">:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">indices:admin/mappings/fields/get</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">indices:admin/validate/query</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">indices:data/read/search</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">indices:data/read/msearch</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">indices:admin/get</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">indices:data/read/field_stats</span></span><br><span class="line">    <span class="string">&#x27;?kibana&#x27;</span><span class="string">:</span></span><br><span class="line">      <span class="string">&#x27;*&#x27;</span><span class="string">:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">MANAGE</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">INDEX</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">READ</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">DELETE</span></span><br><span class="line">    <span class="string">&#x27;?kibana-6&#x27;</span><span class="string">:</span></span><br><span class="line">      <span class="string">&#x27;*&#x27;</span><span class="string">:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">MANAGE</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">INDEX</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">READ</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">DELETE</span></span><br></pre></td></tr></table></figure><p>æ ¼å¼:</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">æƒé™åç§°:</span></span><br><span class="line">  <span class="string">é›†ç¾¤:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">é›†ç¾¤åç§°:æƒé™</span></span><br><span class="line">  <span class="string">ç´¢å¼•:</span></span><br><span class="line">    <span class="string">&#x27;ç´¢å¼•åç§°&#x27;</span><span class="string">:</span></span><br><span class="line">      <span class="string">&#x27;ç±»å‹&#x27;</span><span class="string">:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">æƒé™</span></span><br></pre></td></tr></table></figure><h5 id="3-é…ç½®è§’è‰²æ˜ å°„"><a href="#3-é…ç½®è§’è‰²æ˜ å°„" class="headerlink" title="3. é…ç½®è§’è‰²æ˜ å°„"></a>3. é…ç½®è§’è‰²æ˜ å°„</h5><p>æ–‡ä»¶: sg_roles_mapping.yml</p><p>é…ç½®å®Œç”¨æˆ·çš„è´¦æˆ·å¯†ç , ä»¥åŠç›¸åº”è§’è‰²æƒé™ä¹‹å, éœ€è¦å°†ç”¨æˆ·å’Œæƒé™è¿›è¡Œå…³è”, å…³è”ä¹‹åå³å¯ä½¿ç”¨</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">sg_trans_group:</span></span><br><span class="line">   <span class="attr">backendroles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">trans_group</span></span><br></pre></td></tr></table></figure><p>æ ¼å¼:</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">æ˜ å°„åç§°:</span></span><br><span class="line">  <span class="string">è§’è‰²:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ç”¨æˆ·çš„è§’è‰²</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è¿›è¡Œå…³è”:</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">sg_trans_group:</span></span><br><span class="line">   <span class="attr">users:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">zhangsan</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">lisi</span></span><br><span class="line"><span class="comment"># å³</span></span><br><span class="line"><span class="string">æ˜ å°„åç§°:</span></span><br><span class="line">  <span class="string">ç”¨æˆ·åç§°:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ç”¨æˆ·å</span></span><br></pre></td></tr></table></figure><h5 id="4-ä½¿é…ç½®ç”Ÿæ•ˆ"><a href="#4-ä½¿é…ç½®ç”Ÿæ•ˆ" class="headerlink" title="4. ä½¿é…ç½®ç”Ÿæ•ˆ"></a>4. ä½¿é…ç½®ç”Ÿæ•ˆ</h5><p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./sgadmin.sh -cn é›†ç¾¤åç§° -<span class="built_in">cd</span> ../sgconfig -ks ../../../config/sgadmin-keystore.jks -kspass changeit -ts ../../../config/truststore.jks -tspass changeit -nhnv</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>search-guard-6 å®‰è£…</title>
      <link href="2018/10/23/searchguard6-installation.html"/>
      <url>2018/10/23/searchguard6-installation.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="ES-å®‰è£…-search-guard-6"><a href="#ES-å®‰è£…-search-guard-6" class="headerlink" title="ES å®‰è£… search-guard-6"></a>ES å®‰è£… search-guard-6</h4><h6 id="å®‰è£…æ’ä»¶"><a href="#å®‰è£…æ’ä»¶" class="headerlink" title="å®‰è£…æ’ä»¶"></a>å®‰è£…æ’ä»¶</h6><p>â˜ <a href="https://docs.search-guard.com/latest/demo-installer">å®˜æ–¹ç½‘ç«™</a><br>åœ¨ESç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤</p><pre><code>bin/elasticsearch-plugin install -b com.floragunn:search-guard-6:6.4.2-23.1</code></pre><p>æ³¨: å®‰è£…ç‰ˆæœ¬éœ€è¦å’ŒElasticsearchç‰ˆæœ¬ç›¸å¯¹åº”. <a href="https://docs.search-guard.com/latest/search-guard-versions">æŸ¥çœ‹ç‰ˆæœ¬</a></p><p>è¿™é‡Œä¸ä½¿ç”¨å®˜æ–¹çš„å¿«é€Ÿæ„å»ºæ–¹æ³•</p><a id="more"></a><h6 id="ç”Ÿæˆè¯ä¹¦"><a href="#ç”Ÿæˆè¯ä¹¦" class="headerlink" title="ç”Ÿæˆè¯ä¹¦"></a>ç”Ÿæˆè¯ä¹¦</h6><ol><li><p>ä¸‹è½½è„šæœ¬<br> <code>git clone https://github.com/floragunncom/search-guard-ssl.git</code></p></li><li><p>è¯ä¹¦é…ç½®<br> è·¯å¾„<br> <code>**/elasticsearch-6.4.2/search-guard-ssl/example-pki-scripts</code></p><p> ç›®å½•å†…å®¹ etcä¸‹å¯å¯¹è¯ä¹¦è¿›è¡Œé…ç½®<br> <img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="/resources/image/elk/configuration.png" alt="è¯ä¹¦é…ç½®"></p></li><li><p>ä¿®æ”¹<a href="search-guard-ssl/example-pki-scripts/example.sh">example.sh</a></p></li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">OPENSSL_VER=<span class="string">&quot;<span class="subst">$(openssl version)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$OPENSSL_VER</span> == *<span class="string">&quot;0.9&quot;</span>* ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Your OpenSSL version is too old: <span class="variable">$OPENSSL_VER</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Please install version 1.0.1 or later&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> -1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Your OpenSSL version is: <span class="variable">$OPENSSL_VER</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line">./clean.sh</span><br><span class="line"><span class="comment"># ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºCAæ ¹è¯ä¹¦å¯†ç ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºTSå¯†ç (truststoreï¼Œä¿¡ä»»è¯ä¹¦å¯†ç )</span></span><br><span class="line">./gen_root_ca.sh capass changeit</span><br><span class="line"><span class="comment"># ç”ŸæˆèŠ‚ç‚¹è¯ä¹¦ï¼š ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºèŠ‚ç‚¹ç¼–å·ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºkeystoreæ–‡ä»¶å¯†ç ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºCAæ ¹è¯ä¹¦å¯†ç ã€‚</span></span><br><span class="line"><span class="comment"># æ­¤å¤„æˆ‘ä»¬åªç”Ÿæˆä¸¤ä¸ªèŠ‚ç‚¹è¯ä¹¦</span></span><br><span class="line">./gen_node_cert.sh 0 changeit capass &amp;&amp; ./gen_node_cert.sh 1 changeit capass</span><br><span class="line"><span class="comment"># ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦ï¼š ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå®¢æˆ·ç«¯åç§°, ç¬¬äºŒä¸ªå‚æ•°ä¸ºkeystoreæ–‡ä»¶åç§°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºCAæ ¹è¯ä¹¦åç§°ã€‚</span></span><br><span class="line">./gen_client_node_cert.sh spock changeit capass</span><br><span class="line">./gen_client_node_cert.sh kirk changeit capass</span><br><span class="line">./gen_client_node_cert.sh logstash changeit capass</span><br><span class="line">./gen_client_node_cert.sh filebeat changeit capass</span><br><span class="line">./gen_client_node_cert.sh kibana changeit capass</span><br><span class="line"><span class="comment"># ç”Ÿæˆä¸€ä¸ªsgadminå®¢æˆ·ç«¯è¯ä¹¦ï¼Œç”¨äºé…ç½®ç®¡ç†</span></span><br><span class="line">./gen_client_node_cert.sh sgadmin changeit capass</span><br><span class="line"><span class="comment"># ç”Ÿæˆä¸€ä¸ªjavaapiè®¿é—®çš„å®¢æˆ·ç«¯è¯ä¹¦</span></span><br><span class="line">./gen_client_node_cert.sh javaapi changeit capass</span><br><span class="line">rm -f ./*tmp*</span><br></pre></td></tr></table></figure><ol start="4"><li>ç”Ÿæˆè¯ä¹¦ç§»åŠ¨åˆ°elasticsearch config åœ¨ESç›®å½•ä¸‹</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./example.sh</span><br><span class="line">cp node-0-keystore.jks sgadmin-keystore.jks truststore.jks /opt/<span class="built_in">export</span>/app/elasticsearch-6.4.2/config/</span><br></pre></td></tr></table></figure><ol start="5"><li>é…ç½®elasticsearch.yml, å¢åŠ ä»¥ä¸‹é…ç½®</li></ol><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é…ç½®èŠ‚ç‚¹é—´é€šä¿¡è¯ä¹¦ï¼ŒèŠ‚ç‚¹é—´é€šä¿¡ä½¿ç”¨TLSæ˜¯å¼ºåˆ¶çš„</span></span><br><span class="line"><span class="attr">searchguard.ssl.transport.keystore_filepath:</span> <span class="string">node-0-keystore.jks</span></span><br><span class="line"><span class="attr">searchguard.ssl.transport.keystore_password:</span> <span class="string">changeit</span></span><br><span class="line"><span class="attr">searchguard.ssl.transport.truststore_filepath:</span> <span class="string">truststore.jks</span></span><br><span class="line"><span class="attr">searchguard.ssl.transport.truststore_password:</span> <span class="string">changeit</span></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸æ ¡éªŒhostname</span></span><br><span class="line"><span class="attr">searchguard.ssl.transport.enforce_hostname_verification:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">searchguard.ssl.transport.resolve_hostname:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># é…ç½®ç®¡ç†å‘˜è¯ä¹¦DN</span></span><br><span class="line"><span class="attr">searchguard.authcz.admin_dn:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">CN=sgadmin,OU=client,O=client,L=Test,</span> <span class="string">C=DE</span></span><br><span class="line"></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">bootstrap.system_call_filter:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><ol start="6"><li>å¯åŠ¨è®¿é—®éœ€è¦æƒé™</li></ol><h6 id="æ·»åŠ è„šæœ¬æƒé™å¹¶åˆå§‹åŒ–ç”¨æˆ·"><a href="#æ·»åŠ è„šæœ¬æƒé™å¹¶åˆå§‹åŒ–ç”¨æˆ·" class="headerlink" title="æ·»åŠ è„šæœ¬æƒé™å¹¶åˆå§‹åŒ–ç”¨æˆ·"></a>æ·»åŠ è„šæœ¬æƒé™å¹¶åˆå§‹åŒ–ç”¨æˆ·</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/<span class="built_in">export</span>/app/elasticsearch-6.4.2/plugins/search-guard-6/tools</span><br><span class="line">chmod +x *.sh</span><br><span class="line">./sgadmin.sh -cn cluster-es -<span class="built_in">cd</span> ../sgconfig -ks ../../../config/sgadmin-keystore.jks -kspass changeit -ts ../../../config/truststore.jks -tspass changeit -nhnv</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡æ›´æ–°ç”¨æˆ·æƒé™æˆ–è€…æ–°å¢ä¿®æ”¹ç”¨æˆ·, åªéœ€è¦é‡æ–°æ‰§è¡Œç¬¬ä¸‰æ¡å‘½ä»¤, æ›´æ–°ç”¨æˆ·ä¿¡æ¯å³å¯</p><h4 id="Kibanaå®‰è£…"><a href="#Kibanaå®‰è£…" class="headerlink" title="Kibanaå®‰è£…"></a>Kibanaå®‰è£…</h4><p>å‚ç…§å®˜æ–¹ç½‘ç«™å®‰è£…é…ç½®å³å¯. <a href="https://docs.search-guard.com/latest/demo-installer">å®˜æ–¹ç½‘ç«™</a>, æˆ–è€…æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤.</p><ol><li>åœ¨kibanaå®‰è£…ç›®å½•ä¸‹æ‰§è¡Œä¸€ä¸‹å—å‘½ä»¤</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bin/kibana-plugin install https://search.maven.org/remotecontent?filepath=com/floragunn/search-guard-kibana-plugin/6.4.2-15/search-guard-kibana-plugin-6.4.2-15.zip</span><br></pre></td></tr></table></figure><ol start="2"><li>ä¿®æ”¹kibana.yml</li></ol><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Use HTTPS instead of HTTP</span></span><br><span class="line"><span class="comment"># elasticsearch.url: &quot;https://localhost:9200&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.url:</span> <span class="string">&quot;http://localhost:9200&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure the Kibana internal server user</span></span><br><span class="line"><span class="attr">elasticsearch.username:</span> <span class="string">&quot;kibanaserver&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.password:</span> <span class="string">&quot;kibanaserver&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable SSL verification because we use self-signed demo certificates</span></span><br><span class="line"><span class="attr">elasticsearch.ssl.verificationMode:</span> <span class="string">none</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Whitelist the Search Guard Multi Tenancy Header</span></span><br><span class="line"><span class="attr">elasticsearch.requestHeadersWhitelist:</span> [ <span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;sgtenant&quot;</span> ]</span><br></pre></td></tr></table></figure><ol start="3"><li>æ‰“å¼€å¯¹åº”åŸŸåç™»å½•<br><code>http://localhost:5601/</code></li></ol><h4 id="æ³¨"><a href="#æ³¨" class="headerlink" title="æ³¨:"></a>æ³¨:</h4><p>ä»¥ä¸Šå†…å®¹ä¸ºå‚è€ƒè‡ª<a href="https://www.jianshu.com/u/d58afc984a4f">Mé†‰é€é¥</a>, å¹¶æ­å»ºæˆåŠŸåæ€»ç»“è®°å½•, ä»¥ä½œå¤‡å¿˜. é“¾æ¥å¦‚ä¸‹:<br><a href="https://www.jianshu.com/p/319913a944af">https://www.jianshu.com/p/319913a944af</a></p>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexoæ­å»ºåšå®¢</title>
      <link href="2018/10/08/hexo-build-blog.html"/>
      <url>2018/10/08/hexo-build-blog.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å®‰è£…node"><a href="#å®‰è£…node" class="headerlink" title="å®‰è£…node"></a>å®‰è£…node</h3><p>ä¸‹è½½åœ°å€: <a href="https://nodejs.org/en/">https://nodejs.org</a></p><p>æŸ¥çœ‹å½“å‰ç‰ˆæœ¬: node -v</p><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="/resources/hexo/node-v.png" alt="node-v"></p><h3 id="å®‰è£…hexo"><a href="#å®‰è£…hexo" class="headerlink" title="å®‰è£…hexo"></a>å®‰è£…hexo</h3><pre><code>npm install</code></pre><p>ä¹Ÿå¯ä»¥ä½¿ç”¨<a href="https://npm.taobao.org/">æ·˜å®é•œåƒ</a></p><pre><code>npm install -g cnpm --registry=https://registry.npm.taobao.orgcnpm install hexo</code></pre><a id="more"></a><h3 id="hexoå¸¸ç”¨å‘½ä»¤"><a href="#hexoå¸¸ç”¨å‘½ä»¤" class="headerlink" title="hexoå¸¸ç”¨å‘½ä»¤"></a>hexoå¸¸ç”¨å‘½ä»¤</h3><h5 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h5><pre><code>hexo init</code></pre><h5 id="æ¸…é™¤ç¼“å­˜"><a href="#æ¸…é™¤ç¼“å­˜" class="headerlink" title="æ¸…é™¤ç¼“å­˜"></a>æ¸…é™¤ç¼“å­˜</h5><pre><code>hexo clean</code></pre><h5 id="ç”Ÿæˆé™æ€æ–‡ä»¶"><a href="#ç”Ÿæˆé™æ€æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆé™æ€æ–‡ä»¶"></a>ç”Ÿæˆé™æ€æ–‡ä»¶</h5><pre><code>hexo ghexo generate</code></pre><h5 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h5><pre><code>hexo shexo server</code></pre><h5 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h5><pre><code>hexo dhexo deploy</code></pre><h5 id="ç”Ÿæˆå¹¶éƒ¨ç½²"><a href="#ç”Ÿæˆå¹¶éƒ¨ç½²" class="headerlink" title="ç”Ÿæˆå¹¶éƒ¨ç½²"></a>ç”Ÿæˆå¹¶éƒ¨ç½²</h5><pre><code>hexo g -d</code></pre>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æœåŠ¡å™¨cpuå ç”¨ç‡é«˜</title>
      <link href="2018/09/25/server-cpu-occupancy-rate-is-high.html"/>
      <url>2018/09/25/server-cpu-occupancy-rate-is-high.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="1-top-å‘½ä»¤æ‰¾åˆ°å ç”¨cpuæœ€é«˜çš„è¿›ç¨‹"><a href="#1-top-å‘½ä»¤æ‰¾åˆ°å ç”¨cpuæœ€é«˜çš„è¿›ç¨‹" class="headerlink" title="1. top å‘½ä»¤æ‰¾åˆ°å ç”¨cpuæœ€é«˜çš„è¿›ç¨‹"></a>1. top å‘½ä»¤æ‰¾åˆ°å ç”¨cpuæœ€é«˜çš„è¿›ç¨‹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">top - 14:37:14 up 34 days, 13:27,  2 users,  load average: 0.21, 0.29, 0.29</span><br><span class="line">Tasks: 151 total,   1 running, 150 sleeping,   0 stopped,   0 zombie</span><br><span class="line">Cpu(s):  4.4%us,  2.7%sy,  0.0%ni, 90.9%id,  0.5%wa,  0.0%hi,  0.2%si,  1.3%st</span><br><span class="line">Mem:  16334064k total, 16171240k used,   162824k free,    16716k buffers</span><br><span class="line">Swap: 16383996k total,  4470816k used, 11913180k free,   539788k cached</span><br><span class="line"></span><br><span class="line">PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND</span><br><span class="line">1818 tomcat    20   0 3643m 983m 7548 S  0.7 24.8 190:40.13 java</span><br><span class="line"></span><br></pre></td></tr></table></figure><a id="more"></a><p>å­—æ®µè§£é‡Š:<br>top - æ—¶é—´ è¿è¡Œæ—¶é—´ ç”¨æˆ· ç³»ç»Ÿè´Ÿè½½<br>Tasks: è¿›ç¨‹ç›¸å…³ä¿¡æ¯<br>Cpu(s): cpuç›¸å…³ä¿¡æ¯<br>Mem: å†…å­˜ç›¸å…³<br>Swap: äº¤æ¢åŒºç›¸å…³ä¿¡æ¯</p><p>è¿›ç¨‹ç›¸å…³ä¿¡æ¯<br>PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND</p><h3 id="2-ä½¿ç”¨top-H-p-æŸ¥çœ‹è¯¥è¿›ç¨‹å†…æ‰€æœ‰çº¿ç¨‹"><a href="#2-ä½¿ç”¨top-H-p-æŸ¥çœ‹è¯¥è¿›ç¨‹å†…æ‰€æœ‰çº¿ç¨‹" class="headerlink" title="2. ä½¿ç”¨top -H -p  æŸ¥çœ‹è¯¥è¿›ç¨‹å†…æ‰€æœ‰çº¿ç¨‹"></a>2. ä½¿ç”¨top -H -p <pid> æŸ¥çœ‹è¯¥è¿›ç¨‹å†…æ‰€æœ‰çº¿ç¨‹</h3><p>top -H -p 1818</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND</span><br><span class="line">6656 tomcat    20   0 4193m 608m  11m R 21.0  3.8   1419:44 java</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-printf-â€œ-x-nâ€-å°†10è¿›åˆ¶çº¿ç¨‹å·è½¬æ¢ä¸º16è¿›åˆ¶ç»“æœ"><a href="#3-printf-â€œ-x-nâ€-å°†10è¿›åˆ¶çº¿ç¨‹å·è½¬æ¢ä¸º16è¿›åˆ¶ç»“æœ" class="headerlink" title="3. printf â€œ%x\nâ€  å°†10è¿›åˆ¶çº¿ç¨‹å·è½¬æ¢ä¸º16è¿›åˆ¶ç»“æœ"></a>3. printf â€œ%x\nâ€ <pid> å°†10è¿›åˆ¶çº¿ç¨‹å·è½¬æ¢ä¸º16è¿›åˆ¶ç»“æœ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[liuzhihang@test08 ~]$ <span class="built_in">printf</span> <span class="string">&quot;%x\n&quot;</span> 1876</span><br><span class="line">754</span><br><span class="line">[liuzhihang@test08 ~]$</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-jstack-grep"><a href="#4-jstack-grep" class="headerlink" title="4. jstack  |grep "></a>4. jstack <pid> |grep <tid></h3><p>jstack 1818 | grep 754 -A 30</p><p>pid ä¸ºç¬¬ä¸€æ¬¡æ‰§è¡Œtopå‘½ä»¤æ—¶çš„ pid<br>tid ä¸ºå°†ç¬¬äºŒæ¬¡çš„pidè¿›è¡Œåå…­è¿›åˆ¶è½¬æ¢åçš„ç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;catalina-8180-89&quot;</span> <span class="comment">#1842 daemon prio=5 os_prio=0 tid=0x00007f4ec4096000 nid=0x5d96 waiting on condition [0x00007f4e87545000]</span></span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">- parking to <span class="built_in">wait</span> <span class="keyword">for</span>  &lt;0x00000000f418f898&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.await(AbstractQueuedSynchronizer.java:2039)</span><br><span class="line">at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)</span><br><span class="line">at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:104)</span><br><span class="line">at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:32)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624)</span><br><span class="line">at org.apache.tomcat.util.threads.TaskThread<span class="variable">$WrappingRunnable</span>.run(TaskThread.java:61)</span><br><span class="line">at java.lang.Thread.run(Thread.java:748)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;catalina-8180-88&quot;</span> <span class="comment">#1841 daemon prio=5 os_prio=0 tid=0x00007f4eb848e800 nid=0x5d94 waiting on condition [0x00007f4e8bd8b000]</span></span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">at sun.misc.Unsafe.park(Native Method)</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> issue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> issue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>final finally finalizeåŒºåˆ«</title>
      <link href="2018/09/06/final-finally-finalize-difference.html"/>
      <url>2018/09/06/final-finally-finalize-difference.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="final"><a href="#final" class="headerlink" title="final"></a>final</h3><p>finalä¸ºjavaå…³é”®å­—, å¯ä»¥ä½œç”¨äºæˆå‘˜å˜é‡ã€æ–¹æ³•ã€ç±»ä¸Š<br>1.ä½œç”¨äºæˆå‘˜å˜é‡ä¸Š, åŸºæœ¬ç±»å‹åˆ™å€¼ä¸å¯ä¿®æ”¹, å¦‚æœæˆå‘˜å˜é‡ä¸ºå¯¹è±¡, åˆ™è¯¥å¯¹è±¡çš„å¼•ç”¨ä¸å¯ä¿®æ”¹.<br>2.ä½œç”¨äºæ–¹æ³•, è¯¥æ–¹æ³•ä¸å¯è¢«é‡å†™<br>3.ä½œç”¨äºç±», è¯¥ç±»ä¸å¯ç»§æ‰¿</p><a id="more"></a><h3 id="finally"><a href="#finally" class="headerlink" title="finally"></a>finally</h3><p>å¼‚å¸¸å¤„ç†çš„å…³é”®å­—, æ— è®ºå¼‚å¸¸æ˜¯å¦å‘ç”Ÿ, finallyå†…é€»è¾‘æ€»ä¼šæ‰§è¡Œ.</p><h4 id="finally-å’Œ-return-çš„æ‰§è¡Œé¡ºåº"><a href="#finally-å’Œ-return-çš„æ‰§è¡Œé¡ºåº" class="headerlink" title="finally å’Œ return çš„æ‰§è¡Œé¡ºåº"></a>finally å’Œ return çš„æ‰§è¡Œé¡ºåº</h4><p>1.ä¸€èˆ¬ä½¿ç”¨é€»è¾‘, returnåœ¨try-catch-finallyä¹‹å, è¯æ˜, æ— è®ºæ˜¯å¦å¼‚å¸¸, finallyéƒ½ä¼šæ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(finallyTest());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">finallyTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¤„ç†é€»è¾‘&quot;</span>);</span><br><span class="line">            <span class="comment">// int i = 1 / 0;</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¼‚å¸¸é€»è¾‘&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;finallyæ‰§è¡Œäº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æœ€ç»ˆreturnè¿”å›&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.åœ¨try/catchå†…æ·»åŠ return<br>try/catchå†…çš„returnæ‰§è¡Œå®Œåä¼šç»§ç»­æ‰§è¡Œfinally, ä½†æ˜¯ä»æ‰“å°ç»“æœæ¥å¼€, finallyçš„è¯­å¥å…ˆæ‰“å°, åŸå› æ˜¯å› ä¸º returnçš„</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(finallyTest());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">finallyTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¤„ç†é€»è¾‘&quot;</span>);</span><br><span class="line">            <span class="comment">// int i = 1 / 0;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;try - returnè¿”å›&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¼‚å¸¸é€»è¾‘&quot;</span>);</span><br><span class="line">            <span class="comment">// return &quot;catch - returnè¿”å›&quot;;</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;finallyæ‰§è¡Œäº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æœ€ç»ˆreturnè¿”å›&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">å¤„ç†é€»è¾‘</span><br><span class="line">finallyæ‰§è¡Œäº†</span><br><span class="line">try - <span class="built_in">return</span>è¿”å›</span><br></pre></td></tr></table></figure><p>3.finallyé‡Œé¢æ·»åŠ returnè¯­å¥<br>finallyé‡Œé¢returnæ‰§è¡Œå®Œåä¼šç›´æ¥è¿”å›, ä¸ä¼šå†æ‰§è¡Œtryå—ä¸­çš„returnè¯­å¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(finallyTest());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">finallyTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¤„ç†é€»è¾‘&quot;</span>);</span><br><span class="line">            <span class="comment">// int i = 1 / 0;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;try - returnè¿”å›&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¼‚å¸¸é€»è¾‘&quot;</span>);</span><br><span class="line">            <span class="comment">// return &quot;catch - returnè¿”å›&quot;;</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;finallyæ‰§è¡Œäº†&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;finally - returnè¿”å›&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// return &quot;æœ€ç»ˆreturnè¿”å›&quot;;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">å¤„ç†é€»è¾‘</span><br><span class="line">finallyæ‰§è¡Œäº†</span><br><span class="line">finally - <span class="built_in">return</span>è¿”å›</span><br></pre></td></tr></table></figure><p>4.finallyå†…æ·»åŠ é€»è¾‘æ”¹å˜å˜é‡å€¼<br>1).tryä¸­çš„returnå€¼åªæ˜¯æš‚æ—¶æ”¾åœ¨æ ˆä¸­, æ‰€ä»¥æœ€ç»ˆè¿”å›çš„è¿˜æ˜¯ 10, finallyä¸­å¹¶æ²¡æœ‰æ”¹å˜å…¶å€¼<br>2).tryä¸­çš„returnå€¼å¦‚æœæ˜¯å¯¹è±¡, æ ˆä¸­å­˜æ”¾çš„æ˜¯å¯¹è±¡çš„å¼•ç”¨, å¯¹è±¡å±æ€§å€¼è¿˜æ˜¯å¯ä»¥é€šè¿‡finallyä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(finallyTest());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">finallyTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> temp = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¤„ç†é€»è¾‘&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;try - returnè¿”å›: &quot;</span> + temp;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¼‚å¸¸é€»è¾‘&quot;</span>);</span><br><span class="line">            <span class="comment">// return &quot;catch - returnè¿”å›&quot;;</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            temp = <span class="number">100</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;finallyæ‰§è¡Œäº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æœ€ç»ˆreturnè¿”å›: &quot;</span> + temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">å¤„ç†é€»è¾‘</span><br><span class="line">finallyæ‰§è¡Œäº†</span><br><span class="line">try - <span class="built_in">return</span>è¿”å›: 10</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Temp temp = <span class="keyword">new</span> Temp();</span><br><span class="line">        temp.temp = <span class="number">1</span>;</span><br><span class="line">        System.out.println(finallyTest(temp).toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Temp <span class="title">finallyTest</span><span class="params">(Temp temp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¤„ç†é€»è¾‘&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> temp;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¼‚å¸¸é€»è¾‘&quot;</span>);</span><br><span class="line">            <span class="comment">// return &quot;catch - returnè¿”å›&quot;;</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            temp.temp = <span class="number">100</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;finallyæ‰§è¡Œäº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Temp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Temp&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;temp=&quot;</span> + temp +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">å¤„ç†é€»è¾‘</span><br><span class="line">finallyæ‰§è¡Œäº†</span><br><span class="line">Temp&#123;temp=100&#125;</span><br></pre></td></tr></table></figure><h3 id="finalizeæ–¹æ³•"><a href="#finalizeæ–¹æ³•" class="headerlink" title="finalizeæ–¹æ³•"></a>finalizeæ–¹æ³•</h3><p>Objectç±»çš„æ–¹æ³•, å­ç±»å¯é‡å†™, ä¸»è¦æ˜¯åƒåœ¾å›æ”¶æ—¶ä½¿ç”¨.</p>]]></content>
      
      
      <categories>
          
          <category> æºç å­¦ä¹  </category>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç å­¦ä¹  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿ç¨‹æ± åŸç†åŠæºç è§£æ</title>
      <link href="2018/09/05/thread-pool-principle-and-source-code-analysis.html"/>
      <url>2018/09/05/thread-pool-principle-and-source-code-analysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="çº¿ç¨‹æ± å¤„ç†æµç¨‹"><a href="#çº¿ç¨‹æ± å¤„ç†æµç¨‹" class="headerlink" title="çº¿ç¨‹æ± å¤„ç†æµç¨‹"></a>çº¿ç¨‹æ± å¤„ç†æµç¨‹</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="/resources/concurrent/thread-pool.png" alt="çº¿ç¨‹æ± å¤„ç†æµç¨‹"></p><ol><li>åˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹æ± æ˜¯å¦å·²æ»¡, ä¸æ»¡åˆ™åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</li><li>ç­‰å¾…é˜Ÿåˆ—å¦‚æœæœ‰ç•Œ, åˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—æ˜¯å¦å·²æ»¡, ä¸æ»¡, åˆ™æ·»åŠ ä»»åŠ¡åˆ°ç­‰å¾…é˜Ÿåˆ—</li><li>åˆ¤æ–­æœ€å¤§çº¿ç¨‹æ•°æ˜¯å¦å·²æ»¡, ä¸æ»¡åˆ™åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</li><li>æœ€å¤§çº¿ç¨‹æ•°å·²æ»¡, æŒ‰ç…§æ—¢å®šç­–ç•¥å¤„ç†æ–°ä»»åŠ¡<a id="more"></a><h3 id="å…¨å‚æ„é€ åŠå„å‚æ•°å«ä¹‰"><a href="#å…¨å‚æ„é€ åŠå„å‚æ•°å«ä¹‰" class="headerlink" title="å…¨å‚æ„é€ åŠå„å‚æ•°å«ä¹‰"></a>å…¨å‚æ„é€ åŠå„å‚æ•°å«ä¹‰</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractExecutorService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize, // æ ¸å¿ƒçº¿ç¨‹æ•°</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•°</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime, // æ ¸å¿ƒçº¿ç¨‹å¤–çº¿ç¨‹çš„å­˜æ´»æ—¶é—´</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit, // å­˜æ´»æ—¶é—´çš„å•ä½</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue, // ä¿å­˜ç­‰å¾…æ‰§è¡Œçš„çº¿ç¨‹çš„é˜»å¡é˜Ÿåˆ—</span></span></span><br><span class="line"><span class="function"><span class="params">                              ThreadFactory threadFactory, // çº¿ç¨‹å·¥å‚</span></span></span><br><span class="line"><span class="function"><span class="params">                              RejectedExecutionHandler handler)</span> </span>&#123; <span class="comment">// çº¿ç¨‹æ‹’ç»ç­–ç•¥</span></span><br><span class="line">        <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span> ||</span><br><span class="line">            maximumPoolSize &lt;= <span class="number">0</span> ||</span><br><span class="line">            maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">            keepAliveTime &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">if</span> (workQueue == <span class="keyword">null</span> || threadFactory == <span class="keyword">null</span> || handler == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">this</span>.acc = System.getSecurityManager() == <span class="keyword">null</span> ?</span><br><span class="line">                <span class="keyword">null</span> :</span><br><span class="line">                AccessController.getContext();</span><br><span class="line">        <span class="keyword">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">        <span class="keyword">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">        <span class="keyword">this</span>.workQueue = workQueue;</span><br><span class="line">        <span class="keyword">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">        <span class="keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line">        <span class="keyword">this</span>.handler = handler;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çœç•¥ . . .</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>workQueueé˜»å¡é˜Ÿåˆ—<br>ArrayBlockingQueue: æ˜¯ä¸€ä¸ªåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—, æ­¤é˜Ÿåˆ—æŒ‰ FIFO(å…ˆè¿›å…ˆå‡º) åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åº.<br>LinkedBlockingQueue: ä¸€ä¸ªåŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—,æ­¤é˜Ÿåˆ—æŒ‰ FIFO(å…ˆè¿›å…ˆå‡º) æ’åºå…ƒç´ , ååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueue. é™æ€å·¥å‚æ–¹æ³•Executors.newFixedThreadPool()ä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—<br>SynchronousQueue: ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—. æ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œ, å¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€, ååé‡é€šå¸¸è¦é«˜äºLinkedBlockingQueue, é™æ€å·¥å‚æ–¹æ³•Executors.newCachedThreadPoolä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—.<br>PriorityBlockingQueue: ä¸€ä¸ªå…·æœ‰ä¼˜å…ˆçº§çš„æ— é™é˜»å¡é˜Ÿåˆ—.</li></ol><p>2.threadFactoryçº¿ç¨‹å·¥å‚<br>å¯ä»¥ä½¿ç”¨é»˜è®¤çš„å·¥å‚ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å·¥å‚, æˆ–è€…ä½¿ç”¨ google guava æä¾›çš„å·¥å‚, å¯ä»¥ä¸ºçº¿ç¨‹å‘½åå’Œè®¾ç½®æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// é»˜è®¤å·¥å‚</span><br><span class="line">ThreadFactory threadFactory = Executors.defaultThreadFactory();</span><br><span class="line">// google guavaå·¥å…·æä¾›</span><br><span class="line">ThreadFactory namedThreadFactory = new ThreadFactoryBuilder().setNameFormat(<span class="string">&quot;demo-pool-%d&quot;</span>).build();</span><br></pre></td></tr></table></figure><p>3.handlerçº¿ç¨‹æ‹’ç»ç­–ç•¥<br>å½“çº¿ç¨‹æ± è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°, å¹¶ä¸”é˜Ÿåˆ—æ»¡äº†, æ–°çš„çº¿ç¨‹è¦é‡‡å–çš„å¤„ç†ç­–ç•¥.<br>1.AbortPolicy æ‹’ç»æ–°ä»»åŠ¡å¹¶æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸<br>2.CallerRunsPolicy ç›´æ¥åœ¨è°ƒç”¨ç¨‹åºçš„çº¿ç¨‹ä¸­è¿è¡Œ<br>3.DiscardOldestPolicy æ”¾å¼ƒæœ€æ—©çš„ä»»åŠ¡, å³é˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡<br>4.DiscardPolicy ä¸¢å¼ƒ, ä¸å¤„ç†</p><h3 id="Executorsåˆå§‹åŒ–çº¿ç¨‹æ± çš„å››ç§æ–¹å¼"><a href="#Executorsåˆå§‹åŒ–çº¿ç¨‹æ± çš„å››ç§æ–¹å¼" class="headerlink" title="Executorsåˆå§‹åŒ–çº¿ç¨‹æ± çš„å››ç§æ–¹å¼"></a>Executorsåˆå§‹åŒ–çº¿ç¨‹æ± çš„å››ç§æ–¹å¼</h3><p>è¿™å››ç§åˆå§‹åŒ–çº¿ç¨‹æ± çš„æ–¹å¼, å‰ä¸‰ç§éƒ½æ˜¯è°ƒç”¨ ThreadPoolExecutor ç±»çš„æ„é€ åˆ›å»ºçš„çº¿ç¨‹æ± , åªä¸è¿‡ä½¿ç”¨çš„é˜»å¡é˜Ÿåˆ—æ–¹å¼ä¸åŒ.</p><ol><li>newFixedThreadPool()</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Executors</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å›ºå®šçº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment">     * æ ¸å¿ƒçº¿ç¨‹æ•° = æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="comment">     * è¶…æ—¶æ—¶é—´ä¸º0</span></span><br><span class="line"><span class="comment">     * LinkedBlockingQueueæ— ç•Œé˜Ÿåˆ—, ä¼šæŒç»­ç­‰å¾…</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨é»˜è®¤æ‹’ç»ç­–ç•¥ AbortPolicy</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                      <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>newCachedThreadPool()</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Executors</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ— ç•Œçº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment">     * æ ¸å¿ƒçº¿ç¨‹æ•°0 æœ€å¤§çº¿ç¨‹æ•° (2Â³Â¹ -1)</span></span><br><span class="line"><span class="comment">     * è¶…æ—¶æ—¶é—´ 60ç§’</span></span><br><span class="line"><span class="comment">     * SynchronousQueueä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     * çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡60ç§’, ä¼šè‡ªåŠ¨é‡Šæ”¾èµ„æº, æäº¤ä»»åŠ¡å¦‚æœæ²¡æœ‰ç©ºé—²çº¿ç¨‹, åˆ™ä¼šåˆ›å»ºæ–°çº¿ç¨‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                         <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                         <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.newSingleThreadExecutor()</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Executors</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºåªæœ‰ 1ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment">     * å¦‚æœçº¿ç¨‹å¼‚å¸¸, åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newSingleThreadExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FinalizableDelegatedExecutorService</span><br><span class="line">            (<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                    <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                    <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4.newSingleThreadExecutor()</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Executors</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ScheduledThreadPoolExecutor ç»§æ‰¿ ThreadPoolExecutor ç±»</span></span><br><span class="line"><span class="comment">     * å¯ä»¥åœ¨æŒ‡å®šæ—¶é—´å‘¨æœŸå†…æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">newScheduledThreadPool</span><span class="params">(<span class="keyword">int</span> corePoolSize)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> ScheduledThreadPoolExecutor(corePoolSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h3><h4 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractExecutorService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ctx ä¸ºåŸå­ç±»å‹çš„å˜é‡, æœ‰ä¸¤ä¸ªæ¦‚å¿µ</span></span><br><span class="line"><span class="comment">    * workerCount, è¡¨ç¤ºæœ‰æ•ˆçš„çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="comment">    * runState, è¡¨ç¤ºçº¿ç¨‹çŠ¶æ€, æ˜¯å¦æ­£åœ¨è¿è¡Œ, å…³é—­ç­‰</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line">    <span class="comment">// 29</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT_BITS = Integer.SIZE - <span class="number">3</span>;</span><br><span class="line">    <span class="comment">// å®¹é‡ 2Â²â¹-1</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAPACITY   = (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// runState is stored in the high-order bits çº¿ç¨‹æ± çš„äº”ä¸­çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// å³é«˜3ä½ä¸º111, æ¥å—æ–°ä»»åŠ¡å¹¶å¤„ç†æ’é˜Ÿä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING    = -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="comment">// å³é«˜3ä½ä¸º000, ä¸æ¥å—æ–°ä»»åŠ¡, ä½†å¤„ç†æ’é˜Ÿä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHUTDOWN   =  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="comment">// å³é«˜3ä½ä¸º001, ä¸æ¥å—æ–°ä»»åŠ¡, ä¸å¤„ç†æ’é˜Ÿä»»åŠ¡, å¹¶ä¸­æ–­æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP       =  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="comment">// å³é«˜3ä½ä¸º010, æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»ˆæ­¢, å·¥ä½œçº¿ç¨‹ä¸º0, çº¿ç¨‹è½¬æ¢åˆ°çŠ¶æ€TIDYING, å°†è¿è¡Œterminate()é’©å­æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIDYING    =  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="comment">// å³é«˜3ä½ä¸º011, æ ‡è¯†terminateï¼ˆï¼‰å·²ç»å®Œæˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TERMINATED =  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="comment">// Packing and unpacking ctl ç”¨æ¥è®¡ç®—çº¿ç¨‹çš„æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">runStateOf</span><span class="params">(<span class="keyword">int</span> c)</span>     </span>&#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">workerCountOf</span><span class="params">(<span class="keyword">int</span> c)</span>  </span>&#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ctlOf</span><span class="params">(<span class="keyword">int</span> rs, <span class="keyword">int</span> wc)</span> </span>&#123; <span class="keyword">return</span> rs | wc; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="executeæ–¹æ³•"><a href="#executeæ–¹æ³•" class="headerlink" title="executeæ–¹æ³•"></a>executeæ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractExecutorService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç©ºåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (command == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="comment">// è®¡ç®—å·¥ä½œçº¿ç¨‹æ•° å¹¶åˆ¤æ–­æ˜¯å¦å°äºæ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">            <span class="comment">// addWorkeræäº¤ä»»åŠ¡, æäº¤æˆåŠŸåˆ™ç»“æŸ</span></span><br><span class="line">            <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            <span class="comment">// æäº¤å¤±è´¥å†æ¬¡è·å–å½“å‰çŠ¶æ€</span></span><br><span class="line">            c = ctl.get();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­çº¿ç¨‹çŠ¶æ€, å¹¶æ’å…¥é˜Ÿåˆ—, å¤±è´¥åˆ™ç§»é™¤</span></span><br><span class="line">        <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">            <span class="comment">// å†æ¬¡è·å–çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">int</span> recheck = ctl.get();</span><br><span class="line">            <span class="comment">// å¦‚æœçŠ¶æ€ä¸æ˜¯RUNNING, å¹¶ç§»é™¤å¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">                <span class="comment">// è°ƒç”¨æ‹’ç»ç­–ç•¥</span></span><br><span class="line">                reject(command);</span><br><span class="line">            <span class="comment">// å¦‚æœå·¥ä½œçº¿ç¨‹ä¸º0 åˆ™è°ƒç”¨ addWorker</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">                addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æäº¤ä»»åŠ¡å¤±è´¥ èµ°æ‹’ç»ç­–ç•¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</span><br><span class="line">            reject(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="addWorkeræ–¹æ³•"><a href="#addWorkeræ–¹æ³•" class="headerlink" title="addWorkeræ–¹æ³•"></a>addWorkeræ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractExecutorService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å¯ä»¥æäº¤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</span><br><span class="line">        retry:</span><br><span class="line">        <span class="comment">// å¤–å±‚å¾ªç¯</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">            <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if queue empty only if necessary. æ£€æŸ¥çº¿ç¨‹æ± æ˜¯å¦å…³é—­</span></span><br><span class="line">            <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">                ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">                   firstTask == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                   ! workQueue.isEmpty()))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// å†…å±‚å¾ªç¯</span></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line">                <span class="comment">// å·¥ä½œçº¿ç¨‹å¤§äºå®¹é‡ æˆ–è€…å¤§äº æ ¸å¿ƒæˆ–æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line">                <span class="keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">                    wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// CAS çº¿ç¨‹æ•°å¢åŠ , æˆåŠŸåˆ™è°ƒåˆ°å¤–å±‚å¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                    <span class="keyword">break</span> retry;</span><br><span class="line">                <span class="comment">// å¤±è´¥åˆ™å†æ¬¡è·å–çº¿ç¨‹çŠ¶æ€</span></span><br><span class="line">                c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">                <span class="comment">// ä¸ç›¸ç­‰åˆ™é‡æ–°èµ°å¤–å±‚å¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                    <span class="keyword">continue</span> retry;</span><br><span class="line">                <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * åˆ›å»ºæ–°worker å¼€å§‹æ–°çº¿ç¨‹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</span><br><span class="line">        Worker w = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            w = <span class="keyword">new</span> Worker(firstTask);</span><br><span class="line">            <span class="keyword">final</span> Thread t = w.thread;</span><br><span class="line">            <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">                <span class="comment">// åŠ é”</span></span><br><span class="line">                mainLock.lock();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Recheck while holding lock.</span></span><br><span class="line">                    <span class="comment">// Back out on ThreadFactory failure or if</span></span><br><span class="line">                    <span class="comment">// shut down before lock acquired.</span></span><br><span class="line">                    <span class="keyword">int</span> rs = runStateOf(ctl.get());</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                        (rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                        <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å­˜æ´», å·²å­˜æ´»æŠ›å‡ºéæ³•å¼‚å¸¸</span></span><br><span class="line">                        <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line">                        <span class="comment">//  è®¾ç½®åŒ…å«æ± ä¸­çš„æ‰€æœ‰å·¥ä½œçº¿ç¨‹ã€‚ä»…åœ¨æŒæœ‰mainLockæ—¶è®¿é—® workersæ˜¯ HashSet é›†åˆ</span></span><br><span class="line">                        <span class="comment">//  private final HashSet&lt;Worker&gt; workers = new HashSet&lt;Worker&gt;();</span></span><br><span class="line">                        workers.add(w);</span><br><span class="line">                        <span class="keyword">int</span> s = workers.size();</span><br><span class="line">                        <span class="comment">// è®¾ç½®æ± æœ€å¤§å¤§å°, å¹¶å°† workerAddedè®¾ç½®ä¸º true</span></span><br><span class="line">                        <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                            largestPoolSize = s;</span><br><span class="line">                        workerAdded = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// è§£é”</span></span><br><span class="line">                    mainLock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ·»åŠ æˆåŠŸ å¼€å§‹å¯åŠ¨çº¿ç¨‹ å¹¶å°† workerStarted è®¾ç½®ä¸º true</span></span><br><span class="line">                <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                    t.start();</span><br><span class="line">                    workerStarted = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// å¯åŠ¨çº¿ç¨‹å¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">                addWorkerFailed(w);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> workerStarted;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯åŠ¨çº¿ç¨‹å¤±è´¥, åŠ é”</span></span><br><span class="line"><span class="comment">     * ç§»é™¤çº¿ç¨‹, å¹¶å‡å°‘çº¿ç¨‹æ€»æ•°</span></span><br><span class="line"><span class="comment">     * è½¬æ¢çŠ¶æ€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addWorkerFailed</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (w != <span class="keyword">null</span>)</span><br><span class="line">                workers.remove(w);</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            tryTerminate();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å¹¶å‘å’Œé” </category>
          
      </categories>
      
      
        <tags>
            
            <tag> çº¿ç¨‹æ±  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤šçº¿ç¨‹ç›¸å…³</title>
      <link href="2018/09/04/multithreaded-correlation.html"/>
      <url>2018/09/04/multithreaded-correlation.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="å¤šçº¿ç¨‹"><a href="#å¤šçº¿ç¨‹" class="headerlink" title="å¤šçº¿ç¨‹"></a>å¤šçº¿ç¨‹</h3><p>å¤šä¸ªçº¿ç¨‹åŒæ—¶æˆ–äº¤æ›¿è¿è¡Œ, å•æ ¸CPUä¸ºé¡ºåºæ‰§è¡Œ(äº¤æ›¿æ‰§è¡Œ), å¤šæ ¸æƒ…å†µä¸‹, æ¯ä¸ªCPUæœ‰è‡ªå·±çš„è¿ç®—å™¨, æ‰€ä»¥åœ¨å¤šä¸ªCPUä¸­å¯ä»¥åŒæ—¶è¿è¡Œ.</p><a id="more"></a><h3 id="åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼"><a href="#åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼" class="headerlink" title="åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼"></a>åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼</h3><p>1.ç»§æ‰¿Thread</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.run();</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MyThread myThread = <span class="keyword">new</span> MyThread();</span><br><span class="line">        myThread.setName(<span class="string">&quot;æµ‹è¯•&quot;</span>);</span><br><span class="line">        myThread.start();</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¼€å§‹çº¿ç¨‹, å¯ä»¥çœ‹å‡ºmainçº¿ç¨‹å’Œæµ‹è¯•çº¿ç¨‹æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„çº¿ç¨‹<br>è°ƒç”¨myThread.run();æ–¹æ³•ç›¸å½“äºç›´æ¥åœ¨ä¸»çº¿ç¨‹è¿è¡Œrunæ–¹æ³•, è€Œä¸æ˜¯å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹å»æ‰§è¡Œ</p><p>2.å®ç°Runnableæ¥å£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRunable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MyRunable runable = <span class="keyword">new</span> MyRunable();</span><br><span class="line"></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(runable);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.ä½¿ç”¨çº¿ç¨‹æ± <br>3.1 å¯ä»¥åœ¨springä¸­é…ç½®ç›¸å…³çº¿ç¨‹æ± , ä½¿ç”¨æ—¶ä»å®¹å™¨å–å‡ºå³å¯, ä¹Ÿå¯ä»¥è‡ªå·±å£°æ˜çº¿ç¨‹æ± </p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;threadPool&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé»˜è®¤ä¸º1 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;corePoolSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æœ€å¤§çº¿ç¨‹æ•°ï¼Œé»˜è®¤ä¸ºInteger.MAX_VALUE --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxPoolSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- é˜Ÿåˆ—æœ€å¤§é•¿åº¦ï¼Œä¸€èˆ¬éœ€è¦è®¾ç½®å€¼&gt;=notifyScheduledMainExecutor.maxNumï¼›é»˜è®¤ä¸ºInteger.MAX_VALUE</span></span><br><span class="line"><span class="comment">    &lt;property name=&quot;queueCapacity&quot; value=&quot;1000&quot; /&gt; --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- çº¿ç¨‹æ± ç»´æŠ¤çº¿ç¨‹æ‰€å…è®¸çš„ç©ºé—²æ—¶é—´ï¼Œé»˜è®¤ä¸º60s --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;keepAliveSeconds&quot;</span> <span class="attr">value</span>=<span class="string">&quot;300&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- é˜Ÿåˆ—æœ€å¤§é•¿åº¦ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;queueCapacity&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2000&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- çº¿ç¨‹æ± å¯¹æ‹’ç»ä»»åŠ¡ï¼ˆæ— çº¿ç¨‹å¯ç”¨ï¼‰çš„å¤„ç†ç­–ç•¥ï¼Œç›®å‰åªæ”¯æŒAbortPolicyã€CallerRunsPolicyï¼›é»˜è®¤ä¸ºåè€… --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;rejectedExecutionHandler&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- AbortPolicy:ç›´æ¥æŠ›å‡ºjava.utils.concurrent.RejectedExecutionExceptionå¼‚å¸¸ --&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- CallerRunsPolicy:ä¸»çº¿ç¨‹ç›´æ¥æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œä¹‹åå°è¯•æ·»åŠ ä¸‹ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­ï¼Œå¯ä»¥æœ‰æ•ˆé™ä½å‘çº¿ç¨‹æ± å†…æ·»åŠ ä»»åŠ¡çš„é€Ÿåº¦ --&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- DiscardOldestPolicy:æŠ›å¼ƒæ—§çš„ä»»åŠ¡ã€æš‚ä¸æ”¯æŒï¼›ä¼šå¯¼è‡´è¢«ä¸¢å¼ƒçš„ä»»åŠ¡æ— æ³•å†æ¬¡è¢«æ‰§è¡Œ --&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- DiscardPolicy:æŠ›å¼ƒå½“å‰ä»»åŠ¡ã€æš‚ä¸æ”¯æŒï¼›ä¼šå¯¼è‡´è¢«ä¸¢å¼ƒçš„ä»»åŠ¡æ— æ³•å†æ¬¡è¢«æ‰§è¡Œ --&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3.2 Executors åˆ›å»ºçº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService threadPool = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            threadPool.execute(<span class="keyword">new</span> MyRunable());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± æ—¶, å¦‚æœIDEAå®‰è£…é˜¿é‡Œ P3C æ’ä»¶åä¼šæŠ¥é”™æç¤ºä»¥ä¸‹å†…å®¹, å»ºè®®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©ã€‚</span><br><span class="line">è¯´æ˜ï¼š Executors è¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š</span><br><span class="line">1ï¼‰ FixedThreadPool å’Œ SingleThreadPool:</span><br><span class="line">å…è®¸çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸º Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚</span><br><span class="line">2ï¼‰ CachedThreadPool å’Œ ScheduledThreadPool:</span><br><span class="line">å…è®¸çš„åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸º Integer.MAX_VALUEï¼Œ å¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚</span><br></pre></td></tr></table></figure><p>å»ºè®®ä½¿ç”¨å¦‚ä¸‹æ–¹å¼:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å®šæ—¶ä»»åŠ¡ å»ºè®®ä¸ºçº¿ç¨‹èµ·å</span></span><br><span class="line">        ScheduledExecutorService executorService = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">3</span>,</span><br><span class="line">                <span class="keyword">new</span> BasicThreadFactory.Builder().namingPattern(<span class="string">&quot;example-schedule-pool-%d&quot;</span>).build());</span><br><span class="line">            executorService.scheduleAtFixedRate(<span class="keyword">new</span> MyRunable(), <span class="number">0</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// çº¿ç¨‹å·¥å‚</span></span><br><span class="line">        ThreadFactory namedThreadFactory = <span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">                .setNameFormat(<span class="string">&quot;demo-pool-%d&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Common Thread Pool</span></span><br><span class="line">        ExecutorService pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">5</span>, <span class="number">20</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">1024</span>), namedThreadFactory, <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line"></span><br><span class="line">        pool.execute(()-&gt; System.out.println(Thread.currentThread().getName()));</span><br><span class="line">        pool.shutdown();<span class="comment">//gracefully shutdown</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="çº¿ç¨‹ä¼˜å…ˆçº§"><a href="#çº¿ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="çº¿ç¨‹ä¼˜å…ˆçº§"></a>çº¿ç¨‹ä¼˜å…ˆçº§</h3><p>1.myThread.setPriority(1);è®¾ç½®ä¼˜å…ˆçº§<br>2.ä¼˜å…ˆçº§ä»ä½åˆ°é«˜ä¸º 1-10, Threadç±»æä¾› Thread.MIN_PRIORITY=1, Thread.NORM_PRIORITY=5, Thread.MAX_PRIORITY=10<br>3.é»˜è®¤ä¼˜å…ˆçº§ä¸º 5 å³ NORM_PRIORITY<br>4.ä¼˜å…ˆçº§é«˜çš„ä»…ä»£è¡¨è·å–è¿›å…¥è¿è¡Œæœºä¼šçš„å‡ ç‡å¤§, å¹¶ä¸ä»£è¡¨ä¸€å®šä¼šæ¯”ä¼˜å…ˆçº§ä½çš„å…ˆæ‰§è¡Œ</p><h3 id="sleep-å’Œwait"><a href="#sleep-å’Œwait" class="headerlink" title="sleep()å’Œwait()"></a>sleep()å’Œwait()</h3><p>1.sleep()çº¿ç¨‹æœªé‡Šæ”¾é”, æ—¶é—´ç»“æŸåçº¿ç¨‹ç»§ç»­æ‰§è¡Œ<br>2.waitçº¿ç¨‹é‡Šæ”¾é”, éœ€è¦ä½¿ç”¨notifyæˆ–notifyAll<br>3.waitå¸¸ç”¨äºçº¿ç¨‹ä¹‹é—´çš„äº¤äº’</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.tool.alternate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * äº¤æ›¿æ‰“å°å¥‡å¶æ•°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/9/4 18:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlternateNum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Num num = <span class="keyword">new</span> Num();</span><br><span class="line"></span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Odd(num));</span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Even(num));</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Num</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> anInt = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Odd</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Num num;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Odd</span><span class="params">(Num num)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.num = num;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (num.anInt &lt; <span class="number">1000</span>) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨åŒä¸€æŠŠé”</span></span><br><span class="line">            <span class="keyword">synchronized</span> (num) &#123;</span><br><span class="line">                <span class="keyword">if</span> (num.flag) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;å¥‡æ•° -&gt; &quot;</span> + num.anInt);</span><br><span class="line">                    num.anInt++;</span><br><span class="line">                    num.flag = <span class="keyword">false</span>;</span><br><span class="line">                    num.notify();</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        num.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Even</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Num num;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Even</span><span class="params">(Num num)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.num = num;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (num.anInt &lt; <span class="number">1000</span>) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨åŒä¸€æŠŠé”</span></span><br><span class="line">            <span class="keyword">synchronized</span> (num) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!num.flag) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;å¶æ•° -&gt; &quot;</span> + num.anInt);</span><br><span class="line">                    num.anInt++;</span><br><span class="line">                    num.flag = <span class="keyword">true</span>;</span><br><span class="line">                    num.notify();</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        num.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å¹¶å‘å’Œé” </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¤šçº¿ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åå°„å’Œåºåˆ—åŒ–ç ´è§£å•ä¾‹</title>
      <link href="2018/08/27/reflection-and-serialization-cracking-singleton.html"/>
      <url>2018/08/27/reflection-and-serialization-cracking-singleton.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>ä¸»è¦ä»‹ç»é€šè¿‡åå°„çš„æ–¹å¼è·å–å•ä¾‹å¯¹è±¡, éªŒè¯<a href="https://liuzhihangs.github.io/2018/02/21/lazy-singleton-mode-thread-safe.html">å•ä¾‹æ¨¡å¼</a>çš„å®‰å…¨æ€§.<br>ä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦æ¥ä»‹ç»åå°„ä¸‹çš„å•ä¾‹<br>é¥¿æ±‰å¼<br>åŒé‡é”æ£€æŸ¥<br><a href="https://liuzhihangs.github.io/2018/08/17/use-enumeration-to-implement-a-singleton.html">æšä¸¾å•ä¾‹</a></p><a id="more"></a><h3 id="é¥¿æ±‰å¼"><a href="#é¥¿æ±‰å¼" class="headerlink" title="é¥¿æ±‰å¼"></a>é¥¿æ±‰å¼</h3><p><a href="https://github.com/liuzhihang/demo_design_pattern/blob/master/src/main/java/com/liuzhihang/demo/singleton/HungerPattern.java">é¥¿æ±‰å¼</a>ç›´æ¥ä½¿ç”¨åå°„å³å¯ç ´è§£å•ä¾‹æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HungerPattern hungerPattern = HungerPattern.getHungerPattern();</span><br><span class="line"></span><br><span class="line">            Class&lt;HungerPattern&gt; hungerPatternClass = HungerPattern.class;</span><br><span class="line"></span><br><span class="line">            Constructor&lt;HungerPattern&gt; conA = hungerPatternClass.getDeclaredConstructor();</span><br><span class="line">            Constructor&lt;HungerPattern&gt; conB = hungerPatternClass.getDeclaredConstructor();</span><br><span class="line"></span><br><span class="line">            conA.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            conB.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            HungerPattern instanceA = conA.newInstance();</span><br><span class="line">            HungerPattern instanceB = conB.newInstance();</span><br><span class="line">            <span class="comment">// instanceA å’Œ instanceB ä¸æ˜¯åŒä¸€å¯¹è±¡</span></span><br><span class="line">            System.out.println(hungerPattern.hashCode());</span><br><span class="line">            System.out.println(instanceA.hashCode());</span><br><span class="line">            System.out.println(instanceB.hashCode());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\jdk1.8\bin\java.exe . . .</span><br><span class="line">713338599</span><br><span class="line">168423058</span><br><span class="line">821270929</span><br><span class="line"></span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="åŒé‡é”æ£€æŸ¥"><a href="#åŒé‡é”æ£€æŸ¥" class="headerlink" title="åŒé‡é”æ£€æŸ¥"></a>åŒé‡é”æ£€æŸ¥</h3><p><a href="https://github.com/liuzhihang/demo_design_pattern/blob/master/src/main/java/com/liuzhihang/demo/singleton/DoubleCheckLockLazyPattern.java">åŒé‡é”æ£€æŸ¥</a>åŒæ ·å­˜åœ¨ç›¸åŒçš„æƒ…å†µ</p><ol><li>ç›´æ¥ä½¿ç”¨<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DoubleCheckLockLazyPattern pattern = DoubleCheckLockLazyPattern.getDoubleCheckLockLazyPattern();</span><br><span class="line"></span><br><span class="line">            Class&lt;DoubleCheckLockLazyPattern&gt; patternClass = DoubleCheckLockLazyPattern.class;</span><br><span class="line"></span><br><span class="line">            Constructor&lt;DoubleCheckLockLazyPattern&gt; conA = patternClass.getDeclaredConstructor();</span><br><span class="line">            Constructor&lt;DoubleCheckLockLazyPattern&gt; conB = patternClass.getDeclaredConstructor();</span><br><span class="line"></span><br><span class="line">            conA.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            conB.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            DoubleCheckLockLazyPattern patternA = conA.newInstance();</span><br><span class="line">            DoubleCheckLockLazyPattern patternB = conA.newInstance();</span><br><span class="line"></span><br><span class="line">            System.out.println(pattern.hashCode());</span><br><span class="line">            System.out.println(patternA.hashCode());</span><br><span class="line">            System.out.println(patternB.hashCode());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><p>è¾“å‡ºç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\jdk1.8\bin\java.exe . . .</span><br><span class="line">713338599</span><br><span class="line">168423058</span><br><span class="line">821270929</span><br><span class="line"></span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br></pre></td></tr></table></figure><ol start="2"><li>åœ¨åŒé‡é”æ£€æŸ¥ç§æœ‰æ„é€ å†…åŠ å…¥å¼‚å¸¸</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">public class DoubleCheckLockLazyPattern &#123;</span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="title">DoubleCheckLockLazyPattern</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">        // åŠ å…¥å¼‚å¸¸åˆ¤æ–­, é˜²æ­¢åå°„</span><br><span class="line">        <span class="keyword">if</span> (doubleCheckLockLazyPattern != null) &#123;</span><br><span class="line">            throw new RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static volatile DoubleCheckLockLazyPattern doubleCheckLockLazyPattern = null;</span><br><span class="line"></span><br><span class="line">    public static DoubleCheckLockLazyPattern <span class="function"><span class="title">getDoubleCheckLockLazyPattern</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            <span class="keyword">if</span> (doubleCheckLockLazyPattern == null) &#123;</span><br><span class="line">                // ä¸€ç³»åˆ—æ“ä½œ</span><br><span class="line">                Thread.sleep(100);</span><br><span class="line">                synchronized (DoubleCheckLockLazyPattern.class) &#123;</span><br><span class="line">                    // äºŒæ¬¡æ£€æŸ¥</span><br><span class="line">                    <span class="keyword">if</span> (doubleCheckLockLazyPattern == null) &#123;</span><br><span class="line">                        doubleCheckLockLazyPattern = new DoubleCheckLockLazyPattern();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> doubleCheckLockLazyPattern;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\jdk1.8\bin\java.exe . . .</span><br><span class="line">java.lang.reflect.InvocationTargetException</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</span><br><span class="line">at com.liuzhihang.demo.singleton.ReflectTest.main(ReflectTest.java:24)</span><br><span class="line">Caused by: java.lang.RuntimeException</span><br><span class="line">at com.liuzhihang.demo.singleton.DoubleCheckLockLazyPattern.&lt;init&gt;(DoubleCheckLockLazyPattern.java:15)</span><br><span class="line">... 5 more</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="3"><li>é€šè¿‡åºåˆ—åŒ–ååºåˆ—åŒ–è·å–å¯¹è±¡</li></ol><p>DoubleCheckLockLazyPattern å®ç°åºåˆ—åŒ–</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">public class ReflectTest &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            DoubleCheckLockLazyPattern pattern = DoubleCheckLockLazyPattern.getDoubleCheckLockLazyPattern();</span><br><span class="line"></span><br><span class="line">            FileOutputStream fos= new FileOutputStream(<span class="string">&quot;C:/Users/liuzhihang/desktop/pattern.txt&quot;</span>);</span><br><span class="line">            ObjectOutputStream oos = new ObjectOutputStream(fos);</span><br><span class="line">            oos.writeObject(pattern);</span><br><span class="line">            oos.close();</span><br><span class="line">            fos.close();</span><br><span class="line">            ObjectInputStream oisA = new ObjectInputStream(new FileInputStream(<span class="string">&quot;C:/Users/liuzhihang/desktop/pattern.txt&quot;</span>));</span><br><span class="line">            DoubleCheckLockLazyPattern patternA= (DoubleCheckLockLazyPattern) oisA.readObject();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream oisB = new ObjectInputStream(new FileInputStream(<span class="string">&quot;C:/Users/liuzhihang/desktop/pattern.txt&quot;</span>));</span><br><span class="line">            DoubleCheckLockLazyPattern patternB= (DoubleCheckLockLazyPattern) oisB.readObject();</span><br><span class="line"></span><br><span class="line">            System.out.println(pattern.hashCode());</span><br><span class="line">            System.out.println(patternA.hashCode());</span><br><span class="line">            System.out.println(patternB.hashCode());</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\jdk1.8\bin\java.exe . . .</span><br><span class="line">258952499</span><br><span class="line">1702297201</span><br><span class="line">1996181658</span><br><span class="line"></span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br></pre></td></tr></table></figure><ol start="4"><li>ä¿®æ”¹ååºåˆ—åŒ–æ–¹æ³•, å¯ä»¥é˜²æ­¢ååºåˆ—åŒ–</li></ol><p>æ·»åŠ ä»¥ä¸‹æ–¹æ³•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">private Object <span class="function"><span class="title">readResolve</span></span>() &#123;</span><br><span class="line">    <span class="built_in">return</span> doubleCheckLockLazyPattern;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\jdk1.8\bin\java.exe . . .</span><br><span class="line">258952499</span><br><span class="line">258952499</span><br><span class="line">258952499</span><br><span class="line"></span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br></pre></td></tr></table></figure><h3 id="æšä¸¾å•ä¾‹"><a href="#æšä¸¾å•ä¾‹" class="headerlink" title="æšä¸¾å•ä¾‹"></a>æšä¸¾å•ä¾‹</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">SingletonEnum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•ä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Resource resource;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    SingletonEnum() &#123;</span><br><span class="line">        <span class="keyword">this</span>.resource = <span class="keyword">new</span> Resource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resource <span class="title">getResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="æšä¸¾å•ä¾‹åˆ†æ"><a href="#æšä¸¾å•ä¾‹åˆ†æ" class="headerlink" title="æšä¸¾å•ä¾‹åˆ†æ"></a>æšä¸¾å•ä¾‹åˆ†æ</h4><p>åœ¨æšä¸¾åå°„è·å–å¯¹è±¡æ—¶æŠ›å‡ºå¼‚å¸¸, é€šè¿‡ Constructorç±» æºç å¯ä»¥çœ‹å‡º, åœ¨åå°„åˆ›å»ºå¯¹è±¡æ—¶ä¼šåˆ¤æ–­æ˜¯å¦æ˜¯æšä¸¾ä¿®é¥°, æ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">@CallerSensitive</span><br><span class="line">  public T newInstance(Object ... initargs)</span><br><span class="line">      throws InstantiationException, IllegalAccessException,</span><br><span class="line">             IllegalArgumentException, InvocationTargetException</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">if</span> (!override) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!Reflection.quickCheckMemberAccess(clazz, modifiers)) &#123;</span><br><span class="line">              Class&lt;?&gt; <span class="built_in">caller</span> = Reflection.getCallerClass();</span><br><span class="line">              checkAccess(<span class="built_in">caller</span>, clazz, null, modifiers);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((clazz.getModifiers() &amp; Modifier.ENUM) != 0)</span><br><span class="line">          throw new IllegalArgumentException(<span class="string">&quot;Cannot reflectively create enum objects&quot;</span>);</span><br><span class="line">      ConstructorAccessor ca = constructorAccessor;   // <span class="built_in">read</span> volatile</span><br><span class="line">      <span class="keyword">if</span> (ca == null) &#123;</span><br><span class="line">          ca = acquireConstructorAccessor();</span><br><span class="line">      &#125;</span><br><span class="line">      @SuppressWarnings(<span class="string">&quot;unchecked&quot;</span>)</span><br><span class="line">      T inst = (T) ca.newInstance(initargs);</span><br><span class="line">      <span class="built_in">return</span> inst;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åŒæ—¶åœ¨çˆ¶ç±» Enumç±» ä¸­é‡å†™äº† readObjectæ–¹æ³•, æ‰€ä»¥æšä¸¾ä¹Ÿå¯ä»¥é¿å…ååºåˆ—åŒ–</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * prevent default deserialization</span><br><span class="line"> */</span><br><span class="line">private void readObject(ObjectInputStream <span class="keyword">in</span>) throws IOException,</span><br><span class="line">    ClassNotFoundException &#123;</span><br><span class="line">    throw new InvalidObjectException(<span class="string">&quot;can&#x27;t deserialize enum&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç å­¦ä¹  </tag>
            
            <tag> åå°„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åå°„</title>
      <link href="2018/08/24/reflection.html"/>
      <url>2018/08/24/reflection.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>javaåå°„å¯ä»¥åœ¨è¿è¡Œæ—¶è·å–å¯¹è±¡çš„æˆå‘˜å’Œå±æ€§, å¹¶ä¸”å¯ä»¥åŠ¨æ€çš„åˆ›å»ºå¯¹è±¡å¹¶è°ƒç”¨å¯¹è±¡çš„å±æ€§.<br>åå°„ä¸€èˆ¬ç¼–ç¨‹ä¸­å¾ˆå°‘ä½¿ç”¨,ä½†æ˜¯åœ¨å¾ˆå¤šæ¡†æ¶ä¸­éƒ½ä½¿ç”¨äº†åå°„, æ¯”å¦‚é…ç½®Springçš„Xmlé…ç½®æ–‡ä»¶ä¸­, å°±ä½¿ç”¨å…¨ç±»åé…ç½®æ–¹å¼, å…¶å®å°±æ˜¯åå°„çš„ä¸€ç§ä½¿ç”¨æ–¹å¼.</p><p>åŒæ—¶åå°„å¯¹å•ä¾‹æ¨¡å¼æœ‰ä¸€å®šçš„å½±å“, å¯ä»¥å‚è€ƒ<a href="https://liuzhihang.com/2018/08/27/reflection-and-serialization-cracking-singleton.html">åå°„è·å–å•ä¾‹å¯¹è±¡</a></p><a id="more"></a><h3 id="è·å–åå°„å¯¹è±¡"><a href="#è·å–åå°„å¯¹è±¡" class="headerlink" title="è·å–åå°„å¯¹è±¡"></a>è·å–åå°„å¯¹è±¡</h3><p>è·å–åå°„Classå¯¹è±¡ä¸€å…±ä¸‰ç§æ–¹å¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// 1. ä½¿ç”¨å®ä¾‹è·å–</span><br><span class="line">User user = new User();</span><br><span class="line">Class&lt;? extends User&gt; aClass = user.getClass();</span><br><span class="line">// 2. ä½¿ç”¨ç±»è·å–</span><br><span class="line">Class&lt;User&gt; userClass = User.class;</span><br><span class="line">// 3. å…¨ç±»åè·å–, å¯èƒ½ä¼šæŠ›å‡º ClassNotFoundException å¼‚å¸¸</span><br><span class="line">Class&lt;?&gt; aClass1 = Class.forName(<span class="string">&quot;com.liuzhihang.tool.reflect.User&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="è·å–å±æ€§"><a href="#è·å–å±æ€§" class="headerlink" title="è·å–å±æ€§"></a>è·å–å±æ€§</h3><ol><li>è·å–å­—æ®µ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// è·å–æ‰€æœ‰å…¬æœ‰å­—æ®µ (public)</span><br><span class="line">Field[] fields = aClass.getFields();</span><br><span class="line">// è·å–æ‰€æœ‰å­—æ®µ (public ç¼ºçœ, protected, private)</span><br><span class="line">Field[] fields = aClass.getDeclaredFields()</span><br><span class="line">// è·å–æŒ‡å®šå…¬å…±å­—æ®µ</span><br><span class="line">Field age = aClass.getField(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">// è·å–æŒ‡å®šå­—æ®µ (public ç¼ºçœ, protected, private)</span><br><span class="line">Field userName = aClass.getDeclaredField(<span class="string">&quot;userName&quot;</span>);</span><br></pre></td></tr></table></figure></li></ol><h3 id="è·å–æ„é€ "><a href="#è·å–æ„é€ " class="headerlink" title="è·å–æ„é€ "></a>è·å–æ„é€ </h3><ol><li>è·å–æ„é€ <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// è·å–æ‰€æœ‰æ„é€  ä¸èƒ½è·å–ç§æœ‰</span><br><span class="line">Constructor&lt;?&gt;[] constructors = aClass.getConstructors();</span><br><span class="line"></span><br><span class="line">// è·å–æŒ‡å®šå‚æ•°ç±»å‹çš„æ„é€  ä¸èƒ½è·å–ç§æœ‰ ç©ºåˆ™è·å–ç©ºå‚æ„é€  getConstructor(Class&lt;?&gt;... parameterTypes)</span><br><span class="line">Constructor&lt;User&gt; constructor = aClass.getConstructor(String.class);</span><br><span class="line"></span><br><span class="line">// è·å–æ‰€æœ‰æ„é€  åŒ…å«ç§æœ‰</span><br><span class="line">Constructor&lt;?&gt;[] declaredConstructors = aClass.getDeclaredConstructors();</span><br><span class="line"></span><br><span class="line">// è·å–æŒ‡å®šå‚æ•°ç±»å‹çš„æ„é€  å¯ä»¥è·å–ç§æœ‰ ç©ºåˆ™è·å–ç©ºå‚æ„é€  getDeclaredConstructor(Class&lt;?&gt;... parameterTypes)</span><br><span class="line">Constructor&lt;User&gt; declaredConstructor = aClass.getDeclaredConstructor(String.class);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>ä½¿ç”¨æ„é€ åˆ›å»ºå¯¹è±¡</li></ol><p>å¯ä»¥é€šè¿‡ constructor.setAccessible(true); æš´åŠ›ç ´è§£å¿½ç•¥è®¿é—®ä¿®é¥°ç¬¦, æ¥ä½¿ç”¨ç§æœ‰æ„é€ å‚æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Constructor&lt;User&gt; constructor = aClass.getDeclaredConstructor(String.class);</span><br><span class="line">// æš´åŠ›ç ´è§£</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">User <span class="built_in">test</span> = constructor.newInstance(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="è·å–æ–¹æ³•"><a href="#è·å–æ–¹æ³•" class="headerlink" title="è·å–æ–¹æ³•"></a>è·å–æ–¹æ³•</h3><ol><li>è·å–æ–¹æ³•<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// è·å–æ‰€æœ‰å…¬å…±æ–¹æ³•(åŒ…å«çˆ¶ç±»)</span><br><span class="line">Method[] methods = aClass.getMethods();</span><br><span class="line">// è·å–æ‰€æœ‰æ–¹æ³•</span><br><span class="line">Method[] methods = aClass.getDeclaredMethods();</span><br><span class="line">// è·å–ç§æœ‰æ–¹æ³• ç¬¬ä¸€ä¸ªå‚æ•°å¡«æ–¹æ³•åç§°</span><br><span class="line">Method address = aClass.getDeclaredMethod(<span class="string">&quot;setAddress&quot;</span>, String.class);</span><br><span class="line">// è·å–å…¬å…±æ–¹æ³•</span><br><span class="line">Method address = aClass.getMethod(<span class="string">&quot;setAddress&quot;</span>, String.class);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>ä½¿ç”¨æ–¹æ³•<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;com.liuzhihang.tool.reflect.User&quot;</span>)</span><br><span class="line"></span><br><span class="line">Method address = aClass.getDeclaredMethod(<span class="string">&quot;setAddress&quot;</span>, String.class);</span><br><span class="line"></span><br><span class="line">User user = aClass.getConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">System.out.println(user.toString());</span><br><span class="line">// è§£é™¤ç§æœ‰é™åˆ¶</span><br><span class="line">address.setAccessible(<span class="literal">true</span>);</span><br><span class="line">// ä½¿ç”¨invokeæ¥è°ƒç”¨æ–¹æ³•</span><br><span class="line">address.invoke(user, <span class="string">&quot;åŒ—äº¬&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(user.toString());</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><h3 id="è·å–å…¶ä»–å±æ€§"><a href="#è·å–å…¶ä»–å±æ€§" class="headerlink" title="è·å–å…¶ä»–å±æ€§"></a>è·å–å…¶ä»–å±æ€§</h3><p>è¿˜å¯ä»¥è·å–ç±»å®ç°çš„æ¥å£, çˆ¶ç±», æ³¨è§£, ä»¥åŠåˆ¤æ–­ç±»çš„ç±»å‹ç­‰å¤šç§ä½¿ç”¨æ–¹å¼.</p>]]></content>
      
      
      <categories>
          
          <category> utils </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åå°„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LinkListç›¸å…³å­¦ä¹ </title>
      <link href="2018/08/23/linklist-related-learning.html"/>
      <url>2018/08/23/linklist-related-learning.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><blockquote><p>LinkListä¹Ÿæ˜¯å·¥ä½œä¸­å¸¸è§çš„é›†åˆ, åº•å±‚ä½¿ç”¨åŒå‘é“¾è¡¨ç»“æ„<br>æ¯”è¾ƒé€‚åˆæ–°å¢å’Œåˆ é™¤, æŸ¥è¯¢å’Œä¿®æ”¹éœ€è¦éå†ç›¸å¯¹<a href="https://liuzhihang.com/2018/08/23/arraylist-related-learning.html">ArrayList</a>æ¯”è¾ƒæ¶ˆè€—æ€§èƒ½</p></blockquote><a id="more"></a><h3 id="å†…éƒ¨ç±»-Node"><a href="#å†…éƒ¨ç±»-Node" class="headerlink" title="å†…éƒ¨ç±» Node"></a>å†…éƒ¨ç±» Node</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// å…ƒç´ å€¼</span></span><br><span class="line">    E item;</span><br><span class="line">    <span class="comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    Node&lt;E&gt; next;</span><br><span class="line">    <span class="comment">// ä¸Šä¸€ä¸ªå‡ ç‚¹</span></span><br><span class="line">    Node&lt;E&gt; prev;</span><br><span class="line">    <span class="comment">// æ„é€ ä¸€ä¸ªæ–°èŠ‚ç‚¹ æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹å’Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.item = element;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">        <span class="keyword">this</span>.prev = prev;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="add-æ–°å¢"><a href="#add-æ–°å¢" class="headerlink" title="add æ–°å¢"></a>add æ–°å¢</h3><p>é€šè¿‡ä»£ç å¯ä»¥çœ‹å‡º, åœ¨æ–°å¢å…ƒç´ æ—¶åªéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ Node, å¹¶å°†åŸå§‹é“¾è¡¨æœ€åä¸€ä¸ªNodeçš„nextæŒ‡å‘æ–°Node</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    linkLast(e);</span><br><span class="line">    <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> * Links e as last element.</span><br><span class="line"> */</span><br><span class="line">void linkLast(E e) &#123;</span><br><span class="line">    // å£°æ˜ l ä¸ºæœ€åä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="line">    final Node&lt;E&gt; l = last;</span><br><span class="line">    // åˆ›å»ºæ–°èŠ‚ç‚¹, æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©º</span><br><span class="line">    final Node&lt;E&gt; newNode = new Node&lt;&gt;(l, e, null);</span><br><span class="line">    // æœ€åä¸€ä¸ªèŠ‚ç‚¹ä¸ºæ–°åˆ›å»ºçš„èŠ‚ç‚¹</span><br><span class="line">    last = newNode;</span><br><span class="line">    // åˆ¤æ–­æ˜¯å¦ä¸ºç¬¬ä¸€ä¸ªå…ƒç´ , å¦åˆ™å°† æ–°åˆ›å»ºçš„ NodeåŠ å…¥é“¾è¡¨</span><br><span class="line">    <span class="keyword">if</span> (l == null)</span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        l.next = newNode;</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="remove-åˆ é™¤"><a href="#remove-åˆ é™¤" class="headerlink" title="remove åˆ é™¤"></a>remove åˆ é™¤</h3><p>1.åˆ é™¤æ“ä½œéœ€è¦éå†é“¾è¡¨æ‰¾åˆ°ç›¸åº”å…ƒç´ , ç„¶åç§»åŠ¨æŒ‡é’ˆå³å¯<br>2.åˆ é™¤é¦–å°¾å…ƒç´ ç›´æ¥ç§»åŠ¨æŒ‡é’ˆå³å¯ removeFirst()/removeLast() æ–¹æ³•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">public boolean remove(Object o) &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == null) &#123;</span><br><span class="line">        // éå†é“¾è¡¨</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != null; x = x.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (x.item == null) &#123;</span><br><span class="line">                unlink(x);</span><br><span class="line">                <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != null; x = x.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (o.equals(x.item)) &#123;</span><br><span class="line">                unlink(x);</span><br><span class="line">                <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * åˆ é™¤å…ƒç´ </span><br><span class="line"> */</span><br><span class="line">E unlink(Node&lt;E&gt; x) &#123;</span><br><span class="line">    // assert x != null;</span><br><span class="line">    final E element = x.item;</span><br><span class="line">    final Node&lt;E&gt; next = x.next;</span><br><span class="line">    final Node&lt;E&gt; prev = x.prev;</span><br><span class="line">    // åˆ¤æ–­ä¸Šä¸€ä¸ªNodeæ˜¯å¦ä¸ºç©º</span><br><span class="line">    <span class="keyword">if</span> (prev == null) &#123;</span><br><span class="line">        // ç©º, è¯¥èŠ‚ç‚¹ä¸ºé“¾è¡¨å¤´, å°†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸ºé“¾è¡¨å¤´</span><br><span class="line">        first = next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        // ä¸ä¸ºç©º, å°†ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„next æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ next, å¹¶å°†å½“å‰èŠ‚ç‚¹çš„ prevç½®ä¸ºç©º</span><br><span class="line">        prev.next = next;</span><br><span class="line">        x.prev = null;</span><br><span class="line">    &#125;</span><br><span class="line">    // åˆ¤æ–­ä¸‹ä¸€ä¸ªNodeæ˜¯å¦ä¸ºç©º</span><br><span class="line">    <span class="keyword">if</span> (next == null) &#123;</span><br><span class="line">        // ç©º, è¯¥èŠ‚ç‚¹ä¸ºé“¾è¡¨å°¾, å°†é“¾è¡¨å°¾è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="line">        last = prev;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        // ä¸ä¸ºç©º, å°†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„prev, è®¾ç½®ä¸ºä¸Šä¸€ä¸ªèŠ‚ç‚¹, å¹¶å°†å½“å‰èŠ‚ç‚¹çš„ nextç½®ä¸ºç©º</span><br><span class="line">        next.prev = prev;</span><br><span class="line">        x.next = null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    x.item = null;</span><br><span class="line">    size--;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="built_in">return</span> element;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="get-set"><a href="#get-set" class="headerlink" title="get/set"></a>get/set</h3><p>get/setæ—¶éƒ½éœ€è¦è·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´ , ä½¿ç”¨äºŒåˆ†æ³•æŸ¥æ‰¾, ç„¶åè¿›è¡Œéå†æŸ¥æ‰¾, æ‰€ä»¥æ­¤å¤„ç›¸è¾ƒäº<a href="https://liuzhihang.com/2018/08/23/arraylist-related-learning.html">ArrayList</a>å¤šäº†éå†æŸ¥è¯¢, è™½ç„¶ä½¿ç”¨äº†äºŒåˆ†æ³•è¿›è¡Œä¼˜åŒ–, ä½†æ˜¯get/setæ“ä½œç›¸æ¯”ArrayListæ¥è¯´æ€§èƒ½è¿˜æ˜¯ç›¸å¯¹è¾ƒå·®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">public E get(int index) &#123;</span><br><span class="line">    // æ ¡éªŒç´¢å¼•</span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    // äºŒåˆ†æ³•éå†æŸ¥æ‰¾èŠ‚ç‚¹</span><br><span class="line">    <span class="built_in">return</span> node(index).item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public E <span class="built_in">set</span>(int index, E element) &#123;</span><br><span class="line">    // æ ¡éªŒç´¢å¼•</span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    // äºŒåˆ†æ³•éå†æŸ¥æ‰¾èŠ‚ç‚¹</span><br><span class="line">    Node&lt;E&gt; x = node(index);</span><br><span class="line">    // ä¿®æ”¹NodeèŠ‚ç‚¹çš„ itemå€¼</span><br><span class="line">    E oldVal = x.item;</span><br><span class="line">    x.item = element;</span><br><span class="line">    <span class="built_in">return</span> oldVal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * è¿”å›æŒ‡å®šç´¢å¼•å¤„énullèŠ‚ç‚¹.</span><br><span class="line"> */</span><br><span class="line">Node&lt;E&gt; node(int index) &#123;</span><br><span class="line">    // assert isElementIndex(index);</span><br><span class="line"></span><br><span class="line">    // åˆ¤æ–­ç´¢å¼•æ˜¯å¦å°äºé•¿åº¦çš„ä¸€åŠ (äºŒåˆ†æ³•) ç„¶åéå†æŸ¥æ‰¾</span><br><span class="line">    <span class="keyword">if</span> (index &lt; (size &gt;&gt; 1)) &#123;</span><br><span class="line">        Node&lt;E&gt; x = first;</span><br><span class="line">        <span class="keyword">for</span> (int i = 0; i &lt; index; i++)</span><br><span class="line">            x = x.next;</span><br><span class="line">        <span class="built_in">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;E&gt; x = last;</span><br><span class="line">        <span class="keyword">for</span> (int i = size - 1; i &gt; index; i--)</span><br><span class="line">            x = x.prev;</span><br><span class="line">        <span class="built_in">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æºç å­¦ä¹  </category>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç å­¦ä¹  </tag>
            
            <tag> LinkList </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ArrayListç›¸å…³å­¦ä¹ </title>
      <link href="2018/08/23/arraylist-related-learning.html"/>
      <url>2018/08/23/arraylist-related-learning.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>ArrayListæ˜¯å·¥ä½œä¸­å¸¸ç”¨çš„é›†åˆ, åŸºäºæ•°ç»„å®ç°, å¯ä»¥æ’å…¥ç©ºæ•°æ®, ä¹Ÿæ”¯æŒéšæœºè®¿é—®.<br>ArrayListæ¯”è¾ƒé€‚åˆ get/setæ“ä½œ, å› ä¸º add/removeéœ€è¦ç§»åŠ¨æ•°æ®, ç›¸å¯¹æ¥è¯´æ¯”è¾ƒæ¶ˆè€—æ€§èƒ½.</p></blockquote><h3 id="é»˜è®¤åˆå§‹é•¿åº¦"><a href="#é»˜è®¤åˆå§‹é•¿åº¦" class="headerlink" title="é»˜è®¤åˆå§‹é•¿åº¦"></a>é»˜è®¤åˆå§‹é•¿åº¦</h3><p>1.é»˜è®¤åˆå§‹é•¿åº¦ä¸º 10<br>2.åº•å±‚ç»“æ„ä¸ºObject[] æ•°ç»„</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">private static final int DEFAULT_CAPACITY = 10;</span><br><span class="line"></span><br><span class="line">private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * æ„é€ ä¸€ä¸ªåˆå§‹å®¹é‡ä¸º10çš„ç©ºåˆ—è¡¨</span><br><span class="line"> */</span><br><span class="line">public <span class="function"><span class="title">ArrayList</span></span>() &#123;</span><br><span class="line">    this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ æ–¹æ³•-add"><a href="#æ·»åŠ æ–¹æ³•-add" class="headerlink" title="æ·»åŠ æ–¹æ³• add()"></a>æ·»åŠ æ–¹æ³• add()</h3><ol><li>å‘æ•°ç»„ä¸­æ·»åŠ å…ƒç´ , æµç¨‹å¦‚ä¸‹</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * å°†æŒ‡å®šçš„å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾.</span><br><span class="line"> */</span><br><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    // æ‰©å®¹</span><br><span class="line">    ensureCapacityInternal(size + 1);  // Increments modCount!!</span><br><span class="line">    // æ·»åŠ å…ƒç´ </span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.æ‰©å®¹è¿‡ç¨‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">transient Object[] elementData;</span><br><span class="line"></span><br><span class="line">// æ‰©å®¹</span><br><span class="line">private void ensureCapacityInternal(int minCapacity) &#123;</span><br><span class="line">    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));</span><br><span class="line">&#125;</span><br><span class="line">// è®¡ç®—å®¹é‡, elementDataä¸ºç©º åˆ™ä½¿ç”¨é»˜è®¤å®¹é‡ 10, æŒ‡å®šå®¹é‡</span><br><span class="line">private static int calculateCapacity(Object[] elementData, int minCapacity) &#123;</span><br><span class="line">    <span class="keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</span><br><span class="line">        <span class="built_in">return</span> Math.max(DEFAULT_CAPACITY, minCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> minCapacity;</span><br><span class="line">&#125;</span><br><span class="line">// ä¿®æ”¹æ¬¡æ•°è‡ªå¢, å¹¶ä¸”å¦‚æœ æ–°çš„é•¿åº¦-åŸé•¿åº¦&gt;0 åˆ™ä½¿ç”¨ grow(minCapacity)æ–¹æ³•è¿›è¡Œæ‰©å®¹</span><br><span class="line">private void ensureExplicitCapacity(int minCapacity) &#123;</span><br><span class="line">    modCount++;</span><br><span class="line"></span><br><span class="line">    // overflow-conscious code</span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; 0)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="3"><li>æ·»åŠ å…ƒç´ èµ‹å€¼<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">elementData[size++] = e;</span><br></pre></td></tr></table></figure></li></ol><h3 id="æ‰©å®¹æµç¨‹-grow-minCapacity"><a href="#æ‰©å®¹æµç¨‹-grow-minCapacity" class="headerlink" title="æ‰©å®¹æµç¨‹ grow(minCapacity)"></a>æ‰©å®¹æµç¨‹ grow(minCapacity)</h3><p>é€šè¿‡æ‰©å®¹æµç¨‹å¯ä»¥çœ‹å‡ºæ‰©å®¹è¿‡ç¨‹ä¸­, æ˜¯å°†åˆ›å»ºä¸€ä¸ªåŸæ•°ç»„1.5å€å¤§å°çš„æ–°æ•°ç»„, åŒæ—¶å°†æ•°ç»„å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„, æ‰€ä»¥ä¸€èˆ¬ä½¿ç”¨ä¸­, å°½é‡æŒ‡å®šæ•°ç»„å¤§å°, ä»è€Œé¿å…æ•°ç»„çš„å¤åˆ¶.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¢åŠ å®¹é‡ç¡®ä¿èƒ½å®¹çº³ minCapacity æ•°é‡çš„å…ƒç´ </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="comment">// è·å–å½“å‰ elementData çš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">    <span class="comment">// è·å–æ–°çš„é•¿åº¦ ä¸ºå½“å‰é•¿åº¦çš„ 1.5å€</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// æ¯”è¾ƒå¹¶äº¤æ¢</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="comment">// é˜²æ­¢è¶…å‡ºæœ€å¤§é•¿åº¦</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    <span class="comment">// minCapacity is usually close to size, so this is a win:</span></span><br><span class="line">    <span class="comment">// æ•°ç»„å¤åˆ¶</span></span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ é™¤-remove-æ–¹æ³•"><a href="#åˆ é™¤-remove-æ–¹æ³•" class="headerlink" title="åˆ é™¤ remove æ–¹æ³•"></a>åˆ é™¤ remove æ–¹æ³•</h3><p>åˆ é™¤è¿‡ç¨‹ä¸­ä½¿ç”¨ System.arraycopy æœ¬åœ°æ–¹æ³•, å¯¹æ•°ç»„è¿›è¡Œå¤åˆ¶, æ‰€ä»¥ ArrayListçš„ æ–°å¢å’Œåˆ é™¤æ–¹æ³•æ€§èƒ½ä¸å¦‚, <a href="https://liuzhihang.com/2018/08/23/linklist-related-learning.html">LinkList</a>, ä½†æ˜¯ getå’Œsetæ–¹æ³•, åˆ™ç›´æ¥æ ¹æ®ç´¢å¼•ä¿®æ”¹æ•°æ®, æ¯”è¾ƒé€‚åˆå¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„æ“ä½œ.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ , åé¢çš„å…ƒç´ å°†å‰ç§»</span><br><span class="line"> */</span><br><span class="line">public E remove(int index) &#123;</span><br><span class="line"></span><br><span class="line">    // æ£€æŸ¥ç´¢å¼• å¦åˆ™æŠ›å‡º IndexOutOfBoundsException(outOfBoundsMsg(index))</span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    // ä¿®æ”¹æ¬¡æ•°è‡ªå¢</span><br><span class="line">    modCount++;</span><br><span class="line">    E oldValue = elementData(index);</span><br><span class="line"></span><br><span class="line">    int numMoved = size - index - 1;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; 0)</span><br><span class="line">        // æ•°ç»„å¤åˆ¶</span><br><span class="line">        System.arraycopy(elementData, index+1, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    elementData[--size] = null; // clear to <span class="built_in">let</span> GC <span class="keyword">do</span> its work</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> oldValue;</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> * åˆ é™¤æŒ‡å®šå…ƒç´ </span><br><span class="line"> */</span><br><span class="line">public boolean remove(Object o) &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == null) &#123;</span><br><span class="line">        <span class="keyword">for</span> (int index = 0; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (elementData[index] == null) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (int index = 0; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (o.equals(elementData[index])) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> * System.arraycopy æ–¹æ³•æ‹·è´ åˆ é™¤</span><br><span class="line"> */</span><br><span class="line">private void fastRemove(int index) &#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    int numMoved = size - index - 1;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; 0)</span><br><span class="line">        System.arraycopy(elementData, index+1, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    elementData[--size] = null; // clear to <span class="built_in">let</span> GC <span class="keyword">do</span> its work</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æºç å­¦ä¹  </category>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç å­¦ä¹  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>@Valueæ³¨å…¥å±æ€§çš„å°bug</title>
      <link href="2018/08/21/value-injects-a-small-bug-in-the-property.html"/>
      <url>2018/08/21/value-injects-a-small-bug-in-the-property.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="Valueæ³¨å…¥å±æ€§"><a href="#Valueæ³¨å…¥å±æ€§" class="headerlink" title="@Valueæ³¨å…¥å±æ€§"></a>@Valueæ³¨å…¥å±æ€§</h4><p>å·¥ä½œä¸­ä¸€äº›å…¬å…±å±æ€§, ä¸€èˆ¬é€šè¿‡@Valueæ³¨å…¥çš„å¯¹è±¡çš„å±æ€§ä¸­, ä½¿ç”¨æ–¹å¼å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeChatConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å¾®ä¿¡æ”¯ä»˜å‚æ•°</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.appId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String WX_APP_ID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡@Valueæ³¨è§£, å°†é…ç½®æ–‡ä»¶ä¸­çš„å€¼æ³¨å…¥åˆ°å¯¹è±¡å±æ€§ä¸­, åœ¨ä½¿ç”¨æ—¶åªéœ€è¦æ³¨å…¥WeChatConfigå¯¹è±¡ç„¶åè°ƒç”¨å³å¯, è€Œå®é™…å·¥ä½œä¸­, å¾€å¾€ç”¨é™æ€å±æ€§, æ–¹ä¾¿ä½¿ç”¨, äºæ˜¯å¯ä»¥å†™æˆå¦‚ä¸‹æ–¹å¼</p><a id="more"></a><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeChatConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å¾®ä¿¡æ”¯ä»˜å‚æ•°</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.appId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String WX_APP_ID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ­¤æ–¹å¼ä¸ä¼šæŠ¥é”™, ä½†æ˜¯å´å–ä¸åˆ°å±æ€§å€¼, å¹¶ä¸”ä¸ä¼šæŠ¥é”™. å˜é€šæ–¹å¼å¯ä»¥å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeChatConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å¾®ä¿¡æ”¯ä»˜å‚æ•°</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.appId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String WX_APP_ID;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.app.id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setWxAppId</span><span class="params">(String wxAppId)</span> </span>&#123;</span><br><span class="line">        WX_APP_ID = wxAppId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„: æ­¤å¤„çš„ setæ–¹æ³•ä¸å¯ä»¥è®¾ç½®ä¸ºé™æ€, å¦åˆ™åŒæ ·ä¸èƒ½æ³¨å…¥å±æ€§</p>]]></content>
      
      
      <categories>
          
          <category> issue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> issue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨æšä¸¾å®ç°å•ä¾‹</title>
      <link href="2018/08/17/use-enumeration-to-implement-a-singleton.html"/>
      <url>2018/08/17/use-enumeration-to-implement-a-singleton.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>ä»‹ç»ä½¿ç”¨æšä¸¾çš„æ–¹å¼åˆ›å»ºå•ä¾‹, å…¶ä»–æ–¹å¼å¯ä»¥å‚è€ƒ<a href="https://liuzhihang.com/2018/02/21/singleton-pattern.html">å•ä¾‹æ¨¡å¼</a></p><a id="more"></a><h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨æšä¸¾å•ä¾‹</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/8/17 17:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonPattern</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonPattern <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span>   SingleEnum.INSTANCE.getSingletonPattern();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">enum</span> <span class="title">SingleEnum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å•ä¾‹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        INSTANCE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> SingletonPattern singletonPattern;</span><br><span class="line"></span><br><span class="line">        SingleEnum() &#123;</span><br><span class="line">            <span class="keyword">this</span>.singletonPattern = <span class="keyword">new</span> SingletonPattern();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> SingletonPattern <span class="title">getSingletonPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> singletonPattern;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><p>1.æ¯”åŒé‡é”æ£€æŸ¥ç›¸å¯¹ç®€æ´<br>2.çº¿ç¨‹å®‰å…¨<br>3.è‡ªåŠ¨å¤„ç†åºåˆ—åŒ–<br>4.é˜²æ­¢åå°„</p>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
            <tag> å•ä¾‹æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ElasticsearchåŸºæœ¬è¯­å¥</title>
      <link href="2018/06/26/elasticsearch-basic-statement.html"/>
      <url>2018/06/26/elasticsearch-basic-statement.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="æŸ¥çœ‹é›†ç¾¤"><a href="#æŸ¥çœ‹é›†ç¾¤" class="headerlink" title="æŸ¥çœ‹é›†ç¾¤"></a>æŸ¥çœ‹é›†ç¾¤</h3><h4 id="1-æŸ¥çœ‹é›†ç¾¤å¥åº·"><a href="#1-æŸ¥çœ‹é›†ç¾¤å¥åº·" class="headerlink" title="1. æŸ¥çœ‹é›†ç¾¤å¥åº·"></a>1. æŸ¥çœ‹é›†ç¾¤å¥åº·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_cat/health?v&quot;</span></span><br></pre></td></tr></table></figure><h4 id="2-æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹"><a href="#2-æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹" class="headerlink" title="2. æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹"></a>2. æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_cat/nodes?v&quot;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="3-æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰ç´¢å¼•"><a href="#3-æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰ç´¢å¼•" class="headerlink" title="3. æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰ç´¢å¼•"></a>3. æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰ç´¢å¼•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_cat/indices?v&quot;</span></span><br></pre></td></tr></table></figure><h3 id="get-è·å–æŒ‡å®šæ•°æ®"><a href="#get-è·å–æŒ‡å®šæ•°æ®" class="headerlink" title="get è·å–æŒ‡å®šæ•°æ®"></a>get è·å–æŒ‡å®šæ•°æ®</h3><h4 id="1-ç›´æ¥è·å–æ•°æ®"><a href="#1-ç›´æ¥è·å–æ•°æ®" class="headerlink" title="1. ç›´æ¥è·å–æ•°æ®"></a>1. ç›´æ¥è·å–æ•°æ®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/logs/AWSudIFgTuj3oZBEhyxK?pretty&quot;</span></span><br></pre></td></tr></table></figure><p>æ ¼å¼ä¸º /{index}/{type}/{id}</p><table><thead><tr><th align="left">å­—æ®µ</th><th align="left">å«ä¹‰</th></tr></thead><tbody><tr><td align="left">monitor_log_mch_order_out</td><td align="left">ç´¢å¼• (_index)</td></tr><tr><td align="left">logs</td><td align="left">ç´¢å¼•çš„ç±»å‹ (_type), ä¸çŸ¥é“ç±»å‹å¯ä»¥ç”¨ _all åŒ¹é…</td></tr><tr><td align="left">AWSudIFgTuj3oZBEhyxK</td><td align="left">id (_id)</td></tr><tr><td align="left">pretty</td><td align="left">jsonæ ¼å¼æ˜¾ç¤ºæ•°æ®, å¯çœç•¥</td></tr></tbody></table><h4 id="2-å±è”½æˆ–åªæŸ¥çœ‹-source"><a href="#2-å±è”½æˆ–åªæŸ¥çœ‹-source" class="headerlink" title="2. å±è”½æˆ–åªæŸ¥çœ‹ _source"></a>2. å±è”½æˆ–åªæŸ¥çœ‹ _source</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/logs/AWSudIFgTuj3oZBEhyxK?pretty&amp;_source=false&quot;</span></span><br></pre></td></tr></table></figure><p>æ·»åŠ  _source=false å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/logs/AWSudIFgTuj3oZBEhyxK/_source?pretty&quot;</span></span><br></pre></td></tr></table></figure><h4 id="3-è¿‡æ»¤å­—æ®µ"><a href="#3-è¿‡æ»¤å­—æ®µ" class="headerlink" title="3. è¿‡æ»¤å­—æ®µ"></a>3. è¿‡æ»¤å­—æ®µ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/logs/AWSudIFgTuj3oZBEhyxK?pretty&amp;_source_include=log*&amp;_source_exclude=logType&quot;</span></span><br></pre></td></tr></table></figure><p>è·å–åŒ…å« log* ä¸”ä¸ä¸º logType çš„å­—æ®µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/logs/AWSudIFgTuj3oZBEhyxK?pretty&amp;_source=logType,logLevel&quot;</span></span><br></pre></td></tr></table></figure><p>åªæŸ¥è¯¢æŒ‡å®šå­—æ®µçš„ç®€æ˜“å†™æ³•</p><h3 id="mget-å¤šæ¡ä»¶åŒ¹é…æŸ¥è¯¢"><a href="#mget-å¤šæ¡ä»¶åŒ¹é…æŸ¥è¯¢" class="headerlink" title="mget å¤šæ¡ä»¶åŒ¹é…æŸ¥è¯¢"></a>mget å¤šæ¡ä»¶åŒ¹é…æŸ¥è¯¢</h3><ol><li><p>åŒ¹é…å¤šä¸ªç´¢å¼•, åŒæ—¶æŸ¥è¯¢å¤šä¸ªidçš„æ•°æ®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_mget?pretty&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;docs&quot; : [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;_index&quot; : &quot;monitor_log_mch_order_out&quot;,</span></span><br><span class="line"><span class="string">            &quot;_type&quot; : &quot;logs&quot;,</span></span><br><span class="line"><span class="string">            &quot;_id&quot; : &quot;AWSudIFgTuj3oZBEhyxK&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;_index&quot; : &quot;monitor_log_mch_order_out&quot;,</span></span><br><span class="line"><span class="string">            &quot;_type&quot; : &quot;logs&quot;,</span></span><br><span class="line"><span class="string">            &quot;_id&quot; : &quot;AWSuXewETuj3oZBEhywS&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥å°†ç´¢å¼•å†™åœ¨hoståé¢, ä»£è¡¨æŸ¥è¯¢çš„éƒ½ä¸ºåŒä¸€ç´¢å¼•ä¸‹çš„æ•°æ®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/_mget?pretty&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;docs&quot; : [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;_type&quot; : &quot;logs&quot;,</span></span><br><span class="line"><span class="string">            &quot;_id&quot; : &quot;AWSudIFgTuj3oZBEhyxK&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;_type&quot; : &quot;logs&quot;,</span></span><br><span class="line"><span class="string">            &quot;_id&quot; : &quot;AWSuXewETuj3oZBEhywS&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆå¹¶indexå’Œtype, ä»£è¡¨æŸ¥è¯¢çš„éƒ½ä¸ºåŒä¸€ç´¢å¼•ä¸‹typeä¹Ÿç›¸åŒçš„æ•°æ®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/logs/_mget?pretty&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;docs&quot; : [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;_id&quot; : &quot;AWSudIFgTuj3oZBEhyxK&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;_id&quot; : &quot;AWSuXewETuj3oZBEhywS&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p>ç®€åŒ–åå¦‚ä¸‹:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/logs/_mget?pretty&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;ids&quot; : [&quot;AWSudIFgTuj3oZBEhyxK&quot;, &quot;AWSuXewETuj3oZBEhywS&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure></li></ol><p>æ³¨: å½“å¤šä¸ªæ¡ä»¶çš„ _type ç›¸åŒæ—¶ å¯ä»¥ä½¿ç”¨ _all æˆ–è€…çœç•¥</p><ol start="4"><li>è¿‡æ»¤å­—æ®µ, æ¯ä¸ªIdåˆ†åˆ«å¯¹ _sourceè¿›è¡Œè¿‡æ»¤<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/_mget?pretty&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;docs&quot; : [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;_id&quot; : &quot;AWSudIFgTuj3oZBEhyxK&quot;,</span></span><br><span class="line"><span class="string">            &quot;_source&quot; : false</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;_id&quot; : &quot;AWSuXewETuj3oZBEhywS&quot;,</span></span><br><span class="line"><span class="string">            &quot;_source&quot; : [&quot;bizId&quot;, &quot;method&quot;]</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;_id&quot; : &quot;AWSuLAYqTuj3oZBEhysH&quot;,</span></span><br><span class="line"><span class="string">            &quot;_source&quot; : &#123;</span></span><br><span class="line"><span class="string">                &quot;include&quot;: [&quot;log*&quot;],</span></span><br><span class="line"><span class="string">                &quot;exclude&quot;: [&quot;logLevel&quot;]</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="search-æœç´¢"><a href="#search-æœç´¢" class="headerlink" title="_search æœç´¢"></a>_search æœç´¢</h3><h4 id="1-åŒ¹é…bizId-æŸ¥è¯¢"><a href="#1-åŒ¹é…bizId-æŸ¥è¯¢" class="headerlink" title="1. åŒ¹é…bizId æŸ¥è¯¢"></a>1. åŒ¹é…bizId æŸ¥è¯¢</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/_search?pretty&amp;q=bizId:2009011201807190133430748068&quot;</span></span><br></pre></td></tr></table></figure><h4 id="2-åŒæ—¶æŒ‡å®šç±»å‹"><a href="#2-åŒæ—¶æŒ‡å®šç±»å‹" class="headerlink" title="2. åŒæ—¶æŒ‡å®šç±»å‹"></a>2. åŒæ—¶æŒ‡å®šç±»å‹</h4><p>åŒæ—¶æŒ‡å®šç±»å‹, å¤šä¸ªç±»å‹ç”¨ â€˜,â€™ éš”å¼€, ä¹Ÿæ”¯æŒå¤šä¸ªç´¢å¼•å‹‡å£«æœç´¢, å¤šä¸ªç´¢å¼•ç”¨ â€˜,â€™ éš”å¼€, æˆ–è€…æ¨¡ç³Šæœç´¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/logs/_search?pretty&amp;q=bizId:2009011201807190133430748068&quot;</span></span><br></pre></td></tr></table></figure><h4 id="3-å ä½ç¬¦-all-åŒ¹é…æ‰€æœ‰ç´¢å¼•"><a href="#3-å ä½ç¬¦-all-åŒ¹é…æ‰€æœ‰ç´¢å¼•" class="headerlink" title="3. å ä½ç¬¦ _all åŒ¹é…æ‰€æœ‰ç´¢å¼•"></a>3. å ä½ç¬¦ _all åŒ¹é…æ‰€æœ‰ç´¢å¼•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_all/logs/_search?pretty&amp;q=bizId:2009011201807190133430748068&quot;</span></span><br></pre></td></tr></table></figure><h4 id="4-åŒ¹é…æ‰€æœ‰ç´¢å¼•æ‰€æœ‰ç±»å‹"><a href="#4-åŒ¹é…æ‰€æœ‰ç´¢å¼•æ‰€æœ‰ç±»å‹" class="headerlink" title="4. åŒ¹é…æ‰€æœ‰ç´¢å¼•æ‰€æœ‰ç±»å‹"></a>4. åŒ¹é…æ‰€æœ‰ç´¢å¼•æ‰€æœ‰ç±»å‹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_search?pretty&amp;q=bizId:2009011201807190133430748068&quot;</span></span><br></pre></td></tr></table></figure><p>æ³¨: q ä»£è¡¨æ˜ å°„query_string</p><h4 id="5-è¯·æ±‚ä½“çš„æ–¹å¼"><a href="#5-è¯·æ±‚ä½“çš„æ–¹å¼" class="headerlink" title="5. è¯·æ±‚ä½“çš„æ–¹å¼"></a>5. è¯·æ±‚ä½“çš„æ–¹å¼</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/logs/_search?pretty&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;query&quot; : &#123;</span></span><br><span class="line"><span class="string">        &quot;term&quot; : &#123; &quot;bizId&quot; : &quot;2009011201807190133430748068&quot; &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="6-åˆ†é¡µæŸ¥è¯¢-from-size"><a href="#6-åˆ†é¡µæŸ¥è¯¢-from-size" class="headerlink" title="6. åˆ†é¡µæŸ¥è¯¢ from/size"></a>6. åˆ†é¡µæŸ¥è¯¢ from/size</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/logs/_search?pretty&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;from&quot; : 0, &quot;size&quot; : 1,</span></span><br><span class="line"><span class="string">    &quot;query&quot; : &#123;</span></span><br><span class="line"><span class="string">        &quot;term&quot; : &#123; &quot;bizId&quot; : &quot;2009011201807190133430748068&quot; &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="7-æŸ¥è¯¢å¹¶è¿‡æ»¤å­—æ®µ"><a href="#7-æŸ¥è¯¢å¹¶è¿‡æ»¤å­—æ®µ" class="headerlink" title="7. æŸ¥è¯¢å¹¶è¿‡æ»¤å­—æ®µ"></a>7. æŸ¥è¯¢å¹¶è¿‡æ»¤å­—æ®µ</h4><p>æ ¹æ®å­—æ®µæŸ¥è¯¢å¹¶ç­›é€‰æ‰æŒ‡å®šå­—æ®µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_search?pretty&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;_source&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;includes&quot;: [ &quot;costTime&quot;, &quot;bizId&quot; ],</span></span><br><span class="line"><span class="string">        &quot;excludes&quot;: [ &quot;logLevel&quot; ]</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;query&quot; : &#123;</span></span><br><span class="line"><span class="string">        &quot;term&quot; : &#123; &quot;bizId&quot; : &quot;2009011201807190133430748068&quot; &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="èŒƒå›´æŸ¥è¯¢"><a href="#èŒƒå›´æŸ¥è¯¢" class="headerlink" title="èŒƒå›´æŸ¥è¯¢"></a>èŒƒå›´æŸ¥è¯¢</h3><h4 id="1-æŒ‰ç…§æ—¶é—´èŒƒå›´æŸ¥è¯¢"><a href="#1-æŒ‰ç…§æ—¶é—´èŒƒå›´æŸ¥è¯¢" class="headerlink" title="1. æŒ‰ç…§æ—¶é—´èŒƒå›´æŸ¥è¯¢"></a>1. æŒ‰ç…§æ—¶é—´èŒƒå›´æŸ¥è¯¢</h4><p>å¯ä»¥çœç•¥ç´¢å¼•æŸ¥è¯¢å…¨éƒ¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;localhost:9200/monitor_log_mch_order_out/_search?pretty&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;range&quot; : &#123;</span></span><br><span class="line"><span class="string">            &quot;time&quot; : &#123;</span></span><br><span class="line"><span class="string">                &quot;gte&quot;: &quot;2018-07-19 00:14:25:000&quot;,</span></span><br><span class="line"><span class="string">                &quot;lte&quot;: &quot;2018-07-19 00:14:30:000&quot;,</span></span><br><span class="line"><span class="string">                &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss:SSS&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>logstashé…ç½®</title>
      <link href="2018/06/20/logstash-configuration.html"/>
      <url>2018/06/20/logstash-configuration.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="è¾“å…¥"><a href="#è¾“å…¥" class="headerlink" title="è¾“å…¥"></a>è¾“å…¥</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">input</span> &#123;</span><br><span class="line">    <span class="string">beats</span> &#123;</span><br><span class="line">        <span class="string">port</span> <span class="string">=&gt;</span> <span class="string">&quot;5043&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ—¥å¿—è¾“å…¥æ–¹å¼ä¸º filebeat, å¹¶é…ç½®ç«¯å£</p><a id="more"></a><h3 id="è¿‡æ»¤"><a href="#è¿‡æ»¤" class="headerlink" title="è¿‡æ»¤"></a>è¿‡æ»¤</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="string">grok</span> &#123;</span><br><span class="line">        <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">        <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;\[<span class="template-variable">%&#123;DATA:time&#125;</span>\]-\[<span class="template-variable">%&#123;DATA:method&#125;</span>\] - \[<span class="template-variable">%&#123;DATA:catalina&#125;</span>\] -\[<span class="template-variable">%&#123;DATA:logLevel&#125;</span>\] - \[<span class="template-variable">%&#123;DATA:index_prefix&#125;</span>\|<span class="template-variable">%&#123;WORD:logType&#125;</span>\|<span class="template-variable">%&#123;WORD:sysNo&#125;</span>\|<span class="template-variable">%&#123;WORD:objType&#125;</span>\|<span class="template-variable">%&#123;DATA:funcode&#125;</span>\|<span class="template-variable">%&#123;WORD:monitorObjNo&#125;</span>\|<span class="template-variable">%&#123;WORD:bizId&#125;</span>\|<span class="template-variable">%&#123;WORD:respCode&#125;</span>\|<span class="template-variable">%&#123;DATA:respMsg&#125;</span>\|<span class="template-variable">%&#123;WORD:costTime&#125;</span>|<span class="template-variable">%&#123;DATA:exField&#125;</span>\]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">grok</span>&#123;</span><br><span class="line">         <span class="string">match</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;time&quot;</span> <span class="string">=&gt;</span> [<span class="string">&quot;<span class="template-variable">%&#123;INT:y_index&#125;</span>-<span class="template-variable">%&#123;INT:M_index&#125;</span>-<span class="template-variable">%&#123;INT:d_index&#125;</span>&quot;</span>]&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">mutate</span> &#123;</span><br><span class="line">        <span class="string">add_field</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;[@metadata][index_suffix]&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;y_index&#125;</span><span class="template-variable">%&#123;M_index&#125;</span><span class="template-variable">%&#123;d_index&#125;</span>&quot;</span> &#125;</span><br><span class="line">        <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;beat&quot;</span>,<span class="string">&quot;host&quot;</span>,<span class="string">&quot;thread&quot;</span>,<span class="string">&quot;class&quot;</span>,<span class="string">&quot;source&quot;</span>,<span class="string">&quot;tags&quot;</span>,<span class="string">&quot;type&quot;</span>,<span class="string">&quot;y_index&quot;</span>,<span class="string">&quot;M_index&quot;</span>,<span class="string">&quot;d_index&quot;</span>]</span><br><span class="line">        <span class="string">lowercase</span> <span class="string">=&gt;</span> [ <span class="string">&quot;index_prefix&quot;</span> ]</span><br><span class="line">        <span class="string">lowercase</span> <span class="string">=&gt;</span> [ <span class="string">&quot;funcode&quot;</span> ]</span><br><span class="line">        <span class="string">lowercase</span> <span class="string">=&gt;</span> [ <span class="string">&quot;objType&quot;</span> ]</span><br><span class="line">        <span class="string">lowercase</span> <span class="string">=&gt;</span> [ <span class="string">&quot;monitorObjNo&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>ä½¿ç”¨gorkè¿‡æ»¤å™¨å¯¹æ—¥å¿—è¿›è¡Œç­›é€‰, å¹¶å¯¹éƒ¨åˆ†å­—æ®µèµ‹å€¼.</li><li>ä½¿ç”¨mutateæ’ä»¶å¯¹å­—æ®µè¿›è¡Œè½¬æ¢, add_field ä¸ºæ·»åŠ å­—æ®µ [@metadata][index_suffix] æ„æ€æ˜¯æ·»åŠ ä¸´æ—¶å­—æ®µ, è¯¥å­—æ®µä¸ä¼šè¾“å‡ºåˆ°esä¸­</li></ol><h3 id="è¾“å‡º"><a href="#è¾“å‡º" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">output</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="string">if</span>  [<span class="string">logType</span>] <span class="string">==</span> <span class="string">&quot;info&quot;</span>  &#123;</span><br><span class="line">                 <span class="string">elasticsearch</span> &#123;</span><br><span class="line">                        <span class="string">hosts</span> <span class="string">=&gt;</span> [ <span class="string">&quot;xxx.xxx.xxx.xxx:9200&quot;</span> ]</span><br><span class="line">                        <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;index_prefix&#125;</span>_<span class="template-variable">%&#123;objType&#125;</span>_<span class="template-variable">%&#123;funcode&#125;</span>_<span class="template-variable">%&#123;[@metadata][index_suffix]&#125;</span>&quot;</span></span><br><span class="line">                        <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">elastic</span></span><br><span class="line">                        <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">xxx</span></span><br><span class="line">                 &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="string">if</span> [<span class="string">logType</span>] <span class="string">==</span> <span class="string">&quot;error&quot;</span> &#123;</span><br><span class="line">                <span class="string">redis</span> &#123;</span><br><span class="line">                        <span class="string">data_type</span> <span class="string">=&gt;</span> <span class="string">&quot;list&quot;</span></span><br><span class="line">                        <span class="string">db</span> <span class="string">=&gt;</span> <span class="number">0</span></span><br><span class="line">                        <span class="comment">#key =&gt; &quot;%&#123;index_prefix&#125;_%&#123;sysNo&#125;_%&#123;objType&#125;_%&#123;funcode&#125;_%&#123;[@metadata][index_suffix]&#125;&quot;</span></span><br><span class="line">                        <span class="string">key</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;index_prefix&#125;</span>_<span class="template-variable">%&#123;sysNo&#125;</span>_<span class="template-variable">%&#123;objType&#125;</span>_<span class="template-variable">%&#123;monitorObjNo&#125;</span>&quot;</span></span><br><span class="line">                        <span class="string">host</span> <span class="string">=&gt;</span> <span class="string">&quot;xxx.xxx.xxx.xxx&quot;</span></span><br><span class="line">                        <span class="string">port</span> <span class="string">=&gt;</span> <span class="string">&quot;6379&quot;</span></span><br><span class="line">                        <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†è¿‡æ»¤åçš„å­—æ®µæŒ‰ç…§ç±»å‹è¾“å‡ºåˆ°Esæˆ–è€…redisé˜Ÿåˆ—ä¸­</p><h3 id="å¯åŠ¨å‘½ä»¤"><a href="#å¯åŠ¨å‘½ä»¤" class="headerlink" title="å¯åŠ¨å‘½ä»¤"></a>å¯åŠ¨å‘½ä»¤</h3><pre><code>    ./bin/logstash -f first-pipelines.yml    nohup ./logstash -f ../first-pipelines.yml &gt;/dev/null 2&gt;&amp;1 &amp;</code></pre><h3 id="å…¶ä»–é…ç½®"><a href="#å…¶ä»–é…ç½®" class="headerlink" title="å…¶ä»–é…ç½®"></a>å…¶ä»–é…ç½®</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è¾“å‡ºåˆ°æ§åˆ¶å°</span></span><br><span class="line"><span class="string">stdout</span> &#123; <span class="string">codec</span> <span class="string">=&gt;</span> <span class="string">rubydebug</span> &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>filebeaté…ç½®</title>
      <link href="2018/06/20/filebeat-configuration.html"/>
      <url>2018/06/20/filebeat-configuration.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="filebeaté…ç½®"><a href="#filebeaté…ç½®" class="headerlink" title="filebeaté…ç½®"></a>filebeaté…ç½®</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">filebeat.prospectors:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">input_type:</span> <span class="string">log</span></span><br><span class="line"><span class="comment">#è¯»å–æ—¥å¿—çš„è·¯å¾„</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/opt/export/log/info-xxx.log</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">log_type:</span> <span class="string">&quot;monitor_log&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">fields_under_root:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#è¿‡æ»¤éƒ¨åˆ†æ—¥å¿—</span></span><br><span class="line">  <span class="attr">include_lines:</span> [<span class="string">&#x27;Monitor_log&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------- Logstash output --------------------------------</span></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="comment"># The Logstash hosts</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;xxx.xxx.xxx.xxx:5043&quot;</span>,<span class="string">&quot;xxx.xxx.xxx.xxx:5043&quot;</span>]</span><br><span class="line">  <span class="attr">loadbalance:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Logging =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging.level:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">logging.to_files:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">logging.to_syslog:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">logging.files:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/opt/export/app/filebeat/logs</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mybeat.log</span></span><br><span class="line">  <span class="attr">keepfiles:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><p>è¿‡æ»¤ä¸åŒ…å«æŒ‡å®šå­—æ®µçš„æ—¥å¿—, å¹¶ä»…ä»…è¾“å‡ºåˆ°logstash, ä¹Ÿå¯ä»¥ç›´æ¥è¾“å‡ºåˆ°Elasticsearch</p><h3 id="å¯åŠ¨å‘½ä»¤"><a href="#å¯åŠ¨å‘½ä»¤" class="headerlink" title="å¯åŠ¨å‘½ä»¤"></a>å¯åŠ¨å‘½ä»¤</h3><ol><li>å‰å°å¯åŠ¨ï¼šå…³é—­çª—å£è¿æ¥åè‡ªåŠ¨é€€å‡º</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./filebeat -e -c filebeat.yml</span><br></pre></td></tr></table></figure><ol start="2"><li>åå°å¯åŠ¨:</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nohup ./filebeat -e -c filebeat.yml &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><ol start="3"><li>å…³é—­:</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 xxxx</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§ç³»ç»Ÿæ¶æ„</title>
      <link href="2018/06/20/monitoring-system-architecture.html"/>
      <url>2018/06/20/monitoring-system-architecture.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ç›‘æ§ç³»ç»ŸåŸºæœ¬æ¡†æ¶"><a href="#ç›‘æ§ç³»ç»ŸåŸºæœ¬æ¡†æ¶" class="headerlink" title="ç›‘æ§ç³»ç»ŸåŸºæœ¬æ¡†æ¶"></a>ç›‘æ§ç³»ç»ŸåŸºæœ¬æ¡†æ¶</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="/resources/image/elk/elk.png" alt="ç›‘æ§ç³»ç»ŸåŸºæœ¬æ¶æ„"></p><a id="more"></a><h3 id="è§£é‡Š"><a href="#è§£é‡Š" class="headerlink" title="è§£é‡Š"></a>è§£é‡Š</h3><ol><li>å„ä¸šåŠ¡ç³»ç»ŸæŒ‰ç…§æŒ‡å®šæ ¼å¼æ‰“å°æ—¥å¿—</li><li>filebeatè‡ªåŠ¨è¯»å–æ—¥å¿—ä¿¡æ¯, å¹¶è¿›è¡Œè¿‡æ»¤, è¾“å‡ºåˆ°logstash</li><li>logstashè¿›è¡ŒäºŒæ¬¡å¤„ç†, å°†æ—¥å¿—å†…å®¹æ ¼å¼åŒ–, å¹¶å°† infoæ—¥å¿—å’Œerroræ—¥å¿—åˆ†åˆ«å­˜æ”¾åˆ°Elasticsearchå’Œredisé˜Ÿåˆ—ä¸­</li><li>ç›‘æ§ç³»ç»Ÿå®šæ—¶ä»Eså’Œredisä¸­è·å–æ•°æ®, å­˜æ”¾åˆ°mysqlå¹¶è¿›è¡ŒæŠ¥è­¦åˆ†æ</li><li>ä½¿ç”¨EChartå›¾å½¢åŒ–å±•ç¤ºä¿¡æ¯<br>â€¦</li></ol>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</title>
      <link href="2018/06/15/thread-life-cycle.html"/>
      <url>2018/06/15/thread-life-cycle.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"></a>çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h3><p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="/resources/concurrent/thread-life.png" alt="javaå†…å­˜æ¨¡å‹"></p><a id="more"></a><h3 id="å›¾è§£æ"><a href="#å›¾è§£æ" class="headerlink" title="å›¾è§£æ"></a>å›¾è§£æ</h3><p>1.ä¸€èˆ¬æƒ…å†µä¸‹çº¿ç¨‹ä¸»è¦ç»å†: å‡†å¤‡, å°±ç»ª, è¿è¡Œ, æ­»äº¡å››ç§çŠ¶æ€.<br>2.å‡†å¤‡:å³åˆ›å»ºçº¿ç¨‹, åŒ…æ‹¬é›†æˆThread, çº¿ç¨‹æ± , springæ–¹å¼ç­‰ç­‰<br>3.å°±ç»ª:çº¿ç¨‹åˆ›å»ºå¹¶è°ƒç”¨start()æ–¹æ³•å¹¶ä¸ä»£è¡¨çº¿ç¨‹å°†ç«‹å³è·å¾—èµ„æº, è€Œæ˜¯è¿›å…¥åˆ°å°±ç»ªçŠ¶æ€è¿›è¡Œèµ„æºåˆ†é…<br>4.è¿è¡Œ:æŠ¢å åˆ°èµ„æºçš„çº¿ç¨‹å°†æ‰§è¡Œ, æ‰§è¡Œè¿‡ç¨‹å¯èƒ½ä¼šå«æœ‰ä¸€äº›åˆ«çš„æ“ä½œ<br>&emsp;1).çº¿ç¨‹ç­‰å¾…, ç›´åˆ°è°ƒç”¨ notify()æˆ–notifyAll()æ–¹æ³•è¢«å”¤é†’, è¿™é‡Œå”¤é†’åä¸ä¼šç«‹å³ç»§ç»­æ‰§è¡Œçº¿ç¨‹, è€Œæ˜¯è¿›å…¥å°±ç»ªçŠ¶æ€é‡æ–°æŠ¢å èµ„æº<br>&emsp;2).çº¿ç¨‹ä¼‘çœ , ç›´åˆ°ä¼‘çœ æ—¶é—´ç»“æŸ, åŒæ ·ç»“æŸåä¸ä¼šç«‹å³ç»§ç»­æ‰§è¡Œçº¿ç¨‹, è€Œæ˜¯è¿›å…¥å°±ç»ªçŠ¶æ€é‡æ–°æŠ¢å èµ„æº<br>&emsp;3).çº¿ç¨‹é˜»å¡, IOèµ„æºé˜»å¡, é”ç­‰æ–¹å¼ä½¿çº¿ç¨‹è¿›å…¥é˜»å¡é˜Ÿåˆ—, é‡Šæ”¾é”å°†ç»§ç»­æ‰§è¡Œ<br>5.æ­»äº¡: è°ƒç”¨<del>stop()</del>æ–¹æ³•, çº¿ç¨‹ä¸­æ–­, æˆ–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åˆ™çº¿ç¨‹æ­»äº¡</p>]]></content>
      
      
      <categories>
          
          <category> å¹¶å‘å’Œé” </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¤šçº¿ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>synchronizedé”çš„ä»‹ç»</title>
      <link href="2018/06/13/introduction-of-synchronized-lock.html"/>
      <url>2018/06/13/introduction-of-synchronized-lock.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="synchronizedé”çš„ä½¿ç”¨"><a href="#synchronizedé”çš„ä½¿ç”¨" class="headerlink" title="synchronizedé”çš„ä½¿ç”¨"></a>synchronizedé”çš„ä½¿ç”¨</h3><p>synchronizedå¯ä»¥ä½¿ç”¨åœ¨æ–¹æ³•å’Œä»£ç å—ä¸­, ä½¿ç”¨çš„æ–¹å¼ä¸åŒé”ä»£è¡¨çš„å«ä¹‰ä¸åŒ, ä¸‹é¢å°†ä»å‡ ä¸ªæ–¹é¢è¿›è¡Œä»‹ç».</p><ul><li>æ™®é€šæ–¹æ³•</li><li>é™æ€æ–¹æ³•</li><li>ä»£ç å—synchronized(this)</li><li>ä»£ç å—synchronized(*.class)</li></ul><a id="more"></a><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><ul><li>åœ¨ä½¿ç”¨synchronizedå…³é”®å­—ä¸­é”ä¸»è¦åˆ†ä¸ºä¸¤ç±», ä¸€ç§æ˜¯å¯¹è±¡é”, å¦ä¸€ç§ç±»é”</li><li>æ™®é€šåŠ é”æ–¹æ³•å’Œsynchronized(this)éƒ½æ˜¯å¯¹è±¡é”, é™æ€åŠ é”æ–¹æ³•å’Œsynchronized(*.class)éƒ½æ˜¯ç±»é”</li><li>å¯¹è±¡é”: åŒä¸€å¯¹è±¡æŒæœ‰é”, ç›¸åŒå¯¹è±¡ç­‰å¾…, å…¶ä»–å¯¹è±¡ä¸å—å½±å“; ä¸åŒå¯¹è±¡æŒæœ‰é”, äº’ä¸å½±å“.</li><li>ç±»é”: ç±»é”æ—¶, åªè¦è¯¥ç±»çš„å¯¹è±¡æŒæœ‰é”, æ— è®ºæ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡è®¿é—®é™æ€åŒæ­¥æ–¹æ³•æ—¶éƒ½ç­‰å¾…, è®¿é—®éé™æ€åŒæ­¥æ–¹æ³•ä¸å—å½±å“.</li><li>å¯¹è±¡é”å’Œç±»é”äº’ç›¸ä¸å½±å“</li></ul><h3 id="æµ‹è¯•ä»£ç åŠè¿‡ç¨‹"><a href="#æµ‹è¯•ä»£ç åŠè¿‡ç¨‹" class="headerlink" title="æµ‹è¯•ä»£ç åŠè¿‡ç¨‹"></a>æµ‹è¯•ä»£ç åŠè¿‡ç¨‹</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.tool.sync;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/7/11 16:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncMainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SyncTest syncTest1 = <span class="keyword">new</span> SyncTest();</span><br><span class="line">        <span class="comment">// SyncTest syncTest2 = new SyncTest();</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; syncTest1.methodA(), <span class="string">&quot;çº¿ç¨‹ 01 &quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; syncTest1.methodB(), <span class="string">&quot;çº¿ç¨‹ 02 &quot;</span>).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;start&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;sleep&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;start&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;sleep&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">300</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸ºä¸€ä¸ªç®€å•çš„æµ‹è¯•ä»£ç , æŒ‡ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è°ƒç”¨ä¸¤ä¸ªæ–¹æ³•, é€šè¿‡æ‰“å°ç»“æœå¯ä»¥çœ‹å‡ºé¡ºåºæ˜¯ä¹±åºçš„, å…¶ä¸­çº¿ç¨‹çš„ start() é¡ºåºå¹¶ä¸ä»£è¡¨çº¿ç¨‹çš„æ‰§è¡Œé¡ºåº, åœ¨ä¸‹é¢æµ‹è¯•ä¸­å‡è®¾æ˜¯ â€œçº¿ç¨‹01â€ å…ˆæ‰§è¡Œ.</p><h4 id="1-A-B-æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­—-åŒä¸€å¯¹è±¡"><a href="#1-A-B-æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­—-åŒä¸€å¯¹è±¡" class="headerlink" title="1.A B æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­— + åŒä¸€å¯¹è±¡"></a>1.A B æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­— + åŒä¸€å¯¹è±¡</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“è®º: æ–¹æ³• A é˜»å¡, æ–¹æ³• B ç­‰å¾… A æ‰§è¡Œå®Œæ¯•åæ‰ç»§ç»­æ‰§è¡Œ.</p><h4 id="2-A-B-æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­—-ä¸åŒå¯¹è±¡"><a href="#2-A-B-æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­—-ä¸åŒå¯¹è±¡" class="headerlink" title="2.A B æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­— + ä¸åŒå¯¹è±¡"></a>2.A B æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­— + ä¸åŒå¯¹è±¡</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncMainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SyncTest syncTest1 = <span class="keyword">new</span> SyncTest();</span><br><span class="line">        SyncTest syncTest2 = <span class="keyword">new</span> SyncTest();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; syncTest1.methodA(), <span class="string">&quot;çº¿ç¨‹ 01 &quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; syncTest2.methodB(), <span class="string">&quot;çº¿ç¨‹ 02 &quot;</span>).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“è®º: æ–¹æ³• A é˜»å¡, æ–¹æ³• B ä¸å—å½±å“.</p><h4 id="3-A-æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­—-Bæ–¹æ³•ä¸æ·»åŠ "><a href="#3-A-æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­—-Bæ–¹æ³•ä¸æ·»åŠ " class="headerlink" title="3.A æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­— Bæ–¹æ³•ä¸æ·»åŠ "></a>3.A æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­— Bæ–¹æ³•ä¸æ·»åŠ </h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“è®º: æ–¹æ³• A é˜»å¡, æ–¹æ³• B ä¸å—å½±å“.</p><h4 id="4-A-B-æ–¹æ³•åˆ†åˆ«æ·»åŠ -static-synchronized-ä¸åŒå¯¹è±¡"><a href="#4-A-B-æ–¹æ³•åˆ†åˆ«æ·»åŠ -static-synchronized-ä¸åŒå¯¹è±¡" class="headerlink" title="4.A B æ–¹æ³•åˆ†åˆ«æ·»åŠ  static synchronized  + ä¸åŒå¯¹è±¡"></a>4.A B æ–¹æ³•åˆ†åˆ«æ·»åŠ  static synchronized  + ä¸åŒå¯¹è±¡</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncMainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SyncTest syncTest1 = <span class="keyword">new</span> SyncTest();</span><br><span class="line">        SyncTest syncTest2 = <span class="keyword">new</span> SyncTest();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; syncTest1.methodA(), <span class="string">&quot;çº¿ç¨‹ 01 &quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; syncTest2.methodB(), <span class="string">&quot;çº¿ç¨‹ 02 &quot;</span>).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“è®º: æ–¹æ³• A é˜»å¡, æ–¹æ³• B ç­‰å¾… Aç»“æŸåç»§ç»­æ‰§è¡Œ.</p><h4 id="5-A-æ–¹æ³•æ·»åŠ -static-synchronized-B-æ–¹æ³•æ·»åŠ -synchronized-ä¸åŒå¯¹è±¡"><a href="#5-A-æ–¹æ³•æ·»åŠ -static-synchronized-B-æ–¹æ³•æ·»åŠ -synchronized-ä¸åŒå¯¹è±¡" class="headerlink" title="5.A æ–¹æ³•æ·»åŠ  static synchronized, B æ–¹æ³•æ·»åŠ  synchronized  + ä¸åŒå¯¹è±¡"></a>5.A æ–¹æ³•æ·»åŠ  static synchronized, B æ–¹æ³•æ·»åŠ  synchronized  + ä¸åŒå¯¹è±¡</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncMainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SyncTest syncTest1 = <span class="keyword">new</span> SyncTest();</span><br><span class="line">        SyncTest syncTest2 = <span class="keyword">new</span> SyncTest();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; syncTest1.methodA(), <span class="string">&quot;çº¿ç¨‹ 01 &quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; syncTest2.methodB(), <span class="string">&quot;çº¿ç¨‹ 02 &quot;</span>).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“è®º: æ–¹æ³• A é˜»å¡, æ–¹æ³• B ä¸å—å½±å“.</p><h4 id="6-A-B-æ–¹æ³•å†…æ·»åŠ -synchronized-this"><a href="#6-A-B-æ–¹æ³•å†…æ·»åŠ -synchronized-this" class="headerlink" title="6.A B æ–¹æ³•å†…æ·»åŠ  synchronized(this)"></a>6.A B æ–¹æ³•å†…æ·»åŠ  synchronized(this)</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“è®º: åŒä¸€å¯¹è±¡ A é˜»å¡ Bç­‰å¾…, ä¸åŒå¯¹è±¡ Aé˜»å¡ Bä¸å—å½±å“</p><h4 id="7-A-B-æ–¹æ³•å†…æ·»åŠ -synchronized-SyncTest-class"><a href="#7-A-B-æ–¹æ³•å†…æ·»åŠ -synchronized-SyncTest-class" class="headerlink" title="7.A B æ–¹æ³•å†…æ·»åŠ  synchronized(SyncTest.class)"></a>7.A B æ–¹æ³•å†…æ·»åŠ  synchronized(SyncTest.class)</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SyncTest.class) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SyncTest.class) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“è®º: åŒä¸€/ä¸åŒå¯¹è±¡ A é˜»å¡ Bç­‰å¾…</p><h4 id="8-A-æ–¹æ³•å†…æ·»åŠ -synchronized-SyncTest-class-B-æ–¹æ³•å†…æ·»åŠ -synchronized-this"><a href="#8-A-æ–¹æ³•å†…æ·»åŠ -synchronized-SyncTest-class-B-æ–¹æ³•å†…æ·»åŠ -synchronized-this" class="headerlink" title="8.A æ–¹æ³•å†…æ·»åŠ  synchronized(SyncTest.class), B æ–¹æ³•å†…æ·»åŠ  synchronized(this)"></a>8.A æ–¹æ³•å†…æ·»åŠ  synchronized(SyncTest.class), B æ–¹æ³•å†…æ·»åŠ  synchronized(this)</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SyncTest.class) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“è®º: åŒä¸€/ä¸åŒå¯¹è±¡ A é˜»å¡ Bä¸å—å½±å“</p><h4 id="9-A-æ–¹æ³•å†…æ·»åŠ -synchronized-SyncTest-class-B-æ–¹æ³•å†…æ·»åŠ -synchronized-OtherObj"><a href="#9-A-æ–¹æ³•å†…æ·»åŠ -synchronized-SyncTest-class-B-æ–¹æ³•å†…æ·»åŠ -synchronized-OtherObj" class="headerlink" title="9.A æ–¹æ³•å†…æ·»åŠ  synchronized(SyncTest.class), B æ–¹æ³•å†…æ·»åŠ  synchronized(OtherObj)"></a>9.A æ–¹æ³•å†…æ·»åŠ  synchronized(SyncTest.class), B æ–¹æ³•å†…æ·»åŠ  synchronized(OtherObj)</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String string = <span class="string">&quot;lock&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SyncTest.class) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (string) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“è®º: åŒä¸€/ä¸åŒå¯¹è±¡ A é˜»å¡ Bä¸å—å½±å“</p>]]></content>
      
      
      <categories>
          
          <category> å¹¶å‘å’Œé” </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¤šçº¿ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>synchronizedåŒæ­¥é”åŸç†</title>
      <link href="2018/06/11/synchronized-synchronous-lock-principle.html"/>
      <url>2018/06/11/synchronized-synchronous-lock-principle.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><ul><li>åœ¨å¤šçº¿ç¨‹æ“ä½œä¸­volatileå…³é”®å­—å¯ä»¥ä¿è¯å…±äº«å˜é‡çš„å†…å­˜å¯è§æ€§, ä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯æ“ä½œçš„åŸå­æ€§, è¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°é”, synchronizedåŒæ­¥é”æ˜¯javaå…³é”®å­—, æ˜¯å†…ç½®çš„è¯­è¨€å®ç°.</li><li>synchronizedåŠ é”å’Œçº¿ç¨‹ç»“æŸæˆ–å¼‚å¸¸é”çš„é‡Šæ”¾è¿‡ç¨‹ç”±JVMè¿›è¡Œæ§åˆ¶</li><li>synchronizedå…³é”®å­—å¯ä»¥ä½¿ç”¨åœ¨æ–¹æ³•å’ŒåŒæ­¥ä»£ç å—ä¸­, ä¸åŒçš„ä½¿ç”¨æ–¹å¼, é”çš„ç»“æœæ˜¯ä¸åŒçš„</li><li>é‡é‡çº§é” + å¯é‡å…¥</li></ul><a id="more"></a><h3 id="synchronizedåº•å±‚åŸç†"><a href="#synchronizedåº•å±‚åŸç†" class="headerlink" title="synchronizedåº•å±‚åŸç†"></a>synchronizedåº•å±‚åŸç†</h3><p>1.ä»£ç ç¤ºä¾‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.tool.java;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/06/11 16:05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">syncTest1</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">syncTest2</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.ä½¿ç”¨ javap -v SynchronizedTest.class æŸ¥çœ‹ä»£ç çš„å¯¹åº”å­—èŠ‚ç å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ javap -v SynchronizedTest.class</span><br><span class="line">Classfile &#x2F;C:&#x2F;Users&#x2F;liuzhihang&#x2F;Desktop&#x2F;SynchronizedTest.class</span><br><span class="line">  Last modified 2018-7-10; size 518 bytes</span><br><span class="line">  MD5 checksum ba48def77b226e7b9ac28121ec423c16</span><br><span class="line">  Compiled from &quot;SynchronizedTest.java&quot;</span><br><span class="line">public class com.liuzhihang.tool.java.SynchronizedTest</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">&#x2F;&#x2F; å¸¸é‡æ± çœç•¥</span><br><span class="line">&#123;</span><br><span class="line">  &#x2F;&#x2F; æ„é€ æ–¹æ³•çœç•¥</span><br><span class="line"></span><br><span class="line">  public void syncTest1();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack&#x3D;3, locals&#x3D;3, args_size&#x3D;1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: dup</span><br><span class="line">         2: astore_1</span><br><span class="line">         3: monitorenter</span><br><span class="line">         4: aload_0</span><br><span class="line">         5: dup</span><br><span class="line">         6: getfield      #2                    &#x2F;&#x2F; Field i:I</span><br><span class="line">         9: iconst_1</span><br><span class="line">        10: iadd</span><br><span class="line">        11: putfield      #2                    &#x2F;&#x2F; Field i:I</span><br><span class="line">        14: aload_1</span><br><span class="line">        15: monitorexit</span><br><span class="line">        16: goto          24</span><br><span class="line">        19: astore_2</span><br><span class="line">        20: aload_1</span><br><span class="line">        21: monitorexit</span><br><span class="line">        22: aload_2</span><br><span class="line">        23: athrow</span><br><span class="line">        24: return</span><br><span class="line">      Exception table:</span><br><span class="line">  &#x2F;&#x2F; çœç•¥ä»£ç </span><br><span class="line"></span><br><span class="line">  public synchronized void syncTest2();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_SYNCHRONIZED</span><br><span class="line">    Code:</span><br><span class="line">      stack&#x3D;3, locals&#x3D;1, args_size&#x3D;1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: dup</span><br><span class="line">         2: getfield      #3                  &#x2F;&#x2F; Field j:I</span><br><span class="line">         5: iconst_1</span><br><span class="line">         6: iadd</span><br><span class="line">         7: putfield      #3                  &#x2F;&#x2F; Field j:I</span><br><span class="line">        10: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 22: 0</span><br><span class="line">        line 23: 10</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: &quot;SynchronizedTest.java&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3.ç»“è®º</p><ul><li>åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ monitorenter å’Œ monitorexit æŒ‡ä»¤, å…¶ä¸­æœ‰ä¸¤ä¸ª monitorexit å› ä¸ºä¸èƒ½ç¡®ä¿æ˜¯æ­£å¸¸ç»“æŸè¿˜æ˜¯å¼‚å¸¸ç»“æŸ, æ‰€ä»¥å¦ä¸€ä¸ªæ˜¯ç”¨æ¥ç¡®ä¿å¼‚å¸¸ç»“æŸæ—¶é‡Šæ”¾ monitoræŒ‡ä»¤.</li><li>åŒæ­¥æ–¹æ³•æ—¶ä½¿ç”¨çš„æ˜¯ flagsä¸­çš„ ACC_SYNCHRONIZED æ¥æ ‡è¯†è¯¥æ–¹æ³•ä¸ºåŒæ­¥æ–¹æ³•, JVMåœ¨è°ƒç”¨è¯¥æ–¹æ³•æ—¶ä¾¿ä¼šæ‰§è¡Œç›¸åº”çš„åŒæ­¥è°ƒç”¨.</li><li>æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤è‡ªå·±çš„ç›‘è§†å™¨(monitor), åªè¦æ˜¯åŒæ­¥è°ƒç”¨è¿›è¡Œç›¸å…³æ“ä½œæ—¶è¦å…ˆè·å¾— monitor, å¦åˆ™å°†è¢«é˜»å¡</li></ul>]]></content>
      
      
      <categories>
          
          <category> å¹¶å‘å’Œé” </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¤šçº¿ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>volatileå…³é”®å­—</title>
      <link href="2018/06/09/volatile-keyword.html"/>
      <url>2018/06/09/volatile-keyword.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>åœ¨å¤šçº¿ç¨‹æ“ä½œå…±äº«å˜é‡æ—¶, ä¼šä½¿ç”¨volatileä¿®é¥°å…±äº«å˜é‡, æ¯”å¦‚å•ä¾‹æ¨¡å¼çš„åŒé‡é”æ£€æŸ¥ä¸­, å¹¶ä¸”åœ¨concurrentåŒ…ä¸‹ä¹Ÿå¤§é‡ä½¿ç”¨äº†volatileå…³é”®å­—;<br>volatileå¯ä»¥å¯¹ç±»å±æ€§è¿›è¡Œä¿®é¥°, ä»è€Œç¡®ä¿çº¿ç¨‹æ¯æ¬¡éƒ½æ˜¯ä»ä¸»å­˜ä¸­è·å–å±æ€§, æ“ä½œå®Œæ¯•åå†™å›ä¸»å­˜.</p><a id="more"></a><h3 id="javaå†…å­˜æ¨¡å‹"><a href="#javaå†…å­˜æ¨¡å‹" class="headerlink" title="javaå†…å­˜æ¨¡å‹"></a>javaå†…å­˜æ¨¡å‹</h3><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="/resources/concurrent/volatile.png" width="800" hegiht="800" align=center /><p> åœ¨å¤šçº¿ç¨‹åŒæ—¶å¯¹å…±äº«å˜é‡è¿›è¡Œæ“ä½œè¿‡ç¨‹ä¸­, æ¯ä¸ªçº¿ç¨‹ä¼šæ‹·è´ä¸€ä»½å…±äº«å˜é‡åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­è¿›è¡Œç›¸å…³æ“ä½œ, æ“ä½œå®Œæ¯•åä¼šå°†ç»“æœå†™å…¥åˆ°ä¸»å­˜ä¸­.<br> è€Œvolatileå…³é”®å­—å¯ä»¥ä¿è¯æ“ä½œçš„å¯è§æ€§å’Œæœ‰åºæ€§, ä½†æ˜¯å´ä¸èƒ½ä¿è¯åŸå­æ€§.</p><h3 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h3><h4 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h4><p>æŒ‡ä¸€ä¸ªæ“ä½œæˆ–è€…å¤šä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œè¦ä¹ˆå…¨éƒ¨éƒ½ä¸æ‰§è¡Œ, æ“ä½œè¿‡ç¨‹æ•´ä½“æ˜¯ä¸€ä¸ªåŸå­, ä¸è¢«åˆ†å‰²æ‰“æ–­.</p><h4 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h4><p>å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶, ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼, å…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼.</p><h4 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h4><p>å³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œ<br>ä¸»è¦åŸå› æ˜¯å› ä¸ºå¤„ç†å™¨åœ¨å¤„ç†ç¨‹åºæ—¶ä¼šè¿›è¡ŒæŒ‡ä»¤é‡æ’, å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–, æŒ‡ä»¤é‡æ’åœ¨å•çº¿ç¨‹ä¸­å¾—åˆ°çš„ç»“æœæ˜¯ä¸€è‡´çš„, ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸­å°±ä¼šé€ æˆå„ç§é”™è¯¯.</p><h3 id="volatileå…³é”®å­—ä½œç”¨"><a href="#volatileå…³é”®å­—ä½œç”¨" class="headerlink" title="volatileå…³é”®å­—ä½œç”¨"></a>volatileå…³é”®å­—ä½œç”¨</h3><p>1.ä½¿ç”¨volatileå…³é”®å­—ä¿®é¥°çš„å˜é‡,ä¼šå¼ºåˆ¶å°†ä¿®æ”¹çš„å€¼å†™å…¥åˆ°ä¸»å­˜ä¸­<br>2.volatileä¸ä¿è¯åŸå­æ€§, åœ¨å¤šçº¿ç¨‹æ“ä½œä¸‹ä»…èƒ½ä¿è¯æ“ä½œåˆ«çš„çº¿ç¨‹å¯è§, åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹åŒæ—¶æ“ä½œå…±äº«å˜é‡ä¾ç„¶ä¼šæœ‰æ•°æ®ä¸æ­£ç¡®çš„æƒ…å†µ.<br>3.volatileä¼šé˜²æ­¢æŒ‡ä»¤é‡æ’</p>]]></content>
      
      
      <categories>
          
          <category> å¹¶å‘å’Œé” </category>
          
      </categories>
      
      
        <tags>
            
            <tag> volatile </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringAopä»£ç†çš„é€‰æ‹©</title>
      <link href="2018/05/21/springaop-agent-selection.html"/>
      <url>2018/05/21/springaop-agent-selection.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>SpringåŠ¨æ€åˆ›å»ºbeanè¿‡ç¨‹, æ˜¯å¦‚ä½•è¿›è¡Œé€‰æ‹©ä½¿ç”¨ jdkè¿˜æ˜¯cglibè¿›è¡Œä»£ç†çš„, å¯ä»¥é€šè¿‡æºç è¿›è¡Œè§£æ</p><h3 id="æ‰§è¡Œè¿‡ç¨‹"><a href="#æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="æ‰§è¡Œè¿‡ç¨‹"></a>æ‰§è¡Œè¿‡ç¨‹</h3><p>é€šè¿‡æ–­ç‚¹è¿›è¡Œè·Ÿè¸ªä¸»è¦æ‰§è¡Œè¿‡ç¨‹åœ¨ DefaultAopProxyFactory, é€šè¿‡åˆ¤æ–­æ¡ä»¶æ˜¯ä½¿ç”¨Cglibè¿˜æ˜¯Jdk</p><a id="more"></a><h3 id="ç›¸å…³æºç è§£æ"><a href="#ç›¸å…³æºç è§£æ" class="headerlink" title="ç›¸å…³æºç è§£æ"></a>ç›¸å…³æºç è§£æ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultAopProxyFactory</span> <span class="keyword">implements</span> <span class="title">AopProxyFactory</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AopProxy <span class="title">createAopProxy</span><span class="params">(AdvisedSupport config)</span> <span class="keyword">throws</span> AopConfigException </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ¡ä»¶ æ˜¯å¦ä¼˜åŒ–, è¿”å›æ˜¯å¦ç›´æ¥ä»£ç†ç›®æ ‡ç±»ä»¥åŠä»»ä½•æ¥å£æˆ–è€…æ²¡æœ‰ç”¨æˆ·æä¾›çš„ä»£ç†æ¥å£</span></span><br><span class="line"><span class="keyword">if</span> (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</span><br><span class="line">Class&lt;?&gt; targetClass = config.getTargetClass();</span><br><span class="line"><span class="keyword">if</span> (targetClass == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">&quot;TargetSource cannot determine target class: &quot;</span> +</span><br><span class="line"><span class="string">&quot;Either an interface or a target is required for proxy creation.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦æ˜¯æ¥å£, å’Œå·²ç»ä½¿ç”¨jdkä»£ç†</span></span><br><span class="line"><span class="keyword">if</span> (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ObjenesisCglibAopProxy(config);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Determine whether the supplied &#123;<span class="doctag">@link</span> AdvisedSupport&#125; has only the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.aop.SpringProxy&#125; interface specified</span></span><br><span class="line"><span class="comment"> * (or no proxy interfaces specified at all).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasNoUserSuppliedProxyInterfaces</span><span class="params">(AdvisedSupport config)</span> </span>&#123;</span><br><span class="line">Class&lt;?&gt;[] ifcs = config.getProxiedInterfaces();</span><br><span class="line"><span class="keyword">return</span> (ifcs.length == <span class="number">0</span> || (ifcs.length == <span class="number">1</span> &amp;&amp; SpringProxy.class.isAssignableFrom(ifcs[<span class="number">0</span>])));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> aop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cglibåŠ¨æ€ä»£ç†</title>
      <link href="2018/05/18/cglib-dynamic-proxy.html"/>
      <url>2018/05/18/cglib-dynamic-proxy.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>SpringåŠ¨æ€ä»£ç†å¯ä»¥é€‰æ‹©ä½¿ç”¨jdkåŠ¨æ€ä»£ç†, æˆ–è€…cglibåŠ¨æ€ä»£ç†,  cglibåŠ¨æ€ä»£ç†ä½äº net.sf.cglib.proxy åŒ…ä¸‹.</p><p>ä½¿ç”¨æ—¶æ¶‰åŠ<br>æ¥å£: net.sf.cglib.proxy.MethodInterceptor<br>ç”¨æ¥ç”ŸæˆåŠ¨æ€å­ç±»çš„ç±»ç±»: net.sf.cglib.proxy.Enhancer</p><p>æ³¨æ„: cglib åŠ¨æ€ä»£ç†æ˜¯åŸºäºç±»çš„ä»£ç†, æ˜¯é€šè¿‡å¯¹æŒ‡å®šçš„ä¸šåŠ¡ç±»ç”Ÿæˆä¸€ä¸ªå­ç±», å¹¶è¦†ç›–å…¶ä¸­ä¸šåŠ¡æ–¹æ³•å®ç°ä»£ç†. å› ä¸ºä½¿ç”¨ç»§æ‰¿, æ‰€ä»¥è¢«ä»£ç†ç±»ä¸èƒ½ä½¿ final ä¿®é¥°</p><a id="more"></a><h3 id="ä½¿ç”¨æ­¥éª¤"><a href="#ä½¿ç”¨æ­¥éª¤" class="headerlink" title="ä½¿ç”¨æ­¥éª¤"></a>ä½¿ç”¨æ­¥éª¤</h3><p>1.åˆ›å»ºMethodInterceptoræ¥å£çš„å®ç°ç±», å¹¶ç¼–å†™interceptæ–¹æ³•çš„å®ç°<br>2.é€šè¿‡methodProxy.invokeSuper(o, objects);è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•<br>3.åˆ›å»ºEnhancer, é€šè¿‡ setSuperclass(Class superclass)æ–¹æ³•æŒ‡å®šçˆ¶ç±»(è¢«ä»£ç†ç±»), é€šè¿‡ setCallback(final Callback callback)æ–¹æ³•æŒ‡å®šä»£ç†<br>4.enhancer.create() ç”Ÿæˆä»£ç†, è°ƒç”¨è¢«ä»£ç†ç±»çš„æ–¹æ³•</p><h3 id="ä»£ç æ¼”ç¤º"><a href="#ä»£ç æ¼”ç¤º" class="headerlink" title="ä»£ç æ¼”ç¤º"></a>ä»£ç æ¼”ç¤º</h3><p>æŒ‰ç…§æ­¥éª¤ç¼–å†™ç®€æ˜“é€»è¾‘ä»£ç .</p><h4 id="åˆ›å»ºMethodInterceptoræ¥å£çš„å®ç°ç±»"><a href="#åˆ›å»ºMethodInterceptoræ¥å£çš„å®ç°ç±»" class="headerlink" title="åˆ›å»ºMethodInterceptoræ¥å£çš„å®ç°ç±»"></a>åˆ›å»ºMethodInterceptoræ¥å£çš„å®ç°ç±»</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŸºäºç±»çš„ä»£ç† å³ä½¿ç±»æ²¡æœ‰å®ç°æ¥å£ä¹Ÿå¯ä»¥è¢«ä»£ç†</span></span><br><span class="line"><span class="comment"> * ä¸»è¦æ˜¯åŸºäºç±»ç”Ÿæˆä¸€ä¸ªç»§æ‰¿çš„å­ç±» æ‰€ä»¥ ç±»å’Œæ–¹æ³•ä¸è¦å£°æ˜ä¸º final</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/5/18 10:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMethodInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;cglibåŠ¨æ€ä»£ç† before . . .&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object invoke = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            invoke = methodProxy.invokeSuper(o, objects);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">            System.err.println(<span class="string">&quot;cglibåŠ¨æ€ä»£ç† error: &quot;</span> + throwable.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;cglibåŠ¨æ€ä»£ç† after . . .&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> invoke;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºEnhancer"><a href="#åˆ›å»ºEnhancer" class="headerlink" title="åˆ›å»ºEnhancer"></a>åˆ›å»ºEnhancer</h4><p>åˆ›å»ºEnhancer, é€šè¿‡ setSuperclass(Class superclass)æ–¹æ³•æŒ‡å®šçˆ¶ç±»(è¢«ä»£ç†ç±»), é€šè¿‡ setCallback(final Callback callback)æ–¹æ³•æŒ‡å®šä»£ç†</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibMainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">        enhancer.setSuperclass(SubjectCglib.class);</span><br><span class="line">        enhancer.setCallback(<span class="keyword">new</span> MyMethodInterceptor());</span><br><span class="line"></span><br><span class="line">        SubjectCglib subjectCglib = (SubjectCglib) enhancer.create();</span><br><span class="line"></span><br><span class="line">        System.err.println(subjectCglib.getAge(<span class="string">&quot;liuzhihang&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å¯ä»¥å°†äºŒè€…åˆå¹¶åˆ°MyInterceptorä¸­"><a href="#å¯ä»¥å°†äºŒè€…åˆå¹¶åˆ°MyInterceptorä¸­" class="headerlink" title="å¯ä»¥å°†äºŒè€…åˆå¹¶åˆ°MyInterceptorä¸­"></a>å¯ä»¥å°†äºŒè€…åˆå¹¶åˆ°MyInterceptorä¸­</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŸºäºç±»çš„ä»£ç† å³ä½¿ç±»æ²¡æœ‰å®ç°æ¥å£ä¹Ÿå¯ä»¥è¢«ä»£ç†</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/5/18 10:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCglibInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getInstance</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.object = object;</span><br><span class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">        enhancer.setSuperclass(object.getClass());</span><br><span class="line">        enhancer.setCallback(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;cglibåŠ¨æ€ä»£ç† before . . .&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object invoke = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            invoke = methodProxy.invokeSuper(o, objects);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">            System.err.println(<span class="string">&quot;cglibåŠ¨æ€ä»£ç† error: &quot;</span> + throwable.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;cglibåŠ¨æ€ä»£ç† after . . .&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> invoke;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> åŠ¨æ€ä»£ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jdkåŠ¨æ€ä»£ç†åŠæºç è§£æ</title>
      <link href="2018/05/17/jdk-dynamic-proxy-and-source-code-analysis.html"/>
      <url>2018/05/17/jdk-dynamic-proxy-and-source-code-analysis.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>SpringåŠ¨æ€ä»£ç†å¯ä»¥é€‰æ‹©ä½¿ç”¨jdkåŠ¨æ€ä»£ç†, æˆ–è€…cglibåŠ¨æ€ä»£ç†,  jdkåŠ¨æ€ä»£ç†ä½äº java.lang.reflect åŒ…ä¸‹.</p><p>ä½¿ç”¨æ—¶æ¶‰åŠ<br>æ¥å£: java.lang.reflect.InvocationHandler<br>åŠ¨æ€ä»£ç†ç±»: java.lang.reflect.Proxy</p><p>æ³¨æ„: JDK åŠ¨æ€ä»£ç†æ˜¯åŸºäºæ¥å£çš„ä»£ç†, åªèƒ½å¯¹å®ç°æ¥å£çš„ç±»ç”Ÿæˆä»£ç†, ä¸èƒ½å¯¹ç±»è¿›è¡Œä»£ç†</p><a id="more"></a><h3 id="ä½¿ç”¨æ­¥éª¤"><a href="#ä½¿ç”¨æ­¥éª¤" class="headerlink" title="ä½¿ç”¨æ­¥éª¤"></a>ä½¿ç”¨æ­¥éª¤</h3><p>1.åˆ›å»ºInvocationHandleræ¥å£çš„å®ç°ç±», å¹¶ç¼–å†™invokeæ–¹æ³•çš„å®ç°<br>2.åˆ›å»ºè¢«ä»£ç†ç±»çš„æ¥å£åŠå®ç°ç±»<br>3.ä½¿ç”¨åŠ¨æ€ä»£ç†ç±»Proxyçš„é™æ€æ–¹æ³•ç”Ÿæˆä»£ç†ç±»å®ä¾‹<br>4.ä½¿ç”¨å®ä¾‹è°ƒç”¨æ–¹æ³•</p><h3 id="ä»£ç æ¼”ç¤º"><a href="#ä»£ç æ¼”ç¤º" class="headerlink" title="ä»£ç æ¼”ç¤º"></a>ä»£ç æ¼”ç¤º</h3><p>æŒ‰ç…§æ­¥éª¤ç¼–å†™ç®€æ˜“é€»è¾‘ä»£ç .</p><h4 id="åˆ›å»ºInvocationHandleræ¥å£çš„å®ç°ç±»"><a href="#åˆ›å»ºInvocationHandleræ¥å£çš„å®ç°ç±»" class="headerlink" title="åˆ›å»ºInvocationHandleræ¥å£çš„å®ç°ç±»"></a>åˆ›å»ºInvocationHandleræ¥å£çš„å®ç°ç±»</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JDK åŠ¨æ€ä»£ç†</span></span><br><span class="line"><span class="comment"> * åŸºäºæ¥å£çš„ä»£ç†, åªèƒ½å¯¹å®ç°æ¥å£çš„ç±»ç”Ÿæˆä»£ç†, ä¸èƒ½å¯¹ç±»è¿›è¡Œä»£ç†</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/5/17 10:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›®æ ‡å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyInvocationHandler</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;jdk åŠ¨æ€ä»£ç† before . . . &quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;å½“å‰ä»£ç†æ–¹æ³•ä¸º:&quot;</span> + method);</span><br><span class="line">        Object invoke = method.invoke(target, args);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;jdk åŠ¨æ€ä»£ç† after . . . &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> invoke;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºè¢«ä»£ç†ç±»çš„æ¥å£åŠå®ç°ç±»"><a href="#åˆ›å»ºè¢«ä»£ç†ç±»çš„æ¥å£åŠå®ç°ç±»" class="headerlink" title="åˆ›å»ºè¢«ä»£ç†ç±»çš„æ¥å£åŠå®ç°ç±»"></a>åˆ›å»ºè¢«ä»£ç†ç±»çš„æ¥å£åŠå®ç°ç±»</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¢«ä»£ç†ç±»çš„æ¥å£</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/5/17 10:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–åå­—</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å¹´é¾„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getAge</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¢«ä»£ç†ç±»</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/5/17 10:48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectImpl</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SubjectImplçš„è·å–åå­—æ–¹æ³• . . .&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;liuzhihang&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAge</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(name + <span class="string">&quot;å¼€å§‹è·å–å¹´é¾„ . . .&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;25&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨åŠ¨æ€ä»£ç†ç±»Proxyçš„é™æ€æ–¹æ³•ç”Ÿæˆä»£ç†ç±»å®ä¾‹"><a href="#ä½¿ç”¨åŠ¨æ€ä»£ç†ç±»Proxyçš„é™æ€æ–¹æ³•ç”Ÿæˆä»£ç†ç±»å®ä¾‹" class="headerlink" title="ä½¿ç”¨åŠ¨æ€ä»£ç†ç±»Proxyçš„é™æ€æ–¹æ³•ç”Ÿæˆä»£ç†ç±»å®ä¾‹"></a>ä½¿ç”¨åŠ¨æ€ä»£ç†ç±»Proxyçš„é™æ€æ–¹æ³•ç”Ÿæˆä»£ç†ç±»å®ä¾‹</h4><p>è·å–ä»£ç†ç±»å®ä¾‹æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼, ä¸€ç§æ˜¯é€šè¿‡Proxy.newProxyInstance(..)è·å–,  ä¸€ç§æ˜¯é€šè¿‡ Proxy.getProxyClass(..) æ–¹å¼è·å–<br>1.Proxy.newProxyInstance(..)</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å½“ä»£ç†ç±»å®ä¾‹è°ƒç”¨æ–¹æ³•æ—¶, ä¼šè‡ªåŠ¨è·³è½¬åˆ°ä»£ç†ç±»å…³è”çš„ handler å¯¹è±¡, é€šè¿‡ method.invoke(target, args) è¿›è¡Œè°ƒç”¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/5/17 10:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyMainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Subject subject = <span class="keyword">new</span> SubjectImpl();</span><br><span class="line"></span><br><span class="line">        ClassLoader classLoader = subject.getClass().getClassLoader();</span><br><span class="line">        Class&lt;?&gt;[] interfaces = subject.getClass().getInterfaces();</span><br><span class="line"></span><br><span class="line">        MyInvocationHandler handler = <span class="keyword">new</span> MyInvocationHandler(subject);</span><br><span class="line">        <span class="comment">// ç”Ÿæˆä»£ç†ç±»å®ä¾‹</span></span><br><span class="line">        Subject proxyInstance = (Subject) Proxy.newProxyInstance(classLoader, interfaces, handler);</span><br><span class="line"></span><br><span class="line">        String name = proxyInstance.getName();</span><br><span class="line">        String instanceAge = proxyInstance.getAge(<span class="string">&quot;liuzhihang&quot;</span>);</span><br><span class="line">        System.err.println(name + <span class="string">&quot; &quot;</span> + instanceAge);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.Proxy.getProxyClass(..)</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å½“ä»£ç†ç±»å®ä¾‹è°ƒç”¨æ–¹æ³•æ—¶, ä¼šè‡ªåŠ¨è·³è½¬åˆ°ä»£ç†ç±»å…³è”çš„ handler å¯¹è±¡, é€šè¿‡ method.invoke(target, args) è¿›è¡Œè°ƒç”¨</span></span><br><span class="line"><span class="comment"> * æ­¤æ–¹å¼æœ‰å¼‚å¸¸æŠ›å‡º</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/5/17 10:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyMainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        Subject subject = <span class="keyword">new</span> SubjectImpl();</span><br><span class="line"></span><br><span class="line">        ClassLoader classLoader = subject.getClass().getClassLoader();</span><br><span class="line">        Class&lt;?&gt;[] interfaces = subject.getClass().getInterfaces();</span><br><span class="line"></span><br><span class="line">        MyInvocationHandler handler = <span class="keyword">new</span> MyInvocationHandler(subject);</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; proxyClass = Proxy.getProxyClass(classLoader, interfaces);</span><br><span class="line">            Constructor&lt;?&gt; constructor = proxyClass.getConstructor(InvocationHandler.class);</span><br><span class="line"></span><br><span class="line">            Subject subject1 = (Subject) constructor.newInstance(handler);</span><br><span class="line">            String name1 = subject1.getName();</span><br><span class="line">            String instanceAge1 = subject1.getAge(<span class="string">&quot;liuzhihang&quot;</span>);</span><br><span class="line">            System.err.println(name1 + <span class="string">&quot; &quot;</span> + instanceAge1);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException | IllegalAccessException | InvocationTargetException | InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œç»“æœ"><a href="#æ‰§è¡Œç»“æœ" class="headerlink" title="æ‰§è¡Œç»“æœ"></a>æ‰§è¡Œç»“æœ</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">D:\jdk1.8\bin\java.exe . . .</span><br><span class="line">liuzhihang 25</span><br><span class="line">jdk åŠ¨æ€ä»£ç† before . . .</span><br><span class="line">å½“å‰ä»£ç†æ–¹æ³•ä¸º:public abstract java.lang.String com.liuzhihang.tool.proxy.jdk.Subject.getName()</span><br><span class="line">SubjectImplçš„è·å–åå­—æ–¹æ³• . . .</span><br><span class="line">jdk åŠ¨æ€ä»£ç† after . . .</span><br><span class="line">jdk åŠ¨æ€ä»£ç† before . . .</span><br><span class="line">å½“å‰ä»£ç†æ–¹æ³•ä¸º:public abstract java.lang.String com.liuzhihang.tool.proxy.jdk.Subject.getAge(java.lang.String)</span><br><span class="line">liuzhihangå¼€å§‹è·å–å¹´é¾„ . . .</span><br><span class="line">jdk åŠ¨æ€ä»£ç† after . . .</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure><p>ç»“è®º: ä»£ç†å®ä¾‹åœ¨æ¯æ¬¡è°ƒç”¨æ–¹æ³•æ˜¯éƒ½ä¼šé€šè¿‡ä»£ç†ç±»è¿›è¡Œè°ƒç”¨</p><h3 id="ç›¸å…³æºç è§£æ"><a href="#ç›¸å…³æºç è§£æ" class="headerlink" title="ç›¸å…³æºç è§£æ"></a>ç›¸å…³æºç è§£æ</h3><p>å®Œæ•´æ³¨é‡Šå¯è‡ªå·±æŸ¥çœ‹ç›¸å…³æºç , æºç è¿‡ç¨‹åº”å½“DeBugå¤šèµ°èµ°.<br>1.è°ƒç”¨ Proxy.newProxyInstance æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> &#x2F;**</span><br><span class="line"> * è¿”å›æŒ‡å®šæ¥å£çš„ä»£ç†ç±»å®ä¾‹ï¼Œè¯¥æ¥å£å°†æ–¹æ³•è°ƒç”¨åˆ†æ´¾ç»™æŒ‡å®šçš„è°ƒç”¨å¤„ç†ç¨‹åº</span><br><span class="line"> *&#x2F;</span><br><span class="line">@CallerSensitive</span><br><span class="line">public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h) throws IllegalArgumentException &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; éç©ºæ ¡éªŒ</span><br><span class="line">    Objects.requireNonNull(h);</span><br><span class="line"></span><br><span class="line">    final Class&lt;?&gt;[] intfs &#x3D; interfaces.clone();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; è·å–ç³»ç»Ÿå®‰å…¨æ¥å£</span><br><span class="line">    final SecurityManager sm &#x3D; System.getSecurityManager();</span><br><span class="line">    if (sm !&#x3D; null) &#123;</span><br><span class="line">        &#x2F;&#x2F; æ ¡éªŒæƒé™</span><br><span class="line">        checkProxyAccess(Reflection.getCallerClass(), loader, intfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;*</span><br><span class="line">     * ä»ç¼“å­˜ä¸­è·å–ä»£ç†ç±» æˆ–è€… ç”Ÿæˆæ–°çš„ä»£ç†ç±»</span><br><span class="line">     *&#x2F;</span><br><span class="line">    Class&lt;?&gt; cl &#x3D; getProxyClass0(loader, intfs);</span><br><span class="line"></span><br><span class="line">    &#x2F;*</span><br><span class="line">     * é€šè¿‡åå°„è·å–æ„é€ å‡½æ•°å¯¹è±¡å¹¶ç”Ÿæˆä»£ç†ç±»å®ä¾‹</span><br><span class="line">     *&#x2F;</span><br><span class="line">    try &#123;</span><br><span class="line">        if (sm !&#x3D; null) &#123;</span><br><span class="line">            checkNewProxyPermission(Reflection.getCallerClass(), cl);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; è·å–æ„é€ </span><br><span class="line">        final Constructor&lt;?&gt; cons &#x3D; cl.getConstructor(constructorParams);</span><br><span class="line">        final InvocationHandler ih &#x3D; h;</span><br><span class="line">        &#x2F;&#x2F; éªŒè¯ä»£ç†ç±»çš„ä¿®é¥°ç¬¦</span><br><span class="line">        if (!Modifier.isPublic(cl.getModifiers())) &#123;</span><br><span class="line">            &#x2F;&#x2F; ä¿®æ”¹è®¿é—®æƒé™</span><br><span class="line">            AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">                public Void run() &#123;</span><br><span class="line">                    &#x2F;&#x2F; å°†æ­¤å¯¹è±¡çš„å¯è®¿é—®æ ‡å¿—è®¾ç½®ä¸ºæŒ‡å®šçš„å¸ƒå°”å€¼, trueè¡¨ç¤ºåå°„å¯¹è±¡åœ¨ä½¿ç”¨æ—¶åº”ç¦æ­¢Javaè¯­è¨€è®¿é—®æ£€æŸ¥, falseè¡¨ç¤ºåå°„å¯¹è±¡åº”å¼ºåˆ¶æ‰§è¡ŒJavaè¯­è¨€è®¿é—®æ£€æŸ¥</span><br><span class="line">                    cons.setAccessible(true);</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;ç”Ÿæˆå®ä¾‹, å¹¶å°†å‚æ•°ä¼ å…¥æ„é€ </span><br><span class="line">        return cons.newInstance(new Object[]&#123;h&#125;);</span><br><span class="line">    &#125; catch (IllegalAccessException | InstantiationException e) &#123;</span><br><span class="line">        throw new InternalError(e.toString(), e);</span><br><span class="line">    &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">        Throwable t &#x3D; e.getCause();</span><br><span class="line">        if (t instanceof RuntimeException) &#123;</span><br><span class="line">            throw (RuntimeException) t;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new InternalError(t.toString(), t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">        throw new InternalError(e.toString(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºè·å–ä»£ç†ç±»æ˜¯åœ¨ Class&lt;?&gt; cl = getProxyClass0(loader, intfs); å¤„, ç»§ç»­ç›¸å…³é€»è¾‘<br>2.è·å–ä»£ç†ç±»ç›¸å…³é€»è¾‘</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * ç”Ÿæˆä»£ç†ç±», ä¹‹å‰å¿…é¡»è¿›è¡Œæƒé™æ£€æŸ¥</span><br><span class="line"> *&#x2F;</span><br><span class="line">private static Class&lt;?&gt; getProxyClass0(ClassLoader loader,</span><br><span class="line">                                       Class&lt;?&gt;... interfaces) &#123;</span><br><span class="line">    if (interfaces.length &gt; 65535) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;interface limit exceeded&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;å¦‚æœç”±å®ç°ç»™å®šæ¥å£çš„ç»™å®šåŠ è½½å™¨å®šä¹‰çš„ä»£ç†ç±»å­˜åœ¨ï¼Œåˆ™å®ƒå°†ç®€å•åœ°è¿”å›ç¼“å­˜å‰¯æœ¬; å¦åˆ™ï¼Œå®ƒå°†é€šè¿‡Proxy Class Factoryåˆ›å»ºä»£ç†ç±»</span><br><span class="line">    return proxyClassCache.get(loader, interfaces);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.proxyClassCache.get(loader, interfaces);<br>java.lang.reflect.WeakCache#get(..) ä»‹ç»</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> &#x2F;**</span><br><span class="line"> * é€šè¿‡ç¼“å­˜æŸ¥æ‰¾å€¼, å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ç»™å®šçš„ï¼ˆkeyï¼Œsub Keyï¼‰å¯¹çš„æ¡ç›®æˆ–æ¡ç›®å·²è¢«æ¸…é™¤ï¼Œåˆ™å®ƒæ€»æ˜¯è¯„ä¼°&#123;Key sub Key Factory&#125;å‡½æ•°å¹¶å¯é€‰æ‹©è¯„ä¼°&#123;Factory value&#125;å‡½æ•°</span><br><span class="line"> *&#x2F;</span><br><span class="line">public V get(K key, P parameter) &#123;</span><br><span class="line">    &#x2F;&#x2F; éç©ºæ ¡éªŒ</span><br><span class="line">    Objects.requireNonNull(parameter);</span><br><span class="line">    &#x2F;&#x2F; åˆ¤æ–­ç§»é™¤é˜Ÿåˆ—</span><br><span class="line">    expungeStaleEntries();</span><br><span class="line">    &#x2F;&#x2F; ç¼“å­˜key</span><br><span class="line">    Object cacheKey &#x3D; CacheKey.valueOf(key, refQueue);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; å»¶è¿ŸåŠ è½½ä½¿ç”¨äºŒçº§map</span><br><span class="line">    ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap &#x3D; map.get(cacheKey);</span><br><span class="line">    if (valuesMap &#x3D;&#x3D; null) &#123;</span><br><span class="line">        ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; oldValuesMap</span><br><span class="line">                &#x3D; map.putIfAbsent(cacheKey,</span><br><span class="line">                valuesMap &#x3D; new ConcurrentHashMap&lt;&gt;());</span><br><span class="line">        if (oldValuesMap !&#x3D; null) &#123;</span><br><span class="line">            valuesMap &#x3D; oldValuesMap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; åˆ›å»ºå­key å¹¶æ ¹æ®key æ£€ç´¢supplier</span><br><span class="line">    Object subKey &#x3D; Objects.requireNonNull(subKeyFactory.apply(key, parameter));</span><br><span class="line">    &#x2F;&#x2F; æ ¹æ®keyè·å–supplier</span><br><span class="line">    Supplier&lt;V&gt; supplier &#x3D; valuesMap.get(subKey);</span><br><span class="line">    Factory factory &#x3D; null;</span><br><span class="line"></span><br><span class="line">    while (true) &#123;</span><br><span class="line">        if (supplier !&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; supplier å¯èƒ½ä¸º Factory æˆ–è€… CacheValue&lt;V&gt; çš„å®ä¾‹, ä»ç¼“å­˜ä¸­è·å–åˆ°åˆ™ç›´æ¥è¿”å›</span><br><span class="line">            V value &#x3D; supplier.get();</span><br><span class="line">            if (value !&#x3D; null) &#123;</span><br><span class="line">                return value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; factoryä¸å­˜åœ¨åˆ™åˆ›å»º</span><br><span class="line">        if (factory &#x3D;&#x3D; null) &#123;</span><br><span class="line">            factory &#x3D; new Factory(key, parameter, subKey, valuesMap);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; supplier ä¸ºnull</span><br><span class="line">        if (supplier &#x3D;&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; ä»valuesMapè·å–supplier</span><br><span class="line">            supplier &#x3D; valuesMap.putIfAbsent(subKey, factory);</span><br><span class="line">            if (supplier &#x3D;&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F; successfully installed Factory</span><br><span class="line">                supplier &#x3D; factory;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; else retry with winning supplier</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (valuesMap.replace(subKey, supplier, factory)) &#123;</span><br><span class="line">                &#x2F;&#x2F; successfully replaced</span><br><span class="line">                &#x2F;&#x2F; cleared CacheEntry &#x2F; unsuccessful Factory</span><br><span class="line">                &#x2F;&#x2F; with our Factory</span><br><span class="line">                supplier &#x3D; factory;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F; retry with current supplier</span><br><span class="line">                supplier &#x3D; valuesMap.get(subKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°é‡ç‚¹åœ¨ Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter)); è·å– subKey çš„è¿‡ç¨‹ä¸­.<br>4.subKeyFactory.apply(key, parameter)<br>Debugå‘ç°åœ¨æ­¤å¤„è°ƒç”¨çš„æ˜¯ java.lang.reflect.Proxy.ProxyClassFactory é™æ€å†…éƒ¨ç±»,<br>æ­¤å¤„æ ¹æ®æ¥å£çš„æ•°é‡ç”ŸæˆäºŒçº§ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸€ä¸ªå·¥å‚å‡½æ•°, ç”¨äºç”Ÿæˆ, å®šä¹‰å¹¶è¿”å›ç»™å®šClassLoaderå’Œæ¥å£æ•°ç»„çš„ä»£ç†ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyClassFactory</span></span></span><br><span class="line">        implements BiFunction&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ‰€æœ‰ä»£ç†ç±»çš„å‰ç¼€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String proxyClassNamePrefix = <span class="string">&quot;$Proxy&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// next number to use for generation of unique proxy class names</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong nextUniqueNumber = <span class="keyword">new</span> AtomicLong();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨IdentityHashMapä¸­, å½“ä¸”ä»…å½“ä¸¤ä¸ªkeyä¸¥æ ¼ç›¸ç­‰ï¼ˆkey1==key2ï¼‰æ—¶ï¼ŒIdentityHashMapæ‰è®¤ä¸ºä¸¤ä¸ªkeyç›¸ç­‰</span></span><br><span class="line">        Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = <span class="keyword">new</span> IdentityHashMap&lt;&gt;(interfaces.length);</span><br><span class="line">        <span class="comment">// å¾ªç¯æ¥å£æ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * éªŒè¯ç±»åŠ è½½å™¨æ˜¯å¦å°†æ­¤æ¥å£çš„åç§°è§£æä¸ºåŒä¸€ä¸ªClasså¯¹è±¡</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            Class&lt;?&gt; interfaceClass = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–æ¥å£çš„ class</span></span><br><span class="line">                interfaceClass = Class.forName(intf.getName(), <span class="keyword">false</span>, loader);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (interfaceClass != intf) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        intf + <span class="string">&quot; is not visible from class loader&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * éªŒè¯interfaceClassæ˜¯å¦ä¸ºæ¥å£</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (!interfaceClass.isInterface()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        interfaceClass.getName() + <span class="string">&quot; is not an interface&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * éªŒè¯æ¥å£æ˜¯å¦é‡å¤</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (interfaceSet.put(interfaceClass, Boolean.TRUE) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;repeated interface: &quot;</span> + interfaceClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String proxyPkg = <span class="keyword">null</span>;     <span class="comment">// package to define proxy class in</span></span><br><span class="line">        <span class="keyword">int</span> accessFlags = Modifier.PUBLIC | Modifier.FINAL;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * éªŒè¯æ‰€æœ‰éå…¬å¼€ä»£ç†æ¥å£æ˜¯å¦åœ¨åŒä¸€ä¸ªåŒ…ä¸­</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">            <span class="keyword">int</span> flags = intf.getModifiers();</span><br><span class="line">            <span class="keyword">if</span> (!Modifier.isPublic(flags)) &#123;</span><br><span class="line">                accessFlags = Modifier.FINAL;</span><br><span class="line">                String name = intf.getName();</span><br><span class="line">                <span class="keyword">int</span> n = name.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                String pkg = ((n == -<span class="number">1</span>) ? <span class="string">&quot;&quot;</span> : name.substring(<span class="number">0</span>, n + <span class="number">1</span>));</span><br><span class="line">                <span class="keyword">if</span> (proxyPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    proxyPkg = pkg;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pkg.equals(proxyPkg)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                            <span class="string">&quot;non-public interfaces from different packages&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxyPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰éå…¬å¼€çš„ä»£ç†æ¥å£ï¼Œä½¿ç”¨ com.sun.proxy package</span></span><br><span class="line">            proxyPkg = ReflectUtil.PROXY_PACKAGE + <span class="string">&quot;.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ä¸ºè¦ç”Ÿæˆçš„ä»£ç†ç±»é€‰æ‹©ä¸€ä¸ªåç§°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">long</span> num = nextUniqueNumber.getAndIncrement();</span><br><span class="line">        String proxyName = proxyPkg + proxyClassNamePrefix + num;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ç”Ÿæˆä»£ç†ç±»</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> defineClass0(loader, proxyName,</span><br><span class="line">                    proxyClassFile, <span class="number">0</span>, proxyClassFile.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * A ClassFormatError here means that (barring bugs in the</span></span><br><span class="line"><span class="comment">             * proxy class generation code) there was some other</span></span><br><span class="line"><span class="comment">             * invalid aspect of the arguments supplied to the proxy</span></span><br><span class="line"><span class="comment">             * class creation (such as virtual machine limitations</span></span><br><span class="line"><span class="comment">             * exceeded).</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5.ç”Ÿè¾°ç»™ä»£ç†ç±»<br>byte[] proxyClassFile = ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags);<br>å¯ä»¥åœ¨æµ‹è¯•ç±»ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹æ‰“å°å‡ºä»£ç†ç±»:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">System.setProperty(&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;, &quot;true&quot;);</span><br></pre></td></tr></table></figure><p>ä»£ç†ç±»å†…å®¹å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.sun.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.liuzhihang.tool.proxy.jdk.Subject;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m4;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler var1) <span class="keyword">throws</span>  &#123;</span><br><span class="line">        <span class="keyword">super</span>(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Boolean)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getName</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m2, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getAge</span><span class="params">(String var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m4, <span class="keyword">new</span> Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m0, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m1 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;equals&quot;</span>, Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>));</span><br><span class="line">            m3 = Class.forName(<span class="string">&quot;com.liuzhihang.tool.proxy.jdk.Subject&quot;</span>).getMethod(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">            m2 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;toString&quot;</span>);</span><br><span class="line">            m4 = Class.forName(<span class="string">&quot;com.liuzhihang.tool.proxy.jdk.Subject&quot;</span>).getMethod(<span class="string">&quot;getAge&quot;</span>, Class.forName(<span class="string">&quot;java.lang.String&quot;</span>));</span><br><span class="line">            m0 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(var2.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(var3.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºç”Ÿæˆçš„$Proxy0ç±»ç»§æ‰¿ProxyåŠ¨æ€ä»£ç†ç±»å¹¶å®ç°äº†Subjectè¢«ä»£ç†æ¥å£, å®ç°æ‰€æœ‰æ–¹æ³•<br>é€šè¿‡ super.h.invoke(this, m1, new Object[]{var1}) å†…éƒ¨è°ƒç”¨äº† InvocationHandler.invoke(â€¦)æ–¹æ³•, é€šè¿‡åå°„è°ƒç”¨ä»£ç†å®ä¾‹çš„æ–¹æ³•</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> åŠ¨æ€ä»£ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ‡’æ±‰å•ä¾‹æ¨¡å¼çº¿ç¨‹å®‰å…¨</title>
      <link href="2018/02/21/lazy-singleton-mode-thread-safe.html"/>
      <url>2018/02/21/lazy-singleton-mode-thread-safe.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>ä¸€ä¸ªç±»ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹, ä¸”èƒ½å¤Ÿè‡ªè¡Œå®ä¾‹åŒ–æä¾›è¿™ä¸ªå®ä¾‹, åŒæ—¶æä¾›å…¨å±€è®¿é—®çš„æ–¹æ³•.</p></blockquote><h3 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h3><p>1.æ„é€ ç§æœ‰åŒ–: ç¡®ä¿å¤–éƒ¨ä¸èƒ½ä½¿ç”¨newç›´æ¥åˆ›å»ºå¯¹è±¡<br>2.å†…éƒ¨é™æ€å±æ€§åˆ›å»ºå®ä¾‹<br>3.å¯¹å¤–å…¬å…±é™æ€è·å–å¯¹è±¡æ–¹æ³•</p><a id="more"></a><h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å•ä¾‹æ¨¡å¼</span></span><br><span class="line"><span class="comment"> * 1. æ„é€ ç§æœ‰åŒ–: ç¡®ä¿å¤–éƒ¨ä¸èƒ½ä½¿ç”¨newç›´æ¥åˆ›å»ºå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * 2. å†…éƒ¨é™æ€å±æ€§åˆ›å»ºå®ä¾‹</span></span><br><span class="line"><span class="comment"> * 3. å¯¹å¤–å…¬å…±é™æ€è·å–å¯¹è±¡æ–¹æ³•</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/3/27 17:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonPattern</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonPattern singletonPattern = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonPattern <span class="title">getSingletonPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (singletonPattern == <span class="keyword">null</span>) &#123;</span><br><span class="line">            singletonPattern = <span class="keyword">new</span> SingletonPattern();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> singletonPattern;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h3><p>1.æ‡’æ±‰å¼: æ‡’æ±‰æ¨¡å¼, é¡¹ç›®å¯åŠ¨æ—¶ä¸ç”Ÿæˆå¯¹è±¡, è€Œæ˜¯åœ¨é¦–æ¬¡åˆ›å»ºè¯¥å¯¹è±¡çš„æ—¶å€™ç”Ÿæˆå”¯ä¸€å®ä¾‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‡’æ±‰æ¨¡å¼, é¡¹ç›®å¯åŠ¨æ—¶ä¸ç”Ÿæˆå¯¹è±¡, è€Œæ˜¯åœ¨é¦–æ¬¡åˆ›å»ºè¯¥å¯¹è±¡çš„æ—¶å€™ç”Ÿæˆå”¯ä¸€å®ä¾‹</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/2 16:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyPattern</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazyPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazyPattern lazyPattern = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LazyPattern <span class="title">getLazyPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (lazyPattern == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ¨¡æ‹Ÿä¸€ç³»åˆ—è€—æ—¶æ“ä½œ</span></span><br><span class="line">                Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                lazyPattern = <span class="keyword">new</span> LazyPattern();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> lazyPattern;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.é¥¿æ±‰å¼: é¡¹ç›®å¯åŠ¨æ—¶, è¿›è¡ŒåŠ è½½, ä¼šå¯¼è‡´é¡¹ç›®å¯åŠ¨è¾ƒæ…¢, å¹¶ä¸”æ— è®ºåé¢æ˜¯å¦ç”¨åˆ°éƒ½ä¼šè¿›è¡ŒåŠ è½½</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * é¥¿æ±‰å¼å•ä¾‹æ¨¡å¼</span></span><br><span class="line"><span class="comment"> * é¡¹ç›®å¯åŠ¨æ—¶, è¿›è¡ŒåŠ è½½, ä¼šå¯¼è‡´é¡¹ç›®å¯åŠ¨è¾ƒæ…¢, å¹¶ä¸”æ— è®ºåé¢æ˜¯å¦ç”¨åˆ°éƒ½ä¼šè¿›è¡ŒåŠ è½½</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/2 18:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HungerPattern</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HungerPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HungerPattern hungerPattern = <span class="keyword">new</span> HungerPattern();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HungerPattern <span class="title">getHungerPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hungerPattern;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ç”¨ä¾‹"><a href="#æµ‹è¯•ç”¨ä¾‹" class="headerlink" title="æµ‹è¯•ç”¨ä¾‹"></a>æµ‹è¯•ç”¨ä¾‹</h3><p>åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹å¯¹å•ä¾‹æ¨¡å¼è¿›è¡Œæµ‹è¯•:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/3/27 19:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ThreadTest[] threadTests = <span class="keyword">new</span> ThreadTest[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threadTests.length; i++) &#123;</span><br><span class="line">            threadTests[i] = <span class="keyword">new</span> ThreadTest();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threadTests.length; i++) &#123;</span><br><span class="line">            threadTests[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadTest</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ‡’æ±‰æ¨¡å¼</span></span><br><span class="line">        System.out.println(LazyPattern.getLazyPattern().hashCode());</span><br><span class="line">        <span class="comment">// é¥¿æ±‰æ¨¡å¼</span></span><br><span class="line">        <span class="comment">// System.out.println(HungerPattern.getHungerPattern().hashCode());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœ:</p><p>1.é¥¿æ±‰æ¨¡å¼</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">D:\jdk1.8\bin\java.exe . . .</span><br><span class="line">1294123621</span><br><span class="line">1294123621</span><br><span class="line">1294123621</span><br><span class="line">1294123621</span><br><span class="line">1294123621</span><br><span class="line">1294123621</span><br><span class="line">1294123621</span><br><span class="line">1294123621</span><br><span class="line">1294123621</span><br><span class="line">1294123621</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure><p>2.æ‡’æ±‰æ¨¡å¼</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">D:\jdk1.8\bin\java.exe . . .</span><br><span class="line">140919816</span><br><span class="line">1359128134</span><br><span class="line">1385166630</span><br><span class="line">924507082</span><br><span class="line">67641385</span><br><span class="line">508832262</span><br><span class="line">574926395</span><br><span class="line">140919816</span><br><span class="line">1442414714</span><br><span class="line">896298396</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure><p>ç»“è®º: åœ¨æ‡’æ±‰å•ä¾‹æ¨¡å¼ä¸‹ä¸èƒ½ä¿è¯çº¿ç¨‹çš„å®‰å…¨æ€§</p><h3 id="æ‡’æ±‰æ¨¡å¼çš„çº¿ç¨‹å®‰å…¨ä¼˜åŒ–"><a href="#æ‡’æ±‰æ¨¡å¼çš„çº¿ç¨‹å®‰å…¨ä¼˜åŒ–" class="headerlink" title="æ‡’æ±‰æ¨¡å¼çš„çº¿ç¨‹å®‰å…¨ä¼˜åŒ–"></a>æ‡’æ±‰æ¨¡å¼çš„çº¿ç¨‹å®‰å…¨ä¼˜åŒ–</h3><p>é¥¿æ±‰æ¨¡å¼ä¼šé€ æˆèµ„æºæµªè´¹, å¯åŠ¨æ…¢ç­‰ç»“æœ, ä¸‹é¢å¯¹æ‡’æ±‰æ¨¡å¼è¿›è¡Œçº¿ç¨‹å®‰å…¨ä¼˜åŒ–.</p><h4 id="synchronized-é”ä½é™æ€æ–¹æ³•"><a href="#synchronized-é”ä½é™æ€æ–¹æ³•" class="headerlink" title="synchronized é”ä½é™æ€æ–¹æ³•"></a>synchronized é”ä½é™æ€æ–¹æ³•</h4><p>é”ä½é™æ€æ–¹æ³• ç±»çº§é” å½±å“èŒƒå›´è¾ƒå¤§, å¯¼è‡´æ•ˆç‡ç›¸å¯¹è¾ƒä½</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‡’æ±‰å¼</span></span><br><span class="line"><span class="comment"> * åœ¨æ–¹æ³•ä¸Šæ·»åŠ  synchronized å…³é”®å­— é”ç±»</span></span><br><span class="line"><span class="comment"> * åŒæ­¥æ–¹æ³•çš„æ–¹å¼, å¯¼è‡´æ•ˆç‡ç›¸å¯¹è¾ƒä½</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/3 14:27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncLazyPattern</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SyncLazyPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SyncLazyPattern syncLazyPattern = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> SyncLazyPattern <span class="title">getSyncLazyPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (syncLazyPattern == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                syncLazyPattern = <span class="keyword">new</span> SyncLazyPattern();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> syncLazyPattern;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="synchronized-é”ä½ä»£ç å—"><a href="#synchronized-é”ä½ä»£ç å—" class="headerlink" title="synchronized é”ä½ä»£ç å—"></a>synchronized é”ä½ä»£ç å—</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.demo.singleton;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é”ä»£ç å—çš„æ–¹å¼è™½ç„¶å¯ä»¥ä¿è¯ç»“æœä¸€è‡´æ€§</span></span><br><span class="line"><span class="comment"> * ä½†é”ä½å¾ˆå¤šæ“ä½œ, åŒæ ·ä¼šå¯¼è‡´æ•ˆç‡ä½ä¸‹</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/3 15:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncCodeBlockLazyPattern</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SyncCodeBlockLazyPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SyncCodeBlockLazyPattern syncCodeBlockLazyPattern = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SyncCodeBlockLazyPattern <span class="title">getSyncCodeBlockLazyPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é”ä½å…·ä½“æ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„ä»£ç </span></span><br><span class="line">            <span class="keyword">synchronized</span> (SyncCodeBlockLazyPattern.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (syncCodeBlockLazyPattern == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    syncCodeBlockLazyPattern = <span class="keyword">new</span> SyncCodeBlockLazyPattern();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> syncCodeBlockLazyPattern;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åŒé‡æ£€æŸ¥é”æœºåˆ¶-æ¨è"><a href="#åŒé‡æ£€æŸ¥é”æœºåˆ¶-æ¨è" class="headerlink" title="åŒé‡æ£€æŸ¥é”æœºåˆ¶(æ¨è)"></a>åŒé‡æ£€æŸ¥é”æœºåˆ¶(æ¨è)</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.demo.singleton;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŒé‡é”æ£€æŸ¥æœºåˆ¶, ä»…é”ä½åˆ›å»ºå¯¹è±¡çš„éƒ¨åˆ†ä»£ç </span></span><br><span class="line"><span class="comment"> * æ³¨æ„: åœ¨å¯¹è±¡å‰ æ·»åŠ  volatile å…³é”®å­— ç¡®ä¿å¯è§æ€§, å³ æ¯æ¬¡è·å–å€¼ä»ä¸»å†…å­˜ä¸­è·å–, åŒæ—¶é˜²æ­¢æŒ‡ä»¤é‡æ’åº</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/3 15:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboCheckLockLazyPattern</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DubboCheckLockLazyPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> DubboCheckLockLazyPattern dubboCheckLockLazyPattern = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DubboCheckLockLazyPattern <span class="title">getDubboCheckLockLazyPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (dubboCheckLockLazyPattern == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// ä¸€ç³»åˆ—æ“ä½œ</span></span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (DubboCheckLockLazyPattern.class) &#123;</span><br><span class="line">                    <span class="comment">// äºŒæ¬¡æ£€æŸ¥</span></span><br><span class="line">                    <span class="keyword">if</span> (dubboCheckLockLazyPattern == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        dubboCheckLockLazyPattern = <span class="keyword">new</span> DubboCheckLockLazyPattern();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dubboCheckLockLazyPattern;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
            <tag> å•ä¾‹æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>poiè¯»å†™Excelç®€å•ä»‹ç»</title>
      <link href="2018/02/15/poi-read-and-write-excel-brief-introduction.html"/>
      <url>2018/02/15/poi-read-and-write-excel-brief-introduction.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>Apache POI å¯ä»¥å¯¹Microsoft Office è¿›è¡Œæ“ä½œ, ä¸‹é¢æ˜¯å·¥ä½œä¸­ä½¿ç”¨çš„å¯¹Excelè¿›è¡Œè¯»å†™æ“ä½œçš„å¸¸ç”¨æ–¹å¼.</p></blockquote><h3 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- excel poi --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h3><p>ä¸»è¦ä»‹ç»è¯»å†™æ—¶, åˆ†åˆ«å¸¸ç”¨åˆ°çš„ä¸€äº›å¯¹è±¡åŠå…¶å«ä¹‰, æ–¹ä¾¿è‡ªå·±ç¼–å†™util.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.tool.excel.poi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.poi.hssf.usermodel.HSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Row;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Sheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Workbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFSheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/20 16:12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// readerTest();</span></span><br><span class="line">        writerTest();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writerTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">&quot;c:Users/liuzhihang/Desktop/test.xlsx&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è¯»å–çš„æ–‡ä»¶å­˜åœ¨!&quot;</span>);</span><br><span class="line">            file.delete();</span><br><span class="line">        &#125;</span><br><span class="line">        file.createNewFile();</span><br><span class="line">        <span class="comment">// æ“ä½œ .xls çš„ workbook</span></span><br><span class="line">        Workbook hssfWorkbook = <span class="keyword">new</span> HSSFWorkbook();</span><br><span class="line">        <span class="comment">// æ“ä½œ .xlsx çš„ workbook</span></span><br><span class="line">        XSSFWorkbook xssfWorkbook = <span class="keyword">new</span> XSSFWorkbook();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»º sheet é¡µ</span></span><br><span class="line">        XSSFSheet sheet = xssfWorkbook.createSheet();</span><br><span class="line">        <span class="comment">// åˆ›å»º 0 è¡Œ æ“ä½œå¯¹è±¡</span></span><br><span class="line">        Row row0 = sheet.createRow(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºå•å…ƒæ ¼å¹¶èµ‹å€¼</span></span><br><span class="line">        row0.createCell(<span class="number">0</span>).setCellValue(<span class="string">&quot;åºå·&quot;</span>);</span><br><span class="line"></span><br><span class="line">        OutputStream outputStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">        <span class="comment">// å†™å…¥æ–‡ä»¶</span></span><br><span class="line">        xssfWorkbook.write(outputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">readerTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">&quot;c:Users/liuzhihang/Desktop/parkingLotTempLate.xlsx&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Workbook workBook = ExcelUtil.getWorkBook(file);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å– excel é¡µ</span></span><br><span class="line">        <span class="comment">// Sheet sheetByIndex = workBook.getSheetAt(0);</span></span><br><span class="line">        <span class="comment">// Sheet sheetByName = workBook.getSheet(&quot;Sheet0&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ“ä½œ sheet</span></span><br><span class="line">        Sheet sheet = workBook.getSheetAt(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// è·å–æœ€åä¸€è¡Œè¡Œæ•° ä» 0 å¼€å§‹</span></span><br><span class="line">        <span class="keyword">int</span> lastRowNum = sheet.getLastRowNum();</span><br><span class="line">        <span class="comment">// è·å–æ€»è¡Œæ•°</span></span><br><span class="line">        <span class="keyword">int</span> physicalNumberOfRows = sheet.getPhysicalNumberOfRows();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ“ä½œè¡Œ è·å–ç¬¬0è¡Œ</span></span><br><span class="line">        Row row = sheet.getRow(<span class="number">0</span>);</span><br><span class="line">        String value = row.getCell(<span class="number">0</span>).getStringCellValue();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ExcelUtil-ç®€å•å·¥å…·"><a href="#ExcelUtil-ç®€å•å·¥å…·" class="headerlink" title="ExcelUtil ç®€å•å·¥å…·"></a>ExcelUtil ç®€å•å·¥å…·</h3><p>poiè¯»å†™ excel çš„ç®€å•å·¥å…· <a href="https://github.com/liuzhihang/my_project/blob/master/my_project_tool/src/main/java/com/liuzhihang/tool/excel/poi/ExcelUtil.java">ExcelUtil</a>, å®é™…å·¥ä½œä¸­å¯ç»“åˆjavaBeanä½¿ç”¨å¹¶é‡æ–°ç¼–å†™util.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.tool.excel.poi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.hssf.usermodel.HSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Cell;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Row;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Sheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Workbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/20 12:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯»å–ä¸¤åˆ—excel è¿”å›ç¬¬äºŒåˆ—çš„é›†åˆ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workbook</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">readExcelForTwoColumns</span><span class="params">(Workbook workbook)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workbook == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;è·å– workbook ä¸ºnull&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Sheet sheet = workbook.getSheetAt(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">//è·å–æ€»è¡Œæ•°</span></span><br><span class="line">            <span class="keyword">int</span> rowNum = sheet.getLastRowNum();</span><br><span class="line">            <span class="comment">//æ­£æ–‡å†…å®¹åº”è¯¥ä»ç¬¬äºŒè¡Œå¼€å§‹ï¼Œç¬¬ä¸€è¡Œä¸ºæ–‡ä»¶çš„æ ‡å¤´çš„æ ‡é¢˜</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rowNum; i++) &#123;</span><br><span class="line">                Row row = sheet.getRow(i + <span class="number">1</span>);</span><br><span class="line">                String value = getCellValue(row.getCell(<span class="number">1</span>)).toString();</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(value)) &#123;</span><br><span class="line">                    list.add(value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å†™ excel</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> excelFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writerExcelForTwoColumns</span><span class="params">(File excelFile, List&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        OutputStream outputStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            outputStream = <span class="keyword">new</span> FileOutputStream(excelFile);</span><br><span class="line"></span><br><span class="line">            Workbook workBook = <span class="keyword">null</span>;</span><br><span class="line">            String fileName = excelFile.getName();</span><br><span class="line">            <span class="keyword">if</span> (fileName.endsWith(<span class="string">&quot;.xls&quot;</span>)) &#123;</span><br><span class="line">                workBook = <span class="keyword">new</span> HSSFWorkbook();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fileName.endsWith(<span class="string">&quot;.xlsx&quot;</span>)) &#123;</span><br><span class="line">                workBook = <span class="keyword">new</span> XSSFWorkbook();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®!, å½“å‰æ–‡ä»¶å:&#123;&#125;&quot;</span>, fileName);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åˆ›å»ºç¬¬ 0 é¡µ</span></span><br><span class="line">            Sheet sheet = workBook.createSheet();</span><br><span class="line">            Row row1 = sheet.createRow(<span class="number">0</span>);</span><br><span class="line">            row1.createCell(<span class="number">0</span>).setCellValue(<span class="string">&quot;åºå·&quot;</span>);</span><br><span class="line">            row1.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;ç¼–å·&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">                Row row = sheet.createRow(i + <span class="number">1</span>);</span><br><span class="line">                row.createCell(<span class="number">0</span>).setCellValue(i + <span class="number">1</span>);</span><br><span class="line">                row.createCell(<span class="number">1</span>).setCellValue(list.get(i));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            workBook.write(outputStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å†™excelå¤±è´¥&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                outputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å·¥ä½œè¡¨</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Workbook <span class="title">getWorkBook</span><span class="params">(File file)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String fileName = file.getName();</span><br><span class="line">        Workbook workbook = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream inputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">            <span class="keyword">if</span> (fileName.endsWith(<span class="string">&quot;.xls&quot;</span>)) &#123;</span><br><span class="line">                workbook = <span class="keyword">new</span> HSSFWorkbook(inputStream);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fileName.endsWith(<span class="string">&quot;.xlsx&quot;</span>)) &#123;</span><br><span class="line">                workbook = <span class="keyword">new</span> XSSFWorkbook(inputStream);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®!, å½“å‰æ–‡ä»¶å:&#123;&#125;&quot;</span>, fileName);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> workbook;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å•å…ƒæ ¼çš„æ•°æ®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cell</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getCellValue</span><span class="params">(Cell cell)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cell != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (cell.getCellTypeEnum()) &#123;</span><br><span class="line">                <span class="comment">// æ•°å­—</span></span><br><span class="line">                <span class="keyword">case</span> NUMERIC:</span><br><span class="line">                    <span class="keyword">return</span> cell.getNumericCellValue();</span><br><span class="line">                <span class="comment">// å­—ç¬¦ä¸²</span></span><br><span class="line">                <span class="keyword">case</span> STRING:</span><br><span class="line">                    <span class="keyword">return</span> cell.getStringCellValue();</span><br><span class="line">                <span class="comment">// å…¬å¼</span></span><br><span class="line">                <span class="keyword">case</span> FORMULA:</span><br><span class="line">                    <span class="keyword">return</span> cell.getCellFormula();</span><br><span class="line">                <span class="comment">// å¸ƒå°”</span></span><br><span class="line">                <span class="keyword">case</span> BOOLEAN:</span><br><span class="line">                    <span class="keyword">return</span> cell.getBooleanCellValue();</span><br><span class="line">                <span class="keyword">case</span> ERROR:</span><br><span class="line">                    <span class="keyword">return</span> cell.getErrorCellValue();</span><br><span class="line">                <span class="comment">// ç©º</span></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> utils </category>
          
      </categories>
      
      
        <tags>
            
            <tag> poi </tag>
            
            <tag> excel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>protostuffåºåˆ—åŒ–å·¥å…·</title>
      <link href="2018/02/05/protostuff-serialization-tool.html"/>
      <url>2018/02/05/protostuff-serialization-tool.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>åœ¨å¾ˆå¤šåœ°æ–¹éƒ½éœ€è¦ç”¨åˆ°åºåˆ—åŒ–, æ¯”å¦‚åœ¨ä½¿ç”¨redisç¼“å­˜å¯¹è±¡æ—¶, ä¸€èˆ¬æƒ…å†µæ˜¯å®ç°java Serializableæ¥å£. ç®€å•ä»‹ç»ä¸‹åœ¨æ…•è¯¾ç½‘å­¦ä¹ åˆ°çš„ä¸€ä¸ªæ–°çš„åºåˆ—åŒ–å·¥å…· â€”- protostuff.</p><p>åœ¨å­¦ä¹ ä¸­ä»‹ç»ä½¿ç”¨è¯¥å·¥å…·å¯ä»¥å¤§å¤§å‡å°‘å¯¹è±¡åºåˆ—åŒ–åå­—èŠ‚æ‰€å ç©ºé—´, å¹¶æé«˜åºåˆ—åŒ–æ—¶é—´ç­‰.</p><p>1.<a href="https://www.imooc.com/video/11823">æ…•è¯¾ç½‘è¯¾ç¨‹åœ°å€</a><br>2.<a href="https://github.com/eishay/jvm-serializers/wiki">åºåˆ—åŒ–ç›¸å…³å·¥å…·æ¯”è¾ƒ</a></p><a id="more"></a><h3 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- protostuff åºåˆ—åŒ–å·¥å…· --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyuproject.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyuproject.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ç›¸å…³ä½¿ç”¨"><a href="#ç›¸å…³ä½¿ç”¨" class="headerlink" title="ç›¸å…³ä½¿ç”¨"></a>ç›¸å…³ä½¿ç”¨</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.dyuproject.protostuff.LinkedBuffer;</span><br><span class="line"><span class="keyword">import</span> com.dyuproject.protostuff.ProtostuffIOUtil;</span><br><span class="line"><span class="keyword">import</span> com.dyuproject.protostuff.runtime.RuntimeSchema;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/18 15:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtostuffUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">byte</span>[] serialize(T t, Class&lt;T&gt; cls) &#123;</span><br><span class="line"></span><br><span class="line">        RuntimeSchema&lt;T&gt; schema = RuntimeSchema.createFrom(cls);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ProtostuffIOUtil.toByteArray(t, schema, LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">unSerialize</span><span class="params">(<span class="keyword">byte</span>[] bytes, Class&lt;T&gt; cls)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        RuntimeSchema&lt;T&gt; schema = RuntimeSchema.createFrom(cls);</span><br><span class="line">        T message = schema.newMessage();</span><br><span class="line">        ProtostuffIOUtil.mergeFrom(bytes, message, schema);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/17 19:01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/17 19:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtostuffTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">&quot;test0001&quot;</span>);</span><br><span class="line">        user.setUserName(<span class="string">&quot;æµ‹è¯•ç”¨æˆ·0001&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(JSON.toJSONString(user));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] serialize = ProtostuffUtil.serialize(user, User.class);</span><br><span class="line"></span><br><span class="line">        User unSerialize = ProtostuffUtil.unSerialize(serialize, User.class);</span><br><span class="line"></span><br><span class="line">        System.err.println(JSON.toJSONString(unSerialize));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ç»“æœ:</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;test0001&quot;</span>,<span class="string">&quot;userName&quot;</span>:<span class="string">&quot;æµ‹è¯•ç”¨æˆ·0001&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;test0001&quot;</span>,<span class="string">&quot;userName&quot;</span>:<span class="string">&quot;æµ‹è¯•ç”¨æˆ·0001&quot;</span>&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> utils </category>
          
      </categories>
      
      
        <tags>
            
            <tag> utils </tag>
            
            <tag> serialize </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Transactionalå£°æ˜å¼äº‹åŠ¡</title>
      <link href="2018/01/27/transactional-declarative-transaction.html"/>
      <url>2018/01/27/transactional-declarative-transaction.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>1.å£°æ˜å¼äº‹åŠ¡ç®¡ç†å»ºç«‹åœ¨AOPä¹‹ä¸Šçš„. å…¶æœ¬è´¨æ˜¯å¯¹æ–¹æ³•å‰åè¿›è¡Œæ‹¦æˆª, ç„¶ååœ¨ç›®æ ‡æ–¹æ³•å¼€å§‹ä¹‹å‰åˆ›å»ºæˆ–è€…åŠ å…¥ä¸€ä¸ªäº‹åŠ¡, åœ¨æ‰§è¡Œå®Œç›®æ ‡æ–¹æ³•ä¹‹åæ ¹æ®æ‰§è¡Œæƒ…å†µæäº¤æˆ–è€…å›æ»šäº‹åŠ¡.<br>2.å£°æ˜å¼äº‹åŠ¡æœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯ä¸éœ€è¦é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼ç®¡ç†äº‹åŠ¡, è¿™æ ·å°±ä¸éœ€è¦åœ¨ä¸šåŠ¡é€»è¾‘ä»£ç ä¸­æºæ‚äº‹åŠ¡ç®¡ç†çš„ä»£ç , åªéœ€åœ¨é…ç½®æ–‡ä»¶ä¸­åšç›¸å…³çš„äº‹åŠ¡è§„åˆ™å£°æ˜(æˆ–é€šè¿‡åŸºäº@Transactionalæ³¨è§£çš„æ–¹å¼), ä¾¿å¯ä»¥å°†äº‹åŠ¡è§„åˆ™åº”ç”¨åˆ°ä¸šåŠ¡é€»è¾‘ä¸­.<br>3.å£°æ˜å¼äº‹åŠ¡ä¸è¶³çš„åœ°æ–¹åœ¨äº, ä¸ç¼–ç¨‹å¼äº‹åŠ¡ç›¸æ¯”, åªèƒ½ä½œç”¨åˆ°æ–¹æ³•çº§åˆ«, æ— æ³•åƒç¼–ç¨‹å¼äº‹åŠ¡é‚£æ ·å¯ä»¥ä½œç”¨åˆ°ä»£ç å—çº§åˆ«.</p><h3 id="xmlé…ç½®"><a href="#xmlé…ç½®" class="headerlink" title="xmlé…ç½®"></a>xmlé…ç½®</h3><p>1.æ·»åŠ å‘½åç©ºé—´</p><a id="more"></a><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>  <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">.</span> <span class="attr">.</span> <span class="attr">.</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="tag"><span class="string">        . . .</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx/spring-tx-3.0.xsd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2.æ·»åŠ ç›¸å…³äº‹åŠ¡æ”¯æŒ</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æŒ‡å‘æ•°æ®æº --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;masterDataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å¼€å¯äº‹åŠ¡çš„Annotationæ”¯æŒ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Transactionalæ³¨è§£-ä½¿ç”¨"><a href="#Transactionalæ³¨è§£-ä½¿ç”¨" class="headerlink" title="@Transactionalæ³¨è§£ ä½¿ç”¨"></a>@Transactionalæ³¨è§£ ä½¿ç”¨</h3><p>@Transactional å¯ä»¥ä½œç”¨äºæ¥å£,æ¥å£æ–¹æ³•,ç±»ä»¥åŠç±»æ–¹æ³•ä¸Š. åªéœ€è¦åœ¨ç›¸åº”æ¥å£,ç±»æˆ–æ–¹æ³•ä¸ŠåŠ ä¸Š@Transactionalæ³¨è§£å³å¯.</p><h3 id="Transactional-æ³¨è§£ä»‹ç»"><a href="#Transactional-æ³¨è§£ä»‹ç»" class="headerlink" title="@Transactional æ³¨è§£ä»‹ç»"></a>@Transactional æ³¨è§£ä»‹ç»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.transaction.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Inherited;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AliasFor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Isolation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;) : å¯ç”¨äºæ¥å£, ç±», æšä¸¾, æ³¨è§£, æ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Retention</span>(RetentionPolicy.RUNTIME) : æ³¨è§£ä¼šåœ¨classå­—èŠ‚ç æ–‡ä»¶ä¸­å­˜åœ¨ï¼Œåœ¨è¿è¡Œæ—¶å¯ä»¥é€šè¿‡åå°„è·å–åˆ°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Inherited</span> :ã€€å­ç±»å¯ä»¥ç»§æ‰¿çˆ¶ç±»ä¸­çš„æ³¨è§£</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Documented</span> : æ³¨è§£å°†è¢«åŒ…å«åœ¨javadocä¸­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Transactional &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * äº‹åŠ¡ç®¡ç†å™¨çš„åˆ«å</span></span><br><span class="line"><span class="comment">     * ç³»ç»ŸæŒ‡å®šå¤šä¸ªäº‹åŠ¡ç®¡ç†å™¨æ—¶å¯é€šè¿‡åˆ«åè¿›è¡ŒåŒºåˆ†</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor(&quot;transactionManager&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯é€šè¿‡åœ¨ transactionManager ä¸­è®¾ç½® &lt;qualifier value=&quot;managerOne&quot;/&gt; å±æ€§ç±»æŒ‡å®šåç§°</span></span><br><span class="line"><span class="comment">     * å¯ç”¨äºç¡®å®šç›®æ ‡äº‹åŠ¡ç®¡ç†å™¨ï¼ŒåŒ¹é…ç‰¹å®šçš„é™å®šç¬¦å€¼ï¼ˆæˆ–beanåç§°ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">transactionManager</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * äº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶</span></span><br><span class="line"><span class="comment">     * é»˜è®¤ Propagation.REQUIRED</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Propagation <span class="title">propagation</span><span class="params">()</span> <span class="keyword">default</span> Propagation.REQUIRED</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</span></span><br><span class="line"><span class="comment">     * é»˜è®¤ Isolation.DEFAULT</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Isolation <span class="title">isolation</span><span class="params">()</span> <span class="keyword">default</span> Isolation.DEFAULT</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * äº‹åŠ¡è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment">     * é»˜è®¤ TransactionDefinition.TIMEOUT_DEFAULT å³ -1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">timeout</span><span class="params">()</span> <span class="keyword">default</span> TransactionDefinition.TIMEOUT_DEFAULT</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®äº‹åŠ¡åªè¯»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">readOnly</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™è¿›è¡Œäº‹åŠ¡å›æ»š</span></span><br><span class="line"><span class="comment">     * rollbackFor = Exception.class æˆ– rollbackFor = &#123;RuntimeException.class, Exception.class&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] rollbackFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶, äº‹åŠ¡è¿›è¡Œå›æ»š</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] rollbackForClassName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®ä¸éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™ä¸è¿›è¡Œäº‹åŠ¡å›æ»š</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] noRollbackFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®ä¸éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶, äº‹åŠ¡ä¸è¿›è¡Œå›æ»š</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] noRollbackForClassName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¼ æ’­è¡Œä¸ºä»‹ç»"><a href="#ä¼ æ’­è¡Œä¸ºä»‹ç»" class="headerlink" title="ä¼ æ’­è¡Œä¸ºä»‹ç»"></a>ä¼ æ’­è¡Œä¸ºä»‹ç»</h3><p>äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º, ä¸€å…± 7 ç§<br>1.æšä¸¾ä»‹ç»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.transaction.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionDefinition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Propagation</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨, åˆ™åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡</span></span><br><span class="line"><span class="comment">     * äº‹åŠ¡çš„é»˜è®¤è®¾ç½®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    REQUIRED(TransactionDefinition.PROPAGATION_REQUIRED),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨, åˆ™ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SUPPORTS(TransactionDefinition.PROPAGATION_SUPPORTS),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    MANDATORY(TransactionDefinition.PROPAGATION_MANDATORY),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼€å§‹ä¸€ä¸ªæ–°çš„äº‹åŠ¡, å¹¶æš‚åœå½“å‰äº‹åŠ¡(å¦‚æœå­˜åœ¨)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    REQUIRES_NEW(TransactionDefinition.PROPAGATION_REQUIRES_NEW),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ, æš‚åœå½“å‰äº‹åŠ¡(å¦‚æœå­˜åœ¨)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    NOT_SUPPORTED(TransactionDefinition.PROPAGATION_NOT_SUPPORTED),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ, å¦‚æœå­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    NEVER(TransactionDefinition.PROPAGATION_NEVER),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨, åˆ™åœ¨åµŒå¥—äº‹åŠ¡ä¸­æ‰§è¡Œ.</span></span><br><span class="line"><span class="comment">     * å¦‚æœäº‹åŠ¡ä¸å­˜åœ¨, åˆ™ç­‰åŒäº PROPAGATION_REQUIRED</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    NESTED(TransactionDefinition.PROPAGATION_NESTED);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    Propagation(<span class="keyword">int</span> value) &#123; <span class="keyword">this</span>.value = value; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.value; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.åˆ—è¡¨</p><table><thead><tr><th>Propagation</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>REQUIRED</td><td>æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨, åˆ™åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡</td></tr><tr><td>SUPPORTS</td><td>æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨, åˆ™ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ</td></tr><tr><td>MANDATORY</td><td>æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td>REQUIRES_NEW</td><td>å¼€å§‹ä¸€ä¸ªæ–°çš„äº‹åŠ¡, å¹¶æš‚åœå½“å‰äº‹åŠ¡(å¦‚æœå­˜åœ¨)</td></tr><tr><td>NOT_SUPPORTED</td><td>ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ, æš‚åœå½“å‰äº‹åŠ¡(å¦‚æœå­˜åœ¨)</td></tr><tr><td>NEVER</td><td>ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ, å¦‚æœå­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td>NESTED</td><td>å¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨, åˆ™åœ¨åµŒå¥—äº‹åŠ¡ä¸­æ‰§è¡Œ. å¦‚æœäº‹åŠ¡ä¸å­˜åœ¨, åˆ™ç­‰åŒäº PROPAGATION_REQUIRED</td></tr></tbody></table><h3 id="éš”ç¦»çº§åˆ«ä»‹ç»"><a href="#éš”ç¦»çº§åˆ«ä»‹ç»" class="headerlink" title="éš”ç¦»çº§åˆ«ä»‹ç»"></a>éš”ç¦»çº§åˆ«ä»‹ç»</h3><p>1.æšä¸¾ä»‹ç»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.transaction.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionDefinition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Isolation</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨åº•å±‚æ•°æ®å­˜å‚¨é»˜è®¤çš„éš”ç¦»çº§åˆ«</span></span><br><span class="line"><span class="comment">     * ä¸€èˆ¬å­˜å‚¨åº•å±‚é»˜è®¤ä¸º: READ_COMMITTED</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DEFAULT(TransactionDefinition.ISOLATION_DEFAULT),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯»æœªæäº¤</span></span><br><span class="line"><span class="comment">     * ä¼šå‡ºç°è„è¯»å’Œä¸å¯é‡å¤è¯», ä¸€èˆ¬ä¸ä½¿ç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    READ_UNCOMMITTED(TransactionDefinition.ISOLATION_READ_UNCOMMITTED),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯»å·²æäº¤</span></span><br><span class="line"><span class="comment">     * è¯¥çº§åˆ«ä»…ç¦æ­¢äº‹åŠ¡è¯»å–å…¶ä¸­æœªæäº¤æ›´æ”¹çš„è¡Œ</span></span><br><span class="line"><span class="comment">     * å¯èƒ½ä¼šå‡ºç°ä¸å¯é‡å¤è¯»å–å’Œå¹»åƒè¯»å–</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    READ_COMMITTED(TransactionDefinition.ISOLATION_READ_COMMITTED),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯é‡å¤è¯»</span></span><br><span class="line"><span class="comment">     * ç¦æ­¢äº‹åŠ¡è¯»å–å…¶ä¸­æœ‰æœªæäº¤æ›´æ”¹çš„è¡Œ, å¹¶ä¸”è¿˜ç¦æ­¢ä¸€ä¸ªäº‹åŠ¡è¯»å–ä¸€è¡Œ, ç¬¬äºŒä¸ªäº‹åŠ¡æ›´æ”¹è¯¥è¡Œ. å¹¶ä¸”ç¬¬ä¸€ä¸ªäº‹åŠ¡é‡æ–°è¯»å–è¯¥è¡Œ, ç¬¬äºŒæ¬¡è·å–ä¸åŒå€¼çš„æƒ…å†µ</span></span><br><span class="line"><span class="comment">     * å³ ç¦æ­¢ è¯»æœªæäº¤, ä¸å¯é‡å¤è¯»</span></span><br><span class="line"><span class="comment">     * ä¼šå‡ºç°å¹»è¯»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    REPEATABLE_READ(TransactionDefinition.ISOLATION_REPEATABLE_READ),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸²è¡Œ</span></span><br><span class="line"><span class="comment">     * æ‰€æœ‰äº‹ç‰©ä¾æ¬¡æ‰§è¡Œ, ä¸ä¼šå½±å“åˆ«çš„äº‹åŠ¡, æ‰€ä»¥ä¼šé˜²æ­¢ ä¸å¯é‡å¤è¯» è„è¯» å¹»è¯»</span></span><br><span class="line"><span class="comment">     * ä¼šå½±å“æ€§èƒ½</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SERIALIZABLE(TransactionDefinition.ISOLATION_SERIALIZABLE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    Isolation(<span class="keyword">int</span> value) &#123; <span class="keyword">this</span>.value = value; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.value; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.åˆ—è¡¨</p><table><thead><tr><th>Isolation</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>DEFAULT</td><td>ä½¿ç”¨åº•å±‚æ•°æ®å­˜å‚¨é»˜è®¤çš„éš”ç¦»çº§åˆ«, ä¸€èˆ¬å­˜å‚¨åº•å±‚é»˜è®¤ä¸º: READ_COMMITTED</td></tr><tr><td>READ_UNCOMMITTED</td><td>è¯»æœªæäº¤, ä¼šå‡ºç°è„è¯»å’Œä¸å¯é‡å¤è¯», ä¸€èˆ¬ä¸ä½¿ç”¨</td></tr><tr><td>READ_COMMITTED</td><td>è¯¥çº§åˆ«ä»…ç¦æ­¢äº‹åŠ¡è¯»å–å…¶ä¸­æœªæäº¤æ›´æ”¹çš„è¡Œ. å¯èƒ½ä¼šå‡ºç°ä¸å¯é‡å¤è¯»å–å’Œå¹»åƒè¯»å–</td></tr><tr><td>REPEATABLE_READ</td><td>å¯é‡å¤è¯», ç¦æ­¢äº‹åŠ¡è¯»å–å…¶ä¸­æœ‰æœªæäº¤æ›´æ”¹çš„è¡Œ, å¹¶ä¸”è¿˜ç¦æ­¢ä¸€ä¸ªäº‹åŠ¡è¯»å–ä¸€è¡Œ, ç¬¬äºŒä¸ªäº‹åŠ¡æ›´æ”¹è¯¥è¡Œ. å¹¶ä¸”ç¬¬ä¸€ä¸ªäº‹åŠ¡é‡æ–°è¯»å–è¯¥è¡Œ, ç¬¬äºŒæ¬¡è·å–ä¸åŒå€¼çš„æƒ…å†µ. å³ ç¦æ­¢ è¯»æœªæäº¤, ä¸å¯é‡å¤è¯». ä¼šå‡ºç°å¹»è¯»</td></tr><tr><td>SERIALIZABLE</td><td>ä¸²è¡Œ, æ‰€æœ‰äº‹ç‰©ä¾æ¬¡æ‰§è¡Œ, ä¸ä¼šå½±å“åˆ«çš„äº‹åŠ¡, æ‰€ä»¥ä¼šé˜²æ­¢ ä¸å¯é‡å¤è¯» è„è¯» å¹»è¯». ä¼šå½±å“æ€§èƒ½</td></tr></tbody></table><p>3.è„è¯» å¹»è¯» ä¸å¯é‡å¤è¯»</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>è„è¯»</td><td>å½“ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨è®¿é—®æ•°æ®ï¼Œå¹¶ä¸”å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œè¿™ç§ä¿®æ”¹è¿˜æ²¡æœ‰æäº¤åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¿™ä¸ªæ•°æ®ï¼Œç„¶åä½¿ç”¨äº†è¿™ä¸ªæ•°æ®ã€‚</td></tr><tr><td>å¹»è¯»</td><td>äº‹åŠ¡è¯»å–æ—¶ä¸å­˜åœ¨è¯¥æ•°æ®, è¯»å–åå‘ç°è¯¥æ•°æ®å­˜åœ¨. ä¸­é—´å› ä¸ºåˆ«çš„äº‹åŠ¡åœ¨è¿›è¡Œæ’å…¥æ“ä½œ</td></tr><tr><td>ä¸å¯é‡å¤è¯»</td><td>ä¸€ä¸ªäº‹åŠ¡åœ¨è¯»å–è¯¥æ•°æ®æ—¶å¦ä¸€ä¸ªäº‹åŠ¡åœ¨ä¿®æ”¹è¯¥æ•°æ®, å¯¼è‡´å¤šæ¬¡è¯»å–æ•°æ®å†…å®¹ä¸ä¸€è‡´</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> transactional </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•´æ•°åŒ…è£…ç±»å‹çš„ç¼“å­˜</title>
      <link href="2018/01/15/integer-wrapper-type-cache.html"/>
      <url>2018/01/15/integer-wrapper-type-cache.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>éƒ¨åˆ†åŒ…è£…ç±»å‹å­˜åœ¨ç¼“å­˜æœºåˆ¶, ä¼šåœ¨JVMå¯åŠ¨æ—¶, ç¼“å­˜ä¸€å®šæ•°é‡çš„å¯¹è±¡, æœ‰åŠ©äºèŠ‚çœå†…å­˜, æé«˜æ€§èƒ½.</p></blockquote><h3 id="ç¼“å­˜åŒºé—´"><a href="#ç¼“å­˜åŒºé—´" class="headerlink" title="ç¼“å­˜åŒºé—´"></a>ç¼“å­˜åŒºé—´</h3><table><thead><tr><th>ç±»å‹</th><th>èŒƒå›´</th><th>æ˜¯å¦ä¿®æ”¹</th></tr></thead><tbody><tr><td>Integer</td><td>-128 åˆ° 127</td><td>true : -XX:AutoBoxCacheMax=size ä¿®æ”¹</td></tr><tr><td>ByteCache</td><td>-128 åˆ° 127</td><td>false</td></tr><tr><td>ShortCache</td><td>-128 åˆ° 127</td><td>false</td></tr><tr><td>LongCache</td><td>-128 åˆ° 127</td><td>false</td></tr><tr><td>CharacterCache</td><td>0 åˆ° 127</td><td>false</td></tr></tbody></table><a id="more"></a><h3 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Integer a = <span class="number">100</span>;</span><br><span class="line">Integer b = <span class="number">100</span>;</span><br><span class="line">Integer c = <span class="number">1000</span>;</span><br><span class="line">Integer d = <span class="number">1000</span>;</span><br><span class="line">Integer e = <span class="keyword">new</span> Integer(<span class="number">100</span>);</span><br><span class="line">Integer f = Integer.valueOf(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(a == b); <span class="comment">// true</span></span><br><span class="line">System.out.println(c == d); <span class="comment">// false</span></span><br><span class="line">System.out.println(a == e); <span class="comment">// false</span></span><br><span class="line">System.out.println(f == e); <span class="comment">// false</span></span><br><span class="line">System.out.println(a == f); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>== åœ¨æ¯”è¾ƒå¯¹è±¡æ—¶, åˆ¤æ–­æ˜¯å¦æŒ‡å‘åŒä¸€åœ°å€</p><p>a b f éƒ½æ˜¯ä»ç¼“å­˜ä¸­å–å‡ºæ•°æ®, æ‰€ä»¥åœ°å€æ˜¯ç›¸åŒçš„</p><p>c d ä¸åœ¨ç¼“å­˜èŒƒå›´å†…, æ‰€ä»¥æ˜¯æ–°çš„å¯¹è±¡</p><p>e æ˜¯æ–°å¯¹è±¡</p><h3 id="IntegerCache"><a href="#IntegerCache" class="headerlink" title="IntegerCache"></a>IntegerCache</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerCache</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> low = -<span class="number">128</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> high;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Integer cache[];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            <span class="comment">// high value may be configured by property</span></span><br><span class="line">            <span class="keyword">int</span> h = <span class="number">127</span>;</span><br><span class="line">            String integerCacheHighPropValue =</span><br><span class="line">                sun.misc.VM.getSavedProperty(<span class="string">&quot;java.lang.Integer.IntegerCache.high&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (integerCacheHighPropValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span> i = parseInt(integerCacheHighPropValue);</span><br><span class="line">                    i = Math.max(i, <span class="number">127</span>);</span><br><span class="line">                    <span class="comment">// Maximum array size is Integer.MAX_VALUE</span></span><br><span class="line">                    h = Math.min(i, Integer.MAX_VALUE - (-low) -<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span>( NumberFormatException nfe) &#123;</span><br><span class="line">                    <span class="comment">// If the property cannot be parsed into an int, ignore it.</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            high = h;</span><br><span class="line"></span><br><span class="line">            cache = <span class="keyword">new</span> Integer[(high - low) + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">int</span> j = low;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; cache.length; k++)</span><br><span class="line">                cache[k] = <span class="keyword">new</span> Integer(j++);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// range [-128, 127] must be interned (JLS7 5.1.7)</span></span><br><span class="line">            <span class="keyword">assert</span> IntegerCache.high &gt;= <span class="number">127</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">IntegerCache</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡è®¾ç½® java.lang.Integer.IntegerCache.high æ¥ä¿®æ”¹ç¼“å­˜çš„å€¼. æ–¹æ³•ä¸ºä¿®æ”¹ JVM çš„å¯åŠ¨å‚æ•° -XX:AutoBoxCacheMax=size</p>]]></content>
      
      
      <categories>
          
          <category> æºç å­¦ä¹  </category>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç å­¦ä¹  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Interceptoræ‹¦æˆªå™¨</title>
      <link href="2018/01/10/interceptor.html"/>
      <url>2018/01/10/interceptor.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>Interceptor: æ‹¦æˆªå™¨ï¼Œä½œç”¨ç±»ä¼¼ Filter, ä¸»è¦ä½œç”¨æ˜¯æ‹¦æˆªç”¨æˆ·è¯·æ±‚, åœ¨ Action æ‰§è¡Œçš„å‰åå„æ‰§è¡Œä¸€æ®µä»£ç , è¿›è¡Œç›¸åº”çš„ä¸šåŠ¡å¤„ç†.</p><h3 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h3><p>æƒé™è®¤è¯<br>ç»Ÿä¸€é€»è¾‘å¤„ç†<br>æ—¥å¿—ç›‘æ§ç­‰</p><a id="more"></a><h3 id="ä½¿ç”¨æ–¹å¼åŠæ–¹æ³•ä»‹ç»"><a href="#ä½¿ç”¨æ–¹å¼åŠæ–¹æ³•ä»‹ç»" class="headerlink" title="ä½¿ç”¨æ–¹å¼åŠæ–¹æ³•ä»‹ç»"></a>ä½¿ç”¨æ–¹å¼åŠæ–¹æ³•ä»‹ç»</h3><p>ä½¿ç”¨æ–¹å¼åˆ†ä¸ºä¸¤ç§, ä¸€ç§ä¸º: å®ç°HandlerInterceptoræ¥å£æˆ–è€…æ˜¯ç»§æ‰¿å®ç°äº†HandlerInterceptoræ¥å£çš„ç±», å¦ä¸€ç§ä¸º: å®ç°Springçš„WebRequestInterceptoræ¥å£, æˆ–è€…æ˜¯ç»§æ‰¿å®ç°äº†WebRequestInterceptorçš„ç±».<br>1.HandlerInterceptor ä»‹ç»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯·æ±‚å¤„ç†ä¹‹å‰è°ƒç”¨ é“¾å¼ ä¼šæŒ‰ç…§å£°æ˜é¡ºåºä¾æ¬¡æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">     * è¿”å› true åˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª Interceptor æ— åˆ™æ‰§è¡Œ Controller</span></span><br><span class="line"><span class="comment">     * è¿”å› false è¯·æ±‚ç»“æŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨è¯·æ±‚å¤„ç†ä¹‹åï¼ŒDispatcherServletè¿›è¡Œè§†å›¾è¿”å›æ¸²æŸ“ä¹‹å‰è¿›è¡Œè°ƒç”¨ï¼Œå¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å¯¹Controller å¤„ç†ä¹‹åçš„ModelAndView å¯¹è±¡è¿›è¡Œæ“ä½œã€‚</span></span><br><span class="line"><span class="comment">     * è°ƒåº¦ç¨‹åºServletåœ¨æ‰§è¡Œé“¾ä¸­å¤„ç†ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œç”±ä»»æ„æ•°é‡çš„æ‹¦æˆªå™¨ç»„æˆï¼Œå¤„ç†å™¨æœ¬èº«åœ¨æœ€åã€‚ ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæ¯ä¸ªæ‹¦æˆªå™¨å¯ä»¥åå¤„ç†ä¸€ä¸ªæ‰§è¡Œï¼Œå¹¶æŒ‰ç…§æ‰§è¡Œé“¾çš„ç›¸åé¡ºåºè¿›è¡Œåº”ç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯·æ±‚å¤„ç†å®Œæˆåçš„å›è°ƒï¼Œå³æ¸²æŸ“è§†å›¾åçš„å›è°ƒã€‚ å°†è¢«è°ƒç”¨å¤„ç†ç¨‹åºæ‰§è¡Œçš„ä»»ä½•ç»“æœï¼Œä»è€Œå…è®¸é€‚å½“çš„èµ„æºæ¸…ç†ã€‚</span></span><br><span class="line"><span class="comment">     * æ³¨æ„ï¼šåªæœ‰å½“è¿™ä¸ªæ‹¦æˆªå™¨çš„é¢„å¤„ç†æ–¹æ³•å·²ç»æˆåŠŸå®Œæˆå¹¶è¿”å›æ—¶æ‰ä¼šè¢«è°ƒç”¨</span></span><br><span class="line"><span class="comment">     * ä¸postHandleæ–¹æ³•ä¸€æ ·ï¼Œè¯¥æ–¹æ³•å°†ä»¥ç›¸åçš„é¡ºåºåœ¨é“¾ä¸­çš„æ¯ä¸ªæ‹¦æˆªå™¨ä¸Šè°ƒç”¨ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨å°†æˆä¸ºæœ€åè¢«è°ƒç”¨çš„æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.WebRequestInterceptor ä»‹ç»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.context.request;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.ModelMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.WebRequest;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WebRequestInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨è°ƒç”¨ä¹‹å‰æ‹¦æˆªè¯·æ±‚å¤„ç†ç¨‹åºçš„æ‰§è¡Œã€‚ å…è®¸å‡†å¤‡ä¸Šä¸‹æ–‡èµ„æºï¼ˆå¦‚Hibernate Sessionï¼‰å¹¶å°†å®ƒä»¬å…¬å¼€ä¸ºè¯·æ±‚å±æ€§æˆ–çº¿ç¨‹æœ¬åœ°å¯¹è±¡.</span></span><br><span class="line"><span class="comment">     * å³ å‡†å¤‡ä¸€äº›éœ€è¦çš„èµ„æº, ä¾‹å¦‚, å°†è¯·æ±‚å±æ€§æ”¾ç½®åˆ° WebRequest ä¸­</span></span><br><span class="line"><span class="comment">     * æ— è¿”å›å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preHandle</span><span class="params">(WebRequest request)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨è§†å›¾å‘ˆç°å‰ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰åœ¨æˆåŠŸè°ƒç”¨ä¹‹åæ‹¦æˆªè¯·æ±‚å¤„ç†ç¨‹åºçš„æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment">     * å…è®¸åœ¨æˆåŠŸå¤„ç†ç¨‹åºæ‰§è¡Œåä¿®æ”¹ä¸Šä¸‹æ–‡èµ„æºï¼ˆä¾‹å¦‚ï¼Œåˆ·æ–°ä¼‘çœ ä¼šè¯ï¼‰</span></span><br><span class="line"><span class="comment">     * å¯ä»¥é€šè¿‡ä¿®æ”¹ ModelMap çš„å±æ€§æ¥æ”¹å˜ä½ è¿”å›çš„è¯•å›¾æ¨¡å‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(WebRequest request, ModelMap model)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ±‚å¤„ç†å®Œæˆåçš„å›è°ƒï¼Œå³æ¸²æŸ“è§†å›¾åçš„å›è°ƒã€‚ å°†è¢«è°ƒç”¨å¤„ç†ç¨‹åºæ‰§è¡Œçš„ä»»ä½•ç»“æœï¼Œä»è€Œå…è®¸é€‚å½“çš„èµ„æºæ¸…ç†ã€‚</span></span><br><span class="line"><span class="comment">     * æ³¨æ„ï¼šåªæœ‰åœ¨æ‹¦æˆªå™¨çš„é¢„å¤„ç†æ–¹æ³•æˆåŠŸå®Œæˆæ—¶æ‰ä¼šè°ƒç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(WebRequest request, Exception ex)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="xml-é…ç½®"><a href="#xml-é…ç½®" class="headerlink" title="xml é…ç½®"></a>xml é…ç½®</h3><p>1.åœ¨ *-servlet.xml ä¸­æ·»åŠ  MVC schema</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;</span><br><span class="line">xsi:schemaLocation=&quot; http://www.springframework.org/schema/mvc</span><br><span class="line">http://www.springframework.org/schema/mvc/spring-mvc-3.0.xsd&quot;</span><br></pre></td></tr></table></figure><p>2.é…ç½® mvc:interceptors æ ‡ç­¾</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- æ‹¦æˆªè·¯å¾„ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- æŒ‡å®šæ‹¦æˆªå™¨ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.liuzhihang.myprojext.controller.interceptor.RequestInterceptor&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.myprojext.controller.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// å¤„ç†é€»è¾‘</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> interceptor </tag>
            
            <tag> servlet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>utilså·¥å…·--ValidationUtil å‚æ•°æ ¡éªŒ</title>
      <link href="2017/12/30/utils-tool-validationutil-parameter-check.html"/>
      <url>2017/12/30/utils-tool-validationutil-parameter-check.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>åœ¨å·¥ä½œä¸­ä¸å¯é¿å…çš„è¦é¢å¯¹å¾ˆå¤šå‚æ•°æ ¡éªŒ, æ¯”å¦‚å†™æ–°æ¥å£æ—¶éœ€è¦å¯¹ä¼ å…¥VOçš„å¿…è¦å­—æ®µè¿›è¡Œæ ¡éªŒ, String æ˜¯å¦ä¸ºç©º, Integer æœ€å°å€¼, å¯¹è±¡æ˜¯å¦ä¸ºnull, ç­‰ç­‰.<br>è€Œä½¿ç”¨ hibernateçš„validatorå·¥å…·å¯¹å‚æ•°è¿›è¡Œæ ¡éªŒ, å¯ä»¥æå¤§çš„ç®€åŒ–æµç¨‹, å½“ç„¶ä¸å¯é¿å…çš„å°±æ˜¯éœ€è¦åœ¨è¢«æ ¡éªŒå­—æ®µä¸ŠåŠ ä¸Šæ³¨è§£ä¿¡æ¯.</p><h6 id="1-ç›¸å…³ä¾èµ–"><a href="#1-ç›¸å…³ä¾èµ–" class="headerlink" title="1. ç›¸å…³ä¾èµ–"></a>1. ç›¸å…³ä¾èµ–</h6><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- å‚æ•°æ ¡éªŒå·¥å…· --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.4.2.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.glassfish.web<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>el-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h6 id="2-ValidationUtil"><a href="#2-ValidationUtil" class="headerlink" title="2. ValidationUtil"></a>2. ValidationUtil</h6><p>å¯¹åŠ ä¸Šç›¸å…³æ³¨è§£å­—æ®µè¿›è¡Œæ ¡éªŒ, ä½¿ç”¨åˆ° <a href="https://github.com/liuzhihang/tool_demo/blob/master/src/main/java/com/liuzhihang/tool/xml/JaxbUtil.java">ValidationUtil.java</a>å’Œ<a href="https://github.com/liuzhihang/tool_demo/blob/master/src/main/java/com/liuzhihang/tool/validate/ValidationResult.java">ValidationResult.java</a>ä¸¤ä¸ªæ–‡ä»¶, ä¹Ÿå¯åœ¨å·¥å…·ä¸­ç›´æ¥æŠ›å‡ºå¼‚å¸¸.</p><p>ValidationUtil å†…å®¹å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.tool.validate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintViolation;</span><br><span class="line"><span class="keyword">import</span> javax.validation.Validation;</span><br><span class="line"><span class="keyword">import</span> javax.validation.Validator;</span><br><span class="line"><span class="keyword">import</span> java.beans.IntrospectionException;</span><br><span class="line"><span class="keyword">import</span> java.beans.Introspector;</span><br><span class="line"><span class="keyword">import</span> java.beans.PropertyDescriptor;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹æ·»åŠ  hibernate.validator æ³¨è§£çš„å­—æ®µè¿›è¡Œæ ¡éªŒ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨å‰ éœ€è¦å¼•å…¥ hibernate-validator ä¾èµ–</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/22 11:08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidationUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Validator validator = Validation.buildDefaultValidatorFactory().getValidator();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¼š éªŒè¯ æ‰€æœ‰å­—æ®µ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›æ‰€æœ‰ä¸ç¬¦åˆçš„ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ValidationResult <span class="title">validateAllField</span><span class="params">(T obj)</span> </span>&#123;</span><br><span class="line">        ValidationResult result = <span class="keyword">new</span> ValidationResult(<span class="keyword">true</span>);</span><br><span class="line">        StringBuilder errorMsg = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            result.setHasPass(<span class="keyword">false</span>);</span><br><span class="line">            result.setErrorMsg(<span class="string">&quot;The class is null!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Set&lt;ConstraintViolation&lt;T&gt;&gt; violationSet = validator.validate(obj);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(violationSet)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (ConstraintViolation&lt;T&gt; violation : violationSet) &#123;</span><br><span class="line">                errorMsg.append(violation.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            result.setHasPass(<span class="keyword">false</span>);</span><br><span class="line">            result.setErrorMsg(errorMsg.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éªŒè¯æŒ‡å®šå­—æ®µ æ˜¯å¦ç¬¦åˆä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fieldName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ValidationResult <span class="title">validateOneField</span><span class="params">(T obj, String fieldName)</span> </span>&#123;</span><br><span class="line">        ValidationResult result = <span class="keyword">new</span> ValidationResult(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            result.setHasPass(<span class="keyword">false</span>);</span><br><span class="line">            result.setErrorMsg(<span class="string">&quot;The class is null!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        Set&lt;ConstraintViolation&lt;T&gt;&gt; violationSet = validator.validateProperty(obj, fieldName);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(violationSet)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (ConstraintViolation&lt;T&gt; violation : violationSet) &#123;</span><br><span class="line">                result.setHasPass(<span class="keyword">false</span>);</span><br><span class="line">                result.setErrorMsg(violation.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éªŒè¯ æ‰€æœ‰å­—æ®µ, å½“ç¬¬ä¸€ä¸ªä¸ç¬¦åˆæ—¶ åˆ™ç›´æ¥è¿”å›ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ValidationResult <span class="title">validateAllFieldForOneBack</span><span class="params">(T obj)</span> </span>&#123;</span><br><span class="line">        ValidationResult result = <span class="keyword">new</span> ValidationResult(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            result.setHasPass(<span class="keyword">false</span>);</span><br><span class="line">            result.setErrorMsg(<span class="string">&quot;The class is null!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PropertyDescriptor[] propertyDescriptors = Introspector.getBeanInfo(obj.getClass()).getPropertyDescriptors();</span><br><span class="line">            <span class="keyword">for</span> (PropertyDescriptor propertyDescriptor : propertyDescriptors) &#123;</span><br><span class="line">                result = validateOneField(obj, propertyDescriptor.getName());</span><br><span class="line">                <span class="keyword">if</span> (result.getHasPass()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IntrospectionException e) &#123;</span><br><span class="line">            result.setHasPass(<span class="keyword">false</span>);</span><br><span class="line">            result.setErrorMsg(<span class="string">&quot;This validate has error : &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ValidationResult å†…å®¹å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.tool.validate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2018/1/6 17:57</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidationResult</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Boolean hasPass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String errorMsg;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ValidationResult</span><span class="params">(Boolean hasPass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.hasPass = hasPass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">getHasPass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hasPass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHasPass</span><span class="params">(Boolean hasPass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.hasPass = hasPass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getErrorMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> errorMsg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorMsg</span><span class="params">(String errorMsg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errorMsg = errorMsg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ValidationResult&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;hasPass=&quot;</span> + hasPass +</span><br><span class="line">                <span class="string">&quot;, errorMsg=&#x27;&quot;</span> + errorMsg + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="3-å¸¸ç”¨æ³¨è§£"><a href="#3-å¸¸ç”¨æ³¨è§£" class="headerlink" title="3. å¸¸ç”¨æ³¨è§£"></a>3. å¸¸ç”¨æ³¨è§£</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Bean Validation ä¸­å†…ç½®çš„ constraint</span><br><span class="line">@Null   è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º null</span><br><span class="line">@NotNull    è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸ä¸º null</span><br><span class="line">@AssertTrue     è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º true</span><br><span class="line">@AssertFalse    è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º false</span><br><span class="line">@Min(value)     è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼</span><br><span class="line">@Max(value)     è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼</span><br><span class="line">@DecimalMin(value)  è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼</span><br><span class="line">@DecimalMax(value)  è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼</span><br><span class="line">@Size(max&#x3D;, min&#x3D;)   è¢«æ³¨é‡Šçš„å…ƒç´ çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†…</span><br><span class="line">@Digits (integer, fraction)     è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»åœ¨å¯æ¥å—çš„èŒƒå›´å†…</span><br><span class="line">@Past   è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªè¿‡å»çš„æ—¥æœŸ</span><br><span class="line">@Future     è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªå°†æ¥çš„æ—¥æœŸ</span><br><span class="line">@Pattern(regex&#x3D;,flag&#x3D;)  è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ç¬¦åˆæŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼</span><br><span class="line"></span><br><span class="line">Hibernate Validator é™„åŠ çš„ constraint</span><br><span class="line">@NotBlank(message &#x3D;)   éªŒè¯å­—ç¬¦ä¸²énullï¼Œä¸”é•¿åº¦å¿…é¡»å¤§äº0</span><br><span class="line">@Email  è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ç”µå­é‚®ç®±åœ°å€</span><br><span class="line">@Length(min&#x3D;,max&#x3D;)  è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†…</span><br><span class="line">@NotEmpty   è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¿…é¡»éç©º</span><br><span class="line">@Range(min&#x3D;,max&#x3D;,message&#x3D;)  è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»åœ¨åˆé€‚çš„èŒƒå›´å†…</span><br></pre></td></tr></table></figure><h6 id="4-æµ‹è¯•ç¤ºä¾‹"><a href="#4-æµ‹è¯•ç¤ºä¾‹" class="headerlink" title="4 æµ‹è¯•ç¤ºä¾‹"></a>4 æµ‹è¯•ç¤ºä¾‹</h6><p><a href="https://github.com/liuzhihang/tool_demo/blob/master/src/main/java/com/liuzhihang/tool/validate/ValidationVo.java">ä»£ç </a>:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.tool.validate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.validator.constraints.NotBlank;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.validator.constraints.NotEmpty;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Min;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/22 18:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidationVo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;The name must notEmpty!&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;The age must notNull!&quot;)</span></span><br><span class="line">    <span class="meta">@Min(value = 1, message = &quot;The age must greater than 0!&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ValidationVo validationVo = <span class="keyword">new</span> ValidationVo();</span><br><span class="line">        System.out.println(ValidationUtil.validateAllField(validationVo).toString());</span><br><span class="line">        validationVo.setAge(<span class="number">1</span>);</span><br><span class="line">        System.out.println(ValidationUtil.validateAllField(validationVo).toString());</span><br><span class="line">        validationVo.setName(<span class="string">&quot;äºŒè›‹&quot;</span>);</span><br><span class="line">        System.out.println(ValidationUtil.validateAllField(validationVo).toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ValidationResult&#123;hasPass&#x3D;false, errorMsg&#x3D;&#39;The name must notEmpty!The age must notNull!&#39;&#125;</span><br><span class="line">ValidationResult&#123;hasPass&#x3D;false, errorMsg&#x3D;&#39;The name must notEmpty!&#39;&#125;</span><br><span class="line">ValidationResult&#123;hasPass&#x3D;true, errorMsg&#x3D;&#39;null&#39;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> utils </category>
          
      </categories>
      
      
        <tags>
            
            <tag> utils </tag>
            
            <tag> validation </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xmlè§£æ--dom4j</title>
      <link href="2017/12/30/xml-parsing-dom4j.html"/>
      <url>2017/12/30/xml-parsing-dom4j.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>åœ¨å·¥ä½œä¸­æœ‰æ—¶å€™ä¼šç”¨åˆ°dom4jå¯¹xmlæ–‡ä»¶æˆ–è€…å­—ç¬¦ä¸²è¿›è¡Œè§£æ, ä»¥ä¸‹å†…å®¹ä¸ºéšæ‰‹ç¬”è®°, é˜²æ­¢ä»¥åé—å¿˜.</p><h5 id="1-ç›¸å…³ä¾èµ–"><a href="#1-ç›¸å…³ä¾èµ–" class="headerlink" title="1. ç›¸å…³ä¾èµ–"></a>1. ç›¸å…³ä¾èµ–</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- dom4j --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dom4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dom4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h5 id="2-è·å–domå¯¹è±¡"><a href="#2-è·å–domå¯¹è±¡" class="headerlink" title="2. è·å–domå¯¹è±¡"></a>2. è·å–domå¯¹è±¡</h5><p>è·å–domå¯¹è±¡æ–¹å¼ä¸»è¦ä»¥ä¸‹å‡ ç§:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¯»å– xml æ–‡ä»¶ æ–¹å¼</span></span><br><span class="line">SAXReader reader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">Document doc1 = reader.read(<span class="keyword">new</span> File(<span class="string">&quot;src/main/java/com/liuzhihang/tool/xml/alipay.xml&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£æ xml æ–‡æœ¬ æ–¹å¼</span></span><br><span class="line">String aliPayStr = XmlTest.getAliPayStr();</span><br><span class="line">Document doc2 = DocumentHelper.parseText(aliPayStr);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸»åŠ¨åˆ›å»º</span></span><br><span class="line">Document doc3 = DocumentHelper.createDocument();</span><br><span class="line">Element element = doc3.addElement(<span class="string">&quot;Test&quot;</span>);</span><br></pre></td></tr></table></figure><h6 id="3-æ“ä½œdomå¯¹è±¡"><a href="#3-æ“ä½œdomå¯¹è±¡" class="headerlink" title="3. æ“ä½œdomå¯¹è±¡"></a>3. æ“ä½œdomå¯¹è±¡</h6><p>å½“è·å–åˆ°domå¯¹è±¡åä¾¿å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯¹domè¿›è¡Œæ“ä½œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–æ ¹èŠ‚ç‚¹</span></span><br><span class="line">Element rootElement = dom.getRootElement();</span><br><span class="line"><span class="comment">// System.out.println(rootElement.getName());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å­èŠ‚ç‚¹</span></span><br><span class="line">Element element = rootElement.element(<span class="string">&quot;response&quot;</span>).element(<span class="string">&quot;alipay&quot;</span>);</span><br><span class="line"><span class="comment">// System.out.println(element.asXML());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–èŠ‚ç‚¹çš„æ–‡å­—</span></span><br><span class="line">String text = element.element(<span class="string">&quot;alipay_buyer_login_id&quot;</span>).getText();</span><br><span class="line"><span class="comment">// System.out.println(text);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹ å¿«æ·é”® iter / itco</span></span><br><span class="line">List elements = element.elements();</span><br><span class="line"><span class="comment">// for (Object o : elements) &#123;</span></span><br><span class="line"><span class="comment">//     Element tempElement = (Element) o;</span></span><br><span class="line"><span class="comment">//     System.out.println(tempElement.getName() + &quot;\t&quot; + tempElement.getText());</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// for (Iterator iterator = elements.iterator(); iterator.hasNext(); ) &#123;</span></span><br><span class="line"><span class="comment">//     Element next =  (Element)iterator.next();</span></span><br><span class="line"><span class="comment">//     System.out.println(next.getName() + &quot;\t&quot; + next.getText());</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–èŠ‚ç‚¹ä¸‹æ‰€æœ‰èŠ‚ç‚¹ Iteratorå¯¹è±¡ å¿«æ·é”® itit</span></span><br><span class="line">Iterator iterator = element.elementIterator();</span><br><span class="line"><span class="comment">// while (iterator.hasNext()) &#123;</span></span><br><span class="line"><span class="comment">//     Element next =  (Element)iterator.next();</span></span><br><span class="line"><span class="comment">//     System.out.println(next.getName() + &quot;\t&quot; + next.getText());</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ èŠ‚ç‚¹</span></span><br><span class="line">Element testElement = element.addElement(<span class="string">&quot;testElement&quot;</span>);</span><br><span class="line"><span class="comment">// æŒ‡å®šæ·»åŠ æ–‡å­—</span></span><br><span class="line">testElement.setText(<span class="string">&quot;æµ‹è¯•æ·»åŠ æ–‡å­—&quot;</span>);</span><br><span class="line">System.out.println(element.asXML());</span><br><span class="line"><span class="comment">// åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">boolean</span> remove = element.remove(testElement);</span><br><span class="line">System.out.println(remove + <span class="string">&quot;\n&quot;</span> + element.asXML());</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="4-è¯¦ç»†ä»£ç "><a href="#4-è¯¦ç»†ä»£ç " class="headerlink" title="4. è¯¦ç»†ä»£ç "></a>4. è¯¦ç»†ä»£ç </h6><p><a href="https://github.com/liuzhihang/tool_demo/blob/master/src/main/java/com/liuzhihang/tool/xml/Dom4jTest.java">Dom4jTest.java</a></p>]]></content>
      
      
      <categories>
          
          <category> utils </category>
          
      </categories>
      
      
        <tags>
            
            <tag> utils </tag>
            
            <tag> xml </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xmlè§£æ--JaxbUtil</title>
      <link href="2017/12/17/xml-parsing-jaxbutil.html"/>
      <url>2017/12/17/xml-parsing-jaxbutil.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ä¸»è¦ä»‹ç»ä½¿ç”¨jaxbå¯¹xmlè¿›è¡Œè§£æ, äº’è½¬.</p><p>jaxb æ˜¯ç›¸å¯¹è¾ƒå¤šçš„xmlå·¥å…·, åªéœ€è¦åœ¨javaBeançš„å±æ€§ä¸Šæ·»åŠ ç›¸åº”æ³¨è§£, å°±å¯ä»¥ä½¿ç”¨å·¥å…·è¿›è¡Œè§£æ. å…·ä½“ä½¿ç”¨è¿‡ç¨‹å¦‚ä¸‹:</p><h5 id="1-ç¼–å†™javaBeanå¹¶æ·»åŠ æ³¨è§£"><a href="#1-ç¼–å†™javaBeanå¹¶æ·»åŠ æ³¨è§£" class="headerlink" title="1. ç¼–å†™javaBeanå¹¶æ·»åŠ æ³¨è§£"></a>1. ç¼–å†™javaBeanå¹¶æ·»åŠ æ³¨è§£</h5><p>ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸€èˆ¬å¸¸ç”¨@XmlRootElement, @XmlAccessorType, @XmlElement, @XmlAttributeå››ä¸ªæ³¨è§£, å…¶ä½™ä½¿ç”¨æ–¹å¼å¯ä»¥å†è‡ªè¡Œæ·±å…¥ç ”ç©¶.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@XmlRootElement</span>: æ ¹å…ƒç´ </span><br><span class="line"><span class="meta">@XmlAccessorType</span>: javaå¯¹è±¡ç”Ÿæˆxmlæ–‡ä»¶æ—¶å¯¹javaå¯¹è±¡å±æ€§çš„è®¿é—®æ–¹å¼</span><br><span class="line">    å±æ€§ä¸ºXmlAccessType.FIELD æŒ‡javaæ‰€æœ‰æˆå‘˜å˜é‡</span><br><span class="line"><span class="meta">@XmlElement</span>: å­èŠ‚ç‚¹, name å¯æŒ‡å®šèŠ‚ç‚¹å</span><br><span class="line"><span class="meta">@XmlAttribute</span>: æ˜ å°„ä¸ºxmlæ–‡ä»¶çš„å±æ€§, name å¯æŒ‡å®šå±æ€§å</span><br></pre></td></tr></table></figure><a id="more"></a><p>javaBean:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@XmlRootElement(name = &quot;alipay&quot;)</span></span><br><span class="line"><span class="meta">@XmlAccessorType(XmlAccessType.FIELD)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AliPayXml</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XmlElement(name = &quot;alipay_buyer_login_id&quot; )</span></span><br><span class="line">    <span class="keyword">private</span> String buyerLoginId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XmlElement(name = &quot;alipay_buyer_user_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String buyerUserId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-ä½¿ç”¨-JaxbUtil"><a href="#2-ä½¿ç”¨-JaxbUtil" class="headerlink" title="2. ä½¿ç”¨ JaxbUtil"></a>2. ä½¿ç”¨ JaxbUtil</h5><p><a href="https://github.com/liuzhihang/tool_demo/blob/master/src/main/java/com/liuzhihang/tool/xml/JaxbUtil.java">JaxbUtil</a>ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.liuzhihang.tool.xml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.JAXBContext;</span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.JAXBException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.Marshaller;</span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.Unmarshaller;</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader;</span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Jaxb å·¥å…·</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/28 19:13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JaxbUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHARTSET = <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bean2Xml</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> JAXBException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bean2Xml(obj, CHARTSET);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bean2Xml</span><span class="params">(Object obj, String chartset)</span> <span class="keyword">throws</span> JAXBException </span>&#123;</span><br><span class="line">        JAXBContext jaxbContext = JAXBContext.newInstance(obj.getClass());</span><br><span class="line">        Marshaller marshaller = jaxbContext.createMarshaller();</span><br><span class="line">        marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, <span class="keyword">true</span>);</span><br><span class="line">        marshaller.setProperty(Marshaller.JAXB_ENCODING, chartset);</span><br><span class="line">        StringWriter writer = <span class="keyword">new</span> StringWriter();</span><br><span class="line">        marshaller.marshal(obj, writer);</span><br><span class="line">        <span class="keyword">return</span> writer.getBuffer().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">xml2Bean</span><span class="params">(String xmlString, Class&lt;T&gt; clazz)</span> <span class="keyword">throws</span> JAXBException </span>&#123;</span><br><span class="line">        JAXBContext jaxbContext = JAXBContext.newInstance(clazz);</span><br><span class="line">        Unmarshaller unmarshaller = jaxbContext.createUnmarshaller();</span><br><span class="line">        T t = (T) unmarshaller.unmarshal(<span class="keyword">new</span> StringReader(xmlString));</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-æµ‹è¯•ä»£ç "><a href="#3-æµ‹è¯•ä»£ç " class="headerlink" title="3. æµ‹è¯•ä»£ç "></a>3. æµ‹è¯•ä»£ç </h5><p>å¾…æµ‹è¯•å­—ç¬¦ä¸²: xmlStr</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">alipay</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alipay_buyer_login_id</span>&gt;</span>176****3035<span class="tag">&lt;/<span class="name">alipay_buyer_login_id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alipay_buyer_user_id</span>&gt;</span>2088912868994947<span class="tag">&lt;/<span class="name">alipay_buyer_user_id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">alipay</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç :</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: liuzhihang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2017/12/17 23:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JaxbTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JAXBException </span>&#123;</span><br><span class="line">        String aliPayXmlStr = <span class="string">&quot;&lt;alipay&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;alipay_buyer_login_id&gt;176****3035&lt;/alipay_buyer_login_id&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;alipay_buyer_user_id&gt;2088912868994947&lt;/alipay_buyer_user_id&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/alipay&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        AliPayXml aliPayXml = JaxbUtil.xml2Bean(aliPayXmlStr, AliPayXml.class);</span><br><span class="line">        System.out.println(JSON.toJSONString(aliPayXml));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœ:</p><p>æ‰“å°çš„ä¸ºjsonæ ¼å¼ç»“æœ, å¯debuggeræŸ¥çœ‹. åŒæ ·ä¹Ÿå¯ä»¥å°†javaBeanè½¬æ¢ä¸ºxmlStr</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;buyerLoginId&quot;:&quot;176****3035&quot;,&quot;buyerUserId&quot;:&quot;2088912868994947&quot;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> utils </category>
          
      </categories>
      
      
        <tags>
            
            <tag> utils </tag>
            
            <tag> xml </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
