<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ã€JDKæºç ç¬”è®°ã€‘- è¯·ä»‹ç»ä¸‹ä½ äº†è§£çš„ThreadLocalï¼Œå®ƒçš„åº•å±‚åŸç†ï¼ | ç¨‹åºå‘˜å°èˆª</title><meta name="keywords" content="æºç ç¬”è®°,JDK"><meta name="author" content="liuzhihang"><meta name="copyright" content="liuzhihang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿåœ¨HashMapä¸­æ˜¯æ€ä¹ˆåº”ç”¨çš„ï¼Ÿ">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€JDKæºç ç¬”è®°ã€‘- è¯·ä»‹ç»ä¸‹ä½ äº†è§£çš„ThreadLocalï¼Œå®ƒçš„åº•å±‚åŸç†ï¼">
<meta property="og:url" content="https://liuzhihang.com/2020/06/21/source-code-threadlocal.html">
<meta property="og:site_name" content="ç¨‹åºå‘˜å°èˆª">
<meta property="og:description" content="ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿåœ¨HashMapä¸­æ˜¯æ€ä¹ˆåº”ç”¨çš„ï¼Ÿ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/threadlocal.jpeg">
<meta property="article:published_time" content="2020-06-21T02:00:00.000Z">
<meta property="article:modified_time" content="2020-12-27T09:23:14.595Z">
<meta property="article:author" content="liuzhihang">
<meta property="article:tag" content="æºç ç¬”è®°">
<meta property="article:tag" content="JDK">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/threadlocal.jpeg"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/favicon.ico"><link rel="canonical" href="https://liuzhihang.com/2020/06/21/source-code-threadlocal"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//pingjs.qq.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google_site_verification" content="GZshAnnrC-4eCrl5h-e_5Rdk4lOUhRK7ShULoRi2q0E"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-126394362-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-126394362-1');
</script><script>var _mtac = {};
(function() {
    var mta = document.createElement("script");
    mta.src = "//pingjs.qq.com/h5/stats.js?v2.0.4";
    mta.setAttribute("name", "MTAH5");
    mta.setAttribute("sid", "66540676");
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(mta, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  noticeOutdate: {"limitDay":730,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: undefined,
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ã€JDKæºç ç¬”è®°ã€‘- è¯·ä»‹ç»ä¸‹ä½ äº†è§£çš„ThreadLocalï¼Œå®ƒçš„åº•å±‚åŸç†ï¼',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-12-27 17:23:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_1608878_xsf93f0c1a.css"><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="ç¨‹åºå‘˜å°èˆª" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/404/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">126</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">50</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">28</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-layer-group"></i><span> å¯¼èˆª</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-bookmark"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> æ¨è</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> ä¹¦å•</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> ç”µå½±</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fas fa-comments"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-address-book"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user-circle"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å…¶ä»–</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://juejin.im/user/1987506650493117"><i class="fa-fw iconfont iconjuejin-1"></i><span> æ˜é‡‘</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.zhihu.com/people/liuzhihang"><i class="fa-fw iconfont iconzhihu1"></i><span> çŸ¥ä¹</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.infoq.cn/profile/00B8AE08DA916E/publish"><i class="fa-fw iconfont iconweibiaoti-1"></i><span> InfoQ</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36535538"><i class="fa-fw iconfont iconcsdn"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://leetcode-cn.com/u/liuzhihang/"><i class="fa-fw iconfont iconleetcode"></i><span> LeetCode</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/threadlocal.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ç¨‹åºå‘˜å°èˆª</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-layer-group"></i><span> å¯¼èˆª</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-bookmark"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> æ¨è</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> ä¹¦å•</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> ç”µå½±</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fas fa-comments"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-address-book"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user-circle"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å…¶ä»–</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://juejin.im/user/1987506650493117"><i class="fa-fw iconfont iconjuejin-1"></i><span> æ˜é‡‘</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.zhihu.com/people/liuzhihang"><i class="fa-fw iconfont iconzhihu1"></i><span> çŸ¥ä¹</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.infoq.cn/profile/00B8AE08DA916E/publish"><i class="fa-fw iconfont iconweibiaoti-1"></i><span> InfoQ</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36535538"><i class="fa-fw iconfont iconcsdn"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://leetcode-cn.com/u/liuzhihang/"><i class="fa-fw iconfont iconleetcode"></i><span> LeetCode</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ã€JDKæºç ç¬”è®°ã€‘- è¯·ä»‹ç»ä¸‹ä½ äº†è§£çš„ThreadLocalï¼Œå®ƒçš„åº•å±‚åŸç†ï¼</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2020-06-21T02:00:00.000Z" title="å‘è¡¨äº 2020-06-21 10:00:00">2020-06-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2020-12-27T09:23:14.595Z" title="æ›´æ–°äº 2020-12-27 17:23:14">2020-12-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/">æºç ç¬”è®°</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/">JDK</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">3.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>15åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ã€JDKæºç ç¬”è®°ã€‘- è¯·ä»‹ç»ä¸‹ä½ äº†è§£çš„ThreadLocalï¼Œå®ƒçš„åº•å±‚åŸç†ï¼"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">è¯„è®ºæ•°:</span><a href="/2020/06/21/source-code-threadlocal.html#post-comment"><span class="gitalk-comment-count"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p><strong>å‰è¨€</strong></p>
<p>ä¸šåŠ¡å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨ ThreadLocal æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ç­‰çº¿ç¨‹ç§æœ‰å¯¹è±¡â€¦ ThreadLocal å†…éƒ¨æ„é€ æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿå¸¸è¯´çš„å†…å­˜æ³„éœ²åˆæ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</p>
<p>å…¬ä¼—å·ï¼šliuzhihangs ï¼Œè®°å½•å·¥ä½œå­¦ä¹ ä¸­çš„æŠ€æœ¯ã€å¼€å‘åŠæºç ç¬”è®°ï¼›æ—¶ä¸æ—¶åˆ†äº«ä¸€äº›ç”Ÿæ´»ä¸­çš„è§é—»æ„Ÿæ‚Ÿã€‚æ¬¢è¿å¤§ä½¬æ¥æŒ‡å¯¼ï¼</p>
</blockquote>
<h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><blockquote>
<p>ThreadLocal ç±»æä¾›äº†çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚å’Œæ­£å¸¸å¯¹è±¡ä¸åŒçš„æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—® get()ã€set() æ–¹æ³•ï¼Œè·å–ç‹¬å±äºè‡ªå·±çš„å‰¯æœ¬ã€‚ ThreadLocal å®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œå¹¶ä¸”å…¶çŠ¶æ€å’Œçº¿ç¨‹å…³è”ã€‚<br>æ¯ä¸ªçº¿ç¨‹éƒ½ä¿æŒå¯¹å…¶çº¿ç¨‹å±€éƒ¨å˜é‡å‰¯æœ¬çš„éšå¼å¼•ç”¨ï¼Œåªè¦çº¿ç¨‹æ˜¯æ´»åŠ¨çš„å¹¶ä¸” ThreadLocal å®ä¾‹è®¿é—®; ä¸€ä¸ªçº¿ç¨‹æ¶ˆå¤±ä¹‹åï¼Œæ‰€æœ‰çš„çº¿ç¨‹å±€éƒ¨å®ä¾‹çš„å‰¯æœ¬éƒ½ä¼šè¢«åƒåœ¾å›æ”¶ï¼ˆé™¤éå­˜åœ¨å¯¹è¿™äº›å‰¯æœ¬çš„å…¶ä»–å¼•ç”¨ï¼‰ã€‚</p>
</blockquote>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>æœ‰è¿™ä¹ˆä¸€ç§ä½¿ç”¨åœºæ™¯ï¼Œæ”¶åˆ° web è¯·æ±‚ï¼Œå…ˆè¿›è¡Œ token éªŒè¯ï¼Œè€Œè¿™ä¸ª tokenï¼Œå¯ä»¥è§£æå‡ºç”¨æˆ· user çš„ä¿¡æ¯ã€‚æ‰€ä»¥æˆ‘è¿™è¾¹ä¸€èˆ¬æ˜¯è¿™æ ·ä½¿ç”¨çš„ï¼š</p>
<ol>
<li>è‡ªå®šä¹‰æ³¨è§£ï¼Œ <code>@CheckToken</code> ï¼Œ æ ‡è¯†è¯¥æ–¹æ³•éœ€è¦æ ¡éªŒ tokenã€‚</li>
<li>åœ¨ <code>Interceptor</code>ï¼ˆæ‹¦æˆªå™¨ï¼‰ä¸­æ£€æŸ¥ï¼Œå¦‚æœæ–¹æ³•æœ‰ <code>@CheckToken</code> æ³¨è§£åˆ™æ ¡éªŒ tokenã€‚</li>
<li>ä»Headerä¸­è·å– <code>Authorization</code> ï¼Œè¯·æ±‚ç¬¬ä¸‰æ–¹æˆ–è€…è‡ªå·±çš„é€»è¾‘æ ¡éªŒ token ï¼Œå¹¶è§£ææˆ userã€‚</li>
<li>å°†useræ”¾åˆ°<code>ThreadLocal</code>ä¸­ã€‚</li>
<li>controllerã€service åœ¨åç»­ä½¿ç”¨ä¸­ï¼Œ å¦‚æœéœ€è¦ user ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥ä» <code>ThreadLocal</code> ä¸­è·å–ã€‚</li>
<li>ä½¿ç”¨ç»“æŸåè¿›è¡Œremoveã€‚</li>
</ol>
<h4 id="ä»£ç å¦‚ä¸‹ï¼š"><a href="#ä»£ç å¦‚ä¸‹ï¼š" class="headerlink" title="ä»£ç å¦‚ä¸‹ï¼š"></a>ä»£ç å¦‚ä¸‹ï¼š</h4><pre><code class="java">
public class LocalUserUtils &#123;

    /**
     * ç”¨æˆ·ä¿¡æ¯ä¿å­˜è‡³ ThreadLocal ä¸­
     */
    private static final ThreadLocal&lt;User&gt; USER_THREAD_LOCAL = new ThreadLocal&lt;&gt;();

    public static void set(User user) &#123;
        USER_THREAD_LOCAL.set(user);
    &#125;

    public static User get() &#123;
        return USER_THREAD_LOCAL.get();
    &#125;

    public static void remove() &#123;
        USER_THREAD_LOCAL.remove();
    &#125;

&#125;

/**
 * 1. åŠ ä¸Šæ³¨è§£ CheckToken
 * åªæœ‰æ–¹æ³•ï¼Œ ç±»å¿½ç•¥
 */
@CheckToken
@PostMapping(&quot;/doXxx&quot;)
public Result&lt;Resp&gt; doXxx(@RequestBody Req req) &#123;

    Resp resp = xxxService.doXxx(req);

    return result.success(resp);
&#125;

/**
 * 2. 3. 4.
 */
@Component
public class TokenInterceptor implements HandlerInterceptor &#123;

    @Override
    public void afterCompletion(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2, Exception arg3)
            throws Exception &#123;
        LocalUserUtils.remove();
    &#125;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;
        // è¯·æ±‚æ–¹æ³•æ˜¯å¦å­˜åœ¨æ³¨è§£
        boolean assignableFrom = handler.getClass().isAssignableFrom(HandlerMethod.class);

        if (!assignableFrom) &#123;
            return true;
        &#125;

        CheckToken checkToken = null;
        if (handler instanceof HandlerMethod) &#123;
            checkToken = ((HandlerMethod) handler).getMethodAnnotation(CheckToken.class);
        &#125;

        // æ²¡æœ‰åŠ æ³¨è§£ ç›´æ¥æ”¾è¿‡
        if (checkToken == null) &#123;
            return true;
        &#125;

        // ä»Headerä¸­è·å–Authorization
        String authorization = request.getHeader(&quot;Authorization&quot;);
        log.info(&quot;header authorization : &#123;&#125;&quot;, authorization);
        if (StringUtils.isBlank(authorization)) &#123;
            log.error(&quot;ä»Headerä¸­è·å–Authorizationå¤±è´¥&quot;);
            throw CustomExceptionEnum.NOT_HAVE_TOKEN.throwCustomException();
        &#125;

        User user = xxxUserService.checkAuthorization(authorization);
        // æ”¾åˆ°
        LocalUserUtils.set(user);

        return true;
    &#125;
&#125;

/**
 * 5. ä½¿ç”¨
 * åªæœ‰æ–¹æ³•ï¼Œ ç±»å¿½ç•¥
 */
@Override
public Resp doXxx(Req req) &#123;

    User user = LocalUserUtils.get();

    // do something ...

    return resp;
&#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/640.jpeg"  div align=center />

<h4 id="æŠ›å‡ºé—®é¢˜"><a href="#æŠ›å‡ºé—®é¢˜" class="headerlink" title="æŠ›å‡ºé—®é¢˜"></a>æŠ›å‡ºé—®é¢˜</h4><ol>
<li>ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆå¼ºåˆ¶ä½¿ç”¨åå¿…é¡»removeï¼Ÿ</li>
</ol>
<p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/19.png" alt="19"></p>
<p>å›¾ | é˜¿é‡Œå·´å·´ - Javaå¼€å‘æ‰‹å†Œï¼ˆæˆªå›¾ï¼‰</p>
<p><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/6.png" alt="6"></p>
<p>å›¾ | é˜¿é‡Œå·´å·´ - Javaå¼€å‘æ‰‹å†Œï¼ˆæˆªå›¾ï¼‰</p>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h4><pre><code class="java">
public class Thread implements Runnable &#123;
    // çœç•¥ ...

    ThreadLocal.ThreadLocalMap threadLocals = null;

    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;

    // çœç•¥ ...
&#125;</code></pre>
<p>å¯ä»¥çœ‹å‡º <code>Thread</code> å¯¹è±¡ä¸­å£°æ˜äº† <code>ThreadLocal.ThreadLocalMap</code> å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ <code>ThreadLocal. ThreadLocalMap</code> å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨çº¿ç¨‹ä¹‹é—´æ˜¯äº’ç›¸<code>éš”ç¦»</code>çš„ã€‚</p>
<h4 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h4><p>ThreadLocalåˆ™æ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼ŒåŒæ—¶æä¾› <code>set()</code>ã€<code>get()</code>ã€<code>remove()</code> ç­‰<code>é™æ€</code>æ–¹æ³•ã€‚</p>
<pre><code class="java">public class ThreadLocal&lt;T&gt; &#123;

    // çº¿ç¨‹æœ¬åœ°hashCode
    private final int threadLocalHashCode = nextHashCode();

    // è·å–æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹å‰¯æœ¬ä¸­çš„å€¼
    public T get() &#123;...&#125;
    // è®¾ç½®å½“å‰çº¿ç¨‹çš„æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å¤åˆ¶åˆ°æŒ‡å®šçš„å€¼
    public void set(T value) &#123;...&#125;
    // åˆ é™¤å½“å‰çº¿ç¨‹çš„æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼
    public void remove() &#123;...&#125;
    // ThreadLocalMapåªæ˜¯ç”¨æ¥ç»´æŒçº¿ç¨‹æœ¬åœ°å€¼çš„å®šåˆ¶Map
    static class ThreadLocalMap &#123;...&#125;
&#125;</code></pre>
<h5 id="set-T-value-æ–¹æ³•"><a href="#set-T-value-æ–¹æ³•" class="headerlink" title="set(T value)æ–¹æ³•"></a>set(T value)æ–¹æ³•</h5><pre><code class="java">
public void set(T value) &#123;
    // è·å–å½“å‰çº¿ç¨‹
    Thread t = Thread.currentThread();
    // è·å–å½“å‰çº¿ç¨‹çš„ threadLocals å±æ€§
    ThreadLocalMap map = getMap(t);
    if (map != null)
        // å­˜åœ¨åˆ™èµ‹å€¼
        map.set(this, value);
    else
        // ä¸å­˜åœ¨åˆ™ç›´æ¥åˆ›å»º
        createMap(t, value);
&#125;
// æ ¹æ®çº¿ç¨‹è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap
ThreadLocalMap getMap(Thread t) &#123;
    return t.threadLocals;
&#125;
// åˆ›å»ºThreadLocalMap å¹¶èµ‹å€¼ç»™å½“å‰çº¿ç¨‹çš„threadLocalså­—æ®µ
void createMap(Thread t, T firstValue) &#123;
    t.threadLocals = new ThreadLocalMap(this, firstValue);
&#125;</code></pre>
<p>1.<code>Thread.currentThread()</code> å…ˆè·å–åˆ°å½“å‰çº¿ç¨‹ã€‚<br>2. è·å–å½“å‰çº¿ç¨‹çš„ <code>threadLocals</code> å±æ€§ï¼Œå³ <code>ThreadLocalMap</code>ã€‚<br>3. åˆ¤æ–­ Map æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™èµ‹å€¼ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºå¯¹è±¡ã€‚</p>
<h5 id="get-æ–¹æ³•"><a href="#get-æ–¹æ³•" class="headerlink" title="get()æ–¹æ³•"></a>get()æ–¹æ³•</h5><pre><code class="java">
public T get() &#123;
    // è·å–å½“å‰çº¿ç¨‹
    Thread t = Thread.currentThread();
    // è·å–å½“å‰çº¿ç¨‹çš„ threadLocals å±æ€§
    ThreadLocalMap map = getMap(t);
    // mapä¸ä¸ºç©º
    if (map != null) &#123;
        // æ ¹æ®å½“å‰ThreadLocalè·å–çš„ThreadLocalMapçš„EntryèŠ‚ç‚¹
        ThreadLocalMap.Entry e = map.getEntry(this);
        if (e != null) &#123;
            // è·å–èŠ‚ç‚¹çš„value å¹¶è¿”å›
            @SuppressWarnings(&quot;unchecked&quot;)
            T result = (T)e.value;
            return result;
        &#125;
    &#125;
    // è®¾ç½®åˆå§‹å€¼å¹¶è¿”å› ï¼ˆnullï¼‰
    return setInitialValue();
&#125;
</code></pre>
<p>1.<code>Thread.currentThread()</code> å…ˆè·å–åˆ°å½“å‰çº¿ç¨‹ã€‚<br>2. è·å–å½“å‰çº¿ç¨‹çš„ <code>threadLocals</code> å±æ€§ï¼Œå³ <code>ThreadLocalMap</code> ã€‚<br>3. åˆ¤æ–­ Map ä¸ä¸ºç©ºï¼Œæ ¹æ®å½“å‰ <code>ThreadLocal</code> å¯¹è±¡è·å– <code>ThreadLocalMap.Entry</code> èŠ‚ç‚¹, ä»èŠ‚ç‚¹ä¸­è·å– valueã€‚<br>4.<code>ThreadLocalMap</code> ä¸ºç©ºæˆ–è€… <code>ThreadLocalMap.Entry</code> ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ– ThreadLocalMap å¹¶è¿”å›ã€‚</p>
<h5 id="remove-æ–¹æ³•"><a href="#remove-æ–¹æ³•" class="headerlink" title="remove()æ–¹æ³•"></a>remove()æ–¹æ³•</h5><pre><code class="java">public void remove() &#123;
    // è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap
    ThreadLocalMap m = getMap(Thread.currentThread());
    // ä¸ä¸ºç©ºï¼Œ ä»ThreadLocalMapä¸­ç§»é™¤è¯¥å±æ€§
    if (m != null)
        m.remove(this);
&#125;</code></pre>
<p>é˜…è¯» <code>set()</code>ã€<code>get()</code>ã€<code>remove()</code> çš„æºç ä¹‹åå‘ç°åé¢å…¶å®æ˜¯æ“ä½œçš„ <code>ThreadLocalMap</code>, ä¸»è¦è¿˜æ˜¯æ“ä½œçš„ <code>ThreadLocalMap</code> çš„ <code>set()</code>ã€<code>getEntry()</code>ã€<code>remove()</code> ä»¥åŠæ„é€ å‡½æ•°ã€‚ä¸‹é¢çœ‹æ˜¯çœ‹ ThreadLocalMap çš„æºç ã€‚</p>
<h4 id="ThreadLocalMap"><a href="#ThreadLocalMap" class="headerlink" title="ThreadLocalMap"></a>ThreadLocalMap</h4><pre><code class="java">static class ThreadLocalMap &#123;

    /**
     * EntryèŠ‚ç‚¹ç»§æ‰¿WeakReferenceæ˜¯å¼±å¼•ç”¨
     */
    static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; &#123;
        /** ä¸æ­¤ThreadLocalå…³è”çš„å€¼ã€‚ */
        Object value;

        Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;
            super(k);
            value = v;
        &#125;
    &#125;
    // åˆå§‹å®¹é‡-å¿…é¡»æ˜¯2çš„å¹‚
    private static final int INITIAL_CAPACITY = 16;

    // è¡¨ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´å¤§å°. table.lengthå¿…é¡»å§‹ç»ˆä¸º2çš„å¹‚.
    private ThreadLocal.ThreadLocalMap.Entry[] table;

    // è¡¨ä¸­çš„æ¡ç›®æ•°ã€‚ 
    private int size = 0;

    // æ‰©å®¹é˜ˆå€¼  
    private int threshold; // Default to 0
    // è®¾ç½®é˜€å€¼ä¸ºé•¿åº¦çš„ 2/3   
    private void setThreshold(int len) &#123;
        threshold = len * 2 / 3;
    &#125;
    // æ„é€ å‡½æ•°
    ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;...&#125;

    // æ ¹æ®ThreadLocalè·å–èŠ‚ç‚¹Entry
    private ThreadLocal.ThreadLocalMap.Entry getEntry(ThreadLocal&lt;?&gt; key) &#123;...&#125;

    // set ThreadLocalMapçš„k-v
    private void set(ThreadLocal&lt;?&gt; key, Object value) &#123;...&#125;

    // ç§»é™¤å½“å‰å€¼
    private void remove(ThreadLocal&lt;?&gt; key) &#123;...&#125;
&#125;
</code></pre>
<ol>
<li>Entry ç»§æ‰¿äº† <code>WeakReference&lt;ThreadLocal&lt;?&gt;</code> ä¹Ÿå°±æ„å‘³ç€ï¼Œ <code>Entry èŠ‚ç‚¹çš„ key æ˜¯å¼±å¼•ç”¨</code>ã€‚</li>
<li>Entry å¯¹è±¡çš„keyå¼±å¼•ç”¨ï¼ŒæŒ‡å‘çš„æ˜¯ <code>ThreadLocal</code> å¯¹è±¡ã€‚</li>
<li>çº¿ç¨‹å¯¹è±¡æ‰§è¡Œå®Œæ¯•ï¼Œçº¿ç¨‹å¯¹è±¡å†…å®ä¾‹å±æ€§ä¼šè¢«å›æ”¶ï¼Œæ­¤æ—¶çº¿ç¨‹å†… <code>ThreadLocal</code> å¯¹è±¡çš„<code>å¼•ç”¨</code>è¢«ç½®ä¸º <code>null</code> ï¼Œå³ Entry çš„ <code>key</code> ä¸º <code>null</code>, key ä¼šè¢«åƒåœ¾å›æ”¶ã€‚</li>
<li>ThreadLocal å¯¹è±¡é€šå¸¸ä¸ºç§æœ‰é™æ€å˜é‡ï¼Œ ç”Ÿå‘½å‘¨æœŸä¸ä¼šè‡³å°‘ä¸ä¼šéšç€çº¿ç¨‹æŠ€æœ¯è€Œç»“æŸã€‚</li>
<li>ThreadLocal å¯¹è±¡å­˜åœ¨ï¼Œå¹¶ä¸” <code>Entryçš„ key == null &amp;&amp; value != null</code> ï¼Œè¿™æ—¶å°±ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚</li>
</ol>
<ul>
<li>å°è¡¥å……</li>
</ul>
<ol>
<li>å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨<pre><code class="text">å¼ºå¼•ç”¨ï¼ˆStrongReferenceï¼‰ï¼šæœ€å¸¸è§ï¼Œç›´æ¥ new Object(); åˆ›å»ºçš„å³ä¸ºå¼ºå¼•ç”¨ã€‚å½“å†…å­˜ç©ºé—´ä¸è¶³ï¼ŒJavaè™šæ‹Ÿæœºå®æ„¿æŠ›å‡º OOMï¼Œä¹Ÿä¸æ„¿æ„éšæ„å›æ”¶å…·æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡æ¥è§£å†³å†…å­˜ä¸è¶³é—®é¢˜ã€‚
è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰ï¼šå†…å­˜è¶³å¤Ÿï¼Œåƒåœ¾å›æ”¶å™¨ä¸ä¼šå›æ”¶è½¯å¼•ç”¨å¯¹è±¡ï¼›å†…å­˜ä¸è¶³æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šå›æ”¶ã€‚
å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰ï¼šåƒåœ¾å›æ”¶å™¨çº¿ç¨‹ï¼Œå‘ç°å°±ä¼šå›æ”¶ã€‚
è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰ï¼šä»»ä½•æ—¶å€™éƒ½æœ‰å¯èƒ½è¢«åƒåœ¾å›æ”¶ï¼Œå¿…é¡»å¼•ç”¨é˜Ÿåˆ—è”åˆä½¿ç”¨ã€‚</code></pre>
</li>
<li>å†…å­˜æ³„éœ²ï¼š<pre><code class="text">å†…å­˜æ³„æ¼ï¼ˆMemory leakï¼‰æ˜¯åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œç”±äºç–å¿½æˆ–é”™è¯¯é€ æˆç¨‹åºæœªèƒ½é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚å†…å­˜æ³„æ¼å¹¶éæŒ‡å†…å­˜åœ¨ç‰©ç†ä¸Šçš„æ¶ˆå¤±ï¼Œè€Œæ˜¯åº”ç”¨ç¨‹åºåˆ†é…æŸæ®µå†…å­˜åï¼Œç”±äºè®¾è®¡é”™è¯¯ï¼Œå¯¼è‡´åœ¨é‡Šæ”¾è¯¥æ®µå†…å­˜ä¹‹å‰å°±å¤±å»äº†å¯¹è¯¥æ®µå†…å­˜çš„æ§åˆ¶ï¼Œä»è€Œé€ æˆäº†å†…å­˜çš„æµªè´¹ã€‚
â€”â€” ç»´åŸºç™¾ç§‘</code></pre>
</li>
</ol>
<img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/SJPSIU.jpg"  div align=center />

<h5 id="æ„é€ å‡½æ•°åŠhashè®¡ç®—"><a href="#æ„é€ å‡½æ•°åŠhashè®¡ç®—" class="headerlink" title="æ„é€ å‡½æ•°åŠhashè®¡ç®—"></a>æ„é€ å‡½æ•°åŠhashè®¡ç®—</h5><pre><code class="java">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;
    // åˆå§‹åŒ–Entryæ•°ç»„ï¼Œ é•¿åº¦ä¸º16
    table = new Entry[INITIAL_CAPACITY];
    // è·å–keyçš„hashCodeï¼Œå¹¶è®¡ç®—å‡ºåœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œ
    // é•¿åº¦æ˜¯ 2çš„å¹‚çš„æƒ…å†µä¸‹ï¼Œå–æ¨¡ a % b == a &amp; (b - 1)
    int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);
    table[i] = new Entry(firstKey, firstValue);
    // è®¾ç½®æ•°ç»„å…ƒç´ æ•°
    size = 1;
    // è®¾ç½®æ‰©å®¹é˜ˆå€¼
    setThreshold(INITIAL_CAPACITY);
&#125;</code></pre>
<p>threadLocalHashCode æ˜¯ ThreadLocal çš„é™æ€å±æ€§ï¼Œé€šè¿‡ nextHashCode æ–¹æ³•è·å–ã€‚</p>
<pre><code class="java">private final int threadLocalHashCode = nextHashCode();

// è¢«èµ‹äºˆäº†æ¥ä¸‹æ¥çš„å“ˆå¸Œç ã€‚ åŸå­æ›´æ–°ã€‚ ä»é›¶å¼€å§‹ã€‚
private static AtomicInteger nextHashCode = new AtomicInteger();

private static final int HASH_INCREMENT = 0x61c88647;
private static int nextHashCode() &#123;
    // è¿”å›ä¸‹ä¸€ä¸ªhashç ï¼Œé€šè¿‡æ­¥é•¿ 0x61c88647 ç´¯åŠ ç”Ÿæˆï¼Œè¿™å—æ³¨é‡Šè¯´æ˜æ˜¯æœ€ä½³å“ˆå¸Œå€¼
    return nextHashCode.getAndAdd(HASH_INCREMENT);
&#125;</code></pre>
<ol>
<li>åˆå§‹åŒ–æ•°ç»„ï¼Œé•¿åº¦16ã€‚</li>
<li>è®¡ç®— key çš„ hashCodeï¼Œå¯¹2çš„å¹‚å–æ¨¡ã€‚</li>
<li>è®¾ç½®å…ƒç´ ï¼Œå…ƒç´ æ•°åŠæ‰©å®¹é˜ˆå€¼ã€‚</li>
</ol>
<p>hashCode é€šè¿‡æ­¥é•¿ 0x61c88647 ç´¯åŠ ç”Ÿæˆï¼Œ å¹¶ä¸”ä½¿ç”¨äº† AtomicIntegerï¼Œä¿è¯åŸå­æ€§ã€‚</p>
<h5 id="set-æ–¹æ³•"><a href="#set-æ–¹æ³•" class="headerlink" title="set()æ–¹æ³•"></a>set()æ–¹æ³•</h5><pre><code class="java">
private void set(ThreadLocal&lt;?&gt; key, Object value) &#123;

    Entry[] tab = table;
    int len = tab.length;
    // hashcodeå–æ¨¡æ±‚æ•°ç»„ç´¢å¼•
    int i = key.threadLocalHashCode &amp; (len-1);

    // è·å–æ•°ç»„ä¸­å¯¹åº”çš„ä½ç½®ï¼Œ é‡ç‚¹å…³æ³¨ e = tab[i = nextIndex(i, len)]
    for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) &#123;
        // è·å–key
        ThreadLocal&lt;?&gt; k = e.get();
        // key å­˜åœ¨åˆ™è¦†ç›–
        if (k == key) &#123;
            e.value = value;
            return;
        &#125;
        // key ä¸å­˜åœ¨åˆ™èµ‹å€¼
        if (k == null) &#123;
            replaceStaleEntry(key, value, i);
            return;
        &#125;
    &#125;
    // æ­¤æ—¶ e == null ç›´æ¥æ‰§åˆ›å»ºèŠ‚ç‚¹
    tab[i] = new Entry(key, value);
    int sz = ++size;
    // cleanSomeSlots å¾ªç¯æ•°ç»„ æŸ¥æ‰¾å…¨éƒ¨key==nullçš„Entry
    if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)
        rehash();
&#125;</code></pre>
<ol>
<li>è·å–å¾ªç¯ Entry æ•°ç»„ï¼Œè·å– tab[i] å¤„çš„ eï¼Œ e != null ç»§ç»­å¾ªç¯<ol>
<li>æ­¤æ—¶å‘ç° e çš„ key ä¸å­˜åœ¨ï¼Œå¹¶ä¸”ä¸æ˜¯ null ï¼ˆhashå†²çªäº†ã€‚ï¼‰</li>
<li>é‚£å°±é€šè¿‡ e = tab[i = nextIndex(i, len)]) ç»§ç»­è·å–ä¸‹ä¸€ä¸ª iï¼Œå¹¶è·å–æ–°çš„ tab[i] å¤„çš„ eã€‚</li>
<li>èµ‹å€¼æ›¿æ¢å€¼ç»“æŸç»“æŸå¹¶è¿”å›ã€‚</li>
</ol>
</li>
<li>e == null ç»“æŸå¾ªç¯ã€‚</li>
</ol>
<pre><code class="java">// ä¸‹ä¸€ä¸ªindexï¼Œå¦‚æœ i + 1 &lt; len ç›´æ¥è¿”å›ä¸‹ä¸€ä¸ªä½ç½®  
// å¦‚æœ i + 1 &gt;= len åˆ™è¿”å› 0ï¼Œ ä»å¤´å¼€å§‹ã€‚
private static int nextIndex(int i, int len) &#123;
    return ((i + 1 &lt; len) ? i + 1 : 0);
&#125;

private static int prevIndex(int i, int len) &#123;
    return ((i - 1 &gt;= 0) ? i - 1 : len - 1);
&#125;
</code></pre>
<ol>
<li>è¿™å—åˆ©ç”¨ç¯å½¢è®¾è®¡ï¼Œå¦‚æœé•¿åº¦åˆ°è¾¾æ•°ç»„é•¿åº¦ï¼Œåˆ™ä»å¼€å¤´å¼€å§‹ç»§ç»­æŸ¥æ‰¾ã€‚</li>
<li>int i = key.threadLocalHashCode &amp; (len-1); æ±‚å‡ºç´¢å¼•ï¼Œå¹¶ä¸æ˜¯ä»0å¼€å§‹çš„ã€‚</li>
</ol>
<pre><code class="java">
/**
 * staleSlot ä¸ºå½“å‰ç´¢å¼•ä½ç½®ï¼Œ å¹¶ä¸”å½“å‰ç´¢å¼•ä½ç½®çš„ k == null
 */
private void replaceStaleEntry(ThreadLocal&lt;?&gt; key, Object value, int staleSlot) &#123;
    Entry[] tab = table;
    int len = tab.length;
    Entry e;

    // éœ€è¦æ¸…é™¤çš„ entry çš„ç´¢å¼•
    int slotToExpunge = staleSlot;

    // å¾ªç¯è·å–åˆ°ä¸Šä¸€ä¸ª key==null çš„èŠ‚ç‚¹åŠå…¶ç´¢å¼•ï¼Œæœ‰å¯èƒ½è¿˜æ˜¯è‡ªå·±
    for (int i = prevIndex(staleSlot, len); (e = tab[i]) != null; i = prevIndex(i, len))
        if (e.get() == null)
            slotToExpunge = i;

    // ç»§ç»­ä¸Šä¸€å±‚çš„å¾ªç¯ï¼ŒæŸ¥æ‰¾ä¸‹ä¸€ä¸ª k == key çš„èŠ‚ç‚¹ç´¢å¼•
    for (int i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) &#123;
        ThreadLocal&lt;?&gt; k = e.get();

        if (k == key) &#123;
            // key ç›¸ç­‰ åˆ™ç›´æ¥èµ‹å€¼
            e.value = value;
            // å¹¶ä¸”å°† æ­¤å¤„çš„ entryæ›¿æ¢ä¸º tab[staleSlot]
            tab[i] = tab[staleSlot];
            tab[staleSlot] = e;

            // å¦‚æœå‘ç°è¦æ¸…é™¤çš„ entryå’Œä¼ å…¥çš„åœ¨ä¸€ä¸ªä½ç½®ä¸Šï¼Œ åˆ™ç›´æ¥èµ‹å€¼
            if (slotToExpunge == staleSlot)
                slotToExpunge = i;

            // æ¸…é™¤æ‰è¿‡æœŸçš„ expungeStaleEntry(slotToExpunge) ä¼šæ¸…é™¤ entryçš„valueï¼Œå°†å…¶è®¾ç½®ä¸ºnullå¹¶å°†å…¶è®¾ç½®ä¸ºnullï¼Œ å¹¶è¿”å›ä¸‹ä¸€ä¸ªéœ€è¦æ¸…é™¤çš„entryçš„ç´¢å¼•ä½ç½®
            // cleanSomeSlots å¾ªç¯æ•°ç»„ æŸ¥æ‰¾å…¨éƒ¨key==nullçš„Entry
            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);
            return;
        &#125;

        // å¦‚æœå‘åæ‰«ææ²¡æœ‰æ‰¾åˆ°ï¼Œå¹¶ä¸”å·²ç»åˆ°ç¬¬åˆå§‹ä¼ å…¥çš„ç´¢å¼•ä½ç½®å¤„äº†
        if (k == null &amp;&amp; slotToExpunge == staleSlot)
            slotToExpunge = i;
    &#125;

    // æ²¡æ‰¾åˆ°ï¼Œ ç›´æ¥å°†æ—§å€¼ Entry è®¾ç½®ä¸º null å¹¶æŒ‡å‘æ–°åˆ›å»ºçš„Entry
    tab[staleSlot].value = null;
    tab[staleSlot] = new Entry(key, value);

    // ç»“æŸä¹‹åå‘ç°è¦æ¸…æ¥šçš„ keyçš„ç´¢å¼• ä¸ç­‰äºå½“å‰ä¼ å…¥çš„ç´¢å¼•ï¼Œ è¯´æ˜è¿˜æœ‰å…¶ä»–éœ€è¦æ¸…é™¤ã€‚
    if (slotToExpunge != staleSlot)
        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);
&#125;
</code></pre>
<ol>
<li>è¿™é‡Œå­˜åœ¨ä¸‰ä¸ªå±æ€§ keyï¼Œ valueï¼Œä»¥åŠ staleSlotï¼Œ staleSlotèŠ‚ç‚¹çš„ Entry != null ä½†æ˜¯ k == nullã€‚</li>
<li>å‘å‰æ‰«æè·å–åˆ°ä¸Šä¸€ä¸ª  Entry != null ä½†æ˜¯ k == null çš„èŠ‚ç‚¹åŠå…¶ç´¢å¼•, èµ‹å€¼ç»™ slotToExpungeï¼Œ æ²¡æœ‰æ‰«æåˆ°çš„è¯ slotToExpunge è¿˜æ˜¯ç­‰äº staleSlotã€‚</li>
<li>å‘åæ‰«æ Entry != null çš„èŠ‚ç‚¹ï¼Œå› ä¸ºåœ¨ set æ–¹æ³•ä¸­ï¼Œ åé¢è¿˜æœ‰ä¸€æ®µæ•°ç»„æ²¡æœ‰éå†ã€‚<ol>
<li>å‘ç° key ç›¸ç­‰çš„EntryèŠ‚ç‚¹äº†ï¼Œ ç›´æ¥èµ‹å€¼ï¼Œç„¶åæ¸…é™¤å…¶ä»– Entry != null ä½†æ˜¯ k == null çš„èŠ‚ç‚¹ï¼Œ å¹¶è¿”å›ã€‚</li>
<li>æ²¡æœ‰æ‰¾åˆ°keyç›¸ç­‰çš„èŠ‚ç‚¹ï¼Œä½†æ˜¯æ‰¾åˆ°äº†ä¸‹ä¸€ä¸ª Entry != null ä½†æ˜¯ k == nullï¼Œ ä¸”æ­¤æ—¶ slotToExpunge æœªå‘ç”Ÿå˜åŒ–ï¼Œè¿˜æ˜¯æŒ‡å‘ staleSlotï¼Œ åˆ™ i èµ‹å€¼ç»™ slotToExpungeã€‚</li>
</ol>
</li>
<li>å‘åæ‰«ææ²¡æœ‰æ‰«æåˆ°ï¼Œåˆ™ç›´æ¥å¯¹å½“å‰èŠ‚ç‚¹ï¼ˆç´¢å¼•å€¼ä¸ºstaleSlotï¼‰çš„èŠ‚ç‚¹çš„valueè®¾ç½®ä¸ºnullï¼Œå¹¶æŒ‡å‘æ–°valueã€‚</li>
<li>ç»“æŸä¹‹åå‘ç° slotToExpunge è¢«æ”¹å˜äº†ï¼Œ è¯´æ˜è¿˜æœ‰å…¶ä»–çš„è¦æ¸…é™¤ã€‚</li>
</ol>
<h5 id="getEntry-æ–¹æ³•"><a href="#getEntry-æ–¹æ³•" class="headerlink" title="getEntry()æ–¹æ³•"></a>getEntry()æ–¹æ³•</h5><pre><code class="java">
private Entry getEntry(ThreadLocal&lt;?&gt; key) &#123;
    // hashcodeå–æ¨¡æ±‚æ•°ç»„ç´¢å¼•
    int i = key.threadLocalHashCode &amp; (table.length - 1);
    Entry e = table[i];
    if (e != null &amp;&amp; e.get() == key)
        // å­˜åœ¨åˆ™è¿”å›
        return e;
    else
        // ä¸å­˜åœ¨
        return getEntryAfterMiss(key, i, e);
&#125;

private Entry getEntryAfterMiss(ThreadLocal&lt;?&gt; key, int i, Entry e) &#123;
    Entry[] tab = table;
    int len = tab.length;

    while (e != null) &#123;
        ThreadLocal&lt;?&gt; k = e.get();
        if (k == key)
            return e;
        if (k == null)
            // key å·²ç» == null äº† æ¸…é™¤ä¸€ä¸‹ value
            expungeStaleEntry(i);
        else
            // ç»§ç»­è·å–ä¸‹ä¸€ä¸ª
            i = nextIndex(i, len);
        e = tab[i];
    &#125;
    return null;
&#125;</code></pre>
<ol>
<li>hashcode å–æ¨¡æ±‚æ•°ç»„ç´¢å¼•ã€‚</li>
<li>ç´¢å¼•å¤„è·å–åˆ° Entry åˆ™ç›´æ¥è¿”å›ã€‚</li>
<li>è·å–ä¸åˆ°æˆ–è€…è·å–åˆ°çš„ Entry key ä¸ç›¸ç­‰æ—¶ï¼Œæœ‰å¯èƒ½æ˜¯å› ä¸º hash å†²çªï¼Œè¢«æ”¾åˆ°åˆ«çš„åœ°æ–¹ï¼Œ è°ƒç”¨ getEntryAfterMiss æ–¹æ³•ã€‚</li>
<li>getEntryAfterMiss æ–¹æ³•ä¸­ã€‚<ol>
<li>e == null  è¿”å›nullã€‚</li>
<li>e != null  åˆ¤æ–­keyï¼Œ keyç›¸ç­‰è¿”å› Entryï¼Œ key == nullï¼Œ é‚£å°±éœ€è¦æ¸…é™¤è¿™ä¸ªèŠ‚ç‚¹ï¼Œç„¶åç»§ç»­æŒ‰ç…§ <code>nextIndex(i, len)</code> æ–¹æ³•æ‰¾ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
</ol>
</li>
</ol>
<h4 id="remove-æ–¹æ³•-1"><a href="#remove-æ–¹æ³•-1" class="headerlink" title="remove()æ–¹æ³•"></a>remove()æ–¹æ³•</h4><pre><code class="java">
private void remove(ThreadLocal&lt;?&gt; key) &#123;
    Entry[] tab = table;
    int len = tab.length;
    // hashcode å–æ¨¡æ±‚æ•°ç»„ç´¢å¼•
    int i = key.threadLocalHashCode &amp; (len-1);
    // æ¸…é™¤å½“å‰èŠ‚ç‚¹çš„value
    for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) &#123;
        if (e.get() == key) &#123;
            // æ¸…æ¥šå¯¹è±¡å¼•ç”¨
            e.clear();
            // value æŒ‡å‘ null
            expungeStaleEntry(i);
            return;
        &#125;
    &#125;
&#125;
public void clear() &#123;
    this.referent = null;
&#125;</code></pre>
<ol>
<li>hashcode å–æ¨¡æ±‚æ•°ç»„ç´¢å¼•ã€‚</li>
<li>å¾ªç¯æŸ¥æ‰¾æ•°ç»„ï¼Œå°†å½“å‰ key çš„ Entry çš„å¼•ç”¨ï¼Œå°† value è®¾ç½®ä¸º nullï¼Œ åé¢ä¼šè¢«åƒåœ¾å›æ”¶æ‰ã€‚</li>
</ol>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ"></a>ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ</h4><p>ThreadLocal çš„ get()ã€set()ã€remove()æ–¹æ³•ä¸­éƒ½æœ‰ <code>Thread t = Thread.currentThread();</code> æ“ä½œçš„å…¶å®æ˜¯æœ¬çº¿ç¨‹ï¼Œè·å–æœ¬çº¿ç¨‹çš„ThreadLocalMapã€‚</p>
<p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ ThreadLocalï¼Œå¹¶ä¸”æ˜¯å°† value å­˜æ”¾åœ¨ä¸€ä¸ªä»¥ ThreadLocal ä¸º key çš„ ThreadLocalMap ä¸­çš„ã€‚æ‰€ä»¥çº¿ç¨‹é—´éš”ç¦»ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ"></a>ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ</h4><p>Javaå¼€å‘æ‰‹å†Œå·²ç»ç»™å‡ºè¯´æ˜ï¼Œè¿˜æœ‰å°±æ˜¯ï¼Œå¦‚æœ ThreadLocal è®¾ç½®ä¸ºéé™æ€ï¼Œé‚£å°±æ˜¯æŸä¸ªçº¿ç¨‹çš„å®ä¾‹ç±»ï¼Œè¿™æ ·çš„è¯å°±ä¼šå¤±å»äº†çº¿ç¨‹å…±äº«çš„æœ¬è´¨å±æ€§ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆå¼ºåˆ¶å¿…é¡»æ—¶å€™åremove-ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå¼ºåˆ¶å¿…é¡»æ—¶å€™åremove-ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå¼ºåˆ¶å¿…é¡»æ—¶å€™åremove()ï¼Ÿ"></a>ä¸ºä»€ä¹ˆå¼ºåˆ¶å¿…é¡»æ—¶å€™åremove()ï¼Ÿ</h4><p>è¿™å—å¯ä»¥å’Œå†…å­˜æ³„éœ²ä¸€å—è¯´æ˜ï¼Œ é€šè¿‡ä¸Šé¢çš„ <code>ThreadLocalMap</code> å¤„å…³äºå¼±å¼•ç”¨çš„è®²è§£å·²ç»è¯´æ˜ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚è‡³äºå¦‚ä½•è§£å†³ä¹Ÿç»™å‡ºäº†ç­”æ¡ˆï¼š</p>
<p>1.<code>set()</code> æ—¶æ¸…é™¤ Entry != null &amp;&amp; key == null çš„èŠ‚ç‚¹ï¼Œ å°†å…¶ value è®¾ç½®ä¸º nullã€‚<br>2.<code>getEntry()</code> æ—¶æ¸…é™¤<code>å½“å‰ key åˆ° nextIndex(i, len)==null ä¹‹é—´çš„</code> Entry != null &amp;&amp; key == null çš„èŠ‚ç‚¹ï¼Œ å°†å…¶ value è®¾ç½®ä¸º nullã€‚<br>3.<code>remove()</code> æ—¶æ¸…é™¤<code>æŒ‡å®škey</code>çš„ Entry != null &amp;&amp; key == null çš„èŠ‚ç‚¹ï¼Œ å°†å…¶ value è®¾ç½®ä¸º nullã€‚</p>
<p>ä¹‹æ‰€ä»¥ä½¿ç”¨remove()ï¼Œè¿˜æ˜¯ä¸ºäº†è§£å†³å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚</p>
<h4 id="Last"><a href="#Last" class="headerlink" title="Last"></a>Last</h4><ol>
<li>ä½¿ç”¨æ—¶æ³¨æ„å£°æ˜ä¸º <code>private static final</code>ã€‚</li>
<li>ä½¿ç”¨åè¦ <code>remove()</code>ã€‚</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">liuzhihang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://liuzhihang.com/2020/06/21/source-code-threadlocal.html">https://liuzhihang.com/2020/06/21/source-code-threadlocal.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://liuzhihang.com" target="_blank">ç¨‹åºå‘˜å°èˆª</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/">æºç ç¬”è®°</a><a class="post-meta__tags" href="/tags/JDK/">JDK</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/threadlocal.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/06/28/source-code-longadder.html"><img class="prev-cover" src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/longadder-article.jpeg" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/92776_n5aac6.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ã€JDKæºç ç¬”è®°ã€‘- JDK 8 æ–°å¢çš„ LongAdderï¼Œå¾—è¿‡æ¥çœ‹ä¸€ä¸‹ï¼</div></div></a></div><div class="next-post pull-right"><a href="/2020/06/12/source-code-cas.html"><img class="next-cover" src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/cas.jpeg" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/92776_n5aac6.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">ã€JDKæºç ç¬”è®°ã€‘- ä»JUCæºç çœ‹CASï¼Œæˆ‘åšäº†ä¸ªç¬”è®° ......</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2020/09/27/source-code-arrayblockingqueue.html" title="ã€JDKæºç ç¬”è®°ã€‘- åŸºäºæ•°ç»„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ— â€”â€” ArrayBlockingQueue"><img class="cover" src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ArrayBlockingQueue-cover-ESuNmo.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-27</div><div class="title">ã€JDKæºç ç¬”è®°ã€‘- åŸºäºæ•°ç»„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ— â€”â€” ArrayBlockingQueue</div></div></a></div><div><a href="/2020/06/12/source-code-cas.html" title="ã€JDKæºç ç¬”è®°ã€‘- ä»JUCæºç çœ‹CASï¼Œæˆ‘åšäº†ä¸ªç¬”è®° ......"><img class="cover" src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/cas.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-12</div><div class="title">ã€JDKæºç ç¬”è®°ã€‘- ä»JUCæºç çœ‹CASï¼Œæˆ‘åšäº†ä¸ªç¬”è®° ......</div></div></a></div><div><a href="/2020/10/25/source-code-concurrentlinkedqueue.html" title="ã€JDKæºç ç¬”è®°ã€‘- éé˜»å¡çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ— â€”â€” ConcurrentLinkedQueue"><img class="cover" src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/concurrentlinkedqueue-6pf8RL.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-25</div><div class="title">ã€JDKæºç ç¬”è®°ã€‘- éé˜»å¡çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ— â€”â€” ConcurrentLinkedQueue</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/404/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">liuzhihang</div><div class="author-info__description">å­¦ï¼Œç„¶åçŸ¥ä¸è¶³ï¼›æ•™ï¼Œç„¶åçŸ¥å›°ã€‚</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">126</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">50</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">28</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/liuzhihang"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/liuzhihang" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=Vjo-Iyw_Pz43ODElFicneDU5Ow" target="_blank" title="Email"><i class="fas fa-envelope-open"></i></a><a class="social-icon" href="https://weibo.com/onlyhang" target="_blank" title="Weibo"><i class="fab fa-weibo"></i></a><a class="social-icon" href="https://twitter.com/liuzhihangs" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a><a class="social-icon" href="https://www.infoq.cn/u/liuzhihang/publish" target="_blank" title="InfoQ"><i class="iconfont iconweibiaoti-1"></i></a><a class="social-icon" href="https://juejin.im/user/1987506650493117" target="_blank" title="æ˜é‡‘"><i class="iconfont iconjuejin-1"></i></a><a class="social-icon" href="https://blog.csdn.net/qq_36535538" target="_blank" title="CSDN"><i class="iconfont iconcsdn"></i></a><a class="social-icon" href="https://www.zhihu.com/people/liuzhihang" target="_blank" title="çŸ¥ä¹"><i class="iconfont iconzhihu1"></i></a><a class="social-icon" href="https://leetcode-cn.com/u/liuzhihang" target="_blank" title="LeetCode"><i class="iconfont iconleetcode"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>å…¬å‘Š</span></div><div class="announcement_content">ğŸ§‘â€ğŸ’»æ„Ÿè°¢è®¿é—®æœ¬ç«™ï¼Œè‹¥å–œæ¬¢è¯·æ”¶è— ^_^ <br> <br> <img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/wechat.jpg"> <br> ä¸ªäººå…¬ä¼—å·:ã€ ç¨‹åºå‘˜å°èˆª ã€</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-text">ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-text">ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="toc-text">ä»£ç å¦‚ä¸‹ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%9B%E5%87%BA%E9%97%AE%E9%A2%98"><span class="toc-text">æŠ›å‡ºé—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">æºç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Thread"><span class="toc-text">Thread</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal"><span class="toc-text">ThreadLocal</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#set-T-value-%E6%96%B9%E6%B3%95"><span class="toc-text">set(T value)æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#get-%E6%96%B9%E6%B3%95"><span class="toc-text">get()æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#remove-%E6%96%B9%E6%B3%95"><span class="toc-text">remove()æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocalMap"><span class="toc-text">ThreadLocalMap</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%8F%8Ahash%E8%AE%A1%E7%AE%97"><span class="toc-text">æ„é€ å‡½æ•°åŠhashè®¡ç®—</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#set-%E6%96%B9%E6%B3%95"><span class="toc-text">set()æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getEntry-%E6%96%B9%E6%B3%95"><span class="toc-text">getEntry()æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#remove-%E6%96%B9%E6%B3%95-1"><span class="toc-text">remove()æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AF%E4%BB%A5%E7%BA%BF%E7%A8%8B%E7%A7%81%E6%9C%89%EF%BC%9F"><span class="toc-text">ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BB%BA%E8%AE%AE%E5%A3%B0%E6%98%8E%E4%B8%BA%E9%9D%99%E6%80%81%EF%BC%9F"><span class="toc-text">ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BC%BA%E5%88%B6%E5%BF%85%E9%A1%BB%E6%97%B6%E5%80%99%E5%90%8Eremove-%EF%BC%9F"><span class="toc-text">ä¸ºä»€ä¹ˆå¼ºåˆ¶å¿…é¡»æ—¶å€™åremove()ï¼Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Last"><span class="toc-text">Last</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/06/07/mysql-next-key-4.html" title="MySQL next-key lock åŠ é”èŒƒå›´æ€»ç»“"><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ZnytZB-FhqOd8.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/92776_n5aac6.jpg'" alt="MySQL next-key lock åŠ é”èŒƒå›´æ€»ç»“"/></a><div class="content"><a class="title" href="/2021/06/07/mysql-next-key-4.html" title="MySQL next-key lock åŠ é”èŒƒå›´æ€»ç»“">MySQL next-key lock åŠ é”èŒƒå›´æ€»ç»“</a><time datetime="2021-06-07T11:30:30.000Z" title="å‘è¡¨äº 2021-06-07 19:30:30">2021-06-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/06/07/ides-plugin-toolkit-lombok.html" title="Toolkit Json è½¬å®ä½“ä¹Ÿå¯ä»¥æ”¯æŒ lombok äº†ï¼"><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/dbzZgg-zDjPI7.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/92776_n5aac6.jpg'" alt="Toolkit Json è½¬å®ä½“ä¹Ÿå¯ä»¥æ”¯æŒ lombok äº†ï¼"/></a><div class="content"><a class="title" href="/2021/06/07/ides-plugin-toolkit-lombok.html" title="Toolkit Json è½¬å®ä½“ä¹Ÿå¯ä»¥æ”¯æŒ lombok äº†ï¼">Toolkit Json è½¬å®ä½“ä¹Ÿå¯ä»¥æ”¯æŒ lombok äº†ï¼</a><time datetime="2021-06-07T11:30:30.000Z" title="å‘è¡¨äº 2021-06-07 19:30:30">2021-06-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/06/06/docker-mysql.html" title="ä½¿ç”¨ Docker å®‰è£…å¹¶è¿æ¥ MySQL"><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/kiUEMZ-BRFqnd.png" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/92776_n5aac6.jpg'" alt="ä½¿ç”¨ Docker å®‰è£…å¹¶è¿æ¥ MySQL"/></a><div class="content"><a class="title" href="/2021/06/06/docker-mysql.html" title="ä½¿ç”¨ Docker å®‰è£…å¹¶è¿æ¥ MySQL">ä½¿ç”¨ Docker å®‰è£…å¹¶è¿æ¥ MySQL</a><time datetime="2021-06-06T11:30:30.000Z" title="å‘è¡¨äº 2021-06-06 19:30:30">2021-06-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/06/06/mysql-next-key-1.html" title="MySQL next-key lock åŠ é”èŒƒå›´æ˜¯ä»€ä¹ˆï¼Ÿ"><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ZnytZB-FhqOd8.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/92776_n5aac6.jpg'" alt="MySQL next-key lock åŠ é”èŒƒå›´æ˜¯ä»€ä¹ˆï¼Ÿ"/></a><div class="content"><a class="title" href="/2021/06/06/mysql-next-key-1.html" title="MySQL next-key lock åŠ é”èŒƒå›´æ˜¯ä»€ä¹ˆï¼Ÿ">MySQL next-key lock åŠ é”èŒƒå›´æ˜¯ä»€ä¹ˆï¼Ÿ</a><time datetime="2021-06-06T11:30:30.000Z" title="å‘è¡¨äº 2021-06-06 19:30:30">2021-06-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/06/06/mysql-next-key-2.html" title="çœ‹æ¥ï¼ŒMySQL next-key lock çš„ bug å¹¶æ²¡æœ‰è¢«ä¿®å¤ï¼"><img src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/article/ZnytZB-FhqOd8.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/feature/92776_n5aac6.jpg'" alt="çœ‹æ¥ï¼ŒMySQL next-key lock çš„ bug å¹¶æ²¡æœ‰è¢«ä¿®å¤ï¼"/></a><div class="content"><a class="title" href="/2021/06/06/mysql-next-key-2.html" title="çœ‹æ¥ï¼ŒMySQL next-key lock çš„ bug å¹¶æ²¡æœ‰è¢«ä¿®å¤ï¼">çœ‹æ¥ï¼ŒMySQL next-key lock çš„ bug å¹¶æ²¡æœ‰è¢«ä¿®å¤ï¼</a><time datetime="2021-06-06T11:30:30.000Z" title="å‘è¡¨äº 2021-06-06 19:30:30">2021-06-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2021 By liuzhihang</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn/"><img class="icp-icon" src= "https://cdn.jsdelivr.net/gh/liuzhihang/oss/pic/loading.gif" data-lazy-src="/resources/image/icp.png"><span>å¤‡æ¡ˆå·ï¼šäº¬ICPå¤‡20000888å·</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'e48f300349e2ac2d03bd',
      clientSecret: '001c669e6269dfd9d7d9fef029cc71fd00ea69e3',
      repo: 'comments',
      owner: 'liuzhihang',
      admin: ['liuzhihang'],
      id: 'baa9d9fa32d1b164e09325a5eb3b6eef',
      language: 'en',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>