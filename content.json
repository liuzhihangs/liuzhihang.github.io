{"meta":{"title":"ç¨‹åºå‘˜å°èˆª","subtitle":null,"description":"å­¦ï¼Œç„¶åçŸ¥ä¸è¶³ï¼›æ•™ï¼Œç„¶åçŸ¥å›°ã€‚","author":"liuzhihang","url":"https://liuzhihang.com","root":"/"},"pages":[{"title":"","date":"2019-12-23T06:35:08.833Z","updated":"2019-08-11T08:37:20.375Z","comments":true,"path":"google6f3e65f7f7a779a2.html","permalink":"https://liuzhihang.com/google6f3e65f7f7a779a2.html","excerpt":"","text":"google-site-verification: google6f3e65f7f7a779a2.html"},{"title":"404 Not Foundï¼šè¯¥é¡µæ— æ³•æ˜¾ç¤º","date":"2020-12-27T09:23:14.248Z","updated":"2020-12-27T09:23:14.248Z","comments":true,"path":"/404.html","permalink":"https://liuzhihang.com/404.html","excerpt":"","text":"å•Š~å“¦~ æ‚¨è¦æŸ¥çœ‹çš„é¡µé¢ä¸å­˜åœ¨æˆ–å·²åˆ é™¤ï¼ è¯·æ£€æŸ¥æ‚¨è¾“å…¥çš„ç½‘å€æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è€…ç‚¹å‡»é“¾æ¥ç»§ç»­æµè§ˆç©ºé—´ æ‚¨å¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€ è¿”å›ä¸Šçº§ å›åˆ°é¦–é¡µ"},{"title":"åˆ†ç±»","date":"2020-04-04T04:12:06.732Z","updated":"2020-04-04T04:12:06.732Z","comments":true,"path":"categories/index.html","permalink":"https://liuzhihang.com/categories/index.html","excerpt":"","text":""},{"title":"å…³äºæˆ‘","date":"2020-12-27T09:23:14.247Z","updated":"2020-12-27T09:23:14.247Z","comments":true,"path":"about/index.html","permalink":"https://liuzhihang.com/about/index.html","excerpt":"","text":"Javaå¼€å‘, çƒ­çˆ±äº’è”ç½‘, é—²æš‡æ—¶é—´ä¼šçœ‹çœ‹è§†é¢‘, æ•™ç¨‹, çœ‹ä¹¦. å†™å†™å­¦ä¹ ç¬”è®°.å–œæ¬¢è·‘æ­¥ (è¿™å®¶ä¼™å¾ˆæ‡’, å·²ç»å¾ˆä¹…æ²¡è·‘æ­¥äº†~)å¶å°”æ‰“æ‰“ç‹è€… (æ··åˆ†å¤§ç‹~)æ›´å¤šçš„æ—¶é—´æ˜¯æ¯”è¾ƒå®…! Label:java åç«¯ æ”¯ä»˜ å¼€å‘ ç¨‹åºçŒ¿ coder Experience 2019-12 - è‡³ä»Š åŒ—äº¬æ¬§éç§‘æŠ€æœ‰é™å…¬å¸(Opay) 2017.04 - 2019-12 ç°åœ¨æ”¯ä»˜è‚¡ä»½æœ‰é™å…¬å¸ Otheræ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼äº†è§£æˆ‘ Blog: https://liuzhihang.com/GitHub: https://github.com/liuzhihangLeetCode: https://leetcode-cn.com/u/liuzhihang/CSDN: https://blog.csdn.net/qq_36535538çŸ¥ä¹: https://www.zhihu.com/people/liuzhihang å…¬ä¼—å· æ‰«ç å…³æ³¨"},{"title":"ç•™è¨€æ¿","date":"2020-12-27T09:55:14.776Z","updated":"2020-12-27T09:55:14.776Z","comments":true,"path":"contact/index.html","permalink":"https://liuzhihang.com/contact/index.html","excerpt":"","text":"æ¬¢è¿ç•™è¨€å¤§å®¶æœ‰ä»€ä¹ˆé—®é¢˜éƒ½å¯ä»¥ç»™æˆ‘ç•™è¨€, éå¸¸æ¬¢è¿å’Œå¤§å®¶æ²Ÿé€šäº¤æµ. åšå®¢å†…å®¹ä¸ºä¸ªäººå­¦ä¹ ç¬”è®°, è‚¯å®šæœ‰ç†è§£çš„ä¸åˆ°ä½çš„åœ°æ–¹, éå¸¸æ¬¢è¿å¤§å®¶æŒ‡æ­£."},{"title":"friends","date":"2020-01-04T15:20:32.041Z","updated":"2020-01-04T15:20:32.041Z","comments":true,"path":"friends/index.html","permalink":"https://liuzhihang.com/friends/index.html","excerpt":"","text":"æ¬¢è¿äº¤æ¢å‹é“¾ï¼æ ¼å¼1: åšå®¢åå­—: liuzhihangåšå®¢åœ°å€: https://liuzhihang.com/åšå®¢å¤´åƒ: https://liuzhihang.com/medias/avatar.jpgåšå®¢ç®€ä»‹: Work study notes about java programmers â€¦ æ ¼å¼2:&#123; &quot;name&quot;: &quot;liuzhihang&quot;, &quot;url&quot;: &quot;https://liuzhihang.com/&quot;, &quot;avatar&quot;: &quot;https://liuzhihang.com/medias/avatar.jpg&quot;, &quot;introduction&quot;: &quot;Work study notes about java programmers ...&quot;, &quot;title&quot;: &quot;å‰å»å­¦ä¹ &quot;&#125;"},{"title":"å‹æƒ…é“¾æ¥","date":"2020-10-20T06:05:40.060Z","updated":"2020-10-20T06:05:40.060Z","comments":true,"path":"link/index.html","permalink":"https://liuzhihang.com/link/index.html","excerpt":"","text":"è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç•™è¨€name: å§“ålink: é“¾æ¥åœ°å€avatar: å¤´åƒdescr: ä»‹ç»"},{"title":"Repositories","date":"2019-12-23T06:35:08.828Z","updated":"2019-09-08T04:26:22.862Z","comments":true,"path":"repository/index.html","permalink":"https://liuzhihang.com/repository/index.html","excerpt":"","text":""},{"title":"å›½å†…èšåˆæ”¯ä»˜","date":"2017-11-19T09:42:43.000Z","updated":"2019-10-01T09:07:11.366Z","comments":true,"path":"project/aggregate-pay.html","permalink":"https://liuzhihang.com/project/aggregate-pay.html","excerpt":"","text":"ç³»ç»Ÿæ¶æ„ èšåˆæ”¯ä»˜é¡¹ç›®, ç»´æŠ¤å’Œè¿­ä»£, å¯¹æ¥å•†æˆ·å’Œæ¸ é“.å‚ä¸é¡¹ç›®: å…¬ä¼—å·, å¡ç‰Œ, å°ç¨‹åº å¼€å‘ç¯å¢ƒIDEAã€JDK1.8ã€Tomcat 7ã€MySQLã€Gitã€Maven è½¯ä»¶æ¶æ„Spring + SpringMVC + MyBatis + Redis + Dubbo + Zookeeper + RabbitMQ å¼€å‘æ—¶é—´2017.11 - è‡³ä»Š é¡¹ç›®ä»‹ç»èšåˆæ”¯ä»˜ç³»ç»Ÿä¸€å…±æ¶‰åŠåˆ° APIç³»ç»Ÿ, å…¬ä¼—å·, å¡ç‰Œ, å°ç¨‹åº, H5ç­‰äº¤æ˜“ç³»ç»Ÿ, åº”ç”¨ä¸­å¿ƒ, æ¸…ç»“ç®—, è®¡è´¹ä¸­å¿ƒ, æ•°æ®ä¸­å¿ƒç­‰å…¶ä»–æ”¯æŒç³»ç»Ÿ, è¿™é‡Œä»…ä»…ä»‹ç»äº¤æ˜“ç›¸å…³ç³»ç»Ÿ, å¹¶ä¸”ä»¥å…¬ä¼—å·ç³»ç»Ÿä¸ºä¾‹. APIç³»ç»Ÿ: ç›¸å½“äºç½‘å…³, å¯¹å¤–æä¾›ç»Ÿä¸€æ¥å£, è´Ÿè´£ç»Ÿä¸€åŠ ç­¾éªŒç­¾, æ ¹æ®å‚æ•°è·¯ç”±åˆ°å„ä¸ªå­ç³»ç»Ÿ, è¿‡æ»¤è¯·æ±‚ç­‰ç­‰. å…¬ä¼—å·ç³»ç»Ÿ: èšåˆå¾®ä¿¡å…¬ä¼—å·, æ”¯ä»˜å®æœåŠ¡çª—, æ‰‹Qå…¬ä¼—å·ç­‰å¤šç§æ”¯ä»˜æ–¹å¼, ä¸ºå•†æˆ·æä¾›ç»Ÿä¸€æ¥å£, å¦‚åŸç”Ÿå¾®ä¿¡ã€ åŸç”Ÿæ”¯ä»˜å®ã€ å¾®ä¼—é“¶è¡Œã€ åœ°æ–¹é“¶å•†è¡Œç­‰, æ”¯æŒé€šé“ä¸€é”®åˆ‡æ¢. å®šæ—¶ç³»ç»Ÿ: å®šæ—¶æ‰¹å¤„ç†, è¡¥å•ç­‰ä»»åŠ¡å‘èµ·æœåŠ¡. é«˜å³°æ—¶æœŸæ—¥å‡800wç¬”äº¤æ˜“. è´£ä»»æè¿°ç³»ç»Ÿä»£ç ç»´æŠ¤å’Œé‡æ„, å¯¹æ¥å•†æˆ·å’Œæ¸ é“, ä½¿ç”¨å„ç§åŠ ç­¾éªŒç­¾æ–¹å¼å’Œæ¸ é“äº¤äº’, çº¿ä¸Šç”Ÿäº§é—®é¢˜æ’æŸ¥, ç‰ˆæœ¬è¿­ä»£, åŠæ–°éœ€æ±‚æ–°åŠŸèƒ½å¼€å‘. æ€»ç»“ä¸»è¦æ˜¯å¯¹æ¥é“¶è¡Œç­‰å„ä¸ªæ¸ é“, é“¶è¡Œä¹‹é—´çš„åŠ å¯†åŠ ç­¾æ–¹å¼å„ä¸ç›¸åŒ, éœ€è¦å¤šè¿›è¡Œæµ‹è¯•.æ¶‰åŠåˆ°äº¤æ˜“, è¦ä¿è¯äº¤æ˜“é‡‘é¢æ­£ç¡®, é˜²æ­¢èµ„æŸ.å‘ç”Ÿé—®é¢˜æ—¶è¦åŠæ—¶å®šä½é—®é¢˜, é©¬ä¸Šæ’æŸ¥. å…¬ä¼—å·:0æ¨¡å¼: æœåŠ¡å•†æ¨¡å¼, å•†æˆ·å°†åº”ç”¨æŒ‚åœ¨æˆ‘æ–¹appä¸‹, ç”±æˆ‘æ–¹æ‹‰èµ·æ”¯ä»˜1æ¨¡å¼: å•†æˆ·ä¸‹å•, æˆ‘æ–¹è¿”å›æ”¯ä»˜è¦ç´  2.0 æ‹†åˆ†å¯¹æ¥æ¸ é“é¡¹ç›®ä¸ºæ¸ é“ç»„ä»¶, å…¬ä¼—å·ã€H5ã€SDKç­‰å„ä¸ªæ¸ é“åªéœ€è¦å¼•å…¥æ¸ é“ç»„ä»¶, å¯¹æ¥æ¸ é“ç»„ä»¶å³å¯. å³æ¸ é“ç»„ä»¶è´Ÿè´£å°†å„ä¸ªæ¸ é“çš„æ¥å£æ¨¡å‹è½¬æ¢ä¸ºå›ºå®šçš„æ¨¡å‹."},{"title":"è·¨å¢ƒæ”¯ä»˜ç³»ç»Ÿæ€»ç»“","date":"2017-11-19T09:42:43.000Z","updated":"2019-09-30T13:11:31.222Z","comments":true,"path":"project/crossborder-pay.html","permalink":"https://liuzhihang.com/project/crossborder-pay.html","excerpt":"","text":"ç®€è¿° æ¥åˆ°è¿™è¾¹æ¥è§¦çš„ç¬¬ä¸€ä¸ªé¡¹ç›®, å¾ˆä¹…ä¹‹å‰äº†, å·²ç»è®°å¾—ä¸æ˜¯å¾ˆæ¸…æ¥šäº†. é¡¹ç›®æè¿°è·¨å¢ƒæ”¯ä»˜, ç³»ç»Ÿä¸»è¦åˆ†ä¸ºå››å—: äº¤æ˜“ç³»ç»Ÿ, å®šæ—¶ç³»ç»Ÿ, å•†æˆ·åå°, è¿è¥åå°äº¤æ˜“ç³»ç»Ÿ: å¯¹æ¥å„ä¸ªæ¸ é“(å¾®ä¿¡å¡ç‰Œ, å¾®ä¿¡å…¬ä¼—å·, æ”¯ä»˜å®ç­‰), æ”¯æŒä¸€ç å¤šä»˜, å®æ—¶æ±‡ç‡ç­‰å®šæ—¶ç³»ç»Ÿ: ä¸šåŠ¡ç³»ç»Ÿç›¸å…³çš„å„ä¸ªå®šæ—¶ä»»åŠ¡å•†æˆ·åå°: å•†æˆ·æŸ¥çœ‹äº¤æ˜“è®°å½•, å‘èµ·é€€æ¬¾ç­‰æ“ä½œä¸­å¿ƒè¿è¥åå°: å•†æˆ·è¿›ä»¶, é…ç½®è´¹ç‡ç­‰ è´£ä»»æè¿° å’Œå°ä¼™ä¼´ä¸€èµ·é‡æ„ä»£ç +ç†Ÿæ‚‰é¡¹ç›® å¯¹æ¥æ”¯ä»˜å®è·¨å¢ƒæ”¯ä»˜ å¯¹æ¥å•†æˆ· å…¶ä»– æš‚æ—¶æƒ³ä¸èµ·æ¥äº†"},{"title":"å¡+ç³»ç»Ÿ","date":"2017-11-19T09:42:43.000Z","updated":"2019-09-30T13:08:23.534Z","comments":true,"path":"project/go-card.html","permalink":"https://liuzhihang.com/project/go-card.html","excerpt":"","text":"åŸºæœ¬é€»è¾‘ ä»…ä»…ä»£è¡¨å¤§è‡´é€»è¾‘, å¹¶ä¸æ˜¯æµç¨‹å›¾ ä¼šå‘˜é€šè¿‡å°ç¨‹åºä»¥å…«æŠ˜è´­ä¹°æŸåº—é“ºçš„ä¼šå‘˜å¡â€“goå¡ æ™®é€šç”¨æˆ·æ¶ˆè´¹, é€šè¿‡äºŒç»´ç å¡ç‰Œè¿›è¡Œæ¶ˆè´¹ åå°é€šè¿‡ç®—æ³•, è®¡ç®—å‡ºæ‰£é™¤ goå¡ç¼–å·, æ‰£é™¤è¯¥å¡é¢ç›¸åŒé‡‘é¢ é‡‘é¢ä»¥æ¯”ä¾‹åˆ†æ¶¦ç»™ç”¨æˆ·å’Œæˆ‘å¸ å¥½å‹åœ¨åº—é“ºæ¶ˆè´¹å¯ä»¥æŒ‡å®šä½¿ç”¨å“ªå¼ ä¼šå‘˜å¡ â€“ è¿˜æœ‰æ¶ˆè´¹ 95æŠ˜ æ”¶ç›Šç‚¹: ç”¨æˆ·å…«æŠ˜è´­ä¹°ä¼šå‘˜å¡, å½“å¡é¢é‡‘é¢è¢«æ¶ˆè´¹å®Œ(è‡ªå·±æ¶ˆè´¹å’Œä»–äººæ¶ˆè´¹), è‡ªèº«æ‰€è·å¾—æ”¶ç›Šè¿œå¤§äºè´­ä¹°å¡çš„é‡‘é¢é£é™©ç‚¹: ä¼šå‘˜è´­å¡é‡‘é¢å­˜æ”¾, å¦‚æœç›´æ¥ç»™å•†æˆ·, å•†æˆ·å¯èƒ½å­˜åœ¨è·‘è·¯é£é™© å¼€å‘ç¯å¢ƒIDEAã€JDK1.8ã€Tomcat 7ã€MySQLã€Gitã€Maven è½¯ä»¶æ¶æ„SpringBoot + SpringMVC + MyBatis + Redis + Dubbo + Zookeeper å¼€å‘æ—¶é—´2017.06 - 2017.11 é¡¹ç›®ä»‹ç»è´­å¡é¡¹ç›®: è¯¥ç³»ç»Ÿåˆ†ä¸º å¡+é‡‘è, ä¼šå‘˜ä¸­å¿ƒ, å•†æˆ·åå°, å®šæ—¶ç³»ç»Ÿ, å‰ç«¯ç³»ç»Ÿ, è¿™æœ‰å¡ç®—æ³•æ ¸å¿ƒç­‰å‰ç«¯ç³»ç»Ÿ: é€šè¿‡å…¬ä¼—å·/å°ç¨‹åºå±•ç¤ºå•†æˆ·ä¿¡æ¯, å¡æ”¶ç›Šç‡ç­‰ä¿¡æ¯, è´Ÿè´£å’Œåå°ç³»ç»Ÿè¿›è¡Œäº¤äº’; å¡+é‡‘è: é¡¹ç›®æ ¸å¿ƒ, åˆ†ä¸ºæœ‰å¡æ¶ˆè´¹å’Œæ— å¡æ¶ˆè´¹, ä¸»è¦è¿›è¡Œç”¨æˆ·æ¶ˆè´¹, ä¹°å•äº¤æ˜“, ä¿®æ”¹è´¦æˆ·, åˆ†çº¢äº¤æ˜“, è½¬è´¦äº¤æ˜“ç­‰æ“ä½œ; ä¼šå‘˜ä¸­å¿ƒ: éªŒè¯ä¼šå‘˜ç™»å½•, ç»´æŒç™»å½•æ€, å­˜å‚¨ä¼šå‘˜ä¿¡æ¯ä»¥åŠä¼šå‘˜å¡ä¿¡æ¯ç­‰; å•†æˆ·åå°: å•†æˆ·å®æ—¶æŸ¥çœ‹å¡é”€å”®å’Œè®¢å•äº¤æ˜“æƒ…å†µ, è¿›è¡Œé€€æ¬¾ç­‰æ“ä½œçš„å¹³å°; å®šæ—¶ç³»ç»Ÿ: è´Ÿè´£å®šæ—¶ä»»åŠ¡ç»Ÿä¸€è¯·æ±‚è°ƒåº¦; è¿™æœ‰å¡: ç®—æ³•æ ¸å¿ƒ, å¡+é‡‘èè¯·æ±‚è¿™æœ‰å¡, è¿™æœ‰å¡é€šè¿‡ç®—æ³•è®¡ç®—å‡ºå•†æˆ·å’Œç”¨æˆ·å®æ—¶æ”¶ç›Šç‡ç­‰å¡ä¿¡æ¯, æ¶ˆè´¹æ—¶è·å–éœ€è¦æ‰£é™¤é‡‘é¢å¡çš„å¡å·; è´£ä»»æè¿°å‚ä¸æ¶æ„è®¾è®¡, æµç¨‹æ¢³ç†, è¡¨ç»“æ„è®¾è®¡ç­‰å·¥ä½œ, è´Ÿè´£å¡+é‡‘èç³»ç»Ÿ æ— å¡æ¶ˆè´¹, åˆ†çº¢ç»“ç®—, å¼‚æ­¥é€šçŸ¥, åŒæ­¥æ¸…ç®—äº¤æ˜“, ä¸ŠæŠ¥æ•°æ®ä¸­å¿ƒç­‰é€»è¾‘å®ç°, åŠå®šæ—¶ä»»åŠ¡ç¼–å†™å®ç°; è´Ÿè´£å•†æˆ·åå° åˆ†çº¢ä¿¡æ¯çš„æŸ¥è¯¢å’Œå¯¼å‡º, äº¤æ˜“åˆ—è¡¨åŠè¯¦æƒ…çš„å±•ç¤º, å¡ä¿¡æ¯ç¼–è¾‘å±•ç¤º; æ€»ç»“ ç»“åˆCç«¯ç”¨æˆ·å’Œå•†å®¶çš„ç¬¬ä¸€æ¬¡å°è¯•, åŒæ—¶å¯ä»¥åˆ©ç”¨åˆ°å…¬å¸çš„æ”¯ä»˜èµ„æº æœ¬æ¬¡ä½¿ç”¨çš„æ˜¯å…¬ä¼—å·å†…è¿›è¡Œå¡é”€å”®, åé¢è¿™æœ‰å¡å•ç‹¬å¼€å‘ â€˜å¡æ‹¼æ‹¼â€™ å°ç¨‹åºæ¥è¿›è¡Œç›¸å…³æ‹¼å¡ä¸šåŠ¡, ç›¸å½“äºæ˜¯å¯¹æœ¬é¡¹ç›®çš„è¿­ä»£"},{"title":"å–œèŒ¶æ€»ç»“","date":"2017-11-19T09:42:43.000Z","updated":"2019-09-30T13:08:23.552Z","comments":true,"path":"project/heytea.html","permalink":"https://liuzhihang.com/project/heytea.html","excerpt":"","text":"ç³»ç»Ÿæ¶æ„ ç‹¬ç«‹è´Ÿè´£å–œèŒ¶äº¤æ˜“ç³»ç»Ÿå¼€å‘, ç†Ÿæ‚‰æ•´ä½“ä¸šåŠ¡ å¼€å‘ç¯å¢ƒIDEAã€JDK1.8ã€Tomcat 7ã€MySQLã€Gitã€Maven è½¯ä»¶æ¶æ„SpringBoot + SpringMVC + MyBatis + Redis + Dubbo + Zookeeper + RabbitMQ å¼€å‘æ—¶é—´2018.07 - 2019.03 é¡¹ç›®ä»‹ç»é¡¹ç›®åŒ…æ‹¬: APIç³»ç»Ÿ, è®¢å•ç³»ç»Ÿ, å®šæ—¶ç³»ç»Ÿ, é€šçŸ¥ç³»ç»Ÿ, è´¦æˆ·ç³»ç»Ÿ, æ•°æ®ä¸­å¿ƒç­‰å‡ å¤§ç³»ç»ŸAPIç³»ç»Ÿ: ç»Ÿä¸€åŠ ç­¾éªŒç­¾, æ˜¯å¤–éƒ¨è¯·æ±‚çš„ç»Ÿä¸€å…¥å£; è®¢å•ç³»ç»Ÿ: å……å€¼, é€€æ¬¾, çº¿ä¸Šæ¶ˆè´¹, çº¿ä¸‹æ¶ˆè´¹, å†²æ­£ç­‰ä¸šåŠ¡æ ¸å¿ƒ; å®šæ—¶ç³»ç»Ÿ: å„ç³»ç»Ÿå®šæ—¶ä»»åŠ¡è§¦å‘çš„ç³»ç»Ÿ; é€šçŸ¥ç³»ç»Ÿ: ä»mqä¸­æ¶ˆè´¹æ•°æ®, æŒ‰ç…§é€šçŸ¥åœ°å€é€šçŸ¥å•†æˆ·; è´£ä»»æè¿°å‚ä¸ç³»ç»Ÿçš„è®¾è®¡ä¸æ¶æ„è®¨è®º, å¹¶è´Ÿè´£æ­å»ºå¼€å‘ APIç³»ç»Ÿ, è®¢å•ç³»ç»Ÿ, å®šæ—¶ç³»ç»Ÿ å’Œé€šçŸ¥ç³»ç»Ÿ.APIç³»ç»Ÿ, ç»Ÿä¸€åŠ ç­¾éªŒç­¾, å’Œå–œèŒ¶å¯¹æ¥ç›¸å…³æ¥å£. è®¢å•ç³»ç»Ÿ: å¯¹æ¥å¾®ä¿¡å°ç¨‹åºæ”¯ä»˜, å¾®ä¿¡é€€æ¬¾, å¼€å‘è´¦æˆ·å……å€¼, æ¶ˆè´¹, å†²æ­£, è¡¥å•ç­‰ä¸šåŠ¡é€»è¾‘, å…¶ä¸­æµæ°´å·ç³»ç»Ÿæ’¤é”€, ä½¿ç”¨é›ªèŠ±ç®—æ³•æ–¹å¼ä»£æ›¿æµæ°´å·ç³»ç»Ÿ; å®šæ—¶ç³»ç»Ÿ: è®¾å®šåˆç†çš„è°ƒåº¦åŒºé—´, å®šæ—¶è¡¥å•, å’ŒæŸ¥è¯¢äº¤æ˜“çŠ¶æ€, è¡¥å‘é€šçŸ¥çŠ¶æ€; é€šçŸ¥ç³»ç»Ÿ: æ¶ˆè´¹MQ, å¹¶é€šçŸ¥å•†æˆ·, åŒæ—¶å­˜å…¥æ•°æ®åº“, å¦‚æœé€šçŸ¥å¤±è´¥, åœ¨æŒ‡å®šæ—¶é—´é—´éš”å†…, è¡¥å‘é€šçŸ¥. æ€»ç»“ ç‹¬ç«‹å¼€å‘æ•´ä¸ªé¡¹ç›®, ä»APIç³»ç»Ÿåˆ°ä¸šåŠ¡ç³»ç»Ÿ, é€šçŸ¥ç³»ç»Ÿ æµæ°´å·ç³»ç»Ÿä½¿ç”¨é›ªèŠ±ç®—æ³• ä½¿ç”¨é˜¿é‡Œäº‘MQ, åŒæ—¶ç†Ÿæ‚‰é€šçŸ¥ç³»ç»Ÿæ•´ä½“ä¸šåŠ¡"},{"title":"ç°åœ¨æ”¯ä»˜","date":"2019-12-20T11:00:00.000Z","updated":"2020-04-22T09:25:54.889Z","comments":true,"path":"project/ipaynow.html","permalink":"https://liuzhihang.com/project/ipaynow.html","excerpt":"","text":"2017.04 - 2019-12 ç°åœ¨æ”¯ä»˜è‚¡ä»½æœ‰é™å…¬å¸, ç®€ç§°ipaynowåšä¸‰æ–¹æ”¯ä»˜ç›¸å…³ä¸šåŠ¡, å…ˆåå‚ä¸è·¨å¢ƒæ”¯ä»˜, ä»˜æ¬¾å¹³å°, ç›‘æ§ç³»ç»Ÿç­‰é¡¹ç›®çš„å¼€å‘. Project é•¿æœŸè¿ç»´, ä¸æ–­è¿­ä»£ è·¨å¢ƒæ”¯ä»˜: å¾®ä¿¡å…¬ä¼—å· å¡ç‰Œ æ”¯ä»˜å®, åç§»äº¤ç»™åˆ«çš„ç»„ å›½å†…èšåˆæ”¯ä»˜: å…¬ä¼—å· å¡ç‰Œ å°ç¨‹åº ä»˜æ¬¾å¹³å°&amp;æ¸ é“ç³»ç»Ÿ: ä»£æ‰£ä¸šåŠ¡ ç‹¬ç«‹è´Ÿè´£é¡¹ç›®å¼€å‘ å–œèŒ¶é’±åŒ…: äºŒç±»æˆ· + å–œèŒ¶ åˆä½œé¡¹ç›® éº¦å½“åŠ³Arch Card: éº¦å½“åŠ³é’±åŒ…å……å€¼æ¶ˆè´¹, å¡åˆ¸æ¶ˆè´¹ å†…éƒ¨è¿ç»´, ä»å¤´å¼€å§‹ æ—¥å¿—ç³»ç»Ÿ: ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ, æ–¹ä¾¿æŸ¥è¯¢é—®é¢˜ ç›‘æ§ç³»ç»Ÿ: å¯¹å„ç³»ç»Ÿè¿›è¡Œç›‘æ§, ä»å•†æˆ·å’Œæ¸ é“ä¸¤ä¸ªæ–¹é¢å¯¹äº¤æ˜“æ•°æ®è¿›è¡Œç›‘æ§ skywalkingåº”ç”¨ç›‘æ§: å®æ—¶æŸ¥çœ‹å„ç³»ç»Ÿæƒ…å†µ, æ¥å£è€—æ—¶ è½¬æ¢æ€è·¯, ä¸æ–­å°è¯• å¡+: ä¼šå‘˜å¡çš„é‡æ–°å®šä¹‰, è¾¾åˆ°é—²ç½®ä¼šå‘˜å¡å……åˆ†åˆ©ç”¨, çœŸæ­£å¯ä»¥èµšé’±çš„ä¼šå‘˜å¡ åœè½¦ç®¡å®¶: ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒç³Ÿç³•çš„é¡¹ç›® æ‘‡é’±æ ‘: å’ŒäºŒç±»æˆ·åˆä½œ, å¼€æˆ·è·å–åˆ†çº¢ å†…éƒ¨æ´»åŠ¨, ä¸´æ—¶å°é¡¹ç›® å®šæ—¶æŠ¢: ä¸€ä¸ªä¸´æ—¶å°åˆ›æ„, è®¾ç½®æ¸¸æˆè§„åˆ™, æŒ‰ç…§æ’åé¢†å–çº¢åŒ…"},{"title":"æ—¥å¿—ç³»ç»Ÿæ€»ç»“","date":"2017-11-19T09:42:43.000Z","updated":"2019-09-30T13:08:23.539Z","comments":true,"path":"project/log-system.html","permalink":"https://liuzhihang.com/project/log-system.html","excerpt":"","text":"è½¯ä»¶æ¶æ„Filebeat + Logstash + Elasticsearch + Kibana + Search-Guard é¡¹ç›®ä»‹ç»æ—¥å¿—ç³»ç»ŸåŸºäºELK, ä½¿ç”¨filebeatä»å„ä¸ªç³»ç»Ÿå–æŒ‡å®šæ ¼å¼çš„æ—¥å¿—, é€šè¿‡logstashå°†æ—¥å¿—æ¸…æ´—ç„¶åä¸ŠæŠ¥åˆ°ES; Kibanaä½¿ç”¨Search-Guardè¿›è¡Œæƒé™æ§åˆ¶ è´£ä»»æè¿°å‰æœŸå¯¹ELKè¿›è¡Œè°ƒç ”å’Œæ­å»º, è°ƒç ”Search-Guardæ’ä»¶, å¹¶æµ‹è¯•ä½¿ç”¨æ•ˆæœ, è¯„ä¼°å¯ç”¨æ€§. ç»Ÿä¸€æ—¥å¿—æ ¼å¼, å¹¶é€šè¿‡logstashè¿›è¡Œè¿‡æ»¤. å¯¹esè¿›è¡Œç›¸å…³ç³»ç»Ÿå­¦ä¹ , äº†è§£åº•å±‚åŸç†åŠå¦‚ä½•ä¼˜åŒ–. ç¼–å†™ç›¸å…³æ“ä½œæ–‡æ¡£, åŠæ—¥å¿—ç³»ç»Ÿæ¥å…¥æ–‡æ¡£, å¸®åŠ©å„ä¸ªç³»ç»Ÿå¯¹æ¥æ—¥å¿—ç³»ç»Ÿ. æ€»ç»“å‰æœŸä½¿ç”¨ELK+Search-Gurad, åæœŸå°ä¼™ä¼´å¼€å‘æ—¥å¿—ç»„ä»¶æ—¥å¿—ç»„ä»¶: æ‰€æœ‰é¡¹ç›®æ’æ‰æ—¥å¿—æ¨¡å—, ç»Ÿä¸€ä¾èµ–æ—¥å¿—ç»„ä»¶; è§„èŒƒæ—¥å¿—æ ¼å¼; åŒæ—¶æ—¥å¿—ç»„ä»¶å¯ä»¥ä½¿ç”¨ log4j appender ç›´æ¥ä¸ŠæŠ¥æ•°æ®åˆ°kafka æ–¹ä¾¿ç›‘æ§ç³»ç»Ÿç›‘æ§; æ—¥å¿—ç»„ä»¶ä½¿ç”¨skywalking traceId, å¯ä»¥è¿›è¡Œå…¨é“¾è·¯è¿½è¸ª;"},{"title":"éº¦å½“åŠ³ Arch Cardæ€»ç»“","date":"2017-11-19T09:42:43.000Z","updated":"2019-09-30T13:08:23.536Z","comments":true,"path":"project/mcd-arch-card.html","permalink":"https://liuzhihang.com/project/mcd-arch-card.html","excerpt":"","text":"ç³»ç»Ÿæ¶æ„ ä½¿ç”¨äº† SpringCloud, Feign, Apolloé…ç½®ä¸­å¿ƒ, CMQ ç­‰ å¼€å‘ç¯å¢ƒIDEAã€JDK1.8ã€Tomcat 7ã€TDBã€Gitã€Maven è½¯ä»¶æ¶æ„SpringBoot + SpringMVC + MyBatis + Redis + Dubbo + Zookeeper + SpringCloud + Apollo + CMQ å¼€å‘æ—¶é—´2018.07 - è‡³ä»Š é¡¹ç›®ä»‹ç»é¡¹ç›®åŒ…æ‹¬: APIç³»ç»Ÿ, è®¢å•ç³»ç»Ÿ, å®šæ—¶ç³»ç»Ÿ, é€šçŸ¥ç³»ç»Ÿ, è´¦æˆ·ç³»ç»Ÿ, æ•°æ®ä¸­å¿ƒç­‰å‡ å¤§ç³»ç»ŸAPIç³»ç»Ÿ: ç»Ÿä¸€åŠ ç­¾éªŒç­¾, æ˜¯å¤–éƒ¨è¯·æ±‚çš„ç»Ÿä¸€å…¥å£; è®¢å•ç³»ç»Ÿ: å……å€¼, é€€æ¬¾, çº¿ä¸Šæ¶ˆè´¹, çº¿ä¸‹æ¶ˆè´¹, å¡åˆ¸å……å€¼, å¡åˆ¸æ¶ˆè´¹, å†²æ­£ç­‰ä¸šåŠ¡æ ¸å¿ƒ; å®šæ—¶ç³»ç»Ÿ: å„ç³»ç»Ÿå®šæ—¶ä»»åŠ¡è§¦å‘çš„ç³»ç»Ÿ; é€šçŸ¥ç³»ç»Ÿ: ä»mqä¸­æ¶ˆè´¹æ•°æ®, æŒ‰ç…§é€šçŸ¥åœ°å€é€šçŸ¥å•†æˆ·;å¡åˆ¸ç³»ç»Ÿ: è´Ÿè´£å¡åˆ¸ç”ŸæˆåŠæ ¸é”€; å•†æˆ·åå°: æŸ¥çœ‹äº¤æ˜“ç»Ÿè®¡æ•°æ®ä»¥åŠå‘èµ·é€€æ¬¾. è´£ä»»æè¿°å‚ä¸ç³»ç»Ÿçš„æ¶æ„è®¨è®ºå’Œè®¾è®¡, å¹¶æ­å»ºäº¤æ˜“ç³»ç»Ÿå’Œå®šæ—¶ç³»ç»Ÿäº¤æ˜“ç³»ç»Ÿ: å¯¹æ¥å¾®ä¿¡å……å€¼, å¼€å‘é’±åŒ…å¡åˆ¸å……å€¼, å¡åˆ¸æ¶ˆè´¹, çº¿ä¸Šæ¶ˆè´¹, çº¿ä¸‹æ¶ˆè´¹, é€€æ¬¾, å†²æ­£ç­‰ä¸šåŠ¡é€»è¾‘; å®šæ—¶ç³»ç»Ÿ: è´Ÿè´£ç»Ÿä¸€æ‰¹å¤„ç†è°ƒåº¦; å’Œå•†æˆ·è”è°ƒ, åŒæ—¶å¯¹æ¥å…¶ä»–ç³»ç»Ÿ; æ€»ç»“åˆå§‹ä½¿ç”¨Dubbo+Zookeeperçš„æ–¹å¼, åæœŸæ”¹æˆ SpringCloud+Feignç»Ÿä¸€é…ç½®ä¸­å¿ƒ, Apollo ä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿. (è¿‘æœŸæ­å»ºäº†ä¸‹ Nacos æ„Ÿè§‰ä¹ŸæŒºä¸é”™)"},{"title":"æ‘‡è´æ€»ç»“","date":"2017-11-19T09:42:43.000Z","updated":"2019-09-30T13:08:23.550Z","comments":true,"path":"project/money-tree.html","permalink":"https://liuzhihang.com/project/money-tree.html","excerpt":"","text":"ç³»ç»Ÿæ¶æ„å¼€å‘ç¯å¢ƒè½¯ä»¶æ¶æ„å¼€å‘æ—¶é—´é¡¹ç›®ä»‹ç»è´£ä»»æè¿°æŠ€æœ¯æè¿°æ€»ç»“"},{"title":"ç›‘æ§ç³»ç»Ÿé¡¹ç›®æ€»ç»“","date":"2018-10-04T09:42:43.000Z","updated":"2019-09-30T13:08:23.531Z","comments":true,"path":"project/monitor-system.html","permalink":"https://liuzhihang.com/project/monitor-system.html","excerpt":"","text":"åŸºæœ¬é€»è¾‘ v0.0.1 è¿˜æœªåŠ å…¥ KafkaåæœŸä¸ºè¿­ä»£ä»¥åŠELKç‰ˆæœ¬æ›´æ–°, åœ¨Filebeat å’Œ Logstash ä¸­é—´åŠ å…¥ MQ(Kafka)ä½¿ç”¨ Skywalking + ES å¯¹åº”ç”¨è¿›è¡Œç›‘æ§ å¼€å‘ç¯å¢ƒIDEAã€JDK1.8ã€Tomcat 7ã€MySQLã€Gitã€Maven è½¯ä»¶æ¶æ„SpringBoot + SpringMVC + MyBatis + ELK(Elasticsearchã€Logstashã€Kibana) + Redis + Bootstrap + Thymeleaf å¼€å‘æ—¶é—´ä¸€æœŸ: 2018.05 ä¸€ä¸€ 2018.07äºŒæœŸ: æœªå¯åŠ¨ é¡¹ç›®ä»‹ç»åŸºäºELK, å¯¹å„äº¤æ˜“ç³»ç»Ÿä»æ¸ é“å’Œå•†æˆ·çš„ç»´åº¦å¯¹ä¸‹å•ã€æŸ¥è¯¢ã€æ”¯ä»˜ã€é€šçŸ¥çš„TPS/QPSä»¥åŠæˆåŠŸç‡ã€æ”¯ä»˜ç‡è¿›è¡Œç›‘æ§, ç¡®ä¿ä¸€æ—¦ç¬¦åˆæŠ¥è­¦è§„åˆ™, ç«‹å³æŠ¥è­¦.æŠ¥è­¦æ–¹å¼: çŸ­ä¿¡ã€é‚®ä»¶ã€å¾®ä¿¡ â˜ ç›¸å…³æ¶æ„ è´£ä»»æè¿°1ã€å‚ä¸ç³»ç»Ÿæ¶æ„, è¡¨ç»“æ„è®¾è®¡, å®ç°æµç¨‹çš„è®¨è®º2ã€ç›‘æ§è§„åˆ™çš„åˆ¶å®š3ã€å•†æˆ·ç»´åº¦ç›‘æ§é€»è¾‘å®ç°4ã€ç³»ç»Ÿçš„æ›´æ–°ç»´æŠ¤åŠç‰ˆæœ¬è¿­ä»£ æŠ€æœ¯æè¿°1ã€åŸºäºElasticsearchå’ŒMySqlçš„CRUD2ã€ä½¿ç”¨Springboot Scheduledå®šæ—¶,ç›‘æ§æŒ‡å®šåŒºé—´å†…çš„æ•°æ®å˜åŒ–3ã€ä½¿ç”¨Redisé˜Ÿåˆ—å¯¹Errorä¿¡æ¯ç«‹å³æŠ¥è­¦4ã€ä½¿ç”¨Bootstrap+EChartæ¨¡ç‰ˆå±•ç¤ºç›‘æ§æ•°æ®ä¿¡æ¯ åæœŸè§„åˆ’1ã€å¯¹æ¥å¾®ä¿¡æ¸ é“, æ”¯æŒå…¬ä¼—å·æŠ¥è­¦æ–¹å¼2ã€å‰ç«¯é¡µé¢è¿›è¡Œä¼˜åŒ–(åç«¯ç¨‹åºå‘˜è¡¨ç¤ºâ€¦)3ã€ç»Ÿä¸€æ—¥å¿—æ¨¡å—ä¼˜åŒ–4ã€åå°æƒé™, ç›‘æ§è§„åˆ™å¯é…ç½®(æ‰‹åŠ¨æ”¹åº“æ€»æ˜¯ä¸å¤ªå¥½.)"},{"title":"ç°åœ¨æ”¯ä»˜","date":"2019-12-20T11:00:00.000Z","updated":"2020-04-22T09:47:55.364Z","comments":true,"path":"project/operapay.html","permalink":"https://liuzhihang.com/project/operapay.html","excerpt":"","text":"2019-12 - è‡³ä»Š åŒ—äº¬æ¬§éç§‘æŠ€æœ‰é™å…¬å¸, ç®€ç§°opayæ”¯ä»˜,åŠæ”¯ä»˜åœºæ™¯ç›¸å…³ä¸šåŠ¡ è¿™é‡Œå•¥ä¹Ÿæ²¡æœ‰å¼€å§‹å†™~"},{"title":"ä»˜æ¬¾å¹³å°å’Œæ¸ é“ç³»ç»Ÿ","date":"2017-11-19T09:42:43.000Z","updated":"2019-09-30T13:08:23.545Z","comments":true,"path":"project/pay-platform.html","permalink":"https://liuzhihang.com/project/pay-platform.html","excerpt":"","text":"ç³»ç»Ÿæ¶æ„ å‚ä¸å¯¹åŸä»£ä»˜ç³»ç»Ÿè¿›è¡Œé‡æ„, åŒæ—¶ä¹Ÿäº†è§£ç›¸å…³ä¸šåŠ¡ å¼€å‘ç¯å¢ƒIDEAã€JDK1.8ã€Tomcat 7ã€MySQLã€Gitã€Maven è½¯ä»¶æ¶æ„Spring + SpringMVC + MyBatis + Redis + Dubbo + Zookeeper + RabbitMQ å¼€å‘æ—¶é—´2017.11 - è‡³ä»Š é¡¹ç›®ä»‹ç»å•†æˆ·ä¸è‡ªå·±çš„å®¢æˆ·ç­¾è®¢ä»£æ”¶åè®®, å§”æ‰˜ç°åœ¨æ”¯ä»˜å¯¹å·²ç­¾çº¦å®¢æˆ·å‘èµ·é“¶è¡Œå¡æ‰£æ¬¾, å¹¶å°†èµ„é‡‘åˆ’å…¥å•†æˆ·åœ¨æˆ‘å¸å¼€é€šçš„ä½™é¢è´¦æˆ·, T+1 æ—¥ç»“ç®—åˆ°ç»“ç®—è´¦æˆ·. å•†æˆ·å°†èµ„é‡‘å†²å…¥åœ¨æˆ‘å¸å¼€é€šçš„ä½™é¢è´¦æˆ·, å¹¶å§”æ‰˜æˆ‘å¸å°†ä¸šåŠ¡èµ„é‡‘è½¬è´¦åˆ°æŒ‡å®šçš„å®¢æˆ·é“¶è¡Œå¡ä¸­.é«˜å³°æ—¶æœŸæ—¥å‡æµæ°´è¿‘1äº¿å…ƒ.ä»£ä»˜ç³»ç»Ÿ: åŒ…æ‹¬ ä»˜æ¬¾å¹³å°, æ¸ é“ç³»ç»Ÿ, å®šæ—¶ç³»ç»Ÿä»˜æ¬¾å¹³å°: ä¸»è¦è´Ÿè´£å¯¹æ¥å•†æˆ·, æ ¡éªŒå‚æ•°, é£æ§, å’Œåº”ç”¨ä¸­å¿ƒäº¤äº’ç­‰ä¸šåŠ¡; æ¸ é“ç³»ç»Ÿ: è´Ÿè´£å’Œé“¶è¡Œå¯¹æ¥, åŒ…å«å¤§éƒ¨åˆ†åŠ ç­¾éªŒç­¾å·¥å…·, ä»¥åŠæ¥æ”¶æ¸ é“å¼‚æ­¥é€šçŸ¥. è´£ä»»æè¿°å‚ä¸å¯¹åŸä»£ä»˜ç³»ç»Ÿè¿›è¡Œé‡æ„, è´Ÿè´£é€€ç¥¨é€»è¾‘å®ç°, è¿è¥åå°æŸ¥å•, å‘èµ·é€€ç¥¨ç­‰åŠŸèƒ½å®ç°. å¯¹æ¥é“¶è¡Œ, æ’æŸ¥çº¿ä¸Šé—®é¢˜. ä»¥åŠå¯¹é¡¹ç›®è¿›è¡Œç»´æŠ¤. æ€»ç»“å’Œé“¶è¡Œè¿›è¡Œäº¤äº’, åŠ è§£å¯†éªŒç­¾æ–¹å¼æ¯”è¾ƒå¤æ‚è®¤è¯†åˆ°ä»£ä»˜ä¸šåŠ¡: è¡¥å•, æŸ¥å•, å‹å•, çª—å£æœŸäº†è§£åˆ°æ•´ä½“æ¶æ„: å’Œ é£æ§ç³»ç»Ÿ, åº”ç”¨ä¸­å¿ƒ, é€šçŸ¥ç³»ç»Ÿ, æµæ°´å·ç³»ç»Ÿ, æ¸…ç»“ç®—, æ•°æ®ä¸­å¿ƒ, è¿è¥åå°ç­‰ç³»ç»Ÿçš„äº¤äº’"},{"title":"å›½å†…èšåˆæ”¯ä»˜","date":"2017-11-19T09:42:43.000Z","updated":"2019-09-30T13:08:23.542Z","comments":true,"path":"project/timing.html","permalink":"https://liuzhihang.com/project/timing.html","excerpt":"","text":"å±•ç¤º æ€»ç»“å‘¨äº”å‘¨å…­ä¸¤å¤©æ—¶é—´, è®¾è®¡+å¼€å‘å­¦ä¹ ä½¿ç”¨å¢¨åˆ€å¯¹æ¥å…¬å¸å°ç¨‹åºæ”¯ä»˜å¹¶èƒ½å¤Ÿæ‹‰èµ·æ”¯ä»˜é¡µé¢"},{"title":"æ ‡ç­¾","date":"2020-04-04T04:12:07.018Z","updated":"2020-04-04T04:12:07.018Z","comments":true,"path":"tags/index.html","permalink":"https://liuzhihang.com/tags/index.html","excerpt":"","text":""},{"title":"","date":"2020-06-19T03:34:52.113Z","updated":"2020-06-19T03:34:52.113Z","comments":true,"path":"resources/highlight/atom-one-dark.css","permalink":"https://liuzhihang.com/resources/highlight/atom-one-dark.css","excerpt":"","text":"/* ä»£ç¢¼æ¡†èƒŒæ™¯è‰²å’Œå­—é«”é¡”è‰²,èˆ‡hljsä¸€æ¨£å°±è¡Œ */ /* å¿…é ˆé…ç½®(æŠŠä¸‹é¢.hljsçš„colorå’Œbackgroundè¤‡è£½åˆ°é€™è£ä¾†) */ #article-container pre, #article-container figure.highlight { color: #abb2bf; background: #282c34; } /* ä»£ç¢¼æ¡†å·¥å…·æ¬„ (å¦‚æœä½ é—œæ‰äº†copyã€langå’Œshrink,å¯ä¸ç”¨é…ç½®é€™å€‹ */ #article-container figure.highlight .highlight-tools { color: #5c6370; background: #282c34; } /* ä»£ç¢¼æ¡†è¡Œæ•¸(å¦‚æœå·²ç¶“é—œæ‰line_number,å¯ä»¥ä¸ç”¨é…ç½®é€™å€‹) */ #article-container figure.highlight .gutter pre { color: #5c6370; background: #282c34; } /* ä»£ç¢¼å¡Šfigcaptioné…ç½®(hexoè‡ªå¸¶æ¨™ç°½https://hexo.io/zh-tw/docs/tag-plugins.html#Code-Block) */ /* ä¸éœ€è¦å¯ä»¥ä¸ç”¨é…ç½®é€™å€‹ */ #article-container figure.highlight figcaption a { color: #282c34 !important } /* Atom One Dark by Daniel Gamage Original One Dark Syntax theme from https://github.com/atom/one-dark-syntax base: #282c34 mono-1: #abb2bf mono-2: #818896 mono-3: #5c6370 hue-1: #56b6c2 hue-2: #61aeee hue-3: #c678dd hue-4: #98c379 hue-5: #e06c75 hue-5-2: #be5046 hue-6: #d19a66 hue-6-2: #e6c07b */ #article-container figure.highlight .hljs { display: block; overflow-x: auto; padding: 0.5em; color: #abb2bf; background: #282c34; } .hljs-comment, .hljs-quote { color: #5c6370; font-style: italic; } .hljs-doctag, .hljs-keyword, .hljs-formula { color: #c678dd; } .hljs-section, .hljs-name, .hljs-selector-tag, .hljs-deletion, .hljs-subst { color: #e06c75; } .hljs-literal { color: #56b6c2; } .hljs-string, .hljs-regexp, .hljs-addition, .hljs-attribute, .hljs-meta-string { color: #98c379; } .hljs-built_in, .hljs-class .hljs-title { color: #e6c07b; } .hljs-attr, .hljs-variable, .hljs-template-variable, .hljs-type, .hljs-selector-class, .hljs-selector-attr, .hljs-selector-pseudo, .hljs-number { color: #d19a66; } .hljs-symbol, .hljs-bullet, .hljs-link, .hljs-meta, .hljs-selector-id, .hljs-title { color: #61aeee; } .hljs-emphasis { font-style: italic; } .hljs-strong { font-weight: bold; } .hljs-link { text-decoration: underline; }"},{"title":"","date":"2020-06-19T03:48:58.605Z","updated":"2020-06-19T02:42:28.773Z","comments":true,"path":"resources/highlight/atom-one-light.css","permalink":"https://liuzhihang.com/resources/highlight/atom-one-light.css","excerpt":"","text":"/* Atom One Light by Daniel Gamage Original One Light Syntax theme from https://github.com/atom/one-light-syntax base: #fafafa mono-1: #383a42 mono-2: #686b77 mono-3: #a0a1a7 hue-1: #0184bb hue-2: #4078f2 hue-3: #a626a4 hue-4: #50a14f hue-5: #e45649 hue-5-2: #c91243 hue-6: #986801 hue-6-2: #c18401 */ .hljs { display: block; overflow-x: auto; padding: 0.5em; color: #383a42; background: #fafafa; } .hljs-comment, .hljs-quote { color: #a0a1a7; font-style: italic; } .hljs-doctag, .hljs-keyword, .hljs-formula { color: #a626a4; } .hljs-section, .hljs-name, .hljs-selector-tag, .hljs-deletion, .hljs-subst { color: #e45649; } .hljs-literal { color: #0184bb; } .hljs-string, .hljs-regexp, .hljs-addition, .hljs-attribute, .hljs-meta-string { color: #50a14f; } .hljs-built_in, .hljs-class .hljs-title { color: #c18401; } .hljs-attr, .hljs-variable, .hljs-template-variable, .hljs-type, .hljs-selector-class, .hljs-selector-attr, .hljs-selector-pseudo, .hljs-number { color: #986801; } .hljs-symbol, .hljs-bullet, .hljs-link, .hljs-meta, .hljs-selector-id, .hljs-title { color: #4078f2; } .hljs-emphasis { font-style: italic; } .hljs-strong { font-weight: bold; } .hljs-link { text-decoration: underline; }"},{"title":"","date":"2020-06-19T03:21:26.567Z","updated":"2020-06-19T03:21:26.567Z","comments":true,"path":"resources/highlight/github.css","permalink":"https://liuzhihang.com/resources/highlight/github.css","excerpt":"","text":"/* ä»£ç¢¼æ¡†èƒŒæ™¯è‰²å’Œå­—é«”é¡”è‰²,èˆ‡hljsä¸€æ¨£å°±è¡Œ */ /* å¿…é ˆé…ç½®(æŠŠä¸‹é¢.hljsçš„colorå’Œbackgroundè¤‡è£½åˆ°é€™è£ä¾†) */ #article-container pre, #article-container figure.highlight { color: #333; background: #f8f8f8; } /* ä»£ç¢¼æ¡†å·¥å…·æ¬„ (å¦‚æœä½ é—œæ‰äº†copyã€langå’Œshrink,å¯ä¸ç”¨é…ç½®é€™å€‹ */ #article-container figure.highlight .highlight-tools { color: #333; background: #f8f8f8; } /* ä»£ç¢¼æ¡†è¡Œæ•¸(å¦‚æœå·²ç¶“é—œæ‰line_number,å¯ä»¥ä¸ç”¨é…ç½®é€™å€‹) */ /*#article-container figure.highlight .gutter pre {*/ /* background-color: xxx;*/ /* color: xxx*/ /*}*/ /* ä»£ç¢¼å¡Šfigcaptioné…ç½®(hexoè‡ªå¸¶æ¨™ç°½https://hexo.io/zh-tw/docs/tag-plugins.html#Code-Block) */ /* ä¸éœ€è¦å¯ä»¥ä¸ç”¨é…ç½®é€™å€‹ */ /*#article-container figure.highlight figcaption a {*/ /* color: xxx !important*/ /*}*/ /* github.com style (c) Vasily Polovnyov */ #article-container figure.highlight .hljs { display: block; overflow-x: auto; padding: 0.5em; color: #333; background: #f8f8f8; } .hljs-comment, .hljs-quote { color: #998; font-style: italic; } .hljs-keyword, .hljs-selector-tag, .hljs-subst { color: #333; font-weight: bold; } .hljs-number, .hljs-literal, .hljs-variable, .hljs-template-variable, .hljs-tag .hljs-attr { color: #008080; } .hljs-string, .hljs-doctag { color: #d14; } .hljs-title, .hljs-section, .hljs-selector-id { color: #900; font-weight: bold; } .hljs-subst { font-weight: normal; } .hljs-type, .hljs-class .hljs-title { color: #458; font-weight: bold; } .hljs-tag, .hljs-name, .hljs-attribute { color: #000080; font-weight: normal; } .hljs-regexp, .hljs-link { color: #009926; } .hljs-symbol, .hljs-bullet { color: #990073; } .hljs-built_in, .hljs-builtin-name { color: #0086b3; } .hljs-meta { color: #999; font-weight: bold; } .hljs-deletion { background: #fdd; } .hljs-addition { background: #dfd; } .hljs-emphasis { font-style: italic; } .hljs-strong { font-weight: bold; }"},{"title":"","date":"2019-12-23T06:35:09.080Z","updated":"2019-09-08T10:04:27.884Z","comments":true,"path":"resources/js/generator.js","permalink":"https://liuzhihang.com/resources/js/generator.js","excerpt":"","text":"function generator(locals) { var comparer, extractName, fileUtil, generateCategoriesJson, generatePostsJson, generateTagsJson, pathUtil; pathUtil = require('path'); generatePostsJson = function(posts) { var postsMeta; postsMeta = { posts: posts.map(function(post) { return { title: post.title, url: encodeURI(post.permalink), date: post.updated.toDate().toISOString() || post.date.toDate().toISOString() }; }) }; return { path: 'posts.json', data: JSON.stringify(postsMeta) }; }; comparer = function(a, b) { return b.length - a.length; }; extractName = function(obj) { return obj.name; }; generateCategoriesJson = function(categories) { var categoriesMeta; categoriesMeta = { categories: categories.sort(comparer).map(extractName) }; return { path: 'categories.json', data: JSON.stringify(categoriesMeta) }; }; generateTagsJson = function(tags) { var tagsMeta; tagsMeta = { tags: tags.sort(comparer).map(extractName) }; return { path: 'tags.json', data: JSON.stringify(tagsMeta) }; }; var jsons = new Array(); jsons.push(generatePostsJson(locals.posts.toArray())); jsons.push(generateCategoriesJson(locals.categories.toArray())); jsons.push(generateTagsJson(locals.tags.toArray())); return jsons; } module.exports = generator;"}],"posts":[{"title":"Spring äº‹åŠ¡ã€å¼‚æ­¥å’Œå¾ªç¯ä¾èµ–æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ","slug":"source-code/spring/Spring äº‹åŠ¡å’Œå¼‚æ­¥å¾ªç¯ä¾èµ–çš„å½±å“","date":"2021-02-01T13:40:00.000Z","updated":"2021-02-03T02:32:00.383Z","comments":true,"path":"2021/02/01/spring-sync-translational.html","link":"","permalink":"https://liuzhihang.com/2021/02/01/spring-sync-translational.html","excerpt":"","text":"å‰è¨€åœ¨å¾ªç¯ä¾èµ–ä¸­æœ‰ä¸€ç§å¾ªç¯ä¾èµ–ï¼Œå°±æ˜¯è‡ªæ³¨å…¥ï¼šè‡ªå·±ä¾èµ–è‡ªå·±ã€‚ äº‹åŠ¡çš„è‡ªæ³¨å…¥åœ¨ Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ æœ‰å°ä¼™ä¼´æå‡ºå¯ä»¥è‡ªå·±æ³¨å…¥è‡ªå·±æ¥è§£å†³äº‹åŠ¡å¤±æ•ˆã€‚ å…·ä½“ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š @Slf4j@Servicepublic class OrderBizServiceImpl implements OrderBizService &#123; // æ³¨å…¥è‡ªå·± @Autowired private OrderBizService orderBizService; @Override public void callBack() throws Exception &#123; // ä¸€ç³»åˆ—çš„é€»è¾‘ // éœ€è¦äº‹åŠ¡æ“ä½œæ›´æ–°è®¢å•å’Œç”¨æˆ·é‡‘é¢ orderBizService.updateOrderStatusAndUserBalance(); &#125; @Override @Transactional(rollbackFor = Exception.class) public void updateOrderStatusAndUserBalance() throws Exception &#123; // å†…éƒ¨æ˜¯äº‹åŠ¡é€»è¾‘ &#125;&#125; æ˜¯ä¸æ˜¯å‘ç°å¾ˆç¥å¥‡çš„äº‹æƒ…ï¼Œäº‹åŠ¡ç”Ÿæ•ˆäº†ã€‚ å…¶å®è¿™é‡Œæ³¨å…¥è‡ªå·±ï¼Œå…¶å®æ˜¯æ³¨å…¥çš„ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè°ƒäº‹åŠ¡ï¼Œä¹Ÿæ˜¯è°ƒçš„ä»£ç†å¯¹è±¡çš„äº‹åŠ¡ï¼Œæ‰€ä»¥äº‹åŠ¡ç”Ÿæ•ˆã€‚ Spring äº‹åŠ¡å¤±æ•ˆåŸå› ï¼š äº‹åŠ¡åªèƒ½åº”ç”¨åˆ° public æ–¹æ³•ä¸Šæ‰ä¼šæœ‰æ•ˆï¼›äº‹åŠ¡éœ€è¦ä»å¤–éƒ¨è°ƒç”¨ï¼ŒSpring è‡ªè°ƒç”¨ä¼šå¤±æ•ˆï¼›å»ºè®®äº‹åŠ¡æ³¨è§£ @Transactional ä¸€èˆ¬æ·»åŠ åœ¨å®ç°ç±»ä¸Šã€‚ å¼‚æ­¥çš„è‡ªæ³¨å…¥å‘ç° @Transactional æ³¨è§£å¯ä»¥è‡ªæ³¨å…¥è§£å†³äº‹åŠ¡å¤±æ•ˆçš„é—®é¢˜ï¼Œåœ¨æŸæ¬¡å¼€å‘ä¸­ï¼Œè‡ªç„¶è€Œç„¶æƒ³åˆ° @Async å¼‚æ­¥æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è‡ªæ³¨å…¥è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚ NOï¼Œ NOï¼Œ NOâ€¦â€¦ äº‹å®å‘Šè¯‰æˆ‘ä»¬æ˜¯ä¸å¯ä»¥çš„ï¼ ä»é”™è¯¯å¼€å§‹ç€æ‰‹ï¼š å¼€å§‹å¾€ä¸Šé¢åæ¨ exposedObject == bean æ˜¯è¿™ä¸€å—å‡ºäº†é—®é¢˜ã€‚ ä¹Ÿå°±æ˜¯è¯´å¼‚æ­¥çš„æ—¶å€™ï¼Œå†æ¬¡ä»äºŒçº§ç¼“å­˜ä¸­è·å–çš„å’Œåˆå§‹çš„ä¸ç›¸åŒã€‚ Object earlySingletonReference = getSingleton(beanName, false); è¿™ä¸€æ¬¡è·å–çš„æ—¶å€™å‘ç°ä¸åŒæ‰€ä»¥æŠ¥é”™ã€‚ é‚£å°±å¼€å§‹ Debugï¼Œ æŒ‰ç…§å¾ªç¯ä¾èµ–çš„é€»è¾‘ï¼Œæ‰§è¡Œåˆ° populateBean æ—¶ï¼Œå±æ€§èµ‹å€¼ï¼Œå‘ç°æœ‰ä¾èµ–è‡ªå·±ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºè‡ªå·±ã€‚ æ‰§è¡Œ singleton.getObject æ–¹æ³• è€Œæ­¤æ—¶æ‰§è¡Œ getEarlyBeanReference å…ˆåˆ¤æ–­ InfrastructureAdvisorAutoProxyCreator true è°ƒç”¨ wrapIfNecessary åˆ¤æ–­æ˜¯å¦ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚ ç„¶åå¼€å§‹æ‰§è¡Œå¼‚æ­¥çš„ AsyncAnnotationBeanPostProcessor åˆ¤æ–­ä¸º falseã€‚æ‰€ä»¥æ²¡æœ‰æ‰§è¡Œå¼‚æ­¥çš„ç”Ÿæˆä»£ç†å¯¹è±¡é€»è¾‘ã€‚ é‚£å°±ç»§ç»­å¾€ä¸‹çœ‹ è¿›å…¥åˆ° initializeBean çš„é€»è¾‘ï¼Œæœ‰ä¸€éƒ¨åˆ†å«åš applyBeanPostProcessorsAfterInitialization æ–¹é¢å°ä¼™ä¼´æœç´¢ï¼Œæ‰€ä»¥è´´å‡ºæ¥ä»£ç å…³é”®å­—ã€‚IDEA ä½¿ç”¨ âŒ˜ + Shift + F æœç´¢ã€‚ å¾ªç¯æ‰§è¡Œåç½®å¤„ç†å™¨ï¼š å‘ç°æ‰§è¡Œå®Œ AsyncAnnotationBeanPostProcessor è¿™ä¸ª PostProcessor åï¼Œå¯¹è±¡è¢«æ”¹å˜äº†ã€‚ä»è€Œå¯¼è‡´äºŒçº§ç¼“å­˜å’Œå½“å‰çš„ Bean ä¸åŒã€‚ ä»¥ä¸Šä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ @Async è‡ªè°ƒç”¨ä¸å¯ä»¥ï¼Œå› ä¸ºåœ¨åé¢åˆå§‹åŒ–é˜¶æ®µè¢«ä»£ç†ä¿®æ”¹äº†å¯¹è±¡ã€‚ @Transactional ä¸ºä»€ä¹ˆå¯ä»¥å‘¢ï¼Ÿ å…ˆåˆ¤æ–­ InfrastructureAdvisorAutoProxyCreator true ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚ äº‹åŠ¡çš„å¤„ç†å™¨ PersistenceExceptionTranslationPostProcessor ä¹Ÿæ²¡æœ‰æ‰§è¡Œã€‚ ç»§ç»­ Debug å…³æ³¨ applyBeanPostProcessorsAfterInitialization æ‰§è¡Œç»“æŸï¼Œå‘ç° Bean æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚ æ€»ç»“ @Transactionalï¼š æ˜¯åœ¨å¾ªç¯ä¾èµ–ä»äºŒçº§ç¼“å­˜å‡åˆ°ä¸‰çº§ç¼“å­˜çš„æ—¶å€™å·²ç»ç”Ÿæˆäº†ä»£ç†å¯¹è±¡ã€‚ @Asyncï¼š æ˜¯åœ¨åˆå§‹åŒ–é˜¶æ®µï¼ˆinitializeBeanï¼‰å»ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚ç„¶å @Async å¯¼è‡´åé¢åˆ¤æ–­ exposedObject == bean ä¸º false ï¼Œä»è€ŒæŠ›å‡ºå¼‚å¸¸ã€‚ å¯ä»¥çœ‹å‡ºå›¾ä¸­æœ‰ä¸¤å¤„ä¼šæ‰§è¡Œ BeanPostProcessor ï¼š åœ¨ singletonFactory.getObject æ—¶ï¼Œå¦‚æœæ˜¯ SmartInstantiationAwareBeanPostProcessor çš„å­ç±»ä¼šæ‰§è¡Œ getEarlyBeanReference æ–¹æ³•ã€‚ åœ¨ initializeBean çš„ applyBeanPostProcessorsAfterInitialization æ—¶ä¼šæ‰§è¡Œæ‰€æœ‰ BeanPostProcessor çš„ postProcessAfterInitialization çš„æ–¹æ³•ã€‚ ä¹Ÿæœ‰å…¶ä»–çš„åœ°æ–¹åœ¨æ‰§è¡Œåç½®å¤„ç†å™¨ï¼Œæ¯”å¦‚ applyBeanPostProcessorsBeforeInitialization ï¼Œåªä¸è¿‡è¿™é‡Œå…³æ³¨è¿™ä¿©å¤„ã€‚ è€Œè¿™ä¸¤å¤„éƒ½æœ‰å¯èƒ½ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œ @Transactional æ˜¯åœ¨ getEarlyBeanReference å¤„ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥åé¢åˆ¤æ–­ Bean æ˜¯å¦è¢«æ”¹å˜æ—¶ä¸º trueï¼Œè€Œ @Async æ˜¯åœ¨åé¢å¼‚æ­¥ç”Ÿæˆäº†ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥åˆ¤æ–­ä¸é€šè¿‡ã€‚ è‡³æ­¤ï¼Œåˆ†æå®Œæ¯•ï¼Œé”™è¯¯ä¹‹å¤„ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚ ç›¸å…³æ¨è Spring åŠ¨æ€ä»£ç†æ—¶æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¸‰çº§ç¼“å­˜ï¼Ÿ Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring åŠ¨æ€ä»£ç†æ—¶æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¸‰çº§ç¼“å­˜ï¼Ÿ","slug":"source-code/spring/Spring å¾ªç¯ä¾èµ–ä¸ºä»€ä¹ˆæ˜¯ä¸‰çº§ç¼“å­˜","date":"2021-01-30T13:40:00.000Z","updated":"2021-01-31T04:04:37.858Z","comments":true,"path":"2021/01/30/source-spring-circular-dependence-2.html","link":"","permalink":"https://liuzhihang.com/2021/01/30/source-spring-circular-dependence-2.html","excerpt":"","text":"å‰è¨€åœ¨ç ”ç©¶ ã€ Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ ã€ çš„æ—¶å€™ï¼Œäº†è§£åˆ° Spring æ˜¯å€ŸåŠ©ä¸‰çº§ç¼“å­˜æ¥è§£å†³å¾ªç¯ä¾èµ–çš„ã€‚ åŒæ ·åœ¨ä¸Šä¸€èŠ‚ç•™ä¸‹äº†ç–‘é—®ï¼š å¾ªç¯ä¾èµ–ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¸‰çº§ç¼“å­˜ï¼Ÿè€Œä¸æ˜¯ä½¿ç”¨äºŒçº§ç¼“å­˜ï¼Ÿ AOP åŠ¨æ€ä»£ç†å¯¹å¾ªç¯ä¾èµ–çš„æœ‰æ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ æœ¬ç¯‡æ–‡ç« ä¹Ÿæ˜¯å›´ç»•ä¸Šé¢çš„å†…å®¹è¿›è¡Œå±•å¼€ã€‚ ç¬”è®°ä¹Ÿåœ¨ä¸æ–­æ•´ç†ï¼Œä¹‹å‰å¯èƒ½ä¼šæœ‰ç‚¹æ‚ä¹±ã€‚ å¾ªåºæ¸è¿›ï¼Œçœ‹ä¸€çœ‹ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Ÿå¼€å§‹å…ˆç®€å•å›é¡¾ä¸€ä¸‹ Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå½“ç„¶å°ä¼™ä¼´ä¹Ÿå¯ä»¥ç›´æ¥é˜…è¯»ã€ å•ä¾‹ Bean çš„åˆ›å»º ã€è¿™ç¯‡æ–‡ç« ã€‚ ä¸è¿‡è€ƒè™‘åˆ°é˜…è¯»æœ¬æ–‡å‰å†é˜…è¯»ä¸Šä¸€ç¯‡æ–‡ç« ã€Debug ç­‰ç­‰ï¼Œä¼šæ¯”è¾ƒè€—æ—¶ï¼Œæ‰€ä»¥æœ¬ç¯‡æ–‡ç« å‰é¢ä¸€å°éƒ¨åˆ†ä¼šå…ˆå¯¹ä¹‹å‰çš„æ–‡ç« å†…å®¹åšç®€è¦æ¦‚æ‹¬ï¼Œä¹Ÿç›¸å½“äºå¯¹æˆ‘è‡ªå·±å­¦ä¹ çš„çŸ¥è¯†è¿›è¡Œä¸€ä¸ªæ€»ç»“ã€‚ å…ˆæ¥å›é¡¾ä¸€ä¸‹ä¸‰çº§ç¼“å­˜çš„æ¦‚å¿µã€‚ singletonObjectsï¼š ä¸€çº§ç¼“å­˜ï¼Œå­˜å‚¨å•ä¾‹å¯¹è±¡ï¼ŒBean å·²ç»å®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–å®Œæˆã€‚ earlySingletonObjectsï¼š äºŒçº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonObjectï¼Œè¿™ä¸ª Bean å®ä¾‹åŒ–äº†ï¼Œè¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚ singletonFactoriesï¼š ä¸‰çº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonFactoryã€‚ Bean çš„åˆ›å»ºè¿‡ç¨‹@Servicepublic class CircularServiceA &#123; private String fieldA = &quot;å­—æ®µ A&quot;;&#125; é€šè¿‡ä¸Šé¢çš„æµç¨‹ï¼Œå¯ä»¥çœ‹å‡º Spring åœ¨åˆ›å»º Bean çš„è¿‡ç¨‹ä¸­é‡ç‚¹æ˜¯åœ¨ AbstractAutowireCapableBeanFactory ä¸­çš„ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š å®ä¾‹åŒ– createBeanInstanceï¼š å…¶ä¸­å®ä¾‹åŒ– Bean å¹¶å¯¹ Bean è¿›è¡Œèµ‹å€¼ï¼Œåƒä¾‹å­ä¸­çš„ fieldA å­—æ®µåœ¨è¿™é‡Œå°±ä¼šèµ‹å€¼ã€‚ å±æ€§æ³¨å…¥ populateBeanï¼š å¯ä»¥ç†è§£ä¸ºå¯¹ Bean é‡Œé¢çš„å±æ€§è¿›è¡Œèµ‹å€¼ã€‚(ä¼šä¾èµ–å…¶ä»– Bean) åˆå§‹åŒ– initializeBeanï¼š æ‰§è¡Œåˆå§‹åŒ–å’Œ Bean çš„åç½®å¤„ç†å™¨ã€‚ å®ä¾‹åŒ–èµ‹å€¼æºç å¯ä»¥é˜…è¯»ï¼š BeanUtils.instantiateClass(constructorToUse) å¦‚æœè¦ä¾èµ–å…¶ä»– Bean å‘¢ï¼Ÿé‚£å¦‚æœ CircularServiceA ä¾èµ–äº†å…¶ä»– Bean å‘¢ï¼Ÿ @Servicepublic class CircularServiceA &#123; private String fieldA = &quot;å­—æ®µ A&quot;; @Autowired private CircularServiceB circularServiceB;&#125;@Servicepublic class CircularServiceB &#123;&#125; å½“ A ä¾èµ–äº† B çš„æ—¶å€™ï¼Œåœ¨ createBeanInstance è¿™ä¸€æ­¥ï¼Œå¹¶ä¸ä¼šå¯¹ B è¿›è¡Œå±æ€§èµ‹å€¼ã€‚ è€Œæ˜¯åœ¨ populatedBean è¿™é‡ŒæŸ¥æ‰¾ä¾èµ–é¡¹ï¼Œå¹¶åˆ›å»º Bã€‚ å¾ªç¯ä¾èµ–ä¸‹çš„åˆ›å»ºè¿‡ç¨‹å¾ªç¯ä¾èµ–çš„åœºæ™¯ï¼Œåœ¨ä¸Šä¸€ç¯‡æ–‡ç« å·²ç»æœ‰æ‰€è®²è§£ï¼Œè¿™é‡Œä»…ä»…ç”»å›¾è¯´æ˜ä¸€ä¸‹ã€‚ @Servicepublic class CircularServiceA &#123; private String fieldA = &quot;å­—æ®µ A&quot;; @Autowired private CircularServiceB circularServiceB;&#125;@Servicepublic class CircularServiceB &#123; @Autowired private CircularServiceA circularServiceA;&#125; åœ¨ A å’Œ B å¾ªç¯ä¾èµ–çš„åœºæ™¯ä¸­ï¼š B populatedBean æŸ¥æ‰¾ä¾èµ–é¡¹ A çš„æ—¶å€™ï¼Œä»ä¸€çº§ç¼“å­˜ä¸­è™½ç„¶æœªè·å–åˆ° Aï¼Œä½†æ˜¯å‘ç° A åœ¨åˆ›å»ºä¸­ã€‚ æ­¤æ—¶ï¼Œä»ä¸‰çº§ç¼“å­˜ä¸­è·å– A çš„ singletonFactory è°ƒç”¨å·¥å‚æ–¹æ³•ï¼Œåˆ›å»º getEarlyBeanReference A çš„æ—©æœŸå¼•ç”¨å¹¶è¿”å›ã€‚ B å¼•ç”¨åˆ° A ï¼ŒB å°±å¯ä»¥åˆå§‹åŒ–å®Œæ¯•ï¼Œç„¶å A åŒæ ·ä¹Ÿå¯ä»¥åˆå§‹åŒ–å®Œæ¯•äº†ã€‚ äºŒçº§ç¼“å­˜èƒ½å¦è§£å†³å¾ªç¯ä¾èµ–é€šè¿‡ä¸Šé¢çš„å›¾ï¼Œä»”ç»†åˆ†æä¸€ä¸‹ï¼Œå…¶å®æŠŠäºŒçº§ç¼“å­˜æ‹¿æ‰ï¼Œåœ¨ B å°è¯•è·å– A çš„æ—¶å€™ç›´æ¥è¿”å› A çš„å®ä¾‹ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Ÿ ç­”æ¡ˆæ˜¯ï¼šå¯ä»¥çš„ï¼ ä½†æ˜¯ä¸ºä»€ä¹ˆè¿˜æ˜¯ç”¨ä¸‰çº§ç¼“å­˜å‘¢ï¼Ÿ ç½‘ä¸Šçš„å¾ˆå¤šèµ„æ–™è¯´æ˜¯å’ŒåŠ¨æ€ä»£ç†æœ‰å…³ç³»ï¼Œé‚£å°±ä»åŠ¨æ€ä»£ç†çš„æ–¹é¢ç»§ç»­å¾€ä¸‹åˆ†æåˆ†æã€‚ åŠ¨æ€ä»£ç†çš„åœºæ™¯åœ¨ JavaConfigï¼ˆé…ç½®ç±»ï¼‰ ä¸Šæ·»åŠ  @EnableAspectJAutoProxy æ³¨è§£ï¼Œå¼€å¯ AOP ï¼Œé€šè¿‡ Debug å¾ªåºæ¸è¿›çœ‹ä¸€çœ‹åŠ¨æ€ä»£ç†å¯¹å¾ªç¯ä¾èµ–çš„å½±å“ã€‚ åŠ¨æ€ä»£ç†ä¸‹ï¼ŒBean çš„åˆ›å»ºè¿‡ç¨‹@Servicepublic class CircularServiceA &#123; private String fieldA = &quot;å­—æ®µ A&quot;; public void methodA() &#123; System.out.println(&quot;æ–¹æ³• A æ‰§è¡Œ&quot;); &#125;&#125;@Aspect@Componentpublic class AspectA &#123; @Before(&quot;execution(public void com.liuzhihang.circular.CircularServiceA.methodA())&quot;) public void beforeA() &#123; System.out.println(&quot;beforeA æ‰§è¡Œ&quot;); &#125;&#125; åªæœ‰ A çš„æƒ…å†µä¸‹ï¼Œç»™ A æ·»åŠ åˆ‡é¢ï¼Œå¼€å§‹ Debugã€‚ å‰é¢çš„æµç¨‹éƒ½ç›¸åŒï¼Œåœ¨ initializeBean å¼€å§‹å‡ºç°å·®å¼‚ã€‚ è¿™ä¸€æ­¥éœ€è¦åˆå§‹åŒ– Bean å¹¶æ‰§è¡Œ Bean çš„åç½®å¤„ç†å™¨ã€‚ å…¶ä¸­æœ‰ä¸€ä¸ªå¤„ç†å™¨ä¸ºï¼š AnnotationAwareAspectJAutoProxyCreator å…¶å®å°±æ˜¯åŠ çš„æ³¨è§£åˆ‡é¢ï¼Œä¼šè·³è½¬åˆ° AbstractAutoProxyCreator ç±»çš„ postProcessAfterInitialization æ–¹æ³• å¦‚å›¾æ‰€ç¤ºï¼šwrapIfNecessary æ–¹æ³•ä¼šåˆ¤æ–­æ˜¯å¦æ»¡è¶³ä»£ç†æ¡ä»¶ï¼Œæ˜¯çš„è¯è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¦åˆ™è¿”å›å½“å‰ Beanã€‚ åç»­è°ƒç”¨ getProxy ã€createAopProxy ç­‰ç­‰ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ°ä¸‹é¢ä¸€éƒ¨åˆ†ã€‚ æœ€ç»ˆä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼ŒAOP ä»£ç†ç›¸å…³çš„å°±ä¸ç»†çœ‹äº†ã€‚ ä¸€è·¯æ”¾è¡Œï¼Œç›´åˆ° initializeBean æ‰§è¡Œç»“æŸã€‚ æ­¤æ—¶å‘ç°ï¼šA è¢«æ›¿æ¢ä¸ºäº†ä»£ç†å¯¹è±¡ã€‚ æ‰€ä»¥ doCreateBean è¿”å›ï¼Œä»¥åŠåé¢æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­çš„éƒ½æ˜¯ä»£ç†å¯¹è±¡ã€‚ æœ‰å¾ªç¯ä¾èµ–çš„åŠ¨æ€ä»£ç†è¿™ä¸€æ¬¡æŠŠå¾ªç¯ä¾èµ–æ‰“å¼€ï¼š @Servicepublic class CircularServiceA &#123; private String fieldA = &quot;å­—æ®µ A&quot;; @Autowired private CircularServiceB circularServiceB; public void methodA() &#123; System.out.println(&quot;æ–¹æ³• A æ‰§è¡Œ&quot;); &#125;&#125;@Aspect@Componentpublic class AspectA &#123; @Before(&quot;execution(public void com.liuzhihang.circular.CircularServiceA.methodA())&quot;) public void beforeA() &#123; System.out.println(&quot;beforeA æ‰§è¡Œ&quot;); &#125;&#125;@Servicepublic class CircularServiceB &#123; @Autowired private CircularServiceA circularServiceA; public void methodB() &#123; &#125;&#125;@Aspect@Componentpublic class AspectB &#123; @Before(&quot;execution(public void com.liuzhihang.circular.CircularServiceB.methodB())&quot;) public void beforeB() &#123; System.out.println(&quot;beforeB æ‰§è¡Œ&quot;); &#125;&#125; å¼€å§‹ Debugï¼Œå‰é¢çš„ä¸€äº›åˆ—æµç¨‹ï¼Œéƒ½å’Œæ­£å¸¸çš„æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚è€Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼Œåˆ›å»º B çš„æ—¶å€™ï¼Œéœ€è¦ä»ä¸‰çº§ç¼“å­˜è·å– Aã€‚ æ­¤æ—¶åœ¨ getSingleton æ–¹æ³•ä¸­ä¼šè°ƒç”¨ï¼šsingletonObject = singletonFactory.getObject(); æœ‰æ—¶ä¼šæ¯”è¾ƒç–‘æƒ‘ singletonFactory.getObject() è°ƒç”¨çš„æ˜¯å“ªé‡Œï¼Ÿ æ‰€ä»¥è¿™ä¸€å—è°ƒç”¨çš„æ˜¯ getEarlyBeanReferenceï¼Œå¼€å§‹éå†æ‰§è¡Œ BeanPostProcessorã€‚ çœ‹åˆ° wrapIfNecessary å°±æ˜ç™½äº†å§ï¼è¿™å—ä¼šè·å–ä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚ ä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶è¿”å›ï¼Œå¹¶æ”¾åˆ°äºŒçº§ç¼“å­˜çš„æ˜¯ä¸€ä¸ª A çš„ä»£ç†å¯¹è±¡ã€‚ è¿™æ · B å°±åˆ›å»ºå®Œæ¯•äº†ï¼ åˆ° A å¼€å§‹åˆå§‹åŒ–å¹¶æ‰§è¡Œåç½®å¤„ç†å™¨äº†ï¼å› ä¸º A ä¹Ÿæœ‰ä»£ç†ï¼Œæ‰€ä»¥ A ä¹Ÿä¼šæ‰§è¡Œåˆ° postProcessAfterInitialization è¿™ä¸€éƒ¨åˆ†ï¼ ä½†æ˜¯åœ¨æ‰§è¡Œ wrapIfNecessary ä¹‹å‰ï¼Œä¼šå…ˆåˆ¤æ–­ä»£ç†å¯¹è±¡ç¼“å­˜æ˜¯å¦æœ‰ A äº†ã€‚ this.earlyProxyReferences.remove(cacheKey) != bean ä½†æ˜¯è¿™å—è·å–åˆ°çš„æ˜¯ A çš„ä»£ç†å¯¹è±¡ã€‚è‚¯å®šæ˜¯ false ã€‚ æ‰€ä»¥ä¸ä¼šå†ç”Ÿæˆä¸€æ¬¡ A çš„ä»£ç†å¯¹è±¡ã€‚ æ€»ç»“å¯ä»¥çœ‹åˆ°ï¼Œå¾ªç¯ä¾èµ–ä¸‹ï¼Œæœ‰æ²¡æœ‰ä»£ç†æƒ…å†µä¸‹çš„åŒºåˆ«å°±åœ¨ï¼š singletonObject = singletonFactory.getObject(); åœ¨å¾ªç¯ä¾èµ–å‘ç”Ÿçš„æƒ…å†µä¸‹ B ä¸­çš„ A èµ‹å€¼æ—¶ï¼š æ— ä»£ç†ï¼šgetObject ç›´æ¥è¿”å›åŸæ¥çš„ Bean æœ‰ä»£ç†ï¼šgetObject è¿”å›çš„æ˜¯ä»£ç†å¯¹è±¡ ç„¶åéƒ½æ”¾åˆ°äºŒçº§ç¼“å­˜ã€‚ ä¸ºä»€ä¹ˆè¦ä¸‰çº§ç¼“å­˜? å‡è®¾å»æ‰ä¸‰çº§ç¼“å­˜ å»æ‰ä¸‰çº§ç¼“å­˜ä¹‹åï¼ŒBean ç›´æ¥åˆ›å»º earlySingletonObjectsï¼Œ çœ‹ç€å¥½åƒä¹Ÿå¯ä»¥ã€‚ å¦‚æœæœ‰ä»£ç†çš„æ—¶å€™ï¼Œåœ¨ earlySingletonObjects ç›´æ¥æ”¾ä»£ç†å¯¹è±¡å°±è¡Œäº†ã€‚ ä½†æ˜¯ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼šåœ¨å®ä¾‹åŒ–é˜¶æ®µå°±å¾—æ‰§è¡Œåç½®å¤„ç†å™¨ï¼Œåˆ¤æ–­æœ‰ AnnotationAwareAspectJAutoProxyCreator å¹¶åˆ›å»ºä»£ç†å¯¹è±¡ã€‚ è¿™ä¹ˆä¸€æƒ³ï¼Œæ˜¯ä¸æ˜¯ä¼šå¯¹ Bean çš„ç”Ÿå‘½å‘¨æœŸæœ‰å½±å“ã€‚ åŒæ ·ï¼Œå…ˆåˆ›å»º singletonFactory çš„å¥½å¤„å°±æ˜¯ï¼šåœ¨çœŸæ­£éœ€è¦å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå†ä½¿ç”¨ singletonFactory.getObject() è·å– Bean æˆ–è€… Bean çš„ä»£ç†ã€‚ç›¸å½“äºæ˜¯å»¶è¿Ÿå®ä¾‹åŒ–ã€‚ å‡è®¾å»æ‰äºŒçº§ç¼“å­˜ å¦‚æœå»æ‰äº†äºŒçº§ç¼“å­˜ï¼Œåˆ™éœ€è¦ç›´æ¥åœ¨ singletonFactory.getObject() é˜¶æ®µåˆå§‹åŒ–å®Œæ¯•ï¼Œå¹¶æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­ã€‚ é‚£æœ‰è¿™ä¹ˆä¸€ç§åœºæ™¯ï¼ŒB å’Œ C éƒ½ä¾èµ–äº† Aã€‚ è¦çŸ¥é“åœ¨æœ‰ä»£ç†çš„æƒ…å†µä¸‹ singletonFactory.getObject() è·å–çš„æ˜¯ä»£ç†å¯¹è±¡ã€‚ è€Œå¤šæ¬¡è°ƒç”¨ singletonFactory.getObject() è¿”å›çš„ä»£ç†å¯¹è±¡æ˜¯ä¸åŒçš„ï¼Œå°±ä¼šå¯¼è‡´ B å’Œ C ä¾èµ–äº†ä¸åŒçš„ Aã€‚ é‚£å¦‚æœè·å– B åˆ°ä¹‹åç›´æ¥æ”¾åˆ°ä¸€çº§ç¼“å­˜ï¼Œç„¶å C å†è·å–å‘¢ï¼Ÿ ğŸ˜³ â€¦â€¦ ä¸€çº§ç¼“å­˜æ”¾çš„æ˜¯å·²ç»åˆå§‹åŒ–å®Œæ¯•çš„ Beanï¼Œè¦çŸ¥é“ A ä¾èµ–äº† B å’Œ C ï¼ŒA è¿™æ—¶å€™è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæ¯•ã€‚ å°ç»“å¾ªç¯ä¾èµ–çš„åœºæ™¯æœ‰å¾ˆå¤šï¼Œæœ¬æ–‡åªæ˜¯é€šè¿‡ Debug ï¼Œæ¥äº†è§£åˆ°å¾ªç¯ä¾èµ–å’Œ AOP ä¹‹é—´çš„å…³ç³»ï¼Œä»¥åŠäº†è§£åˆ°ä¸ºä»€ä¹ˆè¦ç”¨ä¸‰çº§ç¼“å­˜ã€‚ å½“ç„¶ï¼ŒSpring è®¾è®¡ä¹‹åˆæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿå¦‚ä½•ä¸€æ­¥ä¸€æ­¥å‘å±•æˆç°åœ¨è¿™ç§çš„ï¼Ÿ è‚¯å®šæ˜¯ä¸èƒ½æ…¢æ…¢å»ç ”ç©¶äº†ï¼Œæ‰€ä»¥åªèƒ½ä»¥ç°åœ¨çš„ç‰ˆæœ¬ï¼Œå»æ£æµ‹ä½œè€…çš„æ„å›¾ã€‚ ä¸è¶³ä¹‹å¤„ï¼Œå¤šå¤šæŒ‡æ­£ã€‚ ç›¸å…³æ¨è Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ Spring æºç å­¦ä¹  16ï¼šå•ä¾‹ Bean åˆ›å»º Spring æºç å­¦ä¹  15ï¼šfinishBeanFactoryInitializationï¼ˆé‡ç‚¹ï¼‰","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ","slug":"source-code/spring/Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„","date":"2021-01-23T13:40:00.000Z","updated":"2021-01-31T04:09:17.998Z","comments":true,"path":"2021/01/23/source-spring-circular-dependence-1.html","link":"","permalink":"https://liuzhihang.com/2021/01/23/source-spring-circular-dependence-1.html","excerpt":"","text":"å‰è¨€ç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´åœ¨å·¥ä½œä¸­éƒ½ä¼šé‡åˆ°å¾ªç¯ä¾èµ–ï¼Œä¸è¿‡å¤§å¤šæ•°å®ƒæ˜¯è¿™æ ·æ˜¾ç¤ºçš„ï¼š è¿˜ä¼šæç¤ºè¿™ä¹ˆä¸€å¥ï¼š Requested bean is currently in creation: Is there an unresolvable circular reference? è€é“ï¼è¿™å°±æ˜¯å‘ç”Ÿå¾ªç¯ä¾èµ–äº†ï¼ å½“ç„¶è¿™é‡Œæ˜¯ä¸€ä¸ªå¼‚å¸¸æƒ…å†µã€‚ åœ¨æˆ‘çš„ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»å¦‚ä½•é¿å… Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆï¼Œå…¶ä¸­ç½‘å‹ç»™å»ºè®®ï¼Œè¯´å¯ä»¥åœ¨ç±»ä¸­æ³¨å…¥è‡ªèº«ï¼Œç„¶åè°ƒç”¨ï¼Œè€Œæ³¨å…¥è‡ªèº«çš„è¿‡ç¨‹ä¹Ÿæ˜¯å¾ªç¯ä¾èµ–çš„å¤„ç†è¿‡ç¨‹ã€‚ ä¸‹é¢å°±ä¸€èµ·çœ‹ä¸€çœ‹ï¼Œä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Œä»¥åŠ Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ– Dependency Resolution Process Spring IoC å®¹å™¨ä¼šåœ¨è¿è¡Œæ—¶æ£€æµ‹åˆ°æ„é€ å‡½æ•°æ³¨å…¥å¾ªç¯å¼•ç”¨ï¼Œå¹¶æŠ›å‡º BeanCurrentlyInCreationExceptionã€‚ æ‰€ä»¥è¦é¿å…æ„é€ å‡½æ•°æ³¨å…¥ï¼Œå¯ä»¥ä½¿ç”¨ setter æ³¨å…¥æ›¿ä»£ã€‚ æ ¹æ®å®˜æ–¹æ–‡æ¡£è¯´æ˜ï¼ŒSpring ä¼šè‡ªåŠ¨è§£å†³åŸºäº setter æ³¨å…¥çš„å¾ªç¯ä¾èµ–ã€‚ å½“ç„¶åœ¨å’±ä»¬å·¥ä½œä¸­ç°åœ¨éƒ½ä½¿ç”¨ @Autowired æ³¨è§£æ¥æ³¨å…¥å±æ€§ã€‚ PS: @Autowired æ˜¯é€šè¿‡åå°„è¿›è¡Œèµ‹å€¼ã€‚ è¿™é‡Œä»æˆ‘ä»¬æœ€ç»å¸¸ä½¿ç”¨çš„åœºæ™¯åˆ‡å…¥ï¼Œçœ‹ Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ ä»£ç @Servicepublic class CircularServiceA &#123; @Autowired private CircularServiceB circularServiceB;&#125;@Servicepublic class CircularServiceB &#123; @Autowired private CircularServiceC circularServiceC;&#125;@Servicepublic class CircularServiceC &#123; @Autowired private CircularServiceA circularServiceA;&#125; è¿™é‡Œæœ‰ Aã€Bã€C ä¸‰ä¸ªç±»ï¼Œå¯ä»¥çœ‹åˆ°å‘ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼š ä½†æ˜¯å³ä½¿å‘ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥å¯åŠ¨ OKï¼Œä½¿ç”¨å¹¶æ²¡æœ‰ä»»ä½•å½±å“ã€‚ Spring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„åœ¨ Spring å•ä¾‹ Bean çš„åˆ›å»º ä¸­ä»‹ç»ä»‹ç»äº†ä½¿ç”¨ä¸‰çº§ç¼“å­˜ã€‚ singletonObjectsï¼š ä¸€çº§ç¼“å­˜ï¼Œå­˜å‚¨å•ä¾‹å¯¹è±¡ï¼ŒBean å·²ç»å®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–å®Œæˆã€‚ earlySingletonObjectsï¼š äºŒçº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonObjectï¼Œè¿™ä¸ª Bean å®ä¾‹åŒ–äº†ï¼Œè¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚ singletonFactoriesï¼š ä¸‰çº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonFactoryã€‚ å½“ç„¶ï¼Œè¿™é‡Œçœ‹ç€æ¯”è¾ƒé•¿ï¼Œå¯ä»¥ç®€åŒ–ä¸€ä¸‹ï¼š é€šè¿‡ Debug æ¥è¯´æ˜ç”Ÿæˆè¿‡ç¨‹ä» preInstantiateSingletons æ–¹æ³•å¼€å§‹ï¼š æ·»åŠ æ–­ç‚¹ beanName.equals(&quot;circularServiceA&quot;) å¯åŠ¨Debugï¼š ä¼šä»ç¼“å­˜ä¸­è·å–å•ä¾‹ Bean è¿™é‡Œå¾ˆæ˜¾ç„¶è·å–ä¸åˆ°ï¼Œç»§ç»­æ‰§è¡Œï¼Œåˆ›å»ºå•ä¾‹å®ä¾‹ å‘ç°æ˜¯å•ä¾‹å†æ¬¡è·å– è¿™é‡Œè¿˜ä¼šä»ä¸€çº§ç¼“å­˜è·å–ä¸€æ¬¡ circularServiceA ï¼Œ æ²¡æœ‰è·å–åˆ°ï¼Œå°† circularServiceA æ·»åŠ åˆ°åœ¨åˆ›å»ºçš„æ± å­é‡Œé¢ ï¼ˆsingletonsCurrentlyInCreation æ˜¯ä¸€ä¸ª set é›†åˆï¼‰ã€‚ ç„¶åä¼šè°ƒç”¨å·¥å‚æ–¹æ³• createBean(beanName, mbd, args) åˆ›å»ºå¯¹è±¡ã€‚ åœ¨ createBean ä¸­å»å®ä¾‹åŒ– Bean ã€‚ åˆ¤æ–­æ˜¯å¦æ˜¯å¾ªç¯å¼•ç”¨ï¼Œæ˜¯çš„è¯éœ€è¦æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ä¸­ã€‚ circularServiceA ä¸åœ¨ä¸€çº§ç¼“å­˜ä¸­ï¼Œåˆ™å°† circularServiceA çš„ singletonFactory æ·»åŠ åˆ° ä¸‰çº§ç¼“å­˜ ï¼ˆsingletonFactoriesï¼‰ ä¸­ï¼ŒåŒæ—¶ä»äºŒçº§ç¼“å­˜ä¸­ç§»é™¤ã€‚ åˆ°è¿™ä¸€æ­¥ä¸ºæ­¢ï¼ŒcircularServiceA å·²ç»åœ¨ä¸‰çº§ç¼“å­˜ä¸­äº†ã€‚ å¼€å§‹å¯¹ Bean çš„å±æ€§è¿›è¡Œèµ‹å€¼ã€‚ åœ¨ populateBean æ–¹æ³•ä¸­æ‰§è¡Œåˆ° PropertyValues pvsToUse = bp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName); å°±ä¼šå¯¹å±æ€§è¿›è¡Œèµ‹å€¼ åœ¨ injet æ–¹æ³•ä¸­ï¼Œå›å»è§£å†³ç›¸å…³ä¾èµ–ã€‚ ç»§ç»­ Debug ï¼Œå‘ç°è§£å†³ä¾èµ–ï¼Œæœ€åå‘ç°å…¶å®åˆè°ƒç”¨å› beanFactory.getBean(beanName); ä¸è¿‡è¿™æ¬¡åˆ›å»ºçš„æ˜¯ circularServiceBã€‚ ä¸‹é¢æ˜¯è°ƒç”¨é“¾ï¼š circularServiceB çš„è¿‡ç¨‹å’Œ circularServiceA çš„ä¸€æ ·ï¼Œä¹Ÿæ˜¯åˆ›å»ºäº†ä¸‰çº§ç¼“å­˜ï¼Œç„¶åå»åˆ›å»º circularServiceC è¿™æ—¶å€™ä¸‰çº§ç¼“å­˜é‡Œé¢æœ‰å®ƒä»¬ä¸‰ä¸ªçš„ singletonFactory ã€‚ circularServiceC ä¹Ÿè°ƒç”¨åˆ° doGetBean æ–¹æ³•å»è·å– circularServiceA ä¸è¿‡è¿™æ¬¡ è°ƒç”¨åˆ° Object sharedInstance = getSingleton(beanName); çš„æ—¶å€™, circularServiceA å·²ç»å­˜åœ¨äº†ã€‚ è¿™æ¬¡è°ƒç”¨è™½ç„¶æ²¡æœ‰ä»ä¸€çº§ç¼“å­˜ ï¼ˆsingletonObjectsï¼‰ ä¸­è·å–åˆ° circularServiceAï¼Œä½†æ˜¯ circularServiceA åœ¨åˆ›å»ºä¸­ï¼Œæ‰€ä»¥è¿›å…¥åˆ¤æ–­ åœ¨è¿™é‡Œæ‰§è¡Œå®Œä¹‹åï¼Œ circularServiceA ä»ä¸‰çº§ç¼“å­˜å‡çº§åˆ°äºŒçº§ç¼“å­˜ ä½¿ç”¨åå°„å¯¹ circularServiceC ä¸­çš„ circularServiceA è¿›è¡Œèµ‹å€¼ï¼Œ æ­¤æ—¶ circularServiceA æ˜¯åœ¨ äºŒçº§ç¼“å­˜ä¸­ã€‚ é‚£å°±æ¯”è¾ƒå¥½å¥‡äº†ï¼Œè¿™æ—¶å€™ circularServiceC é‡Œé¢çš„ circularServiceA å·²ç»é€šè¿‡åå°„èµ‹å€¼ï¼Œè¿™ä¸ªèµ‹å€¼ç»™çš„æ˜¯ä»€ä¹ˆå€¼ï¼Ÿ æŸ¥çœ‹ä»£ç ï¼š è¿™å—æ˜¯ä»ä¸‰çº§ç¼“å­˜ï¼ˆsingletonFactoriesï¼‰ä¸­è·å–çš„ singletonObjectï¼Œç„¶åè°ƒç”¨ singletonObject = singletonFactory.getObject(); è·å–çš„ä¸€ä¸ªå¯¹è±¡ è¿™é‡Œè·å–åˆ°çš„æ˜¯ circularServiceA çš„å¼•ç”¨ï¼Œæ³¨æ„ circularServiceA è¿™æ—¶å€™è¿˜æ²¡åˆ›å»ºå®Œæˆï¼Œåªæ˜¯å¼•ç”¨ã€‚æ‰€ä»¥è¿™é‡Œèµ‹å€¼çš„æ˜¯ circularServiceA çš„å¼•ç”¨ã€‚ åˆ°è¿™é‡Œ circularServiceC å°±åˆ›å»ºå®Œäº†ã€‚ ç„¶åä¼šå°† C æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜å’Œå·²æ³¨å†Œåˆ—è¡¨ä¸­ï¼ŒåŒæ—¶ä»äºŒçº§ä¸‰çº§ç¼“å­˜ä¸­åˆ é™¤ Cã€‚ ç»§ç»­æ‰§è¡Œ B å’Œ A çš„å±æ€§èµ‹å€¼ä»¥åŠåç»­çš„åˆå§‹åŒ–æµç¨‹ã€‚ è‡³æ­¤ï¼Œå¾ªç¯ä¾èµ–è§£å†³å®Œæ¯•ã€‚ æ€»ç»“Spring ä½¿ç”¨ä¸‰çº§ç¼“å­˜æ¥è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œä¸‰çº§ç¼“å­˜åˆ†åˆ«æ˜¯ï¼š singletonObjectsï¼š ä¸€çº§ç¼“å­˜ï¼Œå­˜å‚¨å•ä¾‹å¯¹è±¡ï¼ŒBean å·²ç»å®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–å®Œæˆã€‚ earlySingletonObjectsï¼š äºŒçº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonObjectï¼Œè¿™ä¸ª Bean å®ä¾‹åŒ–äº†ï¼Œè¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚ singletonFactoriesï¼š ä¸‰çº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonFactoryã€‚ æœ¬æ–‡ä¹Ÿé€šè¿‡ Debug æ¥éªŒè¯äº†ä½¿ç”¨ä¸‰çº§ç¼“å­˜è§£å†³ä¾èµ–çš„è¿‡ç¨‹ã€‚ ä¸è¿‡è¿˜æœ‰ä¸€äº›é—®é¢˜æ²¡æœ‰è¯´æ˜ï¼š å¾ªç¯ä¾èµ–å’Œä»£ç†ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿæ¯”å¦‚ @Transactional å’Œ @Async æ³¨è§£ä¼šå¯¹å¾ªç¯ä¾èµ–äº§ç”Ÿä»€ä¹ˆå½±å“ï¼Ÿ ä¸ºä»€ä¹ˆè¦ç”¨ä¸‰çº§ç¼“å­˜ï¼ŸäºŒçº§ç¼“å­˜ä¸å¯ä»¥ä¹ˆï¼Ÿ ç›¸å…³æ¨è Spring æºç å­¦ä¹  16ï¼šå•ä¾‹ Bean åˆ›å»º Spring æºç å­¦ä¹  15ï¼šfinishBeanFactoryInitializationï¼ˆé‡ç‚¹ï¼‰ Spring æºç å­¦ä¹  14ï¼šinitApplicationEventMulticaster","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  16ï¼šå•ä¾‹ Bean åˆ›å»º","slug":"source-code/spring/16-Spring å•ä¾‹ Bean çš„åˆ›å»º","date":"2021-01-17T13:40:00.000Z","updated":"2021-01-18T08:19:22.468Z","comments":true,"path":"2021/01/17/source-spring-16.html","link":"","permalink":"https://liuzhihang.com/2021/01/17/source-spring-16.html","excerpt":"","text":"å‰è¨€åœ¨ finishBeanFactoryInitialization ä¸­ä»‹ç»äº†åˆ›å»º Bean çš„æµç¨‹å¤§æ¦‚æµç¨‹ï¼Œè¿™é‡Œè¿›å…¥å•ä¾‹ Bean çš„åˆ›å»ºè¿‡ç¨‹ã€‚ è¿™é‡Œä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†åˆ›å»ºå•ä¾‹ Bean getSingleton createBean getObjectForBeanInstance ä¸‹é¢è¿›å…¥æºç ï¼š getSingletonpublic Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123; Assert.notNull(beanName, &quot;Bean name must not be null&quot;); // åŠ é” synchronized (this.singletonObjects) &#123; // æ£€æŸ¥ singletonObjects ç¼“å­˜ä¸­æ˜¯å¦æœ‰ Object singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) &#123; // æ£€æŸ¥æ˜¯å¦åœ¨æ‰§è¡Œé”€æ¯ if (this.singletonsCurrentlyInDestruction) &#123; throw new BeanCreationNotAllowedException(beanName, &quot;Singleton bean creation not allowed while singletons of this factory are in destruction &quot; + &quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;); &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Creating shared instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; // å°† Bean æ·»åŠ åˆ° singletonsCurrentlyInCreation é›†åˆä¸­, è¡¨ç¤ºæ­£åœ¨åˆ›å»º beforeSingletonCreation(beanName); boolean newSingleton = false; boolean recordSuppressedExceptions = (this.suppressedExceptions == null); if (recordSuppressedExceptions) &#123; this.suppressedExceptions = new LinkedHashSet&lt;&gt;(); &#125; try &#123; // è°ƒç”¨å·¥å‚æ–¹æ³• // ä¹Ÿå°±æ˜¯è°ƒç”¨ createBean(beanName, mbd, args) singletonObject = singletonFactory.getObject(); newSingleton = true; &#125; catch (IllegalStateException ex) &#123; // Has the singleton object implicitly appeared in the meantime -&gt; // if yes, proceed with it since the exception indicates that state. singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) &#123; throw ex; &#125; &#125; catch (BeanCreationException ex) &#123; if (recordSuppressedExceptions) &#123; for (Exception suppressedException : this.suppressedExceptions) &#123; ex.addRelatedCause(suppressedException); &#125; &#125; throw ex; &#125; finally &#123; if (recordSuppressedExceptions) &#123; this.suppressedExceptions = null; &#125; // åˆ›å»ºæˆåŠŸ, ä» singletonsCurrentlyInCreation ç§»é™¤ afterSingletonCreation(beanName); &#125; if (newSingleton) &#123; // å°†ç»™å®šçš„å•ä¾‹å¯¹è±¡æ·»åŠ åˆ°è¯¥å·¥å‚çš„å•ä¾‹ç¼“å­˜ä¸­ // this.singletonObjects.put(beanName, singletonObject); // this.singletonFactories.remove(beanName); // this.earlySingletonObjects.remove(beanName); // this.registeredSingletons.add(beanName); addSingleton(beanName, singletonObject); &#125; &#125; return singletonObject; &#125;&#125; è¿”å›ä»¥ç»™å®šåç§°æ³¨å†Œçš„ï¼ˆåŸå§‹ï¼‰å•ä¾‹å¯¹è±¡ï¼Œå¦‚æœå°šæœªæ³¨å†Œï¼Œåˆ™åˆ›å»ºå¹¶æ³¨å†Œä¸€ä¸ªæ–°å¯¹è±¡ã€‚ è¿™ä¸€å—ä¸€å…±å¯ä»¥æ‹†æˆä¸‰éƒ¨åˆ†æ¥ç†è§£ï¼š 1. ä»ç¼“å­˜ä¸­è·å– singletonObjectssingletonObject æ˜¯ä»€ä¹ˆï¼Ÿ /** Cache of singleton objects: bean name to bean instance. */private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256); singletonObjects æ˜¯ä¸€ä¸ª ConcurrentHashMapï¼Œ ç”¨æ¥ç¼“å­˜å•ä¾‹å¯¹è±¡çš„å®ä¾‹ã€‚ 2. åˆ›å»º singletonObjectåœ¨ä»ç¼“å­˜ä¸­æ²¡æœ‰è·å–åˆ° singletonObject ï¼Œåˆ›å»ºæ–°çš„å¯¹è±¡ singletonObject = singletonFactory.getObject(); è¿™ä¸€æ­¥å…¶å®å°±æ˜¯è°ƒç”¨å¤–è¾¹çš„ createBean(beanName, mbd, args) æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¥å‚æ–¹æ³•ã€‚ é€šè¿‡ createBean æ–¹æ³•ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ singletonObjectã€‚ 3. å°†åˆ›å»ºçš„ singletonObject æ·»åŠ åˆ°ç¼“å­˜ä¸­protected void addSingleton(String beanName, Object singletonObject) &#123; synchronized (this.singletonObjects) &#123; this.singletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); this.earlySingletonObjects.remove(beanName); // å·²ç»æˆåŠŸåˆ›å»ºçš„å•ä¾‹ this.registeredSingletons.add(beanName); &#125;&#125; è¿™ä¸€æ­¥æ¶‰åŠåˆ°ä¸‰ä¸ªç¼“å­˜ï¼Œä»¥åŠä¸€ä¸ªæˆåŠŸåˆ›å»ºçš„å•ä¾‹åˆ—è¡¨ã€‚ /** Cache of singleton objects: bean name to bean instance. *//** ç¼“å­˜å•ä¾‹å¯¹è±¡ï¼Œ K-V -&gt; BeanName - Bean å®ä¾‹ */private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);/** Cache of singleton factories: bean name to ObjectFactory. *//** ç¼“å­˜ Bean å·¥å‚ */private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16);/** Cache of early singleton objects: bean name to bean instance. *//** ç¼“å­˜æ—©æœŸå•ä¾‹å¯¹è±¡ */private final Map&lt;String, Object&gt; earlySingletonObjects = new ConcurrentHashMap&lt;&gt;(16);/** Set of registered singletons, containing the bean names in registration order. *//** å·²æ³¨å†Œçš„å•ä¾‹åˆ—è¡¨ï¼ŒæŒ‰æ³¨å†Œé¡ºåºä¿å­˜ BeanNameã€‚ */private final Set&lt;String&gt; registeredSingletons = new LinkedHashSet&lt;&gt;(256); å°†åˆ›å»ºçš„å•ä¾‹å¯¹è±¡ï¼Œæ·»åŠ åˆ°å•ä¾‹ç¼“å­˜ä¸­ï¼ŒåŒæ—¶å°†å·¥å‚ç¼“å­˜ä»¥åŠæ—©æœŸå•ä¾‹å¯¹è±¡ç¼“å­˜ä¸­çš„å¯¹åº”å¯¹è±¡åˆ é™¤ã€‚ createBeanprotected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Creating instance of bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; RootBeanDefinition mbdToUse = mbd; // Make sure bean class is actually resolved at this point, and // clone the bean definition in case of a dynamically resolved Class // which cannot be stored in the shared merged bean definition. // è·å–çœŸå®çš„ç±»å‹ Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName); if (resolvedClass != null &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != null) &#123; // åˆ›å»ºæ–°çš„ mbd é˜²æ­¢ å…¶ä»–çº¿ç¨‹ä¿®æ”¹ mbdToUse = new RootBeanDefinition(mbd); mbdToUse.setBeanClass(resolvedClass); &#125; // Prepare method overrides. try &#123; // éªŒè¯å¹¶å‡†å¤‡ä¸ºæ­¤beanå®šä¹‰çš„æ–¹æ³•æ›¿ä»£ã€‚ æ£€æŸ¥æ˜¯å¦å­˜åœ¨å…·æœ‰æŒ‡å®šåç§°çš„æ–¹æ³•ã€‚ mbdToUse.prepareMethodOverrides(); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanDefinitionStoreException(mbdToUse.getResourceDescription(), beanName, &quot;Validation of method overrides failed&quot;, ex); &#125; try &#123; // Give BeanPostProcessors a chance to return a proxy instead of the target bean instance. // åº”ç”¨å®ä¾‹åŒ–ä¹‹å‰çš„åå¤„ç†å™¨ï¼Œä»¥è§£å†³æŒ‡å®šçš„beanæ˜¯å¦å­˜åœ¨å®ä¾‹åŒ–å¿«æ·æ–¹å¼ã€‚ // InstantiationAwareBeanPostProcessor åç½®å¤„ç†å™¨ // postProcessBeforeInstantiation æ–¹æ³•å¯èƒ½ä¼šå·²ç»å®ä¾‹åŒ– Bean Object bean = resolveBeforeInstantiation(beanName, mbdToUse); if (bean != null) &#123; return bean; &#125; &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbdToUse.getResourceDescription(), beanName, &quot;BeanPostProcessor before instantiation of bean failed&quot;, ex); &#125; try &#123; // å®ä¾‹åŒ– Bean Object beanInstance = doCreateBean(beanName, mbdToUse, args); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Finished creating instance of bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; return beanInstance; &#125; catch (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123; // A previously detected exception with proper bean creation context already, // or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry. throw ex; &#125; catch (Throwable ex) &#123; throw new BeanCreationException( mbdToUse.getResourceDescription(), beanName, &quot;Unexpected exception during bean creation&quot;, ex); &#125;&#125; è¿™ä¸ªæ–¹æ³•ä¸­æ¶‰åŠåˆ°ï¼šåˆ›å»º Bean å®ä¾‹ , å¡«å…… Bean , åº”ç”¨ PostProcessorã€‚ å…¶ä¸­å®ä¾‹åŒ– Bean æ˜¯åœ¨ doCreateBean ä¸­ã€‚ç°åœ¨é‡ç‚¹çœ‹ä¸€ä¸‹ doCreateBean æ–¹æ³•ã€‚ doCreateBeanprotected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException &#123; // Instantiate the bean. // Bean çš„ å¯¹è±¡åŒ…è£… BeanWrapper instanceWrapper = null; if (mbd.isSingleton()) &#123; // ä»ç¼“å­˜ä¸­è·å– instanceWrapper = this.factoryBeanInstanceCache.remove(beanName); &#125; if (instanceWrapper == null) &#123; // ç¼“å­˜ä¸­è·å–ä¸åˆ°åˆ™ç›´æ¥åˆ›å»º, è¿™é‡Œåˆ›å»ºçš„ BeanInstance !!! instanceWrapper = createBeanInstance(beanName, mbd, args); &#125; // è·å– Bean å®ä¾‹ä»¥åŠç±»å‹ Object bean = instanceWrapper.getWrappedInstance(); Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass(); if (beanType != NullBean.class) &#123; mbd.resolvedTargetType = beanType; &#125; // Allow post-processors to modify the merged bean definition. synchronized (mbd.postProcessingLock) &#123; if (!mbd.postProcessed) &#123; try &#123; // å¦‚æœå…è®¸ä¿®æ”¹ mbd // è°ƒç”¨ MergedBeanDefinitionPostProcessor åç½®å¤„ç†å™¨çš„ // postProcessMergedBeanDefinition(mbd, beanType, beanName); applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Post-processing of merged bean definition failed&quot;, ex); &#125; mbd.postProcessed = true; &#125; &#125; // Eagerly cache singletons to be able to resolve circular references // even when triggered by lifecycle interfaces like BeanFactoryAware. // mbd æ˜¯å•ä¾‹ ä¸” å…è®¸å¾ªç¯å¼•ç”¨, (é»˜è®¤ true) ä¸”åœ¨åˆ›å»º boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)); if (earlySingletonExposure) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Eagerly caching bean &#x27;&quot; + beanName + &quot;&#x27; to allow for resolving potential circular references&quot;); &#125; // å…ˆè·å– ä¹‹å‰çš„ Bean çš„å¼•ç”¨, ä» beanPostProcessorCache ä¸­ è·å– SmartInstantiationAwareBeanPostProcessor // ç„¶åä» SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference è·å–ä¹‹å‰çš„å¼•ç”¨ addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)); &#125; // Initialize the bean instance. Object exposedObject = bean; try &#123; // å±æ€§èµ‹å€¼ populateBean(beanName, mbd, instanceWrapper); // æ‰§è¡Œ init æ–¹æ³• exposedObject = initializeBean(beanName, exposedObject, mbd); &#125; catch (Throwable ex) &#123; if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123; throw (BeanCreationException) ex; &#125; else &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Initialization of bean failed&quot;, ex); &#125; &#125; // è¿™é‡Œå…è®¸å¾ªç¯ä¾èµ– if (earlySingletonExposure) &#123; // è·å–æ—©æœŸçš„ Bean, å¦‚æœæ²¡æœ‰å¾ªç¯ä¾èµ– åˆ™è·å–ä¸åˆ° Object earlySingletonReference = getSingleton(beanName, false); // æœ‰å¾ªç¯ä¾èµ– if (earlySingletonReference != null) &#123; // åˆ›å»ºçš„æ˜¯ä¸æ˜¯åŒä¸€ä¸ªï¼Œå¯èƒ½ä¼šæœ‰ä»£ç†å¯¹è±¡ if (exposedObject == bean) &#123; exposedObject = earlySingletonReference; &#125; else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123; // è·å–ä¾èµ–çš„ Bean å¹¶ å¾ªç¯æ”¾å…¥åˆ° actualDependentBeans String[] dependentBeans = getDependentBeans(beanName); Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;&gt;(dependentBeans.length); for (String dependentBean : dependentBeans) &#123; if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123; actualDependentBeans.add(dependentBean); &#125; &#125; if (!actualDependentBeans.isEmpty()) &#123; throw new BeanCurrentlyInCreationException(beanName, &quot;Bean with name &#x27;&quot; + beanName + &quot;&#x27; has been injected into other beans [&quot; + StringUtils.collectionToCommaDelimitedString(actualDependentBeans) + &quot;] in its raw version as part of a circular reference, but has eventually been &quot; + &quot;wrapped. This means that said other beans do not use the final version of the &quot; + &quot;bean. This is often the result of over-eager type matching - consider using &quot; + &quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;); &#125; &#125; &#125; &#125; // Register bean as disposable. try &#123; // æ³¨å†Œé”€æ¯æ–¹æ³• registerDisposableBeanIfNecessary(beanName, bean, mbd); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Invalid destruction signature&quot;, ex); &#125; return exposedObject;&#125; åŒæ ·æ˜¯ä»£ç å¾ˆé•¿å¾ˆé•¿ï¼ åˆ†æ­¥éª¤é˜…è¯»ï¼š å¦‚æœè¿™ä¸ª Bean æ˜¯å•ä¾‹ Bean ä¸”å…è®¸å¾ªç¯å¼•ç”¨ä¸”åœ¨åˆ›å»ºä¸­ï¼Œåˆ™è¯´æ˜åœ¨æœ‰å¾ªç¯å¼•ç”¨ã€‚åˆ™è°ƒç”¨ï¼š addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)); è¿™ä¸€è¡Œä»£ç æ¶‰åŠåˆ°ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ getEarlyBeanReference å’Œ addSingletonFactory getEarlyBeanReference addSingletonFactory è¿™ä¸€å—å¯ä»¥çœ‹åˆ°å°†åˆ›å»ºçš„ä¸€ä¸ªå•ä¾‹å¯¹è±¡çš„ singletonFactory æ·»åŠ åˆ°äº† singletonFactories ç¼“å­˜ä¸­ã€‚ åŒæ—¶å°† earlySingletonObjects ç¼“å­˜ä¸­çš„å•ä¾‹å¯¹è±¡ç§»é™¤ã€‚ é‚£ä»€ä¹ˆæ—¶å€™æ·»åŠ åˆ° earlySingletonObjects ç¼“å­˜ä¸­çš„å‘¢ï¼Ÿ è¿™å—å¯ä»¥å‚è€ƒ Spring æºç å­¦ä¹  15ï¼šfinishBeanFactoryInitialization åœ¨ getSingleton æ–¹æ³•ä¸­ put è¿›å»çš„ã€‚ ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘æŠŠè¿™ä¸€å°å—ä»£ç ä¹Ÿè´´å‡ºæ¥ï¼š åœ¨è¿™é‡Œå°†ç¼“å­˜ä» singletonFactories ç§»åˆ°äº† earlySingletonObjectsã€‚ Spring çš„ Bean å®ä¾‹åŒ–çš„æ—¶å€™ç”¨åˆ°çš„ä¸‰çº§ç¼“å­˜å…¶å®æ˜¯ï¼š singletonObjectsï¼š ä¸€çº§ç¼“å­˜ï¼Œå­˜å‚¨å•ä¾‹å¯¹è±¡ï¼ŒBean å·²ç»å®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–å®Œæˆã€‚ earlySingletonObjectsï¼š äºŒçº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonObjectï¼Œè¿™ä¸ª Bean å®ä¾‹åŒ–äº†ï¼Œè¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚ singletonFactoriesï¼š ä¸‰çº§ç¼“å­˜ï¼Œå­˜å‚¨ singletonFactory ä¸‹é¢ä¼šåˆå§‹åŒ– Bean è¿™é‡Œå…³æ³¨é‡ç‚¹å…³æ³¨ä¸‹é¢ä¸€éƒ¨åˆ†ï¼š populateBean å¯¹ Bean çš„å±æ€§è¿›è¡Œèµ‹å€¼ã€‚ è¿™å—éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å¯¹å±æ€§è¿›è¡Œèµ‹å€¼æ—¶ï¼Œå‘ç°ä¾èµ–äº†å…¶ä»– Beanï¼Œå°±ä¼šå»å…ˆåˆ›å»ºå…¶ä»– Beanã€‚ æˆ‘è¿™è¾¹ä½¿ç”¨çš„æ³¨è§£ @Autowired å°±ä¼šæ‰§è¡Œä¸‹é¢ä¸€éƒ¨åˆ†ï¼š åœ¨è¿™é‡Œè§£æå±æ€§çš„æ—¶å€™ï¼Œå°±ä¼šå»åˆ›å»ºå†…éƒ¨ä¾èµ–çš„ Beanã€‚ initializeBean getObjectForBeanInstanceè·å–ç»™å®šbeanå®ä¾‹çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯FactoryBeanï¼Œåˆ™ä¸ºbeanå®ä¾‹æœ¬èº«æˆ–å…¶åˆ›å»ºçš„å¯¹è±¡ã€‚ è¿™ä¸€å—é€»è¾‘ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ ¹æ®å‰é¢ä½ åˆ›å»ºçš„ beanInstance ï¼Œ åˆ¤æ–­å…¶ç±»å‹ï¼Œä»è€Œåˆ›å»º Bean å®ä¾‹ã€‚ æ€»ç»“æœ¬æ–‡ä¸»è¦ä»‹ç»äº†ä¸€ä¸ª å•ä¾‹ Bean çš„åˆ›å»ºï¼Œå½“ç„¶éƒ½æ˜¯å¤§å—å¤§å—çš„æºç ï¼Œéœ€è¦è€å¿ƒçš„å•ƒã€‚ é˜…è¯»å®Œæºç ï¼ŒåŸºæœ¬ä¸Šå¯¹å¾ªç¯ä¾èµ–èƒ½æœ‰ä¸ªè¯¦ç»†çš„äº†è§£ï¼ŒçŸ¥é“ Spring åœ¨åˆå§‹åŒ– Bean çš„æ—¶å€™æ˜¯ä½¿ç”¨ä¸‰çº§ç¼“å­˜æ¥å¤„ç†å¾ªç¯ä¾èµ–çš„é¢ï¼Œè€Œåé¢åˆ™ä¼šå•ç‹¬å‡†å¤‡ä¸€ç¯‡æ–‡ç« å¯¹å¾ªç¯ä¾èµ–åšä»‹ç»ã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  15ï¼šfinishBeanFactoryInitializationï¼ˆé‡ç‚¹ï¼‰ Spring æºç å­¦ä¹  14ï¼šinitApplicationEventMulticaster Spring æºç å­¦ä¹  13ï¼šinitMessageSource","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  15ï¼šfinishBeanFactoryInitializationï¼ˆé‡ç‚¹ï¼‰","slug":"source-code/spring/15-Spring finishBeanFactoryInitialization","date":"2021-01-12T13:40:00.000Z","updated":"2021-01-18T08:23:49.239Z","comments":true,"path":"2021/01/12/source-spring-15.html","link":"","permalink":"https://liuzhihang.com/2021/01/12/source-spring-15.html","excerpt":"","text":"å‰è¨€å¯ä»¥è¯´å‰é¢çš„éƒ½æ˜¯å‡†å¤‡å·¥ä½œï¼Œè€Œæ¥ä¸‹æ¥å¼€å§‹çš„æ‰æ˜¯é‡ç‚¹ï¼Œåœ¨è¿™ä¸€æ­¥ä¼šå®Œæˆ BeanFactory çš„åˆå§‹åŒ–ï¼ŒåŒæ—¶å®ä¾‹åŒ–å•ä¾‹ Beanã€‚ å…·ä½“æ€ä¹ˆæ“ä½œçš„ï¼Œé‚£å°±ä¸€èµ·é˜…è¯»æºç å§ï¼ ä¸è¿‡åœ¨é˜…è¯»æºç ä¹‹å‰ï¼Œè¿˜æ˜¯éœ€è¦äº†è§£ä¸€äº›çŸ¥è¯†çš„ã€‚ ä»€ä¹ˆæ˜¯ FactoryBean ï¼Ÿ FactoryBean æ˜¯å¦‚ä½•ä½¿ç”¨çš„ ï¼Ÿ Bean æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼Ÿ å¸¸è¯´çš„å¾ªç¯ä¾èµ–æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ ä»€ä¹ˆæ˜¯ FactoryBean ï¼Ÿåœ¨å®˜ç½‘çš„è¿™ç¯‡æ–‡ç« ã€ŠWhatâ€™s a FactoryBean?ã€‹ä¸­æœ‰ç›¸å…³è§£ç­”ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥çœ‹ä¸€ä¸‹ã€‚ ç”±å†…éƒ¨ä½¿ç”¨çš„å¯¹è±¡å®ç°çš„æ¥å£ï¼Œè¿™äº›å¯¹è±¡ BeanFactory æœ¬èº«å°±æ˜¯å•ä¸ªå¯¹è±¡çš„å·¥å‚ã€‚å¦‚æœ bean å®ç°æ­¤æ¥å£ï¼Œåˆ™å®ƒå°†ç”¨ä½œå¯¹è±¡å…¬å¼€çš„å·¥å‚ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”¨ä½œå°†è‡ªèº«å…¬å¼€çš„ bean å®ä¾‹ã€‚ æ³¨æ„ï¼šå®ç°æ­¤æ¥å£çš„ bean ä¸èƒ½ç”¨ä½œæ™®é€š beanã€‚ FactoryBeanä»¥ bean æ ·å¼å®šä¹‰ï¼Œä½†æ˜¯ä¸º bean å¼•ç”¨ï¼ˆgetObject()ï¼‰å…¬å¼€çš„å¯¹è±¡å§‹ç»ˆæ˜¯å®ƒåˆ›å»ºçš„å¯¹è±¡ã€‚ FactoryBeans å¯ä»¥æ”¯æŒå•ä¾‹å’ŒåŸå‹ï¼Œå¹¶ä¸”å¯ä»¥æŒ‰éœ€å»¶è¿Ÿåˆ›å»ºå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥åœ¨å¯åŠ¨æ—¶æ€¥äºåˆ›å»ºå¯¹è±¡ã€‚ å½“ç”Ÿå‘½ä¸€ä¸ª FactoryBean æ—¶ï¼Œä¼šå­˜åœ¨ä¸¤ä¸ªç±»å‹çš„ Beanï¼Œåˆ†åˆ«æ˜¯ FactoryBean æœ¬èº«ï¼Œä»¥åŠå®ƒéœ€è¦åˆ›å»ºçš„ç±»å‹çš„ Beanã€‚ ä¸‹é¢æ˜¯ä½¿ç”¨ç¤ºä¾‹ï¼š ä½¿ç”¨1. PaidComponentpublic class PaidComponent &#123; public PaidComponent() &#123; System.out.println(&quot;PaidComponent æ— å‚æ„é€ è¢«è°ƒç”¨&quot;); &#125;&#125; 2. PaidComponentFactoryBean@Componentpublic class PaidComponentFactoryBean implements FactoryBean&lt;PaidComponent&gt; &#123; @Override public PaidComponent getObject() throws Exception &#123; System.out.println(&quot;PaidComponentFactoryBean çš„ getObject æ–¹æ³•è¢«è°ƒç”¨&quot;); return new PaidComponent(); &#125; @Override public Class&lt;?&gt; getObjectType() &#123; return PaidComponent.class; &#125; &#125; 3 Testpublic class AnnotationConfigApplicationTest &#123; public static void main(String[] args) &#123; AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(); context.register(JavaConfig.class); context.refresh(); System.out.println(context.getBean(&quot;paidComponentFactoryBean&quot;)); System.out.println(context.getBean(&quot;&amp;paidComponentFactoryBean&quot;)); System.out.println(context.getBean(PaidComponent.class)); &#125;&#125; å¯ä»¥çœ‹å‡ºæ³¨å†Œäº†ä¸¤ä¸ª Beanï¼Œ ä¸€ä¸ªæ˜¯ paidComponentFactoryBean ï¼Œå¦ä¸€ä¸ªæ˜¯ &amp;paidComponentFactoryBeanã€‚ è€Œç›´æ¥è·å– paidComponentFactoryBean è·å–åˆ°çš„å…¶å®æ˜¯ FactoryBean çš„ getObject() æ–¹æ³•è¿”å›çš„ç±»å‹ã€‚ finishBeanFactoryInitialization æºç protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) &#123; // Initialize conversion service for this context. // åˆå§‹åŒ–ç±»å‹è½¬æ¢å™¨ if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp; beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123; beanFactory.setConversionService( beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)); &#125; // Register a default embedded value resolver if no bean post-processor // (such as a PropertyPlaceholderConfigurer bean) registered any before: // at this point, primarily for resolution in annotation attribute values. // ä¸»è¦ç”¨äºæ³¨é‡Šå±æ€§å€¼çš„è§£æ if (!beanFactory.hasEmbeddedValueResolver()) &#123; beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal)); &#125; // Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early. // å°½æ—©åˆå§‹åŒ– LoadTimeWeaverAware Beanï¼Œä»¥ä¾¿å°½æ—©æ³¨å†Œå…¶è½¬æ¢å™¨ã€‚ String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false); for (String weaverAwareName : weaverAwareNames) &#123; getBean(weaverAwareName); &#125; // Stop using the temporary ClassLoader for type matching. // åœæ­¢ä½¿ç”¨ä¸´æ—¶çš„ClassLoaderè¿›è¡Œç±»å‹åŒ¹é…ã€‚ beanFactory.setTempClassLoader(null); // Allow for caching all bean definition metadata, not expecting further changes. // è®¾ç½® beanDefinition å…ƒæ•°æ® ä¸å¯ä»¥å†ä¿®æ”¹ beanFactory.freezeConfiguration(); // Instantiate all remaining (non-lazy-init) singletons. // å®ä¾‹åŒ–å•ä¾‹ bean beanFactory.preInstantiateSingletons();&#125; è¿™é‡Œé‡ç‚¹å…³æ³¨æœ€åä¸€è¡Œ beanFactory.preInstantiateSingletons(); preInstantiateSingletonsè¿™å—è¿›å…¥çš„æ˜¯ç±» DefaultListableBeanFactory ç±»çš„æºç ã€‚ public void preInstantiateSingletons() throws BeansException &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Pre-instantiating singletons in &quot; + this); &#125; // Iterate over a copy to allow for init methods which in turn register new bean definitions. // While this may not be part of the regular factory bootstrap, it does otherwise work fine. // å°† beanDefinitionNames æ”¾åˆ°é›†åˆä¸­ List&lt;String&gt; beanNames = new ArrayList&lt;&gt;(this.beanDefinitionNames); // Trigger initialization of all non-lazy singleton beans... // éå† for (String beanName : beanNames) &#123; // è·å– bd ä¿¡æ¯, å› ä¸ºå¯èƒ½ å®šä¹‰äº† parentBeanDefinition RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName); // éæŠ½è±¡, å•ä¾‹, ä¸”ä¸æ˜¯æ‡’åŠ è½½ if (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123; // åˆ¤æ–­æ˜¯å¦ä¸º FactoryBean if (isFactoryBean(beanName)) &#123; // FactoryBean éœ€è¦æ·»åŠ å‰ç¼€ &amp; ,é€šè¿‡ getBean(&amp;beanName) è·å–çš„æ˜¯ FactoryBean æœ¬èº« Object bean = getBean(FACTORY_BEAN_PREFIX + beanName); if (bean instanceof FactoryBean) &#123; FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean; // åˆ¤æ–­æ˜¯å¦éœ€è¦åˆå§‹åŒ– boolean isEagerInit; if (System.getSecurityManager() != null &amp;&amp; factory instanceof SmartFactoryBean) &#123; isEagerInit = AccessController.doPrivileged( (PrivilegedAction&lt;Boolean&gt;) ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit, getAccessControlContext()); &#125; else &#123; isEagerInit = (factory instanceof SmartFactoryBean &amp;&amp; ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit()); &#125; // éœ€è¦åˆå§‹åŒ– if (isEagerInit) &#123; getBean(beanName); &#125; &#125; &#125; else &#123; getBean(beanName); &#125; &#125; &#125; // Trigger post-initialization callback for all applicable beans... // å¦‚æœ Bean å®ç°äº† SmartInitializingSingleton, // åœ¨è¿™é‡Œä¼šç»Ÿä¸€è°ƒç”¨ afterSingletonsInstantiated æ–¹æ³• for (String beanName : beanNames) &#123; Object singletonInstance = getSingleton(beanName); if (singletonInstance instanceof SmartInitializingSingleton) &#123; StartupStep smartInitialize = this.getApplicationStartup().start(&quot;spring.beans.smart-initialize&quot;) .tag(&quot;beanName&quot;, beanName); SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance; if (System.getSecurityManager() != null) &#123; AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123; smartSingleton.afterSingletonsInstantiated(); return null; &#125;, getAccessControlContext()); &#125; else &#123; smartSingleton.afterSingletonsInstantiated(); &#125; smartInitialize.end(); &#125; &#125;&#125; ä¸Šé¢æ–¹æ³•ä¸­é€šè¿‡å¾ªç¯ beanNames è¿›è¡Œåˆå§‹åŒ– Beanã€‚ å…¶ä¸­éœ€è¦åŒºåˆ« BeanFactory å’Œ æ™®é€š Beanã€‚ è¿™ä¹Ÿæ˜¯æˆ‘å¼€å§‹ä¸ºä»€ä¹ˆå…ˆä»‹ç»äº†ä»€ä¹ˆæ˜¯ BeanFactory ? ä¸‹é¢å°±éœ€è¦é‡ç‚¹å…³æ³¨ getBean(beanName) æ–¹æ³•ã€‚ getBeanpublic Object getBean(String name) throws BeansException &#123; return doGetBean(name, null, null, false);&#125; åœ¨ getBean æ–¹æ³•ä¸­è°ƒç”¨çš„æ˜¯ doGetBean æ–¹æ³•ã€‚ doGetBeandoGetBean æ–¹æ³•ä½œç”¨æ˜¯ï¼šè¿”å›ä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥æ˜¯æŒ‡å®šbeançš„å…±äº«æˆ–ç‹¬ç«‹çš„ã€‚ è¯¥æ–¹æ³•æ¥å—å››ä¸ªå‚æ•°ï¼š name â€“ è¦æ£€ç´¢çš„ bean çš„åç§°requiredType â€“ è¦æ£€ç´¢çš„ bean çš„å¿…éœ€ç±»å‹ï¼Œè¿™ä¸ªå¯ä»¥ä¸ºç©ºargs â€“ä½¿ç”¨æ˜¾å¼å‚æ•°åˆ›å»ºbeanå®ä¾‹æ—¶è¦ä½¿ç”¨çš„å‚æ•°ï¼ˆä»…åœ¨åˆ›å»ºæ–°å®ä¾‹è€Œä¸æ˜¯æ£€ç´¢ç°æœ‰å®ä¾‹æ—¶æ‰åº”ç”¨ï¼‰typeCheckOnly â€“æ˜¯å¦ä¸ºç±»å‹æ£€æŸ¥è€Œä¸æ˜¯å®é™…ä½¿ç”¨è·å–å®ä¾‹ protected &lt;T&gt; T doGetBean( String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException &#123; // å»æ‰å·¥å‚å¼•ç”¨çš„å‰ç¼€, åŒæ—¶è½¬æ¢åˆ«å String beanName = transformedBeanName(name); Object bean; // Eagerly check singleton cache for manually registered singletons. // ä»ç¼“å­˜ä¸­æ£€æŸ¥å•ä¾‹æ˜¯å¦å·²ç»å­˜åœ¨ Object sharedInstance = getSingleton(beanName); if (sharedInstance != null &amp;&amp; args == null) &#123; if (logger.isTraceEnabled()) &#123; if (isSingletonCurrentlyInCreation(beanName)) &#123; logger.trace(&quot;Returning eagerly cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;); &#125; else &#123; logger.trace(&quot;Returning cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; &#125; // ä»ç¼“å­˜ä¸­å¦‚æœè·å–åˆ°äº†, æ™®é€š Bean ç›´æ¥è¿”å›, FactoryBean åˆ™è¿”å› FactoryBean åˆ›å»ºçš„ Bean bean = getObjectForBeanInstance(sharedInstance, name, beanName, null); &#125; else &#123; // Fail if we&#x27;re already creating this bean instance: // We&#x27;re assumably within a circular reference. // è¿”å›æŒ‡å®šçš„ åŸå‹bean (prototype ç±»å‹çš„ Bean) æ˜¯å¦å½“å‰æ­£åœ¨åˆ›å»ºä¸­ï¼ˆåœ¨å½“å‰çº¿ç¨‹å†…ï¼‰ã€‚ if (isPrototypeCurrentlyInCreation(beanName)) &#123; throw new BeanCurrentlyInCreationException(beanName); &#125; // Check if bean definition exists in this factory. // æ£€æŸ¥ BeanFactory æ˜¯å¦å­˜åœ¨è¿™ä¸ª Bean çš„ BeanDefinition BeanFactory parentBeanFactory = getParentBeanFactory(); if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123; // Not found -&gt; check parent. // æ£€æŸ¥çˆ¶å®¹å™¨ä¸­æœ‰æ²¡æœ‰å®šä¹‰ String nameToLookup = originalBeanName(name); // è¿”å›ä»çˆ¶å®¹å™¨ä¸­æŸ¥è¯¢çš„ç»“æœ if (parentBeanFactory instanceof AbstractBeanFactory) &#123; return ((AbstractBeanFactory) parentBeanFactory).doGetBean( nameToLookup, requiredType, args, typeCheckOnly); &#125; else if (args != null) &#123; // Delegation to parent with explicit args. return (T) parentBeanFactory.getBean(nameToLookup, args); &#125; else if (requiredType != null) &#123; // No args -&gt; delegate to standard getBean method. return parentBeanFactory.getBean(nameToLookup, requiredType); &#125; else &#123; return (T) parentBeanFactory.getBean(nameToLookup); &#125; &#125; if (!typeCheckOnly) &#123; // å°†å½“å‰ beanName æ”¾å…¥ä¸€ä¸ª alreadyCreated çš„ Set é›†åˆä¸­ã€‚ // æ ‡è¯†æœ¬æ¬¡è°ƒç”¨æ–¹æ³•ï¼Œå¹¶éæ˜¯è¦è·å–beançš„ç±»å‹ï¼Œè€Œæ˜¯ä¸ºäº†åˆ›å»ºå®ä¾‹ï¼Œå°†beanNameå­˜åˆ°alreadyCreatedé›†åˆï¼Œä»£è¡¨è¯¥beanå·²ç»åˆ›å»ºäº†ï¼Œåé¢tryã€‚ã€‚catchæœ‰å¼‚å¸¸ä¼šæ¸…ç©ºè¯¥beanName markBeanAsCreated(beanName); &#125; StartupStep beanCreation = this.applicationStartup.start(&quot;spring.beans.instantiate&quot;) .tag(&quot;beanName&quot;, name); try &#123; if (requiredType != null) &#123; beanCreation.tag(&quot;beanType&quot;, requiredType::toString); &#125; // è·å– Bean çš„ BeanDefinition RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); checkMergedBeanDefinition(mbd, beanName, args); // Guarantee initialization of beans that the current bean depends on. // ç¡®ä¿ä¾èµ–çš„ Bean å·²ç»è¢«åˆå§‹åŒ–, æ¯”å¦‚ @DependsOn æ³¨è§£ String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) &#123; for (String dep : dependsOn) &#123; if (isDependent(beanName, dep)) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Circular depends-on relationship between &#x27;&quot; + beanName + &quot;&#x27; and &#x27;&quot; + dep + &quot;&#x27;&quot;); &#125; registerDependentBean(dep, beanName); try &#123; // åˆ›å»ºä¾èµ–çš„ Bean getBean(dep); &#125; catch (NoSuchBeanDefinitionException ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;&#x27;&quot; + beanName + &quot;&#x27; depends on missing bean &#x27;&quot; + dep + &quot;&#x27;&quot;, ex); &#125; &#125; &#125; // Create bean instance. if (mbd.isSingleton()) &#123; // å•ä¾‹ bean sharedInstance = getSingleton(beanName, () -&gt; &#123; try &#123; return createBean(beanName, mbd, args); &#125; catch (BeansException ex) &#123; // Explicitly remove instance from singleton cache: It might have been put there // eagerly by the creation process, to allow for circular reference resolution. // Also remove any beans that received a temporary reference to the bean. destroySingleton(beanName); throw ex; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); &#125; // åˆ›å»ºåŸå‹Bean else if (mbd.isPrototype()) &#123; // It&#x27;s a prototype -&gt; create a new instance. Object prototypeInstance = null; try &#123; beforePrototypeCreation(beanName); prototypeInstance = createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd); &#125; else &#123; // å§”æ‰˜ç»™å®ç°ç±»å¤„ç† String scopeName = mbd.getScope(); if (!StringUtils.hasLength(scopeName)) &#123; throw new IllegalStateException(&quot;No scope name defined for bean Â´&quot; + beanName + &quot;&#x27;&quot;); &#125; Scope scope = this.scopes.get(scopeName); if (scope == null) &#123; throw new IllegalStateException(&quot;No Scope registered for scope name &#x27;&quot; + scopeName + &quot;&#x27;&quot;); &#125; try &#123; Object scopedInstance = scope.get(beanName, () -&gt; &#123; beforePrototypeCreation(beanName); try &#123; return createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; &#125;); bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd); &#125; catch (IllegalStateException ex) &#123; throw new ScopeNotActiveException(beanName, scopeName, ex); &#125; &#125; &#125; catch (BeansException ex) &#123; beanCreation.tag(&quot;exception&quot;, ex.getClass().toString()); beanCreation.tag(&quot;message&quot;, String.valueOf(ex.getMessage())); cleanupAfterBeanCreationFailure(beanName); throw ex; &#125; finally &#123; beanCreation.end(); &#125; &#125; // Check if required type matches the type of the actual bean instance. // æ£€æŸ¥æ‰€éœ€çš„ç±»å‹æ˜¯å¦ä¸å®é™…beanå®ä¾‹çš„ç±»å‹åŒ¹é…ã€‚ if (requiredType != null &amp;&amp; !requiredType.isInstance(bean)) &#123; try &#123; T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType); if (convertedBean == null) &#123; throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass()); &#125; return convertedBean; &#125; catch (TypeMismatchException ex) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Failed to convert bean &#x27;&quot; + name + &quot;&#x27; to required type &#x27;&quot; + ClassUtils.getQualifiedName(requiredType) + &quot;&#x27;&quot;, ex); &#125; throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass()); &#125; &#125; return (T) bean;&#125; ä¸Šé¢ä»£ç æ¯”è¾ƒé•¿ï¼ŒåŸºæœ¬ä¸Šæ­¥éª¤å·²ç»æ·»åŠ ç›¸åº”çš„æ³¨é‡Šï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š ä»ç¼“å­˜ä¸­è·å–åˆ° Beanï¼Œåˆ›å»ºå¯¹åº”çš„ Beanï¼› æ²¡æœ‰ä»ç¼“å­˜ä¸­è·å–åˆ° Beanï¼Œåˆ›å»ºå¯¹åº”çš„ Beanï¼› æ£€æŸ¥æ‰€éœ€çš„ç±»å‹æ˜¯å¦ä¸å®é™…beanå®ä¾‹çš„ç±»å‹åŒ¹é…ã€‚ ä¸‹é¢ä»è¿™ä¸‰ä¸ªæ­¥éª¤åˆ†åˆ«ä»‹ç»ï¼š ä»ç¼“å­˜ä¸­è·å–åˆ° Beanï¼Œåˆ›å»ºå¯¹åº”çš„ Bean Object sharedInstance = getSingleton(beanName); public Object getSingleton(String beanName) &#123; return getSingleton(beanName, true);&#125;/** * è¿”å›ä»¥ç»™å®šåç§°æ³¨å†Œçš„ï¼ˆåŸå§‹ï¼‰å•ä¾‹å¯¹è±¡ã€‚ * * æ£€æŸ¥å·²ç»å®ä¾‹åŒ–çš„å•ä¾‹ï¼Œå¹¶å…è®¸æ—©æœŸå¼•ç”¨å½“å‰åˆ›å»ºçš„å•ä¾‹ï¼ˆè§£æå¾ªç¯å¼•ç”¨ï¼‰ */@Nullableprotected Object getSingleton(String beanName, boolean allowEarlyReference) &#123; // Quick check for existing instance without full singleton lock // private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256); // ç¼“å­˜äº† å•ä¾‹ Bean Object singletonObject = this.singletonObjects.get(beanName); // å¦‚æœæ²¡æœ‰è·å–åˆ°, å¹¶ä¸”å½“å‰ Bean æ­£åœ¨è¢«åˆ›å»ºä¸­ if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123; // private final Map&lt;String, Object&gt; earlySingletonObjects = new ConcurrentHashMap&lt;&gt;(16); // æ—©æœŸçš„å•ä¾‹å¯¹è±¡, å…ˆä» earlySingletonObjects ä¸­è·å– singletonObject = this.earlySingletonObjects.get(beanName); // æ²¡æœ‰ä» earlySingletonObjects ç¼“å­˜ä¸­è·å–åˆ° if (singletonObject == null &amp;&amp; allowEarlyReference) &#123; synchronized (this.singletonObjects) &#123; // Consistent creation of early reference within full singleton lock // å†æ¬¡è·å–å¹¶æ£€æŸ¥ singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) &#123; singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null) &#123; // private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16); // ä» singletonFactories ç¼“å­˜ä¸­è·å– ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); if (singletonFactory != null) &#123; singletonObject = singletonFactory.getObject(); // æ·»åŠ åˆ° earlySingletonObjects ç¼“å­˜ä¸­ this.earlySingletonObjects.put(beanName, singletonObject); // ä» singletonFactories ç¼“å­˜ä¸­åˆ é™¤ this.singletonFactories.remove(beanName); &#125; &#125; &#125; &#125; &#125; &#125; return singletonObject;&#125; è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œè·å–ä¸€ä¸ª Bean ï¼š å…ˆä» singletonObjects ä¸­è·å– Beanï¼› è·å–ä¸åˆ°ï¼Œä» earlySingletonObjects ä¸­è·å– Beanï¼› è·å–ä¸åˆ°ï¼Œä» singletonFactories ä¸­è·å– Beanã€‚ å½“ç„¶è¿™ä¸€å—æ¶‰åŠåˆ°å¾ªç¯å¼•ç”¨ï¼Œç¯‡å¹…æœ‰é™ï¼Œåé¢ä¼šä¸“é—¨ä»‹ç»å¾ªç¯å¼•ç”¨ã€‚ æ²¡æœ‰ä»ç¼“å­˜ä¸­è·å–åˆ° Beanï¼Œåˆ›å»ºå¯¹åº”çš„ Bean // Create bean instance.if (mbd.isSingleton()) &#123; // å•ä¾‹ bean sharedInstance = getSingleton(beanName, () -&gt; &#123; try &#123; return createBean(beanName, mbd, args); &#125; catch (BeansException ex) &#123; // Explicitly remove instance from singleton cache: It might have been put there // eagerly by the creation process, to allow for circular reference resolution. // Also remove any beans that received a temporary reference to the bean. destroySingleton(beanName); throw ex; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);&#125; else if (mbd.isPrototype()) &#123; // åˆ›å»ºåŸå‹Bean &#125; else &#123; // å§”æ‰˜ç»™å®ç°ç±»å¤„ç† String scopeName = mbd.getScope();&#125; æ£€æŸ¥æ‰€éœ€çš„ç±»å‹æ˜¯å¦ä¸å®é™…beanå®ä¾‹çš„ç±»å‹åŒ¹é… æ€»ç»“è¿™é‡Œä¸»è¦ä»‹ç»äº† Bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œä¸»è¦æ˜¯å¯¹æ•´ä¸ªè¿‡ç¨‹æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£å’Œç†Ÿæ‚‰ï¼Œé’ˆå¯¹è¿‡ç¨‹ç”»å›¾å¦‚ä¸‹ï¼š å…¶ä¸­ Bean çš„å®ä¾‹åŒ–ä¸»è¦å…³æ³¨å•ä¾‹ Bean çš„å®ä¾‹åŒ–ï¼Œåé¢å‡†å¤‡å¯¹å…¶è¿›è¡Œè¯¦ç»†ç ”ç©¶åï¼Œå†è¿›è¡Œè¯´æ˜ã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  14ï¼šinitApplicationEventMulticaster Spring æºç å­¦ä¹  13ï¼šinitMessageSource Spring æºç å­¦ä¹  12ï¼šregisterBeanPostProcessors","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  14ï¼šinitApplicationEventMulticaster ã€onRefresh å’Œ registerListeners","slug":"source-code/spring/14-Spring initApplicationEventMulticaster","date":"2021-01-05T13:40:00.000Z","updated":"2021-01-05T13:40:51.243Z","comments":true,"path":"2021/01/05/source-spring-14.html","link":"","permalink":"https://liuzhihang.com/2021/01/05/source-spring-14.html","excerpt":"","text":"å‰è¨€ä¸Šä¸€ç¯‡ä»‹ç»äº†å›½é™…åŒ–çš„ä½¿ç”¨ä»¥åŠåˆå§‹åŒ–æ¶ˆæ¯æºçš„æºç ï¼Œæ¥ä¸‹æ¥æ¥ç€å¾€ä¸‹é˜…è¯»ï¼Œå°†è¿›å…¥ initApplicationEventMulticaster ã€onRefresh å’Œ registerListeners çš„ç›¸å…³æ“ä½œé€»è¾‘ã€‚ è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨ä»¥åŠæ³¨å†Œç›‘å¬å™¨ã€‚è€Œ onRefresh éƒ¨åˆ†åˆ™éœ€è¦å­ç±»å»å®ç°ã€‚ æ‰€ä»¥æœ¬æ–‡ä¸»è¦ä»‹ç»ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š ä»€ä¹ˆæ˜¯ Spring äº‹ä»¶ï¼Ÿ ç›‘å¬å™¨æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Ÿ ä»€ä¹ˆæ˜¯ Spring äº‹ä»¶ï¼Ÿ è¿™å—çš„ä»‹ç»åœ¨å®˜ç½‘ 1.15.2. Standard and Custom Events éƒ¨åˆ†æœ‰ä»‹ç»ã€‚ Spring é€šè¿‡ ApplicationEvent ç±»å’Œ ApplicationListener æ¥å£æä¾› ApplicationContext ä¸­çš„äº‹ä»¶å¤„ç†ã€‚å¦‚æœå°†å®ç° ApplicationListener æ¥å£çš„ bean éƒ¨ç½²åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œåˆ™æ¯æ¬¡å°† ApplicationEvent å‘å¸ƒåˆ° ApplicationContext æ—¶ï¼Œéƒ½ä¼šé€šçŸ¥è¯¥ beanã€‚æœ¬è´¨ä¸Šï¼Œè¿™æ˜¯æ ‡å‡†çš„è§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼ã€‚ å½’çº³ä¸‹æ¥ä¸»è¦å°±æ˜¯ä¸‰ä¸ªéƒ¨åˆ†: äº‹ä»¶ã€äº‹ä»¶å‘å¸ƒè€…ã€äº‹ä»¶ç›‘å¬å™¨ã€‚ äº‹ä»¶ï¼šApplicationEventï¼Œè¦è‡ªå®šä¹‰äº‹ä»¶ï¼Œåˆ™éœ€è¦åˆ›å»ºä¸€ä¸ªç±»ç»§æ‰¿ ApplicationEventã€‚ äº‹ä»¶å‘å¸ƒè€…ï¼šApplicationEventPublisher å’Œ ApplicationEventMulticasterï¼Œå› ä¸º ApplicationContext å®ç°äº† ApplicationEventPublisherï¼Œæ‰€ä»¥äº‹ä»¶å‘å¸ƒå¯ä»¥ç›´æ¥ä½¿ç”¨ ApplicationContextã€‚ äº‹ä»¶ç›‘å¬å™¨ï¼šApplicationListenerï¼Œé€šè¿‡åˆ›å»ºä¸€ä¸ªå®ç°äº† ApplicationListener å¹¶æ³¨å†Œä¸º Spring bean çš„ç±»æ¥æ¥æ”¶æ¶ˆæ¯ã€‚ Spring ä¹Ÿæä¾›äº†ä¹Ÿæœ‰ä¸€äº›å†…ç½®çš„ç›‘å¬å™¨ï¼Œå¯ä»¥åœ¨å®˜ç½‘æŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸åšä»‹ç»äº†ã€‚ ä½¿ç”¨ç›‘å¬å™¨ç®€å•æ¥è¯´ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š æ³¨å†Œäº‹ä»¶ æ³¨å†Œç›‘å¬å™¨ å‘å¸ƒäº‹ä»¶ åœ¨æ¥å£è°ƒç”¨å‘å¸ƒäº‹ä»¶æ—¶ï¼Œç›‘å¬å™¨å°±ä¼šåšå‡ºç›¸åº”çš„æ“ä½œã€‚ 1. æ³¨å†Œäº‹ä»¶åˆ›å»º MyApplicationEvent ç±»å¹¶ç»§æ‰¿ ApplicationEvent public class MyApplicationEvent extends ApplicationEvent &#123; private static final long serialVersionUID = 5366526231219883438L; private String message; /** * Create a new &#123;@code ApplicationEvent&#125;. * * @param source the object on which the event initially occurred or with * which the event is associated (never &#123;@code null&#125;) */ public MyApplicationEvent(Object source, String message) &#123; super(source); this.message = message; &#125; public String getMessage() &#123; return message; &#125;&#125; 2. æ³¨å†Œç›‘å¬å™¨@Componentpublic class MyApplicationListener implements ApplicationListener&lt;MyApplicationEvent&gt; &#123; @Override public void onApplicationEvent(MyApplicationEvent event) &#123; System.out.println(&quot;MyApplicationListener æ”¶åˆ°æ¶ˆæ¯: &quot; + event.getMessage()); &#125;&#125; å½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£ @EventListener çš„æ–¹å¼æ¥ä½¿ç”¨ã€‚ @Componentpublic class MyAnnotationApplicationListener &#123; @EventListener(classes = MyApplicationEvent.class) public void myApplicationEventListener(MyApplicationEvent event) &#123; System.out.println(&quot;ä½¿ç”¨æ³¨è§£çš„æ–¹å¼, æ”¶åˆ°äº‹ä»¶: &quot; + event.getMessage()); &#125;&#125; 3. ä½¿ç”¨å› ä¸º AnnotationConfigApplicationContext å®ç°äº† ApplicationContext ï¼Œ è€Œ ApplicationContext å®ç°äº† ApplicationEventPublisherï¼Œæ‰€ä»¥è¿™å—ä¼ å…¥å½“å‰ context æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ public class AnnotationConfigApplicationTest &#123; public static void main(String[] args) &#123; AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(); context.register(JavaConfig.class); context.refresh(); MyApplicationEvent myApplicationEvent = new MyApplicationEvent(context, &quot;å‘¼å«åœŸè±†,å‘¼å«åœŸè±†!&quot;); context.publishEvent(myApplicationEvent); &#125;&#125; æ—¥å¿—è¾“å‡ºï¼š æºç éƒ¨åˆ†initApplicationEventMulticasterè¿™å—å’Œä¸Šé¢åˆå§‹åŒ–æ¶ˆæ¯æºç±»ä¼¼ï¼Œéƒ½æ˜¯æŸ¥æ‰¾æŒ‡å®šåç§°çš„ Bean ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™è‡ªå·±ä½¿ç”¨é»˜è®¤çš„ã€‚ protected void initApplicationEventMulticaster() &#123; ConfigurableListableBeanFactory beanFactory = getBeanFactory(); // æ˜¯å¦åŒ…å« applicationEventMulticaster Bean if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123; this.applicationEventMulticaster = beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Using ApplicationEventMulticaster [&quot; + this.applicationEventMulticaster + &quot;]&quot;); &#125; &#125; else &#123; // ä½¿ç”¨ SimpleApplicationEventMulticaster åˆ›å»ºä¸€ä¸ª äº‹ä»¶å‘å¸ƒå™¨ SimpleApplicationEventMulticaster simpleApplicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory); simpleApplicationEventMulticaster.setApplicationStartup(getApplicationStartup()); this.applicationEventMulticaster = simpleApplicationEventMulticaster; beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, this.applicationEventMulticaster); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;No &#x27;&quot; + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + &quot;&#x27; bean, using &quot; + &quot;[&quot; + this.applicationEventMulticaster.getClass().getSimpleName() + &quot;]&quot;); &#125; &#125;&#125; onRefreshè¿™å—éœ€è¦å­ç±»å»å®ç°ï¼Œæˆ‘è¿™é‡Œé€šè¿‡æ–­ç”µï¼Œæš‚æ—¶æ²¡æœ‰è¿›å»ã€‚æ‰€ä»¥å°±ä¸ä»‹ç»äº†ã€‚ registerListenersprotected void registerListeners() &#123; // æ·»åŠ å®ç°ApplicationListenerä½œä¸ºä¾¦å¬å™¨çš„beanã€‚ // ä¸ä¼šå½±å“å…¶ä»–ä¾¦å¬å™¨ï¼Œå¯ä»¥å°†å®ƒä»¬æ·»åŠ ä¸ºébeanã€‚ // Register statically specified listeners first. // å…ˆæ³¨å†Œé™æ€æŒ‡å®šçš„ç›‘å¬å™¨ for (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123; getApplicationEventMulticaster().addApplicationListener(listener); &#125; // Do not initialize FactoryBeans here: We need to leave all regular beans // uninitialized to let post-processors apply to them! // åªæ˜¯æ·»åŠ  å¹¶æ²¡æœ‰æ‰§è¡Œ String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false); for (String listenerBeanName : listenerBeanNames) &#123; getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName); &#125; // Publish early application events now that we finally have a multicaster... // å‘å¸ƒæ—©æœŸçš„æ—¶é—´,å¹¶ä¸”å°† earlyApplicationEvents è®¾ç½®ä¸ºç©º Set&lt;ApplicationEvent&gt; earlyEventsToProcess = this.earlyApplicationEvents; this.earlyApplicationEvents = null; if (!CollectionUtils.isEmpty(earlyEventsToProcess)) &#123; for (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123; getApplicationEventMulticaster().multicastEvent(earlyEvent); &#125; &#125;&#125; æ€»ç»“è¿™ç¯‡æ–‡ç« ä¸»è¦å†…å®¹æ˜¯ä»‹ç» Spring äº‹ä»¶çš„ä½¿ç”¨ï¼ŒåŒæ—¶ç®€å•ä»‹ç»äº† initApplicationEventMulticaster ã€onRefresh å’Œ registerListeners éƒ¨åˆ†çš„æºç ã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  13ï¼šinitMessageSource Spring æºç å­¦ä¹  12ï¼šregisterBeanPostProcessors Spring æºç å­¦ä¹  11ï¼šinvokeBeanFactoryPostProcessors","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  13ï¼šinitMessageSource","slug":"source-code/spring/13-Spring initMessageSource","date":"2021-01-02T09:40:00.000Z","updated":"2021-01-02T09:42:22.126Z","comments":true,"path":"2021/01/02/source-spring-13.html","link":"","permalink":"https://liuzhihang.com/2021/01/02/source-spring-13.html","excerpt":"","text":"å‰è¨€åœ¨é˜…è¯»å®Œ registerBeanPostProcessors æºç ä¹‹åï¼Œ ä¸‹ä¸€æ­¥å°±è¿›å…¥åˆ° initMessageSourceï¼Œè¿™ä¸€æ­¥ä¸»è¦ä½œç”¨æ˜¯åˆå§‹åŒ–å›½é™…åŒ–æ–‡ä»¶ã€‚ ä¾ç„¶å¦‚ä¹‹å‰æ‰€ç¤ºï¼Œå…ˆé€šè¿‡å®˜ç½‘äº†è§£åˆ°å›½é™…åŒ–çš„ç”¨æ³•ï¼Œç„¶åå†å¯¹æºç è¿›è¡Œç ”ç©¶ã€‚ MessageSource å›½é™…åŒ– å¦‚å®˜ç½‘1.15.1. Internationalization using MessageSourceæ‰€ç¤ºï¼Œä¸»è¦ä½œç”¨å°±æ˜¯ä½¿ç”¨å›½é™…åŒ–ï¼Œå®šåˆ¶ä¸åŒçš„æ¶ˆæ¯ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ MessageSource å®šä¹‰çš„ Bean åå­—å¿…é¡»ä¸º messageSourceï¼Œ è€Œå¦‚æœæ‰¾ä¸åˆ°åˆ™ä¼šé»˜è®¤æ³¨å†Œ DelegatingMessageSource ä½œä¸º messageSource çš„ Beanã€‚ ä½¿ç”¨1. åˆ›å»ºå›½é™…åŒ–æ–‡ä»¶ 2. å£°æ˜ MessageSourceåœ¨ JavaConfig ä¸­ å£°æ˜ MessageSource ï¼Œ è®°å¾—åå­—ä¸€å®šè¦å«åš messageSource ï¼ @Configuration@ComponentScan(&quot;com.liuzhihang&quot;)public class JavaConfig &#123; @Bean(name = &quot;messageSource&quot;) public MessageSource getMessageSource() &#123; ResourceBundleMessageSource messageSource = new ResourceBundleMessageSource(); messageSource.setDefaultEncoding(&quot;UTF-8&quot;); messageSource.addBasenames(&quot;message&quot;, &quot;message_en&quot;); return messageSource; &#125;&#125; 3. æµ‹è¯•ç»“æœpublic class AnnotationConfigApplicationTest &#123; public static void main(String[] args) &#123; AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(); context.register(JavaConfig.class); context.refresh(); MessageSource messageSource = context.getBean(MessageSource.class); String zhMessage = messageSource.getMessage(&quot;user.name&quot;, null, null, Locale.CHINA); String enMessage = messageSource.getMessage(&quot;user.name&quot;, null, null, Locale.ENGLISH); System.out.println(&quot;zhMessage = &quot; + zhMessage); System.out.println(&quot;enMessage = &quot; + enMessage); &#125;&#125; å¦‚ä¸Šæ‰€ç¤ºï¼Œæ‰§è¡Œä¹‹åè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š çŸ¥é“äº†å›½é™…åŒ–æ˜¯å¦‚ä½•ä½¿ç”¨çš„ä¹‹åï¼Œå†æƒ³ä¸€æƒ³è¿™ä¸€æ­¥æºç ï¼Œå°±çŸ¥é“æ˜¯ä»€ä¹ˆä½œç”¨äº†å§ï¼ initMessageSource æºç protected void initMessageSource() &#123; ConfigurableListableBeanFactory beanFactory = getBeanFactory(); // Bean çš„åç§°å¿…é¡»è¦æ˜¯ messageSource if (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123; this.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class); // Make MessageSource aware of parent MessageSource. if (this.parent != null &amp;&amp; this.messageSource instanceof HierarchicalMessageSource) &#123; HierarchicalMessageSource hms = (HierarchicalMessageSource) this.messageSource; if (hms.getParentMessageSource() == null) &#123; // Only set parent context as parent MessageSource if no parent MessageSource // registered already. hms.setParentMessageSource(getInternalParentMessageSource()); &#125; &#125; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Using MessageSource [&quot; + this.messageSource + &quot;]&quot;); &#125; &#125; else &#123; // Use empty MessageSource to be able to accept getMessage calls. // å¦åˆ™åˆ™ä½¿ç”¨é»˜è®¤çš„ DelegatingMessageSource dms = new DelegatingMessageSource(); dms.setParentMessageSource(getInternalParentMessageSource()); this.messageSource = dms; beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, this.messageSource); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;No &#x27;&quot; + MESSAGE_SOURCE_BEAN_NAME + &quot;&#x27; bean, using [&quot; + this.messageSource + &quot;]&quot;); &#125; &#125;&#125; è¿™å—æºç å”¯ä¸€å€¼å¾—å…³æ³¨çš„åœ°æ–¹å°±æ˜¯ï¼ŒBean çš„åç§°å¿…é¡»è¦æ˜¯ messageSource ã€‚ æ€»ç»“æœ¬æ–‡é€šè¿‡å®˜ç½‘ï¼Œäº†è§£åˆ°ä»€ä¹ˆæ˜¯å›½é™…åŒ–ï¼Œä»¥åŠå›½é™…åŒ–çš„ä½¿ç”¨ï¼Œå¹¶ç»“åˆä»£ç å’Œæºç ï¼ŒçŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚ å½“ç„¶æœ¬æ–‡éœ€è¦æ³¨æ„çš„åœ°æ–¹å°±æ˜¯å›½é™…åŒ– MessageSource çš„ Bean åç§°è¦å¿…é¡»ä¸º messageSourceã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  12ï¼šregisterBeanPostProcessors Spring æºç å­¦ä¹  11ï¼šinvokeBeanFactoryPostProcessors Spring æºç å­¦ä¹  10ï¼šprepareBeanFactory å’Œ postProcessBeanFactory","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  12ï¼šregisterBeanPostProcessors","slug":"source-code/spring/12-Spring registerBeanPostProcessors","date":"2021-01-01T12:50:00.000Z","updated":"2021-01-01T13:07:42.249Z","comments":true,"path":"2021/01/01/source-spring-12.html","link":"","permalink":"https://liuzhihang.com/2021/01/01/source-spring-12.html","excerpt":"","text":"å‰è¨€å‰é¢é€šè¿‡ invokeBeanFactoryPostProcessors è¿™ä¸€æ­¥äº†è§£åˆ°äº†ä»€ä¹ˆæ˜¯ BeanFactoryPostProcessor ï¼Œä»¥åŠ BeanFactoryPostProcessor çš„ä½¿ç”¨åŠä½œç”¨ï¼Œå¹¶é€šè¿‡ invokeBeanFactoryPostProcessors è¿™ä¸€æ­¥æºç ï¼Œå¯¹ BeanFactoryPostProcessor çš„åŠ è½½æµç¨‹æœ‰äº†è¿›ä¸€æ­¥äº†è§£ã€‚ ç°åœ¨å°±ä¸€èµ·è¿›å…¥ä¸‹ä¸€ä¸ªç¯èŠ‚ï¼š registerBeanPostProcessors(beanFactory); è¿™ä¸€æ­¥ä¸»è¦çš„ä½œç”¨æ˜¯åŠ è½½ BeanPostProcessorï¼Œä»åå­—ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåªæ˜¯åŠ è½½ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œã€‚ ä¸è¿‡ï¼Œåœ¨è¿›å…¥æºç ä¹‹å‰ï¼Œä¾ç„¶æ˜¯ç»“åˆå®˜ç½‘ï¼Œå…ˆäº†è§£ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š ä»€ä¹ˆæ˜¯ BeanPostProcessorï¼Ÿ BeanPostProcessor æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Ÿ BeanPostProcessor æœ‰ä»€ä¹ˆç”¨ï¼Ÿ ä»€ä¹ˆæ˜¯ BeanPostProcessor ï¼Ÿ å¦‚æˆªå›¾æ‰€ç¤ºï¼Œåœ¨å®˜ç½‘ 1.8.1 Customizing Beans by Using a BeanPostProcessor ä¸­ä»‹ç»ï¼Œ BeanPostProcessor æ¥å£å®šä¹‰å›è°ƒæ–¹æ³•ï¼Œå¯ä»¥å®ç°è¿™äº›æ–¹æ³•ï¼Œä»è€Œåœ¨ Bean å®ä¾‹åŒ–æœŸé—´ä¿®æ”¹ Bean çš„å±æ€§ã€‚ BeanPostProcessor æ˜¯å¦‚ä½•ä½¿ç”¨çš„?@Componentpublic class MyBeanPostProcessor implements BeanPostProcessor &#123; @Override public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123; if (bean instanceof UserComponent) &#123; System.out.println(&quot;BeanPostProcessor å¼€å§‹æ‰§è¡Œ åˆå§‹åŒ–å‰...&quot; + beanName); UserComponent userComponent = (UserComponent) bean; userComponent.setUserName(&quot;liuzhihang-postProcessBeforeInitialization&quot;); return userComponent; &#125; return bean; &#125; @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; if (bean instanceof UserComponent) &#123; System.out.println(&quot;BeanPostProcessor å¼€å§‹æ‰§è¡Œ åˆå§‹åŒ–å...&quot; + beanName); UserComponent userComponent = (UserComponent) bean; userComponent.setUserName(&quot;liuzhihang-postProcessAfterInitialization&quot;); return userComponent; &#125; return bean; &#125;&#125; å¦‚ä»£ç æ‰€ç¤ºï¼Œåªéœ€è¦å£°æ˜ä¸€ä¸ªè‡ªå·±çš„ MyBeanPostProcessor æ¥å®ç° BeanPostProcessor å¹¶é‡å†™å…¶æ–¹æ³•ï¼š postProcessBeforeInitialization ï¼šåœ¨ Bean å®ä¾‹åè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ä¹‹å‰è¿›è¡Œå¤„ç†ã€‚ postProcessAfterInitialization ï¼šåœ¨ Bean å®ä¾‹åŒ–åè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ä¹‹åè¿›è¡Œå¤„ç†ã€‚ å¹¶ä¸”åœ¨æµ‹è¯•æ—¶å¯ä»¥å‘ç°ï¼ŒBeanPostProcessor ä¿®æ”¹çš„å±æ€§ä¼šè¦†ç›– BeanFactoryPostProcessorï¼Œè‡³äºåŸå› å¯ä»¥é˜…è¯»ä¸‹ Spring æºç å­¦ä¹  11ï¼šinvokeBeanFactoryPostProcessors è¿™ç¯‡æ–‡ç« ï¼Œç›¸ä¿¡å¯¹ BeanFactoryPostProcessor æœ‰äº†ä¸€å®šçš„äº†è§£ä¹‹åï¼Œä¸€å®šä¼šæœ‰è‡ªå·±çš„ç­”æ¡ˆã€‚ å½“ç„¶æˆ‘ä¸ªäººçš„ç†è§£å°±æ˜¯ BeanFactoryPostProcessor æ˜¯åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ˜¯é€šè¿‡ä¿®æ”¹å…ƒæ•°æ®ä»è€Œä¿®æ”¹çš„ Bean çš„å…ƒç´ ä¿¡æ¯ã€‚ è¿™å—ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç è¿›è¡ŒéªŒè¯ã€‚ å¯ä»¥çœ‹å‡ºï¼Œæ‰§è¡Œé¡ºåºæ˜¯ BeanFactoryPostProcessor#postProcessBeanFactory-&gt;BeanPostProcessor#postProcessBeforeInitialization-&gt;BeanPostProcessor#postProcessAfterInitialization æ‰€ä»¥ï¼Œåé¢ä¿®æ”¹çš„å±æ€§ï¼Œä¼šè¦†ç›–ä¹‹å‰ä¿®æ”¹çš„å±æ€§ã€‚ è‡³äº BeanPostProcessor æ˜¯å¦‚ä½•ä¿®æ”¹å±æ€§çš„ï¼Œåœ¨è¿™é‡Œå…ˆä¸åšä»‹ç»ï¼Œç»§ç»­è¿›å…¥æœ¬èŠ‚çš„ä¸»è§’ registerBeanPostProcessors æºç åˆ†æ registerBeanPostProcessors æºç åœ¨ Spring refresh æ–¹æ³•ä¸­ï¼Œæ‰§è¡Œ registerBeanPostProcessors ä¸»è¦ä½œç”¨æ˜¯å°† BeanPostProcessor æ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œæºç å¦‚ä¸‹: protected void registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123; PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this);&#125; è¿™é‡Œè°ƒç”¨äº† PostProcessorRegistrationDelegate ç±»çš„é™æ€æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›ï¼š public static void registerBeanPostProcessors( ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) &#123; // æŸ¥æ‰¾ BeanPostProcessor ç±»å‹çš„ Bean çš„åç§°é›†åˆ, å°±æ˜¯è·å–æ‰€æœ‰ç»§æ‰¿äº† BeanPostProcessor çš„ç±» String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false); // Register BeanPostProcessorChecker that logs an info message when // a bean is created during BeanPostProcessor instantiation, i.e. when // a bean is not eligible for getting processed by all BeanPostProcessors. // æ³¨å†Œä¸€ä¸ª BeanPostProcessorCheckerï¼Œç”¨æ¥è®°å½• bean åœ¨ BeanPostProcessor å®ä¾‹åŒ–æ—¶çš„ä¿¡æ¯ã€‚ int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length; beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount)); // Separate between BeanPostProcessors that implement PriorityOrdered, // Ordered, and the rest. // å››ä¸ªé›†åˆ åŒºåˆ†å®ç°ä¸åŒæ¥å£çš„ BeanPostProcessors List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;&gt;(); List&lt;BeanPostProcessor&gt; internalPostProcessors = new ArrayList&lt;&gt;(); List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;&gt;(); List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;&gt;(); for (String ppName : postProcessorNames) &#123; if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); priorityOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; orderedPostProcessorNames.add(ppName); &#125; else &#123; nonOrderedPostProcessorNames.add(ppName); &#125; &#125; // First, register the BeanPostProcessors that implement PriorityOrdered. // æ’åºåæ‰§è¡Œ å®ç° PriorityOrdered çš„ BeanPostProcessors sortPostProcessors(priorityOrderedPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors); // Next, register the BeanPostProcessors that implement Ordered. List&lt;BeanPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;&gt;(orderedPostProcessorNames.size()); for (String ppName : orderedPostProcessorNames) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); orderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; sortPostProcessors(orderedPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, orderedPostProcessors); // Now, register all regular BeanPostProcessors. List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size()); for (String ppName : nonOrderedPostProcessorNames) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); nonOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors); // Finally, re-register all internal BeanPostProcessors. sortPostProcessors(internalPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, internalPostProcessors); // Re-register post-processor for detecting inner beans as ApplicationListeners, // moving it to the end of the processor chain (for picking up proxies etc). beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext));&#125; ä»£ç ä¸­æ·»åŠ äº†ç›¸åº”çš„æ³¨é‡Šï¼Œç›¸ä¿¡è¯»è¿‡ä¸Šä¸€ç¯‡æ–‡ç« ï¼ˆinvokeBeanFactoryPostProcessors æºç ï¼‰çš„å°ä¼™ä¼´ï¼Œä¸€å®šä¼šæ„Ÿè§‰éå¸¸ç†Ÿæ‚‰ï¼Œè¿™ä¸ªæ–¹æ³•çš„é€»è¾‘å’Œä¸Šé¢åŸºæœ¬ä¸€è‡´ï¼Œéƒ½æ˜¯å£°æ˜é›†åˆï¼Œæ’åºï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ã€‚ ä¸è¿‡è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š registerBeanPostProcessors è¿™ä¸€æ­¥ä»…ä»…å°† BeanPostProcessor æ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œï¼ï¼ï¼ æ€»ç»“æœ¬æ–‡æºç éƒ¨åˆ†ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œä¸»è¦èŠ±è´¹éƒ¨åˆ†ç¯‡å¹…ä»‹ç»ä»€ä¹ˆæ˜¯ BeanPostProcessor ä»¥åŠ BeanPostProcessor çš„ä½¿ç”¨æ–¹æ³•ã€‚ ä¸€å¥è¯æ€»ç»“è¿™ä¸€æ­¥å°±æ˜¯ï¼šæ³¨å†Œ BeanPostProcessor åˆ° BeanFactory ä¸­ï¼Œä½†æ˜¯æ²¡æœ‰æ‰§è¡Œã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  11ï¼šinvokeBeanFactoryPostProcessors Spring æºç å­¦ä¹  10ï¼šprepareBeanFactory å’Œ postProcessBeanFactory Spring æºç å­¦ä¹  09ï¼šrefresh å¤§æ¦‚æµç¨‹","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  11ï¼šinvokeBeanFactoryPostProcessors","slug":"source-code/spring/11-Spring invokeBeanFactoryPostProcessors","date":"2020-12-28T00:00:00.000Z","updated":"2021-01-01T12:51:45.460Z","comments":true,"path":"2020/12/28/source-spring-11.html","link":"","permalink":"https://liuzhihang.com/2020/12/28/source-spring-11.html","excerpt":"","text":"å‰è¨€invokeBeanFactoryPostProcessors ä¼šæ‰§è¡Œ BeanFactory çš„åç½®å¤„ç†å™¨ã€‚çœ‹åˆ°è¿™é‡Œä¼šæœ‰ç–‘é—®ï¼š ä»€ä¹ˆæ˜¯ BeanFactoryPostProcessor ï¼Ÿ BeanfactoryPostProcessor è¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿ çŸ¥é“äº†ä¸Šé¢ä¸¤ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œå¯¹ BeanFactoryPostProcessor æœ‰äº†äº†è§£ä¹‹åï¼Œç„¶åå†æ·±å…¥æºç ï¼Œç»§ç»­é˜…è¯» invokeBeanFactoryPostProcessors è¿™ä¸ªæ–¹æ³•ã€‚ ä½œç”¨èµ„æ–™è¿˜æ˜¯åœ¨å®˜ç½‘å¯ä»¥æ‰¾åˆ°ç­”æ¡ˆ: é˜…è¯»äº†ä¸€ä¸‹ï¼Œå¤§æ¦‚æ„æ€æ˜¯ Spring IoC å®¹å™¨å…è®¸ BeanFactoryPostProcessor è¯»å–é…ç½®å…ƒæ•°æ®ï¼Œå¹¶æœ‰å¯èƒ½åœ¨å®¹å™¨å®ä¾‹åŒ–é™¤ BeanFactoryPostProcessor å®ä¾‹ä»¥å¤–çš„ä»»ä½• bean ä¹‹å‰æ›´æ”¹å®ƒã€‚ åŒæ ·å¯ä»¥ä½¿ç”¨ Ordered æ¥å£å¯¹ BeanFactoryPostProcessor è¿›è¡Œæ’åºã€‚ æ³¨æ„ BeanFactoryPostProcessor æ“ä½œçš„æ˜¯ BeanDefinition ï¼Œå³å…ƒæ•°æ®ã€‚ä½†æ˜¯åŒæ ·å¯ä»¥é€šè¿‡è·å–åˆ° BeanFactory è¿›è¡Œå®ä¾‹åŒ– Beanï¼Œä½†æ˜¯å®˜ç½‘å¾ˆä¸å»ºè®®è¿™æ ·ä½¿ç”¨ã€‚ ç¤ºä¾‹ä½¿ç”¨ BeanFactoryPostProcessor@Componentpublic class MyBeanFactoryPostProcessor implements BeanFactoryPostProcessor &#123; @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123; // ä¿®æ”¹ BeanDefinition ä¿¡æ¯ BeanDefinition userComponentBeanDefinition = beanFactory.getBeanDefinition(&quot;userComponent&quot;); userComponentBeanDefinition.setLazyInit(true); // ä¿®æ”¹ Bean çš„ä¿¡æ¯ // xxx éå¸¸ä¸æ¨è beanFactory.getBean è¿‡æ—©çš„å®ä¾‹åŒ– Bean UserComponent bean = beanFactory.getBean(UserComponent.class); bean.setUserName(&quot;liuzhihang-01&quot;); &#125;&#125; åˆ›å»ºè‡ªå·±çš„ BeanFactoryPostProcessor å¹¶å®ç° BeanFactoryPostProcessor æ¥å£ï¼Œæ·»åŠ æ³¨è§£å³å¯ã€‚ å½“ç„¶é™¤äº†å®ç° BeanFactoryPostProcessor æ¥å£ï¼Œè¿˜æœ‰å…¶ä»–æ¥å£å¯ä»¥å®ç°ï¼š ä½¿ç”¨ BeanDefinitionRegistryPostProcessorBeanDefinitionRegistryPostProcessor ç»§æ‰¿äº† BeanFactoryPostProcessorï¼ŒåŒæ—¶æ‰©å±•äº†å¢åŠ äº† postProcessBeanDefinitionRegistry æ–¹æ³•ã€‚å¯ä»¥æ”¯æŒåœ¨ BeanDefinition æ³¨å†Œä¹‹å Bean å®ä¾‹åŒ–ä¹‹å‰å¯¹ BeanDefinition è¿›è¡Œæ“ä½œã€‚ @Componentpublic class MyBeanDefinitionRegistryPostProcessor implements BeanDefinitionRegistryPostProcessor &#123; @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123; // ä¿®æ”¹ BeanDefinition ä¿¡æ¯ BeanDefinition userComponentBeanDefinition = beanFactory.getBeanDefinition(&quot;userComponent&quot;); userComponentBeanDefinition.setLazyInit(true); // ä¿®æ”¹ Bean çš„ä¿¡æ¯ // xxx éå¸¸ä¸æ¨è beanFactory.getBean è¿‡æ—©çš„å®ä¾‹åŒ– Bean UserComponent bean = beanFactory.getBean(UserComponent.class); bean.setUserName(&quot;liuzhihang-01&quot;); &#125; @Override public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException &#123; // æ³¨å†Œä¸€ä¸ª BeanDefinition BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(OrderComponent.class); AbstractBeanDefinition orderComponentBeanDefinition = builder.getBeanDefinition(); registry.registerBeanDefinition(&quot;orderComponent&quot;, orderComponentBeanDefinition); &#125;&#125; ä¸‹é¢æ˜¯æµ‹è¯•ä»£ç æˆªå›¾ï¼š OrderComponent ç±»æ²¡æœ‰æ·»åŠ ä»»ä½•æ³¨è§£ï¼Œç„¶åæ³¨å†Œä¸º BeanDefinition ä¹‹åï¼Œä»å®¹å™¨ä¸­å¯ä»¥è·å–åˆ° orderComponentã€‚ å¦‚ä½•ä¿®æ”¹å­—æ®µå±æ€§åœ¨ Spring æ–‡æ¡£ä¸Šè¯´æ˜ï¼Œéå¸¸ä¸å»ºè®®åœ¨ BeanFactoryPostProcessor ä¸­å®ä¾‹åŒ– Beanï¼Œé‚£è¿™æ—¶å€™æƒ³ä¿®æ”¹ Bean çš„ä¿¡æ¯ï¼Œæ”¹å¦‚ä½•æ“ä½œï¼Ÿ å…¶å®å¯ä»¥é€šè¿‡è·å–åˆ° MutablePropertyValues åè¿›è¡Œæ“ä½œï¼š @Componentpublic class MyBeanFactoryPostProcessor implements BeanFactoryPostProcessor &#123; @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123; // ä¿®æ”¹ BeanDefinition ä¿¡æ¯ BeanDefinition userComponentBeanDefinition = beanFactory.getBeanDefinition(&quot;userComponent&quot;); userComponentBeanDefinition.setLazyInit(true); MutablePropertyValues userComponentPropertyValues = userComponentBeanDefinition.getPropertyValues(); userComponentPropertyValues.addPropertyValue(&quot;userName&quot;, &quot;liuzhihang-02&quot;); // ä¿®æ”¹ Bean çš„ä¿¡æ¯ // xxx éå¸¸ä¸æ¨è beanFactory.getBean è¿‡æ—©çš„å®ä¾‹åŒ– Bean // UserComponent bean = beanFactory.getBean(UserComponent.class); // bean.setUserName(&quot;liuzhihang-01&quot;); &#125;&#125; invokeBeanFactoryPostProcessorsçœ‹å®Œå‰é¢ï¼Œæˆ‘æƒ³å·²ç»çŸ¥é“äº† BeanFactoryPostProcessor æ˜¯åšä»€ä¹ˆç”¨çš„äº†ï¼Œè€Œè¿™ä¸€æ­¥çš„ä¸»è¦ä½œç”¨å°±æ˜¯å®ä¾‹åŒ–æ‰€æœ‰çš„ BeanFactoryPostProcessorã€‚ è¿›å…¥æºç ï¼š protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123; PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors()); // Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime // (e.g. through an @Bean method registered by ConfigurationClassPostProcessor) if (!IN_NATIVE_IMAGE &amp;&amp; beanFactory.getTempClassLoader() == null &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123; beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory)); beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader())); &#125;&#125; å…¶ä¸­ getBeanFactoryPostProcessors æ–¹æ³•è·å–çš„æ˜¯è‡ªå·±æ·»åŠ çš„ BeanFactoryPostProcessorã€‚è¿™å¥è¯æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ public List&lt;BeanFactoryPostProcessor&gt; getBeanFactoryPostProcessors() &#123; return this.beanFactoryPostProcessors;&#125; çœ‹æºç ï¼Œå°±æ˜¯ç›´æ¥ä» beanFactoryPostProcessors è·å–çš„ï¼Œé‚£å¦‚ä½•å‘å…¶ä¸­æ·»åŠ å‘¢ï¼Ÿ å…¶å®è°ƒç”¨å®¹å™¨çš„ addBeanFactoryPostProcessor æ–¹æ³•å³å¯ã€‚ ç»§ç»­é˜…è¯»é‡ç‚¹ä»£ç  invokeBeanFactoryPostProcessors ï¼š æ³¨æ„æ³¨æ„ï¼Œè¿™å—ä»£ç éå¸¸é•¿ï¼ public static void invokeBeanFactoryPostProcessors( ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors) &#123; // Invoke BeanDefinitionRegistryPostProcessors first, if any. Set&lt;String&gt; processedBeans = new HashSet&lt;&gt;(); // åˆ¤æ–­æ˜¯å¦ä¸º BeanDefinitionRegistry // debug å‘ç° è¿™é‡Œä¼ å…¥çš„æ˜¯ DefaultListableBeanFactory // DefaultListableBeanFactory å®ç°äº† BeanDefinitionRegistry if (beanFactory instanceof BeanDefinitionRegistry) &#123; BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory; // åˆ›å»ºäº†ä¸¤ä¸ª List é›†åˆ, ç”¨æ¥å­˜æ”¾å¤„ç†å™¨ // BeanDefinitionRegistryPostProcessor æ˜¯ BeanFactoryPostProcessor çš„å­æ¥å£ // BeanDefinitionRegistryPostProcessor è¿˜å¯ä»¥é¢å¤–å¤„ç† BeanDefinition, æ·»åŠ  BeanDefinition // ç”¨æ³•å¯ä»¥å‚è€ƒç¤ºä¾‹ List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = new ArrayList&lt;&gt;(); List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = new ArrayList&lt;&gt;(); // å¾ªç¯ beanFactoryPostProcessors // beanFactoryPostProcessors æ˜¯ä½¿ç”¨ API context.addBeanFactoryPostProcessor æ·»åŠ è¿›æ¥çš„ for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123; // BeanDefinitionRegistryPostProcessor è¦å•ç‹¬æ·»åŠ åˆ° registryProcessors if (postProcessor instanceof BeanDefinitionRegistryPostProcessor) &#123; BeanDefinitionRegistryPostProcessor registryProcessor = (BeanDefinitionRegistryPostProcessor) postProcessor; // å¤„ç† Bean çš„ä¿¡æ¯ registryProcessor.postProcessBeanDefinitionRegistry(registry); registryProcessors.add(registryProcessor); &#125; else &#123; regularPostProcessors.add(postProcessor); &#125; &#125; // Do not initialize FactoryBeans here: We need to leave all regular beans // uninitialized to let the bean factory post-processors apply to them! // Separate between BeanDefinitionRegistryPostProcessors that implement // PriorityOrdered, Ordered, and the rest. // ä¸Šé¢å¾ªç¯æ˜¯æ‰§è¡Œçš„æˆ‘ä»¬è°ƒç”¨ API æ·»åŠ çš„ BeanDefinitionRegistryPostProcessor // ä¸‹é¢æ‰§è¡Œ Spring è‡ªå·±çš„ BeanDefinitionRegistryPostProcessor é›†åˆ // å…ˆæ‰§è¡Œå®ç°äº† PriorityOrderedæ¥å£çš„ï¼Œç„¶åæ˜¯ Ordered æ¥å£çš„ï¼Œæœ€åæ‰§è¡Œå‰©ä¸‹çš„ List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = new ArrayList&lt;&gt;(); // First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered. // ç¬¬ä¸€æ­¥å…ˆè°ƒç”¨ BeanDefinitionRegistryPostProcessors å®ƒå®ç°äº†PriorityOrdered // åœ¨åˆå§‹åŒ– reader æ—¶ åœ¨æ³¨å†Œäº† ConfigurationClassPostProcessor åˆ°å®¹å™¨é‡Œé¢ // BeanDefinitionRegistryPostProcessor å®ç°äº† BeanDefinitionRegistryPostProcessor String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) &#123; if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; // æ·»åŠ  bean currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); // è¿™é‡Œåªæ·»åŠ äº†åå­— åé¢ç”¨æ¥åˆ¤æ–­è°å·²ç»æ‰§è¡Œè¿‡äº† processedBeans.add(ppName); &#125; &#125; // æ’åº sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); // å¾ªç¯æ‰§è¡Œ processors çš„ postProcessBeanDefinitionRegistry æ–¹æ³• // è¿™ä¸ªå¾—åœ¨ä»”ç»†çœ‹ // debug çœ‹åˆ° æ‰§è¡Œå®Œè¿™ä¸€æ­¥æˆ‘å¦ä¸€ä¸ªåŠ  @Component æ³¨è§£çš„ç±» æ³¨å†Œåˆ° Registry é‡Œé¢äº† invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup()); // æ¸…é™¤ currentRegistryProcessors.clear(); // Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered. // å¤„ç†å®ç° Ordered çš„ processor postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) &#123; // åªæœ‰ä¸åŒ…å«çš„æ‰æ‰§è¡Œ, æ‰§è¡Œå®Œä¹‹åä¼šæ·»åŠ è¿› processedBeans if (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); &#125; &#125; // åŒä¸Š sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup()); currentRegistryProcessors.clear(); // Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear. // æœ€åæ‰§è¡Œå…¶ä»– boolean reiterate = true; while (reiterate) &#123; reiterate = false; postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) &#123; // åªæœ‰ä¸åŒ…å«çš„æ‰æ‰§è¡Œ, æ‰§è¡Œå®Œä¹‹åä¼šæ·»åŠ è¿› processedBeans if (!processedBeans.contains(ppName)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); reiterate = true; &#125; &#125; sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup()); currentRegistryProcessors.clear(); &#125; // Now, invoke the postProcessBeanFactory callback of all processors handled so far. // ä¸Šé¢å¤„ç†çš„éƒ½æ˜¯ postProcessBeanDefinitionRegistry æ˜¯åœ¨ -&gt; BeanDefinitionRegistryPostProcessor ä¸­ // ä¸‹é¢å¼€å§‹å¤„ç† postProcessBeanFactory -&gt; æ˜¯åœ¨ BeanFactoryPostProcessor ä¸­ invokeBeanFactoryPostProcessors(registryProcessors, beanFactory); invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory); &#125; else &#123; // Invoke factory processors registered with the context instance. // ä¸æ˜¯ BeanDefinitionRegistry åˆ™æ˜¯æ™®é€š BeanFactory ç›´æ¥æ‰§è¡Œ beanFactoryPostProcessors å³å¯ invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory); &#125; // Do not initialize FactoryBeans here: We need to leave all regular beans // uninitialized to let the bean factory post-processors apply to them! // ç¬¬äºŒéƒ¨åˆ† // ä¸Šé¢æ‰§è¡Œçš„æ˜¯ BeanDefinitionRegistryPostProcessor // ä¸‹é¢å¼€å§‹æ‰§è¡Œ BeanFactoryPostProcessor String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false); // Separate between BeanFactoryPostProcessors that implement PriorityOrdered, // Ordered, and the rest. // æŒ‰ç…§é¡ºåºæ‰§è¡Œ List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;&gt;(); List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;&gt;(); List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;&gt;(); for (String ppName : postProcessorNames) &#123; if (processedBeans.contains(ppName)) &#123; // skip - already processed in first phase above // è¯´æ˜ä¸Šé¢å·²ç»æ‰§è¡Œäº†, ä¸‹é¢å¿½ç•¥ &#125; else if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class)); &#125; else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; orderedPostProcessorNames.add(ppName); &#125; else &#123; nonOrderedPostProcessorNames.add(ppName); &#125; &#125; // First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered. // æ‰§è¡Œå®ç° PriorityOrdered çš„ sortPostProcessors(priorityOrderedPostProcessors, beanFactory); invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory); // Next, invoke the BeanFactoryPostProcessors that implement Ordered. List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;&gt;(orderedPostProcessorNames.size()); for (String postProcessorName : orderedPostProcessorNames) &#123; orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class)); &#125; sortPostProcessors(orderedPostProcessors, beanFactory); invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory); // Finally, invoke all other BeanFactoryPostProcessors. List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size()); for (String postProcessorName : nonOrderedPostProcessorNames) &#123; nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class)); &#125; invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory); // Clear cached merged bean definitions since the post-processors might have // modified the original metadata, e.g. replacing placeholders in values... // æ¸…ç©ºä¸å¿…è¦çš„å…ƒæ•°æ®ä¿¡æ¯ beanFactory.clearMetadataCache();&#125; ä¸Šé¢æ€»ä½“å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š æ‰§è¡Œ BeanDefinitionRegistryPostProcessor æ¥å£é‡Œé¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼špostProcessBeanDefinitionRegistry å’Œ postProcessBeanFactoryã€‚ æ‰§è¡Œ BeanFactoryPostProcessor æ¥å£é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ ä»¥ç¬¬ä¸€éƒ¨åˆ†ä¸ºä¾‹ï¼š é¦–å…ˆåˆ¤æ–­ä¼ å…¥çš„ BeanFactory æ˜¯å¦ä¸º BeanDefinitionRegistry å£°æ˜ä¸¤ä¸ª List é›†åˆï¼ŒregularPostProcessors ç”¨æ¥å­˜å‚¨ BeanFactoryPostProcessorï¼ŒregistryProcessors ç”¨æ¥å­˜å‚¨ BeanDefinitionRegistryPostProcessor å¾ªç¯ beanFactoryPostProcessorsï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨ API æ–¹å¼æ·»åŠ è¿›æ¥çš„ BeanFactoryPostProcessorã€‚ åœ¨å¾ªç¯ä¸­ BeanDefinitionRegistryPostProcessor çš„ postProcessBeanDefinitionRegistry ä¼šè¢«æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ç¤ºä¾‹çš„é‚£ä¸ªæ·»åŠ  BeanDefinition æ¼”ç¤ºçš„æ–¹æ³•ä¼šè¢«æ‰§è¡Œã€‚ å¼€å§‹æ‰§è¡Œ Spring è‡ªå·±çš„ BeanDefinitionRegistryPostProcessorï¼Œ å¤„ç†é¡ºåºä¸º PriorityOrdered, Ordered, and the rest å¾ªç¯ï¼Œå°†å¯¹åº”çš„ BeanDefinitionRegistryPostProcessor æ·»åŠ åˆ° currentRegistryProcessors é›†åˆå’ŒprocessedBeansé›†åˆè¡¨ç¤ºä¸ºå·²ç»å¤„ç†ã€‚ æ’åºåæ·»åŠ åˆ°ç¬¬ä¸€æ­¥çš„ registryProcessors ä¸­ã€‚ è°ƒç”¨ invokeBeanDefinitionRegistryPostProcessors æ‰§è¡Œæ‰€æœ‰çš„ Processor é‡Œé¢çš„ postProcessBeanDefinitionRegistry æ–¹æ³• æ‰§è¡Œå®Œ 1 å’Œ 2 ä¹‹åï¼Œæ‰€æœ‰çš„ postProcessBeanDefinitionRegistry å·²ç»è¢«æ‰§è¡Œå®Œäº†ï¼Œä½†æ˜¯ä¸¤ä¸ªé›†åˆï¼ˆregistryProcessorsã€regularPostProcessorsï¼‰é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•è¿˜æ²¡æœ‰è¢«æ‰§è¡Œã€‚æœ€åä¼šå¾ªç¯æ‰§è¡Œã€‚ å¦‚æœä¸æ˜¯ BeanDefinitionRegistry ç±»å‹ï¼Œåˆ™ç›´æ¥æ‰§è¡Œä¼ å…¥çš„ beanFactoryPostProcessors å³å¯ã€‚ ä¸‹é¢æ˜¯å¯¹åº”çš„ä»£ç æˆªå›¾ ä»¥ä¸Šåªæ˜¯è¿™ä¸ªæ–¹æ³•çš„å‰åŠéƒ¨åˆ†ï¼Œæ‰§è¡Œäº† BeanDefinitionRegistryPostProcessor é‡Œé¢çš„ postProcessBeanDefinitionRegistry å’Œ postProcessBeanFactoryã€‚ å› ä¸ºè¿˜æœ‰ç›´æ¥å®ç° BeanFactoryPostProcessor çš„å¤„ç†å™¨ï¼Œä¸‹é¢åˆ™å¼€å§‹å¤„ç† BeanFactoryPostProcessor çš„å¤„ç†å™¨ã€‚è¿‡ç¨‹å’Œä¸Šé¢ç±»ä¼¼ã€‚ æ€»ç»“é€šè¿‡ä»¥ä¸Šçš„é˜…è¯»ï¼Œå¯¹ invokeBeanFactoryPostProcessors(beanFactory); è¿™ä¸€æ­¥æ–¹æ³•è¿›è¡Œæ€»ç»“ã€‚ BeanFactoryPostProcessor ä½œç”¨BeanFactoryPostProcessor ä¸»è¦ä½œç”¨æ˜¯åœ¨æ³¨å†Œ BeanDefinition ä¹‹åï¼Œåœ¨ Bean åˆå§‹åŒ–ä¹‹å‰ï¼Œä¿®æ”¹ BeanDefinition çš„ä¿¡æ¯ã€‚ BeanFactoryPostProcessor æœ‰ä¸ªå®ç°å« BeanDefinitionRegistryPostProcessorï¼Œå®ƒå¯ä»¥é¢å¤–çš„æ³¨å†Œæ–°çš„ BeanDefinition åˆ°å®¹å™¨ä¸­ã€‚ æµç¨‹æ¦‚è¿° è¿™ä¸€æ­¥ä¸»è¦æ˜¯å¤„ç† BeanFactoryPostProcessorï¼Œåˆ†ä¸ºä¸¤æ­¥ã€‚ æ‰§è¡Œ BeanDefinitionRegistryPostProcessor æ¥å£é‡Œé¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼špostProcessBeanDefinitionRegistry å’Œ postProcessBeanFactoryã€‚ æ‰§è¡Œ BeanFactoryPostProcessor æ¥å£é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  10ï¼šprepareBeanFactory å’Œ postProcessBeanFactory Spring æºç å­¦ä¹  09ï¼šrefresh å¤§æ¦‚æµç¨‹ Spring æºç å­¦ä¹  08ï¼šregister æ³¨å†Œé…ç½®ç±»","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  10ï¼šprepareBeanFactory å’Œ postProcessBeanFactory","slug":"source-code/spring/10-Spring prepareBeanFactory","date":"2020-12-27T15:00:00.000Z","updated":"2020-12-27T09:49:55.161Z","comments":true,"path":"2020/12/27/source-spring-10.html","link":"","permalink":"https://liuzhihang.com/2020/12/27/source-spring-10.html","excerpt":"","text":"å‰è¨€æ ¹æ® refresh æµç¨‹ï¼Œå½“ obtainFreshBeanFactory æ‰§è¡Œç»“æŸåï¼Œä¸‹ä¸€æ­¥ä¼šæ‰§è¡Œ prepareBeanFactory ï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å‡†å¤‡ BeanFactoryï¼Œä¸‹é¢ä¸€èµ·çœ‹ä¸€çœ‹è¿™éƒ¨åˆ†é€»è¾‘ã€‚ prepareBeanFactoryprotected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123; // Tell the internal bean factory to use the context&#x27;s class loader etc. // è®¾ç½®beanFactoryçš„ç±»åŠ è½½å™¨ beanFactory.setBeanClassLoader(getClassLoader()); // spring.spel.ignore å±æ€§æ§åˆ¶æ˜¯å¦è§£æ SpEL è¡¨è¾¾å¼ if (!shouldIgnoreSpel) &#123; beanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader())); &#125; // è®¾ç½®å±æ€§è§£æå™¨ beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment())); // Configure the bean factory with context callbacks. // æ·»åŠ åˆ°åç½®å¤„ç†å™¨åˆ—è¡¨, æ–°åˆ›å»ºçš„ ApplicationContextAwareProcessor å…¥å‚ä¸ºå½“å‰ ApplicationContext beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this)); // å¿½ç•¥è‡ªåŠ¨è£…é… // é»˜è®¤æƒ…å†µä¸‹ åªæœ‰BeanFactoryAware è¢«å¿½ç•¥ è¦å¿½ç•¥å…¶ä»–ç±»å‹ï¼Œéœ€è¦å•ç‹¬è®¾ç½® beanFactory.ignoreDependencyInterface(EnvironmentAware.class); beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class); beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class); beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class); beanFactory.ignoreDependencyInterface(MessageSourceAware.class); beanFactory.ignoreDependencyInterface(ApplicationContextAware.class); beanFactory.ignoreDependencyInterface(ApplicationStartup.class); // BeanFactory interface not registered as resolvable type in a plain factory. // MessageSource registered (and found for autowiring) as a bean. // æ³¨å†Œè‡ªåŠ¨è£…é…çš„ç±» beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory); beanFactory.registerResolvableDependency(ResourceLoader.class, this); beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this); beanFactory.registerResolvableDependency(ApplicationContext.class, this); // Register early post-processor for detecting inner beans as ApplicationListeners. beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(this)); // Detect a LoadTimeWeaver and prepare for weaving, if found. // æ˜¯å¦éœ€è¦ç±»åŠ è½½æœŸé—´ç»‡å…¥ å¢åŠ Aspectjçš„æ”¯æŒ if (!IN_NATIVE_IMAGE &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123; beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory)); // Set a temporary ClassLoader for type matching. beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader())); &#125; // Register default environment beans. // æ³¨å†Œå…¶ä»–çš„ bean if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123; beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment()); &#125; if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123; beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties()); &#125; if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123; beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment()); &#125; if (!beanFactory.containsLocalBean(APPLICATION_STARTUP_BEAN_NAME)) &#123; beanFactory.registerSingleton(APPLICATION_STARTUP_BEAN_NAME, getApplicationStartup()); &#125;&#125; è¿™å—ä»£ç æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±ç›´æ¥è´´ä»£ç äº†ã€‚ å†å¯¹ä»£ç è¿›è¡Œåˆ†æï¼Œä¸»è¦ç»å†ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š addBeanPostProcessor æ·»åŠ  BeanPostProcessor registerResolvableDependency æ³¨å†Œä¾èµ–å…³ç³» registerSingleton æ³¨å†Œå…¶ä»–çš„å•ä¾‹ Bean ä¸‹é¢å¯ä»¥ Debug çœ‹ä¸€ä¸‹ã€‚ Debugæ–¹æ³•è°ƒç”¨å‰ï¼š registerResolvableDependency æ‰§è¡Œä¹‹å è¿™é‡Œå‘ç°è°ƒç”¨ registerResolvableDependency æ‰§è¡Œç»“æŸä¹‹åï¼ŒbeanDefinitionNames ä¸­å¹¶æ²¡æœ‰å¤šæ·»åŠ ç›¸å…³å¯¹è±¡ã€‚ æŸ¥çœ‹æºç å‘ç°å…¶å®æ˜¯æ·»åŠ åˆ°äº† resolvableDependencies è¿™ä¸ª Map ä¸­äº†ã€‚ å›é¡¾ åœ¨ä»‹ç» DefaultListableBeanFactory æ—¶ï¼Œè¯´ BeanDefinition æ˜¯å­˜å‚¨åœ¨ beanDefinitionMap ä¸­çš„ã€‚è€Œè¿™é‡Œçš„ä¾èµ–å…³ç³»æ˜¯åˆ™æ˜¯å­˜å‚¨åœ¨ resolvableDependencies ä¸­çš„ã€‚ postProcessBeanFactoryåœ¨æ‰§è¡Œ prepareBeanFactory ä¹‹åï¼Œå½“çœ‹åˆ° postProcessBeanFactory(beanFactory); æ–¹æ³•çš„æ—¶å€™å°±å¾ˆç–‘æƒ‘ï¼Œ å› ä¸ºè¿™ä¸ªæ˜¯éœ€è¦å­ç±»å®ç°çš„ï¼Œåªæ˜¯ä½œä¸ºä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå­ç±»å®ç°ä¹‹åï¼Œå¯ä»¥åœ¨é‡Œé¢æ·»åŠ è‡ªå·±çš„é€»è¾‘ã€‚ æ€»ç»“è¿™ç¯‡æ–‡ç« ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å‡†å¤‡ BeanFactory å‘å…¶ä¸­æ·»åŠ ç³»ç»Ÿçš„ä¾èµ–ä»¥åŠ bean, è€Œ postProcessBeanFactory åˆ™æ˜¯ä¸€ä¸ªæ¨¡ç‰ˆæ–¹æ³•ç”¨æ¥ä¾›å­ç±»å®ç°ã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  09ï¼šrefresh å¤§æ¦‚æµç¨‹ Spring æºç å­¦ä¹  08ï¼šregister æ³¨å†Œé…ç½®ç±» Spring æºç å­¦ä¹  07ï¼šClassPathBeanDefinitionScanner","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  09ï¼šrefresh å¤§æ¦‚æµç¨‹","slug":"source-code/spring/9-Spring refresh","date":"2020-12-16T15:00:00.000Z","updated":"2020-12-27T09:08:55.499Z","comments":true,"path":"2020/12/16/source-spring-09.html","link":"","permalink":"https://liuzhihang.com/2020/12/16/source-spring-09.html","excerpt":"","text":"å‰è¨€å‰é¢çš„å‡†å¤‡å·¥ä½œç»“æŸä¹‹åï¼Œå°±æ˜¯è¿›å…¥æ ¸å¿ƒä»£ç  refreshã€‚ æºç public void refresh() throws BeansException, IllegalStateException &#123; // åŠ é” synchronized (this.startupShutdownMonitor) &#123; StartupStep contextRefresh = this.applicationStartup.start(&quot;spring.context.refresh&quot;); // å‡†å¤‡ä¸€äº›ä¸Šä¸‹æ–‡ prepareRefresh(); // è·å–å‡†å¤‡åçš„ beanFactory DefaultListableBeanFactory ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // å‡†å¤‡ BeanFactory prepareBeanFactory(beanFactory); try &#123; // å…è®¸åœ¨ä¸Šä¸‹æ–‡å­ç±»ä¸­å¯¹beanå·¥å‚è¿›è¡Œåå¤„ç†ã€‚ postProcessBeanFactory(beanFactory); StartupStep beanPostProcess = this.applicationStartup.start(&quot;spring.context.beans.post-process&quot;); // åœ¨ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨æ³¨å†Œä¸º beanFactory åç½®å¤„ç†å™¨ // å°±æ˜¯å®ç°äº† BeanFactoryPostProcessor çš„ bean invokeBeanFactoryPostProcessors(beanFactory); // æ³¨å†Œåç½®å¤„ç†çš„Beanåˆ°å®¹å™¨å½“ä¸­ // å°±æ˜¯æ‰©å±•äº† BeanPostProcessor çš„ Bean registerBeanPostProcessors(beanFactory); beanPostProcess.end(); // ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–æ¶ˆæ¯æºã€‚ // åˆå§‹åŒ–å›½é™…åŒ–å·¥å…· MessageSource initMessageSource(); // ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨ã€‚ initApplicationEventMulticaster(); // åœ¨ç‰¹å®šä¸Šä¸‹æ–‡å­ç±»ä¸­åˆå§‹åŒ–å…¶ä»–ç‰¹æ®Šbeanã€‚å­ç±»å¯ä»¥è‡ªå·±å®ç° onRefresh(); // æ£€æŸ¥å¹¶æ³¨å†Œç›‘å¬å™¨ã€‚ registerListeners(); // å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„ï¼ˆéå»¶è¿Ÿåˆå§‹åŒ–ï¼‰å•ä¾‹ã€‚ finishBeanFactoryInitialization(beanFactory); // æœ€åä¸€æ­¥: å®Œæˆæ­¤ä¸Šä¸‹æ–‡çš„åˆ·æ–°ï¼Œè°ƒç”¨ LifecycleProcessor çš„ onRefreshï¼ˆï¼‰æ–¹æ³•å¹¶å‘å¸ƒ finishRefresh(); &#125; catch (BeansException ex) &#123; if (logger.isWarnEnabled()) &#123; logger.warn(&quot;Exception encountered during context initialization - &quot; + &quot;cancelling refresh attempt: &quot; + ex); &#125; // é”€æ¯å·²åˆ›å»ºçš„å•ä¾‹ä»¥é¿å…èµ„æºæ‚¬æŒ‚ã€‚ destroyBeans(); // é‡ç½®æ´»åŠ¨çŠ¶æ€ cancelRefresh(ex); // Propagate exception to caller. throw ex; &#125; finally &#123; // Reset common introspection caches in Spring&#x27;s core, since we // might not ever need metadata for singleton beans anymore... resetCommonCaches(); contextRefresh.end(); &#125; &#125;&#125; æºç å°±æ˜¯å¯†å¯†éº»éº»çš„ä¸€å¤§å †ï¼Œæºç ä¸Šæœ‰ç›¸åº”çš„æ³¨é‡Šã€‚ ä¸‹é¢å°±æ ¹æ®æµç¨‹ï¼Œä¸€æ­¥ä¸€æ­¥çš„æ·±å…¥æºç ï¼Œäº†è§£åˆ°æ¯ä¸€æ­¥éƒ½æ˜¯åšä»€ä¹ˆäº†ã€‚ å®¹å™¨åˆ·æ–°å‡†å¤‡prepareRefresh è¿™ä¸€æ­¥ä¸»è¦æ˜¯å‡†å¤‡ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å°±ä¸è¿‡å¤šä»‹ç»äº†ã€‚ obtainFreshBeanFactory ä¸‹é¢å…³æ³¨åˆå§‹åŒ– BeanFactory è¿™ä¸€æ­¥ï¼š è¿›å…¥æºç ï¼š é€šè¿‡ Debug å¯ä»¥çœ‹å‡º refreshBeanFactory() è¿™ä¸€æ­¥è°ƒç”¨çš„æ˜¯ org.springframework.context.support.GenericApplicationContext#refreshBeanFactory ä¸­å®ç°çš„æ–¹æ³•ã€‚ ç»§ç»­è·Ÿè¿› å‘ç°è¿™å—åˆ¤æ–­äº†ä¸€ä¸ª refreshed åˆ·æ–°çŠ¶æ€ã€‚ refreshBeanFactory æ–¹æ³•ä¹Ÿæœ‰å¦ä¸€ä¸ªå®ç°æ˜¯åœ¨ AbstractRefreshableApplicationContext ä¸­ï¼Œ åªä¸è¿‡æˆ‘çš„æ–­ç‚¹æ²¡æœ‰æ–­è¿›å»ï¼Œè¿™å—ä¹Ÿä¸€èµ·çœ‹ä¸‹ã€‚ protected final void refreshBeanFactory() throws BeansException &#123; // å¦‚æœå­˜åœ¨ BeanFactory åˆ™é”€æ¯ Bean å¹¶å…³é—­ BeanFactory if (hasBeanFactory()) &#123; destroyBeans(); closeBeanFactory(); &#125; try &#123; // åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ BeanFactory DefaultListableBeanFactory beanFactory = createBeanFactory(); beanFactory.setSerializationId(getId()); // è®¾ç½®å±æ€§ customizeBeanFactory(beanFactory); // åŠ è½½ Bean ä¿¡æ¯ loadBeanDefinitions(beanFactory); this.beanFactory = beanFactory; &#125; catch (IOException ex) &#123; throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex); &#125;&#125; å…¶ä¸­ä¼šåˆ›å»º BeanFactory å¹¶åŠ è½½ BeanDefinitionã€‚åªä¸è¿‡æˆ‘æš‚æ—¶æ²¡æœ‰æ–­åˆ°ï¼Œæ‰€ä»¥ç­‰åé¢é‡åˆ°ä¹‹åå†è¯¦ç»†ä»‹ç»ã€‚ æ€»ç»“ æœ¬æ–‡ç®€å•ä»‹ç»äº† refresh çš„æµç¨‹ï¼Œå¹¶ä»‹ç»äº†å‰ä¸¤ä¸ªéƒ¨åˆ†ï¼š prepareRefresh å‡†å¤‡ä¸Šä¸‹æ–‡ä¿¡æ¯ obtainFreshBeanFactory åˆå§‹åŒ– BeanFactory ç›¸å…³æ¨è Spring æºç å­¦ä¹  08ï¼šregister æ³¨å†Œé…ç½®ç±» Spring æºç å­¦ä¹  07ï¼šClassPathBeanDefinitionScanner Spring æºç å­¦ä¹  06ï¼šAnnotatedBeanDefinitionReader","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  08ï¼šregister æ³¨å†Œé…ç½®ç±»","slug":"source-code/spring/8-Spring register æ³¨å†Œ bean","date":"2020-12-06T15:00:00.000Z","updated":"2020-12-06T13:01:39.451Z","comments":true,"path":"2020/12/06/source-spring-08.html","link":"","permalink":"https://liuzhihang.com/2020/12/06/source-spring-08.html","excerpt":"","text":"å‰è¨€çœ‹å®Œæ— å‚æ„é€ çš„æºç åŠæµç¨‹ä¹‹åï¼Œåé¢å°†ä¼šæ‰§è¡Œ register æ–¹æ³•ã€‚ register æ–¹æ³•ï¼Œå…¥å‚æ˜¯æˆ‘ä»¬çš„é…ç½®ç±» JavaConfig.class ï¼Œä¸‹é¢è·Ÿç€æºç ç»§ç»­å¾€ä¸‹èµ°ï¼ æºç åˆ†æ this.reader.register(componentClasses); è¿™é‡Œæ‰§è¡Œçš„æ˜¯ reader çš„æ–¹æ³•ï¼Œå…¥å‚å°±æ˜¯ä¼ å…¥çš„ JavaConfig.classã€‚ reader åœ¨ä¹‹å‰åˆå§‹åŒ–ï¼Œå°±æ˜¯æ³¨å†Œä¸€äº› PostProcessorã€‚ å¾ªç¯ï¼Œæ³¨å†Œæ‰€æœ‰çš„é…ç½®ç±»ï¼› doRegisterBean å¼€å§‹æ³¨å†Œã€‚ doRegisterBean æ‰æ˜¯çœŸæ­£æ³¨å†Œ Bean çš„é€»è¾‘ï¼Œä»åå­—ä¹Ÿå¯ä»¥æœ‰æ‰€çŒœæµ‹ã€‚ä¸‹é¢å¼€å§‹è¿›å…¥ doRegisterBean çš„æºç é˜…è¯»ï¼š doRegisterBean æ­¤å¤„ä»£ç è¾ƒé•¿ï¼Œä»¥æˆªå›¾ä»£æ›¿ã€‚ é€šè¿‡æºç å¯ä»¥çœ‹å‡ºï¼Œè¿™å—ä¸»è¦æµç¨‹ï¼š æ ¡éªŒä¼ å…¥çš„ JavaConfig.class çš„æ³¨è§£ï¼ˆæ˜¯å¦éœ€è¦å¿½ç•¥ï¼‰ï¼› å¤„ç†é€šç”¨æ³¨è§£ï¼› å°è£…ä¸º BeanDefinitionHolder åï¼Œæ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚ debug é€šè¿‡ debug å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ‰§è¡Œå®Œ register ä¹‹åï¼Œç›¸å½“äºå°† JavaConfig ä½œä¸ºä¸€ä¸ª Bean æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚ æ€»ç»“ åœ¨æˆ‘çœ‹æ¥å‰é¢çš„éƒ¨åˆ†ä¸»è¦æ¶‰åŠåˆ°å‡†å¤‡å·¥ä½œï¼Œè‡³äºæ›´æ·±å±‚æ¬¡çš„ç ”ç©¶ï¼Œåˆ†æï¼Œæš‚æ—¶æ²¡æœ‰æ·±å…¥ã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  07ï¼šClassPathBeanDefinitionScanner Spring æºç å­¦ä¹  06ï¼šAnnotatedBeanDefinitionReader Spring æºç å­¦ä¹  05ï¼šBeanDefinition æ¦‚å¿µåŠå…¶å®ç°","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  07ï¼šClassPathBeanDefinitionScanner","slug":"source-code/spring/7-Spring ClassPathBeanDefinitionScanner","date":"2020-12-05T15:00:00.000Z","updated":"2020-12-06T02:50:24.339Z","comments":true,"path":"2020/12/05/source-spring-07.html","link":"","permalink":"https://liuzhihang.com/2020/12/05/source-spring-07.html","excerpt":"","text":"å‰è¨€AnnotationConfigApplicationContext æ„é€ å‡½æ•°é™¤äº†åˆå§‹åŒ–ä¸€ä¸ª reader ï¼Œè¿˜æœ‰ä¸€ä¸ª scannerï¼Œä¸‹é¢æ¥ä¸€èµ·çœ‹çœ‹ ClassPathBeanDefinitionScanner éƒ½æœ‰ä»€ä¹ˆé€»è¾‘ã€‚ æºç åˆ†æthis.scanner = new ClassPathBeanDefinitionScanner(this); ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š å…¶ä¸­ useDefaultFilters é»˜è®¤è®¾ç½®çš„ trueã€‚æ‰€ä»¥æœ€ç»ˆä¼šæ‰§è¡Œä¸‹é¢ä¸‰éƒ¨åˆ†ä»£ç ï¼š registerDefaultFilters(); setEnvironment(environment); setResourceLoader(resourceLoader); å†æ¥çœ‹ä¸‹ UML ï¼š ClassPathBeanDefinitionScanner ç»§æ‰¿äº† ClassPathScanningCandidateComponentProviderï¼Œè€Œä¸Šé¢è¯´çš„è¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œå…¶å®éƒ½æ˜¯çˆ¶ç±» ClassPathScanningCandidateComponentProvider çš„æ–¹æ³•ã€‚ å¯¹åº”çš„è¿™ä¸‰ä¸ªæ“ä½œå°±æ˜¯ç»™å®ƒçš„å‚æ•°èµ‹å€¼ï¼š registerDefaultFilters æœ¬æ­¥éª¤ä¸»è¦æ˜¯æ·»åŠ è¿‡æ»¤å™¨ï¼Œå¯¹ includeFilters èµ‹å€¼ã€‚ æ³¨å†Œè¿‡æ»¤å™¨ @Componentï¼Œ@Controller @Serviceã€ @Repository ä¹Ÿä¼šè¢«æ·»åŠ è¿›å»ã€‚ ä¹Ÿä¼šæ³¨å†Œæ·»åŠ  JSR-250 çš„ @ManagedBean å’Œ JSR-330 çš„ @Named æ³¨è§£ã€‚ setEnvironment setResourceLoader setEnvironment å’Œ setResourceLoader èµ‹å€¼æ“ä½œï¼ŒåŸºæœ¬ä¸Šå¦‚ä»£ç æ‰€ç¤ºã€‚ æ€»ç»“ è¿™ä¸€æ­¥ä¸»è¦æ˜¯åˆå§‹åŒ–ç±»æ‰«æå™¨ï¼Œåœ¨å®ƒåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–ä¸€äº›éœ€è¦è¢«æ‰«æçš„æ³¨è§£ï¼Œä»¥åŠèµ„æºåŠ è½½å™¨ã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  06ï¼šAnnotatedBeanDefinitionReader Spring æºç å­¦ä¹  05ï¼šBeanDefinition æ¦‚å¿µåŠå…¶å®ç° Spring æºç å­¦ä¹  04ï¼šåˆå§‹åŒ–å®¹å™¨ä¸ DefaultListableBeanFactory","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  06ï¼šAnnotatedBeanDefinitionReader","slug":"source-code/spring/6-Spring AnnotatedBeanDefinitionReader","date":"2020-12-04T15:00:00.000Z","updated":"2020-12-04T14:07:36.172Z","comments":true,"path":"2020/12/04/source-spring-06.html","link":"","permalink":"https://liuzhihang.com/2020/12/04/source-spring-06.html","excerpt":"","text":"å‰è¨€BeanDefinition çš„æ¦‚å¿µä¹Ÿäº†è§£äº†ï¼Œä¹ŸçŸ¥é“ä¸€ä¸ª Bean åœ¨ Spring ä¸­å®šä¹‰çš„ä¿¡æ¯æœ‰å“ªäº›ä¹‹åï¼Œç»§ç»­è¨€å½’æ­£ä¼ ã€‚ æºç åˆ†æåœ¨åˆå§‹åŒ–æ—¶ä¼šå…ˆç”Ÿæˆä¸€ä¸ª reader ï¼Œè¿›å…¥æ–¹æ³•ï¼Œå…¶å®æ˜¯èµ°çš„ä¸‹é¢çš„é€»è¾‘ï¼š å…¶ä¸­ getOrCreateEnvironment(registry) ä¼šè¿”å›ä¸€ä¸ª Environment ç”¨æ¥è¡¨ç¤ºå½“å‰çš„è¿è¡Œç¯å¢ƒä¹‹ç±»çš„ã€‚ ConditionEvaluator æ˜¯ç”¨æ¥å®Œæˆå¯¹ @Conditional è¿™ä¸ªæ¡ä»¶æ³¨è§£çš„åˆ¤æ–­ã€‚ è¿™å—å¯ä»¥å‚è€ƒå®˜ç½‘ï¼šEnvironment Abstraction ç« èŠ‚ Conditionally Include @Configuration Classes or @Bean Methods ç« èŠ‚ è¡¥å…… BeanDefinitionRegistryï¼šå°±æ˜¯å¯¹ BeanDefinition è¿›è¡Œæ³¨å†Œã€ç§»é™¤ã€è·å–ç­‰æ“ä½œçš„ä¸€ä¸ªæ¥å£ã€‚æ¯”å¦‚ï¼šregisterBeanDefinitionã€removeBeanDefinitionã€containsBeanDefinition çœ‹åå­—ä¹Ÿèƒ½çŒœä¸ªå¤§æ¦‚æ„æ€ã€‚ registerAnnotationConfigProcessorsä¸‹é¢æ¥çœ‹æœ€åä¸€è¡Œä»£ç ï¼š AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry); è¿™ä¸ªä»£ç ç›¸å¯¹è¾ƒé•¿ï¼Œè¿˜æ˜¯ä»¥æˆªå›¾ä»£æ›¿ã€‚ å¯¹ beanFactory æ·»åŠ ä¾èµ–æ¯”è¾ƒå™¨ å’Œ è‡ªåŠ¨è£…é…è§£æå™¨ åå¼€å§‹æ·»åŠ å„ç§å¤„ç†å™¨ã€‚ æ·»åŠ å¤„ç†å™¨æ—¶ï¼Œä¸‹é¢æ”¶ç¼©çš„ä»£ç å’Œå”¯ä¸€å±•å¼€çš„ ConfigurationClassPostProcessor å†…éƒ¨é€»è¾‘ç›¸åŒï¼Œéƒ½æ˜¯è°ƒç”¨ registerPostProcessor æ–¹æ³•ï¼Œä¸‹é¢å†ä»‹ç»ä¸‹è¿™å‡ ä¸ªå¤„ç†å™¨çš„ä½œç”¨ï¼š ConfigurationClassPostProcessor ç”¨äºå¯¹ @Configuration ç±»è¿›è¡Œå¼•å¯¼å¤„ç†ã€‚ AutowiredAnnotationBeanPostProcessor å¤„ç† @Autowired @Value å’Œ JSR-330çš„@Inject è¿˜æœ‰ @Lookup æ³¨è§£ CommonAnnotationBeanPostProcessor ç”¨æ¥å¤„ç† @PostConstruct @PreDestroy @Resourceã€‚ PersistenceAnnotationBeanPostProcessor å½“æ”¯æŒ JPA æ—¶æ·»åŠ è¿™ä¸ªã€‚ EventListenerMethodProcessor æ”¯æŒ @EventListenerã€‚ registerPostProcessor registerPostProcessor æ–¹æ³•æœ‰ä¸¤ä¸ªé€»è¾‘ï¼š å°†è¿™å‡ ä¸ª Processor æ³¨å†Œåˆ° beanFactoryï¼› å¤„ç†å™¨å°è£…ä¸º BeanDefinitionHolder å¯¹è±¡ã€‚ BeanDefinitionHolder å°±æ˜¯å°è£…äº†ä¸‹ BeanDefinition ï¼Œè¯´æ˜è¿™ä¸ª BeanDefinition çš„æŒæœ‰è€… name æ˜¯è°ã€‚ å¤§èƒ†çŒœæµ‹æ‰§è¡Œå®Œè¿™ä¸€è¡Œä¹‹åï¼Œåœ¨ AnnotationConfigApplicationContext é‡Œé¢æœ‰äº† è¿™å‡ ä¸ª BeanDefinitionã€‚ å°å¿ƒæ±‚è¯Debug èµ°èµ·ï¼ é¢â€¦â€¦ åªæœ‰å››ä¸ªï¼Œå‡è£…æ˜¯å¯¹çš„ã€‚è¿˜æ˜¯ä¸€æ­¥ä¸€æ­¥çœ‹ä¸€çœ‹å§ï¼åŸæ¥æ˜¯æ²¡æœ‰ JSR-250 å’Œ JPAï¼Œé‚£è¿™ä¸ªå°±æ­£å¸¸äº†ã€‚ æ€»ç»“ å…¶å®ç®€è€Œè¨€ä¹‹ï¼Œè¿™ä¸€æ­¥å°±æ˜¯æ³¨å†Œäº†ä¸€äº› Spring è‡ªå·±çš„ PostProcessorã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  05ï¼šBeanDefinition æ¦‚å¿µåŠå…¶å®ç° Spring æºç å­¦ä¹  04ï¼šåˆå§‹åŒ–å®¹å™¨ä¸ DefaultListableBeanFactory Spring æºç å­¦ä¹  03ï¼šåˆ›å»º IoC å®¹å™¨çš„å‡ ç§æ–¹å¼","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  05ï¼šBeanDefinition æ¦‚å¿µåŠå…¶å®ç°","slug":"source-code/spring/5-Spring BeanDefinition å®šä¹‰","date":"2020-12-03T15:00:00.000Z","updated":"2020-12-04T02:09:09.484Z","comments":true,"path":"2020/12/03/source-spring-05.html","link":"","permalink":"https://liuzhihang.com/2020/12/03/source-spring-05.html","excerpt":"","text":"å‰è¨€BeanDefinitionï¼šé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ Bean çš„å®šä¹‰ï¼Œæ˜¯ç”¨æ¥æè¿°ä¸€ä¸ª Bean éƒ½æœ‰ä»€ä¹ˆä¿¡æ¯ã€‚å‰é¢è¯´åœ¨åˆå§‹åŒ– DefaultListableBeanFactory æ—¶ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ª Map&lt;String, BeanDefinition&gt;ï¼Œè¿™ä¸ª Map çš„åŠŸèƒ½æš‚ä¸”ä¸è¯´ï¼Œï¼ˆPSï¼šæŸ¥èµ„æ–™è¯´çš„æ˜¯å­˜å‚¨ beanï¼‰ï¼Œæ‰€ä»¥ä»Šå¤©å°±ç»“åˆå®˜æ–¹æ–‡æ¡£ä»¥åŠæºç ï¼Œä¸€èµ·äº†è§£ä¸€ä¸‹ BeanDefinitionï¼ æ¦‚å¿µ åœ¨å®¹å™¨å†…éƒ¨ï¼Œä½¿ç”¨ BeanDefinition å¯¹è±¡å®šä¹‰ä¸€ä¸ª Beanã€‚è€Œå®šä¹‰çš„ä¿¡æ¯åŒ…å« ç±»åã€ä½œç”¨åŸŸã€æ˜¯å¦æ‡’åŠ è½½ã€æ„é€ å‚æ•°ã€åˆå§‹åŒ–æ–¹æ³•ã€é”€æ¯æ–¹å¼ç­‰ç­‰ã€‚ äº†è§£äº†æ¦‚å¿µä¹‹åï¼Œå¼€å§‹é˜…è¯»æºç ï¼Œæºç éƒ¨åˆ†æ¯”è¾ƒé•¿ã€‚ æºç ä»‹ç» é€šè¿‡ UML å¯ä»¥çœ‹å‡º BeanDefinition æ¥å£ç»§æ‰¿äº† AttributeAccessor å’Œ BeanMetadataElement ä¸¤ä¸ªæ¥å£ã€‚ AttributeAccessorAttributeAccessorï¼šå®šä¹‰ç”¨äºå°†å…ƒæ•°æ®é™„åŠ åˆ°ä»»æ„å¯¹è±¡æˆ–ä»ä»»æ„å¯¹è±¡è®¿é—®å…ƒæ•°æ®çš„é€šç”¨åå®šçš„æ¥å£ã€‚ public interface AttributeAccessor &#123; void setAttribute(String name, @Nullable Object value); @Nullable Object getAttribute(String name); @Nullable Object removeAttribute(String name); boolean hasAttribute(String name); String[] attributeNames();&#125; é€šè¿‡æ¥å£æ–¹æ³•å¯ä»¥çœ‹å‡ºï¼ŒAttributeAccessor ä¸»è¦å®šä¹‰äº†å¯¹å…ƒæ•°æ®å±æ€§çš„å¢åˆ æ”¹æŸ¥ã€‚ AttributeAccessorSupport æ˜¯ AttributeAccessor æ¥å£çš„ä¸€ä¸ªå®ç°ï¼Œé€šè¿‡å®ç°å¯ä»¥çœ‹å‡ºï¼Œå…¶å†…éƒ¨ä½¿ç”¨äº† Map ä¿å­˜åç§°å’Œå±æ€§å€¼ã€‚ BeanMetadataElementBeanMetadataElementï¼šç”±åŒ…å«é…ç½®æºå¯¹è±¡çš„ bean å…ƒæ•°æ®å…ƒç´ å®ç°çš„æ¥å£ã€‚ public interface BeanMetadataElement &#123; @Nullable default Object getSource() &#123; return null; &#125;&#125; æ¥å£å†…éƒ¨åªæœ‰ä¸€ä¸ª getSource() æ–¹æ³•ï¼Œå…¶å«ä¹‰ä¸ºï¼šè¿”å›æ­¤å…ƒæ•°æ®å…ƒç´ çš„é…ç½®æºObject ï¼ˆå¯ä»¥ä¸ºnull ï¼‰ã€‚ å…¶å®è¿˜æ˜¯ä¸çŸ¥é“å•¥æ„æ€â€¦â€¦ åœ¨å­ç±»ï¼ˆBeanMetadataAttributeAccessorï¼‰ä¸­åŠ ä¸Šæ–­ç‚¹ï¼Œdebug è¿™é‡Œ source é‡Œé¢å­˜å‚¨äº† Class ç±»æ–‡ä»¶åœ¨ç£ç›˜çš„çœŸå®è·¯å¾„ã€‚å½“ç„¶å§‘ä¸”å¯ä»¥è¿™ä¹ˆè®¤ä¸ºï¼Œæ¯•ç«Ÿæˆ‘è¿™ä¹Ÿæ˜¯åˆšå¼€å§‹å­¦ä¹ æºç ï¼Œå½“å‰çš„ç»“è®ºåªæ˜¯ debug åˆ°çš„ï¼Œä¹Ÿæœ‰å¯èƒ½åœ¨åˆ«çš„å®ç°ç±»ä¸­å­˜å‚¨çš„æ˜¯åˆ«çš„ä¿¡æ¯ã€‚ BeanDefinitionBeanDefinition æ–¹æ³•è¾ƒå¤šï¼Œå°±ä¸è´´ä»£ç ï¼Œæˆ–è€…æˆªå›¾äº†ã€‚è¯¦ç»†å¯ä»¥é€šè¿‡ æˆ‘çš„ GitHub è¿›è¡Œé˜…è¯»ï¼Œä¸Šé¢æ·»åŠ äº†ç›¸å…³æ³¨é‡Šã€‚ ä¸è¿‡è¿˜æ˜¯ç®€è¦ä»‹ç»ä¸€ä¸‹æ–¹æ³•ï¼Œå¤§æ¦‚æœ‰ Bean çš„åå­—ã€ä½œç”¨èŒƒå›´ã€æ˜¯å¦é¦–é€‰ã€ä»¥åŠ Bean çš„åˆå§‹åŒ–é”€æ¯æ–¹æ³•ç­‰ç­‰ã€‚ BeanDefinition åªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å®ç°åˆåˆ†ä¸ºå¥½å‡ ç§ã€‚ AbstractBeanDefinitionAbstractBeanDefinition ä½œä¸º BeanDefinition çš„æŠ½è±¡å®ç°ç±»ï¼Œå†…éƒ¨å®šä¹‰äº†å¾ˆå¤šå±æ€§ï¼Œä»¥æ»¡è¶³ BeanDefinition å®šä¹‰çš„æ¥å£åŠŸèƒ½ã€‚ è¿™äº›å±æ€§çš„æ“ä½œï¼Œå°±å¯¹åº”ç€ BeanDefinition å®šä¹‰çš„æ¥å£æ–¹æ³•ã€‚ AbstractBeanDefinition çš„ä¸‰ä¸ªå®ç°ç±»AbstractBeanDefinition çš„å®ç°åˆåˆ†ä¸ºä¸‰ä¸ªï¼šåˆ†åˆ«æ˜¯ ChildBeanDefinitionã€ RootBeanDefinitionã€ GenericBeanDefinitionã€‚ ChildBeanDefinitionï¼šå¯ä»¥ä» Parent Definition é‡Œé¢ç»§æ‰¿ä¸€äº›å…¬å…±å®šä¹‰ï¼ˆåˆå§‹åŒ–æ–¹æ³•ã€é”€æ¯æ–¹æ³•ã€æ˜¯å¦æ‡’åŠ è½½ç­‰ç­‰ï¼‰ä¸è¿‡ RootBeanDefinitionï¼šå®šä¹‰ Bean Definition çš„å…¬å…±å±æ€§ï¼Œè¯¥å®šä¹‰åœ¨è¿è¡Œæ—¶æ”¯æŒSpring BeanFactoryä¸­çš„ç‰¹å®šbeanã€‚ è€Œ RootBeanDefinition æ˜¯ä¸å¯ä»¥è®¾ç½® parentName æŒ‡å®š Parent Definition çš„ã€‚ GenericBeanDefinitionï¼šæ˜¯ä¸€ä¸ªé€šç”¨çš„ Bean Definitionï¼Œæ˜¯ä¸€ç«™å¼æœåŠ¡ï¼Œç”¨äºæ ‡å‡†beanå®šä¹‰ã€‚ åƒä»»ä½•beanå®šä¹‰ä¸€æ ·ï¼Œå®ƒå…è®¸æŒ‡å®šä¸€ä¸ªç±»ä»¥åŠå¯é€‰çš„æ„é€ å‡½æ•°å‚æ•°å€¼å’Œå±æ€§å€¼ã€‚ å¦å¤–ï¼Œå¯ä»¥é€šè¿‡ parentName å±æ€§çµæ´»åœ°é…ç½®ä»çˆ¶beanå®šä¹‰æ´¾ç”Ÿçš„å†…å®¹ã€‚æ‰€ä»¥ç°åœ¨ä¸€èˆ¬ä½¿ç”¨ GenericBeanDefinitionã€‚ ä» Spring 2.5 å¼€å§‹ï¼Œä»¥ç¼–ç¨‹æ–¹å¼æ³¨å†Œ Bean Definition çš„é¦–é€‰æ–¹æ³•æ˜¯ GenericBeanDefinition ç±»ï¼Œè¯¥ç±»å…è®¸é€šè¿‡ GenericBeanDefinition.setParentName æ–¹æ³•åŠ¨æ€å®šä¹‰çˆ¶ä¾èµ–é¡¹ã€‚ GenericBeanDefinition ä¸‹é¢è¿˜æœ‰ä¸¤ä¸ªå®ç°ï¼šScannedGenericBeanDefinition ã€AnnotatedGenericBeanDefinition äºŒè€…å¹¶æ— å¤ªå¤§åŒºåˆ«ï¼Œåªä¸è¿‡ AnnotatedGenericBeanDefinition æ¯” ScannedGenericBeanDefinition å¤šäº†ä¸€ä¸ª factoryMethodMetadata çš„å®šä¹‰ã€‚ æ€»ç»“é€šè¿‡é˜…è¯» BeanDefinition çš„æºç ï¼Œå¹¶å¯¹å…¶å®ç°ç±»çš„æºç è¿›è¡Œé˜…è¯»ä¹‹åï¼Œå¤§è‡´äº†è§£ BeanDefinition çš„æ¦‚å¿µåŠå…¶å«ä¹‰ã€‚å¤§æ¦‚ä½œå›¾æ€»ç»“å¦‚ä¸‹ï¼š ç›¸å…³æ¨è Spring æºç å­¦ä¹  04ï¼šåˆå§‹åŒ–å®¹å™¨ä¸ DefaultListableBeanFactory Spring æºç å­¦ä¹  03ï¼šåˆ›å»º IoC å®¹å™¨çš„å‡ ç§æ–¹å¼ Spring æºç å­¦ä¹  02ï¼šå…³äº Spring IoC å’Œ Bean çš„æ¦‚å¿µ","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  04ï¼šåˆå§‹åŒ–å®¹å™¨ä¸ DefaultListableBeanFactory","slug":"source-code/spring/4-Springå®¹å™¨å¯åŠ¨æµç¨‹","date":"2020-12-02T15:00:00.000Z","updated":"2020-12-02T14:14:33.301Z","comments":true,"path":"2020/12/02/source-spring-04.html","link":"","permalink":"https://liuzhihang.com/2020/12/02/source-spring-04.html","excerpt":"","text":"å‰è¨€ åœ¨å‰ä¸€ç¯‡æ–‡ç« ï¼šåˆ›å»º IoC å®¹å™¨çš„å‡ ç§æ–¹å¼ä¸­ï¼Œä»‹ç»äº†å››ç§æ–¹å¼ï¼Œè¿™é‡Œä»¥ AnnotationConfigApplicationContext ä¸ºä¾‹ï¼Œè·Ÿè¿›ä»£ç ï¼Œçœ‹çœ‹ IoC çš„å¯åŠ¨æµç¨‹ã€‚ å…¥å£ä» JavaConfig ä¸­åŠ è½½é…ç½®çš„ AnnotationConfigApplicationContext å¯åŠ¨æ–¹å¼å¦‚ä¸‹ï¼š è¿›å»ä¹‹åå‘ç°æ„é€ å…¶å®æ˜¯è°ƒç”¨çš„å½“å‰æ— å‚æ„é€ ã€‚ æ‰€ä»¥åœ¨å¯åŠ¨æ—¶ä¹Ÿå¯ä»¥ç›´æ¥å£°æ˜æ— å‚æ„é€ ï¼Œæ”¹å†™ä¸ºä¸‹é¢è¿™ç§ï¼š public class AnnotationConfigApplicationTest &#123; public static void main(String[] args) &#123; AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(); context.register(JavaConfig.class); context.refresh(); System.out.println(context.getBean(UserComponent.class)); &#125;&#125; ä»Šå¤©å°±ç ”ç©¶ç ”ç©¶æ— å‚æ„é€ è¿™ä¸€éƒ¨åˆ†ç©¶ç«Ÿåšäº†ä»€ä¹ˆé€»è¾‘ï¼ æ— å‚æ„é€  å…¶ä¸­çš„ StartupStep æ˜¯ 5.3 æ–°å¢çš„ç±»ï¼Œçœ‹ä»£ç æ³¨é‡Šçš„æ„æ€æ˜¯ï¼šè¡¨ç¤ºç”¨æ¥è®°å½•å¯åŠ¨è¿‡ç¨‹ä¸­çš„ä¸€äº›æŒ‡æ ‡ä¿¡æ¯ç­‰ã€‚æš‚æ—¶ä¸åšç ”ç©¶ã€‚ ä¸»è¦ç ”ç©¶çº¢æ¡†éƒ¨åˆ†ï¼æ³¨æ„ï¼Œè¿™ä¸€å—å¹¶ä¸ä»£è¡¨åªæœ‰çº¢æ¡†éƒ¨åˆ†ï¼ å› ä¸º AnnotationConfigApplicationContext ç»§æ‰¿äº† GenericApplicationContextï¼Œæ‰€ä»¥ä¼šå…ˆæ‰§è¡Œçˆ¶ç±»çš„æ„é€ æ–¹æ³•ã€‚ æ‰€ä»¥è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ª DefaultListableBeanFactory çš„å®¹å™¨ã€‚ DefaultListableBeanFactory è™½ç„¶è¯´ Spring çš„ BeanFactory å®šä¹‰äº†å®¹å™¨çš„åŸºç¡€æ¦‚å¿µã€æ¥å£æ–¹æ³•ç­‰ï¼Œä½†æ˜¯ DefaultListableBeanFactory æ‰æ˜¯ä¸€ä¸ªçœŸæ­£å¯ä»¥ new å‡ºæ¥çš„å…·ä½“çš„å®¹å™¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æš‚ä¸”ç§°ä¹‹ä¸º bean å·¥å‚ã€‚ ä¸‹é¢æ¥çœ‹ä¸€ä¸‹ DefaultListableBeanFactory é‡Œé¢éƒ½æœ‰ä»€ä¹ˆï¼Ÿ åœ¨ DefaultListableBeanFactory é‡Œé¢ä¼šåˆå§‹åŒ–å¾ˆå¤šå‚æ•°ï¼Œå…¶ä¸­é‡ç‚¹å…³æ³¨çš„æ˜¯ä¸‹é¢ä¸¤ä¸ªå‚æ•°ï¼š /** Map of bean definition objects, keyed by bean name. */// BeanDefinition çš„å­˜å‚¨ Map å…¶ä¸­ key ä¸º beanNameprivate final Map&lt;String, BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;&gt;(256);/** List of bean definition names, in registration order. */// BeanName çš„é›†åˆprivate volatile List&lt;String&gt; beanDefinitionNames = new ArrayList&lt;&gt;(256); å…¶ä¸­ BeanDefinition æè¿°äº†ä¸€ä¸ª bean å®ä¾‹ï¼Œè¯¥å®ä¾‹å…·æœ‰å±æ€§å€¼ï¼Œæ„é€ å‡½æ•°å‚æ•°å€¼ä»¥åŠå…·ä½“å®ç°æ‰€æä¾›çš„æ›´å¤šä¿¡æ¯ã€‚ å¯¹åº”çš„ beanDefinitionMap å°±æ˜¯å­˜å‚¨çš„åˆå§‹åŒ–çš„ beanName å’Œ BeanDefinitionã€‚ è‡³äº BeanDefinition å…·ä½“å†…å®¹ï¼Œä¸‹ä¸€èŠ‚å†åšä»‹ç»ã€‚ æ€»ç»“é€šè¿‡ä¸Šé¢çš„é˜…è¯»ï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–æµç¨‹ä¸­å¢åŠ ä¸€éƒ¨åˆ†æ¨¡å—ï¼Œå³å®ä¾‹åŒ– DefaultListableBeanFactory å†å›é¡¾ä¸€ä¸‹ DefaultListableBeanFactory çš„æ¦‚å¿µã€‚ DefaultListableBeanFactoryï¼š Spring çš„ ConfigurableListableBeanFactory å’Œ BeanDefinitionRegistry æ¥å£çš„é»˜è®¤å®ç°ï¼šåŸºäºbeanå®šä¹‰å…ƒæ•°æ®çš„æˆç†Ÿbeanå·¥å‚ï¼Œå¯é€šè¿‡åå¤„ç†å™¨è¿›è¡Œæ‰©å±•ã€‚é‡ç‚¹éœ€è¦æŠŠæ¡çš„æ˜¯ DefaultListableBeanFactory å†…éƒ¨å®šä¹‰äº† BeanDefinition çš„ Mapã€‚ ç»“æŸè¯­æœ¬æ–‡ä»å…¥å£å¼€å§‹ï¼Œè¿›å…¥åˆ°æ„é€ ï¼Œä¸»è¦ä»‹ç»äº† DefaultListableBeanFactory çš„åˆ›å»ºï¼ŒåŠåˆ›å»ºæ—¶åˆå§‹åŒ–äº†ä¸€å †å‚æ•°ã€‚ è€ƒè™‘åˆ°æ–‡ç« ç¯‡å¹…é—®é¢˜ï¼Œå°½é‡é¿å…å¤§æ®µå¤§æ®µçš„è´´ä»£ç ä»¥åŠæ³¨é‡Šï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è¯•ç€è‡ªå·±æ­å»ºæºç æ„å»ºç¯å¢ƒï¼Œç„¶å Debug èµ°ä¸€èµ°ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥äº’ç›¸æ¢è®¨ï¼Œå…±åŒå­¦ä¹ ã€‚ ç¬”è€…ä¹Ÿæ˜¯åˆšå¼€å§‹é˜…è¯»å­¦ä¹ æºç ï¼Œä¸è¶³ä¹‹å¤„ï¼Œå¸Œæœ›å¤šå¤šæŒ‡æ­£ã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  03ï¼šåˆ›å»º IoC å®¹å™¨çš„å‡ ç§æ–¹å¼ Spring æºç å­¦ä¹  02ï¼šå…³äº Spring IoC å’Œ Bean çš„æ¦‚å¿µ Spring æºç å­¦ä¹  01ï¼šæºç é˜…è¯»ç¯å¢ƒçš„æ­å»º","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  03ï¼šåˆ›å»º IoC å®¹å™¨çš„å‡ ç§æ–¹å¼","slug":"source-code/spring/3-Springå®¹å™¨çš„åˆ›å»º","date":"2020-12-01T15:00:00.000Z","updated":"2020-12-01T15:37:00.752Z","comments":true,"path":"2020/12/01/source-spring-03.html","link":"","permalink":"https://liuzhihang.com/2020/12/01/source-spring-03.html","excerpt":"","text":"å‰è¨€ åœ¨ä¸Šä¸€ç¯‡æ–‡ç« æœ«å°¾ç”»äº†ä¸€å¹…ç®€å›¾ï¼Œç°åœ¨ä»ç®€å›¾è¿™å…¥æ‰‹ï¼Œå…ˆæ¥çœ‹çœ‹å¦‚ä½•åˆ›å»ºå®¹å™¨ï¼ åˆ›å»ºå®¹å™¨ åœ¨æ­å»º Spring æºç é˜…è¯»ç¯å¢ƒ æ—¶ï¼Œæœ€åä¸¾äº†ä¸€ä¸ªä¾‹å­ï¼Œå…¶å®å°±æ˜¯åˆ›å»ºå®¹å™¨ï¼Œå¹¶ä»å®¹å™¨ä¸­è·å– Bean ï¼Œæ¥æµ‹è¯•ç¯å¢ƒæ˜¯å¦ OKã€‚ æ ¹æ®å…ƒæ•°æ®çš„ä¸åŒï¼Œåˆ›å»ºå®¹å™¨çš„æ–¹å¼ä¹Ÿä¸åŒï¼Œä¸‹é¢å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œç®€å•ä»‹ç»ä¸‹åˆ›å»ºå®¹å™¨çš„å‡ ç§æ–¹å¼ï¼š Java é…ç½®è·å–å…ƒæ•°æ®public class AnnotationConfigApplicationTest &#123; public static void main(String[] args) &#123; AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(); context.register(JavaConfig.class); context.refresh(); System.out.println(context.getBean(UserComponent.class)); &#125;&#125; Xml è·å–å…ƒæ•°æ®public class XmlConfigApplicationTest &#123; public static void main(String[] args) &#123; ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(&quot;SpringConfig.xml&quot;); System.out.println(context.getBean(&quot;bookService&quot;)); &#125;&#125; Groovy è·å–å…ƒæ•°æ®public class GroovyConfigApplicationTest &#123; public static void main(String[] args) &#123; GenericGroovyApplicationContext context = new GenericGroovyApplicationContext(&quot;SpringConfig.groovy&quot;); System.out.println(context.getBean(NotesServiceImpl.class)); &#125;&#125; GenericApplicationContextä¹Ÿå¯ä»¥ç›´æ¥åˆ›å»º GenericApplicationContext ç„¶ååœ¨åŠ è½½å…ƒæ•°æ®é…ç½®æ–‡ä»¶ã€‚ public class GenericApplicationTest &#123; public static void main(String[] args) &#123; GenericApplicationContext context = new GenericApplicationContext(); new XmlBeanDefinitionReader(context).loadBeanDefinitions(&quot;SpringConfig.xml&quot;); new GroovyBeanDefinitionReader(context).loadBeanDefinitions(&quot;SpringConfig.groovy&quot;); context.refresh(); System.out.println(context.getBean(&quot;bookService&quot;)); System.out.println(context.getBean(NotesServiceImpl.class)); &#125;&#125; æ€»ç»“ æœ¬æ–‡ä¸»è¦ä»‹ç»äº†å¸¸ç”¨çš„å‡ ç§å®¹å™¨çš„åˆ›å»ºï¼Œé…ç½®æ–‡ä»¶éƒ¨åˆ†å°±æ²¡æœ‰åœ¨æ–‡ç« ä¸­ä½“ç°äº†ï¼Œå¦‚æœæƒ³äº†è§£è¿™éƒ¨åˆ†ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  01ï¼šæºç é˜…è¯»ç¯å¢ƒçš„æ­å»º Spring æºç å­¦ä¹  02ï¼šå…³äº Spring IoC å’Œ Bean çš„æ¦‚å¿µ Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  02ï¼šå…³äº Spring IoC å’Œ Bean çš„æ¦‚å¿µ","slug":"source-code/spring/2-Springå®¹å™¨å’ŒBean","date":"2020-11-30T15:00:00.000Z","updated":"2020-11-30T15:21:55.345Z","comments":true,"path":"2020/11/30/source-spring-02.html","link":"","permalink":"https://liuzhihang.com/2020/11/30/source-spring-02.html","excerpt":"","text":"å‰è¨€åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»äº†å¦‚ä½•æ„å»ºæºç é˜…è¯»ç¯å¢ƒï¼Œæ—¢ç„¶æ„å»ºå¥½äº†æºç ç¯å¢ƒï¼Œæœ¬åœ°ä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œï¼Œé‚£å°±å¼€å§‹é˜…è¯»æºç å§ï¼ åœ¨é˜…è¯»æºç æ—¶ï¼Œä¼šå‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œå¾ˆå¤šæ¦‚å¿µåœ¨å®˜ç½‘éƒ½å¯ä»¥å¾—åˆ°ç­”æ¡ˆï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´ä»¬å¯ä»¥ç»§ç»­é˜…è¯»ï¼Œå½“åšå¤ä¹ ï¼Œå†™çš„ä¸è¶³ä¹‹å¤„ï¼Œå¸Œæœ›å¤šå¤šæŒ‡å¯¼ã€‚ IoC å’Œ DI IoCIoCï¼ˆInversion of Controlï¼‰ï¼Œå³æ§åˆ¶åè½¬ã€‚ ä¹‹å‰æ˜¯åœ¨å¯¹è±¡å†…éƒ¨ new åˆ›å»ºå…¶ä»–å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ã€‚ è€Œç°åœ¨ Spring ä¸­æœ‰ä¸€ä¸ªå®¹å™¨å¯ä»¥åœ¨åˆ›å»ºç®¡ç†è¿™äº›å¯¹è±¡ï¼Œå¹¶ä¸”å°†å¯¹è±¡ä¾èµ–çš„å…¶ä»–å¯¹è±¡æ³¨å…¥åˆ°è¿™ä¸ªå¯¹è±¡ä¸­ï¼Œè¿™äº›å¯¹è±¡çš„åˆ›å»ºã€é”€æ¯éƒ½ç”± Spring è¿›è¡Œç®¡ç†ã€‚ ç›¸æ¯”ä»¥å‰æ¥è¯´ï¼Œä¸å†ç”±è‡ªå·±æ§åˆ¶å…¶ä»–å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«åšæ§åˆ¶åè½¬ã€‚è€Œè´Ÿè´£ç»Ÿä¸€ç®¡ç†è¿™äº›ç±»çš„å®¹å™¨å°±å«åš IoC å®¹å™¨ã€‚ DIIoC is also known as dependency injection (DI). æ˜¯ä¸æ˜¯æ„Ÿè§‰å¥‡å¥‡æ€ªæ€ªçš„ï¼Œä¸ºä»€ä¹ˆè¯´ï¼šIoC ä¹Ÿç§°ä¸º DIã€‚ å…¶å® IoC å’Œ DI æ˜¯åŒä¸€ä¸ªæ¦‚å¿µçš„ä¸åŒè§’åº¦æè¿°ã€‚ ä¾èµ–æ³¨å…¥æ˜¯æŒ‡ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ç”±å®¹å™¨åœ¨è¿è¡ŒæœŸå†³å®šï¼Œå½¢è±¡çš„è¯´ï¼Œå³ç”±å®¹å™¨åŠ¨æ€çš„å°†æŸä¸ªä¾èµ–å…³ç³»æ³¨å…¥åˆ°ç»„ä»¶ä¹‹ä¸­ã€‚ é€šè¿‡ä¾èµ–æ³¨å…¥æœºåˆ¶ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ç®€å•çš„é…ç½®ï¼Œè€Œæ— éœ€ä»»ä½•ä»£ç å°±å¯æŒ‡å®šç›®æ ‡éœ€è¦çš„èµ„æºï¼Œå®Œæˆè‡ªèº«çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸éœ€è¦å…³å¿ƒå…·ä½“çš„èµ„æºæ¥è‡ªä½•å¤„ï¼Œç”±è°å®ç°ã€‚ Spring æ˜¯é€šè¿‡ DI å®ç° IoC çš„ã€‚ å®¹å™¨å’Œ Bean Bean æ˜¯ä¸€ä¸ªç”± Spring IoC å®¹å™¨å®ä¾‹åŒ–ï¼Œç»„è£…å’Œç®¡ç†çš„å¯¹è±¡ã€‚ ç›¸ä¿¡å¤§å®¶éƒ½å†™è¿‡æˆ–è€…è§è¿‡ä¸‹é¢çš„ä»£ç ï¼š /** * ä»å®¹å™¨ä¸­è·å–å¯¹è±¡ * @author liuzhihang * @date 2020/4/6 19:02 */@Componentpublic class CustomBeanFactory implements ApplicationContextAware &#123; private static ApplicationContext ctx; @Override public void setApplicationContext(ApplicationContext ac) throws BeansException &#123; ctx = ac; &#125; public static Object getBean(String beanName) &#123; return ctx.getBean(beanName); &#125;&#125; ä»£ç é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯ä»å®¹å™¨ä¸­è·å–åˆ°æŒ‡å®šåç§°çš„ Beanï¼Œè€Œå…¶ä¸­ ApplicationContext æ¥å£å…¶å®å°±æ˜¯ Spring IoC å®¹å™¨ã€‚ å½“ç„¶ ApplicationContext æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæœ‰å¾ˆå¤šå®ç°ï¼Œè€Œå®ƒä¹Ÿç»§æ‰¿äº† BeanFactoryã€‚ è™½ç„¶ BeanFactory æ˜¯ IoC å®¹å™¨çš„æœ€åŸºæœ¬çš„å½¢å¼ï¼Œä½†æ˜¯ ApplicationContext å¯¹å…¶è¿›è¡Œäº†å¾ˆå¤šæ‰©å±•ï¼Œå¹¶å…·æœ‰ BeanFactory çš„æ‰€æœ‰åŠŸèƒ½ï¼Œé€šå¸¸å»ºè®®ä¼˜å…ˆä½¿ç”¨ ApplicationContextã€‚ æ€»ç»“åœ¨é€šè¿‡Spring å®˜ç½‘ äº†è§£äº† IoC ã€DI ã€å®¹å™¨å’Œ Bean çš„æ¦‚å¿µåï¼Œå†ç»“åˆå¹³å¸¸çš„ä½¿ç”¨åŸºæœ¬ä¸Šå¯ä»¥æœ‰ä¸ªå¤§æ¦‚æµç¨‹ã€‚ å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå¾ˆç²—ç•¥çš„çŒœæƒ³ï¼Œæ˜¯å¦æ­£ç¡®ï¼Œè¿˜æœ‰å¾…åé¢ç»§ç»­é˜…è¯»æºç ï¼Œç„¶åå»éªŒè¯ã€‚ ç›¸å…³æ¨è Spring æºç å­¦ä¹  01ï¼šæºç é˜…è¯»ç¯å¢ƒçš„æ­å»º Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ APP è«åå´©æºƒï¼Œå¼€å§‹ä»¥ä¸ºæ˜¯ Header ä¸­ name å¤§å°å†™çš„é”…ï¼Œæœ€åå‘ç°åŸæ¥æ˜¯å®¹å™¨çš„é”™","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"Spring æºç å­¦ä¹  01ï¼šæºç é˜…è¯»ç¯å¢ƒçš„æ­å»º","slug":"source-code/spring/1-Springæºç æ„å»º","date":"2020-11-26T15:00:00.000Z","updated":"2020-11-30T15:20:00.446Z","comments":true,"path":"2020/11/26/source-spring-build.html","link":"","permalink":"https://liuzhihang.com/2020/11/26/source-spring-build.html","excerpt":"","text":"å‰è¨€ æœ¬æ–‡è®°å½•äº† Spring æºç ç¯å¢ƒçš„æ­å»ºæ–¹å¼ï¼Œä»¥åŠè¸©è¿‡çš„é‚£äº›å‘ï¼â€‹ å½“å‰ç‰ˆæœ¬ï¼š5.3.2-SNAPSHOTã€‚ ç¯å¢ƒå‡†å¤‡ Git JDK master åˆ†æ”¯éœ€è¦ JDK 11 5.2.x åˆ†æ”¯ï¼Œ JDK8 å³å¯ Gradle 6.5.1 IDEA æœ€æ–° ï¼ˆ2020.2.3ï¼‰ Spring æºç ä»“åº“åœ°å€ï¼šhttps://github.com/spring-projects/spring-framework ä¸‹è½½æºç  clone æºç  git clone https://github.com/spring-projects/spring-framework.git ä½¿ç”¨ IDEA æ‰“å¼€ ç­‰å¾… IDEA åŠ è½½å®Œæˆå³å¯ã€‚ æ³¨ï¼š ä¹Ÿå¯ä»¥æŒ‡å®š clone çš„åˆ†æ”¯ git clone -b 5.2.x https://github.com/spring-projects/spring-framework.git æˆ–è€…å…ˆ fork åˆ°è‡ªå·±çš„ä»“åº“ï¼Œç„¶åå† cloneã€‚ è¿™é‡Œæˆ‘æ˜¯ fork åˆ°æˆ‘çš„ä»“åº“ï¼Œç„¶åå† clone çš„ã€‚ å½“å‰ master åˆ†æ”¯ä»£è¡¨çš„ç‰ˆæœ¬ä¸º 5.3.2-SNAPSHOTã€‚ æ‰§è¡Œæµ‹è¯• åœ¨é¡¹ç›®å³é”®åˆ›å»º module é€‰æ‹© Gradle Java åˆ›å»º module åœ¨ build.gradle ä¸­æ·»åŠ é…ç½® compile(project(&quot;:spring-context&quot;)) åˆ›å»ºæµ‹è¯•ç±»å¹¶æµ‹è¯• å…¶ä¸­ UserComponent æ·»åŠ äº† @Component æ³¨è§£ï¼Œ ç¨‹åºæ­£å¸¸æ‰§è¡Œåˆ™ä¸€åˆ‡ OKã€‚å¯ä»¥å¼€å§‹æ„‰å¿«çš„è°ƒè¯•ä»£ç äº†ã€‚ é—®é¢˜æ€»ç»“ç¼–è¯‘å¤±è´¥æœ‰å°ä¼™ä¼´ç›´æ¥ä¸‹è½½ zip åŒ…ï¼Œå¯èƒ½é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š(éå¸¸ä¸å»ºè®®ç›´æ¥ä¸‹è½½ zip åŒ…æ„å»ºï¼Œæƒ³çŸ¥é“åŸå› å¯ä»¥ç»§ç»­çœ‹ï¼Œæœ€åæˆ‘ä¹Ÿæ²¡æœ‰æ„å»ºæˆåŠŸï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡ clone æ„å»ºçš„ã€‚) æŠ¥é”™å¦‚ä¸‹ï¼š fatal: not a git repository (or any of the parent directories): .gitBUILD SUCCESSFUL in 14sBuild scan background action failed.org.gradle.process.internal.ExecException: Process &#x27;command &#x27;git&#x27;&#x27; finished with non-zero exit value 128 ... å…¶ä»–çœç•¥ çœ‹æ„æ€æ˜¯æ²¡æœ‰ git é…ç½®ï¼Œé‚£å°±æ·»åŠ ä¸Šå§ï¼ è¿™æ—¶å€™æƒ³ç€æ·»åŠ  git VCS -&gt; Enable Version Control Integration... -&gt; å³ä¸Šè§’ Reload All Gradle Projects ä¾ç„¶æŠ¥é”™ fatal: Needed a single revision æŸ¥è¯¢é—®é¢˜ issues åœ°å€ï¼šhttps://github.com/spring-projects/spring-framework/issues/24467 å»ºè®®ä½¿ç”¨ $ git clone git@github.com:spring-projects/spring-framework.git æ„æ€å°±æ˜¯ zip å‘è¡Œç‰ˆä¸»è¦æ˜¯ç”¨æ¥å…±äº«æºä»£ç ï¼Œä½†ä¸ä¸€å®šç”¨äºæ„å»ºå®ƒã€‚ æœ€åæˆ‘é€‰æ‹©äº†ä½¿ç”¨ clone çš„æ–¹å¼ï¼Œç›´æ¥ clone ä¸‹æ¥ï¼Œç„¶å build é€šè¿‡ã€‚ ç¼ºå°‘ cglib å’Œ objenesis åŒ…Kotlin: warnings found and -Weeror specified æ²¡æœ‰ spring-cglib-repack å’Œ spring-objenesis-repack åŒ… æ‰§è¡Œè¿™ä¸¤ä¸ªå³å¯ã€‚ æ‰¾ä¸åˆ°åŒ… jdk.jfrimport jdk.jfr.Category;import jdk.jfr.Description;import jdk.jfr.Event;import jdk.jfr.Label; JDK å‡çº§ä¸º 11ã€‚å› ä¸ºæˆ‘æœ¬åœ°ä½¿ç”¨çš„æ˜¯ JDK8ï¼Œå‘ç°æŠ¥é”™ï¼Œjfr åŒ…éœ€è¦å‡çº§ JDK 11 æ‰æœ‰ã€‚ å¦‚æœä¸ç”Ÿæ•ˆï¼Œå¯ä»¥é€šè¿‡ï¼š IDEA -&gt; File -&gt; Project Structure -&gt; Project æ£€æŸ¥ä¸‹æ˜¯å¦ä¿®æ”¹ä¸º JDK 11 å¿«æ·é”®ï¼šâŒ˜ + ; ç›¸å…³èµ„æ–™ Spring ä»“åº“ï¼šhttps://github.com/spring-projects/spring-framework Spring æ„å»ºæ–‡æ¡£ï¼šhttps://github.com/spring-projects/spring-framework/wiki/Build-from-Source å†å²æ–‡ç«  ReentrantLock æºç ã€ç”»å›¾ä¸€èµ·çœ‹ä¸€çœ‹ï¼ ReentrantReadWriteLock çš„åŸç†ï¼ Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"}]},{"title":"ã€å·¥å…·å†Œã€‘- DocView ç°åœ¨æ”¯æŒè‡ªå®šä¹‰ Markdown æ¨¡ç‰ˆäº†ï¼","slug":"tool/docview-3 æ”¯æŒè®¾ç½®æ¨¡ç‰ˆ","date":"2020-11-23T14:00:00.000Z","updated":"2020-11-24T02:08:13.738Z","comments":true,"path":"2020/11/23/doc-view-template.html","link":"","permalink":"https://liuzhihang.com/2020/11/23/doc-view-template.html","excerpt":"","text":"å‰è¨€ æœ‰å°ä¼™ä¼´åé¦ˆè¯´å¸Œæœ›å¯ä»¥è‡ªå®šä¹‰ Markdown æ¨¡ç‰ˆï¼Œè¿™æ ·å°±å¯ä»¥å¯¼å‡ºè‡ªå·±æƒ³è¦çš„æ ·å¼äº†ï¼è¿™ä¸ªåŠŸèƒ½å¯ä»¥æœ‰ï¼Œæ¯•ç«Ÿå¤§å®¶ä¸å¯èƒ½éƒ½ç”Ÿæˆä¸€æ¨¡ä¸€æ ·çš„æ–‡æ¡£ã€‚ç°åœ¨æ¥ä¸€èµ·çœ‹çœ‹å¦‚ä½•å®ç°è‡ªå®šä¹‰æ¨¡ç‰ˆå§ï¼ è®¾ç½®æ¨¡ç‰ˆSettings -&gt; Other Settings -&gt; Doc View -&gt; Markdown Template æ‰“å¼€ä¹‹åå†…å®¹å¦‚ä¸‹ï¼š æ¨¡ç‰ˆè¿™é‡Œåˆ†ä¸¤ä¸ª Tab åˆ†åˆ«æ˜¯ Spring ã€ Dubbo ã€‚ è¿™ä¸¤ä¸ªæ¨¡ç‰ˆå†…å®¹å°±ç¨å¾®æœ‰äº›åŒºåˆ«ï¼Œå¦‚æœè‡ªå®šä¹‰æ¨¡ç‰ˆï¼Œç›´æ¥ä¿®æ”¹ä¿å­˜å³å¯ã€‚ æ¨¡ç‰ˆå˜é‡ å…³äºæ¨¡ç‰ˆå˜é‡ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ velocity å°†å˜é‡æ›¿æ¢ä¸ºæ–‡æœ¬ï¼Œå¦‚æœæœ‰å…¶ä»–æ–¹å¼ï¼Œæˆ–è€…è¯´æ˜¯ IDEA ç”¨çš„é‚£ç§æ–¹å¼ï¼Œå¸Œæœ›å¯ä»¥å‘Šè¯‰æˆ‘ã€‚æœ€å¥½å¯ä»¥æä¾›æºç ã€‚ æ€»ç»“éå¸¸æ„Ÿè°¢ lvgo å°ä¼™ä¼´çš„å‚ä¸ã€‚ å¦‚æœå°ä¼™ä¼´ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°ä¸€äº› bug æˆ–è€…æœ‰å¥½çš„æ„è§å»ºè®®ï¼Œå¯ä»¥åœ¨ GitHub æäº¤ Issues ç•™è¨€æŒ‡å‡ºæ¥ã€‚ Doc View GitHubï¼šhttps://github.com/liuzhihang/doc-view æœ€åï¼Œè®°å¾—è¦ ä¸€é”®ä¸‰è¿ï¼Œ æ¥ä¸ª ã€åˆ†äº«ã€ç‚¹èµã€åœ¨çœ‹ã€‘ï¼ æ¨èæ–‡ç«  Dubbo ç”Ÿæˆæ–‡æ¡£ï¼Œå¯¼å‡º Markdownï¼Œè¿™äº›åŠŸèƒ½ DocView ç°åœ¨éƒ½æœ‰äº†ï¼ å¤´å¤§ï¼å†™æ–‡æ¡£å¤ªéº»çƒ¦äº†ï¼å¿«æ¥è¯•è¯•è¿™æ¬¾ IDEA æ’ä»¶å•Šï¼çˆ½åˆ°é£èµ·~ å°ä¼™ä¼´æƒ³å†™ä¸ª IDEA æ’ä»¶ä¹ˆï¼Ÿè¿™äº› API äº†è§£ä¸€ä¸‹ï¼","categories":[{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/"},{"name":"Doc View","slug":"å·¥å…·å†Œ/Doc-View","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/Doc-View/"}],"tags":[{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E5%85%B7%E5%86%8C/"},{"name":"Doc View","slug":"Doc-View","permalink":"https://liuzhihang.com/tags/Doc-View/"}]},{"title":"ã€å·¥å…·å†Œã€‘- Dubbo æ¥å£ï¼Œå¯¼å‡º Markdown ï¼Œè¿™äº›åŠŸèƒ½ DocView ç°åœ¨éƒ½æœ‰äº†ï¼","slug":"tool/docview-2 æ›´æ–°Dubbo","date":"2020-11-19T15:00:00.000Z","updated":"2020-11-23T11:50:47.294Z","comments":true,"path":"2020/11/19/doc-view-dubbo.html","link":"","permalink":"https://liuzhihang.com/2020/11/19/doc-view-dubbo.html","excerpt":"","text":"å‰è¨€ è‡ªä» DocView å‘å¸ƒäº†ç®€é™‹çš„ç¬¬ä¸€ç‰ˆä¹‹åï¼Œå°±ä¸æ–­åœ°æœ‰å°ä¼™ä¼´æå»ºè®®æ„è§ç­‰ç­‰ï¼Œå¸Œæœ›æ‰©å±•å„ç§åŠŸèƒ½ã€‚è¿™ä¸ï¼Œæ—¶éš”ä¸¤å‘¨ï¼ŒDocView åˆå‘å¸ƒäº†æ–°ç‰ˆæœ¬ï¼Œæœ¬æ¬¡çš„æ›´æ–°ä¸»è¦æ¶‰åŠåˆ°æ”¯æŒ Dubboï¼Œä»¥åŠæ”¯æŒå¯¼å‡ºå•ä¸ªæ–‡æ¡£ä¸º Markdown æ–‡ä»¶ã€‚æ¥ä¸€èµ·çœ‹çœ‹æ–°åŠŸèƒ½å§ï¼ æ”¯æŒå¯¼å‡º Markdown æ–‡ä»¶DocView åŸç‰ˆæœ¬å·²ç»æ”¯æŒå¤åˆ¶åˆ°å‰ªè´´æ¿çš„åŠŸèƒ½ã€‚ è€Œåœ¨æ–°ç‰ˆæœ¬ä¸­å¢åŠ äº† Export æŒ‰é’®ï¼Œå¯ä»¥å°†å•ä¸ªæ–‡æ¡£å¯¼å‡ºä¸º Markdown æ–‡ä»¶ã€‚ æ¥ä¸€å¼ åŠ¨å›¾ï¼Œå¤§å®¶çœ‹çœ‹æ•ˆæœï¼š å¯¼å‡ºçš„ Markdown æ–‡æœ¬å†…å®¹å¦‚ä¸‹ï¼š æ”¯æŒ Dubbo æ¥å£ä¹‹å‰çš„ç‰ˆæœ¬æ˜¯ä¸æ”¯æŒ Dubbo æ¥å£çš„ï¼Œè€Œç°åœ¨çš„ç‰ˆæœ¬å¯ä»¥åœ¨ Dubbo æ¥å£é‡Œé¢ä½¿ç”¨ã€‚ å½“ç„¶è¿™é‡Œå¹¶æ²¡æœ‰æ ¡éªŒæ¥å£æ˜¯å¦ä¸º Dubbo æ¥å£ï¼Œåªæ˜¯æ ¡éªŒäº†ä¸‹æ˜¯å¦ä¸ºæ¥å£ã€‚æ‰€ä»¥è¯´å³ä½¿å…¶ä»–æ¥å£ä¹Ÿæ˜¯å¯ä»¥ç”Ÿæˆçš„ã€‚ è¿™å—è¿˜æ˜¯éœ€è¦å®Œå–„çš„! DocView æ–‡æ¡£åœ°å€åœ¨é¢æ¿å·¦ä¸‹è§’çš„ help æŒ‰é’®ä¿®æ”¹äº†è·³è½¬åœ°å€ä¸ºï¼šhttp://docview.liuzhihang.com/ åªæ˜¯ç²—ç•¥æ­å»ºäº†ä¸€ä¸ª DocView çš„è¯´æ˜æ–‡æ¡£ç½‘ç«™ï¼Œå°ä¼™ä¼´ä»¬å¯ä»¥å‘ç°è¿™ä¸ªç½‘ç«™è¿ logo éƒ½æ²¡æœ‰ã€‚ å…¶ä»–å½“ç„¶ä¹Ÿæœ‰ä¸€äº›å…¶ä»–çš„å°æ”¹åŠ¨ï¼Œæ¯”å¦‚è®¾ç½®é¡µé¢ï¼ˆä¾ç„¶ä¸æ”¯æŒè‡ªå®šä¹‰è®¾ç½®ï¼‰ã€‚ æ€»ç»“ DocView è™½ç„¶æ”¯æŒäº†ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œä½†æ˜¯è·ç¦»å°ä¼™ä¼´ä»¬æœŸæœ›ä¸­çš„æ–‡æ¡£æ’ä»¶è¿˜æœ‰å¾ˆå¤šå¾ˆå¤šéœ€è¦è¿­ä»£çš„åŠŸèƒ½ã€‚ æ¯”å¦‚ï¼š æ‰¹é‡ç”Ÿæˆï¼ˆå½“å‰ä»…æ”¯æŒå•ä¸ªç±»æˆ–è€…æ–¹æ³•ï¼‰ æ‰¹é‡å¯¼å‡º é¢æ¿æ”¯æŒæŸ¥çœ‹ Markdown æºæ–‡æœ¬ æ”¯æŒä» Swagger æ³¨è§£è·å–å­—æ®µç›¸å…³ä¿¡æ¯ æ”¯æŒ Setting è®¾ç½® æ”¯æŒè‡ªå®šä¹‰æ¨¡ç‰ˆ æ”¯æŒä¸Šä¼ çš„ YApi æ”¯æŒå¯¼å‡ºå…¶ä»–ç±»å‹ â€¦ å—¯~ å¯èƒ½å¤§æ¦‚ä¹Ÿè®¸åº”è¯¥ä¼šéœ€è¦è¿­ä»£å¾ˆä¹…â€¦â€¦ ä¹Ÿç¡®å®æ˜¯ä¸ªäººèƒ½åŠ›å’Œç²¾åŠ›æœ‰é™ï¼Œå¦‚æœå°ä¼™ä¼´ä»¬æœ‰å…´è¶£ï¼Œå¯ä»¥æäº¤ PRã€‚ å½“ç„¶å¦‚æœå°ä¼™ä¼´ä»¬å‘ç°ä¸€äº› bug æˆ–è€…æœ‰å¥½çš„æ„è§å»ºè®®ï¼Œä¹Ÿå¯ä»¥ç•™è¨€æŒ‡å‡ºæ¥ã€‚ ç•™è¨€æ¨èå¤§å®¶åœ¨ GitHub æ Issuesã€‚ æœ€åå¦‚æœå°ä¼™ä¼´ä»¬è§‰å¾—æ’ä»¶ä¸é”™ï¼Œå¯ä»¥æ¨èç»™å‘¨å›´çš„æœ‹å‹åŒäº‹ï¼Œä¹Ÿè®°å¾— ä¸€é”®ä¸‰è¿ï¼Œ æ¥ä¸ª ã€åˆ†äº«ã€ç‚¹èµã€å†çœ‹ã€‘ã€‚","categories":[{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/"},{"name":"Doc View","slug":"å·¥å…·å†Œ/Doc-View","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/Doc-View/"}],"tags":[{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E5%85%B7%E5%86%8C/"},{"name":"Doc View","slug":"Doc-View","permalink":"https://liuzhihang.com/tags/Doc-View/"}]},{"title":"Warning: Calling `brew list` to only list formulae is deprecated! Use `brew list --formula` instead.","slug":"mac/brew list å¼‚å¸¸","date":"2020-11-15T02:00:00.000Z","updated":"2020-11-26T07:13:47.125Z","comments":true,"path":"2020/11/15/brew-list-warning.html","link":"","permalink":"https://liuzhihang.com/2020/11/15/brew-list-warning.html","excerpt":"","text":"é—®é¢˜æœ€è¿‘ç»ˆç«¯æ€»æ˜¯å¼¹å‡ºè¿™ä¹ˆä¸€å¥è¯ï¼Œå’±ä¹Ÿä¸æ‡‚æ€ä¹ˆè§£å†³ã€‚ Google baidu ä¹ŸæŸ¥ä¸åˆ°é—®é¢˜ã€‚ å°ä¼™ä¼´å¸®å¿™çœ‹ä¸€ä¸‹ã€‚ æ¯æ¬¡æ–°æ‰“å¼€ç»ˆç«¯éƒ½ä¼šæœ‰è¿™ä¸ª Warning ã€‚ Warning: Calling `brew list` to only list formulae is deprecated! Use `brew list --formula` instead. æœ€åè¢«é€¼æ— å¥ˆï¼Œåœ¨ V ç«™ å‘å¸–æ±‚åŠ©å°ä¼™ä¼´ï¼Œ ç»“æœè¿˜çœŸæ‰¾åˆ°äº†ç­”æ¡ˆ è§£å†³æ–¹å¼ æœ€åæ‰¾åˆ°é—®é¢˜æ‰€åœ¨ï¼Œæ˜¯å› ä¸ºæŒ‰ç…§ç½‘ä¸Šçš„æ•™ç¨‹å®‰è£…çš„ Coreutils ~/.zshrc é‡Œæ”¹ä¸€ä¸‹å³å¯ã€‚ è¡¥å……å†™åˆ°è¿™é‡Œï¼Œå¾ˆå¤šå°ä¼™ä¼´åº”è¯¥å·²ç»çŸ¥é“é—®é¢˜æ‰€åœ¨äº†ï¼Œå¯èƒ½æœ‰çš„å°ä¼™ä¼´è¿˜ä¸çŸ¥é“æ€ä¹ˆè§£å†³ï¼š vim ~/.zshrc æ‰¾åˆ°ä½¿ç”¨ brew list çš„åœ°æ–¹ å°† brew list æ”¹ä¸º brew list --formula å¦‚æœè¿˜ä¸çŸ¥é“æ€ä¹ˆå¼„ï¼Œé‚£å¯ä»¥ç”¨ç¼–è¾‘å·¥å…·æ‰“å¼€ .zshrc æ–‡ä»¶ï¼Œç„¶åæœç´¢æ‰¾åˆ° brew list ï¼Œç„¶åæ›¿æ¢ã€‚","categories":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/categories/issue/"}],"tags":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/tags/issue/"},{"name":"mac","slug":"mac","permalink":"https://liuzhihang.com/tags/mac/"},{"name":"brew","slug":"brew","permalink":"https://liuzhihang.com/tags/brew/"}]},{"title":"ã€å·¥ä½œç¬”è®°ã€‘- Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ","slug":"work/Spring è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆ","date":"2020-11-08T09:00:00.000Z","updated":"2020-11-18T07:57:19.092Z","comments":true,"path":"2020/11/08/spring-self-call.html","link":"","permalink":"https://liuzhihang.com/2020/11/08/spring-self-call.html","excerpt":"","text":"å‰è¨€ ç›¸ä¿¡å¤§å®¶éƒ½é‡åˆ°ä¸€ç§äº‹åŠ¡å¤±æ•ˆåœºæ™¯ï¼Œé‚£å°±æ˜¯ Spring è‡ªè°ƒç”¨ï¼Œå°±æ˜¯åœ¨ Service æ–¹æ³•å†…ï¼Œè°ƒç”¨å¦ä¸€ä¸ªåŠ  @Transactional æ³¨è§£çš„æ–¹æ³•ï¼Œå‘ç°äº‹åŠ¡å¤±æ•ˆï¼Œè¿™æ—¶å€™ä½ æ˜¯æ€ä¹ˆè§£å†³çš„å‘¢ï¼Ÿ äº‹æƒ…å›é¡¾é‚£æ˜¯ä¸€ä¸ªæˆ‘å¿˜äº†å¤©æ°”å’‹æ ·çš„ä¸‹åˆï¼Œçªç„¶è¹¦å‡ºä¸€ä¸ªå°çº¢ç‚¹ï¼Œå—¯~ æŒºç€æ€¥çš„å°çº¢ç‚¹ã€‚ åŸæ¥æ˜¯äº‹åŠ¡å¤±æ•ˆäº†ï¼ è«æ…Œï¼è«æ…Œï¼ æœ€åå°ä¼™ä¼´é€‰æ‹©äº†æŠ½èµ°ï¼Œæ˜¯æˆ‘çš„å·¥å…·ç±»ä¸é¦™äº†ä¹ˆï¼Ÿ å½“ç„¶æ•…äº‹çš„ç»“æœæ˜¯å®Œç¾çš„ï¼Œé—®é¢˜è§£å†³äº†ã€‚ äº‹åŠ¡åœ¨å¼€å‘ä¸­æ¶‰åŠåˆ°åŒæ—¶æ“ä½œå¤šä¸ªè¡¨çš„æ—¶å€™ï¼Œè¦ä¿è¯ä¸¤ä¸ªæ“ä½œè¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·å¤±è´¥ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°äº‹åŠ¡ã€‚ ç°åœ¨ä¸€èˆ¬ä½¿ç”¨çš„éƒ½æ˜¯åŸºäº @Transactional æ³¨è§£çš„å£°æ˜å¼äº‹åŠ¡ã€‚ è€Œäº‹åŠ¡ä½¿ç”¨è¿‡ç¨‹ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š äº‹åŠ¡åªèƒ½åº”ç”¨åˆ° public æ–¹æ³•ä¸Šæ‰ä¼šæœ‰æ•ˆï¼› äº‹åŠ¡éœ€è¦ä»å¤–éƒ¨è°ƒç”¨ï¼ŒSpring è‡ªè°ƒç”¨ä¼šå¤±æ•ˆï¼› å»ºè®®äº‹åŠ¡æ³¨è§£ @Transactional ä¸€èˆ¬æ·»åŠ åœ¨å®ç°ç±»ä¸Šã€‚ å½“ç„¶è¿™å‡ å¥è¯ä¸æ˜¯è¯´æˆ‘çš„ï¼Œäººå®¶å®˜æ–¹æ–‡æ¡£å¯æ˜¯æ˜ç¡®è¯´æ˜çš„ï¼ è¿™é‡Œå¯æ˜¯è¯´æ˜äº†åº”ä»…å°† @Transactional æ³¨è§£åº”ç”¨äºå…·æœ‰å…¬å¼€å¯è§æ€§çš„æ–¹æ³•ã€‚å¦‚æœå¯¹å— protected, private oæˆ– package-visible ä¿®é¥°çš„æ–¹æ³•ä½¿ç”¨ï¼Œåˆ™ä¸ä¼šå¼•å‘ä»»ä½•é”™è¯¯ï¼Œä½†æ˜¯è¢«æ³¨è§£çš„æ–¹æ³•ä¸ä¼šæ˜¾ç¤ºå·²é…ç½®çš„äº‹åŠ¡è®¾ç½®ã€‚ è¯´ç™½äº†ï¼Œå°±æ˜¯ä½ ç”¨äº†ï¼Œä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯ä¸ç”Ÿæ•ˆï¼ è‡³äºå»ºè®®åŠ åœ¨å®ç°ç±»ä¸Šï¼Œè¿™ä¸ªåªæ˜¯å»ºè®®ï¼Œä¸è¿‡å¦‚æœåŠ åœ¨æ¥å£ç±»æˆ–æ¥å£æ–¹æ³•ä¸Šæ—¶ï¼Œåªæœ‰é…ç½®åŸºäºæ¥å£çš„ä»£ç†æ‰ä¼šç”Ÿæ•ˆã€‚æ‰€ä»¥è¿™å—è¿˜æ˜¯è€è€å®å®çš„åŠ åœ¨å®ç°ç±»æˆ–å®ç°ç±»æ–¹æ³•ä¸Šå§ã€‚ å› ä¸ºä»£ç†æ¨¡å¼åªæ‹¦æˆªé€šè¿‡ä»£ç†ä¼ å…¥çš„å¤–éƒ¨æ–¹æ³•è°ƒç”¨ï¼Œæ‰€ä»¥è‡ªè°ƒç”¨äº‹åŠ¡æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚ å®˜æ–¹çš„è§£é‡Šè¿˜æ˜¯æ¯”è¾ƒç®€å•æ˜äº†çš„ï¼Œè™½ç„¶æˆ‘çœ‹ä¸æ‡‚ï¼Œä½†æ˜¯ä¸å½±å“æˆ‘æˆªå›¾ã€‚ é‚£æˆ‘è¿˜æ˜¯å†æˆªä¸€ä¸ªå§â€¦â€¦ å®é™…ä½¿ç”¨ä½†æ˜¯åœ¨å¼€å‘ä¸­ï¼Œå°ä¼™ä¼´ä»¬å¾€å¾€ä¼šé‡åˆ°è¿™ç§æƒ…å†µï¼ æœ¬æ¥è‡ªå·±å†™çš„ä»£ç å°±ä¸€å¨å¨çš„åˆè‡­åˆé•¿ï¼Œé‡Œé¢æœ‰å„ç§éªŒç­¾ã€éªŒå‚ã€æŸ¥è¯¢ã€éªŒè¯ç­‰ç­‰ï¼Œå°±æƒ³ç€æ¥ä¸ªäº‹åŠ¡ï¼Œè®©äº‹åŠ¡åŒ…è£¹çš„èŒƒå›´æœ€å°ï¼Œä»…ä»…åœ¨åŒæ—¶æ›´æ–°çš„æ—¶å€™åŠ ä¸Šäº‹åŠ¡å§ï¼ è¿™ä¹ˆå†™ï¼Œå’¦~ IDEA æŠ¥é”™äº†ï¼Œå¥½åƒä¸èƒ½ private ä¿®é¥°ï¼Œé‚£æˆ‘æ”¹æˆ publicã€‚ å¾ˆæ˜¾ç„¶äº‹åŠ¡æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚ æŠŠæ›´æ–°çš„ä»£ç æ”¾åˆ°åˆè‡­åˆé•¿çš„ä»£ç é‡Œé¢ï¼Œè®©å®ƒå˜å¾—æ›´è‡­æ›´é•¿ï¼Œç„¶åç”¨ @Transactional æ³¨è§£ä¸€åŠ ã€‚å®Œç¾è§£å†³ï¼ è¯·æ”¾è¿‡é‚£å¨ä»£ç å§ï¼æ¥çœ‹çœ‹ä¸‹é¢çš„åŠæ³•ã€‚ è§£å†³æ–¹æ¡ˆ 1 é‚£æˆ‘æ”¹æˆå¤–éƒ¨è°ƒç”¨ä¸å°±è¡Œäº†ä¹ˆï¼Ÿ å†å£°æ˜ä¸€ä¸ª Serviceï¼ŒæŠŠæ›´æ–°è¡¨çš„é€»è¾‘æ”¾è¿‡å»ã€‚ æˆ‘ä¸€èˆ¬å°±å–œæ¬¢ä½¿ç”¨è¿™ä¸ªåŠæ³•ã€‚ è§£å†³æ–¹æ¡ˆ 2ä½¿ç”¨ç¼–ç¨‹å¼äº‹åŠ¡ï¼Œå‰é¢è¯´äº†ï¼Œä½¿ç”¨å£°æ˜å¼äº‹åŠ¡æ—¶ï¼Œåˆè¿™åˆé‚£ï¼Œæˆ‘æ¢ä¸€ç§æ€»å¯ä»¥å§ï¼ ä½ çœ‹ï¼Œæˆ‘è¿˜æŠŠæ–¹æ³•æ”¹æˆ private ä¿®é¥°äº†ï¼Œäº‹åŠ¡ä¹Ÿç”Ÿæ•ˆã€‚å®Œç¾è§£å†³ï¼ å…¶å®è¿™ä¸ªæ–¹æ³•ä¹Ÿå¾ˆä¸é”™å“¦ï¼ è§£å†³æ–¹æ¡ˆ 3åˆæƒ³ç”¨æ³¨è§£ï¼Œåˆæƒ³è‡ªè°ƒç”¨æ€ä¹ˆåŠï¼Ÿ ä¸è¿‡â€¦ éº»çƒ¦ä¸€ç‚¹è¿˜æ˜¯å¯ä»¥çš„ã€‚ å’±ä»¬å¯ä»¥å‚è€ƒç¼–ç¨‹å¼äº‹åŠ¡çš„æ–¹å¼ï¼Œä¸å°±æ˜¯ä¸è®©è‡ªè°ƒç”¨ä¹ˆï¼Œæˆ‘è°ƒå¤–éƒ¨æ–¹æ³•ï¼Œç„¶åå¤–éƒ¨æ–¹æ³•å†ç»™æˆ‘è°ƒå›æ¥ä¸å°±å¯ä»¥äº†ã€‚ @Componentpublic class TransactionalComponent &#123; public interface Cell &#123; void run() throws Exception; &#125; @Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class) public void required(Cell cell) throws Exception &#123; cell.run(); &#125;&#125; è¿™æ ·çš„è¯ä¸å°±å¯ä»¥é€šè¿‡ TransactionalComponent è°ƒç”¨äº†ä¹ˆï¼Œå¹¶ä¸”è¿˜å¯ä»¥ä½¿ç”¨ lambda è¡¨è¾¾å¼ã€‚ å½“ç„¶åŸºäºè¿™ä¸ªç‰ˆæœ¬ä¹Ÿå¯ä»¥åšä¸€ä¸ªè¿­ä»£ï¼Œå°±æ˜¯ä½¿ç”¨é™æ€æ–¹æ³•è°ƒç”¨ï¼Œä¸ç”¨æ¯æ¬¡éƒ½ç”¨ @Autowired æ³¨å…¥ä¸€æ¬¡ã€‚ public class TransactionalUtils &#123; private static volatile TransactionalComponent transactionalComponent; private static synchronized TransactionalComponent getTransactionalComponent() &#123; if (transactionalComponent == null) &#123; // ä»å®¹å™¨ä¸­è·å– transactionalComponent transactionalComponent = ApplicationContextUtils.getBean(TransactionalComponent.class); &#125; return transactionalComponent; &#125; public static void required(TransactionalComponent.Cell cell) throws Exception &#123; getTransactionalComponent().required(cell); &#125;&#125; è¿™æ ·é€šè¿‡å·¥å…·ç±» TransactionalUtils ä¾¿å¯ä»¥ç›´æ¥è°ƒç”¨é™æ€æ–¹æ³•çš„æ–¹å¼æ‰§è¡Œäº‹åŠ¡æ“ä½œã€‚ æ€»ç»“ç»“æŸè¯­æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸ºä»€ä¹ˆä¼šé‡åˆ°äº‹åŠ¡å¤±æ•ˆï¼Œä»¥åŠäº‹åŠ¡å¤±æ•ˆçš„é¿å…æ–¹å¼ï¼ŒåŒæ—¶æä¾›äº†ä¸‰ç§æ–¹å¼æ¥è§£å†³è‡ªè°ƒç”¨äº‹åŠ¡å¤±æ•ˆçš„é—®é¢˜ã€‚ä¸è¶³ä¹‹å¤„ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚ ç›¸å…³èµ„æ–™ Spring æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-framework/docs/5.3.0/reference/html/data-access.html#transaction-declarative-annotations","categories":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"}]},{"title":"ã€å·¥å…·å†Œã€‘- å†™æ–‡æ¡£å¤ªéº»çƒ¦ï¼Œè¯•è¯•è¿™æ¬¾ IDEA æ’ä»¶å§ï¼","slug":"tool/docview-1 æ’ä»¶å‘å¸ƒ","date":"2020-11-01T07:00:00.000Z","updated":"2020-11-23T11:50:53.094Z","comments":true,"path":"2020/11/01/doc-view.html","link":"","permalink":"https://liuzhihang.com/2020/11/01/doc-view.html","excerpt":"","text":"å‰è¨€ æ¯æ¬¡å¼€å‘å®Œæ–°é¡¹ç›®æˆ–è€…æ–°æ¥å£åŠŸèƒ½ç­‰ï¼Œç¬¬ä¸€ä»¶äº‹å°±æ˜¯æä¾›æ¥å£æ–‡æ¡£ã€‚è¯´åˆ°æ¥å£æ–‡æ¡£ï¼Œå½“ç„¶æ˜¯ç”¨ Markdown äº†ã€‚å„ç§å¤åˆ¶ç²˜è´´å­—æ®µï¼Œå¿…å¡«éå¿…å¡«ï¼Œå­—æ®µå¤‡æ³¨ï¼Œè¯·æ±‚è¿”å›ç¤ºä¾‹ç­‰ç­‰ã€‚ç®€ç›´æ˜¯æµªè´¹æ—¶é—´å“‡ã€‚æ‰€ä»¥æƒ³åˆ°äº†å¼€å‘ä¸€æ¬¾æ’ä»¶æ¥è§£å†³é‡å¤å¤åˆ¶æ–‡æ¡£çš„é—®é¢˜ã€‚ä¸‹é¢æ¥çœ‹æˆ‘ä»‹ç»ä»‹ç»è¿™æ¬¾æ’ä»¶ã€‚ PSï¼šæ’ä»¶æ¯”è¾ƒç®€é™‹ï¼Œè¿˜éœ€è¦ä¸æ–­è¿­ä»£ã€‚ ä¸ºä»€ä¹ˆå¼€å‘æ’ä»¶æ¯æ¬¡åœ¨å¯¹å¤–æä¾›æ¥å£æ—¶éƒ½è¦å†™æ–‡æ¡£ï¼Œå„ç§éº»çƒ¦ï¼Œå¹¶ä¸”æ–‡æ¡£è€—è´¹äº†å¾ˆå¤§ä¸€éƒ¨åˆ†æ—¶é—´ã€‚ä¹Ÿä½¿ç”¨äº†ä¸€äº›æ–‡æ¡£å·¥å…·ï¼Œåœ¨çº¿å†™ä½œå·¥å…·ï¼Œæœ€ç»ˆè¿˜æ˜¯æ¯”è¾ƒå–œæ¬¢è‡ªå·±æ‰‹å†™æ–‡æ¡£ã€‚ ä½¿ç”¨è¿‡çš„ç”Ÿæˆå·¥å…· Swagger ï¼š æ·»åŠ ä¾èµ–ï¼Œé…ç½®ç±»åŠæè¿°ä¿¡æ¯ï¼Œç„¶ååœ¨æ–¹æ³•åŠå®ä½“ä¸Šæ·»åŠ æ³¨è§£ï¼Œå¯åŠ¨é¡¹ç›®ä¾¿å¯ä»¥é€šè¿‡è®¿é—® xxxx/swagger-ui.html æŸ¥çœ‹æ¥å£æ–‡æ¡£ï¼› API Doc ï¼šæ·»åŠ é…ç½®æ–‡ä»¶åŠæ³¨é‡Šï¼Œå®‰è£… npm å¹¶é€šè¿‡æ‰§è¡Œå‘½ä»¤ç”Ÿæˆæ–‡æ¡£ï¼› SmartDoc ï¼šæ·»åŠ ä¾èµ–åŠæ³¨é‡Šåæ‰§è¡Œæµ‹è¯•ç±»ç”Ÿæˆæ–‡æ¡£ï¼› API2DOC ï¼šæ·»åŠ ä¾èµ–ï¼Œå¼€å¯æ³¨è§£ï¼Œé€šè¿‡æ³¨è§£é…ç½®ç”Ÿæˆæ–‡æ¡£ã€‚ ä¸Šé¢å››ç§æ–¹æ³•ï¼Œæ— ç–‘éƒ½éœ€è¦æ·»åŠ ä¾èµ–ï¼Œä½¿ç”¨æ³¨è§£ç­‰æ–¹å¼ï¼Œå¯ä»¥è¯´æœ‰ä¸€å®šçš„ä»£ç ä¾µå…¥æ€§ã€‚ ä½¿ç”¨è¿‡çš„æ¥å£æ–‡æ¡£å·¥å…· ShowDoc ï¼šæ›¾ç»ä¸€æ®µæ—¶é—´å¾ˆå–œæ¬¢ç”¨è¿™ä¸ªï¼Œ Markdown è¯­æ³•ï¼Œæ–¹ä¾¿ç›´è§‚ã€‚ä¸è¿‡å°±æ˜¯è¦è‡ªå·±æ‰‹å†™ï¼› YApi ï¼šç°åœ¨åœ¨ä½¿ç”¨ YApiï¼Œå¯ä»¥é€šè¿‡ Swagger å¯¼å…¥ï¼› VS Code å†™ Markdown ï¼šç›´æ¥ç¦»çº¿å†™ Markdown ï¼Œå¯ä»¥å¯¼å‡º PDFã€Wordã€Htmlã€‚ è‡ªå·±å†™æ–‡æ¡£æ¯”è¾ƒé‡å¤ï¼Œç¹çï¼Œä¸è¿‡ä¸ªäººæ¯”è¾ƒå–œæ¬¢ Markdown æ ¼å¼ã€‚ç®€æ´ç›´è§‚ã€‚å¹¶ä¸”é…åˆç€æˆ‘ä¹‹å‰å†™çš„ IDEA æ’ä»¶ copy-as-json å’Œ Tookit å°†å®ä½“å¤åˆ¶ä¸º json å­—ç¬¦ä¸²ï¼Œç”¨æ¥å¿«é€Ÿç”Ÿæˆè¯·æ±‚æ ·ä¾‹å’Œè¿”å›æ ·ä¾‹ï¼Œè¿˜æ˜¯å¯ä»¥å‡å°‘ä¸€å®šçš„å·¥ä½œé‡çš„ã€‚ å…¶ä»–ä½¿ç”¨æ–¹å¼ä½¿ç”¨å„ç§åœ¨çº¿åä½œå·¥å…·ï¼Œè…¾è®¯æ–‡æ¡£ã€è¯­é›€ã€çŸ³å¢¨æ–‡æ¡£ã€‚ä½¿ç”¨ç¦»çº¿ç‰ˆæœ¬ PDFã€Wordã€Excel ç­‰ç­‰ã€‚ä¹Ÿæœ‰ä¸€äº›å…¶ä»–çš„æ–‡æ¡£å·¥å…·ï¼Œä¸è¿‡è‡ªå·±éƒ½æ²¡æœ‰ä½¿ç”¨è¿‡æˆ–è€…è°ƒç ”è¿‡äº†ã€‚ åŸºæœ¬ä¸Šè¿™äº›æ–‡æ¡£å·¥å…·è¦ä¹ˆé€šè¿‡ä»£ç ä¾µå…¥çš„æ–¹å¼ç”Ÿæˆæ–‡æ¡£ï¼Œè¦ä¹ˆè‡ªå·±æ‰‹æ’¸æ–‡æ¡£ã€‚æ€»ä½“æ¥è¯´å„æœ‰åƒç§‹ã€‚ ä¸ªäººæ‰‹å†™æ›´æ–¹ä¾¿ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„å°±æ˜¯æ‰‹å†™ Markdown ã€‚ ä¸‹é¢æ˜¯ä¸¤å¹…å›¾ï¼š æœ‰æ—¶å€™æ–‡æ¡£æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œå°±å†™çš„ç´¯äº†ã€‚å°¤å…¶æ˜¯æœ€è¿‘ä½¿ç”¨äº† YApi ï¼Œ ä¸ªäººæ„Ÿè§‰ä½¿ç”¨ Swagger ç„¶åå¯¼å…¥åˆ° YApi é‡Œé¢è¿˜æ˜¯æŒºæ–¹ä¾¿çš„ï¼Œçœæ—¶çœåŠ›ã€‚ åæ¥å°±æƒ³ï¼Œæ—¢ç„¶ YApi æä¾›æ¥å£ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥è‡ªå·±ç”Ÿæˆï¼Œç„¶åä¼ åˆ° YApi ä¸­å‘¢ï¼Ÿ æ‰€ä»¥å°±å¼€å§‹ç€æ‰‹è¿™ä¸ªæ’ä»¶çš„å¼€å‘ã€‚ ä½¿ç”¨åŠåŠŸèƒ½æ—¢ç„¶å·²ç»å¼€å‘å¥½æœ€åŸºç¡€ç‰ˆæœ¬äº†ï¼Œå½“ç„¶ä¹Ÿå¾—ä»‹ç»ä¸‹ï¼Œé¦–å…ˆçœ‹å›¾ï¼š é€šè¿‡å›¾ç®€å•ä»‹ç»ä¸‹ä½¿ç”¨ä»¥åŠåŠŸèƒ½ï¼š ä½¿ç”¨ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼Œç›´æ¥åœ¨ Controller ç±»æˆ–è€… Controller ç±»çš„å…¬å…±éé™æ€æ–¹æ³•å†…å³é”®å”¤å‡ºèœå•ï¼Œå•æœº Doc View å³å¯ã€‚ åªèƒ½åœ¨ Controller ç±»æˆ–è€… Controller ç±»çš„å…¬å…±éé™æ€æ–¹æ³•å†…ä½¿ç”¨ã€‚è‡³äºä¸¤è€…çš„åŒºåˆ«ï¼Œåç»­ä¼šä»‹ç»ã€‚ è¿™é‡Œå¯èƒ½ä¼šæœ‰å°ä¼™ä¼´ä»¬å‘å‡ºç–‘é—®ï¼šDubbo æ¥å£ä¹Ÿè¦å†™æ–‡æ¡£ï¼Œéš¾é“ä¸å¯ä»¥ä¹ˆï¼Ÿ å—¯~ å¯ä»¥ï¼ä½†æ˜¯ç°åœ¨ä¸æ”¯æŒ~ åŠŸèƒ½åŸºæœ¬åŠŸèƒ½å°±æ˜¯æˆªå›¾å±•ç¤ºçš„é‚£æ ·ã€‚ å·¦ä¾§æ˜¾ç¤ºæ¥å£ååŠåˆ—è¡¨ï¼Œå³ä¾§å±•ç¤ºæ¥å£ä¿¡æ¯ï¼› ç‚¹å‡» Copy æŒ‰é’® å°±ä¼šå°†å±•ç¤ºçš„ä¿¡æ¯åŸæœ¬å¯¹åº”çš„ Markdown æ–‡æœ¬å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼› åœ¨ Class å†…éƒ¨ç‚¹å‡»ï¼Œç”Ÿæˆçš„å¦‚å›¾æ‰€ç¤ºçš„åˆ—è¡¨ï¼Œè€Œåœ¨æ–¹æ³•å†…å³é”®ç”Ÿæˆçš„æ˜¯åªæœ‰æœ¬æ–¹æ³•çš„ã€‚ ä½¿ç”¨è¯´æ˜Dubbo æ¥å£ï¼Œå½“å‰ç‰ˆæœ¬ä¸æ”¯æŒï¼Œæ‰€ä»¥ä¸‹é¢ä»‹ç»çš„å…¨éƒ½æ˜¯åœ¨ Class ä¸Šçš„ä½¿ç”¨ï¼š è¦ç”Ÿæˆæ–‡æ¡£ï¼Œéœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼Ÿ ç›®æ ‡ç±»å†…éƒ¨æœ‰æ–¹æ³•ï¼› ç±»å¿…é¡»æœ‰ç›¸å…³ Spring æ³¨è§£ã€‚ org.springframework.stereotype.Controller org.springframework.web.bind.annotation.RestController ç”Ÿæˆæ–‡æ¡£ï¼Œæ¥å£æ–¹æ³•éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼Ÿæ–‡æ¡£çš„æ–¹æ³•ï¼šPublic ä¿®é¥°ä¸”éé™æ€æ–¹æ³•ï¼ˆstatic ä¿®é¥°ï¼‰ï¼Œæ–¹æ³•ä¸ŠåŒ…å«ä»¥ä¸‹æ³¨è§£ï¼š org.springframework.web.bind.annotation.GetMapping org.springframework.web.bind.annotation.PostMapping org.springframework.web.bind.annotation.GetMapping org.springframework.web.bind.annotation.DeleteMapping org.springframework.web.bind.annotation.PatchMapping org.springframework.web.bind.annotation.RequestMapping æ–‡æ¡£æ¨¡ç‰ˆæ˜¯å¦å¯ä»¥è®¾ç½®ï¼Ÿå½“å‰ç‰ˆæœ¬æ–‡æ¡£æ¨¡ç‰ˆåªæœ‰å±•ç¤ºçš„è¿™ä¸ªï¼Œä¸æ”¯æŒè‡ªå®šä¹‰æ¨¡ç‰ˆã€‚ æ¥å£åç§°æ˜¯å¦‚ä½•è®¾ç½®çš„ï¼Ÿ æ¥å£åç§°é»˜è®¤å–å€¼å¦‚å›¾æˆªå›¾æ‰€ç¤º ç±»å#æ–¹æ³•åï¼› æ”¯æŒåœ¨æ³¨é‡Šä¸Šä½¿ç”¨ @name è®¾ç½®æ¥å£åã€‚ æ¥å£æè¿°æ˜¯ä»å“ªé‡Œè·å–çš„ï¼Ÿ æ¥å£æè¿°ç›´æ¥å–çš„æ–¹æ³•æ³¨é‡Šï¼› å¦‚æœæœ‰ @description æ ‡ç­¾ï¼Œåˆ™ä¼šä¼˜å…ˆä½¿ç”¨æ ‡ç­¾å¯¹åº”çš„æè¿°ã€‚ è¯·æ±‚è·¯å¾„æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿå– Class å’Œ Method ä¸Šçš„ path è¿›è¡Œæ‹¼è£…ç»„æˆã€‚ è¯·æ±‚æ–¹å¼å¦‚ä½•è®¾ç½®ï¼Ÿæ ¹æ® Method ä¸Šçš„æ³¨è§£ç”Ÿæˆã€‚ è¯·æ±‚å‚æ•°åŠè¯·æ±‚ç¤ºä¾‹çš„éœ€è¦è®¾ç½®ä»€ä¹ˆï¼Ÿ æ ¹æ®æ˜¯å¦æœ‰ @RequestBody æ³¨è§£ï¼Œç”Ÿæˆè¯·æ±‚ Header æ˜¯å¦ä¸º json è¿˜æ˜¯ formã€‚åŒæ—¶ä¼šæ£€æµ‹è¯·æ±‚å‚æ•°ä¸­æ˜¯å¦æœ‰ @RequestHeader æ³¨è§£ï¼› å¯¹è±¡ç”Ÿæˆåˆ—è¡¨ï¼› æ ¹æ®è¯·æ±‚æ˜¯ json è¿˜æ˜¯ form ç”Ÿæˆå¯¹åº”çš„è¯·æ±‚ç¤ºä¾‹ã€‚ è¿”å›å‚æ•°åŠè¿”å›ç¤ºä¾‹æ€ä¹ˆç”Ÿæˆï¼Ÿæ”¯æŒå¯¹è±¡ï¼Œè¿”å›ç©ºï¼Œè¿”å›å¸¦æ³›å‹æ–¹å¼ã€‚è¿™é‡Œçš„æ³›å‹ä»…æ”¯æŒå•ä¸ªæ³›å‹ä¸”åç§°ä¸º Tã€‚ æ€»ç»“Q&amp;AQ: Doc View æ’ä»¶å»å“ªé‡Œä¸‹è½½ï¼Ÿ A: å¯ä»¥ç›´æ¥é€šè¿‡ IDEA æ’ä»¶ä»“åº“ï¼Œç›´æ¥æœç´¢åç§°å³å¯ï¼› åœ¨ GitHub é€šè¿‡ Releases ä¸‹è½½ï¼› å…³æ³¨å…¬ä¼—å·å¹¶å‘é€ Doc View ç›¸å…³å…³é”®å­—ï¼ˆdoc/doc viewï¼‰è·å–ã€‚ Q: Doc View æ˜¯å¦å¼€æºï¼Ÿ A: æ˜¯çš„ã€‚å¼€æºåœ°å€ä¸ºï¼šhttps://github.com/liuzhihang/doc-viewï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´ï¼Œå¯ä»¥ç»™ä¸ª Star ï¼Œå¦‚æœæƒ³å¢åŠ ä¸€äº›åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥æ PRã€‚ ç»“æŸè¯­æ’ä»¶å¼€å‘ä»æœ€å¼€å§‹å¼€å‘åˆ°ä»Šå¤©å‘å¸ƒç¬¬ä¸€ç‰ˆï¼Œä¸­é—´ç»å†äº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œæ¯•ç«Ÿåªæ˜¯ä¸šä½™æ—¶é—´å¼€å‘ï¼Œå°±æ–­æ–­ç»­ç»­çš„å†™ï¼Œä¸è¿‡ç°åœ¨æœ€ç®€å•ç‰ˆæœ¬å·²ç»å¯ä»¥ä½¿ç”¨äº†ã€‚ ç›®å‰æ¥çœ‹ï¼Œåªæœ‰ä¸€ä¸ª Copy åŠŸèƒ½ï¼Œä¸è¿‡åŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³ä½¿ç”¨ã€‚è‡³äºå…¶ä»–çš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼šè‡ªå®šä¹‰æ¨¡ç‰ˆã€æ”¯æŒ Dubbo æ¥å£ã€é¢„è§ˆå¯¼å‡ºç­‰åŠŸèƒ½å°±éœ€è¦åç»­ä¸æ–­è¿­ä»£äº†ã€‚ ä¸ªäººå¼€å‘ç²¾åŠ›æœ‰é™ï¼Œå°ä¼™ä¼´åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°è‚¯å®šä¼šé‡åˆ° bugï¼Œæˆ–è€…æ˜¯æœ‰å…¶ä»–çš„åŠŸèƒ½åŠä½¿ç”¨å»ºè®®ï¼Œéƒ½å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åé¦ˆï¼š å…³æ³¨å…¬ä¼—å·ï¼šã€ åˆ˜å¿—èˆª ã€ é€šè¿‡è¯»è€…è®¨è®ºè¿›è¡Œç•™è¨€ï¼› åœ¨ GitHub ä¸Šæ Issuesï¼› åœ¨æ’ä»¶å¸®åŠ©é¡µé¢ç•™è¨€ï¼› æ–‡ç« ç»“å°¾ç•™è¨€ï¼› æœ€åï¼Œæ„Ÿè°¢å°ä¼™ä¼´ä»¬çš„æ”¯æŒã€‚æ¬¢è¿ä¸‹è½½ä½“éªŒï¼Œå¹¶æå‡ºç›¸å…³å»ºè®®åŠæ„è§ã€‚","categories":[{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/"},{"name":"Doc View","slug":"å·¥å…·å†Œ/Doc-View","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/Doc-View/"}],"tags":[{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E5%85%B7%E5%86%8C/"},{"name":"Doc View","slug":"Doc-View","permalink":"https://liuzhihang.com/tags/Doc-View/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- å†™æ—¶å¤åˆ¶é›†åˆ â€”â€” CopyOnWriteArrayList","slug":"source-code/java/CopyOnWriteArrayList","date":"2020-10-31T02:00:00.000Z","updated":"2020-11-18T07:57:19.126Z","comments":true,"path":"2020/10/31/copyonwritearraylist.html","link":"","permalink":"https://liuzhihang.com/2020/10/31/copyonwritearraylist.html","excerpt":"","text":"å‰è¨€ JUC ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªç³»åˆ—çš„ç±»ï¼Œéƒ½æ˜¯ CopyOnWriteXXX ï¼Œæ„æ€æ˜¯å†™æ—¶å¤åˆ¶ï¼Œè¿™ä¸ªç©¶ç«Ÿæ˜¯æ€ä¹ˆå›äº‹ï¼Ÿé‚£å°±ä»¥ CopyOnWriteArrayList ä¸ºåˆ‡å…¥ç‚¹ï¼Œä¸€èµ·äº†è§£å†™æ—¶å¤åˆ¶æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ ä»‹ç»ArrayList çš„ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å˜ä½“ï¼Œå…¶ä¸­æ‰€æœ‰å¯å˜æ“ä½œï¼ˆaddã€set ç­‰ç­‰ï¼‰éƒ½æ˜¯é€šè¿‡å¯¹åº•å±‚æ•°ç»„è¿›è¡Œä¸€æ¬¡æ–°çš„å¤åˆ¶æ¥å®ç°çš„ã€‚ åƒåå­—ä¸€æ ·ï¼Œæ¯æ¬¡è¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œéƒ½ä¼šè¿›è¡Œä¸€æ¬¡å¤åˆ¶ï¼Œå½“ç„¶ä¼šæœ‰å¾ˆå¤§çš„æ€§èƒ½æ¶ˆè€—ï¼Œä½†æ˜¯åœ¨æŸäº›ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œåˆä¼šæé«˜æ€§èƒ½ã€‚å…·ä½“æ˜¯æ€ä¹ˆæ“ä½œçš„ï¼Œé‚£å°±ä¸€æ­¥ä¸€æ­¥é˜…è¯»æºç ï¼Œç„¶åå†åšæ€»ç»“å½’çº³ã€‚ åŸºæœ¬ä½¿ç”¨public class CopyOnWriteArrayListTest &#123; public static void main(String[] args) &#123; CopyOnWriteArrayList&lt;String&gt; list = new CopyOnWriteArrayList&lt;&gt;(); // æ·»åŠ å…ƒç´  list.add(&quot;liuzhihang&quot;); // ç§»é™¤å…ƒç´  list.remove(&quot;liuzhihang&quot;); // æŸ¥çœ‹å…ƒç´  String value0 = list.get(0); // éå† Iterator&lt;String&gt; iterator = list.iterator(); while (iterator.hasNext()) &#123; String next = iterator.next(); &#125; &#125;&#125; é—®é¢˜ç–‘é—® ä¸ºä»€ä¹ˆè¦å«å†™æ—¶å¤åˆ¶é›†åˆï¼Ÿ CopyOnWriteArrayList å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ CopyOnWriteArrayList å’Œ ArrayList æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ CopyOnWriteArrayList å¤åˆ¶æ˜¯æ€ä¹ˆè¿›è¡Œå¤åˆ¶çš„ï¼Ÿ æºç åˆ†æåŸºæœ¬ç»“æ„ å‚æ•°ä»‹ç»public class CopyOnWriteArrayList&lt;E&gt; implements List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable &#123; private static final long serialVersionUID = 8673264195747942595L; /** æ•°æ®æœ‰å˜åŠ¨æ—¶ä½¿ç”¨ */ final transient ReentrantLock lock = new ReentrantLock(); /** æ•°ç»„ åªèƒ½é€šè¿‡ getArray/setArray è®¿é—® */ private transient volatile Object[] array; final Object[] getArray() &#123; return array; &#125; // å°†æ•°ç»„æŒ‡å‘ä¼ å…¥çš„æ–°æ•°ç»„ final void setArray(Object[] a) &#123; array = a; &#125;&#125; é€šè¿‡å‚æ•°å¯ä»¥äº†è§£åˆ°ä»¥ä¸‹å†…å®¹ï¼š åŸºäºæ•°ç»„å®ç°ï¼› ä½¿ç”¨äº† ReentrantLock äº’æ–¥é”ã€‚ æ„é€ å‡½æ•°public CopyOnWriteArrayList() &#123; setArray(new Object[0]);&#125; åœ¨åˆå§‹åŒ– CopyOnWriteArrayList æ—¶ï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª Object çš„æ•°ç»„ã€‚ addpublic boolean add(E e) &#123; // åŠ é” final ReentrantLock lock = this.lock; lock.lock(); try &#123; // è·å–å½“å‰æ•°ç»„ Object[] elements = getArray(); int len = elements.length; // åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œå¹¶å°†åŸæ•°ç»„æ•°æ®å¤åˆ¶åˆ°æ–°æ•°ç»„ Object[] newElements = Arrays.copyOf(elements, len + 1); // æ·»åŠ çš„æ–°å…ƒç´ åˆ°æ•°ç»„å°¾éƒ¨ newElements[len] = e; // å°†æ•°ç»„æŒ‡å‘æ–°æ•°ç»„ setArray(newElements); return true; &#125; finally &#123; lock.unlock(); &#125;&#125; add æ–¹æ³•é€»è¾‘å¾ˆç®€å•ï¼š é€šè¿‡åŠ äº’æ–¥é”ï¼ˆReentrantLockï¼‰ä»è€Œä¿è¯åœ¨å†™çš„æ—¶å€™åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å†™ã€‚ æ–°å¢å…ƒç´ æ—¶ï¼Œå…ˆä½¿ç”¨ Arrays.copyOf(elements, len + 1) å¤åˆ¶å‡ºä¸€ä¸ªé•¿åº¦ +1 çš„æ–°æ•°ç»„ã€‚ æ·»åŠ å…ƒç´ åˆ°æ–°æ•°ç»„ã€‚ ç„¶åå†å°†åŸæ•°ç»„å¯¹è±¡æŒ‡å‘æ–°æ•°ç»„ã€‚ ç”»å›¾å¦‚ä¸‹ï¼š removepublic E remove(int index) &#123; // åŠ é” final ReentrantLock lock = this.lock; lock.lock(); try &#123; // åŸæ•°ç»„ Object[] elements = getArray(); int len = elements.length; // ç§»é™¤çš„å€¼ E oldValue = get(elements, index); int numMoved = len - index - 1; if (numMoved == 0) // å¦‚æœç§»é™¤æœ€åä¸€ä¸ªå…ƒç´  // ç›´æ¥å¤åˆ¶å‰é¢çš„å…ƒç´ å³å¯ setArray(Arrays.copyOf(elements, len - 1)); else &#123; // ç§»é™¤ä¸­é—´çš„å…ƒç´ ï¼Œè¿›è¡Œä¸¤æ¬¡å¤åˆ¶ Object[] newElements = new Object[len - 1]; System.arraycopy(elements, 0, newElements, 0, index); System.arraycopy(elements, index + 1, newElements, index, numMoved); setArray(newElements); &#125; return oldValue; &#125; finally &#123; lock.unlock(); &#125;&#125; remove æ–¹æ³•ç›¸å¯¹å¤šäº†ä¸€äº›åˆ¤æ–­ï¼š é€šè¿‡åŠ äº’æ–¥é”ï¼ˆReentrantLockï¼‰ä»è€Œä¿è¯åœ¨å†™çš„æ—¶å€™åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç§»é™¤å…ƒç´ ã€‚ å¦‚æœç§»é™¤çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåˆ™ç›´æ¥å¤åˆ¶å‰é¢çš„å…ƒç´ åˆ°æ–°æ•°ç»„ï¼Œå¹¶æŒ‡å‘æ–°æ•°ç»„å³å¯ã€‚ å¦‚æœç§»é™¤çš„æ˜¯ä¸­é—´çš„å…ƒç´ ï¼Œåˆ™éœ€è¦è¿›è¡Œä¸¤æ¬¡å¤åˆ¶ï¼Œç„¶åæŒ‡å‘æ–°æ•°ç»„ã€‚ ç”»å›¾å¦‚ä¸‹ï¼š getpublic E get(int index) &#123; return get(getArray(), index);&#125; get æ–¹æ³•å¯ä»¥çœ‹å‡ºï¼š è·å–å…ƒç´ å¹¶æ²¡æœ‰è¿›è¡ŒåŠ é”ã€‚ ä»åŸæ•°ç»„è·å–çš„å…ƒç´ ã€‚ æ‰€ä»¥å¹¶å‘æƒ…å†µä¸‹ï¼Œå¹¶ä¸èƒ½ä¿è¯å¾ˆåŠæ—¶çš„è¯»å–çš„åˆšæ’å…¥æˆ–è€…ç§»é™¤çš„å…ƒç´ ã€‚ æ•°ç»„å¤åˆ¶é€šè¿‡é˜…è¯» add å’Œ remove ç›¸å…³ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åœ¨æ•°ç»„å¤åˆ¶æ—¶ä½¿ç”¨äº† Arrays.copyOf å’Œ System.arraycopyï¼Œè¿™ç›¸å½“äºä¸€ä¸ªä¼˜åŒ–æ–¹é¢å§ã€‚ æ¯•ç«Ÿæ•°ç»„å¤åˆ¶æ€»ä¸èƒ½æŠŠåŸæ•°ç»„éå†ä¸€éï¼ŒæŒ¨ç€èµ‹å€¼åˆ°æ–°æ•°ç»„é‡Œé¢å§ã€‚ é‚£æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼š public class Arrays &#123; // å…¶ä»–æ–¹æ³•çœç•¥ ... /** * original è¦å¤åˆ¶çš„æ•°ç»„ * newLength æ–°æ•°ç»„çš„é•¿åº¦ */ public static &lt;T&gt; T[] copyOf(T[] original, int newLength) &#123; return (T[]) copyOf(original, newLength, original.getClass()); &#125; /** * original è¦å¤åˆ¶çš„æ•°ç»„ * newLength æ–°æ•°ç»„çš„é•¿åº¦ */ public static &lt;T,U&gt; T[] copyOf(U[] original, int newLength, Class&lt;? extends T[]&gt; newType) &#123; // åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œé•¿åº¦æ˜¯æŒ‡å®šçš„é•¿åº¦ @SuppressWarnings(&quot;unchecked&quot;) T[] copy = ((Object)newType == (Object)Object[].class) ? (T[]) new Object[newLength] // åˆ›å»ºå…·æœ‰æŒ‡å®šçš„ç»„ä»¶ç±»å‹å’Œé•¿åº¦çš„æ–°æ•°ç»„ : (T[]) Array.newInstance(newType.getComponentType(), newLength); // è°ƒç”¨ System.arraycopy å¤åˆ¶æ•°ç»„ System.arraycopy(original, 0, copy, 0, Math.min(original.length, newLength)); return copy; &#125;&#125; é€šè¿‡é˜…è¯» Arrays.copyOf ç›¸å…³æºç ï¼Œå‘ç°å…¶å® Arrays.copyOf åº•å±‚ä¹Ÿæ˜¯è°ƒç”¨çš„ System.arraycopy public final class System &#123; // å…¶ä»–æ–¹æ³•çœç•¥ ... /** * src æºæ•°ç»„ * srcPos æºæ•°ç»„èµ·å§‹ä½ç½® * dest ç›®æ ‡æ•°ç»„ * destPos ç›®æ ‡æ•°ç»„çš„èµ·å§‹ä½ç½® * length è¦å¤åˆ¶çš„å…ƒç´ æ•°é‡ */ public static native void arraycopy(Object src, int srcPos, Object dest, int destPos, int length);&#125; å¯ä»¥çœ‹åˆ° System.arraycopy æ˜¯ä¸€ä¸ª native æ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯ JVM å†…éƒ¨å®ç°çš„ï¼Œå…·ä½“å¯ä»¥é˜…è¯»ç›¸å…³èµ„æ–™ã€‚è€Œä½¿ç”¨è¿™ç§æ–¹å¼è¦æ¯” for å¾ªç¯å’Œ clone è¦é«˜æ•ˆå¾ˆå¤šã€‚ æ€»ç»“Q&amp;AQ: ä¸ºä»€ä¹ˆè¦å«å†™æ—¶å¤åˆ¶é›†åˆï¼Ÿ A: å› ä¸ºåœ¨ addã€remove æ“ä½œæ—¶ä¼šå¤åˆ¶å‡ºæ¥ä¸€ä¸ªæ–°æ•°ç»„ã€‚ Q: CopyOnWriteArrayList å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ A: åœ¨ addã€remove æ“ä½œæ—¶ä¼šè¿›è¡ŒåŠ é”ï¼Œç„¶åå¤åˆ¶å‡ºæ¥ä¸€ä¸ªæ–°æ•°ç»„ï¼Œæ“ä½œçš„éƒ½æ˜¯æ–°æ•°ç»„ï¼Œè€Œæ­¤æ—¶åŸæ•°ç»„æ˜¯å¯ä»¥æä¾›æŸ¥è¯¢çš„ã€‚å½“æ“ä½œç»“æŸä¹‹åï¼Œä¼šå°†å¯¹è±¡æŒ‡é’ˆæŒ‡å‘æ–°æ•°ç»„ã€‚ Q: CopyOnWriteArrayList å’Œ ArrayList æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ A: CopyOnWriteArrayList åœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹å¯ä»¥æé«˜æ•ˆç‡ï¼Œè€Œ ArrayList åªæ˜¯æ™®é€šæ•°ç»„é›†åˆï¼Œå¹¶ä¸é€‚ç”¨äºå¹¶å‘åœºæ™¯ï¼Œè€Œå¦‚æœå¯¹ ArrayList åŠ é”ï¼Œåˆ™ä¼šå½±å“ä¸€éƒ¨åˆ†æ€§èƒ½ã€‚ åŒæ ·å¯¹ CopyOnWriteArrayList è€Œè¨€ï¼Œä»…èƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚å› ä¸ºåˆšå†™å…¥çš„æ•°æ®ï¼Œæ˜¯å†™åˆ°çš„å¤åˆ¶çš„æ•°ç»„ä¸­ï¼Œæ­¤æ—¶å¹¶ä¸èƒ½ç«‹å³æŸ¥è¯¢åˆ°ã€‚å¦‚æœè¦ä¿è¯å®æ—¶æ€§å¯ä»¥å°è¯•ä½¿ç”¨ Collections.synchronizedList æˆ–è€…åŠ é”ç­‰æ–¹å¼ã€‚ Q: CopyOnWriteArrayList å¤åˆ¶æ˜¯æ€ä¹ˆè¿›è¡Œå¤åˆ¶çš„ï¼Ÿ A: å†…éƒ¨ä½¿ç”¨çš„æ˜¯æœ¬åœ°æ–¹æ³• System.arraycopy è¿›è¡Œæ•°ç»„çš„å¤åˆ¶ã€‚ ç»“æŸè¯­é€šè¿‡é˜…è¯» CopyOnWriteArrayList æºç ï¼Œäº†è§£åˆ°å†™æ—¶å¤åˆ¶æ˜¯çš„åŸç†ã€‚åŒæ—¶äº†è§£åˆ°å¯ä»¥ä½¿ç”¨ System.arraycopy çš„æ–¹å¼æé«˜æ•°ç»„å¤åˆ¶çš„æ•ˆç‡ã€‚ åŒæ · CopyOnWriteArrayList é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œæ»¡è¶³æœ€ç»ˆä¸€è‡´æ€§ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯æ•°æ®ä¿®æ”¹åŠæ—¶æŸ¥è¯¢åˆ°ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- éé˜»å¡çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ— â€”â€” ConcurrentLinkedQueue","slug":"source-code/java/ConcurrentLinkedQueue","date":"2020-10-25T04:30:00.000Z","updated":"2020-12-27T09:23:14.600Z","comments":true,"path":"2020/10/25/source-code-concurrentlinkedqueue.html","link":"","permalink":"https://liuzhihang.com/2020/10/25/source-code-concurrentlinkedqueue.html","excerpt":"","text":"å‰è¨€ JUC ä¸‹é¢çš„ç›¸å…³æºç ç»§ç»­å¾€ä¸‹é˜…è¯»ï¼Œè¿™å°±çœ‹åˆ°äº†éé˜»å¡çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ— â€”â€” ConcurrentLinkedQueueï¼Œæ¥ä¸€èµ·çœ‹çœ‹å§ã€‚ ä»‹ç»åŸºäºé“¾æ¥èŠ‚ç‚¹çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œå¯¹å…ƒç´ FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰è¿›è¡Œæ’åºã€‚ é˜Ÿåˆ—çš„å¤´éƒ¨æ˜¯é˜Ÿåˆ—ä¸­æœ€é•¿æ—¶é—´çš„å…ƒç´ ï¼Œé˜Ÿåˆ—çš„å°¾éƒ¨æ˜¯é˜Ÿåˆ—ä¸­æœ€çŸ­æ—¶é—´çš„å…ƒç´ ã€‚ åœ¨é˜Ÿåˆ—çš„å°¾éƒ¨æ’å…¥æ–°å…ƒç´ ï¼Œé˜Ÿåˆ—æ£€ç´¢æ“ä½œè·å–é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ã€‚ å½“è®¸å¤šçº¿ç¨‹å…±äº«å¯¹å…¬å…±é›†åˆçš„è®¿é—® ConcurrentLinkedQueue æ˜¯ä¸€ä¸ªåˆé€‚çš„é€‰æ‹©ã€‚ ä¸å¤§å¤šæ•°å…¶ä»–å¹¶å‘é›†åˆå®ç°ä¸€æ ·ï¼Œæ­¤ç±»ä¸å…è®¸ä½¿ç”¨nullå…ƒç´ ã€‚ åŸºæœ¬ä½¿ç”¨public class ConcurrentLinkedQueueTest &#123; public static void main(String[] args) &#123; ConcurrentLinkedQueue&lt;String&gt; queue = new ConcurrentLinkedQueue&lt;String&gt;(); // å°†æŒ‡å®šå…ƒç´ æ’å…¥æ­¤é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚ queue.add(&quot;liuzhihang&quot;); // å°†æŒ‡å®šå…ƒç´ æ’å…¥æ­¤é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚ queue.offer(&quot;liuzhihang&quot;); // è·å–ä½†ä¸ç§»é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œé˜Ÿåˆ—ä¸ºç©ºè¿”å› nullã€‚ queue.peek(); // è·å–å¹¶ç§»é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œæ­¤é˜Ÿåˆ—ä¸ºç©ºè¿”å› nullã€‚ queue.poll(); &#125;&#125; æºç åˆ†æåŸºæœ¬ç»“æ„ å‚æ•°ä»‹ç»private static class Node&lt;E&gt; &#123; // èŠ‚ç‚¹ä¸­çš„å…ƒç´  volatile E item; // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ volatile Node&lt;E&gt; next; Node(E item) &#123; UNSAFE.putObject(this, itemOffset, item); &#125; // CAS çš„æ–¹å¼è®¾ç½®èŠ‚ç‚¹å…ƒç´  boolean casItem(E cmp, E val) &#123; return UNSAFE.compareAndSwapObject(this, itemOffset, cmp, val); &#125; // è®¾ç½®ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ void lazySetNext(Node&lt;E&gt; val) &#123; UNSAFE.putOrderedObject(this, nextOffset, val); &#125; // CAS çš„æ–¹å¼è®¾ç½®ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ boolean casNext(Node&lt;E&gt; cmp, Node&lt;E&gt; val) &#123; return UNSAFE.compareAndSwapObject(this, nextOffset, cmp, val); &#125; // çœç•¥ â€¦â€¦&#125; åœ¨ ConcurrentLinkedQueue å†…éƒ¨å«æœ‰ä¸€ä¸ªå†…éƒ¨ç±» Nodeï¼Œå¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™ä¸ªå†…éƒ¨ç±»ç”¨æ¥æ ‡è¯†é“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåœ¨ ConcurrentLinkedQueue ä¸­çš„é“¾è¡¨ä¸ºå•å‘é“¾è¡¨ã€‚ public class ConcurrentLinkedQueue&lt;E&gt; extends AbstractQueue&lt;E&gt; implements Queue&lt;E&gt;, java.io.Serializable &#123; // å…¶ä»–çœç•¥ // å¤´ç»“ç‚¹ private transient volatile Node&lt;E&gt; head; // å°¾èŠ‚ç‚¹ private transient volatile Node&lt;E&gt; tail;&#125; å¤´å°¾èŠ‚ç‚¹ä½¿ç”¨ volatile ä¿®é¥°ï¼Œä¿è¯å†…å­˜å¯è§æ€§ã€‚ æ„é€ å‡½æ•°public ConcurrentLinkedQueue() &#123; head = tail = new Node&lt;E&gt;(null);&#125; å½“åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¤´å°¾èŠ‚ç‚¹éƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªç©ºèŠ‚ç‚¹ã€‚ æ·»åŠ å…ƒç´ public boolean add(E e) &#123; return offer(e);&#125;public boolean offer(E e) &#123; // éªŒè¯æ˜¯å¦ä¸ºç©º checkNotNull(e); // åˆ›å»ºèŠ‚ç‚¹ final Node&lt;E&gt; newNode = new Node&lt;E&gt;(e); // å¾ªç¯å…¥é˜Ÿåˆ— // t æ˜¯å½“å‰å°¾èŠ‚ç‚¹ï¼Œp åˆå§‹ä¸º t for (Node&lt;E&gt; t = tail, p = t;;) &#123; // q ä¸ºå°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ Node&lt;E&gt; q = p.next; if (q == null) &#123; // ä¸ºç©ºï¼Œè¯´æ˜åé¢æ²¡æœ‰èŠ‚ç‚¹ï¼Œåˆ™ CAS è®¾ç½®å°¾èŠ‚ç‚¹ if (p.casNext(null, newNode)) &#123; // æ­¤æ—¶ p.next æ˜¯ newNode // å¦‚æœ p ï¼= t è¯´æ˜æœ‰å¹¶å‘ if (p != t) // å…¶ä»–çº¿ç¨‹å·²ç»æ›´æ–°äº† tail // q = p.next æ‰€ä»¥ q == null ä¸æ­£ç¡®äº† // q å–åˆ°äº† t.next // æ­¤æ—¶å°† tail æ›´æ–°ä¸º æ–°èŠ‚ç‚¹ casTail(t, newNode); // Failure is OK. return true; &#125; // Lost CAS race to another thread; re-read next &#125; // å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œ poll ï¼Œæ“ä½œç§»é™¤å…ƒç´ ï¼Œå¯èƒ½ä¼šå¯¼è‡´ p == q // æ­¤æ—¶è¦é‡æ–°æŸ¥æ‰¾ else if (p == q) // p = (t != (t = tail)) ? t : head; else // æ£€æŸ¥ tail å¹¶æ›´æ–° p = (p != t &amp;&amp; t != (t = tail)) ? t : q; &#125;&#125; ç”»å›¾è¯´æ˜ï¼š å•çº¿ç¨‹æƒ…å†µä¸‹ï¼š å½“æ‰§è¡Œåˆ° Node&lt;E&gt; q = p.next; æ—¶ï¼Œå½“å‰æƒ…å†µå¦‚å›¾æ‰€ç¤ºï¼š åˆ¤æ–­ q == nullï¼Œæ»¡è¶³æ¡ä»¶ï¼Œæ­¤æ—¶ä¾¿ä¼šæ‰§è¡Œ p.casNext(null, newNode) ä½¿ç”¨ CAS è®¾ç½® p.nextã€‚ è®¾ç½®æˆåŠŸä¹‹åï¼Œp == t æ²¡æœ‰å˜åŠ¨ï¼Œæ‰€ä»¥ç¨‹åºé€€å‡ºã€‚ å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼š å½“æ‰§è¡Œåˆ° Node&lt;E&gt; q = p.next; æ—¶ï¼Œå½“å‰æƒ…å†µå¦‚å›¾æ‰€ç¤ºï¼š å¤šä¸ªçº¿ç¨‹æ‰§è¡Œ p.casNext(null, newNode) ä½¿ç”¨ CAS è®¾ç½® p.nextã€‚ A çº¿ç¨‹ CAS è®¾ç½®æˆåŠŸï¼š B çº¿ç¨‹ CAS æ‰§è¡Œå¤±è´¥ï¼Œ é‡æ–°å¾ªç¯ï¼Œä¼šæ‰§è¡Œåˆ° p = (p != t &amp;&amp; t != (t = tail)) ? t : qã€‚ å†æ¬¡å¾ªç¯å°±å¯ä»¥æˆåŠŸè®¾ç½®ä¸Šäº†ã€‚ è·å–å…ƒç´ public E poll() &#123; restartFromHead: // æ— é™å¾ªç¯ for (;;) &#123; for (Node&lt;E&gt; h = head, p = h, q;;) &#123; // å¤´ç»“ç‚¹çš„ iterm E item = p.item; // å½“å‰èŠ‚ç‚¹å¦‚æœä¸ä¸º null CAS è®¾ç½®ä¸º null if (item != null &amp;&amp; p.casItem(item, null)) &#123; // CAS æˆåŠŸ åˆ™æ ‡è®°ç§»é™¤ if (p != h) // hop two nodes at a time updateHead(h, ((q = p.next) != null) ? q : p); return item; &#125; // å½“å‰é˜Ÿåˆ—æœªç©º è¿”å› null else if ((q = p.next) == null) &#123; updateHead(h, p); return null; &#125; // è‡ªå¼•ç”¨äº†ï¼Œ é‡æ–°è¿›è¡Œå¾ªç¯ else if (p == q) continue restartFromHead; else p = q; &#125; &#125;&#125; ç”»å›¾è¿‡ç¨‹å¦‚ä¸‹ï¼š åœ¨æ‰§è¡Œå†…å±‚å¾ªç¯æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼šE item = p.item; æ­¤æ—¶ï¼Œiterm ä¸º nullï¼Œä¼š updateHead(h, p) å¹¶è¿”å› nullã€‚ å‡è®¾åŒæ—¶æœ‰å¹¶å‘æ’å…¥æ“ä½œï¼Œæ·»åŠ äº†ä¸€ä¸ªå…ƒç´ ï¼Œæ­¤æ—¶å¦‚å›¾æ‰€ç¤ºï¼š è¿™æ—¶ä¼šæ‰§è¡Œæœ€åçš„ else å°† p = q ç»§ç»­å¾ªç¯è·å– itemï¼Œå¹¶æ‰§è¡Œ p.casItem(item, null) ï¼Œ ç„¶ååˆ¤æ–­ p != hï¼Œæ›´æ–° head å¹¶è¿”å› itemã€‚ è¿™é‡Œçš„æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œåªæ˜¯åˆ—ä¸¾ä¸€ç§ï¼Œå¦‚æœéœ€è¦å¯ä»¥è‡ªå·±å¤šåˆ—ä¸¾å‡ ç§ã€‚ è€ŒæŸ¥çœ‹å…ƒç´ çš„ä»£ç å’Œè·å–å…ƒç´ ä»£ç ç±»ä¼¼å°±ä¸å¤šä»‹ç»äº†ã€‚ size æ“ä½œpublic int size() &#123; int count = 0; for (Node&lt;E&gt; p = first(); p != null; p = succ(p)) if (p.item != null) // Collection.size() spec says to max out if (++count == Integer.MAX_VALUE) break; return count;&#125; CAS æ²¡æœ‰åŠ é”ï¼Œæ‰€ä»¥ size æ˜¯ä¸å‡†ç¡®çš„ã€‚å¹¶ä¸” size ä¼šéå†ä¸€éåˆ—è¡¨ï¼Œæ¯”è¾ƒè€—è´¹æ€§èƒ½ã€‚ æ€»ç»“ConcurrentLinkedQueue åœ¨å·¥ä½œä¸­ä½¿ç”¨çš„ç›¸å¯¹è¾ƒå°‘ï¼Œæ‰€ä»¥é˜…è¯»ç›¸å…³æºç çš„æ—¶å€™ä¹Ÿåªæ˜¯å¤§æ¦‚çœ‹äº†ä¸€ä¸‹ï¼Œäº†è§£å¸¸ç”¨ APIï¼Œä»¥åŠåº•å±‚åŸç†ã€‚ ç®€å•æ€»ç»“å°±æ˜¯ä½¿ç”¨å•å‘é“¾è¡¨æ¥ä¿å­˜é˜Ÿåˆ—å…ƒç´ ï¼Œå†…éƒ¨ä½¿ç”¨éé˜»å¡çš„ CAS ç®—æ³•ï¼Œæ²¡æœ‰åŠ é”ã€‚æ‰€ä»¥è®¡ç®— size æ—¶å¯èƒ½ä¸å‡†ç¡®ï¼ŒåŒæ · size ä¼šéå†é“¾è¡¨ï¼Œæ‰€ä»¥å¹¶ä¸å»ºè®®ä½¿ç”¨ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€å·¥ä½œç¬”è®°ã€‘- APP è«åå´©æºƒï¼Œå¼€å§‹ä»¥ä¸ºæ˜¯ Header ä¸­ name å¤§å°å†™çš„é”…ï¼Œæœ€åå‘ç°åŸæ¥æ˜¯å®¹å™¨çš„é”™ï¼","slug":"work/è¯·æ±‚ header å¤§å°å†™é—®é¢˜","date":"2020-10-18T23:00:00.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/10/19/header-name-case.html","link":"","permalink":"https://liuzhihang.com/2020/10/19/header-name-case.html","excerpt":"","text":"å‰è¨€ éƒ¨ç½²æµ‹è¯•ï¼Œéƒ¨ç½²é¢„å‘å¸ƒï¼Œä¸€åˆ‡æµ‹è¯•å°±ç»ªï¼Œä¸Šç”Ÿäº§ã€‚ å‘å¸ƒç”Ÿäº§ é—ªé€€ Whatï¼Ÿï¼Ÿï¼Ÿ é©¬ä¸Šå›æ»š å¼€å§‹æ’æŸ¥ åç«¯ä¸€æ¨¡ä¸€æ ·çš„ä»£ç ï¼Œä¸æ˜¯ APP ç«¯çš„é—®é¢˜å§ã€‚å¯ APP ç«¯æ²¡æœ‰å‘ç‰ˆå•Šã€‚ â€¦â€¦ ä¸€ç•ªæ’æŸ¥ åŸæ¥æ˜¯ APP ç«¯æ‰“åŒ…ï¼Œæµ‹è¯•å’Œé¢„å‘å¸ƒåŒ… Header ä¼ çš„éƒ½æ˜¯ Authorization ï¼Œç”Ÿäº§ä¼ çš„æ˜¯ authorization ã€‚å°±æ˜¯å¤§å°å†™é—®é¢˜ï¼Œé‚£èµ¶ç´§æ”¹ã€‚ èƒŒæ™¯é¦–é¡µæ¥å£åªæœ‰ç™»å½•æ‰å¯ä»¥è¿›å…¥ï¼Œå› ä¸ºé¦–é¡µè¦å±•ç¤ºè·å–ç”¨æˆ·è´¦æˆ·çš„ä¸€äº›ä¿¡æ¯ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ç»Ÿä¸€æ‹¦æˆªï¼Œä» Header ä¸­è·å– token åï¼Œä½¿ç”¨ token è·å–ç”¨æˆ·ä¿¡æ¯ã€‚ è€Œç°åœ¨è¦æ”¹ä¸ºç”¨æˆ·æœªç™»å½•ä¹Ÿå¯ä»¥æŸ¥çœ‹é¦–é¡µä¿¡æ¯ä¸­çš„å®£ä¼ æ–‡æ¡ˆç­‰ç­‰ï¼Œåªä¸è¿‡è´¦æˆ·ä¿¡æ¯ä¸æ˜¾ç¤ºã€‚ åŸæµç¨‹ æ•´ä¸ªè¿‡ç¨‹ä»£ç åœ¨ ThreadLocalåº•å±‚åŸç† é‡Œé¢æœ‰æ‰€ä»‹ç»ã€‚è¿™é‡Œçœç•¥ä¸€éƒ¨åˆ†ä»£ç ã€‚ @Componentpublic class TokenInterceptor implements HandlerInterceptor &#123; @Override public void afterCompletion(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2, Exception arg3) throws Exception &#123; LocalUserUtils.remove(); &#125; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; // è¯·æ±‚æ–¹æ³•æ˜¯å¦å­˜åœ¨æ³¨è§£ boolean assignableFrom = handler.getClass().isAssignableFrom(HandlerMethod.class); if (!assignableFrom) &#123; return true; &#125; CheckToken checkToken = null; if (handler instanceof HandlerMethod) &#123; checkToken = ((HandlerMethod) handler).getMethodAnnotation(CheckToken.class); &#125; // æ²¡æœ‰åŠ æ³¨è§£ ç›´æ¥æ”¾è¿‡ if (checkToken == null) &#123; return true; &#125; // ä»Headerä¸­è·å–Authorization String authorization = request.getHeader(&quot;Authorization&quot;); log.info(&quot;header authorization : &#123;&#125;&quot;, authorization); if (StringUtils.isBlank(authorization)) &#123; log.error(&quot;ä»Headerä¸­è·å–Authorizationå¤±è´¥&quot;); throw CustomExceptionEnum.NOT_HAVE_TOKEN.throwCustomException(); &#125; // å…¶ä»–ä»£ç çœç•¥ return true; &#125;&#125; ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºè¿™é‡Œå¤§æ¦‚è¿‡ç¨‹å¦‚ä¸‹ï¼š æ˜¯ä½¿ç”¨æ‹¦æˆªå™¨æ‹¦æˆªè¯·æ±‚ å¦‚æœæ–¹æ³•æ²¡æœ‰ CheckToken æ³¨è§£ç›´æ¥æ”¾è¿‡ æœ‰ CheckToken æ³¨è§£ï¼Œåˆ™ä» request çš„ header ä¸­è·å– Authorization æ–°éœ€æ±‚è¿™é‡Œæƒ³åˆ°åªéœ€è¦æŠŠæ³¨è§£å»æ‰ï¼Œç„¶åä»è¯·æ±‚å‚æ•°ä¸­è·å– token å³å¯ã€‚è·å–åˆ°èµ°åŸé€»è¾‘ï¼Œè·å–ä¸åˆ°åˆ™åªè¿”å›å®£ä¼ æ–‡æ¡ˆç­‰ä¿¡æ¯ã€‚ ä» Header ä¸­è·å–ä¿¡æ¯ç›´æ¥è·å–è¯·æ±‚å¤´æŸä¸€ä¸ª headerName@PostMapping(&quot;/getAuthorizationByKey&quot;)public String getAuthorizationByKey(@RequestHeader(&quot;Authorization&quot;) String authorization) &#123; log.info(&quot;è·å– Authorization ---&gt;&#123;&#125;&quot;, authorization); return authorization;&#125; ä½¿ç”¨ Map è·å–æ‰€æœ‰è¯·æ±‚å¤´@PostMapping(&quot;/getAuthorizationByMap&quot;)public String getAuthorizationByMap(@RequestHeader Map&lt;String, String&gt; map) &#123; String authorization = map.get(&quot;Authorization&quot;); log.info(&quot;è·å– Authorization ---&gt;&#123;&#125;&quot;, authorization); return authorization;&#125; ä½¿ç”¨ MultiValueMap è·å–è¯·æ±‚å¤´@PostMapping(&quot;/getAuthorizationByMultiValueMap&quot;)public String getAuthorizationByMultiValueMap(@RequestHeader MultiValueMap&lt;String, String&gt; map) &#123; List&lt;String&gt; authorization = map.get(&quot;Authorization&quot;); log.info(&quot;è·å– Authorization ---&gt;&#123;&#125;&quot;, authorization); return &quot;SUCCESS&quot;;&#125; ä½¿ç”¨ HttpHeaders è·å–è¯·æ±‚å¤´@PostMapping(&quot;/getAuthorizationByHeaders&quot;)public String getAuthorizationByHeaders(@RequestHeader HttpHeaders headers) &#123; List&lt;String&gt; authorization = headers.get(&quot;Authorization&quot;); log.info(&quot;è·å– Authorization ---&gt;&#123;&#125;&quot;, authorization); return &quot;SUCCESS&quot;;&#125; ä½¿ç”¨ HttpServletRequest è·å–@PostMapping(&quot;/getAuthorizationByServlet&quot;)public String getAuthorizationByServlet(HttpServletRequest request) &#123; String authorization = request.getHeader(&quot;Authorization&quot;); log.info(&quot;è·å– Authorization ---&gt;&#123;&#125;&quot;, authorization); return authorization;&#125; æµ‹è¯•æ–‡ä»¶ ç»è¿‡æµ‹è¯•è¿™äº›éƒ½æ˜¯å¯ä»¥çš„ï¼Œæœ€ç»ˆé€‰æ‹©ä½¿ç”¨ Map æ¥æ”¶ Header ï¼Œç„¶åä» Map ä¸­è·å– Authorizationã€‚ PS: å¯èƒ½æœ‰å°ä¼™ä¼´æµ‹è¯•ä¸è¿‡ï¼Œå‘ç°æ¥å—çš„ header é‡Œçš„ name å…¨éƒ½æ˜¯å°å†™äº†ï¼Œå¯ä»¥ç»§ç»­é˜…è¯»ã€‚æºç åœ¨æ–‡æœ«ï¼Œä¹Ÿå¯ä»¥å…³æ³¨å…¬ä¼—å·ï¼Œå‘é€ headerName/4 è·å–ã€‚ ä½ ä»¥ä¸ºäº‹æƒ…å¦‚æœåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œé‚£çœŸæ˜¯å¤ªå¤©çœŸäº†ã€‚ è¿™ä¸ï¼Œå‡ºç°äº†æ–‡ç« å¼€å¤´çš„æè¿°çš„åœºæ™¯ï¼Œèµ¶ç´§å›æ»šï¼Œç„¶åæ’æŸ¥é—®é¢˜ï¼Œæœ€åå®šä½åˆ°æ˜¯ Header çš„ name å¤§å°å†™é—®é¢˜ã€‚ æ€è€ƒ ä¹‹å‰ APP ç«¯ä¹Ÿæ˜¯è¿™ä¹ˆä¼ çš„ï¼Œé‚£ä¸ºä»€ä¹ˆä½¿ç”¨æ‹¦æˆªå™¨æ˜¯æ­£å¸¸çš„å‘¢ï¼Ÿ ä¸Šé¢çš„é‚£å‡ ç§æ–¹å¼æ˜¯ä¸æ˜¯éƒ½æ˜¯è¿™æ ·ï¼Ÿ ä¸æ’é™¤ tomcat å‘ç°åŸæ¥éƒ½ä¼šè½¬æ¢ä¸ºå°å†™ï¼Œåˆæ˜¯ä¸ºä»€ä¹ˆï¼Ÿ æ¨¡æ‹Ÿæ’æŸ¥ç¯å¢ƒé…ç½®æ¨¡æ‹Ÿç”Ÿäº§é¦–å…ˆä½¿ç”¨ç›¸åŒçš„å®¹å™¨é…ç½®ï¼Œè¿™é‡Œæ’é™¤äº†å†…ç½®çš„ tomcat å®¹å™¨ï¼Œå¹¶ä¸”ä½¿ç”¨ undertow å®¹å™¨ã€‚ &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;!-- Exclude the Tomcat dependency --&gt; &lt;exclusion&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-undertow&lt;/artifactId&gt;&lt;/dependency&gt; ä½¿ç”¨æ‹¦æˆªå™¨ä¼ å°å†™ä¸ºä»€ä¹ˆæ²¡æœ‰é—®é¢˜ ä¿®æ”¹ä½¿ç”¨å°å†™ authorization debug æ–­ç‚¹ ç¥å¥‡çš„ä¸€å¹•å‡ºç°äº†ï¼Œæ”¶åˆ°çš„ç¡®å®æ˜¯å°å†™ï¼Œä½†æ˜¯ request.getHeader(â€œAuthorizationâ€); å´å¯ä»¥è·å–åˆ° authorization F7 ç»§ç»­å¾€é‡Œè·Ÿ io.undertow.servlet.spec.HttpServletRequestImpl#getHeader ç¬¬ 190 è¡Œï¼Œä» HeaderMap ä¸­è·å–ç¬¬ä¸€ä¸ªå…ƒç´  io.undertow.util.HeaderMap#getFirst ç¬¬ 297 è¡Œï¼Œ é€šè¿‡ getEntry æ–¹æ³•è·å– header ç»§ç»­è¿½è¸ªï¼Œå‘ç°åœ¨ io.undertow.util.HeaderMap#getEntry(java.lang.String) æ–¹æ³• 77~79 è¡Œçš„æ—¶å€™è·å–åˆ°äº† header ä¿¡æ¯ã€‚é‚£å°±çœ‹ä¸€ä¸‹è¿™å—çš„æºç å§ã€‚ åœ¨ä»”ç»†çœ‹ä¸€ä¸‹å‘ç°æ˜¯ 77 è¡Œ final int hc = HttpString.hashCodeOf(headerName); åœ¨è·å– name çš„ hashCode æ—¶ï¼Œè¿™é‡Œæ— è®ºå¤§å°å†™ï¼Œéƒ½æ˜¯åŒä¸€ä¸ª hashCodeã€‚è¿™å—ä»£ç å¦‚ä¸‹ higher æ–¹æ³•ï¼š private static int higher(byte b) &#123; return b &amp; (b &gt;= &#x27;a&#x27; &amp;&amp; b &lt;= &#x27;z&#x27; ? 0xDF : 0xFF);&#125; è¿™å—çš„å«ä¹‰ å¦‚æœ b æ˜¯å°å†™å­—ç¬¦åˆ™ b &amp; 0xDF å¦‚æœ b æ˜¯å¤§å†™å­—ç¬¦åˆ™ b &amp; 0xFF å¯¹ç…§ ASCII è¡¨ï¼Œå¤§å°å†™å­—æ¯ç›¸å·® 32 è€Œ 0xFF(255) å’Œ 0xDF(223) åŒæ ·ç›¸å·® 32ï¼Œæ‰€ä»¥é—®é¢˜å®šä½åˆ°äº†ã€‚header çš„ name æ— è®ºæ˜¯å¤§å†™è¿˜æ˜¯å°å†™ï¼Œéƒ½ä¼šæŸ¥å‡ºåŒä¸€ä¸ªå€¼ã€‚ å½“ç„¶ä½ ä¹Ÿå¯ä»¥è¿™ä¹ˆä¼  è¿™æ ·çš„è¯è°åœ¨ä¸Šé¢ï¼ŒHeader ä¸­ä½¿ç”¨çš„ name å°±æ˜¯é‚£ä¸ªã€‚ ä½¿ç”¨ Map ä¸ºä»€ä¹ˆä¼šåŒºåˆ†å¤§å°å†™ä¼ å…¥çš„æ˜¯å¤§å†™ HttpServlet -&gt; DispatcherServlet#doDispatch -&gt; AbstractHandlerMethodAdapter#handle -&gt; RequestMappingHandlerAdapter#handleInternal -&gt; RequestMappingHandlerAdapter#invokeHandlerMethod -&gt; ServletInvocableHandlerMethod#invokeAndHandle-&gt; InvocableHandlerMethod#invokeForRequest (è§£æå‚æ•°å€¼)-&gt; InvocableHandlerMethod#getMethodArgumentValues-&gt; RequestHeaderMapMethodArgumentResolver#resolveArgument å¦‚å›¾æ‰€ç¤º String headerName = iterator.next(); name è¢«åŒºåˆ†å¤§å°å†™æ”¾åˆ°äº† LinkedHashMap ä¸­ï¼Œåç»­ä¼šåå°„è°ƒç”¨å¯¹åº”çš„ Controller æ–¹æ³•ã€‚ æ‰€ä»¥ä¹Ÿå°±å‡ºç°äº†æˆ‘æ‰€é‡åˆ°çš„é—®é¢˜ã€‚ å½“ç„¶ç†è®ºä¸Š APP å®¢æˆ·ç«¯ä¸åº”è¯¥æµ‹è¯•å’Œé¢„å‘å¸ƒä½¿ç”¨å¤§å†™ï¼Œè€Œç”Ÿäº§ä½¿ç”¨å°å†™ã€‚ ä¸Šé¢é˜…è¯»çš„æºç åªæ˜¯ Spring å¯¹ Header çš„å¤„ç†ï¼ŒSpring åœ¨ HttpServlet æ”¶åˆ°è¯·æ±‚æ—¶ï¼ŒSpring æ²¡æœ‰å¯¹è¯·æ±‚ Header çš„ name å¤§å°å†™è¿›è¡Œè½¬æ¢ï¼Œåªæ˜¯åœ¨è·å–å¯¹åº” value çš„æ—¶å€™ï¼Œæ²¡æœ‰åŒºåˆ†å¤§å°å†™è¿›è¡Œè·å–ã€‚ å®¹å™¨å¯¹ header çš„å¤„ç†undertow å®¹å™¨çš„å¤„ç† è¯·æ±‚å‚æ•°çš„å¤„ç† è¿™é‡Œå‘ç° undertow å¹¶æ²¡æœ‰å¯¹è¯·æ±‚å‚æ•°è¿›è¡Œå¤§å°å†™è½¬æ¢å¤„ç†æ“ä½œã€‚ ä» HttpServletRequest è·å– header debug å‘ç°è°ƒç”¨çš„æ˜¯ io.undertow.servlet.spec.HttpServletRequestImpl#getHeaderï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸Šé¢çš„æ’æŸ¥è¿‡ç¨‹ã€‚ ä» Headers ä¸­è·å– header é€šè¿‡ debug å‘ç° jetty è°ƒç”¨çš„æ˜¯ org.springframework.http.HttpHeaders#getï¼Œç„¶åè°ƒç”¨ org.springframework.util.MultiValueMapAdapter#getï¼Œç„¶åè°ƒç”¨ org.springframework.util.LinkedCaseInsensitiveMap#get è¿™é‡Œä¼šä¸åŒºåˆ†å¤§å°å†™ ä» MultiValueMap è·å– header è¿™å— debug å‘ç°æ˜¯ç›´æ¥ä» LinkedHashMap è·å–çš„ï¼Œæ‰€ä»¥åŒºåˆ†äº†å¤§å°å†™ã€‚ tomcat å®¹å™¨çš„å¤„ç† è¯·æ±‚å‚æ•°çš„å¤„ç† è€Œå¦‚æœæ²¡æœ‰æ’é™¤çš„è¯ï¼Œå³ä½¿ç”¨å†…åµŒçš„ tomcat å®¹å™¨æ— è®ºä¼ é€’å¤§å†™è¿˜æ˜¯å°å†™ï¼Œæ¥æ”¶åˆ°çš„å…¨éƒ¨éƒ½æ˜¯å°å†™ï¼Œåˆæ˜¯æ€ä¹ˆä¸ªæƒ…å†µå‘¢ï¼Ÿ é€šè¿‡ debug å‘ç°æ²¡æœ‰æ’é™¤ tomcat ä½¿ç”¨çš„æ˜¯ï¼Œåœ¨æ¥æ”¶è¯·æ±‚æ—¶ä½¿ç”¨çš„æ˜¯ org.apache.coyote.http11.Http11Processorã€‚ åœ¨ Http11Processor#service æ–¹æ³•ä¸­ ç±» 284 è¡Œè´Ÿè´£å¤„ç†è§£æ header è¿›å…¥ org.apache.coyote.http11.Http11InputBuffer#parseHeaders æ–¹æ³• ç¬¬ 589 è¡Œ ï¼ˆDownload Sources åï¼‰ï¼Œé˜…è¯» parseHeader æ–¹æ³• å‘ç°ä¼šå°†è¯·æ±‚ header çš„ name è½¬æ¢ä¸ºå°å†™ ä» HttpServletRequest è·å– header å½“ä½¿ç”¨ tomcat å®¹å™¨æ—¶ï¼Œè°ƒç”¨ org.apache.catalina.connector.RequestFacade#getHeaderï¼Œ org.apache.catalina.connector.Request#getHeaderï¼Œ org.apache.coyote.Request#getHeader org.apache.tomcat.util.http.MimeHeaders#getHeader æœ€åè°ƒç”¨ org.apache.tomcat.util.http.MimeHeaders#getValue è·å– header è¿™é‡Œä¹Ÿä¼šå¿½ç•¥å¤§å°å†™åˆ¤æ–­ ä» Headers è·å– header é€šè¿‡ debug å‘ç° tomcat å®¹å™¨ä¸‹è°ƒç”¨çš„æ˜¯ org.springframework.http.HttpHeaders#getï¼Œç„¶åè°ƒç”¨ org.springframework.util.MultiValueMapAdapter#getï¼Œç„¶åè°ƒç”¨ org.springframework.util.LinkedCaseInsensitiveMap#get è¿™é‡Œä¼šä¸åŒºåˆ†å¤§å°å†™ ä» MultiValueMap è·å– header è¿™å— debug å‘ç°æ˜¯ç›´æ¥ä» LinkedHashMap è·å–çš„ï¼Œæ‰€ä»¥åŒºåˆ†äº†å¤§å°å†™ã€‚ jetty å®¹å™¨çš„å¤„ç† è¯·æ±‚å‚æ•°çš„å¤„ç† å¦‚æœæ¢æˆ jetty å®¹å™¨çš„è¯ åœ¨ org.eclipse.jetty.server.HttpConnection ä¸­åˆä¼šå‘ç°æ— è®ºä¼ å…¥å¤§å†™è¿˜æ˜¯å°å†™éƒ½ä¼šè¢«è½¬æ¢ä¸ºé©¼å³°ã€‚ æºç å¯ä»¥é˜…è¯» org.eclipse.jetty.http.HttpParser#parseFields ä¼šè½¬æ¢ä¸ºé©¼å³°å‘½åæ³•ã€‚ ä» HttpServletRequest è·å– header é€šè¿‡ debug å‘ç° jetty è°ƒç”¨çš„æ˜¯ org.eclipse.jetty.server.Request#getHeader jetty åœ¨è·å– header æ—¶ï¼Œä¼šè°ƒç”¨ org.eclipse.jetty.http.HttpFields#get åŸæ¥åœ¨è·å–çš„æ—¶å€™å¿½ç•¥äº†å¤§å°å†™ ä» Headers è·å– header é€šè¿‡ debug å‘ç° jetty å®¹å™¨ä¸‹è°ƒç”¨çš„æ˜¯ org.springframework.http.HttpHeaders#getï¼Œç„¶åè°ƒç”¨ org.springframework.util.MultiValueMapAdapter#getï¼Œç„¶åè°ƒç”¨ org.springframework.util.LinkedCaseInsensitiveMap#get è¿™é‡Œä¼šä¸åŒºåˆ†å¤§å°å†™ ä» MultiValueMap è·å– ä¹Ÿæ˜¯è°ƒç”¨çš„ org.springframework.util.MultiValueMapAdapter#get ç„¶åä¸åŒºåˆ†å¤§å°å†™ã€‚å’Œä» Headers ä¸­è·å–ç›¸åŒã€‚ æ€»ç»“Q&amp;AQ: ä¸ºä»€ä¹ˆæ‹¦æˆªå™¨è·å– Authorization å¯ä»¥ä¸åŒºåˆ†å¤§å°å†™ï¼Ÿ A: ä»æ‹¦æˆªå™¨è·å– Authorization å…¶å®å°±æ˜¯ä» HttpServletRequest ä¸­è·å–ï¼Œè¿™é‡Œæ— è®ºä½¿ç”¨ tomcat è¿˜æ˜¯ä½¿ç”¨ undertow æˆ–è€… jetty è·å– Header æ˜¯éƒ½æ˜¯å¿½ç•¥ headerName çš„å¤§å°å†™çš„ã€‚å…·ä½“å¯ä»¥é˜…è¯»ä¸Šé¢çš„æºç åˆ†æã€‚ Q: è¿™ä¹ˆå¤šè·å– Header çš„æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŸA: ä¸åŒçš„å®¹å™¨ä¸‹å®ç°æ–¹å¼ä¸åŒï¼Œè¿™é‡Œåˆ—è¡¨è¯´æ˜ undertow tomcat jetty è¯·æ±‚å‚æ•°å¤§å°å†™è½¬æ¢ ä¸å˜ å°å†™ é©¼å³° ç›´æ¥è·å–è¯·æ±‚å¤´æŸä¸€ä¸ª headerName å¿½ç•¥å¤§å°å†™ï¼Œä¸èƒ½ä¸ºç©º å¿½ç•¥å¤§å°å†™ï¼Œä¸èƒ½ä¸ºç©º å¿½ç•¥å¤§å°å†™ï¼Œä¸èƒ½ä¸ºç©º ä½¿ç”¨ Map è·å–æ‰€æœ‰è¯·æ±‚å¤´ Map çš„ key å’Œä¼ å…¥ headerName å¤§å°å†™çš„ä¸€è‡´ï¼Œä¿æŒä¸€è‡´å¯è·å–åˆ° Map çš„ key å…¨æ˜¯å°å†™ï¼Œéœ€è¦ä½¿ç”¨å°å†™headerName è·å– Map çš„ key æ˜¯é©¼å³°å‘½åæ³•ï¼Œè¦ä½¿ç”¨é©¼å³°å‘½åæ‰å¯ä»¥è·å–åˆ° ä½¿ç”¨ MultiValueMap è·å–è¯·æ±‚å¤´ å®é™…æ˜¯ä» LinkedHashMap ä¸­è·å–ï¼ŒåŒºåˆ†å¤§å°å†™ å®é™…æ˜¯ä» LinkedHashMap ä¸­è·å–ï¼ŒåŒºåˆ†å¤§å°å†™ ä» LinkedCaseInsensitiveMap è·å–ï¼Œä¸åŒºåˆ†å¤§å°å†™ ä½¿ç”¨ HttpHeaders è·å–è¯·æ±‚å¤´ ä» LinkedCaseInsensitiveMap è·å–ï¼Œä¸åŒºåˆ†å¤§å°å†™ ä» LinkedCaseInsensitiveMap è·å–ï¼Œä¸åŒºåˆ†å¤§å°å†™ ä» LinkedCaseInsensitiveMap è·å–ï¼Œä¸åŒºåˆ†å¤§å°å†™ ä½¿ç”¨ HttpServletRequest è·å– ä½¿ç”¨ HttpString.hashCodeOf(headerName) å¿½ç•¥äº†å¤§å°å†™ è°ƒç”¨ MimeHeaders#getValue å¿½ç•¥äº†å¤§å°å†™ HttpFields#get å¿½ç•¥äº†å¤§å°å†™ é€šè¿‡è¡¨æ ¼å‘ç°ï¼Œå³ä½¿æ˜¯ä¸åŒçš„å®¹å™¨åœ¨ä½¿ç”¨ HttpHeaders è·å–è¯·æ±‚å¤´æ˜¯éƒ½æ˜¯è°ƒç”¨äº† Spring çš„ LinkedCaseInsensitiveMap è·å– headerï¼Œå¹¶ä¸”å†…éƒ¨å¿½ç•¥äº†å¤§å°å†™ï¼Œè¿™é‡Œæ¯”è¾ƒæ¨èä½¿ç”¨ã€‚ åŒæ ·ä½¿ç”¨ HttpServletRequest çš„æ–¹å¼è·å–ä¹Ÿæ¯”è¾ƒæ¨èã€‚ ç»“æŸè¯­æœ¬æ–‡ä¸»è¦æ˜¯åˆ†æç”Ÿäº§é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œç„¶åå¼€å§‹æ¢ç©¶åŸå› ï¼Œå¼€å§‹çš„æ—¶å€™å‘ç°æ˜¯ Spring çš„åŸå› ï¼Œå› ä¸ºä½¿ç”¨ Map æ¥æ”¶æ—¶ï¼Œ headerName ä»€ä¹ˆæ ¼å¼å°±æ˜¯ä»€ä¹ˆæ ¼å¼ã€‚ åœ¨è‡ªå·±å†™ demo æ—¶åˆå‘ç°ï¼ŒåŸæ¥å’Œ Spring çš„å…³ç³»å¹¶ä¸å¤§ï¼Œæ˜¯å®¹å™¨çš„åŸå› ã€‚ä¸åŒçš„å®¹å™¨å¤„ç†æ–¹å¼ä¸åŒã€‚æ‰€ä»¥æ€»ç»“å‡ºæ¥ç›¸å…³æ–‡ç« ï¼Œä¾›å¤§å®¶å‚è€ƒï¼Œä¸è¶³ä¹‹å¤„ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚ ç›¸å…³èµ„æ–™ æœ¬æ–‡æºç åœ°å€ï¼šhttps://github.com/liuzhihang/header-demo","categories":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"}]},{"title":"ã€å·¥ä½œç¬”è®°ã€‘- å‡ è¡Œä»£ç è½»æ¾å®ç°è·¨ç³»ç»Ÿä¼ é€’ traceIdï¼Œå†ä¹Ÿä¸ç”¨æ‹…å¿ƒå¯¹ä¸ä¸Šæ—¥å¿—äº†ï¼","slug":"work/MDC è·¨ç³»ç»Ÿé“¾è·¯è¿½è¸ª","date":"2020-10-18T05:00:00.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/10/18/log-trace-id.html","link":"","permalink":"https://liuzhihang.com/2020/10/18/log-trace-id.html","excerpt":"","text":"å‰è¨€ æ–°é¡¹ç›®æŸ¥æ—¥å¿—å¤ªéº»çƒ¦ï¼Œå¤šå°æœºå™¨ä¹‹é—´æŸ¥æ¥æŸ¥å»ï¼Œè¿˜ä¸çŸ¥é“æ˜¯ä¸æ˜¯åŒä¸€ä¸ªè¯·æ±‚çš„ã€‚æ‰“å°æ—¥å¿—æ—¶ä½¿ç”¨ MDC åœ¨æ—¥å¿—ä¸Šæ·»åŠ ä¸€ä¸ª traceIdï¼Œé‚£è¿™ä¸ª traceId å¦‚ä½•è·¨ç³»ç»Ÿä¼ é€’å‘¢ï¼Ÿ èƒŒæ™¯åŒæ ·æ˜¯æ–°é¡¹ç›®å¼€å‘çš„ç¬”è®°ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯åˆ†å¸ƒå¼æ¶æ„ï¼Œæ¶‰åŠåˆ°å„ä¸ªç³»ç»Ÿä¹‹é—´çš„äº¤äº’ è¿™æ—¶å€™å°±ä¼šé‡åˆ°ä¸€ä¸ªå¾ˆå¸¸è§çš„é—®é¢˜ï¼š å•ä¸ªç³»ç»Ÿæ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œæ—¥å¿—åˆ†å¸ƒåœ¨å¤šå°æœåŠ¡å™¨ä¸Šï¼› å¤šä¸ªç³»ç»Ÿçš„æ—¥å¿—åœ¨å¤šå°æœºå™¨ï¼Œä½†æ˜¯ä¸€æ¬¡è¯·æ±‚ï¼ŒæŸ¥æ—¥å¿—æ›´æ˜¯éš¾ä¸ŠåŠ éš¾ã€‚ è§£å†³æ–¹æ¡ˆ ä½¿ç”¨ SkyWalking traceid è¿›è¡Œé“¾è·¯è¿½è¸ªï¼› ä½¿ç”¨ Elastic APM çš„ trace.id è¿›è¡Œé“¾è·¯è¿½è¸ªï¼› è‡ªå·±ç”Ÿæˆ traceId å¹¶ put åˆ° MDC é‡Œé¢ã€‚ MDCMDCï¼ˆMapped Diagnostic Contextï¼‰æ˜¯ä¸€ä¸ªæ˜ å°„ï¼Œç”¨äºå­˜å‚¨è¿è¡Œä¸Šä¸‹æ–‡çš„ç‰¹å®šçº¿ç¨‹çš„ä¸Šä¸‹æ–‡æ•°æ®ã€‚å› æ­¤ï¼Œå¦‚æœä½¿ç”¨log4jè¿›è¡Œæ—¥å¿—è®°å½•ï¼Œåˆ™æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„MDCï¼Œè¯¥MDCå¯¹æ•´ä¸ªçº¿ç¨‹æ˜¯å…¨å±€çš„ã€‚å±äºè¯¥çº¿ç¨‹çš„ä»»ä½•ä»£ç éƒ½å¯ä»¥è½»æ¾è®¿é—®çº¿ç¨‹çš„MDCä¸­å­˜åœ¨çš„å€¼ã€‚ å¦‚ä½•ä½¿ç”¨ MDC åœ¨ log4j2-spring.xml çš„æ—¥å¿—æ ¼å¼ä¸­æ·»åŠ  %X&#123;traceId&#125; é…ç½®ã€‚ &lt;Property name=&quot;LOG_PATTERN&quot;&gt; [%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;]-[%t]-[%X&#123;traceId&#125;]-[%-5level]-[%c&#123;36&#125;:%L]-[%m]%n&lt;/Property&gt;&lt;Property name=&quot;LOG_PATTERN_ERROR&quot;&gt; [%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;]-[%t]-[%X&#123;traceId&#125;]-[%-5level]-[%l:%M]-[%m]%n&lt;/Property&gt;&lt;!-- çœç•¥ --&gt;&lt;!--è¿™ä¸ªè¾“å‡ºæ§åˆ¶å°çš„é…ç½®--&gt;&lt;Console name=&quot;Console&quot; target=&quot;SYSTEM_OUT&quot; follow=&quot;true&quot;&gt; &lt;!--è¾“å‡ºæ—¥å¿—çš„æ ¼å¼--&gt; &lt;PatternLayout charset=&quot;UTF-8&quot; pattern=&quot;$&#123;LOG_PATTERN&#125;&quot;/&gt;&lt;/Console&gt; æ–°å¢æ‹¦æˆªå™¨ æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œä» header ä¸­è·å– traceId ç„¶åæ”¾åˆ° MDC ä¸­ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™ç›´æ¥ç”¨ UUID ç”Ÿæˆä¸€ä¸ªã€‚ @Slf4j@Componentpublic class LogInterceptor implements HandlerInterceptor &#123; private static final String TRACE_ID = &quot;traceId&quot;; @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception arg3) throws Exception &#123; &#125; @Override public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView arg3) throws Exception &#123; &#125; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; String traceId = request.getHeader(TRACE_ID); if (StringUtils.isEmpty(traceId)) &#123; MDC.put(TRACE_ID, UUID.randomUUID().toString()); &#125; else &#123; MDC.put(TRACE_ID, traceId); &#125; return true; &#125; &#125; é…ç½®æ‹¦æˆªå™¨ @Configurationpublic class WebConfig implements WebMvcConfigurer &#123; @Resource private LogInterceptor logInterceptor; @Override public void addInterceptors(InterceptorRegistry registry) &#123; registry.addInterceptor(logInterceptor) .addPathPatterns(&quot;/**&quot;); &#125;&#125; è·¨æœåŠ¡ä¹‹é—´å¦‚ä½•ä¼ é€’ traceId FeignClient å› ä¸ºè¿™è¾¹ä½¿ç”¨çš„æ˜¯ FeignClient è¿›è¡ŒæœåŠ¡ä¹‹é—´çš„è°ƒç”¨ï¼Œåªéœ€è¦æ–°å¢è¯·æ±‚æ‹¦æˆªå™¨å³å¯ @Configurationpublic class FeignInterceptor implements RequestInterceptor &#123; private static final String TRACE_ID = &quot;traceId&quot;; @Override public void apply(RequestTemplate requestTemplate) &#123; requestTemplate.header(TRACE_ID, MDC.get(TRACE_ID)); &#125;&#125; Dubbo å¦‚æœæ˜¯ Dubbo å¯ä»¥é€šè¿‡æ‰©å±• Filter çš„æ–¹å¼ä¼ é€’ traceId ç¼–å†™ filter @Activate(group = &#123;&quot;provider&quot;, &quot;consumer&quot;&#125;)public class TraceIdFilter implements Filter &#123; @Override public Result invoke(Invoker&lt;?&gt; invoker, Invocation invocation) throws RpcException &#123; RpcContext rpcContext = RpcContext.getContext(); String traceId; if (rpcContext.isConsumerSide()) &#123; traceId = MDC.get(&quot;traceId&quot;); if (traceId == null) &#123; traceId = UUID.randomUUID().toString(); &#125; rpcContext.setAttachment(&quot;traceId&quot;, traceId); &#125; if (rpcContext.isProviderSide()) &#123; traceId = rpcContext.getAttachment(&quot;traceId&quot;); MDC.put(&quot;traceId&quot;, traceId); &#125; return invoker.invoke(invocation); &#125;&#125; æŒ‡å®š filter src |-main |-java |-com |-xxx |-XxxFilter.java (å®ç°Filteræ¥å£) |-resources |-META-INF |-dubbo |-org.apache.dubbo.rpc.Filter (çº¯æ–‡æœ¬æ–‡ä»¶ï¼Œå†…å®¹ä¸ºï¼šxxx=com.xxx.XxxFilter) æˆªå›¾å¦‚ä¸‹ï¼š æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š dubbo filter ç›¸å…³æºç åœ°å€åœ¨æ–‡æœ«ä¹Ÿå¯ä»¥å…³æ³¨å…¬ä¼—å·ï¼Œå‘é€ traceid è·å– å…¶ä»–æ–¹å¼å½“ç„¶å¦‚æœå°ä¼™ä¼´ä»¬æœ‰ä½¿ç”¨ SkyWalking æˆ–è€… Elastic APM ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œæ³¨å…¥ï¼š SkyWalking &lt;dependency&gt; &lt;groupId&gt;org.apache.skywalking&lt;/groupId&gt; &lt;artifactId&gt;apm-toolkit-log4j-2.x&lt;/artifactId&gt; &lt;version&gt;&#123;project.release.version&#125;&lt;/version&gt;&lt;/dependency ç„¶åå°† [%traceId] é…ç½®åœ¨ log4j2.xml æ–‡ä»¶çš„ pattern ä¸­å³å¯ Elastic APM åœ¨å¯åŠ¨æ—¶æŒ‡å®š enable_log_correlation ä¸º true å°† %X&#123;trace.id&#125; é…ç½®åœ¨ log4j2.xml æ–‡ä»¶çš„ pattern ä¸­ æ‰©å±•ç»Ÿä¸€æ—¥å¿—é‡‡é›†è™½ç„¶æœ‰äº† traceId å¯ä»¥è¿›è¡Œå…¨é“¾è·¯è¿½è¸ªæŸ¥è¯¢æ—¥å¿—ï¼Œä½†æ˜¯æ¯•ç«Ÿä¹Ÿæ˜¯åœ¨å¤šå°æœåŠ¡å™¨ä¸Šï¼Œä¸ºäº†æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œå¯ä»¥è€ƒè™‘å°†æ—¥å¿—æ±‡æ€»åˆ°ä¸€èµ·ã€‚ å¸¸ç”¨çš„ä½¿ç”¨æ–¹æ³•å°±æ˜¯åŸºäº ELK çš„æ—¥å¿—ç³»ç»Ÿï¼š ä½¿ç”¨ filebeat é‡‡é›†æ—¥å¿—æŠ¥é€åˆ° logstash logstash è¿›è¡Œåˆ†è¯è¿‡æ»¤ç­‰å¤„ç†ï¼Œè¾“å‡ºåˆ° Elasticsearch ä½¿ç”¨ Kinbana æˆ–è€…è‡ªå·±å¼€å‘çš„å¯è§†åŒ–å·¥å…·ä» Elasticsearch æŸ¥è¯¢æ—¥å¿— ç»“æŸè¯­æœ¬æ–‡ä¸»è¦è®°å½•è¿‘æœŸå¼€å‘è¿‡ç¨‹ä¸­çš„é‡åˆ°çš„ä¸€ç‚¹é—®é¢˜ï¼Œå¸Œæœ›å¯¹å°ä¼™ä¼´ä¹Ÿæœ‰æ‰€å¸®åŠ©ã€‚ä¸è¶³ä¹‹å¤„ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚å¦‚æœå°ä¼™ä¼´æœ‰å…¶ä»–çš„å»ºè®®æˆ–è€…è§‚ç‚¹æ¬¢è¿ç•™è¨€è®¨è®ºï¼Œå…±åŒè¿›æ­¥ã€‚ ç›¸å…³èµ„æ–™ Log4j 2 APIï¼šhttps://logging.apache.org/log4j/2.x/manual/thread-context.html SkyWalkingï¼šhttps://github.com/apache/skywalking/tree/master/docs/en/setup/service-agent/java-agent Elastic APMï¼šhttps://www.elastic.co/guide/en/apm/agent/java/current/log-correlation.html Dubbo filterï¼šhttp://dubbo.apache.org/zh-cn/docs/dev/impls/filter.html æœ¬æ–‡ Dubbo filter demoï¼šhttps://github.com/liuzhihang/trace","categories":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"é“¾è·¯è¿½è¸ª","slug":"å·¥ä½œç¬”è®°/é“¾è·¯è¿½è¸ª","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/"}],"tags":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"é“¾è·¯è¿½è¸ª","slug":"é“¾è·¯è¿½è¸ª","permalink":"https://liuzhihang.com/tags/%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/"}]},{"title":"ã€å·¥ä½œç¬”è®°ã€‘- è€å¤§é—®æˆ‘ï¼šâ€œå»ºè¡¨ä¸ºå•¥è¿˜è®¾ç½®ä¸ªè‡ªå¢ id ï¼Ÿç”¨æµæ°´å·å½“ä¸»é”®ä¸æ­£å¥½ä¹ˆï¼Ÿâ€","slug":"work/æ–°å»ºè¡¨ä¸ºä»€ä¹ˆè¦æœ‰è‡ªå¢id","date":"2020-10-11T05:00:00.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/10/11/work-trans-why-table-id.html","link":"","permalink":"https://liuzhihang.com/2020/10/11/work-trans-why-table-id.html","excerpt":"","text":"åˆè¦å¼€å§‹æ–°é¡¹ç›®äº†ï¼Œä¸€é¡¿æ“ä½œçŒ›å¦‚è™ï¼Œæ¢³ç†æµç¨‹åŠ ç”»å›¾ã€‚è¿™ä¸ï¼Œå¼€å§‹å¯¹æµç¨‹åŠè¡¨ç»“æ„äº†ã€‚æˆ‘ï¼šå§å•¦å§å•¦å§å•¦ â€¦â€¦è€å¤§ï¼šè¿™ä¸ªå»ºè¡¨ä¸ºå•¥è¿˜è®¾ç½®ä¸ªè‡ªå¢ id ï¼Ÿç›´æ¥ç”¨æµæ°´å·ï¼ˆç”¨æˆ·å·/äº§å“å·ï¼‰å½“ä¸»é”®ä¸å°±è¡Œäº†ï¼Ÿæˆ‘ï¼šè¿™ä¸ªæ˜¯ DBA è§„å®šçš„ï¼Œåˆ›å»ºè¡¨ idã€create_timeã€update_time è¿™ä¸‰ä¸ªå­—æ®µéƒ½è¦æœ‰ã€‚ã€ŠJava å¼€å‘è§„èŒƒã€‹ä¹Ÿæ˜¯è¿™ä¹ˆè§„å®šçš„ã€‚å°ä¼™ä¼´ï¼šï¼ˆé™„å’Œï¼‰æ˜¯çš„ï¼Œè§„å®šçš„æ˜¯è¿™æ ·çš„ï¼è€å¤§ï¼šæµæ°´å·åœ¨ä½ è¿™æ˜¯å”¯ä¸€ç´¢å¼•å§ï¼Ÿè®¾ç½®æˆä¸»é”®ï¼Œè¿™æ ·å°±ä¸ç”¨ id äº†ï¼Œè¿˜å‡å°‘ä¸€æ¬¡å›è¡¨æŸ¥è¯¢ï¼Ÿæˆ‘ï¼šâ€¦â€¦ ï¼ˆè¯´çš„å¥½åƒå¾ˆæœ‰é“ç†ï¼Œå’±ä¹Ÿä¸æ•¢è¯´è¯ã€‚ï¼‰è€å¤§ï¼šæ—¢ç„¶ä»–ä»¬è§„å®šäº†ï¼Œé‚£ä½ å›å»æŸ¥ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸ªè‡ªå¢ id ï¼Ÿæˆ‘ï¼šæå‡ºå°æœ¬æœ¬ï¼ˆå›å»æŸ¥èµ„æ–™~ï¼‰ã€‚ å»ºè¡¨è§„çº¦ åœ¨å·¥ä½œä¸­ï¼Œåˆ›å»ºè¡¨çš„æ—¶å€™ï¼ŒDBA ä¹Ÿä¼šå®¡æ ¸ä¸€ä¸‹å»ºè¡¨ SQLï¼Œæ£€æŸ¥æ˜¯å¦ç¬¦åˆè§„èŒƒä»¥åŠå¸¸ç”¨å­—æ®µæ˜¯å¦è®¾ç½®ç´¢å¼•ã€‚ CREATE TABLE `xxxx` ( `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;è‡ªå¢ä¸»é”®&#x27;, `create_time` datetime(3) NOT NULL DEFAULT current_timestamp(3) COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;, `update_time` datetime(3) NOT NULL DEFAULT current_timestamp(3) ON UPDATE current_timestamp(3) COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;, PRIMARY KEY (`id`) USING BTREE, KEY `idx_create_time` (`create_time`) USING BTREE, KEY `idx_update_time` (`update_time`) USING BTREE) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;è¡¨æ³¨é‡Š&#x27;; æ‰€ä»¥åœ¨æˆ‘ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œæµæ°´å·éƒ½æ˜¯å•ç‹¬è®¾ç½®äº†ä¸€ä¸ªå­—æ®µï¼Œæ¯”å¦‚å« trans_noï¼Œä½†æ˜¯è¿™æ¬¡å°±é‡åˆ°äº†ç–‘é—®ï¼štrans_no æ—¢ç„¶æ˜¯å”¯ä¸€çš„ï¼Œé‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ trans_no å½“åš id å‘¢ï¼Ÿ ä¸‹é¢å¼€å§‹é€šè¿‡æŸ¥é˜…ç›¸å…³èµ„æ–™ï¼Œä¸€æ­¥ä¸€æ­¥çš„äº†è§£æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ ä¸»é”®ä»€ä¹ˆæ˜¯ä¸»é”® https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_primary_key è¿™æ®µå®šä¹‰å’±ä»¬ä¸»è¦å…³æ³¨æœ€åä¸€å¥ï¼š When choosing primary key values, consider using arbitrary values (a synthetic key) rather than relying on values derived from some other source (a natural key). æ„æ€æ˜¯åˆ›å»ºä¸»é”®çš„æ—¶å€™å°½é‡ä½¿ç”¨ MySQL è‡ªå¢ä¸»é”®è€Œä¸æ˜¯ä½¿ç”¨ä¸šåŠ¡ç”Ÿæˆçš„å€¼å½“åšä¸»é”®ã€‚ ä¸»é”®çš„ç‰¹å¾ ç®€è€Œè¨€ä¹‹ï¼š éç©ºã€å”¯ä¸€ã€å°‘æ›´æ”¹æˆ–ä¸æ›´æ”¹ ã€‚ å¦‚ä½•æ·»åŠ ä¸»é”® å¯ä»¥åœ¨ create åˆ›å»ºè¡¨çš„æ—¶å€™æŒ‡å®šï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ alter è¯­å¥åé¢æ·»åŠ ä¸»é”®ï¼Œä¸è¿‡å®˜æ–¹å»ºè®®åœ¨åˆ›å»ºè¡¨æ—¶å°±æŒ‡å®šã€‚ ä¸ºä»€ä¹ˆè¦æ·»åŠ ä¸»é”® ä¸»é”®å¯ä»¥å”¯ä¸€æ ‡è¯†è¿™ä¸€è¡Œæ•°æ®ï¼Œä»è€Œä¿è¯åœ¨åˆ é™¤æ›´æ–°æ“ä½œæ—¶ï¼Œåªæ˜¯æ“ä½œè¿™ä¸€è¡Œæ•°æ®ã€‚ ç´¢å¼•éœ€è¦ï¼Œæ¯ä¸ª InnoDB è¡¨åˆæœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç´¢å¼•ï¼Œå³èšç°‡ç´¢å¼•ï¼Œç”¨æ¥å­˜å‚¨è¡Œæ•°æ®ã€‚é€šå¸¸ï¼Œèšç°‡ç´¢å¼•å’Œä¸»é”®åŒä¹‰ã€‚ å£°æ˜ä¸»é”®ï¼ŒInnoDB ä¼šå°†ä¸»é”®ä½œä¸ºèšç°‡ç´¢å¼•ã€‚ æœªå£°æ˜æ—¶ï¼Œä¼šåœ¨ UNIQUE æ‰€æœ‰é”®åˆ—æ‰€åœ¨ä½ç½®æ‰¾åˆ°ç¬¬ä¸€ä¸ªç´¢å¼•ï¼ŒNOT NULL å¹¶å°†å…¶ä½œä¸ºèšç°‡ç´¢å¼• æœªå£°æ˜ä¸”æ‰¾ä¸åˆ°åˆé€‚çš„ UNIQUE ç´¢å¼•ï¼Œåˆ™å†…éƒ¨ç”Ÿæˆä¸€ä¸ªéšè—çš„èšç°‡ç´¢å¼• GEN_CLUST_INDEXï¼Œè¿™ä¸ªéšè—çš„è¡Œ ID æ˜¯ 6 å­—èŠ‚ä¸”å•è°ƒå¢åŠ ã€‚ å›¾ -&gt; é‚£ä»€ä¹ˆæ˜¯ç´¢å¼• ç´¢å¼•è¿™é‡Œä»…ä»‹ç» InnoDB å¼•æ“ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œå¹¶ä¸”ä»‹ç»çš„ç›¸å¯¹æ¯”è¾ƒç®€å•ã€‚ ç´¢å¼•åˆ†ç±» èšç°‡ç´¢å¼•ï¼šè¡¨å­˜å‚¨æ˜¯æ ¹æ®ä¸»é”®åˆ—çš„å€¼ç»„ç»‡çš„ï¼Œä»¥åŠ å¿«æ¶‰åŠä¸»é”®åˆ—çš„æŸ¥è¯¢å’Œæ’åºã€‚åœ¨ä»‹ç»ä¸»é”®æ—¶ä¹Ÿå¯¹èšç°‡ç´¢å¼•è¿›è¡Œäº†ä»‹ç»ã€‚ äºŒçº§ç´¢å¼•ï¼šä¹Ÿå¯ä»¥å«è¾…åŠ©ç´¢å¼•ï¼Œåœ¨è¾…åŠ©ç´¢å¼•ä¸­ä¼šè®°å½•å¯¹åº”çš„ä¸»é”®åˆ—ä»¥åŠè¾…åŠ©ç´¢å¼•åˆ—ã€‚æ ¹æ®è¾…åŠ©ç´¢å¼•è¿›è¡Œæœç´¢çš„æ—¶å€™ï¼Œä¼šå…ˆæ ¹æ®è¾…åŠ©ç´¢å¼•è·å–åˆ°å¯¹åº”çš„ä¸»é”®åˆ—ï¼Œç„¶åå†æ ¹æ®ä¸»é”®å»èšç°‡ç´¢å¼•é‡Œé¢æœç´¢ã€‚ä¸€èˆ¬ä¸å»ºè®®ä¸»é”®å¾ˆé•¿ï¼Œå› ä¸ºä¸»é”®å¾ˆé•¿è¾…åŠ©ç´¢å¼•å°±ä¼šä½¿ç”¨æ›´å¤šçš„ç©ºé—´ã€‚ è¡¥å……ï¼š å›è¡¨ï¼šå…ˆåœ¨äºŒçº§ç´¢å¼•æŸ¥è¯¢åˆ°å¯¹åº”çš„ä¸»é”®å€¼ï¼Œç„¶åæ ¹æ®ä¸»é”®å†å»èšç°‡ç´¢å¼•é‡Œé¢å–æŸ¥è¯¢ã€‚ç´¢å¼•è¦†ç›–ï¼šäºŒçº§ç´¢å¼•è®°å½•äº†ä¸»é”®åˆ—å’ŒäºŒçº§ç´¢å¼•åˆ—ï¼Œå¦‚æœæˆ‘åªæŸ¥è¯¢ä¸»é”®åˆ—çš„å€¼å’ŒäºŒçº§ç´¢å¼•åˆ—çš„å€¼ï¼Œé‚£å°±ä¸éœ€è¦å›è¡¨äº†ã€‚ ç´¢å¼•çš„ç‰©ç†ç»“æ„InnoDB ä½¿ç”¨çš„ B+ æ•°æ•°æ®ç»“æ„ï¼Œæ ¹æ®èšç°‡ç´¢å¼•å€¼ï¼ˆä¸»é”®/UNQIUE/æˆ–è€…è‡ªå·±ç”Ÿæˆï¼‰æ„å»ºä¸€é¢— B+ æ ‘ï¼Œå¶å­èŠ‚ç‚¹ä¸­å­˜æ”¾è¡Œè®°å½•æ•°æ®ï¼Œæ‰€ä»¥æ¯ä¸ªå¶å­èŠ‚ç‚¹ä¹Ÿå¯ä»¥å«æ•°æ®é¡µã€‚æ¯ä¸ªæ•°æ®é¡µå¤§å°é»˜è®¤ä¸º 16kï¼Œæ”¯æŒè‡ªå®šä¹‰ã€‚ æ•°æ®çš„æ’å…¥å½“æ•°æ®æ’å…¥æ—¶ï¼ŒInnoDB ä¼šä½¿é¡µé¢ 1/16 ç©ºé—²ï¼Œä»¥å¤‡å°†æ¥æ’å…¥å’Œæ›´æ–°ç´¢å¼•è®°å½•ã€‚ é¡ºåºæ’å…¥ï¼ˆå‡åºæˆ–é™åºï¼‰ï¼šä¼šå°†ç´¢å¼•é¡µå‰©ä½™çš„å¤§çº¦ 15/16 è£…æ»¡ éšæœºæ’å…¥ï¼šåªä¼šä½¿ç”¨å®¹é‡çš„ 1/2 åˆ° 15/16 åœ¨éšæœºæ’å…¥ä¸­ï¼Œä¼šé¢‘ç¹çš„ç§»åŠ¨ã€åˆ†é¡µï¼Œä»è€Œé€ æˆå¤§é‡çš„ç¢ç‰‡ï¼Œå¹¶ä¸”ä½¿ç´¢å¼•æ ‘ä¸å¤Ÿç´§å‡‘ã€‚è€Œä½¿ç”¨é¡ºåºæ’å…¥çš„æ–¹å¼ï¼Œåˆ™æ•°æ®æ¯”è¾ƒç´§å‡‘ï¼Œæœ‰æ›´é«˜çš„ç©ºé—´åˆ©ç”¨ç‡ã€‚ æ€»ç»“Q&amp;AQ: ä»€ä¹ˆæ˜¯å›è¡¨å’Œç´¢å¼•è¦†ç›–ï¼Ÿ A: å›è¡¨ï¼šå…ˆåœ¨äºŒçº§ç´¢å¼•æŸ¥è¯¢åˆ°å¯¹åº”çš„ä¸»é”®å€¼ï¼Œç„¶åæ ¹æ®ä¸»é”®å†å»èšç°‡ç´¢å¼•é‡Œé¢å–æŸ¥è¯¢ã€‚ ç´¢å¼•è¦†ç›–ï¼šäºŒçº§ç´¢å¼•è®°å½•äº†ä¸»é”®åˆ—å’ŒäºŒçº§ç´¢å¼•åˆ—ï¼Œå¦‚æœæˆ‘åªæŸ¥è¯¢ä¸»é”®åˆ—çš„å€¼å’ŒäºŒçº§ç´¢å¼•åˆ—çš„å€¼ï¼Œé‚£å°±ä¸éœ€è¦å›è¡¨äº†ã€‚ Q: ä¸ºä»€ä¹ˆè¦è®¾ç½®è‡ªå¢ä¸»é”® id ï¼Ÿ A: å¯ä»¥å”¯ä¸€æ ‡è¯†ä¸€è¡Œæ•°æ®ï¼Œåœ¨ InnoDB æ„å»ºç´¢å¼•æ ‘çš„æ—¶å€™ä¼šä½¿ç”¨ä¸»é”®ã€‚ è‡ªå¢ id æ˜¯é¡ºåºçš„ï¼Œå¯ä»¥ä¿è¯ç´¢å¼•æ ‘ä¸Šçš„æ•°æ®æ¯”è¾ƒç´§å‡‘ï¼Œæœ‰æ›´é«˜çš„ç©ºé—´åˆ©ç”¨ç‡ä»¥åŠå‡å°‘æ•°æ®é¡µçš„åˆ†è£‚åˆå¹¶ç­‰æ“ä½œï¼Œæé«˜æ•ˆç‡ã€‚ ä¸€èˆ¬ä½¿ç”¨æ‰‹æœºå·ã€èº«ä»½è¯å·ä½œä¸ºä¸»é”®ç­‰å¹¶ä¸èƒ½ä¿è¯é¡ºåºæ€§ã€‚ æµæ°´å·ä¸€èˆ¬ç›¸å¯¹è¾ƒé•¿ï¼Œæ¯”å¦‚ 28 ä½ï¼Œ32 ä½ç­‰ï¼Œè¿‡é•¿çš„è¯ä¼šäºŒçº§ç´¢å¼•å ç”¨ç©ºé—´è¾ƒå¤šã€‚åŒæ—¶ä¸ºäº†ä¸šåŠ¡éœ€æ±‚ï¼Œæµæ°´å·å…·æœ‰ä¸€å®šçš„éšæœºæ€§ã€‚ ç»“æŸè¯­æœ¬æ–‡ä¸»è¦é€šè¿‡æŸ¥é˜…èµ„æ–™ï¼Œäº†è§£ä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸€ä¸ªå’Œä¸šåŠ¡æ— å…³çš„è‡ªå¢ id ç”¨æ¥å½“åšä¸»é”®ï¼Œå¾ˆå¤šå†…å®¹æ¯”è¾ƒæµ…æ˜¾ï¼Œæ¯”å¦‚ InnoDB çš„ B+ æ ‘ï¼Œé¡µåˆ†è£‚åŠé¡µåˆå¹¶ï¼Œæ’å…¥è¿‡ç¨‹ç­‰éƒ½æ²¡æœ‰è¿›è¡Œæ·±å…¥ç ”ç©¶ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥æ›´æ·±å…¥çš„ç ”ç©¶ä¸‹ã€‚ åŒæ—¶åœ¨å»ºè¡¨æ—¶é™¤äº†è¦è®¾ç½®ä¸€ä¸ªè‡ªå¢ id ç”¨æ¥å½“åšä¸»é”®ï¼Œå°ä¼™ä¼´ä»¬åœ¨ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­æ˜¯å¦ä¹Ÿä¼šé‡åˆ°ä¸€ç§æƒ…å†µï¼šç”¨æˆ·çš„æ³¨é”€ï¼Œæ•°æ®çš„åˆ é™¤ç­‰éƒ½æ˜¯è¿›è¡Œçš„é€»è¾‘åˆ é™¤ï¼Œè€Œä¸æ˜¯ç‰©ç†åˆ é™¤ã€‚ æœ¬ç¯‡æ–‡ç« ä»‹ç»æ¯”è¾ƒç®€é™‹ï¼Œä¸è¶³ä¹‹å¤„ï¼Œå¸Œæœ›å¤§å®¶å¤šå¤šæŒ‡æ­£ã€‚","categories":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- åŸºäºé“¾è¡¨çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ— â€”â€” LinkedBlockingQueue","slug":"source-code/java/LinkedBlockingQueue","date":"2020-10-04T06:30:00.000Z","updated":"2020-12-27T09:23:14.595Z","comments":true,"path":"2020/10/04/source-code-linkedblockingqueue.html","link":"","permalink":"https://liuzhihang.com/2020/10/04/source-code-linkedblockingqueue.html","excerpt":"","text":"å‰è¨€ ä¸Šä¸€èŠ‚çœ‹äº†åŸºäºæ•°æ®çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ— ArrayBlockingQueue çš„æºç ï¼Œé€šè¿‡é˜…è¯»æºç äº†è§£åˆ°åœ¨ ArrayBlockingQueue ä¸­å…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—æ“ä½œéƒ½æ˜¯ç”¨äº† ReentrantLock æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ä¸‹é¢å’±ä»¬çœ‹å¦ä¸€ç§æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼šLinkedBlockingQueueã€‚ ä»‹ç»ä¸€ä¸ªåŸºäºé“¾æ¥èŠ‚ç‚¹çš„ï¼Œå¯é€‰ç»‘å®šçš„ BlockingQueue é˜»å¡é˜Ÿåˆ—ã€‚ å¯¹å…ƒç´  FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰è¿›è¡Œæ’åºã€‚é˜Ÿåˆ—çš„å¤´éƒ¨æ˜¯å·²åœ¨é˜Ÿåˆ—ä¸­åœç•™æœ€é•¿æ—¶é—´çš„å…ƒç´ ã€‚é˜Ÿåˆ—çš„å°¾éƒ¨æ˜¯æœ€çŸ­æ—¶é—´å‡ºç°åœ¨é˜Ÿåˆ—ä¸­çš„å…ƒç´ ã€‚å°†æ–°å…ƒç´ æ’å…¥é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶æ£€ç´¢é˜Ÿåˆ—æ“ä½œè·å–é˜Ÿåˆ—å¼€å¤´çš„å…ƒç´ ã€‚ åŸºäºè¿è¡¨çš„é˜Ÿåˆ—é€šå¸¸å…·æœ‰æ¯”åŸºäºæ•°ç»„çš„é˜Ÿåˆ—æœ‰æ›´é«˜çš„ååé‡ï¼Œä½†æ˜¯å¤§å¤šæ•°å¹¶å‘åº”ç”¨ç¨‹åºä¸­çš„å¯é¢„æµ‹æ€§è¾ƒå·®ã€‚ åŸºæœ¬ä½¿ç”¨public class LinkedBlockingQueueTest &#123; private static final LinkedBlockingQueue&lt;String&gt; QUEUE = new LinkedBlockingQueue&lt;&gt;(10); public static void main(String[] args) throws InterruptedException &#123; // å…¥é˜Ÿåˆ— QUEUE.put(&quot;put å…¥é˜Ÿåˆ—, é˜Ÿåˆ—æ»¡åˆ™ä¼šé˜»å¡ç­‰å¾…&quot;); QUEUE.add(&quot;add å…¥é˜Ÿåˆ—, é˜Ÿåˆ—æ»¡åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸&quot;); QUEUE.offer(&quot;offer å…¥é˜Ÿåˆ—, é˜Ÿåˆ—æ»¡ä¼šè¿”å› false&quot;); // å‡ºé˜Ÿåˆ— // é˜Ÿåˆ—ç©ºè¿”å› null String poll = QUEUE.poll(); // é˜Ÿåˆ—ç©ºä¼šé˜»å¡ç­‰å¾… String take = QUEUE.take(); // ä»…ä»…çœ‹ä¸€ä¸‹æœ€æ—©å…¥é˜Ÿåˆ—çš„å…ƒç´  String peek = QUEUE.peek(); &#125;&#125; é—®é¢˜ç–‘é—® LinkedBlockingQueue çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ LinkedBlockingQueue å’Œ ArrayBlockingQueue çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ æºç åˆ†æåŸºæœ¬ç»“æ„ å‚æ•°ä»‹ç»static class Node&lt;E&gt; &#123; E item; /** * One of: * - çœŸæ­£çš„åç»§èŠ‚ç‚¹ * - æœ‰å€¼ï¼Œè¡¨ç¤ºåç»§è€…æ˜¯head.next * - nullï¼Œè¡¨ç¤ºæ²¡æœ‰åç»§ï¼ˆè¿™æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼‰ */ Node&lt;E&gt; next; Node(E x) &#123; item = x; &#125;&#125; é¦–å…ˆåœ¨ LinkedBlockingQueue ä¸­æœ‰ä¸€ä¸ªé™æ€å†…éƒ¨ç±» Node æ”¯æŒæ³›å‹ï¼Œä¸‹é¢çœ‹ä¸‹å…¶ä»–å­—æ®µï¼š /** åˆå§‹å®¹é‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¸ºInteger.MAX_VALUE */private final int capacity;/** å½“å‰å…ƒç´ æ•° */private final AtomicInteger count = new AtomicInteger();/*** é“¾è¡¨å¤´* ä¸å˜çš„æ˜¯: head.item == null*/transient Node&lt;E&gt; head;/*** é“¾è¡¨å°¾* ä¸å˜çš„æ˜¯: last.next == null*/private transient Node&lt;E&gt; last;/** æ‰§è¡Œ take, poll ç­‰æ“ä½œéœ€è¦è·å–åˆ° takeLock */private final ReentrantLock takeLock = new ReentrantLock();/** ç­‰å¾…æ‰§è¡Œ take æ“ä½œçš„çº¿ç¨‹ï¼Œä¼šæ”¾å…¥è¿™ä¸ªæ¡ä»¶é˜Ÿåˆ— */private final Condition notEmpty = takeLock.newCondition();/** æ‰§è¡Œ put, offer ç­‰æ“ä½œéœ€è¦è·å–åˆ° putLock */private final ReentrantLock putLock = new ReentrantLock();/** ç­‰å¾…æ‰§è¡Œ put æ“ä½œçš„çº¿ç¨‹ï¼Œä¼šè¢«æ”¾å…¥è¿™ä¸ªæ¡ä»¶é˜Ÿåˆ— */private final Condition notFull = putLock.newCondition(); æ„é€ å‡½æ•°public LinkedBlockingQueue() &#123; this(Integer.MAX_VALUE);&#125;// åˆ›å»ºæ—¶æŒ‡å®šå®¹é‡public LinkedBlockingQueue(int capacity) &#123; if (capacity &lt;= 0) throw new IllegalArgumentException(); this.capacity = capacity; last = head = new Node&lt;E&gt;(null);&#125; é€šè¿‡æ„é€ å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œåœ¨åˆå§‹åŒ– LinkedBlockingQueue æ—¶ï¼Œå¦‚æœä¸ä¼ å…¥å®¹é‡åˆ™ä¼šé»˜è®¤æŒ‡å®š Integer.MAX_VALUEã€‚ æ·»åŠ å…ƒç´ add æ–¹æ³•æ˜¯ç›´æ¥è°ƒç”¨çš„çˆ¶ç±» AbstractQueue çš„æ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨çš„ LinkedBlockingQueue è‡ªå·±å®ç°çš„ offer æ–¹æ³• public boolean add(E e) &#123; if (offer(e)) return true; else throw new IllegalStateException(&quot;Queue full&quot;);&#125; ä¸»è¦é˜…è¯»çš„è¿˜æ˜¯ LinkedBlockingQueue çš„ put å’Œ offer æ–¹æ³•ï¼š public void put(E e) throws InterruptedException &#123; // æ’å…¥å…ƒ if (e == null) throw new NullPointerException(); // Note: æ‰€æœ‰put / take / etcä¸­çš„çº¦å®šæ˜¯é¢„è®¾æœ¬åœ°å˜é‡ // ä¿æŒè®¡æ•°ä¸ºè´Ÿè¡¨ç¤ºå¤±è´¥ï¼Œé™¤éç½®ä½ã€‚ int c = -1; Node&lt;E&gt; node = new Node&lt;E&gt;(e); final ReentrantLock putLock = this.putLock; final AtomicInteger count = this.count; putLock.lockInterruptibly(); try &#123; // å¦‚æœå·²ç»åˆ°æœ€å¤§å®¹é‡ï¼Œåˆ™ç­‰å¾… while (count.get() == capacity) &#123; notFull.await(); &#125; enqueue(node); // æ€»æ•°è¿›è¡Œå¢åŠ ï¼Œ è¿”å›çš„æ˜¯å…ˆå‰çš„å®¹é‡ c = count.getAndIncrement(); // åˆ¤æ–­æ˜¯å¦éœ€è¦å”¤é†’å…¥é˜Ÿåˆ—é˜»å¡çš„çº¿ç¨‹ if (c + 1 &lt; capacity) notFull.signal(); &#125; finally &#123; putLock.unlock(); &#125; if (c == 0) // å”¤é†’å› è°ƒç”¨ notEmpty çš„ await æ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹ signalNotEmpty();&#125; public boolean offer(E e) &#123; // ä¸ºç©ºæŠ›å‡ºå¼‚å¸¸ if (e == null) throw new NullPointerException(); final AtomicInteger count = this.count; // å¦‚æœå·²ç»åˆ°æœ€å¤§å®¹é‡ï¼Œè¿”å› false if (count.get() == capacity) return false; int c = -1; Node&lt;E&gt; node = new Node&lt;E&gt;(e); final ReentrantLock putLock = this.putLock; putLock.lock(); try &#123; if (count.get() &lt; capacity) &#123; enqueue(node); c = count.getAndIncrement(); if (c + 1 &lt; capacity) notFull.signal(); &#125; &#125; finally &#123; putLock.unlock(); &#125; if (c == 0) signalNotEmpty(); return c &gt;= 0;&#125; é€šè¿‡ä¸Šé¢ä¸¤æ®µä»£ç å¯ä»¥çœ‹å‡º put å’Œ offer çš„æœ€å¤§åŒºåˆ«åœ¨äºæ˜¯å¦é˜»å¡ã€‚ put æ–¹æ³•å½“é˜Ÿåˆ—è¾¾åˆ°æŒ‡å®šå®¹é‡æ—¶ï¼Œä¼šé˜»å¡ï¼Œç­‰å¾…æœ‰å…ƒç´ å‡ºé˜Ÿåˆ—ã€‚è€Œ offer æ–¹æ³•ä¼šç›´æ¥è¿”å› falseã€‚ åŒæ—¶ä¸¤ä¸ªæ–¹æ³•æ“ä½œå…ƒç´ å…¥é˜Ÿåˆ—éƒ½æ˜¯è°ƒç”¨çš„ enqueue(node) æ–¹æ³•ï¼Œä¸‹é¢ä¸€èµ·çœ‹ä¸‹ enqueue æ–¹æ³•ã€‚ private void enqueue(Node&lt;E&gt; node) &#123; // assert putLock.isHeldByCurrentThread(); // assert last.next == null; last = last.next = node;&#125; åœ¨ enqueue æ–¹æ³•ä¸­ï¼Œç›´æ¥æŒ‡å®šå½“å‰å°¾èŠ‚ç‚¹çš„ next ä¸ºä¼ å…¥çš„å…ƒç´ å³å¯ã€‚ è·å–å…ƒç´ public E poll() &#123; final AtomicInteger count = this.count; // é˜Ÿåˆ—ä¸ºç©ºè¿”å› null if (count.get() == 0) return null; E x = null; int c = -1; // åŠ é” final ReentrantLock takeLock = this.takeLock; takeLock.lock(); try &#123; if (count.get() &gt; 0) &#123; x = dequeue(); // å‡å°‘é˜Ÿåˆ—å…ƒç´ è®¡æ•°ï¼Œè¿”å›çš„æ˜¯æ—§å€¼ c = count.getAndDecrement(); if (c &gt; 1) // æ—§å€¼å¤§äº 1 ï¼Œå°±æ˜¯å½“å‰å¤§äº 0 // å”¤é†’è°ƒç”¨ notEmpty.await ç­‰å¾…çš„çº¿ç¨‹ notEmpty.signal(); &#125; &#125; finally &#123; takeLock.unlock(); &#125; if (c == capacity) // å¦‚æœæ—§å€¼ç­‰äº capacity è¯´æ˜å½“å‰ç©ºäº†ä¸€ä¸ªä½ç½® signalNotFull(); return x;&#125; public E take() throws InterruptedException &#123; E x; int c = -1; final AtomicInteger count = this.count; final ReentrantLock takeLock = this.takeLock; takeLock.lockInterruptibly(); try &#123; // é˜»å¡ç­‰å¾… while (count.get() == 0) &#123; notEmpty.await(); &#125; x = dequeue(); c = count.getAndDecrement(); if (c &gt; 1) notEmpty.signal(); &#125; finally &#123; takeLock.unlock(); &#125; if (c == capacity) signalNotFull(); return x;&#125; é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡º poll å’Œ take æ–¹æ³•é€»è¾‘å¤§è‡´ç›¸åŒã€‚åŒºåˆ«å°±æ˜¯åœ¨å½“å‰é˜Ÿåˆ—ä¸ºç©ºæ—¶çš„å¤„ç†é€»è¾‘ã€‚poll åœ¨å½“å‰é˜Ÿåˆ—ä¸ºç©ºæ—¶è¿”å› nullï¼Œtake ä¼šé˜»å¡ç­‰å¾…ï¼ŒçŸ¥é“å½“å‰é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ ã€‚ poll å’Œ take éƒ½è¯•ç”¨ dequeue() æ–¹æ³•ä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ ã€‚ private E dequeue() &#123; // assert takeLock.isHeldByCurrentThread(); // assert head.item == null; Node&lt;E&gt; h = head; Node&lt;E&gt; first = h.next; h.next = h; // help GC head = first; E x = first.item; first.item = null; return x;&#125; dequeue() æ–¹æ³•é€»è¾‘å°±æ˜¯è·å–å¤´èŠ‚ç‚¹ï¼Œå¹¶å°† head æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ æŸ¥çœ‹å…ƒç´ public E peek() &#123; if (count.get() == 0) return null; final ReentrantLock takeLock = this.takeLock; takeLock.lock(); try &#123; Node&lt;E&gt; first = head.next; if (first == null) return null; else return first.item; &#125; finally &#123; takeLock.unlock(); &#125;&#125; peek() æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œç›´æ¥è·å– head çš„å…ƒç´ å€¼å³å¯ã€‚ æ€»ç»“Q&amp;AQ: LinkedBlockingQueue çš„å®ç°åŸç†ï¼Ÿ A: LinkedBlockingQueue æ˜¯åŸºäºé“¾è¡¨å®ç°çš„ï¼Œå†…éƒ¨ä½¿ç”¨ ReentrantLock äº’æ–¥é”ï¼Œé˜²æ­¢å¹¶å‘æ”¾ç½®å…ƒç´ æˆ–è€…å–å‡ºå…ƒç´ çš„å†²çªé—®é¢˜ã€‚ takeã€pollã€peek ç­‰ä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„æ“ä½œå…±ç”¨ takeLock é”ã€‚ addã€putã€offer ç­‰å‘é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ çš„æ“ä½œå…±åŒ putLock é”ã€‚ notEmpty å’Œ notFull æ˜¯ Condition ç±»å‹ï¼Œåœ¨ take å’Œ put æ“ä½œæ—¶ï¼Œå¦‚æœå¦‚æœé˜Ÿåˆ—ä¸ºç©ºæˆ–è€…é˜Ÿåˆ—å·²æ»¡ï¼Œä¼šè°ƒç”¨ç›¸åº”çš„ await å°†çº¿ç¨‹æ”¾å…¥æ¡ä»¶é˜Ÿåˆ—ã€‚ Q: å…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—æ–¹æ³•ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ æ–¹æ³• ä½œç”¨ add æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡äº†ï¼Œæ·»åŠ å¤±è´¥æŠ›å‡ºé—äº§ offer æ·»åŠ å…ƒç´ ï¼Œ é˜Ÿåˆ—æ»¡äº†ï¼Œæ·»åŠ å¤±è´¥ï¼Œè¿”å› false put æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡äº†ï¼Œé˜»å¡ç­‰å¾… poll å¼¹å‡ºå…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©ºåˆ™è¿”å› null take å¼¹å‡ºå…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©ºåˆ™ç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰å…ƒç´  peek æŸ¥çœ‹é˜Ÿåˆ—ä¸­æ”¾å…¥æœ€æ—©çš„ä¸€ä¸ªå…ƒç´  ç»“æŸè¯­LinkedBlockingQueue ä½¿ç”¨å’Œ ArrayBlockingQueue å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå†…éƒ¨å®ç°éƒ½æ˜¯ä½¿ç”¨çš„ ReentrantLockï¼Œå¯ä»¥å¯¹ç…§ç€é˜…è¯»ã€‚åŒæ—¶ Condition è¿™å—ä¹Ÿéœ€è¦ç€é‡äº†è§£ä¸€ä¸‹ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- AQS éƒ½çœ‹å®Œäº†ï¼ŒCondition åŸç†å¯ä¸èƒ½å°‘ï¼","slug":"source-code/java/Condition","date":"2020-10-01T10:00:00.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/10/01/source-code-condition.html","link":"","permalink":"https://liuzhihang.com/2020/10/01/source-code-condition.html","excerpt":"","text":"å‰è¨€ åœ¨ä»‹ç» AQS æ—¶ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå†…éƒ¨ç±»å«åš ConditionObjectï¼Œå½“æ—¶å¹¶æ²¡æœ‰è¿›è¡Œä»‹ç»ï¼Œå¹¶ä¸”åœ¨åç»­é˜…è¯»æºç æ—¶ï¼Œä¼šå‘ç°å¾ˆå¤šåœ°æ–¹ç”¨åˆ°äº† Condition ï¼Œè¿™æ—¶å°±ä¼šå¾ˆè¯§å¼‚ï¼Œè¿™ä¸ª Condition åˆ°åº•æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿé‚£ä»Šå¤©å°±é€šè¿‡é˜…è¯» Condition æºç ï¼Œä»è€Œå¼„æ¸…æ¥š Condition åˆ°åº•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿå½“ç„¶é˜…è¯»è¿™ç¯‡æ–‡ç« çš„æ—¶å€™å¸Œæœ›ä½ å·²ç»é˜…è¯»äº† AQSã€ReentrantLock ä»¥åŠ LockSupport çš„ç›¸å…³æ–‡ç« æˆ–è€…æœ‰ä¸€å®šçš„äº†è§£ï¼ˆå½“ç„¶å°ä¼™ä¼´ä¹Ÿå¯ä»¥ç›´æ¥è·³åˆ°æ–‡æœ«çœ‹æ€»ç»“ï¼‰ã€‚ ä»‹ç»Object çš„ç›‘è§†å™¨æ–¹æ³•ï¼šwaitã€notifyã€notifyAll åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œåœ¨å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œå¿…é¡»å…ˆä½¿ç”¨ synchronized è·å–åˆ°é”ï¼Œç„¶åæ‰å¯ä»¥è°ƒç”¨ Object çš„ waitã€notifyã€‚ Condition çš„ä½¿ç”¨ï¼Œç›¸å½“äºç”¨ Lock æ›¿æ¢äº† synchronizedï¼Œç„¶åç”¨ Condition æ›¿æ¢ Object çš„ç›‘è§†å™¨æ–¹æ³•ã€‚ Conditionsï¼ˆä¹Ÿç§°ä¸ºæ¡ä»¶é˜Ÿåˆ—æˆ–æ¡ä»¶å˜é‡ï¼‰ä¸ºä¸€ç§çº¿ç¨‹æä¾›äº†ä¸€ç§æš‚åœæ‰§è¡Œï¼ˆç­‰å¾…ï¼‰ï¼Œç›´åˆ°å¦ä¸€çº¿ç¨‹é€šçŸ¥è¢«é˜»å¡çš„çº¿ç¨‹ï¼ŒæŸäº›çŠ¶æ€æ¡ä»¶ç°åœ¨å¯èƒ½ä¸ºçœŸã€‚ å› ä¸ºè®¿é—®åˆ°æ­¤å…±äº«çŠ¶æ€ä¿¡æ¯å‘ç”Ÿåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ï¼Œå› æ­¤å¿…é¡»å¯¹å…¶è¿›è¡Œä¿æŠ¤ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨æŸç§å½¢å¼çš„é”ã€‚ç­‰å¾…æ¡ä»¶æä¾›çš„å…³é”®å±æ€§æ˜¯å®ƒä»¥åŸå­åœ°é‡Šæ”¾äº†å…³è”çš„é”ï¼Œå¹¶ä¸”æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œå°±åƒ Object.wait ä¸€æ ·ã€‚ Condition å®ä¾‹æœ¬è´¨ä¸Šè¦ç»‘å®šåˆ°é”ã€‚ ä¸ºäº†è·å¾— Condition å®ä¾‹ï¼Œä¸€èˆ¬ä½¿ç”¨ Lock å®ä¾‹çš„ newCondition() æ–¹æ³•ã€‚ Lock lock = new ReentrantLock();Condition con = lock.newCondition(); åŸºæœ¬ä½¿ç”¨class BoundedBuffer &#123; final Lock lock = new ReentrantLock(); // condition å®ä¾‹ä¾èµ–äº lock å®ä¾‹ final Condition notFull = lock.newCondition(); final Condition notEmpty = lock.newCondition(); final Object[] items = new Object[100]; int putPtr, takePtr, count; public void put(Object x) throws InterruptedException &#123; lock.lock(); try &#123; // put æ—¶åˆ¤æ–­æ˜¯å¦å·²ç»æ»¡äº† // åˆ™çº¿ç¨‹åœ¨ notFull æ¡ä»¶ä¸Šæ’é˜Ÿé˜»å¡ while (count == items.length) &#123; notFull.await(); &#125; items[putPtr] = x; if (++putPtr == items.length) &#123; putPtr = 0; &#125; ++count; // put æˆåŠŸä¹‹åï¼Œé˜Ÿåˆ—ä¸­æœ‰å…ƒç´  // å”¤é†’åœ¨ notEmpty æ¡ä»¶ä¸Šæ’é˜Ÿé˜»å¡çš„çº¿ç¨‹ notEmpty.signal(); &#125; finally &#123; lock.unlock(); &#125; &#125; public Object take() throws InterruptedException &#123; lock.lock(); try &#123; // take æ—¶ï¼Œå‘ç°ä¸ºç©º // åˆ™çº¿ç¨‹åœ¨ notEmpty çš„æ¡ä»¶ä¸Šæ’é˜Ÿé˜»å¡ while (count == 0) &#123; notEmpty.await(); &#125; Object x = items[takePtr]; if (++takePtr == items.length) &#123; takePtr = 0; &#125; --count; // take æˆåŠŸï¼Œé˜Ÿåˆ—ä¸å¯èƒ½æ˜¯æ»¡çš„ // å”¤é†’åœ¨ notFull æ¡ä»¶ä¸Šæ’é˜Ÿé˜»å¡çš„çº¿ç¨‹ notFull.signal(); return x; &#125; finally &#123; lock.unlock(); &#125; &#125;&#125; ä¸Šé¢æ˜¯å®˜æ–¹æ–‡æ¡£çš„ä¸€ä¸ªä¾‹å­ï¼Œå®ç°äº†ä¸€ä¸ªç®€å•çš„ BlockingQueue ï¼Œçœ‹æ‡‚è¿™é‡Œï¼Œä¼šå‘ç°åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯ç”¨çš„è¿™ä¸ªé€»è¾‘ã€‚å¿…è¦çš„ä»£ç è¯´æ˜éƒ½å·²ç»åœ¨ä»£ç ä¸­è¿›è¡Œæ³¨é‡Šã€‚ é—®é¢˜ç–‘é—® Condition å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ Condition çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ Condition çš„ç­‰å¾…é˜Ÿåˆ—å’Œ AQS çš„åŒæ­¥é˜Ÿåˆ—æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ï¼Ÿ æºç åˆ†æåŸºæœ¬ç»“æ„ é€šè¿‡ UML å¯ä»¥çœ‹å‡ºï¼ŒCondition åªæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒçš„ä¸»è¦å®ç°é€»è¾‘æ˜¯åœ¨ AQS çš„å†…éƒ¨ç±» ConditionObject å®ç°çš„ã€‚ä¸‹é¢ä¸»è¦ä» await å’Œ signal ä¸¤ä¸ªæ–¹æ³•å…¥æ‰‹ï¼Œä»æºç äº†è§£ ConditionObjectã€‚ åˆ›å»º ConditionLock lock = new ReentrantLock();Condition con = lock.newCondition(); ä¸€èˆ¬ä½¿ç”¨ lock.newCondition() åˆ›å»ºæ¡ä»¶å˜é‡ã€‚ public class ReentrantLock implements Lock, java.io.Serializable &#123; private final Sync sync; public Condition newCondition() &#123; return sync.newCondition(); &#125; // Sync é›†æˆ AQS abstract static class Sync extends AbstractQueuedSynchronizer &#123; final ConditionObject newCondition() &#123; return new ConditionObject(); &#125; &#125;&#125; è¿™é‡Œä½¿ç”¨çš„æ˜¯ ReentrantLock çš„æºç ï¼Œé‡Œé¢è°ƒç”¨çš„ sync.newCondition()ï¼ŒSync ç»§æ‰¿ AQSï¼Œå…¶å®å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª AQS å†…éƒ¨ç±»çš„ ConditionObject çš„å®ä¾‹ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ lock æ¯è°ƒç”¨ä¸€æ¬¡ lock.newCondition() éƒ½ä¼šæœ‰ä¸€ä¸ªæ–°çš„ ConditionObject å®ä¾‹ç”Ÿæˆï¼Œå°±æ˜¯è¯´ä¸€ä¸ª lock å¯ä»¥åˆ›å»ºå¤šä¸ª Condition å®ä¾‹ã€‚ Condition å‚æ•°/** æ¡ä»¶é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ */private transient Node firstWaiter;/** æ¡ä»¶é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ */private transient Node lastWaiter; await æ–¹æ³•await æ–¹æ³•ï¼Œä¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œç›´åˆ°æ”¶åˆ°ä¿¡å·æˆ–è¢«ä¸­æ–­ã€‚ ä¸æ­¤ Condition ç›¸å…³è”çš„é”è¢«åŸå­é‡Šæ”¾ï¼Œå¹¶ä¸”å‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œå½“å‰çº¿ç¨‹è¢«ç¦ç”¨ï¼Œå¹¶ä¸”å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹å››ç§æƒ…å†µä¹‹ä¸€ï¼š å…¶ä»–ä¸€äº›çº¿ç¨‹è°ƒç”¨æ­¤ Condition çš„ signal æ–¹æ³•ï¼Œè€Œå½“å‰çº¿ç¨‹æ°å¥½è¢«é€‰æ‹©ä¸ºè¦å”¤é†’çš„çº¿ç¨‹ï¼› å…¶ä»–ä¸€äº›çº¿ç¨‹è°ƒç”¨æ­¤ Condition çš„ signalAll æ–¹æ³•ï¼› å…¶ä»–ä¸€äº›çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ï¼Œå¹¶æ”¯æŒä¸­æ–­çº¿ç¨‹æŒ‚èµ·ï¼› å‘ç”Ÿè™šå‡å”¤é†’ã€‚ åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œåœ¨æ­¤æ–¹æ³•å¯ä»¥è¿”å›ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹å¿…é¡»é‡æ–°è·å–ä¸æ­¤æ¡ä»¶å…³è”çš„é”ã€‚å½“çº¿ç¨‹è¿”å›æ—¶ï¼Œå¯ä»¥ä¿è¯ä¿æŒæ­¤é”ã€‚ ç°åœ¨æ¥çœ‹ AQS å†…éƒ¨çš„å®ç°é€»è¾‘ï¼š public final void await() throws InterruptedException &#123; // å“åº”ä¸­æ–­ if (Thread.interrupted()) throw new InterruptedException(); // æ·»åŠ åˆ°æ¡ä»¶é˜Ÿåˆ—å°¾éƒ¨ï¼ˆç­‰å¾…é˜Ÿåˆ—ï¼‰ // å†…éƒ¨ä¼šåˆ›å»º Node.CONDITION ç±»å‹çš„ Node Node node = addConditionWaiter(); // é‡Šæ”¾å½“å‰çº¿ç¨‹è·å–çš„é”ï¼ˆé€šè¿‡æ“ä½œ state çš„å€¼ï¼‰ // é‡Šæ”¾äº†é”å°±ä¼šè¢«é˜»å¡æŒ‚èµ· int savedState = fullyRelease(node); int interruptMode = 0; // èŠ‚ç‚¹å·²ç»ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåˆ™è°ƒç”¨ park è®©å…¶åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­æŒ‚ç€ while (!isOnSyncQueue(node)) &#123; // è°ƒç”¨ park é˜»å¡æŒ‚èµ·å½“å‰çº¿ç¨‹ LockSupport.park(this); // è¯´æ˜ signal è¢«è°ƒç”¨äº†æˆ–è€…çº¿ç¨‹è¢«ä¸­æ–­ï¼Œæ ¡éªŒä¸‹å”¤é†’åŸå›  // å¦‚æœå› ä¸ºç»ˆç«¯è¢«å”¤é†’ï¼Œåˆ™è·³å‡ºå¾ªç¯ if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; &#125; // while å¾ªç¯ç»“æŸï¼Œ çº¿ç¨‹å¼€å§‹æŠ¢é” if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) interruptMode = REINTERRUPT; if (node.nextWaiter != null) // clean up if cancelled unlinkCancelledWaiters(); // ç»Ÿä¸€å¤„ç†ä¸­æ–­çš„ if (interruptMode != 0) reportInterruptAfterWait(interruptMode);&#125; await æ–¹æ³•æ­¥éª¤å¦‚ä¸‹ï¼š åˆ›å»º Node.CONDITION ç±»å‹çš„ Node å¹¶æ·»åŠ åˆ°æ¡ä»¶é˜Ÿåˆ—ï¼ˆConditionQueueï¼‰çš„å°¾éƒ¨ï¼› é‡Šæ”¾å½“å‰çº¿ç¨‹è·å–çš„é”ï¼ˆé€šè¿‡æ“ä½œ state çš„å€¼ï¼‰ åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ï¼ˆSyncQueueï¼‰ä¸­ï¼Œä¸åœ¨çš„è¯ä¼šä½¿ç”¨ park æŒ‚èµ·ã€‚ å¾ªç¯ç»“æŸä¹‹åï¼Œè¯´æ˜å·²ç»å·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ï¼ˆSyncQueueï¼‰ä¸­äº†ï¼Œåé¢ç­‰å¾…è·å–åˆ°é”ï¼Œç»§ç»­æ‰§è¡Œå³å¯ã€‚ åœ¨è¿™é‡Œä¸€å®šè¦æŠŠæ¡ä»¶é˜Ÿåˆ—å’ŒåŒæ­¥é˜Ÿåˆ—è¿›è¡ŒåŒºåˆ†æ¸…æ¥šï¼ï¼ æ¡ä»¶é˜Ÿåˆ—/ç­‰å¾…é˜Ÿåˆ—ï¼šå³ Condition çš„é˜Ÿåˆ—åŒæ­¥é˜Ÿåˆ—ï¼šAQS çš„é˜Ÿåˆ—ã€‚ ä¸‹é¢å¯¹ await é‡Œé¢é‡è¦æ–¹æ³•è¿›è¡Œé˜…è¯»ï¼š addConditionWaiter() æ–¹æ³• private Node addConditionWaiter() &#123; Node t = lastWaiter; // If lastWaiter is cancelled, clean out. // åˆ¤æ–­å°¾èŠ‚ç‚¹çŠ¶æ€ï¼Œå¦‚æœè¢«å–æ¶ˆï¼Œåˆ™æ¸…é™¤æ‰€æœ‰è¢«å–æ¶ˆçš„èŠ‚ç‚¹ if (t != null &amp;&amp; t.waitStatus != Node.CONDITION) &#123; unlinkCancelledWaiters(); t = lastWaiter; &#125; // åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œç±»å‹ä¸º Node.CONDITION Node node = new Node(Thread.currentThread(), Node.CONDITION); // å°†æ–°èŠ‚ç‚¹æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ if (t == null) firstWaiter = node; else t.nextWaiter = node; lastWaiter = node; return node;&#125; addConditionWaiter æ–¹æ³•å¯ä»¥çœ‹å‡ºï¼Œåªæ˜¯åˆ›å»ºä¸€ä¸ªç±»å‹ä¸º Node.CONDITION çš„èŠ‚ç‚¹å¹¶æ”¾åˆ°æ¡ä»¶é˜Ÿåˆ—å°¾éƒ¨ã€‚åŒæ—¶é€šè¿‡è¿™æ®µä»£ç è¿˜å¯ä»¥å¾—å‡ºå…¶ä»–ç»“è®ºï¼š æ¡ä»¶é˜Ÿåˆ—å†…éƒ¨çš„ Nodeï¼Œåªç”¨åˆ°äº† threadã€waitStatusã€nextWaiter å±æ€§ï¼› æ¡ä»¶é˜Ÿåˆ—æ˜¯å•å‘é˜Ÿåˆ—ã€‚ ä½œä¸ºå¯¹æ¯”ï¼Œè¿™é‡ŒæŠŠæ¡ä»¶é˜Ÿåˆ—å’ŒåŒæ­¥é˜Ÿåˆ—åšå‡ºå¯¹æ¯”ï¼š AQS åŒæ­¥é˜Ÿåˆ—å¦‚ä¸‹ï¼š å†æ¥çœ‹ä¸‹ Condition çš„æ¡ä»¶é˜Ÿåˆ— waitStatus åœ¨ AQS ä¸­å·²ç»è¿›è¡Œäº†ä»‹ç»ï¼š é»˜è®¤çŠ¶æ€ä¸º 0ï¼› waitStatus &gt; 0 (CANCELLED 1) è¯´æ˜è¯¥èŠ‚ç‚¹è¶…æ—¶æˆ–è€…ä¸­æ–­äº†ï¼Œéœ€è¦ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼› waitStatus = -1 SIGNAL å½“å‰çº¿ç¨‹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNALï¼Œåˆ™å½“å‰çº¿ç¨‹éœ€è¦é˜»å¡ï¼ˆunparkï¼‰ï¼› waitStatus = -2 CONDITION -2 ï¼šè¯¥èŠ‚ç‚¹ç›®å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ï¼› waitStatus = -3 PROPAGATE -3 ï¼šreleaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œåœ¨å…±äº«é”æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚ fullyRelease æ–¹æ³• ï¼ˆAQSï¼‰ final int fullyRelease(Node node) &#123; boolean failed = true; try &#123; // è·å–å½“å‰èŠ‚ç‚¹çš„ state int savedState = getState(); // é‡Šæ”¾é” if (release(savedState)) &#123; failed = false; return savedState; &#125; else &#123; throw new IllegalMonitorStateException(); &#125; &#125; finally &#123; if (failed) node.waitStatus = Node.CANCELLED; &#125;&#125; fullyRelease æ–¹æ³•æ˜¯ç”± AQS æä¾›çš„ï¼Œé¦–å…ˆè·å–å½“å‰çš„ stateï¼Œç„¶åè°ƒç”¨ release æ–¹æ³•è¿›è¡Œé‡Šæ”¾é”ã€‚ public final boolean release(int arg) &#123; if (tryRelease(arg)) &#123; Node h = head; if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); return true; &#125; return false;&#125; release æ–¹æ³•åœ¨ AQS ä¸­åšäº†è¯¦ç»†çš„ä»‹ç»ã€‚å®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯é‡Šæ”¾é”ï¼Œå¹¶ä¸”éœ€è¦æ³¨æ„çš„æ˜¯ï¼š fullyRelease ä¼šä¸€æ¬¡æ€§é‡Šæ”¾æ‰€æœ‰çš„é”ï¼Œæ‰€ä»¥è¯´ä¸ç®¡é‡å…¥å¤šå°‘æ¬¡ï¼Œåœ¨è¿™é‡Œéƒ½ä¼šå…¨éƒ¨é‡Šæ”¾çš„ã€‚ è¿™é‡Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä¸»è¦æ˜¯åœ¨é‡Šæ”¾é”å¤±è´¥æ—¶ï¼Œè¿™æ—¶å°±ä¼šåœ¨ finally é‡Œé¢å°†èŠ‚ç‚¹çŠ¶æ€ç½®ä¸º Node.CANCELLEDã€‚ isOnSyncQueue(node) é€šè¿‡ä¸Šé¢çš„æµç¨‹ï¼ŒèŠ‚ç‚¹å·²ç»æ”¾åˆ°äº†æ¡ä»¶é˜Ÿåˆ—å¹¶ä¸”é‡Šæ”¾äº†æŒæœ‰çš„é”ï¼Œè€Œåå°±ä¼šæŒ‚èµ·é˜»å¡ï¼Œç›´åˆ° signal å”¤é†’ã€‚ä½†æ˜¯åœ¨æŒ‚èµ·æ—¶è¦ä¿è¯èŠ‚ç‚¹å·²ç»ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ï¼ˆSyncQueueï¼‰ä¸­äº†æ‰å¯ä»¥æŒ‚èµ·ã€‚ final boolean isOnSyncQueue(Node node) &#123; // å½“å‰èŠ‚ç‚¹æ˜¯æ¡ä»¶é˜Ÿåˆ—èŠ‚ç‚¹ï¼Œæˆ–è€…ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯ç©º if (node.waitStatus == Node.CONDITION || node.prev == null) return false; if (node.next != null) // If has successor, it must be on queue return true; return findNodeFromTail(node);&#125;// ä»å°¾éƒ¨å¼€å§‹éå†private boolean findNodeFromTail(Node node) &#123; Node t = tail; for (;;) &#123; if (t == node) return true; if (t == null) return false; t = t.prev; &#125;&#125; å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæ€»æ˜¯ä¸€ä¸ªæœ€åˆæ”¾ç½®åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼‰ç°åœ¨æ­£ç­‰å¾…åœ¨åŒæ­¥é˜Ÿåˆ—ä¸Šé‡æ–°è·å–ï¼Œåˆ™è¿”å›trueã€‚ è¿™æ®µä»£ç çš„ä¸»è¦ä½œç”¨åˆ¤æ–­èŠ‚ç‚¹æ˜¯ä¸æ˜¯åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœä¸åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåé¢æ‰ä¼šè°ƒç”¨ park è¿›è¡Œé˜»å¡å½“å‰çº¿ç¨‹ã€‚è¿™é‡Œå°±ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼šAQS çš„åŒæ­¥é˜Ÿåˆ—å’Œ Condition çš„æ¡ä»¶é˜Ÿåˆ—åº”è¯¥æ˜¯æ— å…³çš„ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¼šè¦ä¿è¯èŠ‚ç‚¹ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ä¹‹åæ‰å¯ä»¥è¿›è¡Œé˜»å¡ï¼Ÿå› ä¸º signal æˆ–è€… signalAll å”¤é†’èŠ‚ç‚¹ä¹‹åï¼ŒèŠ‚ç‚¹å°±ä¼šè¢«æ”¾åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚ çº¿ç¨‹åˆ°è¿™é‡Œå·²ç»è¢«é˜»å¡äº†ï¼Œå½“æœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨ signal æˆ–è€… signalAll æ—¶ï¼Œä¼šå”¤é†’å½“å‰çº¿ç¨‹ã€‚ è€Œåä¼šéªŒè¯æ˜¯å¦å› ä¸­æ–­å”¤é†’å½“å‰çº¿ç¨‹ï¼Œè¿™é‡Œå‡è®¾æ²¡æœ‰å‘ç”Ÿä¸­æ–­ã€‚é‚£ while å¾ªç¯çš„ isOnSyncQueue(Node node) å¿…ç„¶ä¼šè¿”å› true ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­äº†ã€‚ åç»­ä¼šè°ƒç”¨ acquireQueued(node, savedState) è¿›è¡Œè·å–é”ã€‚ final boolean acquireQueued(final Node node, int arg) &#123; // æ˜¯å¦æ‹¿åˆ°èµ„æº boolean failed = true; try &#123; // ä¸­æ–­çŠ¶æ€ boolean interrupted = false; // æ— é™å¾ªç¯ for (;;) &#123; // å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„èŠ‚ç‚¹ final Node p = node.predecessor(); // å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œ è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ å¤´èŠ‚ç‚¹çš„ next å³çœŸå®çš„ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ ï¼ˆå› ä¸º head æ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼‰ // ç„¶åå†å°è¯•è·å–èµ„æº if (p == head &amp;&amp; tryAcquire(arg)) &#123; // è·å–æˆåŠŸä¹‹å å°†å¤´æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹ setHead(node); p.next = null; // help GC failed = false; return interrupted; &#125; // p ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œ æˆ–è€… å¤´èŠ‚ç‚¹æœªèƒ½è·å–åˆ°èµ„æº ï¼ˆéå…¬å¹³æƒ…å†µä¸‹è¢«åˆ«çš„èŠ‚ç‚¹æŠ¢å ï¼‰ // åˆ¤æ–­ node æ˜¯å¦è¦è¢«é˜»å¡ï¼Œè·å–ä¸åˆ°é”å°±ä¼šä¸€ç›´é˜»å¡ if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) interrupted = true; &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125; è¿™é‡Œå°±æ˜¯ AQS çš„é€»è¾‘äº†ï¼ŒåŒæ ·å¯ä»¥é˜…è¯» AQS çš„ç›¸å…³ä»‹ç»ã€‚ ä¸æ–­è·å–æœ¬èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸º headï¼Œå› ä¸º head æ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯ head èŠ‚ç‚¹ï¼Œåˆ™å½“å‰èŠ‚ç‚¹ä¸º ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹&gt;ï¼› ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ä¸æ–­çš„å»è·å–èµ„æºï¼Œè·å–æˆåŠŸï¼Œåˆ™å°† head æŒ‡å‘å½“å‰èŠ‚ç‚¹ï¼› å½“å‰èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œæˆ–è€… tryAcquire(arg) å¤±è´¥ï¼ˆå¤±è´¥å¯èƒ½æ˜¯éå…¬å¹³é”ï¼‰ã€‚è¿™æ—¶å€™éœ€è¦åˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€å†³å®šå½“å‰èŠ‚ç‚¹æ˜¯å¦è¦è¢«é˜»å¡ï¼ˆå‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€æ˜¯å¦ä¸º SIGNALï¼‰ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“èŠ‚ç‚¹æ”¾åˆ° AQS çš„åŒæ­¥é˜Ÿåˆ—æ—¶ï¼Œä¹Ÿæ˜¯è¿›è¡Œäº‰æŠ¢èµ„æºï¼ŒåŒæ—¶è®¾ç½® savedState çš„å€¼ï¼Œè¿™ä¸ªå€¼åˆ™æ˜¯ä»£è¡¨å½“åˆé‡Šæ”¾é”çš„æ—¶å€™é‡Šæ”¾äº†å¤šå°‘é‡å…¥æ¬¡æ•°ã€‚ æ€»ä½“æµç¨‹ç”»å›¾å¦‚ä¸‹ï¼š signalpublic final void signal() &#123; // æ˜¯å¦ä¸ºå½“å‰æŒæœ‰çº¿ç¨‹ if (!isHeldExclusively()) throw new IllegalMonitorStateException(); Node first = firstWaiter; if (first != null) doSignal(first);&#125;private void doSignal(Node first) &#123; do &#123; // firstWaiter å¤´èŠ‚ç‚¹æŒ‡å‘æ¡ä»¶é˜Ÿåˆ—å¤´çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ if ( (firstWaiter = first.nextWaiter) == null) lastWaiter = null; // å°†åŸæ¥çš„å¤´èŠ‚ç‚¹å’ŒåŒæ­¥é˜Ÿåˆ—æ–­å¼€ first.nextWaiter = null; &#125; while (!transferForSignal(first) &amp;&amp; (first = firstWaiter) != null);&#125;final boolean transferForSignal(Node node) &#123; // åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å·²ç»åœ¨ä¹‹å‰è¢«å–æ¶ˆäº† if (!compareAndSetWaitStatus(node, Node.CONDITION, 0)) return false; // è°ƒç”¨ enq æ·»åŠ åˆ° åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨ Node p = enq(node); int ws = p.waitStatus; // node çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ ä¿®æ”¹ä¸º SIGNAL è¿™æ ·åç»­å°±å¯ä»¥å”¤é†’è‡ªå·±äº† if (ws &gt; 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL)) LockSupport.unpark(node.thread); return true;&#125; enq åŒæ ·å¯ä»¥é˜…è¯» AQS çš„ä»£ç  private Node enq(final Node node) &#123; for (;;) &#123; Node t = tail; // å°¾èŠ‚ç‚¹ä¸ºç©º éœ€è¦åˆå§‹åŒ–å¤´èŠ‚ç‚¹ï¼Œæ­¤æ—¶å¤´å°¾èŠ‚ç‚¹æ˜¯ä¸€ä¸ª if (t == null) &#123; // Must initialize if (compareAndSetHead(new Node())) tail = head; &#125; else &#123; // ä¸ä¸ºç©º å¾ªç¯èµ‹å€¼ node.prev = t; if (compareAndSetTail(t, node)) &#123; t.next = node; return t; &#125; &#125; &#125;&#125; é€šè¿‡ enq æ–¹æ³•å°†èŠ‚ç‚¹æ”¾åˆ° AQS çš„åŒæ­¥é˜Ÿåˆ—ä¹‹åï¼Œè¦å°† node çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ waitStatus è®¾ç½®ä¸º Node.SIGNALã€‚signalAll çš„ä»£ç ä¹Ÿæ˜¯ç±»ä¼¼ã€‚ æ€»ç»“Q&amp;AQ: Condition å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ A: Condition æ˜¯åŸºäº AQS å®ç°çš„ï¼ŒCondition çš„å®ç°ç±» ConditionObject æ˜¯ AQS çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œåœ¨é‡Œé¢å…±ç”¨äº†ä¸€éƒ¨åˆ† AQS çš„é€»è¾‘ã€‚ Q: Condition çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ A: Condition å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—ï¼Œåœ¨è·å–é”çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹è°ƒç”¨ awaitï¼Œçº¿ç¨‹ä¼šè¢«æ”¾ç½®åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­å¹¶è¢«é˜»å¡ã€‚ç›´åˆ°è°ƒç”¨ signalã€signalAll å”¤é†’çº¿ç¨‹ï¼Œæ­¤åçº¿ç¨‹å”¤é†’ï¼Œä¼šæ”¾å…¥åˆ° AQS çš„åŒæ­¥é˜Ÿåˆ—ï¼Œå‚ä¸äº‰æŠ¢é”èµ„æºã€‚ Q: Condition çš„ç­‰å¾…é˜Ÿåˆ—å’Œ AQS çš„åŒæ­¥é˜Ÿåˆ—æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ï¼ŸA: Condition çš„ç­‰å¾…é˜Ÿåˆ—æ˜¯å•å‘é“¾è¡¨ï¼ŒAQS çš„æ˜¯åŒå‘é“¾è¡¨ã€‚äºŒè€…ä¹‹é—´å¹¶æ²¡æœ‰ä»€ä¹ˆæ˜ç¡®çš„è”ç³»ã€‚ä»…ä»…åœ¨èŠ‚ç‚¹ä»é˜»å¡çŠ¶æ€è¢«å”¤é†’åï¼Œä¼šä»ç­‰å¾…é˜Ÿåˆ—æŒªåˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚ ç»“æŸè¯­æœ¬æ–‡ä¸»è¦æ˜¯é˜…è¯» Condition çš„ç›¸å…³ä»£ç ï¼Œä¸è¿‡çœç•¥äº†çº¿ç¨‹ä¸­æ–­ç­‰é€»è¾‘ã€‚æœ‰å…´è¶£çš„å°ä¼™ä¼´ã€‚å¯ä»¥æ›´æ·±å…¥çš„ç ”ç©¶ç›¸å…³çš„æºç ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- åŸºäºæ•°ç»„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ— â€”â€” ArrayBlockingQueue","slug":"source-code/java/ArrayBlockingQueue","date":"2020-09-27T14:50:00.000Z","updated":"2020-12-27T09:23:14.595Z","comments":true,"path":"2020/09/27/source-code-arrayblockingqueue.html","link":"","permalink":"https://liuzhihang.com/2020/09/27/source-code-arrayblockingqueue.html","excerpt":"","text":"å‰è¨€ åœ¨é˜…è¯»å®Œå’Œ AQS ç›¸å…³çš„é”ä»¥åŠåŒæ­¥è¾…åŠ©å™¨ä¹‹åï¼Œæ¥ä¸€èµ·é˜…è¯» JUC ä¸‹çš„å’Œé˜Ÿåˆ—ç›¸å…³çš„æºç ã€‚å…ˆä»ç¬¬ä¸€ä¸ªå¼€å§‹ï¼šArrayBlockingQueueã€‚ ä»‹ç»ç”±æ•°ç»„æ”¯æŒçš„æœ‰ç•ŒBlockingQueueé˜»å¡é˜Ÿåˆ—ã€‚ è¿™ä¸ªé˜Ÿåˆ—çš„å‘½ä»¤å…ƒç´ FIFOï¼ˆå…ˆå…¥å…ˆå‡ºï¼‰ã€‚ é˜Ÿåˆ—çš„å¤´æ˜¯å…ƒç´ ä¸€ç›´åœ¨é˜Ÿåˆ—ä¸­æ—¶é—´æœ€é•¿ã€‚ é˜Ÿåˆ—çš„å°¾éƒ¨æ˜¯è¯¥å…ƒç´ å·²ç»åœ¨é˜Ÿåˆ—ä¸­çš„æ—¶é—´æœ€çŸ­ã€‚ æ–°å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶ä¸”é˜Ÿåˆ—æ£€ç´¢æ“ä½œè·å–åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨å…ƒç´ ã€‚ è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œæœ‰ç•Œç¼“å†²åŒºâ€ï¼Œåœ¨å…¶ä¸­ä¸€ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„ä¿æŒç”±ç”Ÿäº§è€…æ’å…¥å¹¶å—åˆ°æ¶ˆè´¹è€…çš„æå–çš„å…ƒç´ ã€‚ ä¸€æ—¦åˆ›å»ºï¼Œå®¹é‡ä¸èƒ½æ”¹å˜ã€‚ è¯•å›¾put ä¸€ä¸ªå…ƒç´ åˆ°ä¸€ä¸ªæ»¡çš„é˜Ÿåˆ—å°†å¯¼è‡´æ“ä½œé˜»å¡; è¯•å›¾ take ä»ç©ºé˜Ÿåˆ—ä¸€ä¸ªå…ƒç´ å°†ç±»ä¼¼åœ°é˜»å¡ã€‚ æ­¤ç±»æ”¯æŒè®¢è´­ç­‰å¾…ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹å¯é€‰çš„å…¬å¹³æ”¿ç­–ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé¡ºåºä¸èƒ½ä¿è¯ã€‚ ç„¶è€Œï¼Œé˜Ÿåˆ—å…¬å¹³è®¾ç½®ä¸ºæ„å»º true ä¿è¯çº¿ç¨‹ä»¥FIFOçš„é¡ºåºè¿›è¡Œè®¿é—®ã€‚ å…¬å¹³æ€§é€šå¸¸ä¼šé™ä½ååé‡ï¼Œä½†å‡å°‘äº†å¯å˜æ€§å’Œé¿å…é¥¥é¥¿ã€‚ åŸºæœ¬ä½¿ç”¨public class ArrayBlockingQueueTest &#123; private static final ArrayBlockingQueue&lt;String&gt; QUEUE = new ArrayBlockingQueue&lt;&gt;(10); private static final CountDownLatch LATCH = new CountDownLatch(2); public static void main(String[] args) &#123; ExecutorService pool = new ThreadPoolExecutor(2, 2, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;&gt;(1024), new ThreadFactoryBuilder().setNameFormat(&quot;Thread-pool-%d&quot;).build(), new ThreadPoolExecutor.AbortPolicy()); pool.submit(() -&gt; &#123; for (int i = 0; i &lt; 100; i++) &#123; try &#123; Thread.sleep(1000L); QUEUE.put(&quot;é¸¡è›‹&quot; + Thread.currentThread().getName()); System.out.println(&quot;put æ”¾å…¥å…ƒç´ &quot;); &#125; catch (InterruptedException ignored) &#123; &#125; &#125; LATCH.countDown(); &#125;); pool.submit(() -&gt; &#123; for (int i = 0; i &lt; 100; i++) &#123; try &#123; Thread.sleep(500L); String take = QUEUE.take(); System.out.println(&quot;take = &quot; + take); &#125; catch (InterruptedException ignored) &#123; &#125; &#125; LATCH.countDown(); &#125;); try &#123; LATCH.await(); &#125; catch (InterruptedException ignored) &#123; &#125; pool.shutdown(); &#125;&#125; demo åªæ˜¯ä¸´æ—¶å†™çš„ä¸€ä¸ªï¼Œå¾ˆç®€å•çš„ç‰ˆæœ¬ã€‚ é—®é¢˜ç–‘é—® ArrayBlockingQueue çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ å…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—æ–¹æ³•ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ æºç åˆ†æåŸºæœ¬ç»“æ„ å‚æ•°ä»‹ç»/** æ•°ç»„ - å­˜å‚¨é˜Ÿåˆ—ä¸­çš„å…ƒç´  */final Object[] items;/** ä¸‹ä¸€ä¸ª take, poll, peek or remove çš„ç´¢å¼• */int takeIndex;/** ä¸‹ä¸€ä¸ª put, offer, or add çš„ç´¢å¼• */int putIndex;/** é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•° */int count;/** Main lock guarding all access */final ReentrantLock lock;/** take æ“ä½œæ—¶æ˜¯å¦ç­‰å¾… */private final Condition notEmpty;/** put æ“ä½œæ—¶æ˜¯å¦ç­‰å¾… */private final Condition notFull; æ„é€ å‡½æ•°public ArrayBlockingQueue(int capacity) &#123; this(capacity, false);&#125;// æŒ‡å®šå®¹é‡ï¼ŒåŠæ˜¯å¦å…¬å¹³public ArrayBlockingQueue(int capacity, boolean fair) &#123; if (capacity &lt;= 0) throw new IllegalArgumentException(); this.items = new Object[capacity]; lock = new ReentrantLock(fair); notEmpty = lock.newCondition(); notFull = lock.newCondition();&#125;// åˆå§‹åŒ–çš„æ—¶å€™æ”¾å…¥å…ƒç´ public ArrayBlockingQueue(int capacity, boolean fair, Collection&lt;? extends E&gt; c) &#123; this(capacity, fair); final ReentrantLock lock = this.lock; lock.lock(); // Lock only for visibility, not mutual exclusion try &#123; int i = 0; try &#123; for (E e : c) &#123; checkNotNull(e); items[i++] = e; &#125; &#125; catch (ArrayIndexOutOfBoundsException ex) &#123; throw new IllegalArgumentException(); &#125; count = i; putIndex = (i == capacity) ? 0 : i; &#125; finally &#123; lock.unlock(); &#125;&#125; æ·»åŠ å…ƒç´ public boolean add(E e) &#123; return super.add(e);&#125;// çˆ¶ç±»çš„æ–¹æ³•ï¼Œå…¶å®è°ƒç”¨çš„ä¹Ÿæ˜¯ offerpublic boolean add(E e) &#123; if (offer(e)) return true; else throw new IllegalStateException(&quot;Queue full&quot;);&#125;// ä½¿ç”¨é”public boolean offer(E e) &#123; checkNotNull(e); // åŠ é” final ReentrantLock lock = this.lock; lock.lock(); try &#123; if (count == items.length) return false; else &#123; enqueue(e); return true; &#125; &#125; finally &#123; lock.unlock(); &#125;&#125;// æ”¾å…¥å…ƒç´ ï¼Œ å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ç­‰å¾…public void put(E e) throws InterruptedException &#123; checkNotNull(e); final ReentrantLock lock = this.lock; lock.lockInterruptibly(); try &#123; while (count == items.length) notFull.await(); enqueue(e); &#125; finally &#123; lock.unlock(); &#125;&#125; add æ–¹æ³•ï¼šè°ƒç”¨çš„æ˜¯çˆ¶ç±» AbstractQueue çš„ add æ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨çš„æ˜¯ offer æ–¹æ³•ï¼Œå¦‚æœ offer è¿”å› falseï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ offer æ–¹æ³•ï¼šæ ¡éªŒå…ƒç´ éç©ºï¼ŒåŠ äº’æ–¥é”ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™è¿”å› falseï¼Œå¦‚æœé˜Ÿåˆ—æœªæ»¡ï¼Œåˆ™è°ƒç”¨ enqueue æ–¹æ³•ï¼Œæ·»åŠ å…ƒç´ ã€‚ put æ–¹æ³•ï¼šæ ¡éªŒå…ƒç´ éç©ºï¼ŒåŠ äº’æ–¥é”ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¸€ç›´è‡ªæ—‹ç­‰å¾…ï¼Œé˜Ÿåˆ—æœªæ»¡åˆ™è°ƒç”¨ enqueue æ–¹æ³•ï¼Œæ·»åŠ å…ƒç´ ã€‚ æ‰€ä»¥ä¸‹é¢è¿˜æ˜¯éœ€è¦çœ‹ä¸€ä¸‹ enqueue æ–¹æ³•ï¼š // åªæœ‰åœ¨è·å–é”çš„æ—¶å€™æ‰å¯ä»¥è°ƒç”¨private void enqueue(E x) &#123; // assert lock.getHoldCount() == 1; // assert items[putIndex] == null; final Object[] items = this.items; // putIndex ä¸‹ä¸€ä¸ª put, offer, or add çš„ç´¢å¼• // å¯¹å…¶è¿›è¡Œèµ‹å€¼ï¼Œç„¶åè¿›è¡Œ ++putIndex æ“ä½œ items[putIndex] = x; // å¦‚æœç­‰äºé•¿åº¦ï¼Œåˆ™æŒ‡å®šä¸ºå¼€å§‹ if (++putIndex == items.length) putIndex = 0; // å¯¹å…ƒç´ æ•°è¿›è¡Œ ++ count++; // æœ‰å…ƒç´ å…¥é˜Ÿåˆ—ï¼Œå”¤é†’åœ¨ç­‰å¾…è·å–å…ƒç´ çš„çº¿ç¨‹ notEmpty.signal();&#125; è·å–å…ƒç´ public E poll() &#123; final ReentrantLock lock = this.lock; lock.lock(); try &#123; return (count == 0) ? null : dequeue(); &#125; finally &#123; lock.unlock(); &#125;&#125;public E take() throws InterruptedException &#123; final ReentrantLock lock = this.lock; lock.lockInterruptibly(); try &#123; while (count == 0) notEmpty.await(); return dequeue(); &#125; finally &#123; lock.unlock(); &#125;&#125; é€šè¿‡æºç å¯ä»¥çœ‹å‡ºï¼š pool å’Œ take éƒ½æ˜¯ä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ ï¼ŒäºŒè€…ä¸åŒçš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰å…ƒç´ æ—¶ï¼Œpoll æ–¹æ³•è¿”å› nullï¼Œè€Œ take æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°ä»é˜Ÿåˆ—ä¸­è·å–åˆ°å…ƒç´ ã€‚ poll å’Œ take æ–¹æ³•è·å–å…ƒç´ éƒ½æ˜¯è°ƒç”¨çš„ dequeue æ–¹æ³•ã€‚ private E dequeue() &#123; // assert lock.getHoldCount() == 1; // assert items[takeIndex] != null; final Object[] items = this.items; @SuppressWarnings(&quot;unchecked&quot;) // è·å–å…ƒç´ å¹¶å°†å…ƒç´ ç½®ä¸º null E x = (E) items[takeIndex]; items[takeIndex] = null; // takeIndex ä¸‹ä¸€ä¸ª take, poll, peek or remove çš„ç´¢å¼• // æŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸” å…ƒç´ æ•°å‡å°‘ if (++takeIndex == items.length) takeIndex = 0; count--; // æ›´æ–°è¿­ä»£å™¨çŠ¶æ€ if (itrs != null) itrs.elementDequeued(); // å”¤é†’ç­‰å¾…æ”¾å…¥å…ƒç´ çš„çº¿ç¨‹ notFull.signal(); return x;&#125; æŸ¥çœ‹å…ƒç´ public E peek() &#123; final ReentrantLock lock = this.lock; lock.lock(); try &#123; return itemAt(takeIndex); // null when queue is empty &#125; finally &#123; lock.unlock(); &#125;&#125; æ€»ç»“Q&amp;AQ: ArrayBlockingQueue çš„å®ç°åŸç†ï¼Ÿ A: ArrayBlockingQueue æ˜¯åŸºäºæ•°ç»„å®ç°çš„ï¼Œå†…éƒ¨ä½¿ç”¨ ReentrantLock äº’æ–¥é”ï¼Œé˜²æ­¢å¹¶å‘æ”¾ç½®å…ƒç´ æˆ–è€…å–å‡ºå…ƒç´ çš„å†²çªé—®é¢˜ã€‚ Q: å…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—æ–¹æ³•ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ æ–¹æ³• ä½œç”¨ add æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡äº†ï¼Œæ·»åŠ å¤±è´¥æŠ›å‡ºé—äº§ offer æ·»åŠ å…ƒç´ ï¼Œ é˜Ÿåˆ—æ»¡äº†ï¼Œæ·»åŠ å¤±è´¥ï¼Œè¿”å› false put æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡äº†ï¼Œé˜»å¡ç­‰å¾… poll å¼¹å‡ºå…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©ºåˆ™è¿”å› null take å¼¹å‡ºå…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©ºåˆ™ç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰å…ƒç´  peek æŸ¥çœ‹é˜Ÿåˆ—ä¸­æ”¾å…¥æœ€æ—©çš„ä¸€ä¸ªå…ƒç´  ç»“æŸè¯­ArrayBlockingQueue ä¸­ä½¿ç”¨äº† ReentrantLock äº’æ–¥é”ï¼Œåœ¨å…ƒç´ å…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—çš„æ—¶å€™éƒ½è¿›è¡Œäº†åŠ é”ï¼Œæ‰€ä»¥åŒæ—¶åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå…¥é˜Ÿåˆ—æˆ–è€…å‡ºé˜Ÿåˆ—ï¼Œä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- ä½¿ç”¨é€’å¢è®¡æ•°å™¨çš„çº¿ç¨‹åŒæ­¥å·¥å…· â€”â€” ä¿¡å·é‡ï¼Œå®ƒçš„åŸç†æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ","slug":"source-code/java/Semaphore","date":"2020-09-20T23:00:00.000Z","updated":"2020-12-27T09:23:14.248Z","comments":true,"path":"2020/09/21/source-code-semaphore.html","link":"","permalink":"https://liuzhihang.com/2020/09/21/source-code-semaphore.html","excerpt":"","text":"å‰è¨€ åœ¨ JUC ä¸­çº¿ç¨‹åŒæ­¥å™¨é™¤äº† CountDownLatch å’Œ CycleBarrier ï¼Œè¿˜æœ‰ä¸€ä¸ªå«åš Semaphore ï¼ˆä¿¡å·é‡ï¼‰ï¼ŒåŒæ ·æ˜¯åŸºäº AQS å®ç°çš„ã€‚ä¸‹é¢æ¥çœ‹çœ‹ä¿¡å·é‡çš„å†…éƒ¨åŸç†ã€‚ ä»‹ç»ä¸€ä¸ªè®¡æ•°ä¿¡å·é‡ã€‚ ä»æ¦‚å¿µä¸Šè®²ï¼Œä¿¡å·é‡ç»´æŠ¤äº†ä¸€ç»„è®¸å¯ã€‚ å¦‚æœæœ‰å¿…è¦ï¼Œåœ¨è®¸å¯å¯ç”¨ä¹‹å‰è°ƒç”¨ acquire æ–¹æ³•ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è®¸å¯è¯å¯ç”¨ã€‚ è°ƒç”¨ release æ–¹æ³•ä¼šå¢åŠ äº†ä¸€ä¸ªè®¸å¯è¯ï¼Œä»è€Œé‡Šæ”¾è¢«é˜»å¡çš„çº¿ç¨‹ã€‚ å£°æ˜æ—¶æŒ‡å®šåˆå§‹è®¸å¯æ•°é‡ã€‚ è°ƒç”¨ acquire(int permits) æ–¹æ³•ï¼ŒæŒ‡å®šç›®æ ‡è®¸å¯æ•°é‡ã€‚ è°ƒç”¨ release(int permits) æ–¹æ³•ï¼Œå‘å¸ƒæŒ‡å®šçš„è®¸å¯æ•°é‡ã€‚ åœ¨è®¸å¯æ•°é‡æ²¡æœ‰åˆ°è¾¾æŒ‡å®šç›®æ ‡æ•°é‡æ—¶ï¼Œè°ƒç”¨ acquire æ–¹æ³•çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚ åŸºæœ¬ä½¿ç”¨public class SemaphoreTest1 &#123; private static final Semaphore SEMAPHORE = new Semaphore(0); public static void main(String[] args) throws InterruptedException &#123; ExecutorService pool = new ThreadPoolExecutor(5, 5, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;&gt;(1024), new ThreadFactoryBuilder().setNameFormat(&quot;Thread-pool-%d&quot;).build(), new ThreadPoolExecutor.AbortPolicy()); for (int i = 0; i &lt; 5; i++) &#123; pool.submit(() -&gt; &#123; try &#123; Thread.sleep(1000 + new Random().nextInt(1000)); &#125; catch (InterruptedException ignored) &#123; &#125; System.out.println(&quot;å½“å‰çº¿ç¨‹: &quot; + Thread.currentThread().getName() + &quot; å‘å¸ƒä¸€ä¸ªè®¸å¯&quot;); SEMAPHORE.release(1); &#125;); &#125; System.out.println(&quot;-----&gt; è¿™é‡Œæ˜¯ä¸»çº¿ç¨‹&quot;); SEMAPHORE.acquire(5); System.out.println(&quot;-----&gt; ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•&quot;); pool.shutdown(); &#125;&#125; -----&gt; è¿™é‡Œæ˜¯ä¸»çº¿ç¨‹å½“å‰çº¿ç¨‹: Thread-pool-2 å‘å¸ƒä¸€ä¸ªè®¸å¯å½“å‰çº¿ç¨‹: Thread-pool-4 å‘å¸ƒä¸€ä¸ªè®¸å¯å½“å‰çº¿ç¨‹: Thread-pool-1 å‘å¸ƒä¸€ä¸ªè®¸å¯å½“å‰çº¿ç¨‹: Thread-pool-0 å‘å¸ƒä¸€ä¸ªè®¸å¯å½“å‰çº¿ç¨‹: Thread-pool-3 å‘å¸ƒä¸€ä¸ªè®¸å¯-----&gt; ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯• ä¸Šé¢è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯æ¨¡æ‹Ÿäº†ç±»ä¼¼ CountDownLatch çš„ç”¨æ³•ï¼Œ åœ¨å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚åªä¸è¿‡ Semaphore å’Œ CountDownLatch åŒºåˆ«æœ€å¤§çš„æ˜¯ï¼š Semaphore æ˜¯ä»æŒ‡å®šæ•°å€¼å¼€å§‹å¢åŠ ï¼Œç›´åˆ°åˆ°è¾¾è®¸å¯æ•°é‡ï¼Œç„¶åè¢«é˜»å¡çº¿ç¨‹å¼€å§‹ç»§ç»­æ‰§è¡Œã€‚ CountDownLatch æ˜¯ä»æŒ‡å®šæ•°é‡çš„çº¿ç¨‹å¼€å§‹å‡å°‘ï¼Œç›´åˆ°ä¸º 0 æ—¶ï¼Œè¢«é˜»å¡çš„çº¿ç¨‹å¼€å§‹ç»§ç»­æ‰§è¡Œã€‚ å½“ç„¶è¿™åªæ˜¯æœ€ç®€å•çš„ç”¨æ³•ï¼Œé™¤æ­¤è®©ä¸»çº¿ç¨‹ç­‰å¾…ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥è®©å…¶ä»–çº¿ç¨‹ç­‰å¾…ï¼Œç„¶åå†å¼€å§‹æ‰§è¡Œã€‚ é—®é¢˜ç–‘é—® Semaphore å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ Semaphore å’Œ CountDownLatch æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ æºç åˆ†æåŸºæœ¬ç»“æ„ é€šè¿‡ç±»å›¾å¯ä»¥çœ‹å‡ºåœ¨ Semaphore é‡Œé¢æœ‰ä¸€ä¸ªé™æ€å†…éƒ¨ç±» Sync ç»§æ‰¿äº† AQSï¼ŒåŒæ—¶ä¸ºäº†åŒºåˆ†å…¬å¹³å’Œéå…¬å¹³çš„æƒ…å†µï¼ŒSync åˆ†åˆ«æœ‰ä¸¤ä¸ªå­ç±»ï¼šNonfairSync ã€FairSyncã€‚ ä¸‹é¢æ ¹æ®æ¡ˆä¾‹åˆ†åˆ«ä»æ„é€ å‡½æ•°ã€acquire()ã€release() å…¥æ‰‹ï¼Œä»è€Œäº†è§£å†…éƒ¨å®ç°åŸç†ã€‚ åˆå§‹åŒ–public Semaphore(int permits) &#123; sync = new NonfairSync(permits);&#125; åˆå§‹åŒ–é»˜è®¤éå…¬å¹³é”ï¼Œ åŒæ—¶éœ€è¦ä¼ å…¥æŒ‡å®šè®¸å¯æ•°ï¼Œ å¯ä»¥çœ‹åˆ°è¿™å—ä»£ç æ˜¯è°ƒç”¨çš„ AQS çš„ setState(permits) æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š static final class NonfairSync extends Sync &#123; private static final long serialVersionUID = -2694183684443567898L; NonfairSync(int permits) &#123; super(permits); &#125;&#125;abstract static class Sync extends AbstractQueuedSynchronizer &#123; private static final long serialVersionUID = 1192457210091910933L; Sync(int permits) &#123; setState(permits); &#125; &#125; setState æ–¹æ³•å…¶å®å°±æ˜¯å¯¹ AQS çš„ state è¿›è¡Œèµ‹å€¼ã€‚ è¡¥å…… åœ¨ ReentrantLock ä¸­ state ä»£è¡¨åŠ é”çŠ¶æ€ï¼Œ0 æ²¡æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äºç­‰äº 1 å·²ç»æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äº 1 è¯´æ˜è¯¥è·å¾—é”çš„çº¿ç¨‹å¤šæ¬¡é‡å…¥ã€‚ åœ¨ ReentrantReadWriteLock ä¸­ state ä»£è¡¨é”çš„çŠ¶æ€ã€‚state ä¸º 0 ï¼Œæ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œstate çš„é«˜ 16 ä¸ºä»£è¡¨è¯»é”çŠ¶æ€ï¼Œä½ 16 ä¸ºä»£è¡¨å†™é”çŠ¶æ€ã€‚é€šè¿‡ä½è¿ç®—å¯ä»¥è·å–è¯»å†™é”çš„å®é™…å€¼ã€‚ è€Œåœ¨è¿™é‡Œ ï¼ˆCountDownLatchï¼‰åˆ™ä»£è¡¨é—¨é—©æˆ–è€…è¯´è®¡æ•°çš„å€¼ã€‚ å¦‚æœå¯¹ state æœ‰æ‰€é—å¿˜ï¼Œå¯ä»¥é˜…è¯»å‰é¢çš„ AQS ã€CAS ç›¸å…³ä»£ç ã€‚ state åœ¨è¿™é‡Œä»£è¡¨çš„æ˜¯ä¿¡å·é‡çš„è®¸å¯æ•°é‡ã€‚ acquire()public void acquire() throws InterruptedException &#123; sync.acquireSharedInterruptibly(1);&#125;public void acquire(int permits) throws InterruptedException &#123; if (permits &lt; 0) throw new IllegalArgumentException(); sync.acquireSharedInterruptibly(permits);&#125; acquire() å’Œ acquire(int permits) è°ƒç”¨çš„éƒ½æ˜¯ sync.acquireSharedInterruptibly(permits) æ–¹æ³•ï¼Œåªä¸è¿‡ä¸€ä¸ªæ”¯æŒä¼ é€’å‚æ•°ï¼Œä¸€ä¸ªé»˜è®¤ä¸º 1ã€‚ acquireSharedInterruptibly æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯ Sync ç»§æ‰¿è‡ª AQS çš„ã€‚ è¿™å—å¯ä»¥é˜…è¯» AQS çš„æ–‡ç« ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹ï¼š private void doAcquireSharedInterruptibly(int arg) throws InterruptedException &#123; final Node node = addWaiter(Node.SHARED); boolean failed = true; try &#123; for (;;) &#123; final Node p = node.predecessor(); if (p == head) &#123; int r = tryAcquireShared(arg); if (r &gt;= 0) &#123; setHeadAndPropagate(node, r); p.next = null; // help GC failed = false; return; &#125; &#125; if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) throw new InterruptedException(); &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125; åœ¨å¤±è´¥åä¼šä½¿ç”¨ doAcquireSharedInterruptibly(arg); ä¸æ–­è·å–èµ„æºï¼› final Node node = addWaiter(Node.SHARED); ä¼šåˆ›å»ºèŠ‚ç‚¹ä»¥å…±äº«æ¨¡å¼æ”¾åˆ°é˜Ÿåˆ—é‡Œï¼› åœ¨å¾ªç¯ä¸­ä¸æ–­åˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯ headï¼Œåˆ™å°è¯•è·å–å…±äº«èµ„æºï¼› åœ¨å…±äº«æ¨¡å¼ä¸‹è·å–åˆ°èµ„æºåä¼šä½¿ç”¨ setHeadAndPropagate(node, r); è®¾ç½®å¤´èŠ‚ç‚¹ï¼ŒåŒæ—¶å”¤é†’åç»­èŠ‚ç‚¹ã€‚ tryAcquireShared æ˜¯éœ€è¦å­ç±»å®ç°ï¼Œä¹Ÿå°±æ˜¯åœ¨ Semaphore.Sync çš„å®ç°ç±»ä¸­å®ç°äº†ï¼Œè¿™é‡Œä»¥ FairSync åšè®²è§£ï¼š static final class FairSync extends Sync &#123; private static final long serialVersionUID = 2014338818796000944L; FairSync(int permits) &#123; super(permits); &#125; protected int tryAcquireShared(int acquires) &#123; for (;;) &#123; // å¦‚æœå‰é¢æœ‰èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥è¿”å› -1 è¡¨ç¤ºå¤±è´¥ if (hasQueuedPredecessors()) return -1; // è·å–å½“å‰ä¿¡å·é‡ int available = getState(); // è·å–å½“å‰å‰©ä½™é‡ int remaining = available - acquires; // å¦‚æœå°äº 0 æˆ–è€… CAS è®¾ç½®ä¿¡å·é‡æˆåŠŸ åˆ™ç›´æ¥è¿”å› if (remaining &lt; 0 || compareAndSetState(available, remaining)) return remaining; &#125; &#125;&#125;``` è€Œè¿™æ®µä»£ç çš„å«ä¹‰ï¼š1. å¦‚æœå‰é¢æœ‰èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥é˜»å¡ï¼›2. å¦‚æœå½“å‰å‰©ä½™ä¿¡å·é‡å°äº 0 ï¼Œåˆ™è¿”å›è´Ÿå€¼ï¼Œç›´æ¥é˜»å¡ï¼›3. å¦‚æœå½“å‰å‰©ä½™é‡å¤§äºç­‰äº 0 ï¼Œä¼š CAS æ›´æ–°ä¿¡å·é‡ï¼Œå¹¶è¿”å›éè´Ÿæ•°ã€‚&gt;è¿™å—æ•°å€¼çš„å«ä¹‰ï¼Œåœ¨ AQS ä¸­å®šä¹‰äº†ï¼Œå«ä¹‰å¦‚ä¸‹ï¼š&gt;1. å°äº 0: è¡¨ç¤ºå¤±è´¥ï¼›&gt;2. ç­‰äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œä½†åç»­çš„èŠ‚ç‚¹ä¸èƒ½ä»¥å…±äº«æ¨¡å¼è·å–æˆåŠŸ; &gt;3. å¤§äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œåç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¹Ÿå¯èƒ½ä¼šæˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåç»­ç­‰å¾…çº¿ç¨‹å¿…é¡»æ£€æŸ¥å¯ç”¨æ€§ã€‚#### release()```javapublic void release() &#123; sync.releaseShared(1);&#125;public void release(int permits) &#123; if (permits &lt; 0) throw new IllegalArgumentException(); sync.releaseShared(permits);&#125; å‘å¸ƒè®¸å¯è¯çš„ç»™å®šæ•°é‡ï¼Œè¯¥æ•°é‡å¢åŠ å¯ç”¨çš„è®¸å¯æ•°é‡ã€‚ çœ‹å…¶å†…éƒ¨è°ƒç”¨çš„æ˜¯ Sync çš„ releaseSharedï¼Œ å…¶å®å°±æ˜¯ AQS çš„å¯¹åº”æ–¹æ³•ï¼š public final boolean releaseShared(int arg) &#123; if (tryReleaseShared(arg)) &#123; doReleaseShared(); return true; &#125; return false;&#125; å¦‚æœå®ç°tryReleaseSharedè¿”å›trueï¼Œä»¥å…±äº«æ¨¡å¼é‡Šæ”¾èµ„æºã€‚ å…¶ä¸­çš„ tryReleaseShared éƒ¨åˆ†ç”± Semaphore.Sync ä¸­å®ç°ï¼Œé€»è¾‘å¦‚ä¸‹ï¼š protected final boolean tryReleaseShared(int releases) &#123; for (;;) &#123; // è·å–å½“å‰ state int current = getState(); // å¯¹ state è¿›è¡Œå¢åŠ  int next = current + releases; if (next &lt; current) // overflow throw new Error(&quot;Maximum permit count exceeded&quot;); // ä½¿ç”¨ CAS èµ‹å€¼ if (compareAndSetState(current, next)) return true; &#125;&#125; é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåœ¨ Semaphore çš„ release æ–¹æ³•ä¸­ä¸»è¦å°±æ˜¯å¯¹ state è¿›è¡Œå¢åŠ ï¼Œå¢åŠ æˆåŠŸåä¼šè°ƒç”¨ AQS çš„ doReleaseShared æ–¹æ³•å”¤é†’å¤´èŠ‚ç‚¹ã€‚ æ€»ç»“Q&amp;AQ: æ—¢ç„¶ Semaphore ä¹Ÿæ˜¯åŸºäº AQSï¼Œ é‚£åœ¨ Semaphore ä¸­ state çš„å«ä¹‰ä»£è¡¨ä»€ä¹ˆï¼ŸA: åœ¨ Semaphore ä¸­ state ä»£è¡¨è®¸å¯æ•°é‡ï¼Œacquire æ–¹æ³•å½“è®¸å¯å°äºæŒ‡å®šæ•°é‡ä¼šé˜»å¡çº¿ç¨‹ï¼Œrelease æ–¹æ³•å¢åŠ è®¸å¯å½“è®¸å¯å¢åŠ æˆåŠŸåˆ™å”¤é†’é˜»å¡èŠ‚ç‚¹ã€‚ Q: Semaphore åŸºäº AQS å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼ŸA: åˆå§‹è®¾ç½® state çš„åˆå§‹å€¼ï¼Œå³åˆå§‹è®¸å¯æ•°é‡ã€‚ acquire æ–¹æ³•è®¾ç½®ç›®æ ‡æ•°é‡ï¼Œå½“ç›®æ ‡æ•°é‡å¤§äºå½“å‰æ•°é‡æ—¶ï¼Œä¼šé˜»å¡çº¿ç¨‹å¹¶å°†å…¶æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ã€‚æ­¤å¤„åŸºäº AQS å®ç°ã€‚ release å¯¹ state è¿›è¡Œå¢åŠ ï¼ŒæˆåŠŸåä¼šè°ƒç”¨ AQS çš„ doReleaseShared å”¤é†’å¤´ç»“ç‚¹ã€‚åŒæ ·æ˜¯åŸºäº AQS å®ç°ã€‚ Q: Semaphore å’Œ CountDownLatch æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŸA: Semaphore çš„è®¡æ•°å™¨æ˜¯é€’åŠ çš„ï¼Œè€Œ CountDownLatch æ˜¯é€’å‡çš„ã€‚ç›¸åŒç‚¹å°±æ˜¯è®¡æ•°å™¨éƒ½ä¸å¯ä»¥é‡ç½®ã€‚ ç»“æŸè¯­åœ¨é˜…è¯» Semaphore æºç è¿‡ç¨‹ä¸­ï¼Œå‘ç°å…¶ä¸»è¦åŠŸèƒ½éƒ½æ˜¯åŸºäº AQS å®ç°çš„ï¼Œå¯ä»¥å›é¡¾é˜…è¯» AQS çš„ç›¸å…³ç¬”è®°ã€‚åŒæ · Semaphore ä¹Ÿæ”¯æŒå…¬å¹³å’Œéå…¬å¹³æ¨¡å¼ï¼Œè¿™å—å°±éœ€è¦å°ä¼™ä¼´è‡ªå·±å»é˜…è¯»å•¦ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€å·¥ä½œç¬”è®°ã€‘- ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ä¸ºä»€ä¹ˆäº¤æ˜“å’Œé€€æ¬¾è¦æ‹†å¼€ä¸åŒçš„è¡¨ï¼Ÿ","slug":"work/ä¸ºä»€ä¹ˆè¦æ‹†äº¤æ˜“å’Œé€€æ¬¾è¡¨","date":"2020-09-19T02:00:00.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/09/19/work-trans-refund-table.html","link":"","permalink":"https://liuzhihang.com/2020/09/19/work-trans-refund-table.html","excerpt":"","text":"å‰è¨€ è¿‘æœŸåšæ–°é¡¹ç›®ï¼Œåœ¨è®¾è®¡è¡¨ç»“æ„çš„æ—¶å€™ï¼Œçªç„¶æƒ³èµ·æ¥ä¹‹å‰é¢è¯•çš„æ—¶å€™é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œé‚£æ—¶å€™ä¹Ÿæ˜¯åˆå‡ºèŒ…åºï¼Œå¯¹å¾ˆå¤šä¸œè¥¿ä¸€çŸ¥åŠè§£ï¼ˆå½“ç„¶ç°åœ¨ä¹Ÿæ˜¯ï¼‰ï¼Œå½“æ—¶é‚£ä¸ªå°å“¥å“¥é—®æˆ‘ä¸ºä»€ä¹ˆäº¤æ˜“å’Œé€€æ¬¾è¦æ‹†æˆä¸¤ä¸ªè¡¨ï¼Ÿæ˜¯åŸºäºä»€ä¹ˆè€ƒè™‘ï¼Ÿæœ‰ä»€ä¹ˆå¥½å¤„å’Œä¼˜ç‚¹ä¹ˆï¼Ÿ èƒŒæ™¯é‚£æ˜¯ä¸€ä¸ªé£å’Œæ—¥ä¸½çš„ä¸‹åˆï¼Œå½“ç„¶ï¼Œé£å’Œæ—¥ä¸½çš„ä¸‹åˆåº”è¯¥é…ç‚¹å…¶ä»–çš„å½¢å®¹è¯ï¼Œå®åœ¨æ˜¯æˆ‘æ‰ç–å­¦æµ…ï¼Œåªèƒ½ç”¨è¿™ä¸ªè¯å……å½“äº†ä¸‹å¼€å¤´â€¦â€¦ ï¼ˆæ­¤å¤„çœç•¥å°äº”åƒå­—ï¼‰ èµ¶ç´§è¿›å…¥æ­£æ–‡ï¼ å› ä¸ºä¹‹å‰ä¸€ç›´åšèšåˆæ”¯ä»˜ï¼Œè€Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œä¹Ÿæ˜¯æ”¯ä»˜å’Œé€€æ¬¾è¡¨æ‹†å¼€çš„ï¼Œä¸€ç›´è¿™ä¹ˆç”¨ï¼Œå¹¶æ²¡æœ‰è§‰å¾—ä¸å¦¥ã€‚ æ¯”å¦‚ä¸€ä¸ªäº¤æ˜“è¡¨åŸºæœ¬å°±æ˜¯è¿™æ ·çš„ï¼š å­—æ®µ ç±»å‹ å«ä¹‰ id bigint ä¸»é”® id trans_id varchar äº¤æ˜“è®¢å•å· trans_amount bigint è®¢å•é‡‘é¢ trans_status tinyint äº¤æ˜“çŠ¶æ€ â€¦â€¦ â€¦â€¦ â€¦â€¦ create_time datetime åˆ›å»ºæ—¶é—´ update_time datetime æ›´æ–°æ—¶é—´ é€€æ¬¾è¡¨æ˜¯è¿™æ ·å­çš„ï¼š å­—æ®µ ç±»å‹ å«ä¹‰ id bigint ä¸»é”® id refund_id varchar é€€æ¬¾è®¢å•å· origin_trans_id varchar åŸå§‹äº¤æ˜“è®¢å•å· refund_status tinyint é€€æ¬¾çŠ¶æ€ refund_amount bigint é€€æ¬¾é‡‘é¢ â€¦â€¦ â€¦â€¦ â€¦â€¦ create_time datetime åˆ›å»ºæ—¶é—´ update_time datetime æ›´æ–°æ—¶é—´ å¤§æ¦‚ä¸¤ä¸ªè¡¨å°±æ˜¯è¿™æ ·å­çš„å§ï¼åƒä¸€äº›å…¶ä»–å­—æ®µå°±å…ˆçœç•¥äº†ï¼Œå¹³å¸¸ç”¨ç€ä¹Ÿè§‰å¾—æ²¡ä»€ä¹ˆã€‚ ä½†æ˜¯æ°å¥½é‚£æ¬¡é‚£ä¸ªå°å“¥å“¥å°±é—®äº†è¿™ä¸ªé—®é¢˜ï¼Œæ”¯ä»˜å’Œé€€æ¬¾ä¸ºä»€ä¹ˆè¦åˆ†å¼€è®°å½•ï¼Ÿ å½“æ—¶ä¹Ÿæ˜¯ç¡®å®æ˜¯å®åŠ›ä¸å…è®¸ï¼Œæˆ‘åªæ˜¯è¯´äº†å°±æ˜¯è¿™ä¹ˆç”¨çš„ï¼ŒæŠŠæ­£å‘æµç¨‹å’Œé€†å‘æµç¨‹æ‹†å¼€ï¼Œåˆ†å¼€å®ç°é€»è¾‘ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚ ä¸ªäººè§è§£è¿™é‡Œè¯´çš„ä¸ä»…ä»…æ˜¯äº¤æ˜“å’Œé€€æ¬¾ï¼ŒåŒæ—¶æ³›æŒ‡æ­£å‘äº¤æ˜“å’Œé€†å‘äº¤æ˜“ï¼Œæ¯”å¦‚å……å€¼å’Œæ¶ˆè´¹ï¼Œå€Ÿæ¬¾å’Œè´·æ¬¾ï¼Œè´¦æˆ·å‡ºè´¦å…¥è´¦ç­‰ç­‰ï¼Œä¸‹é¢ä»…è¯´è¯´ä¸ªäººè§è§£ï¼Œåªåšè®¨è®ºï¼Œå¦‚æœå°ä¼™ä¼´æœ‰æ›´å¥½çš„è¯´æ³•ï¼Œå¸Œæœ›å¯ä»¥ç•™è¨€æŒ‡å‡ºï¼Œå…±åŒå­¦ä¹ ã€‚ å¯¹è´¦éœ€è¦å¯¹è´¦æˆ·è€Œè¨€ï¼Œå‡ºæ¬¾è¡¨å’Œå…¥æ¬¾è¡¨æœ€åä¸¤æ–¹çš„é‡‘é¢æ˜¯èƒ½å¯¹çš„ä¸Šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ”¶æ”¯å¹³è¡¡ã€‚ å½“ç„¶è¿™ä¸ªè®°åœ¨ä¸€ä¸ªè¡¨é‡Œä¹Ÿæ˜¯å®Œå…¨å¯ä»¥çš„ã€‚æ¯•ç«Ÿå¯¹å‡ºå…¥è´¦åªæ˜¯æµæ°´æ²¡æœ‰çŠ¶æ€å˜åŒ–ï¼Œæ¯”å¦‚å‡ºè´¦ä¸­ï¼Œå…¥è´¦ä¸­ï¼Œç­‰ç­‰ï¼Œæµæ°´è¡¨å®Œå…¨å¯ä»¥è®°åœ¨ä¸€ä¸ªé‡Œé¢ï¼Œç„¶åç”¨å­—æ®µè¿›è¡Œæ ‡è¯†æ˜¯å‡ºè´¦è¿˜æ˜¯å…¥è´¦ã€‚ æ‹†è¡¨éœ€è¦åœ¨ç½‘ä¸Šçœ‹èµ„æ–™ç»å¸¸ä¼šè¯´åˆ†åº“åˆ†è¡¨ï¼Œè€Œåƒè®¢å•è¿™ç§ï¼ˆäº¤æ˜“/é€€æ¬¾ï¼‰å®Œå…¨ä¸¤ç§ä¸šåŠ¡ï¼Œä½¿ç”¨ä¸¤å¼ è¡¨ç›¸å¯¹è€Œè¨€æ¯”è¾ƒåˆé€‚ï¼Œæ¯•ç«Ÿäº¤æ˜“çš„è®¢å•ç›¸æ¯”é€€æ¬¾è®¢å•è¦å¤šçš„å¤šã€‚ å­—æ®µè®¾è®¡äº¤æ˜“å’Œé€€æ¬¾æ˜¯å®Œå…¨ä¸åŒçš„ä¸¤ç§ä¸šåŠ¡ï¼Œä¸åƒè´¦æˆ·æµæ°´å°±æ˜¯èµ„é‡‘è®°å½•ã€‚ äº¤æ˜“é™¤äº†è®¢å•çŠ¶æ€è¿˜æœ‰ä¸€äº›äº¤æ˜“ä¿¡æ¯æ¯”å¦‚å•†æˆ·å·ã€ä¼˜æƒ é‡‘é¢ã€å®ä»˜é‡‘é¢ã€äº¤æ˜“æ¸ é“ã€å•†å“ id åç§°ã€å¤‡æ³¨ç­‰å„ç§ä¿¡æ¯ã€‚ é€€æ¬¾åˆ™æ˜¯æ ¹æ®åŸå•è¿›è¡Œé€€æ¬¾ï¼Œéœ€è¦è®°å½•åŸå§‹è®¢å•å·ã€é€€æ¬¾é‡‘é¢ï¼ˆéƒ¨åˆ†é€€æ¬¾ï¼‰ã€é€€æ¬¾ä¿¡æ¯ç­‰ã€‚ è™½ç„¶äº¤æ˜“å’Œé€€æ¬¾æ€»ä½“ä¸Šéƒ½åŒ…å« è®¢å•å·ã€çŠ¶æ€ã€é‡‘é¢ç­‰ï¼Œä½†æ˜¯å¦‚æœå¼ºè¡Œæ”¾åœ¨ä¸€ä¸ªè¡¨ï¼Œå°±ä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š å¾ˆå¤šå­—æ®µä¸ºç©ºçš„æƒ…å†µï¼Œæ¯”å¦‚äº¤æ˜“ä¸éœ€è¦åŸå§‹è®¢å•å·ï¼Œé€€æ¬¾éœ€è¦å­˜å‚¨åŸå§‹è®¢å•å·ã€‚æœ¬æ¥å¯ä»¥è®¾ç½®ç´¢å¼•æ¥æé«˜æŸ¥è¯¢æ•ˆç‡çš„å­—æ®µä¹Ÿä¸å¤ªåˆé€‚è®¾ç½®äº†ã€‚ çŠ¶æ€ä¹Ÿä¸ä¸€å®šå¯ä»¥å®Œå…¨å…¼å®¹ï¼Œåƒäº¤æ˜“çŠ¶æ€å’Œé€€æ¬¾çŠ¶æ€å°±å¾ˆéš¾äº’ç›¸å…¼å®¹ã€‚ å¼€å‘æ•ˆç‡äº¤æ˜“å’Œé€€æ¬¾åˆ†å¼€ä¹‹åï¼Œä¸¤ä¸ªäººè´Ÿè´£ä¸åŒçš„ä¸šåŠ¡è¿›è¡Œå¼€å‘ï¼ŒåŒ…æ‹¬ä¸šåŠ¡é€»è¾‘å’ŒæŸ¥è¯¢å±•ç¤ºã€‚å¦‚æœæ”¾åœ¨ä¸€èµ·ï¼Œå°±å¾ˆå¤šå­—æ®µä¸èƒ½ä¿è¯åˆ«äººçŸ¥é“æœ‰è¿˜æ˜¯æ²¡æœ‰ï¼Œæ˜¯å­˜å‚¨è¿˜æ˜¯ä¸å­˜å‚¨ï¼Œæ¯•ç«Ÿè¡¨é‡Œè®¾ç½®çš„éƒ½å¯ä»¥ä¸ºç©ºã€‚è¿™ç§æƒ…å†µä¸‹éœ€è¦å¾ˆå¤šæ²Ÿé€šï¼Œæˆ–è€…å¹²è„†ä¸€ä¸ªäººè¿›è¡Œå¼€å‘ã€‚ è®¾è®¡æ¨¡å¼åŠåŸåˆ™å…¶ä»–ä»è®¾è®¡æ¨¡å¼åŠåŸåˆ™çš„è§’åº¦ä¸Šæ¥è¯´ï¼Œå¯ä»¥è¯´æ˜¯èŒè´£å•ä¸€ï¼Œå½“ç„¶å†é«˜å¤§ä¸Šåç†è®ºçš„æˆ‘è¿™å°±æ‰¯ä¸å‡ºæ¥äº†ã€‚ æ€»ç»“Q&amp;AQ: é‚£å‰ç«¯è¦å°†ä¸¤ç§ç”šè‡³å¤šç§åœ¨ä¸€ä¸ªåˆ—è¡¨å±•ç¤ºè¯¥å¦‚ä½•å¤„ç†ï¼Ÿ A: åœ¨å¾ˆå¤š APP ä¸­å¤§å®¶çœ‹åˆ°çš„å¤šç§è®¢å•éƒ½æ˜¯åœ¨ä¸€ä¸ªåˆ—è¡¨é‡Œé¢å±•ç¤ºå‡ºæ¥çš„ï¼Œæ¯”å¦‚ï¼šæ”¯ä»˜å®çš„è´¦å•é¡µé¢ã€‚ å½“ç„¶ï¼Œå¦‚æœå‰ç«¯åˆ† tab é¡µï¼Œåˆ†å¼€å±•ç¤ºä¸åŒçš„ä¸šåŠ¡ï¼Œé‚£å¯¹åç«¯æ¥è¯´ç®€ç›´ä¸è¦å¤ªå‹å¥½ã€‚ä¸è¿‡å®é™…å¾€å¾€ä¸æ˜¯è¿™æ ·ï¼Œè¿™æ—¶å€™å°±éœ€è¦å°†è®¢å•ç»Ÿä¸€å­˜å‚¨ã€‚ åœ¨è®¢å•æˆåŠŸçš„æ—¶å€™å­˜å‚¨åˆ°ä¸€ä¸ªå…¬å…±å­˜å‚¨ä¸­ï¼Œå¯ä»¥é€šè¿‡ MQ ç­‰ï¼Œå°†æ•°æ®ä¿é€åˆ°å¦ä¸€å¼ è¡¨/åº“ï¼Œæˆ–è€… ES ä¸­ç”¨æ¥å­˜å‚¨ã€‚è¿™æ ·è®¢å•æŸ¥è¯¢è¿˜å¯ä»¥å’Œä¸šåŠ¡é€»è¾‘çš„è¡¨/åº“åˆ†å¼€ã€‚ä¹Ÿå¯ä»¥é€šè¿‡ binlog è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œçš„æ–¹æ¡ˆåªåšå‚è€ƒã€‚ ç»“æŸè¯­ä¹‹æ‰€ä»¥å†™è¿™ç¯‡æ–‡ç« ï¼Œä¹Ÿæ˜¯ä¸ºäº†æ€»ç»“ä¸€ä¸‹æœ€è¿‘å·¥ä½œä¸­é‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠå¤„ç†æ–¹æ³•ã€‚åŒæ—¶ä¸€ç¬é—´æƒ³èµ·æ¥äº†å¾ˆä¹…å‰é‡åˆ°çš„ç›¸åŒçš„é—®é¢˜ã€‚ å¦‚æœå°ä¼™ä¼´ä»¬è¿˜æœ‰åˆ«çš„çœ‹æ³•ï¼Œæ¬¢è¿ç•™è¨€ï¼Œå‘è¡¨è‡ªå·±çš„æ„è§åŠçœ‹æ³•ï¼Œå…±åŒè®¨è®ºã€‚","categories":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- CyclicBarrier ä¸å°±æ˜¯æ¯” CountDownLatch å¤šäº†ä¸ªå›ç¯ä¹ˆï¼Ÿ","slug":"source-code/java/CyclicBarrier","date":"2020-09-12T17:30:00.000Z","updated":"2020-12-27T09:23:14.595Z","comments":true,"path":"2020/09/13/source-code-cyclicbarrier.html","link":"","permalink":"https://liuzhihang.com/2020/09/13/source-code-cyclicbarrier.html","excerpt":"","text":"å‰è¨€ çœ‹å®Œ CountDownLatch æ­£å‡†å¤‡è¡¨ç¤ºä¸€ç•ªï¼Œçªç„¶çœ‹åˆ°äº†ä¸€ä¸ª CyclicBarrier â€”â€” å›ç¯å±éšœã€‚æ²ƒç‰¹ï¼Ÿå›ç¯è¿˜å±éšœï¼Ÿè¯´æ¯” CountDownLatch è¦å¤šä¸€ä¸ªå›ç¯ï¼Œé‚£å’±å¯å¾—ç§ä¸€ç§ï¼Œçœ‹ä¸€çœ‹äº†ï¼ ä»‹ç»ä¸€ä¸ªåŒæ­¥è¾…åŠ©ï¼Œå®ƒå…è®¸ä¸€ç»„çº¿ç¨‹çš„æ‰€æœ‰ç­‰å¾…å½¼æ­¤è¾¾æˆå…±åŒå±éšœç‚¹ã€‚ CyclicBarrier åœ¨æ¶‰åŠå›ºå®šçº¿ç¨‹æ•°ä¸”å¿…é¡»ç­‰å¾…å½¼æ­¤çš„ç¨‹åºéå¸¸æœ‰ç”¨ã€‚ è¯¥å±éšœè¢«ç§°ä¸ºå›ç¯å±éšœ ï¼Œå› ä¸ºå®ƒåœ¨ç­‰å¾…çš„çº¿ç¨‹è¢«é‡Šæ”¾åå¯ä»¥è¢«é‡æ–°åˆ©ç”¨ã€‚ CyclicBarrier æ”¯æŒä¸€ä¸ªå¯é€‰çš„ Runnable å‘½ä»¤ï¼Œè¯¥å‘½ä»¤åœ¨éšœç¢ä¸­çš„æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾ä¹‹åï¼Œä½†åœ¨é‡Šæ”¾ä»»ä½•çº¿ç¨‹ä¹‹å‰ï¼Œæ¯ä¸ªå±éšœç‚¹è¿è¡Œä¸€æ¬¡ã€‚ æ­¤å±éšœæ“ä½œå¯¹äºåœ¨ä»»ä½•ä¸€æ–¹ç»§ç»­ä¹‹å‰æ›´æ–°å…±äº«çŠ¶æ€å¾ˆæœ‰ç”¨ã€‚ é€šè¿‡ä¸Šé¢çš„æºç æ³¨é‡ŠåŸºæœ¬å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š CyclicBarrier å’Œ CountDownLatch ç±»ä¼¼ï¼Œä½†å®ƒæ˜¯ä¸€ç»„çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œçš„ä¸€ç»„æ“ä½œå®Œæˆä¸ºæ­¢ã€‚ CountDownLatch æ˜¯è®¡æ•°é€’å‡ï¼Œç»“æŸåå†è°ƒç”¨ await æˆ–è€… countdown éƒ½ä¼šç«‹å³è¿”å›ï¼Œä½†æ˜¯ CyclicBarrier å¯ä»¥é‡ç½®å±éšœã€‚ CyclicBarrier è¿˜å¯ä»¥ä¼ å…¥å‚æ•° Runnable ï¼ŒRunnable ä¼šåœ¨é‡Šæ”¾çº¿ç¨‹ä¹‹å‰æ‰§è¡Œã€‚ åŸºæœ¬ä½¿ç”¨æ—¢ç„¶ä¸Šé¢æ€»ç»“äº†ä¸‰ä¸ªç»“è®ºï¼Œä¸‹é¢å½“ç„¶ä»ä¸‰ä¸ªæ–¹é¢æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨çš„ï¼š - å±éšœåŠŸèƒ½ public class CyclicBarrierTest &#123; private static final CyclicBarrier CYCLIC_BARRIER = new CyclicBarrier(11); public static void main(String[] args) throws BrokenBarrierException, InterruptedException &#123; ExecutorService pool = new ThreadPoolExecutor(10, 10, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;&gt;(1024), new ThreadFactoryBuilder().setNameFormat(&quot;Thread-pool-%d&quot;).build(), new ThreadPoolExecutor.AbortPolicy()); for (int i = 0; i &lt; 10; i++) &#123; pool.submit(() -&gt; &#123; try &#123; System.out.println(Thread.currentThread().getName() + &quot; å¼€å§‹æ‰§è¡Œ&quot;); Thread.sleep(5000); System.out.println(Thread.currentThread().getName() + &quot; æ‰§è¡Œç»“æŸï¼Œå‡†å¤‡è°ƒç”¨ await&quot;); CYCLIC_BARRIER.await(); &#125; catch (InterruptedException | BrokenBarrierException e) &#123; e.printStackTrace(); &#125; &#125;); &#125; System.out.println(&quot;ä¸»çº¿ç¨‹æ‰§è¡Œ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” &gt;&gt;&gt;&quot;); CYCLIC_BARRIER.await(); System.out.println(&quot;ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” &gt;&gt;&gt;&quot;); pool.shutdown(); &#125;&#125; é€šè¿‡ä¸Šé¢ä»£ç å…¶å®æ¨¡æ‹Ÿäº†ä¸ªç±»ä¼¼ CountDownLatch çš„åŠŸèƒ½ï¼Œè®©æ‰€æœ‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°éƒ½è°ƒç”¨ await ä¹‹åï¼Œå„ä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼ŒåŒæ—¶ä¸»çº¿ç¨‹ä¹Ÿç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚ ä¸è¿‡ç›¸å¯¹ CountDownLatch çš„æŒ‡å®šä¸€ä¸ªçº¿ç¨‹æˆ–å¤šä¸ªç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œç­‰å¾…çš„çº¿ç¨‹æ‰ç»§ç»­æ‰§è¡Œæ¥è¯´ï¼ŒCyclicBarrier ç›¸å¯¹æ¥è¯´è¿˜æ˜¯é€Šè‰²ã€‚ å·®åˆ«æ€»ç»“å¦‚ä¸‹ï¼š CountDownLatch æ˜¯æŒ‡å®šç­‰å¾…çš„çº¿ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹è¿›è¡Œ countDownï¼Œç­‰è®¡æ•°ä¸º 0 æ—¶ï¼Œç­‰å¾…çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚ CyclicBarrier æ˜¯ä¸€ç»„çº¿ç¨‹è°ƒç”¨ await è¿›è¡Œç­‰å¾…ï¼Œå½“æ‰€æœ‰çš„éƒ½è¿›å…¥ç­‰å¾…çš„æ—¶å€™ï¼Œè¿™ä¸€ç»„å°±ä¼šä¸€èµ·å†²ç ´å±éšœç»§ç»­æ‰§è¡Œã€‚ - å›ç¯åŠŸèƒ½ public class CyclicBarrierTest2 &#123; private static final CyclicBarrier CYCLIC_BARRIER = new CyclicBarrier(5); public static void main(String[] args) throws BrokenBarrierException, InterruptedException &#123; ExecutorService pool = new ThreadPoolExecutor(5, 5, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;&gt;(1024), new ThreadFactoryBuilder().setNameFormat(&quot;Thread-pool-%d&quot;).build(), new ThreadPoolExecutor.AbortPolicy()); for (int i = 0; i &lt; 5; i++) &#123; pool.submit(() -&gt; &#123; try &#123; System.out.println(Thread.currentThread().getName() + &quot; å¼€å§‹æ‰§è¡Œ&quot;); CYCLIC_BARRIER.await(); System.out.println(Thread.currentThread().getName() + &quot; å†²ç ´å±éšœ &gt;&gt;&gt; 1&quot;); CYCLIC_BARRIER.await(); System.out.println(Thread.currentThread().getName() + &quot; å†²ç ´å±éšœ &gt;&gt;&gt;&gt;&gt; 2&quot;); CYCLIC_BARRIER.await(); &#125; catch (InterruptedException | BrokenBarrierException e) &#123; e.printStackTrace(); &#125; &#125;); &#125; pool.shutdown(); &#125;&#125; ä¸Šé¢æ¼”ç¤ºçš„å›ç¯çš„ç”¨æ³•ã€‚ - å›ç¯ Runnable è¿™å—åªéœ€è¦åœ¨å£°æ˜çš„ CyclicBarrier ä¿®æ”¹ä¸ºä»¥ä¸‹å³å¯ï¼š private static final CyclicBarrier CYCLIC_BARRIER = new CyclicBarrier(5, new Runnable() &#123; @Override public void run() &#123; System.out.println(&quot;æ‰§è¡Œä¸€æ¬¡ Runnable &quot;); &#125;&#125;); æ‰“å°ç»“æœå¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡ºåªæ˜¯åœ¨ä¸‹ä¸€ä¸ªè®¡æ•°å¼€å§‹ä¹‹å‰ï¼Œå…ˆæ‰§è¡Œ Runnable ã€‚è‡³äºæ˜¯ä¸æ˜¯åœ¨é‡Šæ”¾å±éšœä¹‹å‰ï¼Œé‚£å¾ˆå®¹æ˜“ï¼Œç›´æ¥ Debug èµ°ä¸€é­å°±çŸ¥é“äº†ï¼ä¸“é—¨å½•åˆ¶äº†ä¸ªè§†é¢‘ï¼š é€šè¿‡ debug å¯ä»¥çœ‹å‡ºRunnable ä¼šåœ¨é‡Šæ”¾çº¿ç¨‹ä¹‹å‰æ‰§è¡Œã€‚ é—®é¢˜ç–‘é—®ï¼Ÿ CyclicBarrier å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ CyclicBarrier çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ CyclicBarrier æ˜¯å¦‚ä½•å®ç°å›ç¯çš„ï¼Ÿ ä¸‹é¢å°±å¸¦ç€ç–‘é—®å»æºç é˜…è¯»ï¼Œä¸€æ¢ç©¶ç«Ÿï¼ æºç åˆ†æåŸºæœ¬ç»“æ„ é€šè¿‡ UML ä¹ä¸€çœ‹ï¼ŒCyclicBarrier å’Œ AQS å¹¶æ— ä»€ä¹ˆå…³ç³»ï¼Œé‚£ä¸‹é¢å¼€å§‹ä»å‚æ•°ã€æ„é€ å™¨ã€await()æ–¹æ³•åˆ†åˆ«çœ‹æºç ã€‚ å‚æ•°public class CyclicBarrier &#123; /** * å±éšœçš„æ¯æ¬¡ä½¿ç”¨éƒ½è¡¨ç¤ºä¸ºä¸€ä¸ªç”Ÿæˆå®ä¾‹ã€‚ * broken è¡¨ç¤ºå±éšœæ˜¯å¦è¢«æ‰“ç ´ã€‚ */ private static class Generation &#123; boolean broken = false; &#125; /** é” */ private final ReentrantLock lock = new ReentrantLock(); /** æ¡ä»¶ç­‰å¾…ï¼Œç›´åˆ°å±éšœ */ private final Condition trip = lock.newCondition(); /** ç­‰å¾…è®¡æ•° */ private final int parties; /* The command to run when tripped */ private final Runnable barrierCommand; /** å½“å‰ generation æ–°åˆ›å»ºçš„*/ private Generation generation = new Generation(); /** ä»åœ¨ç­‰å¾…çš„ parties æ•°é‡ï¼Œé€’å‡ ä¸º 0 ä¼šé‡ç½® */ private int count; &#125; é€šè¿‡ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼š å†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ªé™æ€ç±» Generation ï¼Œå®ƒæœ‰ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿé€šè¿‡æ³¨é‡Šäº†è§£åˆ°ï¼Œæ¯æ¬¡ä½¿ç”¨å±éšœçš„æ—¶å€™éƒ½ä¼šç”Ÿæˆï¼Œå…·ä½“æœ‰ä»€ä¹ˆç”¨ï¼Œå…¶å®å°±æ˜¯ç”¨æ¥æ ‡ç¤ºå±éšœæ˜¯å¦è¢«æ‰“ç ´ã€‚ å†…éƒ¨è¿˜æœ‰ä¸€ä¸ª parties è¡¨ç¤ºç­‰å¾…è®¡æ•°ï¼Œcount è¡¨ç¤ºä»åœ¨ç­‰å¾…çš„è®¡æ•°ã€‚ é‚£å°±ç»§ç»­å¾€ä¸‹çœ‹å§ï¼ æ„é€ å™¨public CyclicBarrier(int parties, Runnable barrierAction) &#123; if (parties &lt;= 0) throw new IllegalArgumentException(); this.parties = parties; this.count = parties; this.barrierCommand = barrierAction;&#125; è¿™é‡Œçš„å…¥å‚æœ‰ä¸¤ä¸ªï¼š partiesï¼ˆç­‰å¾…è®¡æ•°ï¼‰ï¼šè®°å½•å¤šå°‘ä¸ªçº¿ç¨‹è°ƒç”¨ await ä¹‹åï¼Œæ‰ä¼šä¸€èµ·æ‰“ç ´å±éšœã€‚ barrierActionï¼šå†²ç ´å±éšœå‰æ‰§è¡Œçš„è¡Œä¸ºã€‚ ä½†æ˜¯ä¼šåŒæ—¶å¯¹ parties å’Œ count èµ‹å€¼ä¸ºä¼ å…¥çš„ partiesã€‚ å•å‚æ•°æ„é€ ï¼Œå…¶å®å°±æ˜¯å°† barrierAction èµ‹å€¼ä¸º nullã€‚ await() æ–¹æ³•åœ¨ç¤ºä¾‹ä¸­ç”¨çš„ await() æ–¹æ³•ï¼Œ é‚£å°±ä» await() æ–¹æ³•å…¥æ‰‹ï¼š public int await() throws InterruptedException, BrokenBarrierException &#123; try &#123; return dowait(false, 0L); &#125; catch (TimeoutException toe) &#123; throw new Error(toe); // cannot happen &#125;&#125; await() æ‰æ˜¯é‡å¤´æˆï¼Œ å…ˆæ¥æ ¹æ®æºç æ³¨é‡Šï¼Œäº†è§£æ˜¯å¹²å˜›çš„ï¼Œçœ‹çœ‹ä½œè€…æ€ä¹ˆè®²ï¼š ç­‰åˆ°æ‰€æœ‰å„æ–¹éƒ½åœ¨æ­¤éšœç¢ä¸Šè°ƒç”¨awaitã€‚ å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æœ€ååˆ°è¾¾çš„çº¿ç¨‹ï¼Œåˆ™å‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„å°†å…¶ç¦ç”¨ï¼Œå¹¶ä½¿å…¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹æƒ…å†µä¹‹ä¸€ï¼š æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾ï¼› å…¶ä»–ä¸€äº›çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ï¼› å…¶ä»–ä¸€äº›çº¿ç¨‹ä¸­æ–­å…¶ä»–æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ä¹‹ä¸€ï¼› ç­‰å¾…å±éšœçš„æ—¶å€™å…¶ä»–çº¿ç¨‹è¶…æ—¶ï¼› å…¶ä»–ä¸€äº›çº¿ç¨‹åœ¨æ­¤å±éšœä¸Šè°ƒç”¨ resetã€‚ çœ‹åˆ°è¿™äº›ï¼Œå’±ä»¬æœ€æƒ³çœ‹çš„å½“ç„¶æ˜¯ 2.1 ï¼Œç­‰å¾…æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœï¼Œä¹‹åæ‰€æœ‰çš„çº¿ç¨‹ä¸€èµ·ç»§ç»­æ‰§è¡Œã€‚ private int dowait(boolean timed, long nanos) throws InterruptedException, BrokenBarrierException, TimeoutException &#123; // åŠ é” final ReentrantLock lock = this.lock; lock.lock(); try &#123; // åœ¨è¿™é‡Œç”¨åˆ°äº†è¿™ä¸ªä»£ final Generation g = generation; if (g.broken) throw new BrokenBarrierException(); // çº¿ç¨‹ç»ˆä¸­æ–­æ ‡ç¤º if (Thread.interrupted()) &#123; breakBarrier(); throw new InterruptedException(); &#125; // å¯¹è®¡æ•°è¿›è¡Œé€’å‡ int index = --count; // å¦‚æœæ˜¯ 0 åˆ™ if (index == 0) &#123; // tripped boolean ranAction = false; try &#123; final Runnable command = barrierCommand; // ä¸æ˜¯ null å…ˆæ‰§è¡Œè¡Œä¸º if (command != null) // è¿™é‡Œä¸æ˜¯æ–°å¼€çº¿ç¨‹ command.run(); ranAction = true; // ä¸‹ä¸€ä»£ nextGeneration(); return 0; &#125; finally &#123; // ä»»åŠ¡æœªæˆåŠŸæ—¶ï¼Œå³ ranAction è¿˜æ˜¯ false æ‰“ç ´å±éšœ if (!ranAction) breakBarrier(); &#125; &#125; // loop until tripped, broken, interrupted, or timed out // è‡ªæ—‹ for (;;) &#123; try &#123; // æ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ if (!timed) // è¿›å…¥ç­‰å¾… trip.await(); else if (nanos &gt; 0L) nanos = trip.awaitNanos(nanos); &#125; catch (InterruptedException ie) &#123; if (g == generation &amp;&amp; ! g.broken) &#123; breakBarrier(); throw ie; &#125; else &#123; Thread.currentThread().interrupt(); &#125; &#125; if (g.broken) throw new BrokenBarrierException(); // å·²ç»ä¸‹ä¸€ä»£äº† if (g != generation) return index; if (timed &amp;&amp; nanos &lt;= 0L) &#123; breakBarrier(); throw new TimeoutException(); &#125; &#125; &#125; finally &#123; lock.unlock(); &#125;&#125; è¿™ä¸€å¤§å¨ä»£ç ï¼Œå®Œå…¨æ²¡æœ‰çœ‹çš„æ¬²æœ›ï¼Œç›´æ¥åˆ’è¿‡å»å§ï¼ æ‰€ä»¥â€¦â€¦ ç›´æ¥çœ‹åˆ°äº†è¿™é‡Œå§ã€‚ ä»£ç è¿˜æ˜¯è¦é˜…è¯»çš„ï¼Œåˆ†å¼€æ¥çœ‹ï¼ˆå¼‚å¸¸æµç¨‹çœç•¥ï¼‰ï¼š ä½¿ç”¨äº† ReentrantLock äº’æ–¥é”ï¼Œå› æ­¤å¯¹ countã€broken çš„ä¿®æ”¹æ˜¯åŸå­æ€§çš„ã€‚ å¯¹ count è¿›è¡Œ â€“count æ“ä½œï¼Œè¿™æ ·å°±ç†è§£ä¸ºä»€ä¹ˆè¯´ count æ˜¯ä»åœ¨ç­‰å¾…çš„è®¡æ•°ï¼Œæˆ–è€…è¯´è¿˜æœ‰å¤šå°‘æ‰èƒ½åˆ°è¾¾å±éšœç‚¹ã€‚ å½“ count ä¸º 0 ï¼Œè¡¨ç¤ºåˆ°è¾¾å±éšœç‚¹äº† command ä¸ä¸º nullï¼Œä¼šå…ˆæ‰§è¡Œ **command.run()**ï¼Œ å€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œå¹¶ä¸æ˜¯æ–°å¼€äº†ä¸ªçº¿ç¨‹ã€‚ **nextGeneration()**å¼€å§‹æ–°çš„ä¸‹ä¸€ä»£ï¼Œå³é‡ç½® count ä¸º partiesã€‚ åœ¨ finally é‡Œé¢ä½¿ç”¨ breakBarrier() æ‰“ç ´å±éšœã€‚ å½“ count ä¸æ˜¯ 0 è‡ªæ—‹ï¼Œç›´åˆ°æ˜¯ 0. è¿™åé¢è¿˜æœ‰ä¸¤ä¸ªæ–¹æ³•ä¸èƒ½å°‘ï¼š private void nextGeneration() &#123; // å”¤é†’çº¿ç¨‹ trip.signalAll(); // æ›´æ–° count ä¸º parties count = parties; // æ›´æ–° Generation generation = new Generation();&#125; // æ‰“ç ´å±éšœï¼Œå¹¶å”¤é†’å…¨éƒ¨private void breakBarrier() &#123; generation.broken = true; count = parties; trip.signalAll();&#125; reset()public void reset() &#123; final ReentrantLock lock = this.lock; lock.lock(); try &#123; breakBarrier(); // break the current generation nextGeneration(); // start a new generation &#125; finally &#123; lock.unlock(); &#125;&#125; å°†å±éšœé‡ç½®ä¸ºå…¶åˆå§‹çŠ¶æ€ï¼Œreset() æ–¹æ³•å…¶å®è¿˜æ˜¯è°ƒç”¨çš„ breakBarrier() å’Œ nextGeneration()ï¼Œå‰è€…æ—¶æ‰“ç ´å½“å‰ä»£ï¼Œåè€…æ˜¯å¼€å§‹æ–°çš„ä¸€è½®ã€‚ æ€»ç»“Q: CyclicBarrier å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼ŸA: é€šè¿‡é˜…è¯»æºç ï¼Œå…¶å®å‘ç°æ˜¯ä½¿ç”¨äº† ReentrantLock äº’æ–¥é” ä»¥åŠ Condition çš„ç­‰å¾…å”¤é†’åŠŸèƒ½ã€‚ Q: CyclicBarrier çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼ŸA: å†…éƒ¨å«æœ‰ä¸¤ä¸ªè®¡æ•°ï¼Œåˆ†åˆ«æ˜¯ parties å’Œ count ï¼Œåˆå§‹æ˜¯äºŒè€…ç›¸ç­‰ï¼Œå½“æœ‰çº¿ç¨‹è°ƒç”¨ await() æ—¶ï¼Œcount é€’å‡ï¼Œåªè¦ count ä¸ä¸º 0 ï¼Œ å°±ä¼šé˜»å¡çº¿ç¨‹ï¼Œç›´åˆ° count é€’å‡ä¸º 0 æ—¶ï¼Œæ­¤æ—¶ä¼šæ‰€æœ‰çº¿ç¨‹ä¸€èµ·é‡Šæ”¾ï¼ŒåŒæ—¶å°† count é‡ç½®ä¸º partiesã€‚ Q: CyclicBarrier æ˜¯å¦‚ä½•å®ç°å›ç¯çš„ï¼ŸA: ä½¿ç”¨ä¸¤ä¸ªè®¡æ•°ï¼Œcount é€’å‡ï¼Œå½“ count ä¸º 0 æ—¶ï¼Œä¼šé‡ç½®ä¸º partiesï¼Œä»è€Œè¾¾åˆ°å›ç¯æ•ˆæœã€‚ Q: ä¸ºä»€ä¹ˆ count çš„ â€“count æ“ä½œæ²¡æœ‰ä½¿ç”¨ CASï¼ŸA: å› ä¸ºå·²ç» lock.lock() äº†ï¼Œä½¿ç”¨äº† ReentrantLock é”èƒ½å¤Ÿä¿è¯ count çš„åŸå­æ€§ã€‚ CyclicBarrier å’Œ CountDownLatch çš„åŒºåˆ« å›ç¯ï¼šCyclicBarrier å¯ä»¥å›ç¯ï¼Œé‡æ–°è®¡æ•°ã€‚CountDownLatch åªèƒ½ä¸€è½®ã€‚ è®¡æ•°å™¨ï¼šCyclicBarrier çš„è®¡æ•°å™¨è‡ªå·±ç»´æŠ¤é€’å‡ï¼Œ CountDownLatch çš„è®¡æ•°å™¨ç»´æŠ¤åˆ™æ˜¯äº¤ç»™ä½¿ç”¨è€…ã€‚ é˜»å¡çº¿ç¨‹ï¼šCyclicBarrier é˜»å¡çš„æ˜¯è‡ªèº«ï¼Œå½“åˆ°è¾¾å±éšœåï¼Œæ‰€æœ‰è¢«é˜»å¡çš„çº¿ç¨‹ä¸€èµ·é‡Šæ”¾ã€‚CountDownLatch å¯ä»¥æŒ‡å®šé˜»å¡çº¿ç¨‹ã€‚ ç»“æŸè¯­æœ¬æ–‡ä¸»è¦ä»‹ç»äº† CyclicBarrier çš„å¸¸ç”¨æ–¹å¼ï¼Œé€šè¿‡æºç æ–¹å¼ï¼Œåˆ†æå¦‚ä½•è¾¾åˆ°å±éšœä»¥åŠå›ç¯çš„æ•ˆæœã€‚ä¸å¯¹ä¹‹å¤„ï¼Œè¯·å¤šæŒ‡æ­£ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€å·¥å…·å†Œã€‘- ç»™å¤§å®¶ä»‹ç»ä¸‹ï¼Œè¿™æ˜¯æˆ‘çš„æµç¨‹å›¾è½¯ä»¶ â€”â€” draw.io","slug":"tool/ç”»å›¾è½¯ä»¶","date":"2020-09-06T09:00:00.000Z","updated":"2020-12-27T09:23:14.248Z","comments":true,"path":"2020/09/06/source-tool-drawio.html","link":"","permalink":"https://liuzhihang.com/2020/09/06/source-tool-drawio.html","excerpt":"","text":"å‰è¨€ ä¹‹å‰æ¨äº†ä¸€ç¯‡æ–‡ç« ã€Šåå¼ å›¾å¸¦å¤§å®¶çœ‹æ‡‚ ES åŸç† ï¼æ˜ç™½ä¸ºä»€ä¹ˆè¯´ï¼šES æ˜¯å‡†å®æ—¶çš„ï¼ã€‹ï¼Œå¾ˆå¤šå°ä¼™ä¼´éƒ½æ¯”è¾ƒå¥½å¥‡åœ¨æ–‡ç« ä¸­çš„å›¾æ˜¯ç”¨çš„ä»€ä¹ˆç”»å›¾è½¯ä»¶ï¼Ÿçœ‹é‚£ä¹ˆæ˜æ˜¾çš„æ‰‹ç»˜é£æ ¼ï¼Œå½“ç„¶æ˜¯æ‰‹ç”»çš„å•¦ï¼ï¼ˆå¼€ç©ç¬‘ï¼‰ï¼Œå…¶å®æˆ‘ç”¨çš„æ˜¯ draw.io ï¼Œä¸‹é¢åˆ†äº«æˆ‘çš„ç”»å›¾è½¯ä»¶ â€”â€” draw.io ã€‚ ä¸ºä»€ä¹ˆéœ€è¦ç”»å›¾ï¼Ÿä¿—è¯è¯´ï¼šâ€œä¸€å›¾é¡¶ç™¾å­—ï¼â€ï¼Œå¥½å§ï¼è¿™æ˜¯æˆ‘ç°æƒ³çš„ä¿—è¯ã€‚ åœ¨æ–°é¡¹ç›®å¼€å‘ï¼ŒæŠ€æœ¯åˆ†äº«ï¼Œé˜…è¯»ä»£ç ç¬”è®°ï¼Œæˆ–è€…é¢è¯•çš„æ—¶å€™ï¼Œç”»ä¸ªæµç¨‹å›¾ï¼Œæ¶æ„å›¾ç­‰ç­‰ï¼Œæ¯”è¾ƒç›´è§‚ï¼Œä¾¿äºç†è§£ç­‰ã€‚ä¼˜ç‚¹å•¥çš„å°±ä¸å¤šä»‹ç»äº†ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»æˆ‘çš„ç”»å›¾è½¯ä»¶ã€‚ åŸºæœ¬è¦æ±‚ å…è´¹ ä½¿ç”¨æ–¹ä¾¿ æ”¯æŒç¦»çº¿ä½¿ç”¨ ç”¨è¿‡çš„å…¶ä»–è½¯ä»¶ Visioï¼šä½¿ç”¨æ–¹ä¾¿ï¼Œåœ¨æœ€å¼€å§‹çš„æ—¶å€™å°±æ˜¯ä½¿ç”¨ Visioï¼Œä¸è¿‡åªèƒ½åœ¨ Win ç³»ç»Ÿä¸Šä½¿ç”¨ã€‚ ProcessOnï¼šåœ¨çº¿ç‰ˆï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œå¾ˆç®€æ´ã€‚ä¸ªäººå…è´¹ï¼Œä¸è¿‡é™åˆ¶æ–‡ä»¶æ•°é‡ã€‚ OmniGraffleï¼šMac å®¢æˆ·ç«¯ï¼Œæ”¶è´¹ï¼Œæœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œä¸è¿‡å¯¹æˆ‘æ¥è¯´æœ‰ç‚¹ç©ä¸ç†Ÿç»ƒã€‚ è¯­é›€ï¼šè¯­é›€ä¹Ÿæ”¯æŒç”»ç®€å•çš„æµç¨‹å›¾ã€‚ å…¶ä»–ä¸€äº›ï¼Œæš‚æ—¶æ²¡æƒ³èµ·æ¥çš„ã€‚ ä½“éªŒäº†å¾ˆå¤šç”»å›¾è½¯ä»¶ï¼Œæœ€åè¿˜æ˜¯ï¼ˆæš‚æ—¶ï¼‰é€‰æ‹©äº† draw.io ã€‚ åŸå› å¾ˆç®€å•ï¼Œæ”¯æŒå¤šå¹³å°ï¼ˆç½‘é¡µ/Win/Mac/Linuxï¼‰ï¼Œå¼€æºå…è´¹ï¼Œæ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©å­˜å‚¨ä½ç½®ã€‚ ä¸‹é¢ç®€å•ä»‹ç»ä¸‹ draw.io draw.ioä½¿ç”¨åœ¨çº¿ç‰ˆå¯ä»¥ç›´æ¥è®¿é—® https://draw.io æˆ–è€… https://app.diagrams.net/ ä½¿ç”¨ï¼Œè¿›å»ä¹‹åå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥é€‰æ‹©å­˜å‚¨ï¼Œå½“ç„¶ä¹Ÿæœ‰ç¦»çº¿ç‰ˆæœ¬ï¼Œå³ drawio-desktop ï¼Œä¸‹è½½åœ°å€ï¼šhttps://github.com/jgraph/drawio-desktop é€‰æ‹©å¯¹åº”çš„å¹³å°ä¸‹è½½å®‰è£…å³å¯ï¼š è®¾ç½®è¯­è¨€æ‰“å¼€ app æˆ–è€… è¿›å…¥ app ä¹‹åå¯ä»¥è®¾ç½®è¯­è¨€ï¼Œå¦‚ä¸‹ï¼š ä½¿ç”¨éƒ½å·²ç»åˆ°è¿™é‡Œäº†ï¼Œå°±ä¸ç”¨è¯´æ€ä¹ˆä½¿ç”¨çš„äº†å§ï¼ä¸‹é¢å±•ç¤ºä¹‹å‰ç”»çš„å›¾ï¼š æ‰‹ç»˜é£æ ¼é‚£æ‰‹ç»˜é£æ ¼æ˜¯æ€ä¹ˆç”»çš„å‘¢ï¼Ÿ ç§˜ç±å°±åœ¨å³ä¾§å·¥å…·æ ï¼Œé€‰ä¸­ Sketch é€‰é¡¹ï¼Œä¹‹åå›¾ç‰‡å°±ä¼šå˜ä¸ºæ‰‹ç»˜é£æ ¼çš„äº†ï¼ æ€»ç»“æœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†äº«æˆ‘å¸¸ç”¨çš„ç”»å›¾è½¯ä»¶ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥ä½¿ç”¨è¯•ä¸€ä¸‹ã€‚è½¯ä»¶ä¸‡ä¸‡åƒï¼Œè‡ªå·±ç”¨çš„é¡ºæ‰‹çš„æ‰æ˜¯æœ€é‡è¦çš„ã€‚ä¸è¿‡ draw.io è¿˜æ˜¯æ¯”è¾ƒæ¨èçš„ã€‚ åç»­æˆ‘ä¹Ÿä¼šåˆ†äº«ä¸€äº›å…¶ä»–è½¯ä»¶å·¥å…·ç­‰ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å…³æ³¨ä»¥ä¸‹ã€‚å¦‚æœæœ‰ä»€ä¹ˆæ¯”è¾ƒæœ‰è¶£æˆ–ç”Ÿäº§åŠ›è½¯ä»¶éƒ½å¯ä»¥ç»™æ¨èä¸‹ã€‚","categories":[{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/"}],"tags":[{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E5%85%B7%E5%86%8C/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- å¿«æ¥çœ‹çœ‹ï¼AQS å’Œ  CountDownLatch æœ‰æ€ä¹ˆæ ·çš„å…³ç³»ï¼Ÿ","slug":"source-code/java/CountDownLatch","date":"2020-09-06T04:00:00.000Z","updated":"2020-12-27T09:23:14.595Z","comments":true,"path":"2020/09/06/source-code-countdownlatch.html","link":"","permalink":"https://liuzhihang.com/2020/09/06/source-code-countdownlatch.html","excerpt":"","text":"å‰è¨€ CountDownLatch ä¸€ä¸ªåŒæ­¥è¾…åŠ©å·¥å…·ï¼ŒåŒæ ·æ˜¯åŸºäº AQS å®ç°ï¼Œæœ¬ç¯‡æ–‡ä»¶ä¸»è¦æ˜¯ä»‹ç» CountDownLatch çš„ä½¿ç”¨ï¼Œä»¥åŠæºç ã€‚ ä»‹ç»ä¸€ä¸ªåŒæ­¥è¾…åŠ©å·¥å…·ï¼Œå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œçš„ä¸€ç»„æ“ä½œå®Œæˆä¸ºæ­¢ ä¸€ä¸ª CountDownLatch åˆå§‹åŒ–ä¸ºç»™å®šè®¡æ•°ã€‚ åœ¨ await æ–¹æ³•é˜»å¡ï¼Œè°ƒç”¨ countDown æ–¹æ³•ä¼šå‡å°‘è®¡æ•°ç›´åˆ°è¾¾åˆ°é›¶ï¼Œæ­¤åæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹è¢«é‡Šæ”¾ï¼Œä»»ä½•åç»­è°ƒç”¨ await éƒ½ä¼šç«‹å³è¿”å›ã€‚ è¿™æ˜¯ä¸€æ¬¡æ€§çš„ç°è±¡ - è®¡æ•°ä¸èƒ½å¤ä½ã€‚ å¦‚æœä½ éœ€è¦ä¸€ä¸ªç‰ˆæœ¬é‡ç½®è®¡æ•°ï¼Œè¯·è€ƒè™‘ä½¿ç”¨CyclicBarrier ã€‚ CountDownLatch æ˜¯ä¸€ç§é€šç”¨çš„åŒæ­¥å·¥å…·ï¼Œå¯ç”¨äºå¤šç§ç”¨é€”ã€‚ ç”¨ä½œä¸€ä¸ªç®€å•çš„å¼€/å…³é”å­˜å™¨ï¼Œæˆ–è€…é—¨ï¼šæ‰€æœ‰çº¿ç¨‹è°ƒç”¨awaitåœ¨é—¨å£ç­‰å¾…ï¼Œç›´åˆ°è¢«è°ƒç”¨ countDown çš„çº¿ç¨‹æ‰“å¼€ã€‚ åˆå§‹åŒ–è®¡æ•°ä¸º N ï¼Œç”¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ° N ä¸ªçº¿ç¨‹å®ŒæˆæŸé¡¹æ“ä½œï¼Œæˆ–æŸäº›åŠ¨ä½œå·²ç»å®Œæˆ N æ¬¡ã€‚ CountDownLatch ä¸€ä¸ªæœ‰ç”¨çš„å±æ€§æ˜¯ï¼Œå®ƒä¸è¦æ±‚è°ƒç”¨ countDown çº¿ç¨‹ç­‰å¾…è®¡æ•°åˆ°è¾¾é›¶ä¹‹å‰ç»§ç»­ï¼Œå®ƒåªæ˜¯é˜»æ­¢ä»»ä½•çº¿ç¨‹é€šè¿‡await ï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹å¯ä»¥é€šè¿‡ã€‚ åŸºæœ¬ä½¿ç”¨åœ¨æˆ‘ä¹‹å‰ CAS é‚£ç¯‡æ–‡ç« ã€Šä»JUCæºç çœ‹CASï¼Œæˆ‘åšäº†ä¸ªç¬”è®° â€¦â€¦ã€‹ä¸­ä»‹ç» CAS ä¸¾ä¾‹æ—¶ä½¿ç”¨äº† CountDownLatchï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š public class CasTest &#123; private static final CountDownLatch LATCH = new CountDownLatch(10); private static int NUM_I = 0; private static volatile int NUM_J = 0; private static final AtomicInteger NUM_K = new AtomicInteger(0); public static void main(String[] args) throws InterruptedException &#123; ExecutorService threadPool = Executors.newFixedThreadPool(10); for (int i = 0; i &lt; 10; i++) &#123; threadPool.execute(new Runnable() &#123; public void run() &#123; for (int j = 0; j &lt; 10000; j++) &#123; NUM_I++; NUM_J++; NUM_K.incrementAndGet(); &#125; LATCH.countDown(); &#125; &#125;); &#125; LATCH.await(); System.out.println(&quot;NUM_I = &quot; + NUM_I); System.out.println(&quot;NUM_J = &quot; + NUM_J); System.out.println(&quot;NUM_K = &quot; + NUM_K.get()); threadPool.shutdown(); &#125;&#125; ç®€å•ä»‹ç»ä¸‹è¿™æ®µä»£ç çš„ä¸»è¦é€»è¾‘åŠåŠŸèƒ½ï¼š CountDownLatch åˆå§‹åŒ–è®¡æ•°ä¸º 10 ã€‚ å¼€ 10 ä¸ªçº¿ç¨‹å»å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œä¸šåŠ¡é€»è¾‘ç»“æŸä¼šè°ƒç”¨ LATCH.countDown() å¯¹è®¡æ•°è¿›è¡Œ -1 æ“ä½œã€‚ åœ¨ LATCH.await() å¤„ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ° LATCH çš„å€¼ä¸º 0 ï¼Œå³ 10 ä¸ªçº¿ç¨‹ä¸šåŠ¡éƒ½å¤„ç†ç»“æŸã€‚ ç„¶åä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚ é—®é¢˜ç–‘é—® CountDownLatch å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ CountDownLatch çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ æºç åˆ†æåŸºæœ¬ç»“æ„ é€šè¿‡ç±»å›¾å¯ä»¥çœ‹å‡ºï¼ŒCountDownLatch å†…éƒ¨å­˜åœ¨ä¸€ä¸ªé™æ€ç±» Syncï¼Œè€Œ Sync ç»§æ‰¿äº† AbstractQueuedSynchronizerã€‚å…·ä½“å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Œåˆ™ä¸‹é¢é€šè¿‡æºç å’Œç”»å›¾ä¸€æ­¥ä¸€æ­¥çš„è¿›è¡Œä»‹ç»ã€‚ åˆå§‹åŒ–public CountDownLatch(int count) &#123; if (count &lt; 0) throw new IllegalArgumentException(&quot;count &lt; 0&quot;); this.sync = new Sync(count);&#125; é€šè¿‡åˆå§‹åŒ–æ„é€ å™¨å¯ä»¥çœ‹å‡ºï¼Œåœ¨ new åˆ›å»ºå¯¹è±¡æ—¶å¿…é¡»ä¼ é€’ä¸€ä¸ª int ç±»å‹çš„éè´Ÿæ•°ã€‚å®ç°é€»è¾‘å¯ä»¥çœ‹å‡ºï¼Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ª Sync å¯¹è±¡ã€‚ private static final class Sync extends AbstractQueuedSynchronizer &#123; private static final long serialVersionUID = 4982264981922014374L; Sync(int count) &#123; setState(count); &#125; int getCount() &#123; return getState(); &#125;&#125; ä¹‹å‰åœ¨ä»‹ç» AQS æºç ä¸­å·²ç»ä»‹ç»äº† state çš„å«ä¹‰ï¼Œstate åœ¨ä¸åŒå­ç±»ä¸­ä»£è¡¨ä¸åŒçš„å«ä¹‰ã€‚ åœ¨ ReentrantLock ä¸­ state ä»£è¡¨åŠ é”çŠ¶æ€ï¼Œ0 æ²¡æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äºç­‰äº 1 å·²ç»æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äº 1 è¯´æ˜è¯¥è·å¾—é”çš„çº¿ç¨‹å¤šæ¬¡é‡å…¥ã€‚ åœ¨ ReentrantReadWriteLock ä¸­ state ä»£è¡¨é”çš„çŠ¶æ€ã€‚state ä¸º 0 ï¼Œæ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œstate çš„é«˜ 16 ä¸ºä»£è¡¨è¯»é”çŠ¶æ€ï¼Œä½ 16 ä¸ºä»£è¡¨å†™é”çŠ¶æ€ã€‚é€šè¿‡ä½è¿ç®—å¯ä»¥è·å–è¯»å†™é”çš„å®é™…å€¼ã€‚ è€Œåœ¨è¿™é‡Œ ï¼ˆCountDownLatchï¼‰åˆ™ä»£è¡¨é—¨é—©æˆ–è€…è¯´è®¡æ•°çš„å€¼ã€‚ countDownpublic void countDown() &#123; sync.releaseShared(1);&#125; é€’å‡é”å­˜å™¨çš„è®¡æ•°ï¼š å¦‚æœå½“å‰è®¡æ•°å¤§äºé›¶ï¼Œåˆ™é€’å‡ã€‚ å¦‚æœè®¡æ•°åˆ°è¾¾é›¶ï¼Œåˆ™é‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚ å¦‚æœé‚£ä¹ˆå½“å‰è®¡æ•°ç­‰äºé›¶æ²¡æœ‰ä»»ä½•ååº”ã€‚ æ­¤å¤„è°ƒç”¨çš„æ˜¯ AQS çš„ releaseShard() æ–¹æ³•ï¼Œé‡Šæ”¾å…±äº«èµ„æºã€‚ // AQS ä»£ç public final boolean releaseShared(int arg) &#123; if (tryReleaseShared(arg)) &#123; doReleaseShared(); return true; &#125; return false;&#125; åœ¨ AQS é‡Šæ”¾å…±äº«èµ„æºæ–¹æ³•ä¸­ tryReleaseShared(arg) éƒ¨åˆ†æ˜¯åœ¨ CountDownLatch çš„å†…éƒ¨ç±» Sync ä¸­å®ç°çš„ï¼Œä»£ç éƒ¨åˆ†å¦‚ä¸‹ï¼š protected boolean tryReleaseShared(int releases) &#123; // Decrement count; signal when transition to zero for (;;) &#123; int c = getState(); if (c == 0) return false; int nextc = c-1; if (compareAndSetState(c, nextc)) return nextc == 0; &#125;&#125; é€’å‡æ›´æ–° state ï¼Œå¦‚æœ state ä¸º 0 åˆ™è¿”å› falseï¼Œå¦åˆ™è¿”å› true ã€‚ æ­¤æ—¶å†å¯¹ç…§ä¸Šé¢ AQS ä»£ç ï¼Œå‘ç°ï¼šå¦‚æœ tryReleaseShared è¿”å› true ï¼Œåˆ™ä¼šå”¤é†’åç»­èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œæ“ä½œã€‚æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ state ä¸ä¸º 0ï¼Œåˆ™ä¸ä¼šå”¤é†’åç»­èŠ‚ç‚¹ï¼Œç›´åˆ° state ä¸º 0 ã€‚ awaitpublic void await() throws InterruptedException &#123; sync.acquireSharedInterruptibly(1);&#125; å¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°é”å­˜å™¨å€’è®¡æ•°è‡³é›¶ï¼Œé™¤éçº¿ç¨‹è¢«ä¸­æ–­ã€‚ å¦‚æœå½“å‰è®¡æ•°ä¸ºé›¶ï¼Œåˆ™æ­¤æ–¹æ³•ç«‹å³è¿”å›ã€‚ å¦‚æœå½“å‰è®¡æ•°å¤§äºé›¶ï¼Œåˆ™å½“å‰çº¿ç¨‹ç”¨äºçº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œç¦ç”¨å¹¶ä¸€ç›´å¤„äºä¼‘çœ çŠ¶æ€çš„ä¸¤ä»¶äº‹æƒ…ä¹‹ä¸€å‘ç”Ÿï¼š å› è°ƒç”¨countDownæ–¹æ³•ä½¿è®¡æ•°è¾¾åˆ°0; å…¶ä»–æŸäº›çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ã€‚ public final void acquireSharedInterruptibly(int arg) throws InterruptedException &#123; if (Thread.interrupted()) throw new InterruptedException(); if (tryAcquireShared(arg) &lt; 0) doAcquireSharedInterruptibly(arg);&#125; AQS å®šä¹‰äº† tryAcquireShared è¿”å›å€¼åˆ†ä¸º 3 ç§ï¼š å°äº 0: è¡¨ç¤ºå¤±è´¥ï¼› ç­‰äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œä½†åç»­çš„èŠ‚ç‚¹ä¸èƒ½ä»¥å…±äº«æ¨¡å¼è·å–æˆåŠŸ; å¤§äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œåç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¹Ÿå¯èƒ½ä¼šæˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåç»­ç­‰å¾…çº¿ç¨‹å¿…é¡»æ£€æŸ¥å¯ç”¨æ€§ã€‚ å…¶ä¸­ tryAcquireShared åŒæ ·ç”± CountDownLatch çš„å†…éƒ¨ç±» Sync ä¸­å®ç°ï¼Œå†…éƒ¨é€»è¾‘ä¸»è¦æ˜¯åˆ¤æ–­ state çš„å€¼ï¼Œè¿›è¡Œè¿”å›ã€‚ åœ¨å†…éƒ¨å®ç°ä¸­è¿”å›çš„å€¼åªæœ‰ 1 å’Œ -1 ï¼Œè¯´æ˜åœ¨ state == 0 æ—¶ï¼Œè¿”å› 1 ï¼Œå³å”¤é†’åç»­èŠ‚ç‚¹ã€‚ä¸ç­‰äº 0 æ—¶ï¼Œä¼šé˜»å¡ã€‚ protected int tryAcquireShared(int acquires) &#123; return (getState() == 0) ? 1 : -1;&#125; æ€»ç»“Q: CountDownLatch å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ A: CountDownLatch æ˜¯åŸºäº AQS çš„å…±äº«æ¨¡å¼å®ç°çš„ã€‚ Q: CountDownLatch çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ A: å¯ä»¥å‚è€ƒä¸Šé¢çš„æºç è§£æï¼Œè¿›è¡Œæ€»ç»“ä»‹ç»ã€‚ CountDownLatch æ˜¯åŸºäº AQS å…±äº«æ¨¡å¼å®ç°çš„ï¼Œåœ¨åˆå§‹åŒ–æ—¶å¿…é¡»ä¼ å…¥è®¡æ•°ï¼Œè¯¥è®¡æ•°å®é™…ä¸Šæ˜¯ AQS çš„ state å€¼ã€‚åœ¨ countDown æ—¶å¯¹ state è¿›è¡Œé€’å‡ï¼Œåœ¨ å½“ state ä¸º 0 æ—¶ ä¼šå”¤é†’ AQS é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ç­‰å¾…çš„èŠ‚ç‚¹ ï¼ˆå› ä¸ºæ˜¯å…±äº«æ¨¡å¼ï¼‰ã€‚è€Œ await æ–¹æ³•æ˜¯åˆ¤æ–­ state çš„å€¼ï¼Œå¦‚æœä¸æ˜¯ 0 ï¼Œåˆ™æ‰€æœ‰çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­é˜»å¡ï¼Œç­‰å¾…å”¤é†’ã€‚ Q: state åœ¨ä»£è¡¨çš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼ŸA: åœ¨ ReentrantLock ä¸­ state ä»£è¡¨åŠ é”çŠ¶æ€ï¼Œ0 æ²¡æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äºç­‰äº 1 å·²ç»æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äº 1 è¯´æ˜è¯¥è·å¾—é”çš„çº¿ç¨‹å¤šæ¬¡é‡å…¥ã€‚ åœ¨ ReentrantReadWriteLock ä¸­ state ä»£è¡¨é”çš„çŠ¶æ€ã€‚state ä¸º 0 ï¼Œæ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œstate çš„é«˜ 16 ä¸ºä»£è¡¨è¯»é”çŠ¶æ€ï¼Œä½ 16 ä¸ºä»£è¡¨å†™é”çŠ¶æ€ã€‚é€šè¿‡ä½è¿ç®—å¯ä»¥è·å–è¯»å†™é”çš„å®é™…å€¼ã€‚ è€Œåœ¨è¿™é‡Œ ï¼ˆCountDownLatchï¼‰åˆ™ä»£è¡¨é—¨é—©æˆ–è€…è¯´è®¡æ•°çš„å€¼ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€Elasticsearch æŠ€æœ¯åˆ†äº«ã€‘â€”â€” åå¼ å›¾å¸¦å¤§å®¶çœ‹æ‡‚ ES åŸç† ï¼æ˜ç™½ä¸ºä»€ä¹ˆè¯´ï¼šES æ˜¯å‡†å®æ—¶çš„ï¼","slug":"elk/5. ES ä¸ºä»€ä¹ˆæ˜¯å‡†å®æ—¶çš„","date":"2020-08-28T17:20:00.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/08/29/technology-sharing-es-5.html","link":"","permalink":"https://liuzhihang.com/2020/08/29/technology-sharing-es-5.html","excerpt":"","text":"å‰è¨€ è¯´åˆ° Elasticsearch ï¼Œå…¶ä¸­æœ€æ˜æ˜¾çš„ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯ near real-time å‡†å®æ—¶ â€”â€” å½“æ–‡æ¡£å­˜å‚¨åœ¨Elasticsearchä¸­æ—¶ï¼Œå°†åœ¨1ç§’å†…ä»¥å‡ ä¹å®æ—¶çš„æ–¹å¼å¯¹å…¶è¿›è¡Œç´¢å¼•å’Œå®Œå…¨æœç´¢ã€‚é‚£ä¸ºä»€ä¹ˆè¯´ ES æ˜¯å‡†å®æ—¶çš„å‘¢ï¼Ÿ Lucene å’Œ ESLuceneLucene æ˜¯ Elasticsearchæ‰€åŸºäºçš„ Java åº“ï¼Œå®ƒå¼•å…¥äº†æŒ‰æ®µæœç´¢çš„æ¦‚å¿µã€‚ Segmentï¼š ä¹Ÿå«æ®µï¼Œç±»ä¼¼äºå€’æ’ç´¢å¼•ï¼Œç›¸å½“äºä¸€ä¸ªæ•°æ®é›†ã€‚ Commit pointï¼šæäº¤ç‚¹ï¼Œè®°å½•ç€æ‰€æœ‰å·²çŸ¥çš„æ®µã€‚ Lucene indexï¼š â€œa collection of segments plus a commit pointâ€ã€‚ç”±ä¸€å † Segment çš„é›†åˆåŠ ä¸Šä¸€ä¸ªæäº¤ç‚¹ç»„æˆã€‚ å¯¹äºä¸€ä¸ª Lucene index çš„ç»„æˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ Elasticsearchä¸€ä¸ª Elasticsearch Index ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ª shard ï¼ˆåˆ†ç‰‡ï¼‰ ç»„æˆã€‚ è€Œ Lucene ä¸­çš„ Lucene index ç›¸å½“äº ES çš„ä¸€ä¸ª shardã€‚ å†™å…¥è¿‡ç¨‹å†™å…¥è¿‡ç¨‹ 1.0 ï¼ˆä¸å®Œå–„ï¼‰ ä¸æ–­å°† Document å†™å…¥åˆ° In-memory buffer ï¼ˆå†…å­˜ç¼“å†²åŒºï¼‰ã€‚ å½“æ»¡è¶³ä¸€å®šæ¡ä»¶åå†…å­˜ç¼“å†²åŒºä¸­çš„ Documents åˆ·æ–°åˆ°ç£ç›˜ã€‚ ç”Ÿæˆæ–°çš„ segment ä»¥åŠä¸€ä¸ª Commit point æäº¤ç‚¹ã€‚ è¿™ä¸ª segment å°±å¯ä»¥åƒå…¶ä»– segment ä¸€æ ·è¢«è¯»å–äº†ã€‚ ç”»å›¾å¦‚ä¸‹ï¼š å°†æ–‡ä»¶åˆ·æ–°åˆ°ç£ç›˜æ˜¯éå¸¸è€—è´¹èµ„æºçš„ï¼Œè€Œä¸”åœ¨å†…å­˜ç¼“å†²åŒºå’Œç£ç›˜ä¸­é—´å­˜åœ¨ä¸€ä¸ªé«˜é€Ÿç¼“å­˜ï¼ˆcacheï¼‰ï¼Œä¸€æ—¦æ–‡ä»¶è¿›å…¥åˆ° cache å°±å¯ä»¥åƒç£ç›˜ä¸Šçš„ segment ä¸€æ ·è¢«è¯»å–äº†ã€‚ å†™å…¥è¿‡ç¨‹ 2.0 ä¸æ–­å°† Document å†™å…¥åˆ° In-memory buffer ï¼ˆå†…å­˜ç¼“å†²åŒºï¼‰ã€‚ å½“æ»¡è¶³ä¸€å®šæ¡ä»¶åå†…å­˜ç¼“å†²åŒºä¸­çš„ Documents åˆ·æ–°åˆ° é«˜é€Ÿç¼“å­˜ï¼ˆcacheï¼‰ã€‚ ç”Ÿæˆæ–°çš„ segment ï¼Œè¿™ä¸ª segment è¿˜åœ¨ cache ä¸­ã€‚ è¿™æ—¶å€™è¿˜æ²¡æœ‰ commit ï¼Œä½†æ˜¯å·²ç»å¯ä»¥è¢«è¯»å–äº†ã€‚ ç”»å›¾å¦‚ä¸‹ï¼š æ•°æ®ä» buffer åˆ° cache çš„è¿‡ç¨‹æ˜¯å®šæœŸæ¯ç§’åˆ·æ–°ä¸€æ¬¡ã€‚æ‰€ä»¥æ–°å†™å…¥çš„ Document æœ€æ…¢ 1 ç§’å°±å¯ä»¥åœ¨ cache ä¸­è¢«æœç´¢åˆ°ã€‚ è€Œ Document ä» buffer åˆ° cache çš„è¿‡ç¨‹å«åš ?refresh ã€‚ä¸€èˆ¬æ˜¯ 1 ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œä¸éœ€è¦è¿›è¡Œé¢å¤–ä¿®æ”¹ã€‚å½“ç„¶ï¼Œå¦‚æœæœ‰ä¿®æ”¹çš„éœ€è¦ï¼Œå¯ä»¥å‚è€ƒæ–‡æœ«çš„ç›¸å…³èµ„æ–™ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¯´ Elasticsearch æ˜¯å‡†å®æ—¶çš„ã€‚ ä½¿æ–‡æ¡£ç«‹å³å¯è§ï¼š PUT /test/_doc/1?refresh&#123;&quot;test&quot;: &quot;test&quot;&#125;// æˆ–è€…PUT /test/_doc/2?refresh=true&#123;&quot;test&quot;: &quot;test&quot;&#125; Translog äº‹åŠ¡æ—¥å¿—æ­¤å¤„å¯ä»¥è”æƒ³ Mysql çš„ binlogï¼Œ ES ä¸­ä¹Ÿå­˜åœ¨ä¸€ä¸ª translog ç”¨æ¥å¤±è´¥æ¢å¤ã€‚ Document ä¸æ–­å†™å…¥åˆ° In-memory bufferï¼Œæ­¤æ—¶ä¹Ÿä¼šè¿½åŠ  translogã€‚ å½“ buffer ä¸­çš„æ•°æ®æ¯ç§’ refresh åˆ° cache ä¸­æ—¶ï¼Œtranslog å¹¶æ²¡æœ‰è¿›å…¥åˆ°åˆ·æ–°åˆ°ç£ç›˜ï¼Œæ˜¯æŒç»­è¿½åŠ çš„ã€‚ translog æ¯éš” 5s ä¼š fsync åˆ°ç£ç›˜ã€‚ translog ä¼šç»§ç»­ç´¯åŠ å˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œå½“ translog å¤§åˆ°ä¸€å®šç¨‹åº¦æˆ–è€…æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œä¼šæ‰§è¡Œ flushã€‚ flush æ“ä½œä¼šåˆ†ä¸ºä»¥ä¸‹å‡ æ­¥æ‰§è¡Œï¼š buffer è¢«æ¸…ç©ºã€‚ è®°å½• commit pointã€‚ cache å†…çš„ segment è¢« fsync åˆ·æ–°åˆ°ç£ç›˜ã€‚ translog è¢«åˆ é™¤ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š translog æ¯ 5s åˆ·æ–°ä¸€æ¬¡ç£ç›˜ï¼Œæ‰€ä»¥æ•…éšœé‡å¯ï¼Œå¯èƒ½ä¼šä¸¢å¤± 5s çš„æ•°æ®ã€‚ translog æ‰§è¡Œ flush æ“ä½œï¼Œé»˜è®¤ 30 åˆ†é’Ÿä¸€æ¬¡ï¼Œæˆ–è€… translog å¤ªå¤§ ä¹Ÿä¼šæ‰§è¡Œã€‚ æ‰‹åŠ¨æ‰§è¡Œflushï¼š POST /my-index-000001/_flush åˆ é™¤å’Œæ›´æ–°segment ä¸å¯æ”¹å˜ï¼Œæ‰€ä»¥ docment å¹¶ä¸èƒ½ä»ä¹‹å‰çš„ segment ä¸­ç§»é™¤æˆ–æ›´æ–°ã€‚ æ‰€ä»¥æ¯æ¬¡ commitï¼Œ ç”Ÿæˆ commit point æ—¶ï¼Œä¼šæœ‰ä¸€ä¸ª .del æ–‡ä»¶ï¼Œé‡Œé¢ä¼šåˆ—å‡ºè¢«åˆ é™¤çš„ documentï¼ˆé€»è¾‘åˆ é™¤ï¼‰ã€‚è€ŒæŸ¥è¯¢æ—¶ï¼Œè·å–åˆ°çš„ç»“æœåœ¨è¿”å›å‰ä¼šç»è¿‡ .del è¿‡æ»¤ã€‚ æ›´æ–°æ—¶ï¼Œä¹Ÿä¼šæ ‡è®°æ—§çš„ docment è¢«åˆ é™¤ï¼Œå†™å…¥åˆ° .del æ–‡ä»¶ï¼ŒåŒæ—¶ä¼šå†™å…¥ä¸€ä¸ªæ–°çš„æ–‡ä»¶ã€‚æ­¤æ—¶æŸ¥è¯¢ä¼šæŸ¥è¯¢åˆ°ä¸¤ä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œä½†åœ¨è¿”å›å‰ä¼šè¢«ç§»é™¤æ‰ä¸€ä¸ªã€‚ segment åˆå¹¶æ¯ 1s æ‰§è¡Œä¸€æ¬¡ refresh éƒ½ä¼šå°†å†…å­˜ä¸­çš„æ•°æ®åˆ›å»ºä¸€ä¸ª segmentã€‚ segment æ•°ç›®å¤ªå¤šä¼šå¸¦æ¥è¾ƒå¤§çš„éº»çƒ¦ã€‚ æ¯ä¸€ä¸ª segment éƒ½ä¼šæ¶ˆè€—æ–‡ä»¶å¥æŸ„ã€å†…å­˜å’Œcpuè¿è¡Œå‘¨æœŸã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæ¯ä¸ªæœç´¢è¯·æ±‚éƒ½å¿…é¡»è½®æµæ£€æŸ¥æ¯ä¸ª segment ï¼›æ‰€ä»¥ segment è¶Šå¤šï¼Œæœç´¢ä¹Ÿå°±è¶Šæ…¢ã€‚ åœ¨ ES åå°ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œ segment åˆå¹¶ã€‚ refreshæ“ä½œä¼šåˆ›å»ºæ–°çš„ segment å¹¶æ‰“å¼€ä»¥ä¾›æœç´¢ä½¿ç”¨ã€‚ åˆå¹¶è¿›ç¨‹é€‰æ‹©ä¸€å°éƒ¨åˆ†å¤§å°ç›¸ä¼¼çš„ segmentï¼Œå¹¶ä¸”åœ¨åå°å°†å®ƒä»¬åˆå¹¶åˆ°æ›´å¤§çš„ segment ä¸­ã€‚è¿™å¹¶ä¸ä¼šä¸­æ–­ç´¢å¼•å’Œæœç´¢ã€‚ å½“åˆå¹¶ç»“æŸï¼Œè€çš„ segment è¢«åˆ é™¤ è¯´æ˜åˆå¹¶å®Œæˆæ—¶çš„æ´»åŠ¨ï¼š æ–°çš„ segment è¢«åˆ·æ–°ï¼ˆflushï¼‰åˆ°äº†ç£ç›˜ã€‚ å†™å…¥ä¸€ä¸ªåŒ…å«æ–° segment ä¸”æ’é™¤æ—§çš„å’Œè¾ƒå°çš„ segmentçš„æ–° commit pointã€‚ æ–°çš„ segment è¢«æ‰“å¼€ç”¨æ¥æœç´¢ã€‚ è€çš„ segment è¢«åˆ é™¤ã€‚ ç‰©ç†åˆ é™¤ï¼š åœ¨ segment merge è¿™å—ï¼Œé‚£äº›è¢«é€»è¾‘åˆ é™¤çš„ document æ‰ä¼šè¢«çœŸæ­£çš„ç‰©ç†åˆ é™¤ã€‚ æ€»ç»“ä¸»è¦ä»‹ç»äº†å†…éƒ¨å†™å…¥å’Œåˆ é™¤çš„è¿‡ç¨‹ï¼Œéœ€è¦äº†è§£ refreshã€fsyncã€flushã€.delã€segment merge ç­‰åè¯çš„å…·ä½“å«ä¹‰ã€‚ å®Œæ•´ç”»å›¾å¦‚ä¸‹ï¼š ä»¥ä¸Šå°±æ˜¯ä¸ªäººåˆ†äº«çš„ ES ç›¸å…³çš„å†…å®¹ï¼Œä¸»è¦ç›®çš„æ˜¯ç»„å†…æŠ€æœ¯åˆ†äº«ï¼Œè¿›è¡Œæ‰«ç›²ã€‚ä¸å¯¹ä¹‹å¤„ï¼Œå¸Œæœ›å¤§å®¶ç•™è¨€æŒ‡æ­£ã€‚ ç›¸å…³èµ„æ–™ å‡†å®æ—¶æœç´¢ï¼š https://www.elastic.co/guide/en/elasticsearch/reference/7.9/near-real-time.html Refresh APIï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/7.9/indices-refresh.html Flush APIï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/7.9/indices-flush.html","categories":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"ELK","slug":"å·¥ä½œç¬”è®°/ELK","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/ELK/"}],"tags":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"ã€Elasticsearch æŠ€æœ¯åˆ†äº«ã€‘â€”â€” ES æŸ¥è¯¢æ£€ç´¢æ•°æ®çš„è¿‡ç¨‹ï¼Œæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ","slug":"elk/4. ES æŸ¥è¯¢æ£€ç´¢çš„è¿‡ç¨‹","date":"2020-08-26T12:20:00.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/08/26/technology-sharing-es-4.html","link":"","permalink":"https://liuzhihang.com/2020/08/26/technology-sharing-es-4.html","excerpt":"","text":"å‰è¨€ ES ä½¿ç”¨è¿‡ç¨‹ä¸­å¸¸ç”¨çš„å°±æ˜¯æŸ¥è¯¢ä»¥åŠæ£€ç´¢ï¼Œé‚£æŸ¥è¯¢å’Œæ£€ç´¢çš„è¿‡ç¨‹ï¼Œä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ æŸ¥è¯¢æµç¨‹GET my-index/_doc/0 Client å°†è¯·æ±‚å‘é€åˆ°ä»»æ„èŠ‚ç‚¹ nodeï¼Œæ­¤æ—¶ node èŠ‚ç‚¹å°±æ˜¯åè°ƒèŠ‚ç‚¹ï¼ˆcoordinating nodeï¼‰ã€‚ åè°ƒèŠ‚ç‚¹å¯¹ id è¿›è¡Œè·¯ç”±ï¼Œä»è€Œåˆ¤æ–­è¯¥æ•°æ®åœ¨å“ªä¸ªshardã€‚ åœ¨ primary shard å’Œ replica shard ä¹‹é—´ éšæœºé€‰æ‹©ä¸€ä¸ªï¼Œè¯·æ±‚è·å– docã€‚ æ¥æ”¶è¯·æ±‚çš„èŠ‚ç‚¹ä¼šå°†æ•°æ®è¿”å›ç»™åè°ƒèŠ‚ç‚¹ï¼Œåè°ƒèŠ‚ç‚¹ä¼šå°†æ•°æ®è¿”å›ç»™Clientã€‚ å¯ä»¥é€šè¿‡ preference å‚æ•°æŒ‡å®šæ‰§è¡Œæ“ä½œçš„èŠ‚ç‚¹æˆ–åˆ†ç‰‡ã€‚é»˜è®¤ä¸ºéšæœºã€‚ æ£€ç´¢æµç¨‹GET /my-index/_search Client å°†è¯·æ±‚å‘é€åˆ°ä»»æ„èŠ‚ç‚¹ nodeï¼Œæ­¤æ—¶ node èŠ‚ç‚¹å°±æ˜¯åè°ƒèŠ‚ç‚¹ï¼ˆcoordinating nodeï¼‰ åè°ƒèŠ‚ç‚¹è¿›è¡Œåˆ†è¯ç­‰æ“ä½œåï¼Œå»æŸ¥è¯¢æ‰€æœ‰çš„ shard ï¼ˆprimary shard å’Œ replica shard é€‰æ‹©ä¸€ä¸ªï¼‰ æ‰€æœ‰ shard å°†æ»¡è¶³æ¡ä»¶çš„æ•°æ® id æ’åºå­—æ®µ ç­‰ä¿¡æ¯è¿”å›ç»™è·¯ç”±èŠ‚ç‚¹ è·¯ç”±èŠ‚ç‚¹é‡æ–°è¿›è¡Œæ’åºï¼Œæˆªå–æ•°æ®åï¼Œè·å–åˆ°çœŸæ­£éœ€è¦è¿”å›çš„æ•°æ®çš„ id è·¯ç”±èŠ‚ç‚¹å†æ¬¡è¯·æ±‚å¯¹åº”çš„ shard ï¼ˆæ­¤æ—¶æœ‰ id äº†ï¼Œå¯ä»¥ç›´æ¥å®šä½åˆ°å¯¹åº”shardï¼‰ è·å–åˆ°å…¨é‡æ•°æ®ï¼Œè¿”å›ç»™ Client æ€»ç»“ä¸»è¦ä»‹ç»äº† ES æŸ¥è¯¢ä»¥åŠæ£€ç´¢çš„æµç¨‹ï¼Œä¸è¶³åŠé”™è¯¯ä¹‹å¤„æ¬¢è¿æŒ‡æ­£ã€‚ å‚è€ƒæ–‡æ¡£ åè°ƒèŠ‚ç‚¹ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-node.html#coordinating-node","categories":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"ELK","slug":"å·¥ä½œç¬”è®°/ELK","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/ELK/"}],"tags":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"ã€Elasticsearch æŠ€æœ¯åˆ†äº«ã€‘â€”â€” Elasticsearch å­˜å‚¨ä¸€æ¡æ•°æ®ï¼Œ put è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ","slug":"elk/3. ES æ•°æ®çš„å­˜å‚¨ put çš„è¿‡ç¨‹","date":"2020-08-25T16:10:00.000Z","updated":"2020-12-27T09:23:14.768Z","comments":true,"path":"2020/08/26/technology-sharing-es-3.html","link":"","permalink":"https://liuzhihang.com/2020/08/26/technology-sharing-es-3.html","excerpt":"","text":"å‰è¨€ åœ¨å‰é¢å·²ç»ä»‹ç»äº† ES ä¸­å¸¸ç”¨çš„ä¸€äº›åè¯ï¼ŒçŸ¥é“äº†æ•°æ®æ˜¯å­˜å‚¨åœ¨ shard ä¸­çš„ï¼Œè€Œ index ä¼šæ˜ å°„ä¸€ä¸ªæˆ–è€…å¤šä¸ª shard ã€‚é‚£è¿™æ—¶å€™æˆ‘è¦å­˜å‚¨ä¸€æ¡æ•°æ®åˆ°æŸä¸ªç´¢å¼•ä¸‹ï¼Œè¿™æ¡æ•°æ®æ˜¯åœ¨å“ªä¸ª index ä¸‹çš„å‘¢ï¼Ÿ ES æ¼”ç¤ºä¸€åˆ‡æŒ‰ç…§å®˜æ–¹æ•™ç¨‹ä½¿ç”¨ ä¸‰æ¡å‘½ä»¤ï¼Œåœ¨æœ¬æœºå¯åŠ¨ä¸‰ä¸ªèŠ‚ç‚¹ç»„è£…æˆä¼ªé›†ç¾¤ã€‚ ~ % &gt; ./elasticsearch~ % &gt; ./elasticsearch -Epath.data=data2 -Epath.logs=log2~ % &gt; ./elasticsearch -Epath.data=data3 -Epath.logs=log3 åˆ›å»ºç´¢å¼•curl -X PUT &quot;localhost:9200/my-index-000001?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;&#123; &quot;settings&quot;: &#123; &quot;index&quot;: &#123; &quot;number_of_shards&quot;: 3, &quot;number_of_replicas&quot;: 2 &#125; &#125;&#125;&#x27; å½“å‰ç‰ˆæœ¬ 7.9 æ–‡æ¡£åœ°å€ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html ES é»˜è®¤ number_of_shards ä¸º 1é»˜è®¤ number_of_replicas ä¸º 1ï¼Œå³ä¸€ä¸ªåˆ†ç‰‡åªæœ‰ä¸€ä¸ªå‰¯æœ¬ ä¸‹é¢å‘½ä»¤å¯ä»¥æŸ¥çœ‹ç´¢å¼•ä¿¡æ¯ curl -X GET &quot;localhost:9200/_cat/indices/my-index-000001?v&amp;s=index&amp;pretty&quot; å­˜æ”¾æ•°æ®curl -X PUT &quot;localhost:9200/my-index-000001/_doc/0825?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;&#123; &quot;name&quot;: &quot;liuzhihang&quot;&#125;&#x27; æŸ¥è¯¢æ•°æ®curl -X GET &quot;localhost:9200/my-index-000001/_doc/0825?pretty&quot; æ–‡æ¡£åœ°å€ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/current/docs-get.html ä¸€æ¡æ•°æ®è¯¥å­˜æ”¾åœ¨å“ªä¸ª shardé€šè¿‡å‘½ä»¤å¯ä»¥çœ‹å‡ºï¼šåœ¨å­˜æ”¾æ•°æ®æ—¶å¹¶æ²¡æœ‰æŒ‡å®šåˆ°å“ªä¸ª shardï¼Œé‚£æ•°æ®æ˜¯å­˜åœ¨å“ªé‡Œçš„å‘¢ï¼Ÿ å½“ä¸€æ¡æ•°æ®è¿›æ¥ï¼Œä¼šé»˜è®¤ä¼šæ ¹æ® id åšè·¯ç”± shard &#x3D; hash(routing) % number_of_primary_shards ä»è€Œç¡®å®šå­˜æ”¾åœ¨å“ªä¸ª shardã€‚ routing é»˜è®¤æ˜¯ _idï¼Œ ä¹Ÿå¯ä»¥è®¾ç½®å…¶ä»–ã€‚ è¿™ä¸ª id å¯ä»¥è‡ªå·±æŒ‡å®šä¹Ÿå¯ä»¥ç³»ç»Ÿç»™ç”Ÿæˆ, å¦‚æœä¸æŒ‡å®šåˆ™ä¼šç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆã€‚ put ä¸€æ¡æ•°æ®çš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ å†™å…¥è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ åè°ƒé˜¶æ®µï¼šClient å®¢æˆ·ç«¯é€‰æ‹©ä¸€ä¸ª node å‘é€ put è¯·æ±‚ï¼Œæ­¤æ—¶å½“å‰èŠ‚ç‚¹å°±æ˜¯åè°ƒèŠ‚ç‚¹ï¼ˆcoordinating nodeï¼‰ã€‚åè°ƒèŠ‚ç‚¹æ ¹æ® document çš„ id è¿›è¡Œè·¯ç”±ï¼Œå°†è¯·æ±‚è½¬å‘ç»™å¯¹åº”çš„ nodeã€‚è¿™ä¸ª node ä¸Šçš„æ˜¯ primary shard ã€‚ ä¸»è¦é˜¶æ®µï¼šå¯¹åº”çš„ primary shard å¤„ç†è¯·æ±‚ï¼Œå†™å…¥æ•°æ® ï¼Œç„¶åå°†æ•°æ®åŒæ­¥åˆ° replica shardã€‚ primary shard ä¼šéªŒè¯ä¼ å…¥çš„æ•°æ®ç»“æ„ æœ¬åœ°æ‰§è¡Œç›¸å…³æ“ä½œ å°†æ“ä½œè½¬å‘ç»™ replica shard å½“æ•°æ®å†™å…¥ primary shard å’Œ replica shard æˆåŠŸåï¼Œè·¯ç”±èŠ‚ç‚¹è¿”å›å“åº”ç»™ Clientã€‚ å‰¯æœ¬é˜¶æ®µï¼šæ¯ä¸ª replica shard åœ¨è½¬å‘åï¼Œä¼šè¿›è¡Œæœ¬åœ°æ“ä½œã€‚ åœ¨å†™æ“ä½œæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œåªéœ€è¦ primary shard å¤„äºæ´»è·ƒçŠ¶æ€å³å¯è¿›è¡Œæ“ä½œã€‚ åœ¨ç´¢å¼•è®¾ç½®æ—¶å¯ä»¥è®¾ç½®è¿™ä¸ªå±æ€§ index.write.wait_for_active_shards é»˜è®¤æ˜¯ 1ï¼Œå³ primary shard å†™å…¥æˆåŠŸå³å¯è¿”å›ã€‚ å¦‚æœè®¾ç½®ä¸º all åˆ™ç›¸å½“äº number_of_replicas+1 å°±æ˜¯ primary shard æ•°é‡ + replica shard æ•°é‡ã€‚ å°±æ˜¯éœ€è¦ç­‰å¾… primary shard å’Œ replica shard éƒ½å†™å…¥æˆåŠŸæ‰ç®—æˆåŠŸã€‚ å¯ä»¥é€šè¿‡ç´¢å¼•è®¾ç½®åŠ¨æ€è¦†ç›–æ­¤é»˜è®¤è®¾ç½®ã€‚ æ€»ç»“å¦‚ä½•æŸ¥çœ‹æ•°æ®åœ¨å“ªä¸ª shard ä¸Šå‘¢ï¼Ÿcurl -X GET &quot;localhost:9200/my-index-000001/_search_shards?routing=0825&amp;pretty&quot; é€šè¿‡ä¸Šé¢å‘½ä»¤å¯ä»¥æŸ¥åˆ°æ•°æ® 0825 çš„æ‰€åœ¨ shardã€‚ ç›¸å…³èµ„æ–™ ES åˆ›å»ºç´¢å¼•ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html ES æŸ¥è¯¢æ•°æ®ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/current/docs-get.html ES æ£€ç´¢ shardï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/current/search-shards.html","categories":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"ELK","slug":"å·¥ä½œç¬”è®°/ELK","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/ELK/"}],"tags":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"ã€Elasticsearch æŠ€æœ¯åˆ†äº«ã€‘â€”â€” ES å¸¸ç”¨åè¯åŠç»“æ„","slug":"elk/2. ESçš„å¸¸ç”¨åè¯åŠç»“æ„","date":"2020-08-23T02:00:00.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/08/23/technology-sharing-es-2.html","link":"","permalink":"https://liuzhihang.com/2020/08/23/technology-sharing-es-2.html","excerpt":"","text":"å‰è¨€ çœ‹å®Œä»€ä¹ˆæ˜¯ Elasticsearch ä»¥åŠäº†è§£åˆ°äº†å€’æ’ç´¢å¼•çš„æ¦‚å¿µï¼Œä¸‹é¢å°±ç†Ÿæ‚‰ä¸‹ ES ä¸­å¸¸ç”¨çš„ä¸€äº›åè¯ã€‚ å¸¸ç”¨æœ¯è¯­ åè¯ è§£é‡Š cluster ä¸€ä¸ªæˆ–è€…å¤šä¸ª node æŒ‡å®šç›¸åŒçš„ cluster nameï¼Œåˆ™å®ƒä»¬ä¼šç»„æˆé›†ç¾¤ï¼Œå¹¶ä¸”è‡ªåŠ¨é€‰ä¸¾ masterï¼Œä»¥åŠåœ¨æ•…éšœæ—¶è‡ªåŠ¨é€‰ä¸¾ã€‚ node èŠ‚ç‚¹æ˜¯å±äºé›†ç¾¤çš„Elasticsearchçš„è¿è¡Œå®ä¾‹ ã€‚åœ¨å¯åŠ¨æ—¶ï¼ŒèŠ‚ç‚¹å°†ä½¿ç”¨å•æ’­æ¥å‘ç°å…·æœ‰ç›¸åŒé›†ç¾¤åç§°çš„ç°æœ‰é›†ç¾¤ï¼Œå¹¶å°†å°è¯•åŠ å…¥è¯¥é›†ç¾¤ã€‚ index ç±»ä¼¼å…³ç³»æ•°æ®åº“çš„è¡¨ï¼Œæ˜ å°„ä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸»åˆ†ç‰‡ï¼ŒåŒæ—¶æ‹¥æœ‰é›¶ä¸ªæˆ–å¤šä¸ªå‰¯æœ¬åˆ†ç‰‡ã€‚ index alias ç´¢å¼•åˆ«åæ˜¯ç”¨äºå¼•ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªç°æœ‰ç´¢å¼•çš„è¾…åŠ©åç§°ã€‚å¤§å¤šæ•°Elasticsearch APIæ¥å—ç´¢å¼•åˆ«åä»£æ›¿ç´¢å¼•åç§°ã€‚ mapping æ¯ä¸ª index éƒ½æœ‰ä¸€ä¸ª mapping ï¼Œå®šä¹‰ä¸€ä¸ª type ä»¥åŠè®¸å¤šç´¢å¼•èŒƒå›´çš„è®¾ç½®ã€‚mapping å¯ä»¥æ˜ç¡®å®šä¹‰ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸ºæ–‡æ¡£å»ºç«‹ç´¢å¼•åè‡ªåŠ¨ç”Ÿæˆã€‚ shard åˆ†ç‰‡æ˜¯å•ä¸ªLuceneå®ä¾‹ã€‚æœ€å°çš„å·¥ä½œå•ä½ï¼Œç”±Elasticsearchè‡ªåŠ¨ç®¡ç†ã€‚ç´¢å¼•æ˜¯æŒ‡å‘ä¸»åˆ†ç‰‡å’Œå‰¯æœ¬åˆ†ç‰‡çš„é€»è¾‘å‘½åç©ºé—´ã€‚ primary shard æ¯ä¸ªæ–‡æ¡£éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªä¸»åˆ†ç‰‡ä¸­ã€‚å½“æ‚¨ä¸ºæ–‡æ¡£å»ºç«‹ç´¢å¼•æ—¶ï¼Œå°†é¦–å…ˆåœ¨ä¸» shard ä¸Šå»ºç«‹ç´¢å¼•ï¼Œç„¶ååœ¨ä¸» shard çš„æ‰€æœ‰å‰¯æœ¬ä¸Šå»ºç«‹ç´¢å¼•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç´¢å¼•å…·æœ‰ä¸€ä¸ªä¸»åˆ†ç‰‡ã€‚æ‚¨å¯ä»¥æŒ‡å®šæ›´å¤šçš„ä¸»è¦åˆ†ç‰‡æ¥æ‰©å±• ç´¢å¼•å¯ä»¥å¤„ç†çš„æ–‡æ¡£æ•°é‡ã€‚åˆ›å»ºç´¢å¼•åï¼Œæ‚¨å°†æ— æ³•æ›´æ”¹ç´¢å¼•ä¸­çš„ä¸»è¦åˆ†ç‰‡æ•°é‡ã€‚ä½†æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨split APIå°†ç´¢å¼•æ‹†åˆ†ä¸ºæ–°ç´¢å¼• ã€‚ replica shard æ¯ä¸ªä¸»åˆ†ç‰‡å¯ä»¥å…·æœ‰é›¶ä¸ªæˆ–å¤šä¸ªå‰¯æœ¬ã€‚å‰¯æœ¬æ˜¯ primary shard çš„å‰¯æœ¬ã€‚ document document æ˜¯å­˜å‚¨åœ¨ Elasticsearch ä¸­çš„ JSON æ–‡æ¡£ã€‚æ¯ä¸ª document éƒ½å­˜å‚¨åœ¨ç´¢å¼•ä¸­ï¼Œå¹¶ä¸”æœ‰ type å’Œ idã€‚è¢«ç´¢å¼•çš„ JSON æ–‡æ¡£ å°†å­˜å‚¨åœ¨ _source å­—æ®µä¸­ï¼Œè¯¥å­—æ®µåœ¨è·å–æˆ–æœç´¢æ–‡æ¡£æ—¶é»˜è®¤è¿”å›ã€‚ id æ¯ä¸ª document éƒ½æœ‰ä¸åŒçš„ idï¼Œæ²¡æœ‰æŒ‡å®šçš„è¯ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆã€‚ field ä¸€ä¸ª document åŒ…å«å­—æ®µæˆ–é”®å€¼å¯¹çš„åˆ—è¡¨ã€‚å­—æ®µç±»ä¼¼äºå…³ç³»æ•°æ®åº“ä¸­è¡¨ä¸­çš„åˆ—ã€‚ source field é»˜è®¤æƒ…å†µä¸‹ï¼Œç´¢å¼•çš„JSONæ–‡æ¡£å­˜å‚¨åœ¨ _source å­—æ®µä¸­ï¼Œå¹¶ä¸”å°†ç”±æ‰€æœ‰ get å’Œ search è¯·æ±‚è¿”å›ã€‚è¿™æ ·ï¼Œå¯ä»¥ç›´æ¥ä»æœç´¢ç»“æœä¸­è®¿é—®åŸå§‹å¯¹è±¡ï¼Œè€Œæ— éœ€æ‰§è¡Œç¬¬äºŒæ­¥æ¥ä» ID ä¸­æ£€ç´¢å¯¹è±¡ã€‚ ç”»å›¾å‡ºæ¥å°±æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ replica shard æœ‰ä»€ä¹ˆç”¨ï¼Ÿ å¢åŠ æ•…éšœè½¬ç§»ï¼šå¦‚æœä¸»å‰¯æœ¬å‘ç”Ÿæ•…éšœï¼Œå‰¯æœ¬å‰¯æœ¬å¯ä»¥æå‡ä¸ºä¸»å‰¯æœ¬ æé«˜æ€§èƒ½ï¼šè·å–å’Œæœç´¢è¯·æ±‚å¯ä»¥ç”±ä¸»æˆ–å‰¯æœ¬åˆ†ç‰‡å¤„ç†ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªä¸»åˆ†ç‰‡éƒ½æœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œä½†æ˜¯å¯ä»¥åœ¨ç°æœ‰ç´¢å¼•ä¸ŠåŠ¨æ€æ›´æ”¹å‰¯æœ¬çš„æ•°é‡ã€‚å‰¯æœ¬åˆ†ç‰‡æ°¸è¿œä¸ä¼šä¸å…¶ä¸»åˆ†ç‰‡åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šå¯åŠ¨ã€‚ é™¤äº†å®šä¹‰ç´¢å¼•åº”å…·æœ‰çš„ä¸»åˆ†ç‰‡å’Œå‰¯æœ¬åˆ†ç‰‡çš„æ•°é‡å¤–ï¼Œæ‚¨æ— éœ€ç›´æ¥å¼•ç”¨åˆ†ç‰‡ã€‚ç›¸åï¼Œæ‚¨çš„ä»£ç åº”ä»…å¤„ç†ç´¢å¼•ã€‚ Elasticsearch åœ¨ é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¹‹é—´åˆ†é…åˆ†ç‰‡ï¼Œå¹¶ä¸”åœ¨èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæˆ–æ·»åŠ æ–°èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è‡ªåŠ¨å°†åˆ†ç‰‡ä»ä¸€ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ã€‚ åˆ†ç‰‡ é»˜è®¤æ˜¯ 5ä¸ªï¼Œå‰¯æœ¬é»˜è®¤ä¸º 1ä¸ªã€‚ æ€»ç»“è¿™ç¯‡æ–‡ç« ç®€å•ä»‹ç»äº† ES çš„å¸¸ç”¨åè¯ï¼Œå› ä¸ºåªæœ‰äº†è§£åˆ°è¿™äº›åè¯ï¼Œåœ¨å°ä¼™ä¼´è®¨è®º ES çš„æ—¶å€™ï¼Œæ‰ä¸ä¼šä¸€è„¸æ‡µé€¼ã€‚","categories":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"ELK","slug":"å·¥ä½œç¬”è®°/ELK","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/ELK/"}],"tags":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"ã€Elasticsearch æŠ€æœ¯åˆ†äº«ã€‘â€”â€” Elasticsearch ï¼Ÿå€’æ’ç´¢å¼•ï¼Ÿè¿™éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ","slug":"elk/1.åˆè¯†es","date":"2020-08-18T05:00:00.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/08/18/technology-sharing-es-1.html","link":"","permalink":"https://liuzhihang.com/2020/08/18/technology-sharing-es-1.html","excerpt":"","text":"å‰è¨€ é©å‘½åŒå¿—æ˜¯å—ç –ï¼Œå“ªé‡Œéœ€è¦å“ªé‡Œæ¬ï¼è¿™ä¸ï¼Œè€å¤§å‘è¯ï¼Œè¦æˆ‘åœ¨ç»„å†…åšä¸€ä¸ª Elasticsearch æŠ€æœ¯åˆ†äº«ã€‚è¿™ä¸è¯é¢˜ä¸€è½¬ï¼Œå¼€å§‹çœ‹èµ·æ¥ ES äº†ã€‚è™½ç„¶å¾ˆä¹…ä¹‹å‰ç”¨è¿‡ ELK åšè¿‡æ—¥å¿—ç›‘æ§ç³»ç»Ÿï¼Œä½†æ˜¯æ¯•ç«Ÿæ—¶éš”å·²ä¹…ï¼Œè¿˜æ˜¯å¾—ä»å¤´çœ‹èµ·ã€‚å½“ç„¶æ‰‹å¤´çš„æ´»ä¹Ÿä¸èƒ½åœï¼Œè¯ä¸å¤šè¯´ï¼Œå¼€å§‹åˆ†äº«ã€‚å…ˆçœ‹çœ‹ä»€ä¹ˆæ˜¯ ESï¼Ÿ ä»€ä¹ˆæ˜¯ESElasticsearch æ˜¯åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ã€‚ Elasticsearch ä¸ºæ‰€æœ‰ç±»å‹çš„æ•°æ®æä¾›è¿‘å®æ—¶ï¼ˆnear real-timeï¼‰çš„æœç´¢å’Œåˆ†æã€‚ å¸¸ç”¨åœºæ™¯ï¼š ç½‘ç«™æœç´¢ ELK æ—¥å¿—é‡‡é›†ï¼Œå­˜å‚¨ï¼Œåˆ†æ åœ°ç†ä¿¡æ¯ç³»ç»Ÿåˆ†æ åƒä¸‹å›¾ä¸­ä½¿ç”¨çš„è®¾è®¡ï¼š ç‰¹ç‚¹ï¼š ESæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨ï¼Œå­˜å‚¨çš„æ•°æ®éƒ½æ˜¯åºåˆ—åŒ–ä¸º JSON documents ã€‚ ä½¿ç”¨å€’æ’ç´¢å¼•å­˜å‚¨æ•°æ®ï¼Œå€’æ’ç´¢å¼•æ¯”è¾ƒé€‚åˆå…¨æ–‡æœ¬æœç´¢ã€‚ åŸºäºApache Luceneæœç´¢å¼•æ“åº“ï¼Œå¯ä»¥å­˜å‚¨ï¼Œæ£€ç´¢æ–‡æ¡£åŠå…ƒæ•°æ®ã€‚ æ”¯æŒ JSON æ ·å¼çš„æŸ¥è¯¢è¯­è¨€â€”â€”Query DSLï¼Œä¹Ÿæ”¯æŒ SQL æ ·å¼çš„æŸ¥è¯¢ã€‚ é›†ç¾¤éƒ¨ç½²ï¼Œæ˜“äºæ‰©å±•ã€‚èŠ‚ç‚¹ï¼ˆnodeï¼‰åˆ†ç‰‡ï¼ˆshardï¼‰ï¼Œå°†æ–°çš„ node æ·»åŠ åˆ°é›†ç¾¤æ—¶ï¼ŒES ä¼šè‡ªåŠ¨è¿ç§» shard åˆ°æ–° node ä¸Šï¼Œé‡æ–°å¹³è¡¡é›†ç¾¤ã€‚ shard åˆ†ä¸ºä¸¤ç§ ä¸»åˆ†ç‰‡ï¼ˆprimary shardï¼‰å’Œ å‰¯æœ¬åˆ†ç‰‡ ï¼ˆreplica shardï¼‰ replica shard å­˜æ”¾çš„æ˜¯ primary shard çš„å†—ä½™å‰¯æœ¬ â€”â€” å¯ä»¥é˜²æ­¢é›†ç¾¤æ•…éšœï¼Œæ•°æ®ä¸¢å¤±ï¼ŒåŒæ—¶å¯ä»¥æé«˜æœç´¢æˆ–æ£€ç´¢é€Ÿåº¦ã€‚ åœ¨åˆ›å»ºç´¢å¼•æ—¶ primary shard æ•°é‡æ˜¯å›ºå®šçš„ï¼Œè€Œreplica shard æ•°é‡æ˜¯å¯ä»¥æ›´æ”¹çš„ã€‚ åˆ†ç‰‡ç”±ç´¢å¼•é…ç½®ï¼Œåˆ†ç‰‡è¶Šå¤šï¼Œç»´æŠ¤ç´¢å¼•åˆ™å¼€é”€åˆ™è¶Šå¤§ï¼Œåˆ†ç‰‡å¤§å°è¶Šå¤§ï¼Œåˆ™ ES åœ¨å¢å‡èŠ‚ç‚¹é‡æ–°å¹³è¡¡é›†ç¾¤æ—¶ï¼Œåˆ†ç‰‡ç§»åŠ¨æ—¶é—´è¶Šé•¿ã€‚ é›†ç¾¤æ¢å¤ï¼š è·¨é›†ç¾¤å¤åˆ¶ ï¼ˆCCRï¼‰ï¼Œå¯ä»¥è‡ªåŠ¨å°†ç´¢å¼•ä»ä¸»é›†ç¾¤åŒæ­¥åˆ°çƒ­å¤‡ä»½çš„è¾…åŠ©è¿œç¨‹é›†ç¾¤ã€‚ ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿå€’æ’ç´¢å¼•ä¹Ÿå¯ä»¥æˆä¸ºåå‘ç´¢å¼•ã€‚ ä½œä¸ºå¼€å‘å’±ä»¬ç»å¸¸æ¥è§¦åˆ°çš„å°±æ˜¯ MySqlï¼Œå‡è®¾æœ‰ä¸€å †æŠ€æœ¯ä¹¦ç±ï¼Œå¹¶ä¸”å·²ç»ç¼–ä¸Šå·ã€‚ Java å¹¶å‘ç¼–ç¨‹ä¹‹ç¾ Java å¼€å‘æ‰‹å†Œ æ·±å…¥åˆ†å¸ƒå¼ç¼“å­˜ Java å¹¶å‘ç¨‹åºè®¾è®¡ ç®—æ³• æ•°æ®ç»“æ„ä¸ç®—æ³• å¦‚æœæ”¾åœ¨ MySql é‡Œé¢å°±æ˜¯è¿™æ · id book_name 1 Java å¹¶å‘ç¼–ç¨‹ä¹‹ç¾ 2 Java å¼€å‘æ‰‹å†Œ 3 æ·±å…¥åˆ†å¸ƒå¼ç¼“å­˜ 4 Java å¹¶å‘ç¨‹åºè®¾è®¡ 5 ç®—æ³• 6 æ•°æ®ç»“æ„ä¸ç®—æ³• æ­¤æ—¶æˆ‘æƒ³æŸ¥è¯¢æ‰€æœ‰å…³äº å¹¶å‘ çš„ä¹¦ç±ã€‚ select * from table_book where book_name like %å¹¶å‘%; ç„¶åä¼šå¼€å§‹éå†è¡¨æ ¼ï¼ŒæŸ¥æ‰¾åˆ° 1å’Œ4ä¸¤æ¡è®°å½•ã€‚ å¦‚æœæ˜¯å€’æ’ç´¢å¼•å¤„ç†çš„è¯ é¦–å…ˆä¼šå°†æ¯ä¸ªåç§°è¿›è¡Œåˆ†è¯ï¼Œæ¯”å¦‚ Java å¹¶å‘ç¼–ç¨‹ä¹‹ç¾ ä¼šè¢«åˆ†ä¸º Java å¹¶å‘ ç¼–ç¨‹ ä¹‹ ç¾ã€‚åˆ†è¯ç»“æŸä¹‹åæŒ‰ç…§è¯å…³è”ä¹¦ç±çš„ç¼–å·ã€‚ term ids Java 1ã€2ã€4 å¹¶å‘ 1ã€4 ç¼–ç¨‹ 1 ç®—æ³• 5ã€6 åˆ†å¸ƒå¼ 3 â€¦ â€¦ åœ¨å€’æ’ç´¢å¼•ä¸­æœç´¢å¹¶å‘ï¼Œç„¶åè¿›è¡Œæ£€ç´¢ï¼Œå°±å¾ˆå®¹æ˜“å®šä½åˆ°å…³äºå¹¶å‘ä¹¦ç±çš„ç¼–å·ã€‚ é‚£ä»€ä¹ˆæ˜¯ Luceneï¼ŸLucene å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå¼€æºçš„ã€é«˜æ€§èƒ½ã€å¯ä¼¸ç¼©çš„ä¿¡æ¯æœç´¢åº“ã€‚ä½¿ç”¨ Java å¼€å‘ï¼Œå°è£…äº†å„ç§å€’æ’ç´¢å¼•å’Œæœç´¢çš„APIã€‚ç›¸å½“äºä¸€ä¸ªç»„ä»¶ã€‚ è€Œ ES å°±æ˜¯åœ¨ Lucene ä¹‹ä¸Šè¿›è¡Œçš„å¼€å‘ï¼Œä»è€Œå¯ä»¥é«˜å¯ç”¨ã€é›†ç¾¤éƒ¨ç½²ã€æ•…éšœè¿ç§»ã€å¤‡ä»½å®¹ç¾ç­‰ã€‚ æ€»ç»“å°±è¿™ä¹ˆå¤šï¼Œå…ˆçŸ¥é“ä¸ª ES æ˜¯å¹²å˜›çš„ã€‚åç»­å†æ…¢æ…¢çœ‹ã€æ…¢æ…¢æ€»ç»“ã€‚","categories":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"ELK","slug":"å·¥ä½œç¬”è®°/ELK","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/ELK/"}],"tags":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- é™¤äº†è¯»å†™é”ï¼ŒJUC ä¸‹é¢è¿˜æœ‰ä¸ª StampedLockï¼è¿˜ä¸è¿‡æ¥äº†è§£ä¸€ä¸‹ä¹ˆï¼Ÿ","slug":"source-code/java/StampedLock","date":"2020-08-09T07:30:00.000Z","updated":"2020-12-27T09:23:14.595Z","comments":true,"path":"2020/08/09/source-code-stamped-lock.html","link":"","permalink":"https://liuzhihang.com/2020/08/09/source-code-stamped-lock.html","excerpt":"","text":"å‰è¨€ åœ¨äº†è§£å®Œ ReentrantLock å’Œ ReentrantReadWriteLock ä¹‹åï¼ŒæƒŠå¥‡çš„å‘ç° JUC ä¸‹è¿˜æœ‰ä¸€ä¸ª StampedLock ã€‚ æŸ¥é˜…èµ„æ–™å‘ç°æ˜¯ JDK8 æ–°å¢çš„ä¸€ä¸ªé”ã€‚ç°åœ¨å·²ç» JDK15 äº†ï¼ŒåŸè°…æˆ‘çš„å­¤é™‹å¯¡é—»ï¼Œå®åœ¨æ˜¯ä¸šåŠ¡å¼€å‘ä¸­ç”¨çš„å¤ªå°‘ã€‚é‚£è¡Œå§ï¼Œèµ¶ç´§æ¥çœ‹ä¸€ä¸‹ StampedLock åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæœ‰äº† ReentrantLock å’Œ ReentrantReadWriteLock ä¹‹åè¿˜è¦è®¾è®¡ä¸€ä¸ª StampedLock ï¼Ÿ ä»‹ç»å¾€æœŸå›é¡¾åœ¨ä»‹ç» StampedLock ä¹‹å‰è¿˜æ˜¯å…ˆçœ‹ä¸€ä¸‹ ReentrantLock å’Œ ReentrantReadWriteLockã€‚ ReentrantLockï¼šäº’æ–¥é”ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æŒæœ‰ã€‚æ”¯æŒé”é‡å…¥ã€‚ ReentrantReadWriteLockï¼šè¯»å†™é”ï¼Œåˆ†ä¸ºè¯»é”å’Œå†™é”ï¼Œæ”¯æŒé‡å…¥ã€‚å…¶ä¸­è¯»è¯»å…±äº«ï¼Œå†™å†™ç‹¬å ï¼Œè¯»å†™äº’æ–¥ï¼Œå†™è¯»äº’æ–¥ã€‚æ”¯æŒé”é™çº§ï¼Œçº¿ç¨‹è·å–å†™é”åå¯ä»¥é™çº§ä¸ºè¯»é”ã€‚é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚ é‚£ä¸ºä»€ä¹ˆè¦è®¾è®¡ StampedLock å‘¢ï¼Ÿå…ˆæ¥çœ‹ä¸€ä¸‹æºç ä¸Šçš„æ³¨é‡Šï¼š StampedLockåŸºäºåŠŸèƒ½çš„é”ï¼Œå…·æœ‰ä¸‰ç§æ¨¡å¼æ¥æ§åˆ¶è¯»/å†™è®¿é—®ã€‚StampedLockçš„çŠ¶æ€ç”±ç‰ˆæœ¬å’Œæ¨¡å¼ç»„æˆã€‚é”è·å–æ–¹æ³•è¿”å›ä¸€ä¸ª stamp ç”¨æ¥è¡¨ç¤ºå¹¶æ§åˆ¶é”çŠ¶æ€çš„è®¿é—®ï¼›è¿™äº›æ–¹æ³•çš„â€œtryâ€ç‰ˆæœ¬å¯èƒ½ä¼šè¿”å›ç‰¹æ®Šå€¼é›¶ï¼Œä»¥è¡¨ç¤ºæ— æ³•è·å–è®¿é—®æƒé™ã€‚é”çš„é‡Šæ”¾å’Œè½¬æ¢æ–¹æ³•éœ€è¦ä½¿ç”¨ stamp ä½œä¸ºå‚æ•°ï¼Œå¦‚æœå®ƒä»¬ä¸é”çš„çŠ¶æ€ä¸åŒ¹é…ï¼Œåˆ™ä¼šå¤±è´¥ã€‚ ä¸‰ç§æ¨¡å¼æ˜¯ï¼šå†™é”ã€è¯»é”ã€ä¹è§‚è¯»é”ã€‚ å¹¶ä¸”å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š è·å–é”çš„æ—¶å€™ï¼ˆæ— è®ºè¯»é”è¿˜æ˜¯å†™é”æˆ–è€…ä¹è§‚è¯»é”ï¼‰éƒ½ä¼šè¿”å›ä¸€ä¸ª stampï¼Œåœ¨é‡Šæ”¾é”çš„æ—¶å€™éœ€è¦ä½¿ç”¨è¿™ä¸ª stampï¼› æ”¯æŒä¸‰ç§æ¨¡å¼è½¬æ¢ï¼› ä¸æ˜¯å¯é‡å…¥çš„ï¼Œæ‰€ä»¥è·å¾—é”çš„æ—¶å€™ï¼Œä¸è¦å°è¯•å†æ¬¡è·å–ã€‚ ä½¿ç”¨æ ·ä¾‹/** * @author liuzhihang * @date 2020/8/6 15:27 */public class Count &#123; private int num; private final StampedLock stampedLock = new StampedLock(); // ä½¿ç”¨å†™é”ï¼Œåœ¨å¯¹ num è¿›è¡Œå†™å…¥çš„æ—¶å€™åŠ é” void write(int x) &#123; long stamp = stampedLock.writeLock(); try &#123; num += x; &#125; finally &#123; stampedLock.unlockWrite(stamp); &#125; &#125; // ä¹è§‚è¯» int read() &#123; // è·å–ä¹è§‚è¯»é”ï¼›è¿”å› stamp long stamp = stampedLock.tryOptimisticRead(); try &#123; // validate éªŒè¯æ˜¯å¦è¢«å†™é”æŒæœ‰ // æ²¡æœ‰è¢«å†™é”æŒæœ‰ï¼Œå¯ä»¥ç›´æ¥è¿”å› if (!stampedLock.validate(stamp)) &#123; // è¢«å†™é”æŒæœ‰ï¼Œé‚£åªèƒ½è·å–è¯»é” stamp = stampedLock.readLock(); &#125; return num; &#125; finally &#123; stampedLock.unlockRead(stamp); &#125; &#125; void convertWrite(int x) &#123; // è¯» long stamp = stampedLock.readLock(); try &#123; while (num == x) &#123; // æ»¡è¶³æ¡ä»¶ï¼Œè½¬æ¢ä¸ºå†™é” long ws = stampedLock.tryConvertToWriteLock(stamp); // è½¬ä¸ºå†™é”æˆåŠŸ if (ws != 0L) &#123; stamp = ws; num = x; break; &#125; else &#123; // è½¬æ¢å¤±è´¥ï¼Œé‡Šæ”¾è¯»é” stampedLock.unlockRead(stamp); // å†æ¬¡è·å–å†™é” stamp = stampedLock.writeLock(); &#125; &#125; &#125; finally &#123; stampedLock.unlock(stamp); &#125; &#125;&#125; å†™é”ä½¿ç”¨æ–¹æ³•ä¸€æ ·ï¼› ä¹è§‚è¯»ï¼Œå¯ä»¥å…ˆå»è¯»æ•°æ®ï¼Œå‘ç°æ²¡æœ‰æ”¹å˜å¯ä»¥è¿”å›ï¼Œå‘ç°æ”¹å˜äº†ï¼Œåˆ™é‡æ–°è·å–è¯»é”ï¼Œç„¶åå†è¿”å›ï¼› è¯»é”å¯ä»¥å‡çº§ä¸ºå†™é”ï¼Œé€šè¿‡ tryConvertToWriteLock æ–¹æ³•ã€‚ æ€»ç»“UML é€šè¿‡ UML å¯ä»¥çœ‹å‡º StampedLock å’Œ AQS å¹¶æ— ä»»ä½•å…³ç³»ã€‚ StampedLock å’Œ ReentrantReadWriteLock çš„åŒºåˆ«ï¼Ÿ StampedLock ä¹Ÿæ˜¯è¯»å†™é”ï¼Œä½†æ˜¯å’Œ AQS æ²¡æœ‰å…³ç³» StampedLock é™¤äº† è¯»é”å’Œå†™é”ï¼Œè¿˜æœ‰ä¸€ä¸ªä¹è§‚è¯»ã€‚ StampedLock çš„è¯»é”å¯ä»¥å‡çº§ä¸ºå†™é”ã€‚ StampedLock ä¸æ”¯æŒé”é‡å…¥ã€‚ æ€»ç»“æœ¬æ–‡ä¸»è¦ä»‹ç» StampedLock çš„ç›¸å…³ä½¿ç”¨åŠå’Œ ReentrantReadWriteLock çš„åŒºåˆ«ã€‚ å› ä¸ºå·¥ä½œç¡®å®å¾ˆå°‘ä½¿ç”¨ï¼Œé˜…è¯»æºç ï¼Œå†…éƒ¨è‡ªæ—‹é€»è¾‘ç­‰æœ‰å¾ˆå¤šã€‚å¦‚æœä»‹ç»çš„è¯ä¼šç¯‡å¹…ç‰¹åˆ«é•¿ï¼Œè¿™é‡Œå°±çœç•¥äº†ã€‚æœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªå·±é˜…è¯»æºç ã€‚ å› ä¸º StampedLock æä¾›çš„ä¹è§‚è¯»é”æ”¯æŒï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹å¤šè¯»æƒ…å†µä¸‹ï¼Œæ€§èƒ½æ¯” ReentrantReadWriteLock è¦æ›´å¥½ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ StampedLock æ˜¯ä¸æ”¯æŒé”é‡å…¥çš„ã€‚ å¦ä¸€ä¸ªéœ€è¦è®°ä½çš„å°±æ˜¯ StampedLock å’Œ AQS å¹¶æ²¡æœ‰ä»€ä¹ˆå…³ç³»ï¼Œå®ƒæ˜¯åœ¨è‡ªå·±å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é˜»å¡é˜Ÿåˆ—ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"IDEAæ’ä»¶å¼€å‘å¸¸ç”¨API","slug":"plugin/ideaæ’ä»¶å¼€å‘å¸¸ç”¨api","date":"2020-08-01T03:58:16.000Z","updated":"2020-12-27T09:23:14.600Z","comments":true,"path":"2020/08/01/idea-plugin-development-common-api.html","link":"","permalink":"https://liuzhihang.com/2020/08/01/idea-plugin-development-common-api.html","excerpt":"","text":"åœ¨å¼€å‘Toolkitè¿‡ç¨‹ä¸­æŸ¥é˜…ç›¸å…³èµ„æ–™å’Œé˜…è¯»å…¶ä»–å¼€æºé¡¹ç›®æ€»ç»“çš„ä¸€äº›å¸¸ç”¨API.æ•´ä½“å†…å®¹æ¥æºäºç½‘ç»œ, ä»¥åŠè‡ªå·±ä½¿ç”¨å¼€å‘Toolkitè¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°çš„.æ€»ç»“çš„ä¸åˆ°ä½çš„åœ°æ–¹æ¬¢è¿æŒ‡æ­£. AnActionæ“ä½œ åˆ›å»ºActioné›†æˆAnActionå¹¶å®ç°å…¶actionPerformedæ–¹æ³•. åœ¨æ–¹æ³•ä¸­å¯ä»¥è·å–åˆ°AnActionEventå¯¹è±¡. ä»£ç å¦‚ä¸‹: public class JsonFormatAction extends AnAction &#123; @Override public void actionPerformed(AnActionEvent event) &#123; // è·å–å½“å‰projectå¯¹è±¡ Project project = event.getData(PlatformDataKeys.PROJECT); // è·å–å½“å‰ç¼–è¾‘çš„æ–‡ä»¶, å¯ä»¥è¿›è€Œè·å– PsiClass, PsiField å¯¹è±¡ PsiFile psiFile = event.getData(CommonDataKeys.PSI_FILE); Editor editor = event.getData(CommonDataKeys.EDITOR); // è·å–Javaç±»æˆ–è€…æ¥å£ PsiClass psiClass = getTargetClass(editor, psiFile); // åˆ›å»ºå¹¶è°ƒèµ· DialogWrapper DialogWrapper dialog = new JsonFormat(project, psiFile, editor, psiClass); dialog.show(); &#125; å…¶ä»–æ–¹å¼ // è·å–project. å†…éƒ¨è°ƒç”¨ getData(CommonDataKeys.PROJECT) = getDataContext().getData(CommonDataKeys.PROJECT)Project project = e.getProject();// è·å–æ•°æ®ä¸Šä¸‹æ–‡DataContext dataContext = e.getDataContext();// contextå¯ä»¥ä¹Ÿè·å–åˆ°å…¶ä»–ä¿¡æ¯, å…¥å‚ä¸º PlatformDataKeys å®šä¹‰çš„å­—æ®µProject project1 = dataContext.getData(PlatformDataKeys.PROJECT);Editor editor = dataContext.getData(PlatformDataKeys.EDITOR);PsiFile psiFile = dataContext.getData(PlatformDataKeys.PSI_FILE);PsiElement psiElement = dataContext.getData(PlatformDataKeys.PSI_ELEMENT);// è™šæ‹Ÿæ–‡ä»¶VirtualFile virtualFile = dataContext.getData(PlatformDataKeys.VIRTUAL_FILE); è·å–PsiClassPsiClassä¸ºjavaç±»æˆ–è€…æ¥å£ @Nullableprotected PsiClass getTargetClass(Editor editor, PsiFile file) &#123; int offset = editor.getCaretModel().getOffset(); PsiElement element = file.findElementAt(offset); if (element == null) &#123; return null; &#125; else &#123; PsiClass target = PsiTreeUtil.getParentOfType(element, PsiClass.class); return target instanceof SyntheticElement ? null : target; &#125;&#125; Psixxxæ“ä½œPsiClassæ“ä½œAPIæºç æœ‰æ³¨é‡Šä¸”æ¯”è¾ƒæ¸…æ¥š, æ­¤å¤„ä»…è®°å½•æˆ‘ç”¨åˆ°çš„ä¸€éƒ¨åˆ† // è·å–å…¨ç±»åString qualifiedName = aClass.getQualifiedName();// è·å–æ‰€æœ‰å­—æ®µPsiField[] fields = aClass.getFields(); PsiFieldæ“ä½œ// è·å–å­—æ®µåString name = psiField.getName() PsiElementæ“ä½œPsiClasså’ŒPsiFieldéƒ½å®ç°äº†PsiElement // åˆ é™¤element.delete()// æ·»åŠ å…ƒç´ , å‘ä¸€ä¸ªç±»ä¸­æ·»åŠ æ–¹æ³•, å­—æ®µç­‰, ä¹Ÿå¯ä»¥è°ƒç”¨ addBefore, addAfteradd(PsiElement element) PsiTypeæ“ä½œPsiTypeæ”¯æŒå¸¸ç”¨åŸºæœ¬ç±»å‹, ä½†æ˜¯å½“åˆ›å»ºå¯¹è±¡æ—¶åˆ™ä¸æ”¯æŒ.éœ€è¦è‡ªå·±åˆ›å»º PsiElementFactory psiElementFactory = JavaPsiFacade.getElementFactory(project);// String ç±»å‹PsiType stringPsiType = psiElementFactory.createTypeFromText(&quot;java.lang.String&quot;, null)// listPsiType listPsiType = psiElementFactory.createTypeFromText(&quot;java.util.List&lt;String&gt;&quot;, null);// è‡ªå®šä¹‰listPsiType typeFromText = psiElementFactory.createTypeFromText(&quot;java.util.List&lt;&quot; + className + &quot;&gt;&quot;, null); å…¶ä»–APIXML æ–‡ä»¶æ“ä½œå‚è€ƒåœ°å€ï¼šhttps://jetbrains.org/intellij/sdk/docs/reference_guide/frameworks_and_external_apis/xml_dom_api.html ä»¥ Mapper.xml ä¸¾ä¾‹å£°æ˜æ¥å£ï¼Œç»§æ‰¿ DomElementï¼Œå¹¶é…åˆ @Attributeã€@SubTag ã€@SubTagsList æ³¨è§£å®šä¹‰ä¸€ä¸ª xml modelï¼Œå…¶ä¸­éœ€è¦æ³¨æ„ @SubTagsList æ–¹æ³•è¦ä½¿ç”¨å¤æ•°å½¢å¼ã€‚ public interface Mapper extends DomElement &#123; /** * namespace * * @return */ @Attribute(&quot;namespace&quot;) GenericAttributeValue&lt;String&gt; getNamespace(); /** * * å¢åˆ æ”¹æŸ¥å¯¹åº”çš„èŠ‚ç‚¹ * * @return */ @SubTagsList(&#123;&quot;select&quot;, &quot;insert&quot;, &quot;update&quot;, &quot;delete&quot;&#125;) List&lt;Statement&gt; getStatements();â€‹ @SubTagList(&quot;select&quot;) List&lt;Select&gt; getSelects(); @SubTagList(&quot;insert&quot;) List&lt;Insert&gt; getInserts(); @SubTagList(&quot;update&quot;) List&lt;Update&gt; getUpdates(); @SubTagList(&quot;delete&quot;) List&lt;Delete&gt; getDeletes();&#125; æœç´¢æ–‡ä»¶æ¯”å¦‚æƒ³æœç´¢é¡¹ç›®ä¸­çš„æ‰€æœ‰ xml æ–‡ä»¶ï¼Œä¸Šé¢ä½¿ç”¨ Mapper æ¥å£å®šä¹‰äº† Mapper.xml çš„ç»“æ„ï¼Œå°±å¯ä»¥åˆ©ç”¨ DomService æœç´¢æ‰€æœ‰çš„ Mapper.xmlï¼š // å½“å‰é¡¹ç›®çš„æ‰€æœ‰å…ƒç´  mapper, åˆ†åˆ«å¡«å…¥ç±»å‹, ä½œç”¨åŸŸ GlobalSearchScopeList&lt;DomFileElement&lt;Mapper&gt;&gt; fileElements = DomService.getInstance().getFileElements(Mapper.class, project, GlobalSearchScope.allScope(project)); å†™å…¥æ–‡ä»¶éœ€è¦è°ƒç”¨WriteCommandActionè¿›è¡Œå¼‚æ­¥å†™å…¥. WriteCommandAction.runWriteCommandAction(project, () -&gt; &#123; doGenerate(psiClass, jsonObject);&#125;); é€šçŸ¥åœ¨æ“ä½œæˆåŠŸä¹‹åï¼Œåœ¨ IDEA å³ä¸‹è§’é€šçŸ¥ç”¨æˆ·ï¼Œä½¿ç”¨ NotificationGroup ç±»å³å¯ã€‚ // é™æ€å±æ€§private static final NotificationGroup NOTIFICATION_GROUP = new NotificationGroup(&quot;Java2Json.NotificationGroup&quot;, NotificationDisplayType.BALLOON, true);public void actionPerformed(@NotNull AnActionEvent e) &#123; // åœ¨æ–¹æ³•ä¸­è°ƒç”¨ Notification success = NOTIFICATION_GROUP.createNotification(message, NotificationType.INFORMATION); Notifications.Bus.notify(success, project);&#125; ä¹Ÿå¯ä»¥å®šä¹‰ä¸ºå·¥å…·ç±»ï¼Œå¦‚ä¸‹ /** * * è¿›è¡Œæ¶ˆæ¯é€šçŸ¥å·¥å…·ç±» * * @author liuzhihang * @date 2020/2/28 18:52 */public class NotificationUtils &#123; private static NotificationGroup notificationGroup = new NotificationGroup(&quot;ApiDoc.NotificationGroup&quot;, NotificationDisplayType.BALLOON, true); public static void warnNotify(String message, Project project) &#123; Notifications.Bus.notify(notificationGroup.createNotification(message, NotificationType.WARNING), project); &#125; public static void infoNotify(String message, Project project) &#123; Notifications.Bus.notify(notificationGroup.createNotification(message, NotificationType.INFORMATION), project); &#125; public static void errorNotify(String message, Project project) &#123; Notifications.Bus.notify(notificationGroup.createNotification(message, NotificationType.ERROR), project); &#125;&#125; æ€»ç»“åŸºæœ¬ä¸Šå¸¸ç”¨çš„å°±æ˜¯è¿™äº›äº†ï¼Œä¹Ÿå¯ä»¥æŸ¥æ‰¾å®˜æ–¹æ–‡æ¡£ï¼Œå®˜æ–¹æ–‡æ¡£ç°åœ¨è¿˜æ˜¯æ¯”è¾ƒå…¨é¢çš„ï¼Œåœ°å€åœ¨ç›¸å…³èµ„æ–™ä¸­ã€‚ä¹Ÿå¯ä»¥ Clone Toolkit è¿™ä¸ªæ’ä»¶æºç ï¼Œæºç ä¸­æœ‰ä¸€äº›æ³¨é‡Šã€‚åœ¨å…¶ä»–ä¼˜ç§€çš„æ’ä»¶ä¸­ï¼ŒåŒæ ·å¯æœ‰ç›¸å…³ä½¿ç”¨æ–¹æ³•ã€‚ ç›¸å…³èµ„æ–™ Toolkit: https://github.com/liuzhihang/toolkit copy-as-json: https://github.com/liuzhihang/copy-as-json IntelliJ Platform SDK: https://jetbrains.org/intellij/sdk/docs/intro/welcome.html","categories":[{"name":"IDEA","slug":"IDEA","permalink":"https://liuzhihang.com/categories/IDEA/"}],"tags":[{"name":"plugin","slug":"plugin","permalink":"https://liuzhihang.com/tags/plugin/"}]},{"title":"ã€å·¥å…·å†Œã€‘- IDEA æ’ä»¶æ‰¾ä¸åˆ°ï¼Ÿçœ‹è¿™é‡Œï¼é‚£å°±è‡ªå·±æ•²ä¸€ä¸ªï¼","slug":"plugin/IDEAæ’ä»¶å¼€å‘","date":"2020-07-29T05:00:00.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/07/29/tool-book-copy-as-json.html","link":"","permalink":"https://liuzhihang.com/2020/07/29/tool-book-copy-as-json.html","excerpt":"","text":"å‰è¨€ å¤§å®¶éƒ½ç»å¸¸ä½¿ç”¨ IDEA è¿›è¡Œå¼€å‘ï¼Œè‚¯å®šä¼šä½¿ç”¨ä¸€äº› IDEA æ’ä»¶ï¼Œæˆ‘ä¹‹å‰ä¹Ÿå†™è¿‡ä¸¤ä¸ªæ’ä»¶ï¼Œä¸è¿‡å·²ç»å¾ˆä¹…æ²¡æœ‰æ›´æ–°äº†ï¼Œå°±è®©å®ƒå…ˆæ”¾ç€å§ï¼ é‚£å°ä¼™ä¼´ä½ æ˜¯å¦æƒ³äº²æ‰‹å†™ä¸€ä¸ªæ’ä»¶ï¼Œæˆ–è€…ä½ æ˜¯å¦æœ‰ä¸€äº›æ’ä»¶çš„æƒ³æ³•ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°æ’ä»¶ã€‚é‚£å°±è‡ªå·±å®ç°ä¸€ä¸ªå§ï¼ åˆ›å»ºé¡¹ç›®ä½¿ç”¨ Gradle åˆ›å»ºå†™æ’ä»¶ï¼Œå…ˆä»åˆ›å»ºé¡¹ç›®å¼€å§‹ï¼š File -&gt; New -&gt; Project... è¿™é‡Œä½¿ç”¨ Gradleï¼Œå…¶ä¸­ Java å·²ç»é»˜è®¤é€‰ä¸­ï¼Œå’±ä»¬å†é¢å¤–é€‰æ‹© IntelliJ Platform Pluginã€‚ ç‚¹å‡» Next ï¼Œç„¶åå¡«å†™é¡¹ç›®åç§°ï¼Œè·¯å¾„ç­‰é€‰é¡¹ã€‚ é¡¹ç›®ç»“æ„ build.gradle ä¸ºé¡¹ç›®é…ç½®æ–‡ä»¶ã€‚resources/META-INF/plugin.xml ä¸ºæ’ä»¶é…ç½®æ–‡ä»¶ã€‚ ä½¿ç”¨ GitHub æ¨¡ç‰ˆ è®¿é—® https://github.com/JetBrains/intellij-platform-plugin-template ç‚¹å‡» Use this template åˆ›å»ºæ¨¡ç‰ˆã€‚ Clone é¡¹ç›®åˆ°è‡ªå·±æœ¬åœ°ã€‚ æ³¨ï¼šæ¨¡ç‰ˆç”Ÿæˆçš„é¡¹ç›®æ˜¯ä½¿ç”¨çš„ Kotlinï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„ç¬¬ä¸€ç§æ–¹å¼åˆ›å»ºã€‚ å¼€å§‹å¼€å‘ä¿®æ”¹ build.gradle é…ç½®æ–‡ä»¶åŸå†…å®¹å¦‚ä¸‹ï¼š ä¿®æ”¹åï¼š plugins &#123; id &#x27;java&#x27; id &#x27;org.jetbrains.intellij&#x27; version &#x27;0.4.15&#x27;&#125;group &#x27;com.liuzhihang.toolkit&#x27;version &#x27;1.0.2&#x27;sourceCompatibility = 1.8repositories &#123; mavenLocal() maven &#123; url &quot;https://maven.aliyun.com/repository/public&quot; &#125; mavenCentral() jcenter()&#125;dependencies &#123; testCompile group: &#x27;junit&#x27;, name: &#x27;junit&#x27;, version: &#x27;4.12&#x27;&#125;// See https://github.com/JetBrains/gradle-intellij-plugin/intellij &#123; version &#x27;2019.1.1&#x27; pluginName &#x27;Copy as Json&#x27; updateSinceUntilBuild false sameSinceUntilBuild false&#125;patchPluginXml &#123; pluginDescription(file(descriptionFile).text) changeNotes(file(changesFile).text)&#125; ä¿®æ”¹ repositories ä½¿ç”¨é˜¿é‡Œäº‘ ä¿®æ”¹ patchPluginXml ä½¿ç”¨å¤–ç½®æ–‡ä»¶ åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º parts è·¯å¾„ï¼Œå¹¶åˆ›å»º changeNotes.htmlã€pluginDescription.html ä¿®æ”¹ resources/META-INF/plugin.xml æ’ä»¶ä¿¡æ¯åŸå†…å®¹å¦‚ä¸‹ï¼š ä¿®æ”¹åï¼š &lt;idea-plugin&gt; &lt;id&gt;com.liuzhihang.toolkit.copyasjson&lt;/id&gt; &lt;name&gt;Copy as Json&lt;/name&gt; &lt;vendor email=&quot;liuzhihangs@qq.com&quot; url=&quot;https://liuzhihang.com&quot;&gt;Liu ZhiHang&lt;/vendor&gt; &lt;description&gt;&lt;![CDATA[ Description will be added by gradle build]]&gt;&lt;/description&gt; &lt;!-- please see http://www.jetbrains.org/intellij/sdk/docs/basics/getting_started/plugin_compatibility.html on how to target different products --&gt; &lt;depends&gt;com.intellij.modules.java&lt;/depends&gt; &lt;idea-version since-build=&quot;181.00&quot;/&gt; &lt;extensions defaultExtensionNs=&quot;com.intellij&quot;&gt; &lt;!-- Add your extensions here --&gt; &lt;/extensions&gt; &lt;actions&gt; &lt;/actions&gt;&lt;/idea-plugin&gt; plugin.xml è¯´æ˜ï¼šhttps://jetbrains.org/intellij/sdk/docs/basics/plugin_structure/plugin_configuration_file.html åˆ›å»º Action å…ˆåœ¨ main ä¸‹ åˆ›å»º java ç›®å½•ï¼ŒåŠåŒ…è·¯å¾„ã€‚ New -&gt; Plugin DevKit -&gt; Action è®¾ç½® Action çš„ id ã€Class Name ã€ description ã€ group åŠå¿«æ·é”®ç­‰ è¿™æ—¶å€™ä¼šå‘ç°åœ¨ plugin.xml ä¹Ÿæ’å…¥äº† actionã€‚ &lt;actions&gt; &lt;action id=&quot;Toolkit.Json.CopyAsJsonAction&quot; class=&quot;com.liuzhihang.toolkit.action.CopyAsJsonAction&quot; text=&quot;CopyAsJsonAction&quot; description=&quot;Copy As Json&quot;&gt; &lt;add-to-group group-id=&quot;EditorTabsGroup&quot; anchor=&quot;first&quot;/&gt; &lt;keyboard-shortcut keymap=&quot;$default&quot; first-keystroke=&quot;shift meta J&quot;/&gt; &lt;/action&gt;&lt;/actions&gt; åˆ°è¿™é‡Œå·²ç»ç»“æ„å®Œå…¨åˆ›å»ºå®Œæ¯•äº†ï¼Œä¸‹é¢å°†æ¼”ç¤ºæ’ä»¶ copy-as-json çš„å†…éƒ¨é€»è¾‘ã€‚å½“ç„¶è¿™å—ä¹Ÿå¯ä»¥ç›´æ¥è·³è¿‡ï¼Œé˜…è¯»æºç å³å¯ã€‚ æºç åœ°å€ï¼šæ–‡æœ«ç›¸å…³èµ„æ–™æˆ–å…¬ä¼—å·å‘é€ copy-as-json è·å–ã€‚ æ’ä»¶æ•ˆæœï¼šå°† JavaBean å¤åˆ¶ä¸º Json å­—ç¬¦ä¸²ã€‚ å¼€å‘ç¬”è®°é¦–å…ˆéœ€è¦çŸ¥é“ä¸€äº›å¸¸ç”¨çš„ APIï¼Œå¸¸ç”¨ API å¯ä»¥é˜…è¯»å®˜æ–¹æ–‡æ¡£æˆ–è€…å…³æ³¨å…¬ä¼—å·åé¢ä¼šæ¨é€ï¼Œè¿™é‡Œä»…ä»‹ç»ä¸€äº›åœ¨è¿™é‡Œç”¨åˆ°çš„ã€‚ æ‰“å¼€ CopyAsJsonAction è¯¥ç±»ç»§æ‰¿å¹¶éœ€è¦å®ç° actionPerformed æ–¹æ³•ã€‚åœ¨ actionPerformed æ–¹æ³•ä¸­å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•è·å–åˆ°é¡¹ç›®ç›¸å…³ä¿¡æ¯ï¼š // è·å–é¡¹ç›®Project project = e.getData(PlatformDataKeys.PROJECT);// è·å–Psiæ–‡ä»¶PsiFile psiFile = e.getData(CommonDataKeys.PSI_FILE);// è·å–å½“å‰ç¼–è¾‘çš„æ–‡ä»¶Editor editor = e.getData(CommonDataKeys.EDITOR); è·å–åˆ°å½“å‰ç¼–è¾‘çš„æ–‡ä»¶ @Nullablepublic static PsiClass getTargetClass(@NotNull Editor editor, @NotNull PsiFile file) &#123; int offset = editor.getCaretModel().getOffset(); PsiElement element = file.findElementAt(offset); if (element != null) &#123; // å½“å‰ç±» PsiClass target = PsiTreeUtil.getParentOfType(element, PsiClass.class); return target instanceof SyntheticElement ? null : target; &#125; return null;&#125; ä»å½“å‰ç¼–è¾‘çš„æ–‡ä»¶é‡Œé¢è·å–åˆ°å­—æ®µ å°†å½“å‰ç¼–è¾‘çš„ JavaBean ä¸­çš„å­—æ®µæå–ï¼Œå¹¶è½¬æ¢ä¸º Mapã€‚ Map&lt;String, Object&gt; fieldsMap = getFields(selectedClass); getFields æ–¹æ³•ç¯‡å¹…è¾ƒé•¿ï¼Œè¯·å‚è€ƒæºç ã€‚ å°†å­—æ®µè½¬åŒ–æˆ Json å­—ç¬¦ä¸²ï¼Œå¹¶æ ¼å¼åŒ– ä½¿ç”¨ Gson å°† Map è½¬æ¢ä¸º Json å­—ç¬¦ä¸²ï¼Œå¹¶æ ¼å¼åŒ–ã€‚å…¶ä¸­æ ¼å¼åŒ–è‡ªå®šä¹‰äº†ç¼©è¿›ã€‚ è§ä»£ç ï¼šcom.liuzhihang.toolkit.utils.GsonFormatUtil Gson gson = new GsonBuilder().create();String json = GsonFormatUtil.gsonFormat(gson, fieldsMap);// ä½¿ç”¨è‡ªå®šä¹‰ç¼©è¿›æ ¼å¼ String json = new GsonBuilder().setPrettyPrinting().create().toJson(fieldsMap);StringSelection selection = new StringSelection(json); å°† Json å­—ç¬¦ä¸²æ‹·è´åˆ°å‰ªè´´æ¿ StringSelection selection = new StringSelection(json);Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();clipboard.setContents(selection, selection); å‘å‡ºæç¤º success String message = &quot;Convert &quot; + selectedClass.getName() + &quot; to JSON success, copied to clipboard.&quot;;Notification success = NOTIFICATION_GROUP.createNotification(message, NotificationType.INFORMATION);Notifications.Bus.notify(success, project); æµ‹è¯•è¿è¡Œå³ä¾§ Gradle -&gt; é€‰æ‹© intellij -&gt; ç‚¹å‡» runlde æ‰“åŒ…å³ä¾§ Gradle -&gt; é€‰æ‹© intellij -&gt; ç‚¹å‡» buildPlugin æ­¤æ—¶åœ¨é¡¹ç›®è·¯å¾„ä¸‹ä¼šç”Ÿæˆæ’ä»¶ï¼ŒæŠŠè¿™ä¸ªæ’ä»¶åŒ…å‘ç»™å°å…„å¼Ÿå®‰è£…ä½¿ç”¨å°±è¡Œäº†ã€‚ ä¸Šä¼ åˆ° IDEA æ’ä»¶åº“è®¿é—® https://plugins.jetbrains.com/ åˆ›å»ºè´¦å·ï¼Œå°†æ’ä»¶åŒ…ä¸Šä¼ åˆ°ä»“åº“å³å¯ã€‚å½“ç„¶ä¹Ÿæœ‰å…¶ä»–çš„æ–¹å¼ï¼Œè¿™å—å°±æ²¡æœ‰ç ”ç©¶äº†ã€‚ æ€»ç»“é€šè¿‡ä¸Šé¢çš„æ–¹å¼å·²ç»ç®€å•å¼€å‘ä¸€ä¸ªæ’ä»¶äº†ï¼Œè¦é—®è¿™ä¸ªæ’ä»¶æœ‰ä»€ä¹ˆç”¨ï¼Ÿ å…¶å®å°±æ˜¯åœ¨å†™æ–‡æ¡£ï¼Œæˆ–è€…æ¥å£è°ƒç”¨çš„æ—¶å€™ï¼Œç›´æ¥å°† Java Bean å¤åˆ¶ä¸º Json ä¸²ï¼Œçœè¿‡ä¸€ä¸ªä¸€ä¸ªæ•²ï¼Œç„¶åæ‰‹å†™ Json äº†ã€‚ ç›¸å…³èµ„æ–™[1] IntelliJ Platform SDK DevGuideï¼šhttps://jetbrains.org/intellij/sdk/docs/intro/intellij_platform.html[2] JetBrains Plugins Repositoryï¼šhttps://plugins.jetbrains.com/[3] Toolkitï¼š https://github.com/liuzhihang/toolkit[4] copy-as-jsonï¼šhttps://github.com/liuzhihang/copy-as-json[5] copy-as-json æ’ä»¶åœ°å€ï¼šhttps://plugins.jetbrains.com/plugin/13606-copy-as-json","categories":[{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/"},{"name":"IDEA","slug":"å·¥å…·å†Œ/IDEA","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/IDEA/"}],"tags":[{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E5%85%B7%E5%86%8C/"},{"name":"IDEA","slug":"IDEA","permalink":"https://liuzhihang.com/tags/IDEA/"},{"name":"plugin","slug":"plugin","permalink":"https://liuzhihang.com/tags/plugin/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- å¿«è¿›æ¥ï¼èŠ±å‡ åˆ†é’Ÿçœ‹ä¸€ä¸‹ ReentrantReadWriteLock çš„åŸç†ï¼","slug":"source-code/java/ReentrantReadWriteLock","date":"2020-07-27T15:50:00.000Z","updated":"2020-12-27T09:23:14.595Z","comments":true,"path":"2020/07/27/source-code-reentrant-read-write-lock.html","link":"","permalink":"https://liuzhihang.com/2020/07/27/source-code-reentrant-read-write-lock.html","excerpt":"","text":"å‰è¨€ åœ¨çœ‹å®Œ ReentrantLock ä¹‹åï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ ReentrantLock å·²ç»è¶³å¤Ÿä½¿ç”¨ï¼Œä½†æ˜¯å› ä¸º ReentrantLock æ˜¯ç‹¬å é”ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–è¯¥é”ï¼Œè€Œå¾ˆå¤šåº”ç”¨åœºæ™¯éƒ½æ˜¯è¯»å¤šå†™å°‘ï¼Œè¿™æ—¶å€™ä½¿ç”¨ ReentrantLock å°±ä¸å¤ªåˆé€‚äº†ã€‚è¯»å¤šå†™å°‘çš„åœºæ™¯è¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿåœ¨ JUC åŒ…ä¸‹åŒæ ·æä¾›äº†è¯»å†™é” ReentrantReadWriteLock æ¥åº”å¯¹è¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚ ä»‹ç»æ”¯æŒç±»ä¼¼ ReentrantLock è¯­ä¹‰çš„ ReadWriteLock çš„å®ç°ã€‚ å…·æœ‰ä»¥ä¸‹å±æ€§ï¼š è·å–é¡ºåº æ­¤ç±»ä¸ä¼šå°†è¯»å–ä¼˜å…ˆæˆ–å†™å…¥ä¼˜å…ˆå¼ºåŠ ç»™é”è®¿é—®çš„æ’åºã€‚ä½†æ˜¯ï¼Œå®ƒç¡®å®æ”¯æŒå¯é€‰çš„å…¬å¹³ ç­–ç•¥ã€‚ æ”¯æŒå…¬å¹³æ¨¡å¼å’Œéå…¬å¹³æ¨¡å¼ï¼Œé»˜è®¤ä¸ºéå…¬å¹³æ¨¡å¼ã€‚ é‡å…¥ å…è®¸ reader å’Œ writer æŒ‰ç…§ ReentrantLock çš„æ ·å¼é‡æ–°è·å–è¯»é”æˆ–å†™é”ã€‚åœ¨å†™çº¿ç¨‹é‡Šæ”¾æŒæœ‰çš„æ‰€æœ‰å†™é”åï¼Œreader æ‰å…è®¸é‡å…¥ä½¿ç”¨å®ƒä»¬ã€‚æ­¤å¤–ï¼Œwriter å¯ä»¥è·å–è¯»é”ï¼Œä½†åè¿‡æ¥åˆ™ä¸æˆç«‹ã€‚ é”é™çº§ é‡å…¥è¿˜å…è®¸ä»å†™é”é™çº§ä¸ºè¯»é”ï¼Œé€šè¿‡å…ˆè·å–å†™é”ï¼Œç„¶åè·å–è¯»é”ï¼Œæœ€åé‡Šæ”¾å†™é”çš„æ–¹å¼é™çº§ã€‚ä½†æ˜¯ï¼Œä»è¯»é”å‡çº§åˆ°å†™é”æ˜¯ä¸å¯èƒ½çš„ã€‚ é”è·å–çš„ä¸­æ–­ è¯»é”å’Œå†™é”éƒ½æ”¯æŒé”è·å–æœŸé—´çš„ä¸­æ–­ã€‚ Condition æ”¯æŒ å†™é”æä¾›äº†ä¸€ä¸ª Condition å®ç°ï¼Œå¯¹äºå†™é”æ¥è¯´ï¼Œè¯¥å®ç°çš„æ–¹å¼ä¸ ReentrantLock.newCondition() æä¾›çš„ Condition å®ç°å¯¹ ReentrantLock æ‰€åšçš„è¡Œä¸ºç›¸åŒã€‚å½“ç„¶ï¼Œæ­¤ Condition åªèƒ½ç”¨äºå†™é”ã€‚è¯»é”ä¸æ”¯æŒ Conditionã€‚ ç›‘æµ‹ æ­¤ç±»æ”¯æŒä¸€äº›ç¡®å®šæ˜¯ä¿æŒé”è¿˜æ˜¯äº‰ç”¨é”çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•è®¾è®¡ç”¨äºç›‘è§†ç³»ç»ŸçŠ¶æ€ï¼Œè€Œä¸æ˜¯åŒæ­¥æ§åˆ¶ã€‚ é”æœ€å¤šæ”¯æŒ 65535 ä¸ªé€’å½’å†™é”å’Œ 65535 ä¸ªè¯»é” ä»¥ä¸Šä¸º Java Api å®˜æ–¹æ–‡æ¡£[1] çš„è§£é‡Šï¼Œæ€»ç»“ä¸€ä¸‹å†…å®¹å¦‚ä¸‹ï¼š æ”¯æŒéå…¬å¹³å’Œå…¬å¹³æ¨¡å¼ï¼Œé»˜è®¤ä¸ºéå…¬å¹³æ¨¡å¼ã€‚ æ”¯æŒé‡å…¥ï¼Œè¯»é”å¯ä»¥é‡å…¥è·å–è¯»é”ï¼Œå†™é”å¯ä»¥é‡å…¥è·å–å†™é”ï¼Œå†™é”å¯ä»¥è·å–è¯»é”ï¼Œè¯»é”ä¸å¯ä»¥è·å–å†™é”ã€‚ é”å¯ä»¥é™çº§ï¼Œä»å†™é”é™çº§ä¸ºè¯»é”ï¼Œä½†æ˜¯ä¸å¯èƒ½ä»è¯»é”å‡çº§åˆ°å†™é”ã€‚ åŸºæœ¬ä½¿ç”¨class CachedData &#123; Object data; volatile boolean cacheValid; final ReentrantReadWriteLock rwl = new ReentrantReadWriteLock(); void processCachedData() &#123; // è¯»é”åŠ é” rwl.readLock().lock(); if (!cacheValid) &#123; // è·å–å†™é”ä¹‹å‰å¿…é¡»é‡Šæ”¾è¯»é” rwl.readLock().unlock(); // å†™é”åŠ é” rwl.writeLock().lock(); try &#123; // é‡æ–°æ£€æŸ¥çŠ¶æ€ï¼Œå› ä¸ºå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½ // åœ¨æ‰§è¡Œæ“ä½œä¹‹å‰è·å–äº†å†™é”å®šå¹¶æ›´æ”¹äº†çŠ¶æ€ if (!cacheValid) &#123; data = ... cacheValid = true; &#125; // é€šè¿‡åœ¨é‡Šæ”¾å†™é”ä¹‹å‰è·å–è¯»é”æ¥é™çº§ rwl.readLock().lock(); &#125; finally &#123; rwl.writeLock().unlock(); // Unlock write, still hold read &#125; &#125; try &#123; use(data); &#125; finally &#123; rwl.readLock().unlock(); &#125; &#125;&#125; ä¸Šé¢åªæ˜¯å®˜æ–¹æ–‡æ¡£æä¾›çš„ä¸€ä¸ª demoã€‚ é—®é¢˜ç–‘é—® åœ¨ ReentrantReadWriteLock ä¸­ state ä»£è¡¨ä»€ä¹ˆï¼Ÿ çº¿ç¨‹è·å–é”çš„æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ è¯»é”å’Œå†™é”çš„å¯é‡å…¥æ€§æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¢«é˜»å¡çš„åç»­æ“ä½œæ˜¯ä»€ä¹ˆï¼Ÿ é”é™çº§æ˜¯æ€ä¹ˆé™çº§çš„ï¼Ÿ æºç åˆ†æä»£ç ç»“æ„ public class ReentrantReadWriteLock implements ReadWriteLock, java.io.Serializable &#123; private static final long serialVersionUID = -6992448646407690164L; /** æä¾›è¯»é”çš„å†…éƒ¨ç±» */ private final ReentrantReadWriteLock.ReadLock readerLock; /** æä¾›å†™é”çš„å†…éƒ¨ç±» */ private final ReentrantReadWriteLock.WriteLock writerLock; /** æ‰§è¡Œæ‰€æœ‰åŒæ­¥æœºåˆ¶ */ final Sync sync;&#125; stateä¹‹å‰åœ¨é˜…è¯» ReentrantLock æºç çš„æ—¶å€™ state ä»£è¡¨äº†é”çš„çŠ¶æ€ï¼Œ0 è¡¨ç¤ºæ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œå¤§äº 1 è¡¨ç¤ºå·²ç»æœ‰çº¿ç¨‹æŒæœ‰é”åŠå…¶é‡å…¥çš„æ¬¡æ•°ã€‚è€Œåœ¨ ReentrantReadWriteLock æ˜¯è¯»å†™é”ï¼Œé‚£å°±éœ€è¦ä¿å­˜è¯»é”å’Œå†™é”ä¸¤ç§çŠ¶æ€çš„ï¼Œé‚£æ˜¯æ€ä¹ˆæ ·è¡¨ç¤ºçš„å‘¢ï¼Ÿ åœ¨ ReentrantReadWriteLock ä¸­åŒæ ·å­˜åœ¨ä¸€ä¸ª Sync ç»§æ‰¿äº† AbstractQueuedSynchronizerï¼Œä¹Ÿæ˜¯ FairSyncã€NonfairSync çš„çˆ¶ç±»ã€‚å†…éƒ¨å®šä¹‰äº† state çš„ä¸€äº›æ“ä½œã€‚ abstract static class Sync extends AbstractQueuedSynchronizer &#123; private static final long serialVersionUID = 6317671515068378041L; // ç§»ä½æ•° static final int SHARED_SHIFT = 16; // å•ä½ static final int SHARED_UNIT = (1 &lt;&lt; SHARED_SHIFT); // æœ€å¤§æ•°é‡ 1 &lt;&lt; 16 -&gt; 65536 static final int MAX_COUNT = (1 &lt;&lt; SHARED_SHIFT) - 1; // è®¡ç®—ç‹¬å æ•°ä½¿ç”¨ 1 &lt;&lt; 16 -&gt; 65536 static final int EXCLUSIVE_MASK = (1 &lt;&lt; SHARED_SHIFT) - 1; // è¿”å›å…±äº«ä¿ç•™æ•° static int sharedCount(int c) &#123; return c &gt;&gt;&gt; SHARED_SHIFT; &#125; // è¿”å›ç‹¬å ä¿ç•™æ•° static int exclusiveCount(int c) &#123; return c &amp; EXCLUSIVE_MASK; &#125;&#125; åœ¨ AQS ä¸­å®šä¹‰ state ä¸º int ç±»å‹ï¼Œè€Œåœ¨ ReentrantReadWriteLock ä¸­ï¼Œå°† state çš„ é«˜ 16 ä½å’Œä½ 16 ä½æ‹†å¼€è¡¨ç¤ºè¯»å†™é”ã€‚å…¶ä¸­é«˜ 16 ä½è¡¨ç¤ºè¯»é”ï¼Œä½ 16 ä½è¡¨ç¤ºå†™é”ã€‚åˆ†åˆ«ä½¿ç”¨ sharedCount å’Œ exclusiveCount æ–¹æ³•è·å–è¯»é”å’Œå†™é”çš„å½“å‰çŠ¶æ€ã€‚ ä¸‹é¢åˆ†åˆ«ä»è¯»é”å’Œå†™é”çš„è§’åº¦æ¥çœ‹å¦‚ä½•è¿›è¡ŒåŠ é”å’Œé‡Šæ”¾é”çš„ï¼Ÿ ReadLock.lockpublic static class ReadLock implements Lock, java.io.Serializable &#123; /** * è·å–è¯»å–é”ã€‚ * å¦‚æœå†™é”æ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåˆ™è·å–è¯»é”å¹¶ç«‹å³è¿”å›ã€‚ * å¦‚æœå†™é”ç”±å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåˆ™å‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œ * å½“å‰çº¿ç¨‹å°†è¢«ç¦ç”¨ï¼Œå¹¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°è·å–è¯»é”ä¸ºæ­¢ã€‚ */ public void lock() &#123; // è°ƒç”¨ AQS è·å–å…±äº«èµ„æº sync.acquireShared(1); &#125;&#125; è·å–å…±äº«èµ„æºï¼Œè¿™å—ä½¿ç”¨çš„ AQS çš„é€»è¾‘ï¼Œå…¶ä¸­ tryAcquireShared(arg) æ˜¯åœ¨ ReentrantReadWriteLock.Sync ä¸­å®ç°çš„ã€‚å¹¶ä¸” AQS ä¸­æœ‰è§„å®šï¼ŒtryAcquireShared åˆ†ä¸ºä¸‰ç§è¿”å›å€¼ï¼š å°äº 0: è¡¨ç¤ºå¤±è´¥ï¼› ç­‰äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œä½†åç»­çš„èŠ‚ç‚¹ä¸èƒ½ä»¥å…±äº«æ¨¡å¼è·å–æˆåŠŸ; å¤§äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œåç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¹Ÿå¯èƒ½ä¼šæˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåç»­ç­‰å¾…çº¿ç¨‹å¿…é¡»æ£€æŸ¥å¯ç”¨æ€§ã€‚ abstract static class Sync extends AbstractQueuedSynchronizer &#123; protected final int tryAcquireShared(int unused) &#123; Thread current = Thread.currentThread(); // è·å– state å€¼ int c = getState(); // ç‹¬å è®¡æ•°ä¸ä¸º 0 ä¸” ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œ è¯´æ˜å·²ç»æœ‰å†™é” if (exclusiveCount(c) != 0 &amp;&amp; getExclusiveOwnerThread() != current) return -1; // è·å–å…±äº«è®¡æ•°ï¼ˆè¯»é”è®¡æ•°ï¼‰ int r = sharedCount(c); // ä¸éœ€è¦é˜»å¡è¯»é” &amp;&amp; å…±äº«è®¡æ•°å°äºæœ€å¤§å€¼ &amp;&amp; state æ›´æ–°æˆåŠŸ if (!readerShouldBlock() &amp;&amp; r &lt; MAX_COUNT &amp;&amp; compareAndSetState(c, c + SHARED_UNIT)) &#123; if (r == 0) &#123; // å½“å‰è¯»é”è®¡æ•°ä¸º 0 // firstReaderæ˜¯è·å¾—è¯»é”çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ // firstReaderHoldCountæ˜¯firstReaderçš„ä¿æŒè®¡æ•° firstReader = current; firstReaderHoldCount = 1; &#125; else if (firstReader == current) &#123; // è¯»é”é‡å…¥ firstReaderHoldCount++; &#125; else &#123; // å½“å‰ç¼“å­˜è®¡æ•° HoldCounter rh = cachedHoldCounter; // å½“å‰çº¿ç¨‹æ²¡æœ‰è®¡æ•° æˆ–è€… æ²¡æœ‰åˆ›å»ºè®¡æ•°å™¨ if (rh == null || rh.tid != getThreadId(current)) // åˆ›å»ºè®¡æ•°ï¼ŒåŸºäº ThreadLocal cachedHoldCounter = rh = readHolds.get(); else if (rh.count == 0) readHolds.set(rh); // è®¡æ•°ç´¯åŠ  rh.count++; &#125; return 1; &#125; // å®Œæ•´åœ°è·å–å…±äº«é”æ–¹æ³•ï¼Œä½œä¸ºtryAcquireSharedæ–¹æ³•å› CASè·å–é”å¤±è´¥åçš„å¤„ç†ã€‚ // å› ä¸ºå‰é¢å¯èƒ½å¤±è´¥ CAS å¤±è´¥ï¼Œ é˜Ÿåˆ—ç­–ç•¥å¤±è´¥ç­‰åŸå› ã€‚ return fullTryAcquireShared(current); &#125;&#125; å…ˆè·å– state ï¼Œé€šè¿‡ exclusiveCount æ–¹æ³•è·å–åˆ°å†™é”çš„è®¡æ•°å€¼ï¼Œä¸ä¸º 0 ä¸” ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œ è¯´æ˜å·²ç»æœ‰å†™é”ã€‚è¿”å› -1 å¤±è´¥ã€‚ é€šè¿‡ sharedCount è·å–è¯»é”è®¡æ•°ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦é˜»å¡ä»¥åŠæ˜¯å¦è¶…è¿‡ä¸Šé™åï¼Œä½¿ç”¨ CAS æ›´æ–° è¯»é”è®¡æ•°ã€‚ è®¾ç½®æˆ–æ›´æ–° firstReaderã€firstReaderHoldCountã€ cachedHoldCounterã€‚ æœ€åä¼šè¿›è¡Œå®Œæ•´çš„è·å–å…±äº«é”æ–¹æ³•ï¼Œä½œä¸ºä¹‹å‰è·å–å¤±è´¥çš„åç»­å¤„ç†æ–¹æ³•ã€‚ firstReaderï¼šfirstReaderæ˜¯è·å¾—è¯»é”çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼›firstReaderHoldCountï¼šfirstReaderHoldCountæ˜¯firstReaderçš„ä¿æŒè®¡æ•°ã€‚å³è·å¾—è¯»é”çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹çš„é‡å…¥æ¬¡æ•°ã€‚cachedHoldCounterï¼šæœ€åä¸€ä¸ªè·å¾—è¯»é”çš„çº¿ç¨‹è·å¾—è¯»é”çš„é‡å…¥æ¬¡æ•°ã€‚ final int fullTryAcquireShared(Thread current) &#123; HoldCounter rh = null; // æ— é™å¾ªç¯ for (;;) &#123; int c = getState(); // æ˜¯å¦æœ‰å†™é” if (exclusiveCount(c) != 0) &#123; // æœ‰å†™é”ï¼Œä½†æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œç›´æ¥è¿”å›å¤±è´¥ if (getExclusiveOwnerThread() != current) return -1; &#125; else if (readerShouldBlock()) &#123; // éœ€è¦é˜»å¡ // æ²¡æœ‰å†™é”ï¼Œç¡®ä¿æ²¡æœ‰é‡æ–°è·å–è¯»é” if (firstReader == current) &#123; // assert firstReaderHoldCount &gt; 0; &#125; else &#123; // å½“å‰çº¿ç¨‹çš„è¯»é”è®¡æ•° ThreadLocal ä¸­ if (rh == null) &#123; rh = cachedHoldCounter; if (rh == null || rh.tid != getThreadId(current)) &#123; rh = readHolds.get(); // è®¡æ•°ç»“æŸï¼Œremove æ‰ if (rh.count == 0) readHolds.remove(); &#125; &#125; // ä¸º 0 ç›´æ¥å¤±è´¥ if (rh.count == 0) return -1; &#125; &#125; // åˆ°è¾¾ä¸Šé™ æŠ›å‡ºå¼‚å¸¸ if (sharedCount(c) == MAX_COUNT) throw new Error(&quot;Maximum lock count exceeded&quot;); // CAS è®¾ç½®è¯»é” if (compareAndSetState(c, c + SHARED_UNIT)) &#123; if (sharedCount(c) == 0) &#123; firstReader = current; firstReaderHoldCount = 1; &#125; else if (firstReader == current) &#123; firstReaderHoldCount++; &#125; else &#123; if (rh == null) rh = cachedHoldCounter; if (rh == null || rh.tid != getThreadId(current)) rh = readHolds.get(); else if (rh.count == 0) readHolds.set(rh); rh.count++; cachedHoldCounter = rh; // cache for release &#125; return 1; &#125; &#125;&#125; é¦–å…ˆä¼šä¸€ç›´å¾ªç¯ æœ‰å†™é”ï¼Œä½†æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œç›´æ¥è¿”å›å¤±è´¥ã€‚ä½†æ˜¯ï¼Œæœ‰å†™é”ï¼Œå¦‚æœæ˜¯å½“å‰çº¿ç¨‹ï¼Œæ˜¯ä¼šç»§ç»­æ‰§è¡Œçš„ã€‚ è®¾ç½®æˆ–æ›´æ–° firstReaderã€firstReaderHoldCountã€ cachedHoldCounterã€‚ å½“å­˜åœ¨å†™é”ï¼ˆç‹¬å é”ï¼‰æ—¶ï¼Œæ–¹æ³•ä¼šè¿”å› -1 å¤±è´¥ï¼Œåç»­ä¼šè°ƒç”¨ AQS çš„ doAcquireShared æ–¹æ³•ï¼Œå¾ªç¯è·å–èµ„æºã€‚doAcquireShared æ–¹æ³•ä¼šä¸æ–­å¾ªç¯ï¼Œå°è¯•è·å–è¯»é”ï¼Œä¸€æ—¦è·å–åˆ°è¯»é”ï¼Œå½“å‰èŠ‚ç‚¹ä¼šç«‹å³å”¤é†’åç»­èŠ‚ç‚¹ï¼Œåç»­èŠ‚ç‚¹å¼€å§‹å°è¯•è·å–è¯»é”ï¼Œä¾æ¬¡ä¼ æ’­ã€‚ ReadLock.unlockpublic static class ReadLock implements Lock, java.io.Serializable &#123; public void unlock() &#123; sync.releaseShared(1); &#125;&#125; è°ƒç”¨ AQS çš„ releaseShared é‡Šæ”¾å…±äº«èµ„æºæ–¹æ³•ã€‚ å…¶ä¸­ tryReleaseShared æœ‰ ReadLock å®ç°ã€‚ protected final boolean tryReleaseShared(int unused) &#123; Thread current = Thread.currentThread(); if (firstReader == current) &#123; // ç¬¬ä¸€ä¸ªçº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ if (firstReaderHoldCount == 1) firstReader = null; else firstReaderHoldCount--; &#125; else &#123; // ç¬¬ä¸€ä¸ªçº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œæ›´æ–°è‡ªå·±çš„ ThreadLocal é‡Œé¢çš„è®¡æ•° HoldCounter rh = cachedHoldCounter; if (rh == null || rh.tid != getThreadId(current)) rh = readHolds.get(); int count = rh.count; if (count &lt;= 1) &#123; readHolds.remove(); if (count &lt;= 0) throw unmatchedUnlockException(); &#125; --rh.count; &#125; // å¾ªç¯ for (;;) &#123; int c = getState(); int nextc = c - SHARED_UNIT; // ä½¿ç”¨ CAS æ›´æ–° state if (compareAndSetState(c, nextc)) // ä½†æ˜¯å¦‚æœç°åœ¨è¯»å’Œå†™é”éƒ½å·²é‡Šæ”¾ï¼Œ // å®ƒå¯èƒ½å…è®¸ç­‰å¾…çš„å†™ç¨‹åºç»§ç»­è¿›è¡Œã€‚ return nextc == 0; &#125;&#125; å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œç›´æ¥æ›´æ–°æŠ€æœ¯ï¼Œä¸æ˜¯åˆ™æ›´æ–°è‡ªå·± ThreadLocal é‡Œé¢ä¿å­˜çš„è®¡æ•°ã€‚ å¾ªç¯ï¼Œä½¿ç”¨ CAS æ›´æ–° state çš„å€¼ã€‚ å¦‚æœ state æ›´æ–°åçš„å€¼ä¸º 0ï¼Œè¯´æ˜æ²¡æœ‰çº¿ç¨‹æŒæœ‰è¯»é”æˆ–è€…å†™é”äº†ã€‚ å½“ state ä¸º 0ï¼Œæ­¤æ—¶ä¼šè°ƒç”¨ AQS çš„ doReleaseShared æ–¹æ³•ã€‚æ­¤æ—¶é˜Ÿåˆ—å¦‚æœæœ‰å†™é”ï¼Œé‚£å°±ä¼šè¢«å†™é”è·å–çš„é”ã€‚ WriteLock.lockpublic static class WriteLock implements Lock, java.io.Serializable &#123; /** * è·å–å†™å…¥é”ã€‚ * å¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰è¯»é”æˆ–å†™é”ï¼Œä¼šç›´æ¥è¿”å›ï¼Œå¹¶å°†å†™é”è®¡æ•°è®¾ç½®ä¸º1ã€‚ * å¦‚æœå½“å‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œåˆ™å°†å†™é”è®¡æ•° +1ï¼Œç„¶åè¿”å›ã€‚ * å¦‚æœé”æ­£åœ¨è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œåˆ™å½“å‰çº¿ç¨‹ç”¨äºçº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œ * å½“å‰çº¿ç¨‹å°†è¢«ç¦ç”¨ï¼Œå¹¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°è·å–è¯»é”å¹¶å°†å†™é”è®¡æ•°è®¾ç½®ä¸º1ã€‚ */ public void lock() &#123; sync.acquire(1); &#125;&#125; tryAcquire æ–¹æ³•ç”± Write è‡ªå·±å®ç°ï¼Œæ–¹å¼å’Œ ReentrantLock ç±»ä¼¼ã€‚ protected final boolean tryAcquire(int acquires) &#123; // å¦‚æœè¯»é”è®¡æ•°ä¸ºéé›¶æˆ–å†™é”è®¡æ•°ä¸ºéé›¶ï¼Œå¹¶ä¸”æ‰€æœ‰è€…æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œåˆ™å¤±è´¥ã€‚ // å¦‚æœè®¡æ•°é¥±å’Œï¼Œåˆ™å¤±è´¥ã€‚åªæœ‰åœ¨countä¸ä¸ºé›¶æ—¶ï¼Œæ‰å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µã€‚ // å¦åˆ™ï¼Œå¦‚æœè¯¥çº¿ç¨‹æ˜¯å¯é‡å…¥è·å–æˆ–é˜Ÿåˆ—ç­–ç•¥å…è®¸çš„è¯ï¼Œåˆ™æœ‰èµ„æ ¼è¿›è¡Œé”å®šã€‚ // å¦‚æœæ˜¯è¿™æ ·ï¼Œè¯·æ›´æ–°çŠ¶æ€å¹¶è®¾ç½®æ‰€æœ‰è€…ã€‚ Thread current = Thread.currentThread(); int c = getState(); // å†™é”è®¡æ•° int w = exclusiveCount(c); // c ï¼= 0 è¯´æ˜æœ‰æœ‰çº¿ç¨‹è·å–é”äº† if (c != 0) &#123; // (Note: if c != 0 and w == 0 then shared count != 0) // åˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå·±ï¼Œä¸æ˜¯è‡ªå·± è¿”å› false if (w == 0 || current != getExclusiveOwnerThread()) return false; // åˆ¤æ–­æœ‰æ²¡æœ‰è¶…è¿‡ä¸Šé™ if (w + exclusiveCount(acquires) &gt; MAX_COUNT) throw new Error(&quot;Maximum lock count exceeded&quot;); // é‡å…¥ setState(c + acquires); return true; &#125; // ä¸éœ€è¦é˜»å¡ï¼Œæˆ–è€… CAS æ›´æ–° state å¤±è´¥ if (writerShouldBlock() || !compareAndSetState(c, c + acquires)) return false; setExclusiveOwnerThread(current); return true;&#125; è·å– state ï¼Œ å¦‚æœ state ä¸ä¸º 0 åˆ™åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹é‡å…¥è·å–ã€‚ state ä¸º 0 ï¼Œåˆ™å½“å‰çº¿ç¨‹ CAS æ›´æ–° stateï¼Œè·å–é”ã€‚ æ›´æ–°æˆåŠŸä¹‹åç»‘å®šå½“å‰çº¿ç¨‹ã€‚ å¦‚æœå¤±è´¥ä¼šç»§ç»­è°ƒç”¨ AQS çš„ acquireQueuedï¼Œå°†å½“å‰é˜»å¡æ”¾åœ¨ AQS é˜Ÿåˆ—ä¸­ã€‚AQS ä¼šä¸æ–­å¾ªç¯ï¼Œç­‰å¾…ä¸Šä¸€ä¸ªé”é‡Šæ”¾åï¼Œå°è¯•è·å¾—é”ã€‚ WriteLock.unlockpublic static class WriteLock implements Lock, java.io.Serializable &#123; // å¦‚æœå½“å‰çº¿ç¨‹æ˜¯æ­¤é”çš„æŒæœ‰è€…ï¼Œåˆ™ä¿æŒè®¡æ•°é€’å‡ã€‚ // å¦‚æœä¿æŒç°åœ¨çš„è®¡æ•°ä¸ºé›¶ï¼Œåˆ™è§£é™¤é”å®šã€‚ // å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æ­¤é”çš„æŒæœ‰è€…åˆ™IllegalMonitorStateExceptionå¼‚å¸¸ã€‚ public void unlock() &#123; sync.release(1); &#125;&#125; åŒæ ·è¿™å—ä»£ç æ˜¯ä½¿ç”¨ AQS çš„é€»è¾‘ï¼ŒtryRelease éƒ¨åˆ†ç”± WriteLock è‡ªå·±å®ç°ã€‚ protected final boolean tryRelease(int releases) &#123; if (!isHeldExclusively()) throw new IllegalMonitorStateException(); int nextc = getState() - releases; boolean free = exclusiveCount(nextc) == 0; if (free) setExclusiveOwnerThread(null); setState(nextc); return free;&#125; å¦‚æœæ˜¯å½“å‰çº¿ç¨‹é‡å…¥ï¼Œæ‰£å‡é‡å…¥æ¬¡æ•°ã€‚ æ‰£å‡åå¦‚æœä¸º 0ï¼Œåˆ™è®¾ç½®é”æŒæœ‰çº¿ç¨‹ä¸º nullï¼Œæ›´æ–° state å€¼ã€‚AQS ä¼šå”¤é†’åç»­èŠ‚ç‚¹è·å–é”ã€‚ æ€»ç»“é—®é¢˜Qï¼šåœ¨ ReentrantReadWriteLock ä¸­ state ä»£è¡¨ä»€ä¹ˆï¼Ÿ Aï¼šstate ä»£è¡¨é”çš„çŠ¶æ€ã€‚state ä¸º 0 ï¼Œæ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œstate çš„é«˜ 16 ä¸ºä»£è¡¨è¯»é”çŠ¶æ€ï¼Œä½ 16 ä¸ºä»£è¡¨å†™é”çŠ¶æ€ã€‚é€šè¿‡ä½è¿ç®—å¯ä»¥è·å–è¯»å†™é”çš„å®é™…å€¼ã€‚ Qï¼šçº¿ç¨‹è·å–é”çš„æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ Aï¼šå¯ä»¥å‚è€ƒä¸Šé¢çš„æºç ç¬”è®°ï¼Œä»¥åŠåé¢çš„æµç¨‹å›¾ã€‚ Qï¼šè¯»é”å’Œå†™é”çš„å¯é‡å…¥æ€§æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ Aï¼šåœ¨åŠ é”çš„æ—¶å€™ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™ç›´æ¥ç´¯åŠ è®¡æ•°ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šè¯»é”é‡å…¥è®¡æ•°ä½¿ç”¨çš„ ThreadLocal åœ¨çº¿ç¨‹ä¸­ç¼“å­˜è®¡æ•°ï¼Œè€Œå†™é”åˆ™ç›´æ¥ç”¨çš„ state è¿›è¡Œç´¯åŠ ï¼ˆå…¶å®å’Œ state ä½ 16 ä½è¿›è¡Œç´¯åŠ ä¸€æ ·ï¼‰ã€‚ Qï¼šå½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¢«é˜»å¡çš„åç»­æ“ä½œæ˜¯ä»€ä¹ˆï¼Ÿ Aï¼šè·å–å¤±è´¥ï¼Œä¼šæ”¾åˆ° AQS ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåœ¨é˜Ÿåˆ—ä¸­ä¸æ–­å¾ªç¯ï¼Œç›‘è§†å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸º head ï¼Œæ˜¯çš„è¯ï¼Œä¼šé‡æ–°å°è¯•è·å–é”ã€‚ Qï¼šé”é™çº§æ˜¯æ€ä¹ˆé™çº§çš„ï¼Ÿ Aï¼š å¦‚å›¾ï¼Œåœ¨åœˆå‡ºéƒ¨åˆ† fullTryAcquireShared ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨è·å–è¯»é”çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œæ˜¯å¯ä»¥è·å–è¯»é”çš„ã€‚è¿™å—å°±æ˜¯æŒ‡é”é™çº§ï¼Œæ¯”å¦‚çº¿ç¨‹ A è·å–åˆ°äº†å†™é”ï¼Œå½“çº¿ç¨‹ A æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œå®ƒéœ€è¦è·å–å½“å‰æ•°æ®ï¼Œå‡è®¾ä¸æ”¯æŒé”é™çº§ï¼Œå°±ä¼šå¯¼è‡´ A é‡Šæ”¾å†™é”ï¼Œç„¶åå†æ¬¡è¯·æ±‚è¯»é”ã€‚è€Œåœ¨è¿™ä¸­é—´æ˜¯æœ‰å¯èƒ½è¢«å…¶ä»–é˜»å¡çš„çº¿ç¨‹è·å–åˆ°å†™é”çš„ã€‚ä»è€Œå¯¼è‡´çº¿ç¨‹ A åœ¨ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ•°æ®ä¸ä¸€è‡´ã€‚ å°ç»“ ReentrantReadWriteLock è¯»å†™é”ï¼Œå†…éƒ¨å®ç°æ˜¯ ReadLock è¯»é” å’Œ WriteLock å†™é”ã€‚è¯»é”ï¼Œå…è®¸å…±äº«ï¼›å†™é”ï¼Œæ˜¯ç‹¬å é”ã€‚ è¯»å†™é”éƒ½æ”¯æŒé‡å…¥ï¼Œè¯»é”çš„é‡å…¥æ¬¡æ•°è®°å½•åœ¨çº¿ç¨‹ç»´æŠ¤çš„ ThreadLocal ä¸­ï¼Œå†™é”ç»´æŠ¤åœ¨ state ä¸Šï¼ˆä½ 16 ä½ï¼‰ã€‚ æ”¯æŒé”é™çº§ï¼Œä»å†™é”é™çº§ä¸ºè¯»é”ï¼Œé˜²æ­¢è„è¯»ã€‚ ReadLock å’Œ WriteLock éƒ½æ˜¯é€šè¿‡ AQS æ¥å®ç°çš„ã€‚è·å–é”å¤±è´¥åä¼šæ”¾åˆ° AQS ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåç»­ä¸æ–­å°è¯•è·å–é”ã€‚åŒºåˆ«åœ¨è¯»é”åªæœ‰å­˜åœ¨å†™é”çš„æ—¶å€™æ‰æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œå†™é”æ˜¯åªè¦å­˜åœ¨éå½“å‰çº¿ç¨‹é”ï¼ˆæ— è®ºå†™é”è¿˜æ˜¯è¯»é”ï¼‰éƒ½ä¼šæ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ã€‚ é€šè¿‡æºç åˆ†æï¼Œå¯ä»¥å¾—å‡ºè¯»å†™é”é€‚åˆåœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸­ä½¿ç”¨ã€‚ ç›¸å…³èµ„æ–™[1] Java Apiï¼šhttps://docs.oracle.com/javase/8/docs/api/overview-summary.html","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- ä¸èƒ½å†è¢«é—®ä½äº†ï¼ReentrantLock æºç ã€ç”»å›¾ä¸€èµ·çœ‹ä¸€çœ‹ï¼","slug":"source-code/java/ReentrantLock","date":"2020-07-25T01:50:00.000Z","updated":"2020-12-27T09:23:14.595Z","comments":true,"path":"2020/07/25/source-code-reentrant-lock.html","link":"","permalink":"https://liuzhihang.com/2020/07/25/source-code-reentrant-lock.html","excerpt":"","text":"åœ¨é˜…è¯»å®Œ JUC åŒ…ä¸‹çš„ AQS æºç ä¹‹åï¼Œå…¶ä¸­æœ‰å¾ˆå¤šç–‘é—®ï¼Œæœ€å¤§çš„ç–‘é—®å°±æ˜¯ state ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå«ä¹‰ï¼Ÿå¹¶ä¸” AQS ä¸»è¦å®šä¹‰äº†é˜Ÿåˆ—çš„å‡ºå…¥ï¼Œä½†æ˜¯è·å–èµ„æºã€é‡Šæ”¾èµ„æºéƒ½æ˜¯äº¤ç»™å­ç±»å®ç°çš„ï¼Œé‚£å­ç±»æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä¸‹é¢å¼€å§‹äº†è§£ ReentrantLockã€‚ ä»‹ç»ä¸€ä¸ªå¯é‡å…¥çš„äº’æ–¥é”ä¸éšå¼ç›‘è§†å™¨é”synchronizedå…·æœ‰ç›¸åŒçš„åŸºæœ¬è¡Œä¸ºå’Œè¯­ä¹‰ï¼Œä½†åŠŸèƒ½æ›´å¼ºå¤§ã€‚ å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š äº’æ–¥æ€§ï¼šåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–åˆ°è¯¥é”ï¼Œæ­¤æ—¶å…¶ä»–çº¿ç¨‹è¯·æ±‚è·å–é”ï¼Œä¼šè¢«é˜»å¡ï¼Œç„¶åè¢«æ”¾åˆ°è¯¥é”å†…éƒ¨ç»´æŠ¤çš„ä¸€ä¸ª AQS é˜»å¡é˜Ÿåˆ—ä¸­ã€‚ å¯é‡å…¥æ€§ï¼šç»´æŠ¤ state å˜é‡ï¼Œåˆå§‹ä¸º 0ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”æ—¶ï¼Œstate ä½¿ç”¨ cas æ›´æ–°ä¸º 1ï¼Œæœ¬çº¿ç¨‹å†æ¬¡ç”³è¯·è·å–é”ï¼Œä¼šå¯¹ state è¿›è¡Œ CAS é€’å¢ï¼Œé‡å¤è·å–æ¬¡æ•°å³ stateï¼Œæœ€å¤šä¸º 2147483647 ã€‚è¯•å›¾è¶…å‡ºæ­¤é™åˆ¶ä¼šä»é”å®šæ–¹æ³•æŠ›å‡º Errorã€‚ å…¬å¹³/éå…¬å¹³æ€§ï¼šåœ¨åˆå§‹åŒ–æ—¶ï¼Œå¯ä»¥é€šè¿‡æ„é€ å™¨ä¼ å‚ï¼ŒæŒ‡å®šæ˜¯å¦ä¸ºå…¬å¹³é”ï¼Œè¿˜æ˜¯éå…¬å¹³é”ã€‚å½“è®¾ç½®ä¸º true æ—¶ï¼Œä¸ºå…¬å¹³é”ï¼Œçº¿ç¨‹äº‰ç”¨é”æ—¶ï¼Œä¼šå€¾å‘äºç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ã€‚ åŸºæœ¬ä½¿ç”¨class X &#123; private final ReentrantLock lock = new ReentrantLock(); // ... public void m() &#123; lock.lock(); // block until condition holds try &#123; // ... method body &#125; finally &#123; lock.unlock() &#125;&#125;&#125; é—®é¢˜ç–‘é—®ï¼Ÿé¦–å…ˆåœ¨é˜…è¯»æœ¬æ–‡æ—¶ï¼Œå¯¹ AQS æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œå¦‚æœä¸äº†è§£çš„è¯ï¼Œå¯ä»¥çœ‹ä»¥ä¸‹ä¹‹å‰çš„æ–‡ç« ã€‚å›¾æ–‡è®²è§£ AQS åœ¨ AQS ä¸­ä»‹ç» state æ—¶ï¼Œè¯´ state å«ä¹‰ç”±å­ç±»è¿›è¡Œå®šä¹‰ï¼Œé‚£åœ¨ ReentrantLock ä¸­ state ä»£è¡¨ä»€ä¹ˆï¼Ÿ ReentrantLock å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ çº¿ç¨‹æ˜¯å¦‚ä½•è·å–åˆ°é”çš„ï¼Ÿ é”çš„å¯é‡å…¥æ€§æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¢«é˜»å¡çš„åç»­æ“ä½œæ˜¯ä»€ä¹ˆï¼Ÿ å…¬å¹³é”å’Œéå…¬å¹³é”æ˜¯å¦‚ä½•ä½“ç°çš„ï¼Ÿ é”æ˜¯å¦‚ä½•é‡Šæ”¾çš„ï¼Ÿ å°†é€šè¿‡æºç åŠç”»å›¾çš„æ–¹å¼ï¼Œå›´ç»•ä¸Šé¢å‡ ä¸ªé—®é¢˜ï¼Œå±•å¼€é˜…è¯»å’Œåˆ†æã€‚ æºç åˆ†æåŸºæœ¬ç»“æ„ åŸºæœ¬ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼ŒReentrantLock ç±»å®ç°äº†æ¥å£ Lockï¼Œåœ¨æ¥å£ Lock ä¸­å®šä¹‰äº†ä½¿ç”¨é”æ—¶çš„æ–¹æ³•ï¼Œæ–¹æ³•åŠå«ä¹‰å¦‚ä¸‹ï¼š public interface Lock &#123; // è·å–é”ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œä¼šé˜»å¡ã€‚ void lock(); // è·å–é”ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œä¼šé˜»å¡ã€‚å“åº”ä¸­æ–­ã€‚ void lockInterruptibly() throws InterruptedException; // å°è¯•è·å–é”ï¼Œå¦‚æœè·å–åˆ°ï¼Œè¿”å› trueï¼Œæ²¡æœ‰è·å–åˆ° è¿”å› false boolean tryLock(); // å°è¯•è·å–é”ï¼Œæ²¡æœ‰æœ‰è·å–åˆ°ï¼Œä¼šç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œå“åº”ä¸­æ–­ã€‚ boolean tryLock(long time, TimeUnit unit) throws InterruptedException; // é‡Šæ”¾é” void unlock();&#125; è€Œ ReentrantLock ä¹Ÿåªæ˜¯å®ç°äº† Lock æ¥å£ï¼Œå¹¶å®ç°äº†è¿™äº›æ–¹æ³•ï¼Œé‚£ ReentrantLock å’Œ AQS åˆ°åº•æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿè¿™å°±éœ€è¦çœ‹å†…éƒ¨å…·ä½“å¦‚ä½•å®ç°çš„äº†ã€‚ é€šè¿‡ä¸Šé¢ç±»å›¾å¯ä»¥çœ‹å‡ºï¼Œåœ¨ ReentrantLock ä¸­å«æœ‰ä¸¤ä¸ªå†…éƒ¨ç±»ï¼Œåˆ†åˆ«æ˜¯ NonfairSync FairSync è€Œå®ƒä¿©åˆå®ç°äº† æŠ½è±¡ç±» Syncï¼ŒæŠ½è±¡ç±» Sync ç»§æ‰¿äº† AbstractQueuedSynchronizer å³ AQSã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š public class ReentrantLock implements Lock, java.io.Serializable &#123; private final Sync sync; // é”çš„åŒæ­¥æ§åˆ¶åŸºç¡€ç±»ã€‚ å­ç±»å…·ä½“åˆ°å…¬å¹³å’Œéå…¬å¹³çš„ç‰ˆæœ¬ã€‚ ä½¿ç”¨AQSçŠ¶æ€æ¥è¡¨ç¤ºæŒæœ‰è¯¥é”çš„æ•°é‡ã€‚ abstract static class Sync extends AbstractQueuedSynchronizer &#123; // çœç•¥ ... &#125; static final class NonfairSync extends Sync &#123; // éå…¬å¹³é”é€»è¾‘ çœç•¥ ... &#125; static final class FairSync extends Sync &#123; // å…¬å¹³é”é€»è¾‘ çœç•¥ ... &#125; // é»˜è®¤éå…¬å¹³é” public ReentrantLock() &#123; sync = new NonfairSync(); &#125; // æ ¹æ®ä¼ å‚æŒ‡å®šå…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ï¼Œtrue å…¬å¹³é”ï¼Œfalse éå…¬å¹³é” public ReentrantLock(boolean fair) &#123; sync = fair ? new FairSync() : new NonfairSync(); &#125;&#125; é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼š é”çš„åŸºæœ¬æ§åˆ¶æ˜¯ç”± NonfairSync å’Œ FairSync è¿›è¡Œæ§åˆ¶çš„ï¼Œè€Œå®ƒä¿©çš„çˆ¶ç±» Sync ç»§æ‰¿äº† AQS (AbstractQueuedSynchronizer)ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´æ˜ ReentrantLock çš„å®ç°å’Œ AQS æ˜¯æœ‰å…³çš„ã€‚ NonfairSync ä»£è¡¨éå…¬å¹³é”å®ç°é€»è¾‘ï¼ŒFairSync ä»£è¡¨å…¬å¹³é”å®ç°é€»è¾‘ã€‚ æ„é€ å™¨ä¼ å‚å¯ä»¥çœ‹å‡ºï¼Œåˆå§‹åŒ–æ—¶ï¼Œé»˜è®¤ä¸º NonfairSync éå…¬å¹³é”ã€‚ä¹Ÿå¯ä»¥æŒ‡å®šå£°æ˜ä¸ºå…¬å¹³é”æˆ–éå…¬å¹³é”ï¼Œä¼ å‚ true ä¸º å…¬å¹³é”ï¼Œfalse ä¸ºéå…¬å¹³é”ã€‚ å…·ä½“ ReentrantLock å’Œ AQS çš„å…³ç³»æ˜¯æ€æ ·çš„ï¼Œå°±éœ€è¦é€šè¿‡åŠ é”çš„è¿‡ç¨‹æ¥åˆ†æäº†ã€‚ lock å¦‚å›¾æ‰€ç¤ºï¼Œé»˜è®¤å£°æ˜éå…¬å¹³é”ï¼Œlock æ–¹æ³•å†…éƒ¨è°ƒç”¨ sync.lock(); æ­¤æ—¶åº”è¯¥æ˜¯ä½¿ç”¨çš„éå…¬å¹³é”å†…éƒ¨çš„ lock åŠ é”æ“ä½œã€‚ final void lock() &#123; // é€šè¿‡ CAS è®¾ç½® state å€¼ 0 -&gt; 1 if (compareAndSetState(0, 1)) // è®¾ç½®æˆåŠŸå½“å‰çº¿ç¨‹è·å–åˆ°äº†é” setExclusiveOwnerThread(Thread.currentThread()); else // è®¾ç½®å¤±è´¥ï¼Œåˆ™è°ƒç”¨ AQS çš„æ–¹æ³•ï¼Œå°è¯•è·å–é”ã€‚ acquire(1);&#125; é¦–å…ˆä¼š ä½¿ç”¨ CAS æ›´æ–° state çš„å€¼ï¼Œ æ­¤æ—¶å°±ä¼šå‘ç°ï¼Œ state åœ¨è¿™é‡Œä»£è¡¨çš„é”çš„çŠ¶æ€ã€‚ 0 æœªåŠ é”ï¼Œ1 åŠ é”ã€‚ è®¾ç½®å¤±è´¥ï¼Œä¼šè°ƒç”¨ AQS çš„ acquire(1); æ–¹æ³•ã€‚ å†çœ‹ä¸‹ AQS çš„ acquire ä»£ç  public final void acquire(int arg) &#123; // tryAcquire å°è¯•è·å– stateï¼Œè·å–å¤±è´¥åˆ™ä¼šåŠ å…¥åˆ°é˜Ÿåˆ— if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt();&#125; åœ¨ä¹‹å‰åˆ†æ AQS æºç æ—¶ï¼Œå·²ç»ä»‹ç» tryAcquire æ˜¯å°è¯•è·å– state çš„å€¼ï¼ŒAQS ä¸­å¹¶ä¸æä¾›å¯ç”¨çš„æ–¹æ³•ï¼Œæ­¤å¤„æ˜¯ç”±å­ç±»å®ç°çš„ã€‚æ‰€ä»¥è¿™å—ä»£ç è¿˜æ˜¯åœ¨ NonfairSync ç±»ä¸­è‡ªå·±å®ç°çš„ä¸šåŠ¡é€»è¾‘ã€‚ static final class NonfairSync extends Sync &#123; // NonfairSync å®ç° protected final boolean tryAcquire(int acquires) &#123; // è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³• return nonfairTryAcquire(acquires); &#125;&#125;abstract static class Sync extends AbstractQueuedSynchronizer &#123; // NonfairSync çš„çˆ¶ç±» Sync ä¸­æœ‰å®ç° // state ä¼ å‚æ˜¯ 1 final boolean nonfairTryAcquire(int acquires) &#123; // è·å–å½“å‰çº¿ç¨‹ final Thread current = Thread.currentThread(); // è·å– state int c = getState(); // å¦‚æœ c æ˜¯ 0 if (c == 0) &#123; // ä½¿ç”¨ cas æ›´æ–°ä¸º 1 if (compareAndSetState(0, acquires)) &#123; // è®¾ç½®æŒæœ‰çº¿ç¨‹ä¸ºå½“å‰ setExclusiveOwnerThread(current); return true; &#125; &#125; else if (current == getExclusiveOwnerThread()) &#123; // å¦‚æœæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ // å¯¹ state è¿›è¡Œç´¯åŠ  int nextc = c + acquires; // ä¸å…è®¸è¶…è¿‡ int çš„æœ€å¤§å€¼ 2147483647 + 1 = -2147483648 if (nextc &lt; 0) // overflow throw new Error(&quot;Maximum lock count exceeded&quot;); // è®¾ç½® state çš„å€¼ setState(nextc); return true; &#125; return false; &#125;&#125; å½“å‰çº¿ç¨‹åŠ é”ï¼Œç›´æ¥ä½¿ç”¨ CAS æ–¹å¼å¯¹ state ä» 0 æ›´æ–°ä¸º 1ï¼Œæ›´æ–°æˆåŠŸï¼Œåˆ™è·å¾—é”ï¼Œæ›´æ–°å¤±è´¥ï¼Œåˆ™è·å–å¤±è´¥ã€‚ æ›´æ–°å¤±è´¥åä¼šè°ƒç”¨ AQS çš„ acquire(1); æ–¹æ³•ï¼Œ æ­¤å¤„ä¼ å‚ä¸º 1ã€‚ tryAcquire å†æ¬¡å°è¯•è·å–é”ã€‚ state æ˜¯ 0ï¼Œå°è¯•è·å–ã€‚è·å–æˆåŠŸè¿”å› trueï¼› state ä¸æ˜¯ 0ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹æŒæœ‰ï¼Œæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰åˆ™å¯¹ state è¿›è¡Œç´¯åŠ ã€‚ tryAcquire è·å–é”å¤±è´¥ï¼Œåˆ™èµ° AQS çš„ acquireQueued é€»è¾‘ï¼Œåˆ›å»ºèŠ‚ç‚¹ï¼Œå¹¶åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚ æµç¨‹ç”»å›¾å¦‚ä¸‹ï¼š åˆå§‹ä¸ºå•ä¸ªçº¿ç¨‹ æ­¤æ—¶å…¶ä»–çº¿ç¨‹æ¥è¯·æ±‚è·å–é” åŠ é”æµç¨‹å›¾ å†æ¥çœ‹ä¸‹å…¬å¹³é”æ˜¯å¦‚ä½•ä½“ç°çš„ï¼Ÿstatic final class FairSync extends Sync &#123; private static final long serialVersionUID = -3000897897090466540L; final void lock() &#123; acquire(1); &#125; protected final boolean tryAcquire(int acquires) &#123; final Thread current = Thread.currentThread(); int c = getState(); if (c == 0) &#123; // åˆ¤æ–­æœ‰æ— èŠ‚ç‚¹æ’é˜Ÿ if (!hasQueuedPredecessors() &amp;&amp; compareAndSetState(0, acquires)) &#123; setExclusiveOwnerThread(current); return true; &#125; &#125; else if (current == getExclusiveOwnerThread()) &#123; int nextc = c + acquires; if (nextc &lt; 0) throw new Error(&quot;Maximum lock count exceeded&quot;); setState(nextc); return true; &#125; return false; &#125;&#125; æ‹‰å‡ºæ¥ä»£ç æ¯”è¾ƒä¸€ä¸‹ï¼š å¯ä»¥çœ‹å‡ºåœ¨å…¬å¹³é”ï¼ˆFairSyncï¼‰ä¸­å¤šäº†ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ !hasQueuedPredecessors() hasQueuedPredecessors æ–¹æ³•åœ¨ AQS ä¸­ï¼Œå¦‚æœæœ‰å½“å‰çº¿ç¨‹å‰é¢çš„çº¿ç¨‹æ’é˜Ÿè¿”å›trueï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ˜¯åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨æˆ–é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›falseã€‚ ä»£ç å¦‚ä¸‹ï¼š public final boolean hasQueuedPredecessors() &#123; Node t = tail; Node h = head; Node s; return h != t &amp;&amp; ((s = h.next) == null || s.thread != Thread.currentThread());&#125; å¦‚æœå½“å‰åŠ é”æ—¶å·²ç»æœ‰èŠ‚ç‚¹åœ¨æ’é˜Ÿï¼Œé‚£å°±å»èŠ‚ç‚¹å°¾éƒ¨æ’é˜Ÿï¼Œå¦åˆ™æ‰ä¼šå»æŠ¢å é”ã€‚ åˆ°è¿™é‡ŒåŸºæœ¬ä¸Šå·²ç»çŸ¥é“å…¬å¹³é”å’Œéå…¬å¹³é”çš„åŒºåˆ«äº†ï¼š éå…¬å¹³é”ï¼šä¸ç®¡æœ‰æ²¡æœ‰èŠ‚ç‚¹åœ¨æ’é˜Ÿï¼Œéƒ½ä¼šè¯•å›¾å»è·å–é”ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œè¿›å…¥ acquire æ–¹æ³•ï¼Œè¿˜æ˜¯ä¼šè¯•å›¾è·å–ä¸€æ¬¡ï¼Œä¹‹åæ‰ä¼šè¿›å…¥é˜Ÿåˆ—ä¸­ã€‚å…¬å¹³é”ï¼šå·²ç»æœ‰èŠ‚ç‚¹åœ¨æ’é˜Ÿï¼Œé‚£å°±è‡ªå·±å»èŠ‚ç‚¹åé¢æ’é˜Ÿã€‚ tryLockpublic boolean tryLock() &#123; return sync.nonfairTryAcquire(1);&#125; ç›´æ¥è°ƒç”¨çš„ Sync ä¸­çš„ nonfairTryAcquireï¼Œ å°è¯•è·å–é”ï¼Œè·å–å¤±è´¥ï¼Œå°±è¿”å› falseï¼Œè·å–åˆ°é”æˆ–è€…æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰é”åˆ™å¯¹ state ç´¯åŠ åéƒ½è¿”å› trueã€‚ unlockpublic void unlock() &#123; sync.release(1);&#125; å‘ç° unlock ç›´æ¥è°ƒç”¨çš„ AQS çš„ release æ–¹æ³•ï¼Œè¿›è¡Œé‡Šæ”¾èµ„æºã€‚ public final boolean release(int arg) &#123; if (tryRelease(arg)) &#123; Node h = head; if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); return true; &#125; return false;&#125; è¿™å—åœ¨ AQS ä¸­æœ‰ä»‹ç»ï¼Œä¹Ÿè¯´æ˜ tryRelease ç”±å­ç±»è¿›è¡Œå®ç°ï¼Œç°åœ¨åœ¨ ReentrantLock é‡ç‚¹å…³æ³¨ tryRelease çš„å®ç°ã€‚ // é‡Šæ”¾èµ„æºï¼Œä¼ å…¥å€¼ä¸º 1protected final boolean tryRelease(int releases) &#123; int c = getState() - releases; if (Thread.currentThread() != getExclusiveOwnerThread()) throw new IllegalMonitorStateException(); boolean free = false; if (c == 0) &#123; free = true; setExclusiveOwnerThread(null); &#125; setState(c); return free;&#125; è·å–å½“å‰çš„ state è¿›è¡Œ -1 æ“ä½œï¼› åˆ¤æ–­äº†ä¸‹å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºæŒæœ‰çº¿ç¨‹ï¼› å¦‚æœé‡Šæ”¾å®Œä¹‹å state ä¸º 0 ï¼Œåˆ™è®¾ç½®æŒæœ‰çº¿ç¨‹ä¸º nullï¼› æ›´æ–°å¹¶è¿”å› state çš„å€¼ã€‚ æ€»ç»“é€šè¿‡ä¸Šé¢çš„æºç åŠç”»å›¾ï¼ŒåŸºæœ¬ä¸Šå¯¹å¼€å§‹çš„é—®é¢˜å·²ç»æœ‰äº†ç­”æ¡ˆï¼š Qï¼šåœ¨ AQS ä¸­ä»‹ç» state æ—¶ï¼Œè¯´ state å«ä¹‰ç”±å­ç±»è¿›è¡Œå®šä¹‰ï¼Œé‚£åœ¨ ReentrantLock ä¸­ state ä»£è¡¨ä»€ä¹ˆï¼ŸAï¼šåœ¨ ReentrantLock ä¸­ state ä»£è¡¨åŠ é”çŠ¶æ€ï¼Œ0 æ²¡æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äºç­‰äº 1 å·²ç»æœ‰çº¿ç¨‹è·å¾—é”ï¼Œå¤§äº 1 è¯´æ˜è¯¥è·å¾—é”çš„çº¿ç¨‹å¤šæ¬¡é‡å…¥ã€‚ Qï¼šReentrantLock å’Œ AQS æœ‰ä»€ä¹ˆå…³ç³»ï¼ŸAï¼šReentrantLock å†…éƒ¨åŸºäº AQS å®ç°ï¼Œæ— è®ºæ˜¯é”çŠ¶æ€ï¼Œè¿˜æ˜¯è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œé”é‡Šæ”¾ç­‰éƒ½æ˜¯åŸºäº AQS å®ç°ã€‚ReentrantLock çš„å…¬å¹³é”å’Œéå…¬å¹³é”éƒ½æ˜¯ NonfairSyncã€FairSync æ¥å®ç°çš„ï¼Œè€Œä»–ä»¬çš„çˆ¶ç±» Sync ç»§æ‰¿äº† AQSã€‚ Qï¼šçº¿ç¨‹æ˜¯å¦‚ä½•è·å–åˆ°é”çš„ï¼ŸAï¼šçº¿ç¨‹é€šè¿‡ä¿®æ”¹ state å­—æ®µçš„çŠ¶æ€æ¥è·å–åˆ°é”ã€‚ Qï¼šé”çš„å¯é‡å…¥æ€§æ˜¯å¦‚ä½•å®ç°çš„ï¼ŸAï¼šå½“å‰çº¿ç¨‹å‘ç° state ä¸æ˜¯ 0 ï¼Œåˆ™è¯´æ˜æœ‰é”å·²ç»è¢«è·å–äº†ï¼Œæ­¤æ—¶ä¼šåˆ¤æ–­å½“å‰è·å–åˆ°é”çš„çº¿ç¨‹æ˜¯ä¸æ˜¯è‡ªå·±ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¯¹ state è¿›è¡Œç´¯åŠ ã€‚ Qï¼šå½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¢«é˜»å¡çš„åç»­æ“ä½œæ˜¯ä»€ä¹ˆï¼ŸAï¼šè·å–å¤±è´¥ï¼Œä¼šæ”¾åˆ° AQS ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåœ¨é˜Ÿåˆ—ä¸­ä¸æ–­å¾ªç¯ï¼Œç›‘è§†å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸º head ï¼Œæ˜¯çš„è¯ï¼Œä¼šé‡æ–°å°è¯•è·å–é”ã€‚ Qï¼šå…¬å¹³é”å’Œéå…¬å¹³é”æ˜¯å¦‚ä½•ä½“ç°çš„ï¼ŸAï¼šå…¬å¹³é”ä¸»è¦ä½“ç°åœ¨å¦‚æœå½“å‰é˜Ÿåˆ—ä¸­å·²ç»æœ‰æ’é˜Ÿçš„çº¿ç¨‹äº†ï¼Œåˆ™è‡ªå·±ç›´æ¥æ’åœ¨åé¢ã€‚éå…¬å¹³é”æ˜¯ä¸ç®¡å½“å‰é˜Ÿåˆ—éƒ½æ²¡æœ‰çº¿ç¨‹æ’é˜Ÿï¼Œéƒ½ä¼šç›´æ¥å°è¯•ä¿®æ”¹ state è·å–é”ã€‚ Qï¼šé”æ˜¯å¦‚ä½•é‡Šæ”¾çš„ï¼ŸAï¼šé”é‡Šæ”¾èµ„æºï¼Œå³å°† state è¿›è¡Œ -1 æ“ä½œï¼Œå¦‚æœ -1 å state ä¸º 0ï¼Œåˆ™é‡Šæ”¾èŠ‚ç‚¹ï¼Œåç»­èŠ‚ç‚¹å°è¯•è·å–é”ã€‚æ­¤å¤„å¯ä»¥çœ‹ AQS ç›¸å…³é€»è¾‘ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€å·¥ä½œç¬”è®°ã€‘- è€å¤§è¯´æ–°é¡¹ç›®çš„ç»“æ„å’Œ xxx é¡¹ç›®ä¸€æ ·å°±å¯ä»¥äº†ï¼Œæˆ‘ â€¦â€¦","slug":"work/archetype","date":"2020-07-18T05:00:00.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/07/18/work-archetype.html","link":"","permalink":"https://liuzhihang.com/2020/07/18/work-archetype.html","excerpt":"","text":"åˆè¦å¼€å‘æ–°é¡¹ç›®äº†ï¼Œè¿˜æ˜¯åˆ›å»ºæ–°é¡¹ç›®ï¼Œæ€ä¹ˆåŠï¼Ÿè€å¤§è¯´æŒ‰ç…§ xxx é¡¹ç›®çš„ç»“æ„åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®å°±å¯ä»¥äº†ã€‚ åœ¨å·¥ä½œä¸­ç»å¸¸æœ‰æ–°é¡¹ç›®éœ€è¦åˆ›å»ºï¼Œæ­¤æ—¶å°±ä¼šæœ‰ä¸‰ç§å¸¸ç”¨çš„æ–¹å¼ CC å¤§æ³• æ–°å»ºé¡¹ç›®ï¼Œç„¶åæ‰¾åˆ°ä¹‹å‰çš„å„ç§å·¥å…·ç±»ï¼Œå¤åˆ¶ç²˜è´´è¿›æ¥ï¼Œæ­¤æ—¶è¿˜ä¸ä¸€å®šèƒ½è·‘èµ·æ¥ï¼Œç„¶åå†è¿›è¡Œå„ç§è°ƒè¯•ã€‚ CD å¤§æ³• å¤åˆ¶è€é¡¹ç›®ï¼Œç„¶åæ”¹ module åå­—ï¼Œä¾èµ–åå­—ï¼Œåˆ é™¤è€ä»£ç ï¼Œå½“ç„¶ä¹Ÿä¸ä¸€å®šèƒ½è·‘èµ·æ¥ï¼Œæ­¤æ—¶å†è¿›è¡Œå„ç§è°ƒè¯•ã€‚ å½“ç„¶ï¼Œè¿™é‡Œè‚¯å®šä¸æ˜¯ä½¿ç”¨è¿™ä¸¤ç§åŠæ³•ï¼Œä¸‹é¢å’±ä»¬ä»‹ç»ä¸€ç§æ›´ç®€æ´çš„æ–¹å¼ï¼Œä½¿ç”¨ maven archetype ç”Ÿæˆé¡¹ç›®æ¨¡ç‰ˆï¼Œä¸€é”®åˆ›å»ºé¡¹ç›®ã€‚ Actionï¼ï¼ï¼ ä»€ä¹ˆæ˜¯ Archetype ï¼Ÿç®€è€Œè¨€ä¹‹ï¼ŒArchetype æ˜¯ Maven é¡¹ç›®æ¨¡æ¿å·¥å…·ç®±ã€‚ An archetype is defined as an original pattern or model from which all other things of the same kind are made. åŸå‹è¢«å®šä¹‰ä¸ºåŸå§‹æ ·å¼æˆ–æ¨¡å‹ï¼Œä»ä¸­å¯ä»¥åˆ¶æˆæ‰€æœ‰å…¶ä»–åŒç±»é¡¹ç›®ã€‚ å®˜æ–¹è§£é‡Šï¼Œç®€æ´æ˜äº†ï¼Œå°±æ˜¯ä½¿ç”¨å·²æœ‰çš„é¡¹ç›®ï¼Œç”Ÿæˆä¸€ä¸ªæ¨¡ç‰ˆã€‚ä»¥åä½¿ç”¨è¿™ä¸ªæ¨¡ç‰ˆå°±å¯ä»¥å¿«é€Ÿç”Ÿæˆç»“æ„ç›¸åŒçš„é¡¹ç›®äº†ã€‚åœ¨å›¢é˜Ÿå¼€å‘ä¸­å¾ˆæœ‰ç”¨ã€‚ å…¶å®å°±æ˜¯å®˜æ–¹è§£é‡Šï¼Œåœ°å€è´´ä¸Šæ¥ï¼šhttp://maven.apache.org/archetype/maven-archetype-plugin/index.html ä¸‹é¢ä½¿ç”¨ IDEA ä½œä¸ºæ¼”ç¤ºå·¥å…·ï¼Œä¸€æ­¥ä¸€æ­¥å¼€å§‹ä»‹ç»ã€‚ å‡†å¤‡æ¨¡ç‰ˆé¡¹ç›®è¿™é‡Œè¿˜æ˜¯è¦æœ‰ä¸€ä¸ªæ¨¡ç‰ˆé¡¹ç›®ï¼Œæ¯”å¦‚è¿™æ ·ï¼š è¿™æ˜¯ä¸€ä¸ªå¤š module é¡¹ç›®ï¼Œä¸€ä¸ªç®€å•çš„ demo ä½¿ç”¨äº† nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼› fegin ä½œä¸ºè°ƒç”¨å·¥å…·ï¼› æœ‰é€šç”¨æ ¡éªŒ token å·¥å…·ç±»ï¼› å‡è®¾é‡Œé¢ä¹Ÿæœ‰ä¸€äº›å…¬å¸çš„å…¬å…±é…ç½®ï¼ˆMQï¼Œé“¾è·¯ç›‘æ§ï¼Œç»Ÿä¸€æ—¥å¿—ç­‰ï¼‰ã€‚ å½“ç„¶è¿™ä¸ªé¡¹ç›®æ˜¯å¯ä»¥è·‘èµ·æ¥çš„ã€‚æ–°åˆ›å»ºçš„é¡¹ç›®ä¹Ÿæ˜¯è¿™ä¸ªæ¨¡ç‰ˆã€‚ è¿›å…¥ä¸»é¢˜ä½¿ç”¨å‘½ä»¤**archetype:generate ** è¿™æ ·æ˜¯åŸºäºå½“å‰é¡¹ç›®ç”Ÿæˆï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å®˜ç½‘çš„ç”¨æ³•åˆ†åˆ«æŒ‡å®šå‚æ•° mvn archetype:generate ç„¶åä¸€æ­¥ä¸€æ­¥æŒ‰ç…§æç¤ºè¾“å…¥ï¼› ä¸€æ¬¡æ€§è¾“å…¥ï¼Œå…¶ä¸­ DarchetypeGroupId ã€DarchetypeArtifactId ã€DarchetypeVersion ä¸ºç”Ÿæˆçš„ Archetype é¡¹ç›®çš„ç»„ç»‡ç‰ˆæœ¬ã€‚ mvn archetype:generate \\ -DarchetypeGroupId=&lt;archetype-groupId&gt; \\ -DarchetypeArtifactId=&lt;archetype-artifactId&gt; \\ -DarchetypeVersion=&lt;archetype-version&gt; \\ -DgroupId=&lt;my.groupid&gt; \\ -DartifactId=&lt;my-artifactId&gt; é«˜çº§ç”¨æ³• mvn clean archetype:create-from-project æ‰§è¡Œå›¾ç¤ºå¦‚ä¸‹ï¼š æ‰§è¡Œåè¿”å› IDEA æŸ¥çœ‹é¡¹ç›®ï¼Œåœ¨ target/generated-sources ç›®å½•ä¸‹çš„ archetype å³ç”Ÿæˆçš„é¡¹ç›®æ¨¡ç‰ˆã€‚ ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š main/resources/archetype-resourcesï¼šé¡¹ç›®çš„æ¨¡ç‰ˆï¼Œç”Ÿæˆæ–°é¡¹ç›®ï¼Œå°±æ˜¯æ ¹æ®è¿™å—çš„ä»£ç è¿›è¡Œç”Ÿæˆçš„ã€‚ .idea æ— ç”¨ï¼Œåˆ é™¤æ‰ã€‚ __rootArtifactId__xxx é¡¹ç›®çš„å„ä¸ª module main/resources/META-INF/maven/archetype-metadata.xmlï¼šæ¨¡ç‰ˆå·¥ç¨‹çš„å…ƒæ•°æ®é…ç½®ã€‚ å¯ä»¥æŠŠ archetype æ‹·å‡ºå»ï¼Œè¿™æ˜¯ä¸€ä¸ªå•ç‹¬çš„å·¥ç¨‹æ¨¡ç‰ˆï¼Œæ‹·å‡ºå»ä¹‹åï¼Œä½¿ç”¨ IDEA æ‰“å¼€ã€‚ ä¸‹é¢å¼€å§‹ä»‹ç» archetype é‡Œé¢éƒ½æœ‰ä»€ä¹ˆã€‚ archetype æ¨¡ç‰ˆé¡¹ç›®ä»‹ç»ä½¿ç”¨ IDEA æ‰“å¼€ä¹‹åå‘ç°ï¼Œè¿˜æ˜¯ä¸€ä¸ª Maven é¡¹ç›®ã€‚ archetype-resources æ‰“å¼€ pom æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢ $&#123;groupId&#125; ã€ $&#123;artifactId&#125; ã€$&#123;version&#125; ä½¿ç”¨å ä½ç¬¦æŒ‡å®šçš„ç»„ç»‡ç‰ˆæœ¬ï¼Œè¿™äº›å°±æ˜¯æ–°åˆ›å»ºé¡¹ç›®æ—¶æŒ‡å®šçš„ã€‚ archetype-metadata.xmlarchetype-metadata.xml é‡Œé¢ä¸ºå…ƒæ•°æ®é…ç½®ã€‚ fileSetï¼šç”¨æ¥ç”Ÿæˆä¸€äº›é¡¹ç›®ä¸­çš„æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶æˆ–ç›®å½•åç§°åŒ…å« __property__ æ¨¡å¼ï¼Œåˆ™å°†å…¶æ›¿æ¢ä¸ºç›¸åº”çš„å±æ€§å€¼ã€‚ å±æ€§ ç±»å‹ æè¿° filtered boolean è¿‡æ»¤æ–‡é›†ï¼Œå°†æŒ‡å®šæ–‡ä»¶ç›´æ¥å¤åˆ¶ä¸éœ€è¦ä¿®æ”¹ã€‚é»˜è®¤å€¼ä¸ºï¼šfalseã€‚ packaged boolean æ‰“åŒ…æ–‡ä»¶ï¼ŒæŒ‡å®šæ–‡ä»¶å°†åœ¨packageå±æ€§ä¹‹å‰çš„ç›®å½•ç»“æ„ä¸­ç”Ÿæˆ/å¤åˆ¶ã€‚å®ƒä»¬å¯ä»¥æ˜¯éæ‰“åŒ…çš„ï¼Œè¿™æ„å‘³ç€æ‰€é€‰æ–‡ä»¶å°†åœ¨æ²¡æœ‰è¯¥å‰ç¼€çš„æƒ…å†µä¸‹ç”Ÿæˆ/å¤åˆ¶ã€‚é»˜è®¤å€¼ä¸ºï¼šfalseã€‚ encoding String è¿‡æ»¤å†…å®¹æ—¶ä½¿ç”¨çš„ç¼–ç ã€‚ fileSet åŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š å…ƒç´  ç±»å‹ æè¿° directory String ç”Ÿæˆé¡¹ç›®æ–‡ä»¶çš„ç›®å½• includes/include* List åŒ…å«æ–‡ä»¶ excludes/exclude* List æ’é™¤æ–‡ä»¶ å› ä¸ºç”Ÿæˆé¡¹ç›®ä¸éœ€è¦ .idea *.iml æ–‡ä»¶ï¼Œæ‰€ä»¥ç›´æ¥åˆ é™¤ï¼š module å°±æ˜¯è¦ç”Ÿæˆçš„é¡¹ç›®ä¸€å…±å‡ ä¸ª module å±æ€§ ç±»å‹ æè¿° id String The moduleâ€™s artifactId. dir String The moduleâ€™s directory. name String The moduleâ€™s name. å…ƒç´  ç±»å‹ æè¿° fileSets/fileSet* List æ–‡ä»¶ modules/module* List æ¨¡å— å¯ä»¥çœ‹å‡ºé‡Œé¢å°±æ˜¯è‡ªå·±çš„é¡¹ç›®æ¨¡ç‰ˆã€‚ __rootArtifactId__-controller åœ¨ç”Ÿæˆçš„æ—¶å€™ï¼Œå°±ä¼šæ ¹æ®ä¼ å…¥çš„ artifactId ç”ŸæˆæŒ‡å®šçš„ module åå­—ã€‚ ä½¿ç”¨ clean install IDEA Add Archetype é€‰æ‹©ä½¿ç”¨ Archetype ç”Ÿæˆæ–°é¡¹ç›® å¡«å†™æ–°ç”Ÿæˆé¡¹ç›®çš„åå­—ç­‰ ç”Ÿæˆæ–°é¡¹ç›® æ‰©å±•Q: å¦‚ä½•è‡ªå®šä¹‰åŒ…è·¯å¾„ï¼Ÿ A: å¯ä»¥ä½¿ç”¨ requiredProperties è‡ªå®šä¹‰å‚æ•°ã€‚é€šè¿‡ä¼ å…¥è‡ªå®šä¹‰çš„å‚æ•°ï¼Œæ¥ç”Ÿæˆè‡ªå®šçš„åŒ…è·¯å¾„ã€‚ æ¯”å¦‚å‘ç°æ–°ç”Ÿæˆé¡¹ç›®çš„åŒ…è·¯å¾„éƒ½æ˜¯ com.liuzhihang.archetypeï¼Œè¿™æ ·è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œæ¯ä¸ªé¡¹ç›®æœ‰æ¯ä¸ªé¡¹ç›®è‡ªå·±çš„åŒ…è·¯å¾„ã€‚åªéœ€è¦åšä»¥ä¸‹ä¿®æ”¹ï¼š å°† requiredProperties æ·»åŠ åˆ°é¡¹ç›®ä¸­ï¼Œç„¶åæ·»åŠ æ–°å˜é‡ middlePackageã€‚ &lt;requiredProperties&gt; &lt;!--ä½¿ç”¨archetypeæ—¶å€™å¿…é¡»è¦æ±‚è¾“å…¥çš„å‚æ•°--&gt; &lt;requiredProperty key=&quot;groupId&quot;&gt; &lt;!--å¯ä»¥è®¾ç½®é»˜è®¤å€¼ï¼Œä½¿ç”¨archetypeä¼šä½¿ç”¨é»˜è®¤å€¼--&gt; &lt;defaultValue&gt;com.liuzhihang&lt;/defaultValue&gt; &lt;/requiredProperty&gt; &lt;requiredProperty key=&quot;package&quot;&gt; &lt;defaultValue&gt;com.liuzhihang&lt;/defaultValue&gt; &lt;/requiredProperty&gt; &lt;requiredProperty key=&quot;middlePackage&quot;&gt; &lt;defaultValue&gt;$&#123;rootArtifactId&#125;&lt;/defaultValue&gt; &lt;/requiredProperty&gt;&lt;/requiredProperties&gt; ä¿®æ”¹æ¨¡ç‰ˆçš„æ–‡ä»¶å å¦‚æœæ–‡ä»¶æˆ–ç›®å½•åç§°åŒ…å« __property__ æ¨¡å¼ï¼Œåˆ™å°†å…¶æ›¿æ¢ä¸ºç›¸åº”çš„å±æ€§å€¼ã€‚åˆ°è¿™é‡Œè¿˜ä¸è¡Œï¼Œå› ä¸ºç”Ÿæˆçš„åŒ…åè¿˜æ²¡æ”¹ã€‚ ä¿®æ”¹å†…éƒ¨æ–‡ä»¶çš„åŒ…è·¯å¾„ã€‚åŒ…æ‹¬ .java ã€** .xml** ã€** .properties** ç­‰ã€‚ é‡æ–° clean install æ³¨ï¼šæ­¤æ—¶å¯èƒ½ä¼šæŠ¥é”™ï¼Œéœ€è¦åœ¨ src/test/resources/projects/basic/archetype.properties ä¸‹æ·»åŠ  middlePackage=basic å†é‡æ–°å°è¯•ä¸‹ã€‚ åœ¨ç”Ÿæˆæ—¶æ³¨æ„æŒ‡å®š middlePackage å±æ€§ã€‚ Q: æˆ‘æƒ³è‡ªå®šä¹‰ Application çš„åå­—æ€ä¹ˆå¼„ï¼Ÿ A: åŒæ ·ä½¿ç”¨ requiredProperties è‡ªå®šä¹‰å‚æ•°ã€‚ &lt;requiredProperty key=&quot;appName&quot;&gt;&lt;/requiredProperty&gt; å½“ç„¶ä¹Ÿå¯ä»¥èµ·ä¸€ä¸ªé€šç”¨çš„åå­—ã€‚ Q: åˆ«çš„å°ä¼™ä¼´æ€ä¹ˆç”¨ï¼Ÿ A: å½“ç„¶æ˜¯ deploy åˆ°ç§æœäº†ï¼Œ åœ¨ pom é‡Œé¢æ·»åŠ å¦‚ä¸‹é…ç½®ï¼ŒæŒ‡å®šè‡ªå·±å…¬å¸çš„ç§æœã€‚deploy ï¼Œè¿™æ ·å°±å¯ä»¥å’Œå°ä¼™ä¼´ä¸€èµ·æ„‰å¿«çš„ä½¿ç”¨å•¦ã€‚ &lt;!-- è¿œç¨‹ä»“åº“ --&gt;&lt;distributionManagement&gt; &lt;repository&gt; &lt;id&gt;releases&lt;/id&gt; &lt;name&gt;Nexus Release Repository&lt;/name&gt; &lt;url&gt;http://liuzhihang.com:xxxx/repository/maven-releases/&lt;/url&gt; &lt;/repository&gt; &lt;snapshotRepository&gt; &lt;id&gt;snapshots&lt;/id&gt; &lt;name&gt;Nexus Snapshot Repository&lt;/name&gt; &lt;url&gt;http://liuzhihang.com:xxxx/repository/maven-snapshots/&lt;/url&gt; &lt;/snapshotRepository&gt;&lt;/distributionManagement&gt; Q: æˆ‘è¦æ€ä¹ˆä» IDEA åˆ é™¤ Archetype â€‹ï¼Ÿ A: è¿™ä¹ˆå¥½ç”¨æ€ä¹ˆèˆå¾—åˆ é™¤â€‹å‘¢ï¼Ÿåªè¦æ‰¾åˆ°ä»¥ä¸‹è·¯å¾„ liuzhihang % &gt; pwd/Users/liuzhihang/Library/Caches/JetBrains/IntelliJIdea2020.1/Maven/Indices é‡Œé¢æœ‰ä¸€ä¸ª UserArchetypes.xmlâ€‹ï¼Œ æ‰“å¼€ï¼Œåˆ é™¤æ‰é‡Œé¢çš„ archetype å°±è¡Œã€‚ è¡¥å……Maven Archetype æ–‡æ¡£ï¼šhttp://maven.apache.org/archetype/maven-archetype-plugin/index.html ä»£ç åœ°å€ï¼šhttps://github.com/liuzhihang/archetype-demo","categories":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"Archetype","slug":"å·¥ä½œç¬”è®°/Archetype","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/Archetype/"}],"tags":[{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"Archetype","slug":"Archetype","permalink":"https://liuzhihang.com/tags/Archetype/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- åˆ«èµ°ï¼è¿™é‡Œæœ‰ä¸ªç¬”è®°ï¼šå›¾æ–‡è®²è§£ AQS ï¼Œä¸€èµ·çœ‹çœ‹ AQS çš„æºç â€¦â€¦(å›¾æ–‡è¾ƒé•¿)","slug":"source-code/java/AQS","date":"2020-07-12T05:00:00.000Z","updated":"2020-12-27T09:23:14.251Z","comments":true,"path":"2020/07/12/source-code-aqs.html","link":"","permalink":"https://liuzhihang.com/2020/07/12/source-code-aqs.html","excerpt":"","text":"AbstractQueuedSynchronizer æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œç®€ç§° AQS ã€‚æ˜¯åœ¨ JUC åŒ…ä¸‹é¢ä¸€ä¸ªéå¸¸é‡è¦çš„åŸºç¡€ç»„ä»¶ï¼ŒJUC åŒ…ä¸‹é¢çš„å¹¶å‘é” ReentrantLock CountDownLatch ç­‰éƒ½æ˜¯åŸºäº AQS å®ç°çš„ã€‚æ‰€ä»¥æƒ³è¿›ä¸€æ­¥ç ”ç©¶é”çš„åº•å±‚åŸç†ï¼Œéå¸¸æœ‰å¿…è¦å…ˆäº†è§£ AQS çš„åŸç†ã€‚ ä»‹ç»å…ˆçœ‹ä¸‹ AQS çš„ç±»å›¾ç»“æ„ï¼Œä»¥åŠæºç æ³¨é‡Šï¼Œæœ‰ä¸€å®šçš„å¤§æ¦‚äº†è§£ä¹‹åå†ä»æºç å…¥æ‰‹ï¼Œä¸€æ­¥ä¸€æ­¥ç ”ç©¶å®ƒçš„åº•å±‚åŸç†ã€‚ â€œ æºç æ³¨é‡Š æä¾›äº†å®ç°é˜»å¡é”å’Œç›¸å…³åŒæ­¥å™¨ä¾é å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰ç­‰å¾…é˜Ÿåˆ—ï¼ˆä¿¡å·é‡ï¼Œäº‹ä»¶ç­‰ï¼‰çš„æ¡†æ¶ã€‚ æ­¤ç±»ä¸­è®¾è®¡äº†ä¸€ä¸ªå¯¹å¤§å¤šæ•°åŸºäº AQS çš„åŒæ­¥å™¨æœ‰ç”¨çš„åŸå­å˜é‡æ¥è¡¨ç¤ºçŠ¶æ€ï¼ˆstateï¼‰ã€‚ å­ç±»å¿…é¡»å®šä¹‰ protected æ–¹æ³•æ¥ä¿®æ”¹è¿™ä¸ª stateï¼Œå¹¶ä¸”å®šä¹‰ state å€¼åœ¨å¯¹è±¡ä¸­çš„å…·ä½“å«ä¹‰æ˜¯ acquired æˆ– releasedã€‚ è€ƒè™‘åˆ°è¿™äº›ï¼Œåœ¨è¿™ä¸ªç±»ä¸­çš„å…¶ä»–æ–¹æ³•å¯ä»¥å®ç°æ‰€æœ‰æ’é˜Ÿå’Œé˜»å¡æœºåˆ¶ã€‚ å­ç±»å¯ä»¥ä¿æŒå…¶ä»–çŠ¶æ€å­—æ®µï¼Œä½†åªèƒ½ä½¿ç”¨æ–¹æ³• getState ã€setState å’Œ compareAndSetState ä»¥åŸå­æ–¹å¼æ›´æ–° state ã€‚ å­ç±»åº”è¢«å®šä¹‰ä¸ºç”¨äºå®ç°å…¶å°é—­ç±»çš„åŒæ­¥æ€§èƒ½çš„éå…¬å…±å†…éƒ¨è¾…åŠ©ç±»ã€‚ ç±»AbstractQueuedSynchronizeræ²¡æœ‰å®ç°ä»»ä½•åŒæ­¥æ¥å£ã€‚ ç›¸åï¼Œå®ƒå®šä¹‰äº†ä¸€äº›æ–¹æ³•ï¼Œå¦‚ acquireInterruptibly å¯ä»¥é€šè¿‡å…·ä½“çš„é”å’Œç›¸å…³åŒæ­¥å™¨æ¥è°ƒç”¨é€‚å½“å±¥è¡Œå…¶å…¬å…±æ–¹æ³•ã€‚ æ­¤ç±»æ”¯æŒç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ã€‚ åœ¨ç‹¬å æ¨¡å¼ä¸‹ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½è·å–æˆåŠŸï¼Œå…±äº«æ¨¡å¼ä¸‹å¯ä»¥ï¼ˆä½†ä¸ä¸€å®šï¼‰è·å–æˆåŠŸã€‚ æ­¤ç±»ä¸â€œç†è§£â€ï¼Œåœ¨æœºæ¢°æ„ä¹‰ä¸Šè¿™äº›ä¸åŒçš„æ˜¯ï¼Œå½“å…±äº«æ¨¡å¼è·å–æˆåŠŸï¼Œåˆ™ä¸‹ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ä¹Ÿå¿…é¡»ç¡®å®šå®ƒæ˜¯å¦èƒ½å¤Ÿè·å–ã€‚ çº¿ç¨‹åœ¨ä¸åŒæ¨¡å¼ä¸‹çš„ç­‰å¾…å…±äº«ç›¸åŒçš„FIFOé˜Ÿåˆ—ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ç°å­ç±»åªæ”¯æŒå…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œä½†åŒæ—¶ä½¿ç”¨ä¸¤ç§æ¨¡å¼ä¹Ÿå¯ä»¥ï¼Œä¾‹å¦‚ReadWriteLock ã€‚ ä»…å…±äº«æ¨¡å¼ä¸éœ€è¦å®šä¹‰æ”¯æŒæœªä½¿ç”¨çš„æ¨¡å¼çš„æ–¹æ³•çš„å­ç±»ã€‚ è¿™ä¸ªç±»ä¸­å®šä¹‰äº†åµŒå¥—ç±» AbstractQueuedSynchronizer.ConditionObject ï¼Œå¯ç”¨äºä½œä¸ºä¸€ä¸ª Condition ç”±å­ç±»å®ç°ï¼Œå¹¶ä½¿ç”¨ isHeldExclusively æ–¹æ³•è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯å¦ä»¥ç‹¬å æ–¹å¼è¿›è¡Œï¼Œrelease()ã€ getState() acquire() æ–¹æ³•ç”¨äºæ“ä½œ state åŸå­å˜é‡ã€‚ æ­¤ç±»æä¾›æ£€æŸ¥å’Œç›‘è§†å†…éƒ¨é˜Ÿåˆ—çš„æ–¹æ³•ï¼Œä»¥åŠç±»ä¼¼æ–¹æ³•çš„æ¡ä»¶å¯¹è±¡ã€‚ æ ¹æ®éœ€è¦è¿›ä½¿ç”¨ä»¥ç”¨äºå®ƒä»¬çš„åŒæ­¥æœºåˆ¶ã€‚ è¦ä½¿ç”¨è¿™ä¸ªç±»ç”¨ä½œåŒæ­¥çš„åŸºç¡€ä¸Šï¼Œéœ€è¦é‡æ–°å®šä¹‰ä»¥ä¸‹æ–¹æ³•ï¼Œå¦‚ä½¿ç”¨ï¼Œé€šè¿‡æ£€æŸ¥å’Œæˆ–ä¿®æ”¹ getState ã€setState æˆ– compareAndSetState æ–¹æ³•ï¼š tryAcquiretryReleasetryAcquireSharedtryReleaseSharedisHeldExclusively â€œ é€šè¿‡ä¸Šé¢çš„æ³¨é‡Šå¯ä»¥å¾—å‡ºå¤§æ¦‚çš„å°è±¡ï¼š å†…éƒ¨ä¾é å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰ ç­‰å¾…é˜Ÿåˆ—ã€‚ å­˜åœ¨ state è¡¨ç¤ºçŠ¶æ€ä¿¡æ¯ã€‚state å€¼åªèƒ½ç”¨ getState ã€setState å’Œ compareAndSetState æ–¹æ³•ä»¥åŸå­æ–¹å¼æ›´æ–°ã€‚ æ”¯æŒç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼Œä½†å…·ä½“éœ€è¦å­ç±»å®ç°å…·ä½“æ”¯æŒå“ªç§æ¨¡å¼ã€‚ åµŒå¥— AbstractQueuedSynchronizer.ConditionObject å¯ä»¥ä½œä¸º Condition ç”±å­ç±»å®ç°ã€‚ å­ç±»éœ€è¦é‡æ–°å®šä¹‰ tryAcquireã€tryReleaseã€tryAcquireSharedã€tryReleaseSharedã€isHeldExclusively æ–¹æ³•ã€‚ é˜Ÿåˆ—èŠ‚ç‚¹ Node NodeèŠ‚ç‚¹ï¼ŒåŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š å…ƒç´  å«ä¹‰ prev ä¸Šä¸€ä¸ªèŠ‚ç‚¹ next ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ thread æŒæœ‰çº¿ç¨‹ waitStatus èŠ‚ç‚¹çŠ¶æ€ nextWaiter ä¸‹ä¸€ä¸ªå¤„äº CONDITION çŠ¶æ€çš„èŠ‚ç‚¹ ç»„åˆæˆç­‰å¾…é˜Ÿåˆ—åˆ™å¦‚ä¸‹ï¼š ä¸‹é¢æ˜¯ç­‰å¾…é˜Ÿåˆ—èŠ‚ç‚¹çš„ Node å±æ€§ï¼š static final class Node &#123; // èŠ‚ç‚¹æ­£åœ¨å…±äº«æ¨¡å¼ä¸‹ç­‰å¾…çš„æ ‡è®° static final Node SHARED = new Node(); // æŒ‡ç¤ºèŠ‚ç‚¹æ­£åœ¨ä»¥ç‹¬å æ¨¡å¼ç­‰å¾…çš„æ ‡è®° static final Node EXCLUSIVE = null; // æŒ‡ç¤ºçº¿ç¨‹å·²å–æ¶ˆ static final int CANCELLED = 1; // æŒ‡ç¤ºåç»­çº¿ç¨‹éœ€è¦å”¤é†’ static final int SIGNAL = -1; // æŒ‡ç¤ºçº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¡ä»¶ static final int CONDITION = -2; // æŒ‡ç¤ºä¸‹ä¸€æ¬¡acquireSharedåº”è¯¥æ— æ¡ä»¶ä¼ æ’­ static final int PROPAGATE = -3; /** * çŠ¶æ€å­—æ®µï¼Œä»…ä½¿ç”¨ä»¥ä¸‹å€¼ * SIGNAL -1 ï¼šå½“å‰èŠ‚ç‚¹é‡Šæ”¾æˆ–è€…å–æ¶ˆæ—¶ï¼Œå¿…é¡» unpark ä»–çš„åç»­èŠ‚ç‚¹ã€‚ * CANCELLED 1 ï¼šç”±äºè¶…æ—¶ï¼ˆtimeoutï¼‰æˆ–ä¸­æ–­ï¼ˆinterruptï¼‰ï¼Œè¯¥èŠ‚ç‚¹è¢«å–æ¶ˆã€‚èŠ‚ç‚¹æ°¸è¿œä¸ä¼šç¦»å¼€æ­¤çŠ¶æ€ã€‚ç‰¹åˆ«æ˜¯ï¼Œå…·æœ‰å–æ¶ˆèŠ‚ç‚¹çš„çº¿ç¨‹æ°¸è¿œä¸ä¼šå†æ¬¡é˜»å¡ã€‚ * CONDITION -2 ï¼šè¯¥èŠ‚ç‚¹ç›®å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ã€‚ ä½†å®ƒä¸ä¼šè¢«ç”¨ä½œåŒæ­¥é˜Ÿåˆ—èŠ‚ç‚¹ï¼Œç›´åˆ°è½¬ç§»ï¼Œè½¬ç§»æ—¶çš„çŠ¶æ€å°†è¢«è®¾ç½®ä¸º 0 ã€‚ * PROPAGATE -3 ï¼šreleaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ * 0ï¼šéƒ½ä¸æ˜¯ * å€¼ä»¥æ•°å­—è¡¨ç¤ºä»¥ç®€åŒ–ä½¿ç”¨ï¼Œå¤§å¤šæ•°æ—¶å€™å¯ä»¥æ£€æŸ¥ç¬¦å·ï¼ˆæ˜¯å¦å¤§äº0ï¼‰ä»¥ç®€åŒ–ä½¿ç”¨ */ volatile int waitStatus; // ä¸Šä¸€ä¸ªèŠ‚ç‚¹ volatile Node prev; // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ volatile Node next; // èŠ‚ç‚¹æŒæœ‰çº¿ç¨‹ volatile Thread thread; // é“¾æ¥ä¸‹ä¸€ä¸ªç­‰å¾…æ¡ä»¶èŠ‚ç‚¹ï¼Œæˆ–ç‰¹æ®Šå€¼å…±äº« Node nextWaiter; // èŠ‚ç‚¹æ˜¯å¦å¤„äº å…±äº«çŠ¶æ€ æ˜¯ï¼Œ è¿”å› true final boolean isShared() &#123; return nextWaiter == SHARED; &#125; // è¿”å›å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ ä½¿ç”¨æ—¶ å‰ä¸€ä¸ªèŠ‚ç‚¹ä¸èƒ½ä¸ºç©º final Node predecessor() throws NullPointerException &#123; Node p = prev; if (p == null) throw new NullPointerException(); else return p; &#125; Node() &#123; // Used to establish initial head or SHARED marker &#125; Node(Thread thread, Node mode) &#123; // Used by addWaiter this.nextWaiter = mode; this.thread = thread; &#125; Node(Thread thread, int waitStatus) &#123; // Used by Condition this.waitStatus = waitStatus; this.thread = thread; &#125;&#125; åœ¨ Node èŠ‚ç‚¹ä¸­éœ€è¦é‡ç‚¹å…³æ³¨ waitStatus é»˜è®¤çŠ¶æ€ä¸º 0ï¼› waitStatus &gt; 0 (CANCELLED 1) è¯´æ˜è¯¥èŠ‚ç‚¹è¶…æ—¶æˆ–è€…ä¸­æ–­äº†ï¼Œéœ€è¦ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼› waitStatus = -1 SIGNAL å½“å‰çº¿ç¨‹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNALï¼Œåˆ™å½“å‰çº¿ç¨‹éœ€è¦é˜»å¡ï¼ˆunparkï¼‰ï¼› waitStatus = -2 CONDITION -2 ï¼šè¯¥èŠ‚ç‚¹ç›®å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ï¼› waitStatus = -3 PROPAGATE -3 ï¼šreleaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œåœ¨å…±äº«é”æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚ äº†è§£å®Œ Node çš„ç»“æ„ä¹‹åï¼Œå†äº†è§£ä¸‹ AQS ç»“æ„ï¼Œå¹¶ä»å¸¸ç”¨æ–¹æ³•å…¥æ‰‹ï¼Œé€æ­¥äº†è§£å…·ä½“å®ç°é€»è¾‘ã€‚ AbstractQueuedSynchronizerpublic abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer implements java.io.Serializable &#123; // ç­‰å¾…é˜Ÿåˆ—çš„å¤´ï¼Œå»¶è¿Ÿåˆå§‹åŒ–ã€‚ é™¤äº†åˆå§‹åŒ–ï¼Œå®ƒæ˜¯ä»…ç»ç”±æ–¹æ³•setHeadä¿®æ”¹ã€‚ æ³¨æ„ï¼šå¦‚æœå¤´å­˜åœ¨ï¼Œå…¶waitStatusä¿è¯ä¸ä¼šæ˜¯ CANCELLED çŠ¶æ€ private transient volatile Node head; // ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå»¶è¿Ÿåˆå§‹åŒ–ã€‚ ä»…åœ¨ä¿®æ”¹é€šè¿‡æ–¹æ³•ENQæ·»åŠ æ–°èŠ‚ç‚¹ç­‰å¾…ã€‚ private transient volatile Node tail; // åŒæ­¥çŠ¶æ€ private volatile int state; // è·å–çŠ¶æ€ protected final int getState() &#123; return state; &#125; // è®¾ç½®çŠ¶æ€å€¼ protected final void setState(int newState) &#123; state = newState; &#125; // åŸå­æ›´æ–°çŠ¶æ€å€¼ protected final boolean compareAndSetState(int expect, int update) &#123; // See below for intrinsics setup to support this return unsafe.compareAndSwapInt(this, stateOffset, expect, update); &#125;&#125; åœ¨ AQS ä¸­ä¸»è¦å‚æ•°ä¸ºï¼š å‚æ•° å«ä¹‰ head ç­‰å¾…é˜Ÿåˆ—å¤´ tail ç­‰å¾…é˜Ÿåˆ—å°¾ state åŒæ­¥çŠ¶æ€ é€šè¿‡æ³¨é‡Šäº†è§£åˆ°ï¼Œåœ¨ AQS é‡Œä¸»è¦åˆ†ä¸ºä¸¤ç§æ“ä½œæ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯ï¼šç‹¬å æ¨¡å¼ã€å…±äº«æ¨¡å¼ï¼Œä¸‹é¢åˆ†åˆ«ä»ä¸¤ä¸ªä¸åŒçš„è§’åº¦å»åˆ†ææºç ã€‚ æ“ä½œ å«ä¹‰ acquire ä»¥ç‹¬å æ¨¡å¼è·å–ï¼Œå¿½ç•¥ä¸­æ–­ã€‚ é€šè¿‡è°ƒç”¨è‡³å°‘ä¸€æ¬¡å®æ–½tryAcquire ï¼Œåœ¨æˆåŠŸæ—¶è¿”å›ã€‚ å¦åˆ™ï¼Œçº¿ç¨‹æ’é˜Ÿï¼Œå¯èƒ½é‡å¤æŸ¥å°å’Œè§£å°ï¼Œè°ƒç”¨tryAcquireç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚ è¿™ç§æ–¹æ³•å¯ä»¥ç”¨æ¥å®ç°æ–¹æ³•Lock.lock ã€‚ release ä»¥ç‹¬å æ¨¡å¼é‡Šæ”¾ã€‚ é€šè¿‡ç–é€šä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œå¦‚æœå®ç°tryReleaseè¿”å›trueã€‚ è¿™ç§æ–¹æ³•å¯ä»¥ç”¨æ¥å®ç°æ–¹æ³•Lock.unlock ã€‚ acquireShared è·å–åœ¨å…±äº«æ¨¡å¼ä¸‹ï¼Œå¿½ç•¥ä¸­æ–­ã€‚ é€šè¿‡è‡³å°‘ä¸€æ¬¡ç¬¬ä¸€è°ƒç”¨å®ç°tryAcquireShared ï¼Œåœ¨æˆåŠŸæ—¶è¿”å›ã€‚ å¦åˆ™ï¼Œçº¿ç¨‹æ’é˜Ÿï¼Œå¯èƒ½é‡å¤æŸ¥å°å’Œè§£å°ï¼Œè°ƒç”¨tryAcquireSharedç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚ releaseShared ä»¥å…±äº«æ¨¡å¼é‡Šæ”¾ã€‚ é€šè¿‡ç–é€šä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œå¦‚æœå®ç°tryReleaseSharedè¿”å›trueã€‚ æ— è®ºæ˜¯å…±äº«æ¨¡å¼è¿˜æ˜¯ç‹¬å æ¨¡å¼åœ¨è¿™é‡Œé¢éƒ½ä¼šç”¨åˆ° addWaiter æ–¹æ³•ï¼Œå°†å½“å‰çº¿ç¨‹åŠæ¨¡å¼åˆ›å»ºæ’é˜ŸèŠ‚ç‚¹ã€‚ ç‹¬å æ¨¡å¼è·å–ç‹¬å èµ„æº acquirepublic final void acquire(int arg) &#123; // tryAcquire å°è¯•è·å– stateï¼Œè·å–å¤±è´¥åˆ™ä¼šåŠ å…¥åˆ°é˜Ÿåˆ— if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt();&#125; åœ¨ç‹¬å æ¨¡å¼ä¸‹ä¼šå°è¯•è·å– stateï¼Œå½“è·å–å¤±è´¥æ—¶ä¼šè°ƒç”¨ acquireQueued(addWaiter(Node.EXCLUSIVE), arg)ã€‚ tryAcquire(arg)ï¼Œå°è¯•è·å– state è¿™å—ç”±å­ç±»è‡ªå·±å®ç°ï¼Œä¸åŒçš„å­ç±»é€»è¾‘ä¸åŒï¼Œè¿™å—åœ¨ä»‹ç»å­ç±»ä»£ç æ—¶ä¼šè¯´æ˜ã€‚ è·å– state å¤±è´¥åï¼Œä¼šè¿›è¡Œ acquireQueued(addWaiter(Node.EXCLUSIVE), arg)ï¼Œè¿™å—ä»£ç å¯ä»¥æ‹†åˆ†ä¸ºä¸¤å—ï¼šaddWaiter(Node.EXCLUSIVE)ï¼ŒacquireQueued(node, arg)ã€‚ addWaiter(Node.EXCLUSIVE) è¿”å›çš„æ˜¯å½“å‰æ–°åˆ›å»ºçš„èŠ‚ç‚¹ã€‚ acquireQueued(node, arg) çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œä½¿ç”¨ addWaiter(Node.EXCLUSIVE) æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œ acquireQueued(node, arg) ä½¿ç”¨å¾ªç¯ï¼Œä¸æ–­çš„ä¸ºé˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹å»å°è¯•è·å–èµ„æºï¼Œç›´åˆ°è·å–æˆåŠŸæˆ–è€…è¢«ä¸­æ–­ã€‚ æ€»ç»“è·å–èµ„æºä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š å°è¯•è·å–èµ„æº å…¥é˜Ÿåˆ— å‡ºé˜Ÿåˆ— å°è¯•è·å–èµ„æº tryAcquire(arg)ï¼Œç”±å­ç±»å®ç°ï¼Œé‚£ä¸‹é¢åˆ™ç€æ‰‹åˆ†åˆ«åˆ†æ å…¥é˜Ÿåˆ—ã€å‡ºé˜Ÿåˆ—ã€‚ å…¥é˜Ÿåˆ—ï¼šaddWaiter(Node.EXCLUSIVE)ä½¿ç”¨ addWaiter(Node.EXCLUSIVE) æ–¹æ³•å°†èŠ‚ç‚¹æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š æ ¹æ®ä¼ å…¥çš„æ¨¡å¼åˆ›å»ºèŠ‚ç‚¹ åˆ¤æ–­å°¾èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™éœ€è¦ä½¿ç”¨ enq(node) æ–¹æ³•åˆå§‹åŒ–èŠ‚ç‚¹ï¼Œå­˜åœ¨åˆ™ç›´æ¥å°è¯•æ’å…¥å°¾éƒ¨ã€‚ å°è¯•æ’å…¥å°¾éƒ¨æ—¶ä½¿ç”¨ CAS æ’å…¥ï¼Œé˜²æ­¢å¹¶å‘æƒ…å†µï¼Œå¦‚æœæ’å…¥å¤±è´¥ï¼Œä¼šè°ƒç”¨ enq(node) è‡ªæ—‹ç›´åˆ°æ’å…¥ã€‚ private Node addWaiter(Node mode) &#123; Node node = new Node(Thread.currentThread(), mode); // å®šä½åˆ°é˜Ÿåˆ—æœ«å°¾çš„ node Node pred = tail; if (pred != null) &#123; // æ–°èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ æŒ‡å‘å°¾èŠ‚ç‚¹ node.prev = pred; // ä½¿ç”¨ CAS è®¾ç½®å°¾èŠ‚ç‚¹ï¼Œtail å¦‚æœç­‰äº pred åˆ™æ›´æ–°ä¸º node if (compareAndSetTail(pred, node)) &#123; // æ›´æ–°æˆåŠŸåˆ™å°† pred çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘ node pred.next = node; return node; &#125; &#125; // å°¾èŠ‚ç‚¹æ²¡æœ‰åˆå§‹åŒ–ï¼Œæˆ–ç«äº‰å¤±è´¥ï¼Œè‡ªæ—‹ enq(node); return node;&#125;/** * tailOffset ä¹Ÿå°±æ˜¯æˆå‘˜å˜é‡ tail çš„å€¼ * æ­¤å¤„ç›¸å½“äºï¼šæ¯”è¾ƒ tail çš„å€¼å’Œ expect çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œ ç›¸ç­‰åˆ™æ›´æ–°ä¸º update */private final boolean compareAndSetTail(Node expect, Node update) &#123; return unsafe.compareAndSwapObject(this, tailOffset, expect, update);&#125;private final boolean compareAndSetHead(Node update) &#123; return unsafe.compareAndSwapObject(this, headOffset, null, update);&#125;private Node enq(final Node node) &#123; for (;;) &#123; Node t = tail; // å°¾èŠ‚ç‚¹ä¸ºç©º éœ€è¦åˆå§‹åŒ–å¤´èŠ‚ç‚¹ï¼Œæ­¤æ—¶å¤´å°¾èŠ‚ç‚¹æ˜¯ä¸€ä¸ª if (t == null) &#123; // Must initialize if (compareAndSetHead(new Node())) tail = head; &#125; else &#123; // ä¸ä¸ºç©º å¾ªç¯èµ‹å€¼ node.prev = t; if (compareAndSetTail(t, node)) &#123; t.next = node; return t; &#125; &#125; &#125;&#125; çœ‹å®Œä»£ç å’Œæ³¨é‡Šè‚¯å®šè¿˜æ˜¯æœ‰ç‚¹æ¨¡ç³Šï¼Œç°åœ¨ç”¨å›¾ä¸€æ­¥ä¸€æ­¥è¿›è¡Œè¯´æ˜ã€‚ å› ä¸ºæ ¹æ®åˆå§‹å°¾èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œè¿™é‡Œä½¿ç”¨ä¸¤å¹…å›¾ï¼š ç¬¬ä¸€å¹…ä¸ºç¬¬ä¸€æ¬¡æ·»åŠ èŠ‚ç‚¹ï¼Œæ­¤æ—¶ head ä¼šå»¶è¿Ÿåˆå§‹åŒ–ï¼› ç¬¬äºŒå¹…å›¾ä¸ºå·²ç»å­˜åœ¨é˜Ÿåˆ—ï¼Œè¿›è¡Œæ’å…¥èŠ‚ç‚¹ï¼› æ³¨æ„çœ‹ä»£ç ï¼Œenq æ–¹æ³•è¿”å›çš„æ˜¯ä¹‹å‰çš„å°¾èŠ‚ç‚¹ï¼› addWaiter æ–¹æ³• è¿”å›çš„æ˜¯å½“å‰æ’å…¥çš„æ–°åˆ›å»ºçš„èŠ‚ç‚¹ã€‚ èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹åï¼Œè¿”å›å½“å‰èŠ‚ç‚¹ï¼Œè€Œä¸‹ä¸€æ­¥åˆ™éœ€è¦è°ƒç”¨æ–¹æ³• acquireQueued(addWaiter(Node.EXCLUSIVE), arg) ä¸æ–­çš„å»è·å–èµ„æºã€‚ å‡ºé˜Ÿåˆ—ï¼šacquireQueued(addWaiter(Node.EXCLUSIVE), arg)æ–¹æ³•ä¼šé€šè¿‡å¾ªç¯ä¸æ–­å°è¯•è·å–æ‹¿åˆ°èµ„æºï¼Œç›´åˆ°æˆåŠŸã€‚ä»£ç å¦‚ä¸‹ï¼š final boolean acquireQueued(final Node node, int arg) &#123; // æ˜¯å¦æ‹¿åˆ°èµ„æº boolean failed = true; try &#123; // ä¸­æ–­çŠ¶æ€ boolean interrupted = false; // æ— é™å¾ªç¯ for (;;) &#123; // å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„èŠ‚ç‚¹ final Node p = node.predecessor(); // å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œ è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ å¤´èŠ‚ç‚¹çš„ next å³çœŸå®çš„ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ ï¼ˆå› ä¸º head æ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼‰ // ç„¶åå†å°è¯•è·å–èµ„æº if (p == head &amp;&amp; tryAcquire(arg)) &#123; // è·å–æˆåŠŸä¹‹å å°†å¤´æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹ setHead(node); p.next = null; // help GC failed = false; return interrupted; &#125; // p ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œ æˆ–è€… å¤´èŠ‚ç‚¹æœªèƒ½è·å–åˆ°èµ„æº ï¼ˆéå…¬å¹³æƒ…å†µä¸‹è¢«åˆ«çš„èŠ‚ç‚¹æŠ¢å ï¼‰ // åˆ¤æ–­ node æ˜¯å¦è¦è¢«é˜»å¡ï¼Œ if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) interrupted = true; &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125; ä¸æ–­è·å–æœ¬èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸º headï¼Œå› ä¸º head æ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯ head èŠ‚ç‚¹ï¼Œåˆ™å½“å‰èŠ‚ç‚¹ä¸º ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼› ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ä¸æ–­çš„å»è·å–èµ„æºï¼Œè·å–æˆåŠŸï¼Œåˆ™å°† head æŒ‡å‘å½“å‰èŠ‚ç‚¹ï¼› å½“å‰èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œæˆ–è€… tryAcquire(arg) å¤±è´¥ï¼ˆå¤±è´¥å¯èƒ½æ˜¯éå…¬å¹³é”ï¼‰ã€‚è¿™æ—¶å€™éœ€è¦åˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€å†³å®šå½“å‰èŠ‚ç‚¹æ˜¯å¦è¦è¢«é˜»å¡ï¼ˆå‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€æ˜¯å¦ä¸º SIGNALï¼‰ã€‚ /** * æ ¹æ®ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦åº”è¯¥è¢«é˜»å¡ * SIGNAL -1 ï¼šå½“å‰èŠ‚ç‚¹é‡Šæ”¾æˆ–è€…å–æ¶ˆæ—¶ï¼Œå¿…é¡» unpark ä»–çš„åç»­èŠ‚ç‚¹ã€‚ * CANCELLED 1 ï¼šç”±äºè¶…æ—¶ï¼ˆtimeoutï¼‰æˆ–ä¸­æ–­ï¼ˆinterruptï¼‰ï¼Œè¯¥èŠ‚ç‚¹è¢«å–æ¶ˆã€‚èŠ‚ç‚¹æ°¸è¿œä¸ä¼šç¦»å¼€æ­¤çŠ¶æ€ã€‚ç‰¹åˆ«æ˜¯ï¼Œå…·æœ‰å–æ¶ˆèŠ‚ç‚¹çš„çº¿ç¨‹æ°¸è¿œä¸ä¼šå†æ¬¡é˜»å¡ã€‚ * CONDITION -2 ï¼šè¯¥èŠ‚ç‚¹ç›®å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ã€‚ ä½†å®ƒä¸ä¼šè¢«ç”¨ä½œåŒæ­¥é˜Ÿåˆ—èŠ‚ç‚¹ï¼Œç›´åˆ°è½¬ç§»ï¼Œè½¬ç§»æ—¶çš„çŠ¶æ€å°†è¢«è®¾ç½®ä¸º 0 ã€‚ * PROPAGATE -3 ï¼šreleaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ * 0ï¼šéƒ½ä¸æ˜¯ * */private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) &#123; // å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ int ws = pred.waitStatus; // å‰ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦ unpark åç»­èŠ‚ç‚¹ if (ws == Node.SIGNAL) return true; // å½“å‰èŠ‚ç‚¹å¤„äºå–æ¶ˆçŠ¶æ€ if (ws &gt; 0) &#123; do &#123; // å°†å–æ¶ˆçš„èŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­ç§»é™¤ node.prev = pred = pred.prev; &#125; while (pred.waitStatus &gt; 0); pred.next = node; &#125; else &#123; // è®¾ç½®å‰ä¸€ä¸ªèŠ‚ç‚¹ä¸º SIGNAL çŠ¶æ€ compareAndSetWaitStatus(pred, ws, Node.SIGNAL); &#125; return false;&#125; åœ¨ shouldParkAfterFailedAcquire æ–¹æ³•ä¸­ï¼Œä¼šåˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼ŒåŒæ—¶å–æ¶ˆåœ¨é˜Ÿåˆ—ä¸­å½“å‰èŠ‚ç‚¹å‰é¢æ— æ•ˆçš„èŠ‚ç‚¹ã€‚ å†ç»§ç»­é˜…è¯» å‡ºé˜Ÿåˆ— acquireQueued æ–¹æ³•ï¼Œå‘ç°æœ‰ä¸€ä¸ª finally ä¼šåˆ¤æ–­çŠ¶æ€åæ‰§è¡Œ cancelAcquire(node); ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æµç¨‹å›¾ä¸­ä¸‹é¢çš„çº¢è‰²æ–¹å—ã€‚ cancelAcquire(Node node)final boolean acquireQueued(final Node node, int arg) &#123; // æ˜¯å¦æ‹¿åˆ°èµ„æº boolean failed = true; try &#123; // çœç•¥ // åœ¨ finally ä¼šå°†å½“å‰èŠ‚ç‚¹ç½®ä¸ºå–æ¶ˆçŠ¶æ€ &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125;private void cancelAcquire(Node node) &#123; // èŠ‚ç‚¹ä¸å­˜åœ¨ ç›´æ¥è¿”å› if (node == null) return; // å–æ¶ˆèŠ‚ç‚¹å…³è”çº¿ç¨‹ node.thread = null; //è·³è¿‡å·²ç»å–æ¶ˆçš„èŠ‚ç‚¹ï¼Œè·å–å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„æœ‰æ•ˆèŠ‚ç‚¹ Node pred = node.prev; while (pred.waitStatus &gt; 0) node.prev = pred = pred.prev; // è·å–å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„æœ‰æ•ˆèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ Node predNext = pred.next; // å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå–æ¶ˆ node.waitStatus = Node.CANCELLED; // å½“å‰èŠ‚ç‚¹å¦‚æœæ˜¯å°¾èŠ‚ç‚¹ï¼Œåˆ™å°†æœ€åä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹ï¼Œå¹¶å°† predNext è®¾ç½®ä¸ºç©º if (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123; compareAndSetNext(pred, predNext, null); &#125; else &#123; int ws; // pred ä¸æ˜¯å¤´èŠ‚ç‚¹(node çš„ä¸Šä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹ ä¸æ˜¯ head) &amp;&amp; ï¼ˆ predçš„çŠ¶æ€æ˜¯ SIGNAL || pred çš„çŠ¶æ€è®¾ç½®ä¸º SIGNAL æˆåŠŸ ï¼‰ &amp;&amp; pred çš„ç»‘å®šçº¿ç¨‹ä¸ä¸ºç©º if (pred != head &amp;&amp; ((ws = pred.waitStatus) == Node.SIGNAL || (ws &lt;= 0 &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp; pred.thread != null) &#123; // å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ Node next = node.next; // åç»§èŠ‚ç‚¹ä¸ä¸ºç©º ä¸” çŠ¶æ€æœ‰æ•ˆ å°† pred çš„ åç»§èŠ‚ç‚¹è®¾ç½®ä¸º å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ if (next != null &amp;&amp; next.waitStatus &lt;= 0) compareAndSetNext(pred, predNext, next); &#125; else &#123; // node çš„ä¸Šä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹ æ˜¯ headï¼Œ æˆ–è€…å…¶ä»–æƒ…å†µ å”¤é†’å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹ unparkSuccessor(node); &#125; node.next = node; // help GC &#125;&#125;private void unparkSuccessor(Node node) &#123; // åˆ¤æ–­å½“å‰èŠ‚ç‚¹çŠ¶æ€ int ws = node.waitStatus; if (ws &lt; 0) // å°†èŠ‚ç‚¹çŠ¶æ€æ›´æ–°ä¸º 0 compareAndSetWaitStatus(node, ws, 0); // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ ä¸€èˆ¬æ˜¯ä¸‹ä¸€ä¸ªèŠ‚ç‚¹åº”è¯¥å°±æ˜¯éœ€è¦å”¤é†’çš„èŠ‚ç‚¹ï¼Œå³é¢å‘è¯ä¹¦ã€‚ Node s = node.next; // å¤§äº 0 CANCELLED ï¼š çº¿ç¨‹å·²å–æ¶ˆ // ä½†æ˜¯æœ‰å¯èƒ½ åç»§èŠ‚ç‚¹ ä¸ºç©ºæˆ–è€…è¢«å–æ¶ˆäº†ã€‚ if (s == null || s.waitStatus &gt; 0) &#123; s = null; // ä»å°¾èŠ‚ç‚¹å¼€å§‹éå†ï¼Œç›´åˆ°å®šä½åˆ° t.waitStatus &lt;= 0 çš„èŠ‚ç‚¹ // å®šä½åˆ°åå¹¶ä¸ä¼šåœæ­¢ï¼Œä¼šç»§ç»­æ‰§è¡Œï¼Œç›¸å½“äºæ‰¾åˆ°æœ€å¼€å§‹çš„é‚£ä¸ªéœ€è¦å”¤é†’çš„èŠ‚ç‚¹ // t.waitStatus &lt;= 0 ï¼š SIGNALï¼ˆ -1 åç»­çº¿ç¨‹éœ€è¦é‡Šæ”¾ï¼‰ // CONDITION ï¼ˆ -2 çº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¡ä»¶ï¼‰ // PROPAGATE ï¼ˆ -3 releaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ï¼‰ for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev) if (t.waitStatus &lt;= 0) s = t; &#125; // å®šä½åˆ°éœ€è¦å”¤é†’çš„èŠ‚ç‚¹å è¿›è¡Œ unpark if (s != null) LockSupport.unpark(s.thread);&#125; æµç¨‹åˆ†æï¼š æ‰¾åˆ°å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªéæ— æ•ˆèŠ‚ç‚¹ predï¼› å½“å‰èŠ‚ç‚¹å¦‚æœæ˜¯å°¾èŠ‚ç‚¹ï¼Œåˆ™å°†æœ€åä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹ï¼Œå¹¶å°† predNext è®¾ç½®ä¸ºç©ºï¼› pred ä¸æ˜¯å¤´èŠ‚ç‚¹ &amp;&amp; ï¼ˆ predçš„çŠ¶æ€æ˜¯ SIGNAL || pred çš„çŠ¶æ€è®¾ç½®ä¸º SIGNAL æˆåŠŸ ï¼‰ &amp;&amp; pred çš„ç»‘å®šçº¿ç¨‹ä¸ä¸ºç©ºï¼› å…¶ä»–æƒ…å†µã€‚ ä¸‹é¢åˆ†åˆ«ç”»å›¾ï¼š Q: é€šè¿‡å›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œåªæ“ä½œäº† next æŒ‡é’ˆï¼Œä½†æ˜¯æ²¡æœ‰æ“ä½œ prev æŒ‡é’ˆï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ A: åœ¨ å‡ºé˜Ÿåˆ—ï¼šacquireQueued(addWaiter(Node.EXCLUSIVE), arg) æ–¹æ³•ä¸­ï¼ŒshouldParkAfterFailedAcquire æ–¹æ³•ä¼šåˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼ŒåŒæ—¶å–æ¶ˆåœ¨é˜Ÿåˆ—ä¸­å½“å‰èŠ‚ç‚¹å‰é¢æ— æ•ˆçš„èŠ‚ç‚¹ã€‚è¿™æ—¶å€™ä¼šç§»é™¤ä¹‹å‰çš„æ— æ•ˆèŠ‚ç‚¹ï¼Œæ­¤å¤„ä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢æŒ‡å‘ä¸€ä¸ªå·²ç»è¢«ç§»é™¤çš„èŠ‚ç‚¹ã€‚åŒæ—¶ä¿è¯ prev çš„ç¨³å®šï¼Œæœ‰åˆ©äºä» tail å¼€å§‹éå†åˆ—è¡¨ï¼Œè¿™å—åœ¨ unparkSuccessor(node); ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°æ˜¯ä»åå¾€å‰è¡¨é‡Œåˆ—è¡¨ã€‚ Q: unparkSuccessor(Node node) ä¸ºä»€ä¹ˆä»åå¾€å‰éå†ï¼Ÿ A: åœ¨ addWaiter(Node.EXCLUSIVE) æ’å…¥æ–°èŠ‚ç‚¹æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ å°¾æ’æ³•ï¼Œçœ‹çº¢æ¡†éƒ¨åˆ†ï¼Œæ­¤æ—¶æœ‰å¯èƒ½è¿˜æœªæŒ‡å‘nextã€‚ Q: node.next = node; è¿™å—å¯¼è‡´ headä¸æ˜¯æŒ‡å‘æœ€æ–°èŠ‚ç‚¹ï¼Œé“¾è¡¨ä¸å°±æ–­äº†ä¹ˆï¼ŸAï¼š acquireQueued æ–¹æ³•ä»‹ç»ä¸­ï¼Œé‡Œé¢æœ‰ä¸ªå¾ªç¯ï¼Œä¼šä¸æ–­å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸä¹‹åä¼šè®¾ç½®ä¸º headã€‚å¹¶ä¸”åœ¨ shouldParkAfterFailedAcquire ä¸­ä¹Ÿä¼šæ¸…é™¤å½“å‰èŠ‚ç‚¹å‰çš„æ— æ•ˆèŠ‚ç‚¹ã€‚ é‡Šæ”¾ç‹¬å èµ„æº releasepublic final boolean release(int arg) &#123; if (tryRelease(arg)) &#123; Node h = head; if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); return true; &#125; return false;&#125; ä»¥ç‹¬å æ¨¡å¼é‡Šæ”¾ã€‚ é€šè¿‡é‡Šæ”¾ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œå¦‚æœå®ç°tryReleaseè¿”å›trueã€‚ è¿™ç§æ–¹æ³•å¯ä»¥ç”¨æ¥å®ç°æ–¹æ³•Lock.unlock ã€‚ tryRelease(arg) æ“ä½œé‡Šæ”¾èµ„æºï¼ŒåŒæ ·æ˜¯ç”±å­ç±»å®ç°ï¼Œåé¢ä»‹ç»å­ç±»æ—¶ä¼šè¿›è¡Œè¯´æ˜ã€‚è¿”å› true è¯´æ˜èµ„æºç°åœ¨å·²ç»æ²¡æœ‰çº¿ç¨‹æŒæœ‰äº†ï¼Œå…¶ä»–èŠ‚ç‚¹å¯ä»¥å°è¯•è·å–ï¼› é‡Šæ”¾æˆåŠŸï¼Œä¸” head != null &amp;&amp; h.waitStatus != 0, ä¼šç»§ç»­æ‰§è¡Œ unparkSuccessor(h)ï¼› è¿™å—ä¼šçœ‹åˆ° åªè¦ tryRelease(arg) æ“ä½œé‡Šæ”¾èµ„æºæˆåŠŸï¼Œ åé¢æ— è®ºæ‰§è¡Œæ˜¯å¦æˆåŠŸï¼Œéƒ½ä¼šè¿”å› trueï¼ŒunparkSuccessor(h) ç›¸å½“äºåªæ˜¯é™„åŠ æ“ä½œã€‚ å…±äº«æ¨¡å¼è·å–å…±äº«èµ„æº acquireSharedpublic final void acquireShared(int arg) &#123; // å°äº 0 è¡¨ç¤ºè·å–èµ„æºå¤±è´¥ if (tryAcquireShared(arg) &lt; 0) doAcquireShared(arg);&#125;private void doAcquireShared(int arg) &#123; // æ·»åŠ åˆ°èŠ‚ç‚¹ æ­¤å¤„æ˜¯å…±äº«èŠ‚ç‚¹ final Node node = addWaiter(Node.SHARED); // æ ¹æ®æ˜¯å¦æ‹¿åˆ°èµ„æº åˆ¤æ–­æ˜¯å¦éœ€è¦å–æ¶ˆ boolean failed = true; try &#123; boolean interrupted = false; for (;;) &#123; // è¿”å›å‰ä¸€ä¸ªèŠ‚ç‚¹ final Node p = node.predecessor(); if (p == head) &#123; // å†æ¬¡å°è¯•è·å–å…±äº«èµ„æº int r = tryAcquireShared(arg); // è¡¨ç¤ºè·å–æˆåŠŸ if (r &gt;= 0) &#123; // è®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ å¹¶å°è¯•å”¤é†’åç»­èŠ‚ç‚¹ setHeadAndPropagate(node, r); // é‡Šæ”¾å¤´èŠ‚ç‚¹ GC ä¼šå›æ”¶ p.next = null; // help GC if (interrupted) selfInterrupt(); failed = false; return; &#125; &#125; if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) interrupted = true; &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125; tryAcquireShared(arg)ï¼Œå°è¯•è·å–èµ„æºï¼Œè¿™å—ç”±å­ç±»å®ç°ï¼› è¿”å›å€¼åˆ†ä¸º 3 ç§ï¼š å°äº 0: è¡¨ç¤ºå¤±è´¥ï¼› ç­‰äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œä½†åç»­çš„èŠ‚ç‚¹ä¸èƒ½ä»¥å…±äº«æ¨¡å¼è·å–æˆåŠŸ; å¤§äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œåç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¹Ÿå¯èƒ½ä¼šæˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåç»­ç­‰å¾…çº¿ç¨‹å¿…é¡»æ£€æŸ¥å¯ç”¨æ€§ã€‚ åœ¨å¤±è´¥åä¼šä½¿ç”¨ doAcquireShared(arg); ä¸æ–­è·å–èµ„æºï¼› final Node node = addWaiter(Node.SHARED); åŒæ ·ä¼šåˆ›å»ºèŠ‚ç‚¹ï¼› åœ¨å¾ªç¯ä¸­ä¸æ–­åˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹å¦‚æœæ˜¯ headï¼Œåˆ™å°è¯•è·å–èµ„æºï¼› åœ¨å…±äº«æ¨¡å¼ä¸‹è·å–åˆ°èµ„æºåä¼šä½¿ç”¨ setHeadAndPropagate(node, r); è®¾ç½®å¤´èŠ‚ç‚¹ï¼ŒåŒæ—¶å”¤é†’åç»­èŠ‚ç‚¹ã€‚ è®¾ç½®å¤´èŠ‚ç‚¹ï¼Œå¹¶ä¼ æ’­å”¤é†’åç»­èŠ‚ç‚¹// node æ˜¯å½“å‰èŠ‚ç‚¹// propagate æ˜¯ å‰ä¸€æ­¥ tryAcquireShared çš„è¿”å›å€¼ è¿›æ¥æ—¶ &gt;=0// å¤§äº 0: è¡¨ç¤ºå…±äº«æ¨¡å¼è·å–èµ„æºæˆåŠŸï¼Œåç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¹Ÿå¯èƒ½ä¼šæˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåç»­ç­‰å¾…çº¿ç¨‹å¿…é¡»æ£€æŸ¥å¯ç”¨æ€§ã€‚private void setHeadAndPropagate(Node node, int propagate) &#123; // è®°å½•ä¸‹å½“å‰å¤´èŠ‚ç‚¹ Node h = head; // Record old head for check below // è®¾ç½®ä¼ å…¥ node ä¸ºå¤´èŠ‚ç‚¹ setHead(node); // åˆ¤æ–­æ¡ä»¶ï¼Œå”¤é†’åç»­èŠ‚ç‚¹ // propagate &gt; 0 æœ‰åç»­èµ„æº // h == null æ—§çš„å¤´èŠ‚ç‚¹ å› ä¸ºå‰é¢ addWaiterï¼Œ è‚¯å®šä¸ä¼šä¸ºç©ºï¼Œåº”è¯¥æ˜¯é˜²æ­¢ h.waitStatus &lt; 0 ç©ºæŒ‡é’ˆçš„å†™æ³• // (h = head) == null å½“å‰çš„ å¤´èŠ‚ç‚¹ï¼Œå†åˆ¤æ–­çŠ¶æ€ // waitStatus &lt; 0 åç»­èŠ‚ç‚¹å°±éœ€è¦è¢«å”¤é†’ if (propagate &gt; 0 || h == null || h.waitStatus &lt; 0 || (h = head) == null || h.waitStatus &lt; 0) &#123; Node s = node.next; // åç»­èŠ‚ç‚¹ä¸ºå…±äº«ï¼Œåˆ™éœ€è¦å”¤é†’ if (s == null || s.isShared()) doReleaseShared(); &#125;&#125; doReleaseShared() é‡Šæ”¾å…±äº«èµ„æºprivate void doReleaseShared() &#123; // å¾ªç¯ for (;;) &#123; // ä»å¤´å¼€å§‹ Node h = head; // åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå°±æ˜¯åˆšåˆå§‹åŒ– if (h != null &amp;&amp; h != tail) &#123; int ws = h.waitStatus; // SIGNALï¼ˆ -1 åç»­çº¿ç¨‹éœ€è¦é‡Šæ”¾ï¼‰ if (ws == Node.SIGNAL) &#123; // å°†ç­‰å¾…çŠ¶æ€æ›´æ–°ä¸º 0 å¦‚æœå¤±è´¥ï¼Œä¼šå¾ªç¯ if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0)) continue; // loop to recheck cases // å”¤é†’åç»­èŠ‚ç‚¹ï¼Œ åŒæ—¶å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸º å–æ¶ˆ unparkSuccessor(h); &#125; // å¦‚æœçŠ¶æ€æ˜¯ 0 åˆ™ä¼šæ›´æ–°çŠ¶æ€ä¸º PROPAGATE // PROPAGATE ï¼ˆ -3 releaseShared åº”è¯¥è¢«ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ï¼‰ else if (ws == 0 &amp;&amp; !compareAndSetWaitStatus(h, 0, Node.PROPAGATE)) continue; // loop on failed CAS &#125; // åˆ¤æ–­å¤´èŠ‚ç‚¹æœ‰æ²¡æœ‰å˜åŒ–ï¼Œæœ‰å˜åŒ– æ˜¯å› ä¸ºç«äº‰ï¼Œåˆ«çš„çº¿ç¨‹è·å–åˆ°äº†é”ï¼Œä¼šç»§ç»­å¾ªç¯ // æ²¡æœ‰å˜åŒ–ç›´æ¥ç»“æŸ if (h == head) // loop if head changed break; &#125;&#125; ä»å¤´èŠ‚ç‚¹å¼€å§‹è¿›è¡Œï¼Œå¦‚æœ h != null &amp;&amp; h != tail è¯´æ˜é˜Ÿåˆ—ä¸æ˜¯ç©ºæˆ–è€…åˆšåˆå§‹åŒ–ï¼› èŠ‚ç‚¹çŠ¶æ€ä¸º SIGNALï¼ˆ -1 ï¼‰è¯´æ˜åç»­çº¿ç¨‹éœ€è¦é‡Šæ”¾ï¼› ä¼šæ›´æ”¹å½“å‰èŠ‚ç‚¹çŠ¶æ€ï¼ŒæˆåŠŸåå”¤é†’åç»­èŠ‚ç‚¹ï¼Œå¤±è´¥åˆ™ç»§ç»­å¾ªç¯ï¼› èŠ‚ç‚¹çŠ¶æ€å¦‚æœæ˜¯ 0 åˆ™æ›´æ–°ä¸º PROPAGATEï¼Œä¼šå°†çŠ¶æ€ä¼ æ’­ã€‚ é‡Šæ”¾å…±äº«èµ„æº releaseSharedpublic final boolean releaseShared(int arg) &#123; if (tryReleaseShared(arg)) &#123; // é‡Šæ”¾å…±äº«èµ„æº doReleaseShared(); return true; &#125; return false;&#125; ä»¥å…±äº«æ¨¡å¼é‡Šæ”¾ã€‚ é€šè¿‡é‡Šæ”¾ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œå¦‚æœå®ç°tryReleaseSharedè¿”å›trueã€‚ æ€»ç»“Q: AQS åˆ°åº•æ˜¯ä»€ä¹ˆï¼ŸA: AQS å†…éƒ¨æä¾›äº†ä¸€ä¸ªå…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰åŒå‘ç­‰å¾…é˜Ÿåˆ—ï¼Œå†…éƒ¨ä¾é  Node å®ç°ï¼Œå¹¶æä¾›äº†åœ¨ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ä¸‹çš„å‡ºå…¥é˜Ÿåˆ—çš„å…¬å…±æ–¹æ³•ã€‚è€Œå…³äºçŠ¶æ€ä¿¡æ¯ state çš„å®šä¹‰æ˜¯ç”±å­ç±»å®ç°ã€‚tryAcquireã€tryReleaseã€tryAcquireSharedã€tryReleaseSharedç­‰å°è¯•è·å–èµ„æºæ“ä½œéƒ½æ˜¯ç”±å­ç±»è¿›è¡Œå®šä¹‰å’Œå®ç°çš„ã€‚è€Œ AQS ä¸­æä¾›äº†å­ç±»è·å–èµ„æºä¹‹åçš„ç›¸å…³æ“ä½œï¼ŒåŒ…æ‹¬èŠ‚ç‚¹ Node çš„å‡ºå…¥é˜Ÿåˆ—ï¼Œè‡ªæ—‹è·å–èµ„æºç­‰ç­‰ã€‚ Q: AQS è·å–èµ„æºå¤±è´¥åä¼šå¦‚ä½•æ“ä½œï¼ŸA: çº¿ç¨‹è·å–èµ„æºå¤±è´¥åï¼Œä¼šæ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåœ¨é˜Ÿåˆ—ä¸­ä¼šä¸æ–­å°è¯•è·å–èµ„æºï¼ˆè‡ªæ—‹ï¼‰ï¼Œè¯´æ˜çº¿ç¨‹åªæ˜¯è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œåé¢è¿˜æ˜¯å¯ä»¥å†æ¬¡è·å–èµ„æºçš„ã€‚ Q: AQS ç­‰å¾…é˜Ÿåˆ—çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼ŸA: CLHå˜ä½“çš„å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰åŒå‘ç­‰å¾…é˜Ÿåˆ—ã€‚ï¼ˆCLHé”æ˜¯ä¸€ä¸ªè‡ªæ—‹é”ã€‚èƒ½ç¡®ä¿æ— é¥¥é¥¿æ€§ã€‚æä¾›å…ˆæ¥å…ˆæœåŠ¡çš„å…¬å¹³æ€§ã€‚æ˜¯ä¸€ç§åŸºäºé“¾è¡¨çš„å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ï¼Œç”³è¯·çº¿ç¨‹ä»…ä»…åœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œå®ƒä¸æ–­è½®è¯¢å‰é©±çš„çŠ¶æ€ï¼Œå¦‚æœå‘ç°å‰é©±é‡Šæ”¾äº†é”å°±ç»“æŸè‡ªæ—‹ã€‚ï¼‰ Q: AQS ç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹å¦‚ä½•è·å–è·å–å’Œé‡Šæ”¾èµ„æºçš„ï¼ŸA: å¯ä»¥çœ‹ä¸‹ç‹¬å æ¨¡å¼ä¸­çš„è®²è¿°è¿‡ç¨‹ï¼Œé€šè¿‡ä»£ç æ¢³ç†ã€‚ æœ¬æ–‡åˆ†åˆ«ä» ç‹¬å æ¨¡å¼ å’Œ å…±äº«æ¨¡å¼ä»‹ç»çš„ AQS åŸºæœ¬é€»è¾‘ï¼Œå¹¶é€šè¿‡æºç å’Œä½œå›¾ç†è§£åŸºæœ¬æ€è·¯ã€‚ä½†æ˜¯å¹¶æ²¡æœ‰å¯¹éœ€è¦å­ç±»å®ç°çš„ä¸šåŠ¡é€»è¾‘åšä»‹ç»ã€‚è¿™å—ä¼šåœ¨åé¢ä»‹ç» ReentrantLockã€CountDownLatch ç­‰å­ç±»çš„æ—¶å€™åšä»‹ç»ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- JUC åŒ…ä¸‹å·¥å…·ç±»ï¼Œå®ƒçš„åå­—å« LockSupport ï¼ä½ é€ ä¹ˆï¼Ÿ","slug":"source-code/java/LockSupport","date":"2020-07-05T12:20:20.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/07/05/source-code-locksupport.html","link":"","permalink":"https://liuzhihang.com/2020/07/05/source-code-locksupport.html","excerpt":"","text":"LockSupport æ˜¯ JUC ä¸­å¸¸ç”¨çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œä¸»è¦ä½œç”¨æ˜¯æŒ‚èµ·å’Œå”¤é†’çº¿ç¨‹ã€‚åœ¨é˜…è¯» JUC æºç ä¸­ç»å¸¸çœ‹åˆ°ï¼Œæ‰€ä»¥å¾ˆæœ‰å¿…è¦äº†è§£ä¸€ä¸‹ã€‚ ä»‹ç» åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»ã€‚Basic thread blocking primitives for creating locks and other synchronization classes. LockSupport ç±»æ¯ä¸ªä½¿ç”¨å®ƒçš„çº¿ç¨‹å…³è”ä¸€ä¸ªè®¸å¯ï¼ˆåœ¨æ„ä¹‰ä¸Šçš„Semaphoreç±»ï¼‰ã€‚ å¦‚æœè®¸å¯å¯ç”¨ï¼Œè°ƒç”¨ park å°†ç«‹å³è¿”å›ï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­æ¶ˆè´¹å®ƒ; å¦åˆ™å¯èƒ½é˜»å¡ã€‚å¦‚æœè®¸å¯ä¸æ˜¯å¯ç”¨ï¼Œå¯ä»¥è°ƒç”¨ unpark ä½¿å¾—è®¸å¯å¯ç”¨ã€‚ï¼ˆä½†ä¸Semaphoreä¸åŒï¼Œè®¸å¯ä¸èƒ½ç´¯ç§¯ã€‚æœ€å¤šæœ‰ä¸€ä¸ªã€‚ï¼‰ æ–¹æ³• park å’Œ unpark æä¾›äº†é˜»å¡çš„æœ‰æ•ˆæ‰‹æ®µå’Œè§£é”çº¿ç¨‹ä¸ä¼šé‡åˆ°æ­»é”é—®é¢˜ï¼Œè€Œ Thread.suspend å’Œ Thread.resume æ˜¯ä¸èƒ½ç”¨äºè¿™ç§ç›®çš„ï¼šå› ä¸ºè®¸å¯çš„å­˜åœ¨ï¼Œä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ park å’Œå¦ä¸€ä¸ªçº¿ç¨‹è¯•å›¾ unpark å®ƒä¹‹é—´çš„ç«äº‰å°†ä¿æŒæ´»æ€§ã€‚ æ­¤å¤–ï¼Œå¦‚æœè°ƒç”¨è€…çº¿ç¨‹è¢«ä¸­æ–­ï¼Œpark å°†è¿”å›ï¼Œå¹¶ä¸”æ”¯æŒè®¾ç½®è¶…æ—¶ã€‚ è¯¥ park æ–¹æ³•ä¹Ÿå¯èƒ½è¿”å›åœ¨å…¶ä»–ä»»ä½•æ—¶é—´ï¼Œâ€œæ¯«æ— ç†ç”±â€ï¼Œå› æ­¤é€šå¸¸å¿…é¡»åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è°ƒç”¨çš„è¿”å›åé‡æ–°æ£€æŸ¥æ¡ä»¶ã€‚ åœ¨è¿™ä¸ªæ„ä¹‰ä¸Šparkä½œä¸ºâ€œå¿™ç¢Œç­‰å¾…â€ä¸ä¼šæµªè´¹å¤ªå¤šçš„æ—¶é—´è‡ªæ—‹çš„ä¼˜åŒ–ï¼Œä½†å¿…é¡»ä»¥é…å¯¹ unpark ä½¿ç”¨ã€‚ è¿™ä¸‰ç§å½¢å¼çš„ park è¿˜æ”¯æŒ blocker å¯¹è±¡å‚æ•°ã€‚è€Œçº¿ç¨‹è¢«é˜»å¡æ—¶æ˜¯å…è®¸ä½¿ç”¨ç›‘æµ‹å’Œè¯Šæ–­å·¥å…·ï¼Œä»¥ç¡®å®šçº¿ç¨‹è¢«é˜»å¡çš„åŸå› ã€‚ï¼ˆè¯Šæ–­å·¥å…·å¯ä»¥ä½¿ç”¨getBlocker(Thread) æ–¹æ³• ã€‚ï¼‰åŒæ—¶æ¨èä½¿ç”¨å¸¦æœ‰ blocker å‚æ•°çš„ parkæ–¹æ³•ï¼Œé€šå¸¸åšæ³•æ˜¯ blocker è¢«è®¾ç½®ä¸º this ã€‚ ä¸Šé¢çš„æ„æ€æ€»ç»“ä¸‹æ¥ä¸ªäººç†è§£æ˜¯ï¼š è®¸å¯ï¼ˆpermitï¼‰çš„ä¸Šé™æ˜¯1ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰ 0 æˆ– 1 ã€‚ park: æ²¡æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 0 ï¼Œè°ƒç”¨ park ä¼šé˜»å¡ï¼›æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 1 ï¼Œ è°ƒç”¨ park ä¼šæ‰£é™¤ä¸€ä¸ªè®¸å¯ï¼Œç„¶åè¿”å›ã€‚ unparkï¼šæ²¡æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 0 ï¼Œè°ƒç”¨ unpark ä¼šå¢åŠ ä¸€ä¸ªè®¸å¯ï¼Œå› ä¸ºè®¸å¯ä¸Šé™æ˜¯ 1 ï¼Œ æ‰€ä»¥è°ƒç”¨å¤šæ¬¡ä¹Ÿåªä¼šä¸º 1 ä¸ªã€‚ çº¿ç¨‹åˆå§‹çš„æ—¶å€™æ˜¯æ²¡æœ‰è®¸å¯çš„ã€‚ park çš„å½“å‰çº¿ç¨‹å¦‚æœè¢«ä¸­æ–­ï¼Œä¼šç«‹å³è¿”å›ï¼Œå¹¶ä¸ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚ park æ–¹æ³•çš„è°ƒç”¨ä¸€èˆ¬è¦æ”¾åœ¨ä¸€ä¸ªå¾ªç¯åˆ¤æ–­ä½“é‡Œé¢ã€‚ å¤§æ¦‚å¦‚å›¾æ‰€ç¤ºï¼š ä¸‹é¢æ˜¯æºç æ³¨é‡Šä¸­çš„æ¡ˆä¾‹ï¼š /** * FIFO ç‹¬å é” */class FIFOMutex &#123; private final AtomicBoolean locked = new AtomicBoolean(false); private final Queue&lt;Thread&gt; waiters = new ConcurrentLinkedQueue&lt;Thread&gt;(); public void lock() &#123; boolean wasInterrupted = false; Thread current = Thread.currentThread(); waiters.add(current); // Block while not first in queue or cannot acquire lock // ä¸åœ¨é˜Ÿåˆ—å¤´ï¼Œæˆ–è€…é”è¢«å ç”¨ï¼Œåˆ™é˜»å¡ï¼Œ å°±æ˜¯åªæœ‰é˜Ÿåˆ—å¤´çš„å¯ä»¥è·å¾—é” while (waiters.peek() != current || !locked.compareAndSet(false, true)) &#123; LockSupport.park(this); if (Thread.interrupted()) // ignore interrupts while waiting wasInterrupted = true; &#125; waiters.remove(); if (wasInterrupted) // reassert interrupt status on exit current.interrupt(); &#125; public void unlock() &#123; locked.set(false); LockSupport.unpark(waiters.peek()); &#125; &#125; éªŒè¯çº¿ç¨‹åˆå§‹æœ‰æ²¡æœ‰è®¸å¯ï¼Ÿpublic class LockSupportTest &#123; public static void main(String[] args) &#123; System.out.println(&quot;å¼€å§‹æ‰§è¡Œâ€¦â€¦&quot;); LockSupport.park(); System.out.println(&quot;LockSupport park ä¹‹åâ€¦â€¦&quot;); &#125;&#125; æ‰§è¡Œåä¼šå‘ç°ï¼Œä»£ç åœ¨ park å¤„é˜»å¡ã€‚è¯´æ˜ï¼Œçº¿ç¨‹åˆå§‹æ˜¯æ²¡æœ‰è®¸å¯çš„ã€‚ æ·»åŠ è®¸å¯å¹¶æ¶ˆè€—è®¸å¯public class LockSupportTest &#123; public static void main(String[] args) &#123; System.out.println(&quot;å¼€å§‹æ‰§è¡Œâ€¦â€¦&quot;); LockSupport.unpark(Thread.currentThread()); System.out.println(&quot;æ‰§è¡Œ - park&quot;); LockSupport.park(); System.out.println(&quot;LockSupport park ä¹‹åâ€¦â€¦&quot;); &#125;&#125; public class LockSupportTest &#123; public static void main(String[] args) throws InterruptedException &#123; Thread thread = new Thread(new Runnable() &#123; @Override public void run() &#123; System.out.println(&quot;çº¿ç¨‹ &quot; + Thread.currentThread().getName() + &quot;å¼€å§‹æ‰§è¡Œ park&quot;); LockSupport.park(this); System.out.println(&quot;çº¿ç¨‹ &quot; + Thread.currentThread().getName() + &quot;æ‰§è¡Œ park ç»“æŸ&quot;); &#125; &#125;); thread.start(); // ä¿è¯ ä¸Šé¢çº¿ç¨‹å…ˆæ‰§è¡Œï¼Œç„¶åå†ä¸»çº¿ç¨‹ Thread.sleep(5000); System.out.println(&quot;å¼€å§‹æ‰§è¡Œ unpark(thread)&quot;); LockSupport.unpark(thread); Thread.sleep(5000); System.out.println(&quot;æ‰§è¡Œ unpark(thread) ç»“æŸ&quot;); &#125;&#125; é€šè¿‡ä¸Šé¢ç¤ºä¾‹å¯ä»¥çœ‹å‡ºï¼š æ‰§è¡Œ unpark å¯ä»¥è¿›è¡Œç»™äºˆæŒ‡å®šçº¿ç¨‹ä¸€ä¸ªè¯ä¹¦ã€‚ çº¿ç¨‹å½“å‰è¢« park é˜»å¡ï¼Œæ­¤æ—¶ç»™äºˆè¯ä¹¦ä¹‹åï¼Œ park ä¼šæ¶ˆè€—è¯ä¹¦ï¼Œç„¶åç»§ç»­æ‰§è¡Œã€‚ è®¸å¯ä¸Šé™ä¸º 1public class LockSupportTest &#123; public static void main(String[] args) &#123; System.out.println(&quot;unpark 1æ¬¡&quot;); LockSupport.unpark(Thread.currentThread()); System.out.println(&quot;unpark 2æ¬¡&quot;); LockSupport.unpark(Thread.currentThread()); System.out.println(&quot;æ‰§è¡Œ - park 1 æ¬¡&quot;); LockSupport.park(); System.out.println(&quot;æ‰§è¡Œ - park 2 æ¬¡&quot;); LockSupport.park(); System.out.println(&quot;LockSupport park ä¹‹åâ€¦â€¦&quot;); &#125;&#125; çº¿ç¨‹é˜»å¡ï¼Œå¯ä»¥çœ‹å‡º permit åªèƒ½æœ‰ä¸€ä¸ª ä¸­æ–­å¯ä»¥ä½¿ park ç»§ç»­æ‰§è¡Œå¹¶ä¸ä¼šæŠ›å‡ºå¼‚å¸¸public class LockSupportTest &#123; public static void main(String[] args) &#123; Thread thread = new Thread(new Runnable() &#123; @Override public void run() &#123; System.out.println(&quot;çº¿ç¨‹ &quot; + Thread.currentThread().getName() + &quot;å¼€å§‹æ‰§è¡Œ park&quot;); LockSupport.park(this); System.out.println(&quot;çº¿ç¨‹ &quot; + Thread.currentThread().getName() + &quot;æ‰§è¡Œ park ç»“æŸ&quot;); System.out.println(&quot;çº¿ç¨‹ &quot; + Thread.currentThread().getName() + &quot;å¼€å§‹æ‰§è¡Œ park ç¬¬äºŒæ¬¡&quot;); LockSupport.park(this); System.out.println(&quot;çº¿ç¨‹ &quot; + Thread.currentThread().getName() + &quot;æ‰§è¡Œ park ç¬¬äºŒæ¬¡ ç»“æŸ&quot;); &#125; &#125;); try &#123; thread.start(); // ä¿è¯ ä¸Šé¢çº¿ç¨‹å…ˆæ‰§è¡Œï¼Œç„¶åå†ä¸»çº¿ç¨‹ Thread.sleep(5000); System.out.println(&quot;å¼€å§‹æ‰§è¡Œ unpark(thread)&quot;); // LockSupport.unpark(thread); thread.interrupt(); Thread.sleep(5000); System.out.println(&quot;æ‰§è¡Œ unpark(thread) ç»“æŸ&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š /Library/Java/JavaVirtualMachines/jdk1.8.0_221.jdk/Contents/Home/bin/java ...çº¿ç¨‹ Thread-0å¼€å§‹æ‰§è¡Œ parkå¼€å§‹æ‰§è¡Œ unpark(thread)çº¿ç¨‹ Thread-0æ‰§è¡Œ park ç»“æŸçº¿ç¨‹ Thread-0å¼€å§‹æ‰§è¡Œ park ç¬¬äºŒæ¬¡çº¿ç¨‹ Thread-0æ‰§è¡Œ park ç¬¬äºŒæ¬¡ ç»“æŸæ‰§è¡Œ unpark(thread) ç»“æŸ å¯ä»¥çœ‹å‡ºçº¿ç¨‹ä¸­æ–­ï¼Œpark ä¼šç»§ç»­æ‰§è¡Œï¼Œå¹¶ä¸”æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ã€‚ thread.interrupt(); è°ƒç”¨ä¹‹åï¼Œ è®¾ç½®çº¿ç¨‹ä¸­æ–­æ ‡ç¤ºï¼Œunpark æ²¡æœ‰æ¸…é™¤ä¸­æ–­æ ‡ç¤ºï¼Œç¬¬äºŒä¸ª park ä¹Ÿä¼šç»§ç»­æ‰§è¡Œã€‚ ä½¿ç”¨è¯Šæ–­å·¥å…·liuzhihang % &gt; jps76690 LockSupportTest77130 Jpsliuzhihang % &gt; jstack 77265...&quot;main&quot; #1 prio=5 os_prio=31 tid=0x00007f7f3e80a000 nid=0xe03 waiting on condition [0x000070000dfcd000] java.lang.Thread.State: WAITING (parking) at sun.misc.Unsafe.park(Native Method) at java.util.concurrent.locks.LockSupport.park(LockSupport.java:304) at com.liuzhihang.source.LockSupportTest.main(LockSupportTest.java:14) ä¸­é—´çœç•¥éƒ¨åˆ†ï¼Œä½†æ˜¯å¯ä»¥çœ‹å‡ºçº¿ç¨‹è¿›å…¥ WAITING çŠ¶æ€ æºç åˆ†æpublic class LockSupport &#123; private static final sun.misc.Unsafe UNSAFE; /** * ä¸ºçº¿ç¨‹ thread è®¾ç½®ä¸€ä¸ªè®¸å¯ * æ— è®¸å¯ï¼Œåˆ™æ·»åŠ ä¸€ä¸ªè®¸å¯ï¼Œæœ‰è®¸å¯ï¼Œåˆ™ä¸æ·»åŠ  * å¦‚æœçº¿ç¨‹å› ä¸º park è¢«é˜»å¡ï¼Œ æ·»åŠ è®¸å¯ä¹‹åï¼Œä¼šè§£é™¤é˜»å¡çŠ¶æ€ */ public static void unpark(Thread thread) &#123; if (thread != null) UNSAFE.unpark(thread); &#125; /** * æœ‰è®¸å¯ï¼Œåˆ™ä½¿ç”¨è¯¥è®¸å¯ * æ²¡æœ‰è®¸å¯ï¼Œé˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°è·å¾—è®¸å¯ * ä¼ é€’ blocker æ˜¯ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨è¯Šæ–­å·¥å…· */ public static void park(Object blocker) &#123; Thread t = Thread.currentThread(); setBlocker(t, blocker); UNSAFE.park(false, 0L); setBlocker(t, null); &#125; /** * è®¾ç½®çº¿ç¨‹çš„ blocker å±æ€§ */ private static void setBlocker(Thread t, Object arg) &#123; // Even though volatile, hotspot doesn&#x27;t need a write barrier here. UNSAFE.putObject(t, parkBlockerOffset, arg); &#125;&#125; LockSupport çš„ park unpark æ–¹æ³•ï¼Œå®é™…è°ƒç”¨çš„æ˜¯åº•å±‚ Unsafe ç±»çš„ native æ–¹æ³•ã€‚ public final class Unsafe &#123; public native void unpark(Object var1); public native void park(boolean var1, long var2);&#125; æ—¢ç„¶è°ƒç”¨äº† Unsafe åˆ°æ­¤å¤„è‚¯å®šä¸èƒ½å–„ç½¢ç”˜ä¼‘ã€‚ hotspot æºç è¿™å—æ˜¯ä¸‹è½½çš„å®˜æ–¹åŒ…ä¸­çš„æºç ï¼Œé˜…è¯»å¹¶æŸ¥é˜…èµ„æ–™äº†è§£çš„å¤§æ¦‚é€»è¾‘ï¼Œä¸æ¸…æ¥šä¹‹å¤„ï¼Œå¸Œæœ›æŒ‡å¯¼å‡ºæ¥ã€‚ ä¹Ÿå¯ä»¥ç›´æ¥è·³è¿‡ç›´æ¥çœ‹ç»“è®ºã€‚ æŸ¥çœ‹jdkæºç http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/5a83b7215107/src/share/vm/runtime/park.hpp è¿™å—åœ¨ä»¥ os_linux ä»£ç ä¸ºä¾‹http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/5a83b7215107/src/os/linux/vm/os_linux.cpp åœ¨åº•å±‚ç»´æŠ¤äº†ä¸€ä¸ª _counter é€šè¿‡æ›´æ–° _counter çš„å€¼æ¥æ ‡ç¤ºæ˜¯å¦æœ‰è¯æ˜ã€‚ åœ¨ park æ—¶ï¼Œåˆ¤æ–­ _counter ä¸º 0ï¼Œåˆ™é˜»å¡ç­‰å¾…ï¼Œä¸º 1 åˆ™è·å¾—æ›´æ–°ä¸º 0 å¹¶è¿”å›ã€‚ åœ¨ unpark æ—¶ï¼Œåˆ¤æ–­ _counter ä¸º 0ï¼Œåˆ™ç»™äºˆå‡­è¯ï¼Œå¹¶å”¤é†’çº¿ç¨‹ï¼Œä¸º 1 åˆ™ç›´æ¥è¿”å›ã€‚ æ€»ç»“æ€»ç»“ä¹Ÿæ˜¯å’Œé¢„æƒ³çš„æ˜¯ç›¸åŒçš„ã€‚ è®¸å¯ï¼ˆpermitï¼‰çš„ä¸Šé™æ˜¯1ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰ 0 æˆ– 1 ã€‚ park: æ²¡æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 0 ï¼Œè°ƒç”¨ park ä¼šé˜»å¡ï¼›æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 1 ï¼Œ è°ƒç”¨ park ä¼šæ‰£é™¤ä¸€ä¸ªè®¸å¯ï¼Œç„¶åè¿”å›ã€‚ unparkï¼šæ²¡æœ‰è®¸å¯çš„æ—¶å€™ï¼Œpermit ä¸º 0 ï¼Œè°ƒç”¨ unpark ä¼šå¢åŠ ä¸€ä¸ªè®¸å¯ï¼Œå› ä¸ºè®¸å¯ä¸Šé™æ˜¯ 1 ï¼Œ æ‰€ä»¥è°ƒç”¨å¤šæ¬¡ä¹Ÿåªä¼šä¸º 1 ä¸ªã€‚ çº¿ç¨‹åˆå§‹çš„æ—¶å€™æ˜¯æ²¡æœ‰è®¸å¯çš„ã€‚ park çš„å½“å‰çº¿ç¨‹å¦‚æœè¢«ä¸­æ–­ï¼Œä¼šç«‹å³è¿”å›ï¼Œå¹¶ä¸ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚ æ‰©å±• park/unpark å’Œ wait/notify åŒºåˆ« park é˜»å¡å½“å‰çº¿ç¨‹ï¼Œunpark å”¤é†’æŒ‡å®šçº¿ç¨‹ã€‚ wait() éœ€è¦ç»“åˆé”ä½¿ç”¨ï¼Œå¹¶é‡Šæ”¾é”èµ„æºï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œåˆ™éœ€è¦ notify() å”¤é†’ã€‚è€Œ notify() æ˜¯éšæœºå”¤é†’çº¿ç¨‹ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- JDK 8 æ–°å¢çš„ LongAdderï¼Œå¾—è¿‡æ¥çœ‹ä¸€ä¸‹ï¼","slug":"source-code/java/LongAddr","date":"2020-06-28T15:50:20.000Z","updated":"2020-12-27T09:23:14.595Z","comments":true,"path":"2020/06/28/source-code-longadder.html","link":"","permalink":"https://liuzhihang.com/2020/06/28/source-code-longadder.html","excerpt":"","text":"åœ¨ä»‹ç» AtomicInteger æ—¶ï¼Œå·²ç»è¯´æ˜åœ¨é«˜å¹¶å‘ä¸‹å¤§é‡çº¿ç¨‹å»ç«äº‰æ›´æ–°åŒä¸€ä¸ªåŸå­å˜é‡æ—¶ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ›´æ–°æˆåŠŸï¼Œå…¶ä»–çš„çº¿ç¨‹åœ¨ç«äº‰å¤±è´¥åï¼Œåªèƒ½ä¸€ç›´å¾ªç¯ï¼Œä¸æ–­çš„è¿›è¡Œ CAS å°è¯•ï¼Œä»è€Œæµªè´¹äº† CPU èµ„æºã€‚è€Œåœ¨ JDK 8 ä¸­æ–°å¢äº† LongAdder ç”¨æ¥è§£å†³é«˜å¹¶å‘ä¸‹å˜é‡çš„åŸå­æ“ä½œã€‚ä¸‹é¢åŒæ ·é€šè¿‡é˜…è¯»æºç æ¥äº†è§£ LongAdder ã€‚ ä»‹ç»ä¸€ä¸ªæˆ–å¤šä¸ªå˜é‡å…±åŒç»´æŒåˆå€¼ä¸º 0 æ€»å’Œã€‚ å½“è·¨çº¿ç¨‹ç«äº‰æ›´æ–°æ—¶ï¼Œå˜é‡é›†å¯ä»¥åŠ¨æ€å¢é•¿ä»¥å‡å°‘ç«äº‰ã€‚ æ–¹æ³• sum è¿”å›å½“å‰å˜é‡é›†çš„æ€»å’Œã€‚ å½“å¤šä¸ªçº¿ç¨‹æ›´æ–°æ—¶ï¼Œè¿™ä¸ªç±»æ˜¯é€šå¸¸ä¼˜é€‰ AtomicLong ï¼Œæ¯”å¦‚ç”¨äºæ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼Œä¸ç”¨äºç»†ç²’åº¦åŒæ­¥æ§åˆ¶çš„å…±åŒæ€»å’Œã€‚ åœ¨ä½æ›´æ–°ç«äº‰ï¼Œè¿™ä¸¤ä¸ªç±»å…·æœ‰ç›¸ä¼¼çš„ç‰¹å¾ã€‚ ä½†åœ¨é«˜æ›´æ–°ç«äº‰æ—¶ï¼Œä½¿ç”¨ LongAdder æ€§èƒ½è¦é«˜äº AtomicLongï¼ŒåŒæ ·è¦æ¶ˆè€—æ›´é«˜çš„ç©ºé—´ä¸ºä»£ä»·ã€‚ LongAdder ç»§æ‰¿äº† Striped64ï¼Œå†…éƒ¨ç»´æŠ¤ä¸€ä¸ª Cells æ•°ç»„ï¼Œç›¸å½“äºå¤šä¸ª Cell å˜é‡ï¼Œ æ¯ä¸ª Cell é‡Œé¢éƒ½æœ‰ä¸€ä¸ªåˆå§‹å€¼ä¸º 0 çš„ long å‹å˜é‡ã€‚ æºç åˆ†æCell ç±»Cell ç±» æ˜¯ Striped64 çš„é™æ€å†…éƒ¨ç±»ã€‚ @sun.misc.Contended static final class Cell &#123; volatile long value; Cell(long x) &#123; value = x; &#125; final boolean cas(long cmp, long val) &#123; return UNSAFE.compareAndSwapLong(this, valueOffset, cmp, val); &#125; // Unsafe mechanics private static final sun.misc.Unsafe UNSAFE; private static final long valueOffset; static &#123; try &#123; UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; ak = Cell.class; valueOffset = UNSAFE.objectFieldOffset (ak.getDeclaredField(&quot;value&quot;)); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125;&#125; Cell ä½¿ç”¨ @sun.misc.Contended æ³¨è§£ã€‚ å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªè¢« volatile ä¿®é¥°çš„ long å‹ value ã€‚ æä¾› cas æ–¹æ³•ï¼Œæ›´æ–°valueã€‚ å…¶ä¸­ @sun.misc.Contended æ³¨è§£ä½œç”¨æ˜¯ä¸ºäº†å‡å°‘ç¼“å­˜äº‰ç”¨ã€‚ä»€ä¹ˆæ˜¯ç¼“å­˜äº‰ç”¨ï¼Œè¿™é‡Œåªåšä¸‹ç®€è¦ä»‹ç»ã€‚ ä¼ªå…±äº«CPU å­˜åœ¨å¤šçº§ç¼“å­˜ï¼Œå…¶ä¸­æœ€å°å­˜å‚¨å•å…ƒæ˜¯ Cache Lineï¼Œæ¯ä¸ª Cache Line èƒ½å­˜å‚¨ 64 ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼ŒA B ä¸¤ä¸ªçº¿ç¨‹æ•°æ®å¦‚æœè¢«å­˜å‚¨åˆ°åŒä¸€ä¸ª Cache Line ä¸Šï¼Œæ­¤æ—¶ A B æ›´æ–°å„è‡ªçš„æ•°æ®ï¼Œå°±ä¼šå‘ç”Ÿç¼“å­˜äº‰ç”¨ï¼Œå¯¼è‡´å¤šä¸ªçº¿ç¨‹ä¹‹é—´ç›¸äº’ç‰µåˆ¶ï¼Œå˜æˆäº†ä¸²è¡Œç¨‹åºï¼Œé™ä½äº†å¹¶å‘ã€‚@sun.misc.Contended æ³¨è§£ï¼Œåˆ™å¯ä»¥ä¿è¯è¯¥å˜é‡ç‹¬å ä¸€ä¸ª Cache Lineã€‚è¯¦ç»†å¯å‚è€ƒï¼šhttp://openjdk.java.net/jeps/142 Striped64 æ ¸å¿ƒå±æ€§abstract class Striped64 extends Number &#123; /** CPU çš„æ•°é‡ï¼Œä»¥é™åˆ¶è¡¨å¤§å° */ static final int NCPU = Runtime.getRuntime().availableProcessors(); /** * cell æ•°ç»„ï¼Œå½“éç©ºæ—¶ï¼Œå¤§å°æ˜¯ 2 çš„å¹‚ã€‚ */ transient volatile Cell[] cells; /** * Base å€¼ï¼Œåœ¨æ— äº‰ç”¨æ—¶ä½¿ç”¨ï¼Œè¡¨åˆå§‹åŒ–ç«èµ›æœŸé—´çš„åå¤‡ã€‚ä½¿ç”¨ CAS æ›´æ–° */ transient volatile long base; /** * è°ƒæ•´å¤§å°å’Œåˆ›å»ºCellsæ—¶è‡ªæ—‹é”ï¼ˆé€šè¿‡CASé”å®šï¼‰ä½¿ç”¨ã€‚ */ transient volatile int cellsBusy;&#125; Striped64 ç±»ä¸»è¦æä¾›ä»¥ä¸‹å‡ ä¸ªå±æ€§ï¼š NCPUï¼šCPU çš„æ•°é‡ï¼Œä»¥é™åˆ¶è¡¨å¤§å°ã€‚ cellsï¼šCell[] cell æ•°ç»„ï¼Œå½“éç©ºæ—¶ï¼Œå¤§å°æ˜¯ 2 çš„å¹‚ã€‚ baseï¼šlong å‹ï¼ŒBase å€¼ï¼Œåœ¨æ— äº‰ç”¨æ—¶ä½¿ç”¨ï¼Œè¡¨åˆå§‹åŒ–ç«èµ›æœŸé—´çš„åå¤‡ã€‚ä½¿ç”¨ CAS æ›´æ–°ã€‚ cellsBusyï¼šè°ƒæ•´å¤§å°å’Œåˆ›å»ºCellsæ—¶è‡ªæ—‹é”ï¼ˆé€šè¿‡CASé”å®šï¼‰ä½¿ç”¨ã€‚ ä¸‹é¢çœ‹æ˜¯è¿›å…¥æ ¸å¿ƒé€»è¾‘ï¼š LongAdder#addpublic class LongAdder extends Striped64 implements Serializable &#123; public void add(long x) &#123; Cell[] as; long b, v; int m; Cell a; // cells æ˜¯ æ•°ç»„ï¼Œbase æ˜¯åŸºç¡€å€¼ if ((as = cells) != null || !casBase(b = base, b + x)) &#123; boolean uncontended = true; if (as == null || (m = as.length - 1) &lt; 0 || (a = as[getProbe() &amp; m]) == null || !(uncontended = a.cas(v = a.value, v + x))) longAccumulate(x, null, uncontended); &#125; &#125;&#125; abstract class Striped64 extends Number &#123; // ä½¿ç”¨ CAS æ›´æ–° BASE çš„å€¼ final boolean casBase(long cmp, long val) &#123; return UNSAFE.compareAndSwapLong(this, BASE, cmp, val); &#125; // è¿”å›å½“å‰çº¿ç¨‹çš„æ¢æµ‹å€¼ã€‚ ç”±äºåŒ…è£…é™åˆ¶ï¼Œä»ThreadLocalRandomå¤åˆ¶ static final int getProbe() &#123; return UNSAFE.getInt(Thread.currentThread(), PROBE); &#125;&#125; é¦–å…ˆä¼šå¯¹ Base å€¼è¿›è¡Œ CAS æ›´æ–°ï¼Œå½“ Base å‘ç”Ÿç«äº‰æ—¶ï¼Œ ä¼šæ›´æ–°æ•°ç»„å†…çš„ Cell ã€‚ æ•°ç»„æœªåˆå§‹åŒ–ï¼ŒCell æœªåˆå§‹åŒ–ï¼Œ Cell æ›´æ–°å¤±è´¥ï¼Œå³ Cell ä¹Ÿå‘ç”Ÿç«äº‰æ—¶ï¼Œä¼šè°ƒç”¨ Striped64 çš„ longAccumulate æ–¹æ³•ã€‚ Striped64#longAccumulateabstract class Striped64 extends Number &#123; /** * x è¦å¢åŠ çš„å€¼ * wasUncontended æœ‰æ²¡æœ‰å‘ç”Ÿç«äº‰ */ final void longAccumulate(long x, LongBinaryOperator fn, boolean wasUncontended) &#123; int h; // å½“å‰çº¿ç¨‹æœ‰æ— åˆå§‹åŒ–çº¿ç¨‹æ¢æµ‹å€¼ï¼Œ ç»™å½“å‰çº¿ç¨‹ç”Ÿæˆä¸€ä¸ª é 0 æ¢æµ‹å€¼ if ((h = getProbe()) == 0) &#123; ThreadLocalRandom.current(); // force initialization h = getProbe(); wasUncontended = true; &#125; boolean collide = false; // True if last slot nonempty // å¾ªç¯ for (;;) &#123; Cell[] as; Cell a; int n; long v; // æ•°ç»„ä¸ä¸ºç©ºåˆ‡æ•°ç»„é•¿åº¦å¤§äº 0 if ((as = cells) != null &amp;&amp; (n = as.length) &gt; 0) &#123; // (n - 1) &amp; h è·å–åˆ°ç´¢å¼•ï¼Œç´¢å¼•å¤„ cell æ˜¯å¦ä¸º nullï¼Œ cellæœªåˆå§‹åŒ– if ((a = as[(n - 1) &amp; h]) == null) &#123; // åˆ¤æ–­ cellsBusy æ˜¯å¦ä¸º 0 if (cellsBusy == 0) &#123; // Try to attach new Cell Cell r = new Cell(x); // Optimistically create // cellsBusy == 0 ä¸” ä½¿ç”¨ casCellsBusy æ–¹æ³•å°†å…¶æ›´æ–°ä¸º 1ï¼Œå¤±è´¥ä¼šç»§ç»­å¾ªç¯ if (cellsBusy == 0 &amp;&amp; casCellsBusy()) &#123; boolean created = false; try &#123; // Recheck under lock Cell[] rs; int m, j; // é‡æ–°æ£€æŸ¥çŠ¶æ€ å¹¶åˆ›å»º if ((rs = cells) != null &amp;&amp; (m = rs.length) &gt; 0 &amp;&amp; rs[j = (m - 1) &amp; h] == null) &#123; rs[j] = r; created = true; &#125; &#125; finally &#123; // åˆ›å»ºå®Œæˆä¹‹åï¼Œ æ”¹å› cellsBusy å€¼ cellsBusy = 0; &#125; if (created) break; // æœªåˆ›å»ºç»§ç»­å¾ªç¯ continue; // Slot is now non-empty &#125; &#125; collide = false; &#125; // ä¼ å…¥çš„ wasUncontended ä¸º false å³å‘ç”Ÿç¢°æ’äº†ï¼Œ ä¿®æ”¹ä¸ºæœªç¢°æ’ï¼Œ æ­¤å¤„ä¼šç»§ç»­å¾ªç¯ï¼Œèµ°åˆ°ä¸‹ä¸€æ­¥ï¼Œç›¸å½“äºä¼šä¸€ç›´å¾ªç¯è¿™ä¸ª cell else if (!wasUncontended) // CAS already known to fail wasUncontended = true; // Continue after rehash // cas æ›´æ–° cell çš„ valueï¼Œ æˆåŠŸåˆ™è¿”å› else if (a.cas(v = a.value, ((fn == null) ? v + x : fn.applyAsLong(v, x)))) break; // æ•°ç»„åˆ°æœ€å¤§é•¿åº¦ å³å¤§äºç­‰äº CPU æ•°é‡ï¼Œ æˆ–è€… cells æ•°ç»„è¢«æ”¹å˜ï¼Œ else if (n &gt;= NCPU || cells != as) collide = false; // At max size or stale else if (!collide) collide = true; // ä¹è§‚é” è¿›è¡Œæ‰©å®¹ else if (cellsBusy == 0 &amp;&amp; casCellsBusy()) &#123; try &#123; if (cells == as) &#123; // Expand table unless stale Cell[] rs = new Cell[n &lt;&lt; 1]; for (int i = 0; i &lt; n; ++i) rs[i] = as[i]; cells = rs; &#125; &#125; finally &#123; cellsBusy = 0; &#125; collide = false; continue; // Retry with expanded table &#125; // å½“å‰æ¢é’ˆå€¼ä¸èƒ½æ“ä½œæˆåŠŸï¼Œåˆ™é‡æ–°è®¾ç½®ä¸€ä¸ªè¿›è¡Œå°è¯• h = advanceProbe(h); &#125; // æ²¡æœ‰åŠ  cellsBusy ä¹è§‚é” ä¸” æ²¡æœ‰åˆå§‹åŒ–ï¼Œä¸”è·å¾—é”æˆåŠŸï¼ˆæ­¤æ—¶ cellsBusy == 1ï¼‰ else if (cellsBusy == 0 &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123; boolean init = false; try &#123; // Initialize table if (cells == as) &#123; Cell[] rs = new Cell[2]; rs[h &amp; 1] = new Cell(x); cells = rs; init = true; &#125; &#125; finally &#123; cellsBusy = 0; &#125; if (init) break; &#125; // å°è¯•åœ¨baseä¸Šç´¯åŠ  else if (casBase(v = base, ((fn == null) ? v + x : fn.applyAsLong(v, x)))) break; // Fall back on using base &#125; &#125;&#125; longAccumulate æ–¹æ³•ä¸€å…±æœ‰ä¸‰ç§æƒ…å†µ (as = cells) != null &amp;&amp; (n = as.length) &gt; 0 æ•°ç»„ä¸ä¸ºç©ºä¸”é•¿åº¦å¤§äº 0 ã€‚ è·å–ç´¢å¼•å¤„çš„ cell ï¼Œ cell ä¸ºç©ºåˆ™è¿›è¡Œåˆå§‹åŒ–ã€‚ cell ä¸ä¸ºç©ºï¼Œä½¿ç”¨ cas æ›´æ–°ï¼Œ æˆåŠŸ break; è·³å‡ºå¾ªç¯ï¼Œ å¤±è´¥åˆ™è¿˜åœ¨å¾ªç¯å†…ï¼Œä¼šä¸€ç›´å°è¯•ã€‚ collide æŒ‡æ˜¯å¦å‘ç”Ÿå†²çªï¼Œå†²çªåä¼šè¿›è¡Œé‡è¯•ã€‚ å†²çªåä¼šå°è¯•è·å¾—é”å¹¶è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹é•¿åº¦ä¸ºåŸæ¥çš„ 2 å€ï¼Œç„¶åç»§ç»­é‡è¯•ã€‚ è·å¾—é”å¤±è´¥ï¼ˆè¯´æ˜å…¶ä»–çº¿ç¨‹åœ¨æ‰©å®¹ï¼‰ä¼šé‡æ–°è¿›è¡Œè®¡ç®—æ¢é’ˆå€¼ã€‚ cellsBusy == 0 &amp;&amp; cells == as &amp;&amp; casCellsBusy() æ•°ç»„ä¸ºç©ºï¼Œè·å¾—ä¹è§‚é”æˆåŠŸã€‚ ç›´æ¥åˆå§‹åŒ–æ•°ç»„ã€‚ åˆå§‹æ•°ç»„é•¿åº¦ä¸º 2 ã€‚ casBase(v = base, ((fn == null) ? v + x : fn.applyAsLong(v, x))) è·å¾—ä¹è§‚é”å¤±è´¥ã€‚ è¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹åœ¨åˆå§‹åŒ–æ•°ç»„ï¼Œç›´æ¥ CAS æ›´æ–° base ã€‚ LongAdder#sumpublic class LongAdder extends Striped64 implements Serializable &#123; public long sum() &#123; Cell[] as = cells; Cell a; long sum = base; if (as != null) &#123; for (int i = 0; i &lt; as.length; ++i) &#123; if ((a = as[i]) != null) sum += a.value; &#125; &#125; return sum; &#125;&#125; æ•°ç»„ä¸ºç©ºï¼Œè¯´æ˜æ²¡æœ‰å‘ç”Ÿç«äº‰ï¼Œç›´æ¥è¿”å› base ã€‚ æ•°ç»„ä¸ä¸ºç©ºï¼Œè¯´æ˜å‘ç”Ÿç«äº‰ï¼Œç´¯åŠ  cell çš„ value å’Œ base çš„å’Œè¿›è¡Œè¿”å›ã€‚ æ€»ç»“åŸºæœ¬æµç¨‹ LongAdder ç»§æ‰¿äº† Striped64ï¼Œå†…éƒ¨ç»´æŠ¤ä¸€ä¸ª Cells æ•°ç»„ï¼Œç›¸å½“äºå¤šä¸ª Cell å˜é‡ï¼Œ æ¯ä¸ª Cell é‡Œé¢éƒ½æœ‰ä¸€ä¸ªåˆå§‹å€¼ä¸º 0 çš„ long å‹å˜é‡ã€‚ æœªå‘ç”Ÿç«äº‰æ—¶ï¼ˆCells æ•°ç»„æœªåˆå§‹åŒ–ï¼‰ï¼Œæ˜¯å¯¹ base å˜é‡è¿›è¡ŒåŸå­æ“ä½œã€‚ å‘ç”Ÿç«äº‰æ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹è‡ªå·±çš„ Cell å˜é‡çš„ value è¿›è¡ŒåŸå­æ“ä½œã€‚ å¦‚ä½•ç¡®å®šå“ªä¸ªçº¿ç¨‹æ“ä½œå“ªä¸ª cellï¼Ÿé€šè¿‡ getProbe() æ–¹æ³•è·å–è¯¥çº¿ç¨‹çš„æ¢æµ‹å€¼ï¼Œç„¶åå’Œæ•°ç»„é•¿åº¦ n - 1 åš &amp; æ“ä½œ (n - 1) &amp; h ã€‚ static final int getProbe() &#123; return UNSAFE.getInt(Thread.currentThread(), PROBE);&#125; Cells æ•°ç»„åˆå§‹åŒ–åŠæ‰©å®¹ï¼Ÿåˆå§‹åŒ–æ‰©å®¹æ—¶ä¼šåˆ¤æ–­ cellsBusyï¼Œ cellsBusy ä½¿ç”¨ volatile ä¿®é¥°ï¼Œä¿è¯çº¿ç¨‹è§å¯è§æ€§ï¼ŒåŒæ—¶ä½¿ç”¨ CAS è¿›è¡Œæ›´æ–°ã€‚ 0 è¡¨ç¤ºç©ºé—²ï¼Œ1 è¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–æˆ–æ‰©å®¹ã€‚ åˆå§‹åŒ–æ—¶ä¼šåˆ›å»ºé•¿åº¦ä¸º 2 çš„ Cell æ•°ç»„ã€‚æ‰©å®¹æ˜¯åˆ›å»ºä¸€ä¸ªé•¿åº¦æ˜¯åŸæ•°ç»„é•¿åº¦ 2 å€çš„æ–°æ•°ç»„ï¼Œå¹¶å¾ªç¯èµ‹å€¼ã€‚ å¦‚æœçº¿ç¨‹è®¿é—®åˆ†é…çš„ Cell å…ƒç´ æœ‰å†²çªåï¼Œä¼šä½¿ç”¨ advanceProbe() æ–¹æ³•é‡æ–°è·å–æ¢æµ‹å€¼ï¼Œå†æ¬¡è¿›è¡Œå°è¯•ã€‚ ä½¿ç”¨åœºæ™¯åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œéœ€è¦ç›¸å¯¹é«˜çš„æ€§èƒ½ï¼ŒåŒæ—¶æ•°æ®å‡†ç¡®æ€§è¦æ±‚ä¸é«˜ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ LongAdderã€‚ å½“è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¹¶å…è®¸ä¸€å®šçš„æ€§èƒ½æŸè€—æ—¶ï¼Œå¹¶å¯¹æ•°æ®å‡†ç¡®æ€§è¦æ±‚è¾ƒé«˜ï¼Œä¼˜å…ˆä½¿ç”¨ AtomicLongã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- è¯·ä»‹ç»ä¸‹ä½ äº†è§£çš„ThreadLocalï¼Œå®ƒçš„åº•å±‚åŸç†ï¼","slug":"source-code/java/ThreadLocal","date":"2020-06-21T02:00:00.000Z","updated":"2020-12-27T09:23:14.595Z","comments":true,"path":"2020/06/21/source-code-threadlocal.html","link":"","permalink":"https://liuzhihang.com/2020/06/21/source-code-threadlocal.html","excerpt":"","text":"å‰è¨€ ä¸šåŠ¡å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨ ThreadLocal æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ç­‰çº¿ç¨‹ç§æœ‰å¯¹è±¡â€¦ ThreadLocal å†…éƒ¨æ„é€ æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿå¸¸è¯´çš„å†…å­˜æ³„éœ²åˆæ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ å…¬ä¼—å·ï¼šliuzhihangs ï¼Œè®°å½•å·¥ä½œå­¦ä¹ ä¸­çš„æŠ€æœ¯ã€å¼€å‘åŠæºç ç¬”è®°ï¼›æ—¶ä¸æ—¶åˆ†äº«ä¸€äº›ç”Ÿæ´»ä¸­çš„è§é—»æ„Ÿæ‚Ÿã€‚æ¬¢è¿å¤§ä½¬æ¥æŒ‡å¯¼ï¼ ä»‹ç» ThreadLocal ç±»æä¾›äº†çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚å’Œæ­£å¸¸å¯¹è±¡ä¸åŒçš„æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—® get()ã€set() æ–¹æ³•ï¼Œè·å–ç‹¬å±äºè‡ªå·±çš„å‰¯æœ¬ã€‚ ThreadLocal å®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œå¹¶ä¸”å…¶çŠ¶æ€å’Œçº¿ç¨‹å…³è”ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ä¿æŒå¯¹å…¶çº¿ç¨‹å±€éƒ¨å˜é‡å‰¯æœ¬çš„éšå¼å¼•ç”¨ï¼Œåªè¦çº¿ç¨‹æ˜¯æ´»åŠ¨çš„å¹¶ä¸” ThreadLocal å®ä¾‹è®¿é—®; ä¸€ä¸ªçº¿ç¨‹æ¶ˆå¤±ä¹‹åï¼Œæ‰€æœ‰çš„çº¿ç¨‹å±€éƒ¨å®ä¾‹çš„å‰¯æœ¬éƒ½ä¼šè¢«åƒåœ¾å›æ”¶ï¼ˆé™¤éå­˜åœ¨å¯¹è¿™äº›å‰¯æœ¬çš„å…¶ä»–å¼•ç”¨ï¼‰ã€‚ ä½¿ç”¨æœ‰è¿™ä¹ˆä¸€ç§ä½¿ç”¨åœºæ™¯ï¼Œæ”¶åˆ° web è¯·æ±‚ï¼Œå…ˆè¿›è¡Œ token éªŒè¯ï¼Œè€Œè¿™ä¸ª tokenï¼Œå¯ä»¥è§£æå‡ºç”¨æˆ· user çš„ä¿¡æ¯ã€‚æ‰€ä»¥æˆ‘è¿™è¾¹ä¸€èˆ¬æ˜¯è¿™æ ·ä½¿ç”¨çš„ï¼š è‡ªå®šä¹‰æ³¨è§£ï¼Œ @CheckToken ï¼Œ æ ‡è¯†è¯¥æ–¹æ³•éœ€è¦æ ¡éªŒ tokenã€‚ åœ¨ Interceptorï¼ˆæ‹¦æˆªå™¨ï¼‰ä¸­æ£€æŸ¥ï¼Œå¦‚æœæ–¹æ³•æœ‰ @CheckToken æ³¨è§£åˆ™æ ¡éªŒ tokenã€‚ ä»Headerä¸­è·å– Authorization ï¼Œè¯·æ±‚ç¬¬ä¸‰æ–¹æˆ–è€…è‡ªå·±çš„é€»è¾‘æ ¡éªŒ token ï¼Œå¹¶è§£ææˆ userã€‚ å°†useræ”¾åˆ°ThreadLocalä¸­ã€‚ controllerã€service åœ¨åç»­ä½¿ç”¨ä¸­ï¼Œ å¦‚æœéœ€è¦ user ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥ä» ThreadLocal ä¸­è·å–ã€‚ ä½¿ç”¨ç»“æŸåè¿›è¡Œremoveã€‚ ä»£ç å¦‚ä¸‹ï¼špublic class LocalUserUtils &#123; /** * ç”¨æˆ·ä¿¡æ¯ä¿å­˜è‡³ ThreadLocal ä¸­ */ private static final ThreadLocal&lt;User&gt; USER_THREAD_LOCAL = new ThreadLocal&lt;&gt;(); public static void set(User user) &#123; USER_THREAD_LOCAL.set(user); &#125; public static User get() &#123; return USER_THREAD_LOCAL.get(); &#125; public static void remove() &#123; USER_THREAD_LOCAL.remove(); &#125;&#125;/** * 1. åŠ ä¸Šæ³¨è§£ CheckToken * åªæœ‰æ–¹æ³•ï¼Œ ç±»å¿½ç•¥ */@CheckToken@PostMapping(&quot;/doXxx&quot;)public Result&lt;Resp&gt; doXxx(@RequestBody Req req) &#123; Resp resp = xxxService.doXxx(req); return result.success(resp);&#125;/** * 2. 3. 4. */@Componentpublic class TokenInterceptor implements HandlerInterceptor &#123; @Override public void afterCompletion(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2, Exception arg3) throws Exception &#123; LocalUserUtils.remove(); &#125; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; // è¯·æ±‚æ–¹æ³•æ˜¯å¦å­˜åœ¨æ³¨è§£ boolean assignableFrom = handler.getClass().isAssignableFrom(HandlerMethod.class); if (!assignableFrom) &#123; return true; &#125; CheckToken checkToken = null; if (handler instanceof HandlerMethod) &#123; checkToken = ((HandlerMethod) handler).getMethodAnnotation(CheckToken.class); &#125; // æ²¡æœ‰åŠ æ³¨è§£ ç›´æ¥æ”¾è¿‡ if (checkToken == null) &#123; return true; &#125; // ä»Headerä¸­è·å–Authorization String authorization = request.getHeader(&quot;Authorization&quot;); log.info(&quot;header authorization : &#123;&#125;&quot;, authorization); if (StringUtils.isBlank(authorization)) &#123; log.error(&quot;ä»Headerä¸­è·å–Authorizationå¤±è´¥&quot;); throw CustomExceptionEnum.NOT_HAVE_TOKEN.throwCustomException(); &#125; User user = xxxUserService.checkAuthorization(authorization); // æ”¾åˆ° LocalUserUtils.set(user); return true; &#125;&#125;/** * 5. ä½¿ç”¨ * åªæœ‰æ–¹æ³•ï¼Œ ç±»å¿½ç•¥ */@Overridepublic Resp doXxx(Req req) &#123; User user = LocalUserUtils.get(); // do something ... return resp;&#125; æŠ›å‡ºé—®é¢˜ ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼Ÿ ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼Ÿ ä¸ºä»€ä¹ˆå¼ºåˆ¶ä½¿ç”¨åå¿…é¡»removeï¼Ÿ å›¾ | é˜¿é‡Œå·´å·´ - Javaå¼€å‘æ‰‹å†Œï¼ˆæˆªå›¾ï¼‰ å›¾ | é˜¿é‡Œå·´å·´ - Javaå¼€å‘æ‰‹å†Œï¼ˆæˆªå›¾ï¼‰ æºç åˆ†æThreadpublic class Thread implements Runnable &#123; // çœç•¥ ... ThreadLocal.ThreadLocalMap threadLocals = null; ThreadLocal.ThreadLocalMap inheritableThreadLocals = null; // çœç•¥ ...&#125; å¯ä»¥çœ‹å‡º Thread å¯¹è±¡ä¸­å£°æ˜äº† ThreadLocal.ThreadLocalMap å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ ThreadLocal. ThreadLocalMap å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨çº¿ç¨‹ä¹‹é—´æ˜¯äº’ç›¸éš”ç¦»çš„ã€‚ ThreadLocalThreadLocalåˆ™æ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼ŒåŒæ—¶æä¾› set()ã€get()ã€remove() ç­‰é™æ€æ–¹æ³•ã€‚ public class ThreadLocal&lt;T&gt; &#123; // çº¿ç¨‹æœ¬åœ°hashCode private final int threadLocalHashCode = nextHashCode(); // è·å–æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹å‰¯æœ¬ä¸­çš„å€¼ public T get() &#123;...&#125; // è®¾ç½®å½“å‰çº¿ç¨‹çš„æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å¤åˆ¶åˆ°æŒ‡å®šçš„å€¼ public void set(T value) &#123;...&#125; // åˆ é™¤å½“å‰çº¿ç¨‹çš„æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼ public void remove() &#123;...&#125; // ThreadLocalMapåªæ˜¯ç”¨æ¥ç»´æŒçº¿ç¨‹æœ¬åœ°å€¼çš„å®šåˆ¶Map static class ThreadLocalMap &#123;...&#125;&#125; set(T value)æ–¹æ³•public void set(T value) &#123; // è·å–å½“å‰çº¿ç¨‹ Thread t = Thread.currentThread(); // è·å–å½“å‰çº¿ç¨‹çš„ threadLocals å±æ€§ ThreadLocalMap map = getMap(t); if (map != null) // å­˜åœ¨åˆ™èµ‹å€¼ map.set(this, value); else // ä¸å­˜åœ¨åˆ™ç›´æ¥åˆ›å»º createMap(t, value);&#125;// æ ¹æ®çº¿ç¨‹è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMapThreadLocalMap getMap(Thread t) &#123; return t.threadLocals;&#125;// åˆ›å»ºThreadLocalMap å¹¶èµ‹å€¼ç»™å½“å‰çº¿ç¨‹çš„threadLocalså­—æ®µvoid createMap(Thread t, T firstValue) &#123; t.threadLocals = new ThreadLocalMap(this, firstValue);&#125; 1.Thread.currentThread() å…ˆè·å–åˆ°å½“å‰çº¿ç¨‹ã€‚2. è·å–å½“å‰çº¿ç¨‹çš„ threadLocals å±æ€§ï¼Œå³ ThreadLocalMapã€‚3. åˆ¤æ–­ Map æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™èµ‹å€¼ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºå¯¹è±¡ã€‚ get()æ–¹æ³•public T get() &#123; // è·å–å½“å‰çº¿ç¨‹ Thread t = Thread.currentThread(); // è·å–å½“å‰çº¿ç¨‹çš„ threadLocals å±æ€§ ThreadLocalMap map = getMap(t); // mapä¸ä¸ºç©º if (map != null) &#123; // æ ¹æ®å½“å‰ThreadLocalè·å–çš„ThreadLocalMapçš„EntryèŠ‚ç‚¹ ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) &#123; // è·å–èŠ‚ç‚¹çš„value å¹¶è¿”å› @SuppressWarnings(&quot;unchecked&quot;) T result = (T)e.value; return result; &#125; &#125; // è®¾ç½®åˆå§‹å€¼å¹¶è¿”å› ï¼ˆnullï¼‰ return setInitialValue();&#125; 1.Thread.currentThread() å…ˆè·å–åˆ°å½“å‰çº¿ç¨‹ã€‚2. è·å–å½“å‰çº¿ç¨‹çš„ threadLocals å±æ€§ï¼Œå³ ThreadLocalMap ã€‚3. åˆ¤æ–­ Map ä¸ä¸ºç©ºï¼Œæ ¹æ®å½“å‰ ThreadLocal å¯¹è±¡è·å– ThreadLocalMap.Entry èŠ‚ç‚¹, ä»èŠ‚ç‚¹ä¸­è·å– valueã€‚4.ThreadLocalMap ä¸ºç©ºæˆ–è€… ThreadLocalMap.Entry ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ– ThreadLocalMap å¹¶è¿”å›ã€‚ remove()æ–¹æ³•public void remove() &#123; // è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap ThreadLocalMap m = getMap(Thread.currentThread()); // ä¸ä¸ºç©ºï¼Œ ä»ThreadLocalMapä¸­ç§»é™¤è¯¥å±æ€§ if (m != null) m.remove(this);&#125; é˜…è¯» set()ã€get()ã€remove() çš„æºç ä¹‹åå‘ç°åé¢å…¶å®æ˜¯æ“ä½œçš„ ThreadLocalMap, ä¸»è¦è¿˜æ˜¯æ“ä½œçš„ ThreadLocalMap çš„ set()ã€getEntry()ã€remove() ä»¥åŠæ„é€ å‡½æ•°ã€‚ä¸‹é¢çœ‹æ˜¯çœ‹ ThreadLocalMap çš„æºç ã€‚ ThreadLocalMapstatic class ThreadLocalMap &#123; /** * EntryèŠ‚ç‚¹ç»§æ‰¿WeakReferenceæ˜¯å¼±å¼•ç”¨ */ static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; &#123; /** ä¸æ­¤ThreadLocalå…³è”çš„å€¼ã€‚ */ Object value; Entry(ThreadLocal&lt;?&gt; k, Object v) &#123; super(k); value = v; &#125; &#125; // åˆå§‹å®¹é‡-å¿…é¡»æ˜¯2çš„å¹‚ private static final int INITIAL_CAPACITY = 16; // è¡¨ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´å¤§å°. table.lengthå¿…é¡»å§‹ç»ˆä¸º2çš„å¹‚. private ThreadLocal.ThreadLocalMap.Entry[] table; // è¡¨ä¸­çš„æ¡ç›®æ•°ã€‚ private int size = 0; // æ‰©å®¹é˜ˆå€¼ private int threshold; // Default to 0 // è®¾ç½®é˜€å€¼ä¸ºé•¿åº¦çš„ 2/3 private void setThreshold(int len) &#123; threshold = len * 2 / 3; &#125; // æ„é€ å‡½æ•° ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;...&#125; // æ ¹æ®ThreadLocalè·å–èŠ‚ç‚¹Entry private ThreadLocal.ThreadLocalMap.Entry getEntry(ThreadLocal&lt;?&gt; key) &#123;...&#125; // set ThreadLocalMapçš„k-v private void set(ThreadLocal&lt;?&gt; key, Object value) &#123;...&#125; // ç§»é™¤å½“å‰å€¼ private void remove(ThreadLocal&lt;?&gt; key) &#123;...&#125;&#125; Entry ç»§æ‰¿äº† WeakReference&lt;ThreadLocal&lt;?&gt; ä¹Ÿå°±æ„å‘³ç€ï¼Œ Entry èŠ‚ç‚¹çš„ key æ˜¯å¼±å¼•ç”¨ã€‚ Entry å¯¹è±¡çš„keyå¼±å¼•ç”¨ï¼ŒæŒ‡å‘çš„æ˜¯ ThreadLocal å¯¹è±¡ã€‚ çº¿ç¨‹å¯¹è±¡æ‰§è¡Œå®Œæ¯•ï¼Œçº¿ç¨‹å¯¹è±¡å†…å®ä¾‹å±æ€§ä¼šè¢«å›æ”¶ï¼Œæ­¤æ—¶çº¿ç¨‹å†… ThreadLocal å¯¹è±¡çš„å¼•ç”¨è¢«ç½®ä¸º null ï¼Œå³ Entry çš„ key ä¸º null, key ä¼šè¢«åƒåœ¾å›æ”¶ã€‚ ThreadLocal å¯¹è±¡é€šå¸¸ä¸ºç§æœ‰é™æ€å˜é‡ï¼Œ ç”Ÿå‘½å‘¨æœŸä¸ä¼šè‡³å°‘ä¸ä¼šéšç€çº¿ç¨‹æŠ€æœ¯è€Œç»“æŸã€‚ ThreadLocal å¯¹è±¡å­˜åœ¨ï¼Œå¹¶ä¸” Entryçš„ key == null &amp;&amp; value != null ï¼Œè¿™æ—¶å°±ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚ å°è¡¥å…… å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨å¼ºå¼•ç”¨ï¼ˆStrongReferenceï¼‰ï¼šæœ€å¸¸è§ï¼Œç›´æ¥ new Object(); åˆ›å»ºçš„å³ä¸ºå¼ºå¼•ç”¨ã€‚å½“å†…å­˜ç©ºé—´ä¸è¶³ï¼ŒJavaè™šæ‹Ÿæœºå®æ„¿æŠ›å‡º OOMï¼Œä¹Ÿä¸æ„¿æ„éšæ„å›æ”¶å…·æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡æ¥è§£å†³å†…å­˜ä¸è¶³é—®é¢˜ã€‚è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰ï¼šå†…å­˜è¶³å¤Ÿï¼Œåƒåœ¾å›æ”¶å™¨ä¸ä¼šå›æ”¶è½¯å¼•ç”¨å¯¹è±¡ï¼›å†…å­˜ä¸è¶³æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šå›æ”¶ã€‚å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰ï¼šåƒåœ¾å›æ”¶å™¨çº¿ç¨‹ï¼Œå‘ç°å°±ä¼šå›æ”¶ã€‚è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰ï¼šä»»ä½•æ—¶å€™éƒ½æœ‰å¯èƒ½è¢«åƒåœ¾å›æ”¶ï¼Œå¿…é¡»å¼•ç”¨é˜Ÿåˆ—è”åˆä½¿ç”¨ã€‚ å†…å­˜æ³„éœ²ï¼šå†…å­˜æ³„æ¼ï¼ˆMemory leakï¼‰æ˜¯åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œç”±äºç–å¿½æˆ–é”™è¯¯é€ æˆç¨‹åºæœªèƒ½é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚å†…å­˜æ³„æ¼å¹¶éæŒ‡å†…å­˜åœ¨ç‰©ç†ä¸Šçš„æ¶ˆå¤±ï¼Œè€Œæ˜¯åº”ç”¨ç¨‹åºåˆ†é…æŸæ®µå†…å­˜åï¼Œç”±äºè®¾è®¡é”™è¯¯ï¼Œå¯¼è‡´åœ¨é‡Šæ”¾è¯¥æ®µå†…å­˜ä¹‹å‰å°±å¤±å»äº†å¯¹è¯¥æ®µå†…å­˜çš„æ§åˆ¶ï¼Œä»è€Œé€ æˆäº†å†…å­˜çš„æµªè´¹ã€‚â€”â€” ç»´åŸºç™¾ç§‘ æ„é€ å‡½æ•°åŠhashè®¡ç®—ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123; // åˆå§‹åŒ–Entryæ•°ç»„ï¼Œ é•¿åº¦ä¸º16 table = new Entry[INITIAL_CAPACITY]; // è·å–keyçš„hashCodeï¼Œå¹¶è®¡ç®—å‡ºåœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œ // é•¿åº¦æ˜¯ 2çš„å¹‚çš„æƒ…å†µä¸‹ï¼Œå–æ¨¡ a % b == a &amp; (b - 1) int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1); table[i] = new Entry(firstKey, firstValue); // è®¾ç½®æ•°ç»„å…ƒç´ æ•° size = 1; // è®¾ç½®æ‰©å®¹é˜ˆå€¼ setThreshold(INITIAL_CAPACITY);&#125; threadLocalHashCode æ˜¯ ThreadLocal çš„é™æ€å±æ€§ï¼Œé€šè¿‡ nextHashCode æ–¹æ³•è·å–ã€‚ private final int threadLocalHashCode = nextHashCode();// è¢«èµ‹äºˆäº†æ¥ä¸‹æ¥çš„å“ˆå¸Œç ã€‚ åŸå­æ›´æ–°ã€‚ ä»é›¶å¼€å§‹ã€‚private static AtomicInteger nextHashCode = new AtomicInteger();private static final int HASH_INCREMENT = 0x61c88647;private static int nextHashCode() &#123; // è¿”å›ä¸‹ä¸€ä¸ªhashç ï¼Œé€šè¿‡æ­¥é•¿ 0x61c88647 ç´¯åŠ ç”Ÿæˆï¼Œè¿™å—æ³¨é‡Šè¯´æ˜æ˜¯æœ€ä½³å“ˆå¸Œå€¼ return nextHashCode.getAndAdd(HASH_INCREMENT);&#125; åˆå§‹åŒ–æ•°ç»„ï¼Œé•¿åº¦16ã€‚ è®¡ç®— key çš„ hashCodeï¼Œå¯¹2çš„å¹‚å–æ¨¡ã€‚ è®¾ç½®å…ƒç´ ï¼Œå…ƒç´ æ•°åŠæ‰©å®¹é˜ˆå€¼ã€‚ hashCode é€šè¿‡æ­¥é•¿ 0x61c88647 ç´¯åŠ ç”Ÿæˆï¼Œ å¹¶ä¸”ä½¿ç”¨äº† AtomicIntegerï¼Œä¿è¯åŸå­æ€§ã€‚ set()æ–¹æ³•private void set(ThreadLocal&lt;?&gt; key, Object value) &#123; Entry[] tab = table; int len = tab.length; // hashcodeå–æ¨¡æ±‚æ•°ç»„ç´¢å¼• int i = key.threadLocalHashCode &amp; (len-1); // è·å–æ•°ç»„ä¸­å¯¹åº”çš„ä½ç½®ï¼Œ é‡ç‚¹å…³æ³¨ e = tab[i = nextIndex(i, len)] for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) &#123; // è·å–key ThreadLocal&lt;?&gt; k = e.get(); // key å­˜åœ¨åˆ™è¦†ç›– if (k == key) &#123; e.value = value; return; &#125; // key ä¸å­˜åœ¨åˆ™èµ‹å€¼ if (k == null) &#123; replaceStaleEntry(key, value, i); return; &#125; &#125; // æ­¤æ—¶ e == null ç›´æ¥æ‰§åˆ›å»ºèŠ‚ç‚¹ tab[i] = new Entry(key, value); int sz = ++size; // cleanSomeSlots å¾ªç¯æ•°ç»„ æŸ¥æ‰¾å…¨éƒ¨key==nullçš„Entry if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold) rehash();&#125; è·å–å¾ªç¯ Entry æ•°ç»„ï¼Œè·å– tab[i] å¤„çš„ eï¼Œ e != null ç»§ç»­å¾ªç¯ æ­¤æ—¶å‘ç° e çš„ key ä¸å­˜åœ¨ï¼Œå¹¶ä¸”ä¸æ˜¯ null ï¼ˆhashå†²çªäº†ã€‚ï¼‰ é‚£å°±é€šè¿‡ e = tab[i = nextIndex(i, len)]) ç»§ç»­è·å–ä¸‹ä¸€ä¸ª iï¼Œå¹¶è·å–æ–°çš„ tab[i] å¤„çš„ eã€‚ èµ‹å€¼æ›¿æ¢å€¼ç»“æŸç»“æŸå¹¶è¿”å›ã€‚ e == null ç»“æŸå¾ªç¯ã€‚ // ä¸‹ä¸€ä¸ªindexï¼Œå¦‚æœ i + 1 &lt; len ç›´æ¥è¿”å›ä¸‹ä¸€ä¸ªä½ç½® // å¦‚æœ i + 1 &gt;= len åˆ™è¿”å› 0ï¼Œ ä»å¤´å¼€å§‹ã€‚private static int nextIndex(int i, int len) &#123; return ((i + 1 &lt; len) ? i + 1 : 0);&#125;private static int prevIndex(int i, int len) &#123; return ((i - 1 &gt;= 0) ? i - 1 : len - 1);&#125; è¿™å—åˆ©ç”¨ç¯å½¢è®¾è®¡ï¼Œå¦‚æœé•¿åº¦åˆ°è¾¾æ•°ç»„é•¿åº¦ï¼Œåˆ™ä»å¼€å¤´å¼€å§‹ç»§ç»­æŸ¥æ‰¾ã€‚ int i = key.threadLocalHashCode &amp; (len-1); æ±‚å‡ºç´¢å¼•ï¼Œå¹¶ä¸æ˜¯ä»0å¼€å§‹çš„ã€‚ /** * staleSlot ä¸ºå½“å‰ç´¢å¼•ä½ç½®ï¼Œ å¹¶ä¸”å½“å‰ç´¢å¼•ä½ç½®çš„ k == null */private void replaceStaleEntry(ThreadLocal&lt;?&gt; key, Object value, int staleSlot) &#123; Entry[] tab = table; int len = tab.length; Entry e; // éœ€è¦æ¸…é™¤çš„ entry çš„ç´¢å¼• int slotToExpunge = staleSlot; // å¾ªç¯è·å–åˆ°ä¸Šä¸€ä¸ª key==null çš„èŠ‚ç‚¹åŠå…¶ç´¢å¼•ï¼Œæœ‰å¯èƒ½è¿˜æ˜¯è‡ªå·± for (int i = prevIndex(staleSlot, len); (e = tab[i]) != null; i = prevIndex(i, len)) if (e.get() == null) slotToExpunge = i; // ç»§ç»­ä¸Šä¸€å±‚çš„å¾ªç¯ï¼ŒæŸ¥æ‰¾ä¸‹ä¸€ä¸ª k == key çš„èŠ‚ç‚¹ç´¢å¼• for (int i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) &#123; ThreadLocal&lt;?&gt; k = e.get(); if (k == key) &#123; // key ç›¸ç­‰ åˆ™ç›´æ¥èµ‹å€¼ e.value = value; // å¹¶ä¸”å°† æ­¤å¤„çš„ entryæ›¿æ¢ä¸º tab[staleSlot] tab[i] = tab[staleSlot]; tab[staleSlot] = e; // å¦‚æœå‘ç°è¦æ¸…é™¤çš„ entryå’Œä¼ å…¥çš„åœ¨ä¸€ä¸ªä½ç½®ä¸Šï¼Œ åˆ™ç›´æ¥èµ‹å€¼ if (slotToExpunge == staleSlot) slotToExpunge = i; // æ¸…é™¤æ‰è¿‡æœŸçš„ expungeStaleEntry(slotToExpunge) ä¼šæ¸…é™¤ entryçš„valueï¼Œå°†å…¶è®¾ç½®ä¸ºnullå¹¶å°†å…¶è®¾ç½®ä¸ºnullï¼Œ å¹¶è¿”å›ä¸‹ä¸€ä¸ªéœ€è¦æ¸…é™¤çš„entryçš„ç´¢å¼•ä½ç½® // cleanSomeSlots å¾ªç¯æ•°ç»„ æŸ¥æ‰¾å…¨éƒ¨key==nullçš„Entry cleanSomeSlots(expungeStaleEntry(slotToExpunge), len); return; &#125; // å¦‚æœå‘åæ‰«ææ²¡æœ‰æ‰¾åˆ°ï¼Œå¹¶ä¸”å·²ç»åˆ°ç¬¬åˆå§‹ä¼ å…¥çš„ç´¢å¼•ä½ç½®å¤„äº† if (k == null &amp;&amp; slotToExpunge == staleSlot) slotToExpunge = i; &#125; // æ²¡æ‰¾åˆ°ï¼Œ ç›´æ¥å°†æ—§å€¼ Entry è®¾ç½®ä¸º null å¹¶æŒ‡å‘æ–°åˆ›å»ºçš„Entry tab[staleSlot].value = null; tab[staleSlot] = new Entry(key, value); // ç»“æŸä¹‹åå‘ç°è¦æ¸…æ¥šçš„ keyçš„ç´¢å¼• ä¸ç­‰äºå½“å‰ä¼ å…¥çš„ç´¢å¼•ï¼Œ è¯´æ˜è¿˜æœ‰å…¶ä»–éœ€è¦æ¸…é™¤ã€‚ if (slotToExpunge != staleSlot) cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);&#125; è¿™é‡Œå­˜åœ¨ä¸‰ä¸ªå±æ€§ keyï¼Œ valueï¼Œä»¥åŠ staleSlotï¼Œ staleSlotèŠ‚ç‚¹çš„ Entry != null ä½†æ˜¯ k == nullã€‚ å‘å‰æ‰«æè·å–åˆ°ä¸Šä¸€ä¸ª Entry != null ä½†æ˜¯ k == null çš„èŠ‚ç‚¹åŠå…¶ç´¢å¼•, èµ‹å€¼ç»™ slotToExpungeï¼Œ æ²¡æœ‰æ‰«æåˆ°çš„è¯ slotToExpunge è¿˜æ˜¯ç­‰äº staleSlotã€‚ å‘åæ‰«æ Entry != null çš„èŠ‚ç‚¹ï¼Œå› ä¸ºåœ¨ set æ–¹æ³•ä¸­ï¼Œ åé¢è¿˜æœ‰ä¸€æ®µæ•°ç»„æ²¡æœ‰éå†ã€‚ å‘ç° key ç›¸ç­‰çš„EntryèŠ‚ç‚¹äº†ï¼Œ ç›´æ¥èµ‹å€¼ï¼Œç„¶åæ¸…é™¤å…¶ä»– Entry != null ä½†æ˜¯ k == null çš„èŠ‚ç‚¹ï¼Œ å¹¶è¿”å›ã€‚ æ²¡æœ‰æ‰¾åˆ°keyç›¸ç­‰çš„èŠ‚ç‚¹ï¼Œä½†æ˜¯æ‰¾åˆ°äº†ä¸‹ä¸€ä¸ª Entry != null ä½†æ˜¯ k == nullï¼Œ ä¸”æ­¤æ—¶ slotToExpunge æœªå‘ç”Ÿå˜åŒ–ï¼Œè¿˜æ˜¯æŒ‡å‘ staleSlotï¼Œ åˆ™ i èµ‹å€¼ç»™ slotToExpungeã€‚ å‘åæ‰«ææ²¡æœ‰æ‰«æåˆ°ï¼Œåˆ™ç›´æ¥å¯¹å½“å‰èŠ‚ç‚¹ï¼ˆç´¢å¼•å€¼ä¸ºstaleSlotï¼‰çš„èŠ‚ç‚¹çš„valueè®¾ç½®ä¸ºnullï¼Œå¹¶æŒ‡å‘æ–°valueã€‚ ç»“æŸä¹‹åå‘ç° slotToExpunge è¢«æ”¹å˜äº†ï¼Œ è¯´æ˜è¿˜æœ‰å…¶ä»–çš„è¦æ¸…é™¤ã€‚ getEntry()æ–¹æ³•private Entry getEntry(ThreadLocal&lt;?&gt; key) &#123; // hashcodeå–æ¨¡æ±‚æ•°ç»„ç´¢å¼• int i = key.threadLocalHashCode &amp; (table.length - 1); Entry e = table[i]; if (e != null &amp;&amp; e.get() == key) // å­˜åœ¨åˆ™è¿”å› return e; else // ä¸å­˜åœ¨ return getEntryAfterMiss(key, i, e);&#125;private Entry getEntryAfterMiss(ThreadLocal&lt;?&gt; key, int i, Entry e) &#123; Entry[] tab = table; int len = tab.length; while (e != null) &#123; ThreadLocal&lt;?&gt; k = e.get(); if (k == key) return e; if (k == null) // key å·²ç» == null äº† æ¸…é™¤ä¸€ä¸‹ value expungeStaleEntry(i); else // ç»§ç»­è·å–ä¸‹ä¸€ä¸ª i = nextIndex(i, len); e = tab[i]; &#125; return null;&#125; hashcode å–æ¨¡æ±‚æ•°ç»„ç´¢å¼•ã€‚ ç´¢å¼•å¤„è·å–åˆ° Entry åˆ™ç›´æ¥è¿”å›ã€‚ è·å–ä¸åˆ°æˆ–è€…è·å–åˆ°çš„ Entry key ä¸ç›¸ç­‰æ—¶ï¼Œæœ‰å¯èƒ½æ˜¯å› ä¸º hash å†²çªï¼Œè¢«æ”¾åˆ°åˆ«çš„åœ°æ–¹ï¼Œ è°ƒç”¨ getEntryAfterMiss æ–¹æ³•ã€‚ getEntryAfterMiss æ–¹æ³•ä¸­ã€‚ e == null è¿”å›nullã€‚ e != null åˆ¤æ–­keyï¼Œ keyç›¸ç­‰è¿”å› Entryï¼Œ key == nullï¼Œ é‚£å°±éœ€è¦æ¸…é™¤è¿™ä¸ªèŠ‚ç‚¹ï¼Œç„¶åç»§ç»­æŒ‰ç…§ nextIndex(i, len) æ–¹æ³•æ‰¾ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ remove()æ–¹æ³•private void remove(ThreadLocal&lt;?&gt; key) &#123; Entry[] tab = table; int len = tab.length; // hashcode å–æ¨¡æ±‚æ•°ç»„ç´¢å¼• int i = key.threadLocalHashCode &amp; (len-1); // æ¸…é™¤å½“å‰èŠ‚ç‚¹çš„value for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) &#123; if (e.get() == key) &#123; // æ¸…æ¥šå¯¹è±¡å¼•ç”¨ e.clear(); // value æŒ‡å‘ null expungeStaleEntry(i); return; &#125; &#125;&#125;public void clear() &#123; this.referent = null;&#125; hashcode å–æ¨¡æ±‚æ•°ç»„ç´¢å¼•ã€‚ å¾ªç¯æŸ¥æ‰¾æ•°ç»„ï¼Œå°†å½“å‰ key çš„ Entry çš„å¼•ç”¨ï¼Œå°† value è®¾ç½®ä¸º nullï¼Œ åé¢ä¼šè¢«åƒåœ¾å›æ”¶æ‰ã€‚ æ€»ç»“ä¸ºä»€ä¹ˆå¯ä»¥çº¿ç¨‹ç§æœ‰ï¼ŸThreadLocal çš„ get()ã€set()ã€remove()æ–¹æ³•ä¸­éƒ½æœ‰ Thread t = Thread.currentThread(); æ“ä½œçš„å…¶å®æ˜¯æœ¬çº¿ç¨‹ï¼Œè·å–æœ¬çº¿ç¨‹çš„ThreadLocalMapã€‚ æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ ThreadLocalï¼Œå¹¶ä¸”æ˜¯å°† value å­˜æ”¾åœ¨ä¸€ä¸ªä»¥ ThreadLocal ä¸º key çš„ ThreadLocalMap ä¸­çš„ã€‚æ‰€ä»¥çº¿ç¨‹é—´éš”ç¦»ã€‚ ä¸ºä»€ä¹ˆå»ºè®®å£°æ˜ä¸ºé™æ€ï¼ŸJavaå¼€å‘æ‰‹å†Œå·²ç»ç»™å‡ºè¯´æ˜ï¼Œè¿˜æœ‰å°±æ˜¯ï¼Œå¦‚æœ ThreadLocal è®¾ç½®ä¸ºéé™æ€ï¼Œé‚£å°±æ˜¯æŸä¸ªçº¿ç¨‹çš„å®ä¾‹ç±»ï¼Œè¿™æ ·çš„è¯å°±ä¼šå¤±å»äº†çº¿ç¨‹å…±äº«çš„æœ¬è´¨å±æ€§ã€‚ ä¸ºä»€ä¹ˆå¼ºåˆ¶å¿…é¡»æ—¶å€™åremove()ï¼Ÿè¿™å—å¯ä»¥å’Œå†…å­˜æ³„éœ²ä¸€å—è¯´æ˜ï¼Œ é€šè¿‡ä¸Šé¢çš„ ThreadLocalMap å¤„å…³äºå¼±å¼•ç”¨çš„è®²è§£å·²ç»è¯´æ˜ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚è‡³äºå¦‚ä½•è§£å†³ä¹Ÿç»™å‡ºäº†ç­”æ¡ˆï¼š 1.set() æ—¶æ¸…é™¤ Entry != null &amp;&amp; key == null çš„èŠ‚ç‚¹ï¼Œ å°†å…¶ value è®¾ç½®ä¸º nullã€‚2.getEntry() æ—¶æ¸…é™¤å½“å‰ key åˆ° nextIndex(i, len)==null ä¹‹é—´çš„ Entry != null &amp;&amp; key == null çš„èŠ‚ç‚¹ï¼Œ å°†å…¶ value è®¾ç½®ä¸º nullã€‚3.remove() æ—¶æ¸…é™¤æŒ‡å®škeyçš„ Entry != null &amp;&amp; key == null çš„èŠ‚ç‚¹ï¼Œ å°†å…¶ value è®¾ç½®ä¸º nullã€‚ ä¹‹æ‰€ä»¥ä½¿ç”¨remove()ï¼Œè¿˜æ˜¯ä¸ºäº†è§£å†³å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚ Last ä½¿ç”¨æ—¶æ³¨æ„å£°æ˜ä¸º private static finalã€‚ ä½¿ç”¨åè¦ remove()ã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- ä»JUCæºç çœ‹CASï¼Œæˆ‘åšäº†ä¸ªç¬”è®° ......","slug":"source-code/java/CAS","date":"2020-06-12T15:50:20.000Z","updated":"2020-12-27T09:23:14.595Z","comments":true,"path":"2020/06/12/source-code-cas.html","link":"","permalink":"https://liuzhihang.com/2020/06/12/source-code-cas.html","excerpt":"","text":"å‰è¨€JUCåŒ…ä¸‹å¤§é‡ä½¿ç”¨äº†CASï¼Œå·¥ä½œå’Œé¢è¯•ä¸­ä¹Ÿç»å¸¸é‡åˆ°CASï¼ŒåŒ…æ‹¬è¯´åˆ°ä¹è§‚é”ï¼Œä¹Ÿä¸å¯é¿å…çš„æƒ³èµ·CASï¼Œé‚£CASç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿ æ¦‚å¿µè¯´åˆ°CASï¼ŒåŸºæœ¬ä¸Šéƒ½ä¼šæƒ³åˆ°ä¹è§‚é”ã€AtomicIntegerã€Unsafe â€¦ å½“ç„¶ä¹Ÿæœ‰å¯èƒ½å•¥ä¹Ÿæ²¡æƒ³åˆ°ï¼ ä¸ç®¡ä½ ä»¬æ€ä¹ˆæƒ³ï¼Œ æˆ‘ç¬¬ä¸€å°è±¡æ˜¯ä¹è§‚é”ï¼Œæ¯•ç«Ÿåšäº¤æ˜“æ›´æ–°äº¤æ˜“çŠ¶æ€ç»å¸¸ç”¨åˆ°ä¹è§‚é”ï¼Œå°±è‡ªç„¶æƒ³åˆ°è¿™ä¸ªSQLï¼š update trans_order set order_status = 1 where order_no = &#x27;xxxxxxxxxxx&#x27; and order_status = 0; å…¶å®å°±æ˜¯ setå’Œwhereé‡Œé¢éƒ½æºå¸¦order_statusã€‚ é‚£ä»€ä¹ˆæ˜¯CASï¼Ÿ CASå°±æ˜¯Compare-and-Swapï¼Œå³æ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œåœ¨å¹¶å‘ç®—æ³•æ—¶å¸¸ç”¨ï¼Œå¹¶ä¸”åœ¨JUCï¼ˆjava.util.concurrentï¼‰åŒ…ä¸‹å¾ˆå¤šç±»éƒ½ä½¿ç”¨äº†CASã€‚ éå¸¸å¸¸è§çš„é—®é¢˜å°±æ˜¯å¤šçº¿ç¨‹æ“ä½œi++é—®é¢˜ã€‚ä¸€èˆ¬è§£å†³åŠæ³•å°±æ˜¯æ·»åŠ  synchronized å…³é”®å­—ä¿®é¥°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ AtomicInteger ä»£ç ä¸¾ä¾‹å¦‚ä¸‹ï¼š public class CasTest &#123; private static final CountDownLatch LATCH = new CountDownLatch(10); private static int NUM_I = 0; private static volatile int NUM_J = 0; private static final AtomicInteger NUM_K = new AtomicInteger(0); public static void main(String[] args) throws InterruptedException &#123; ExecutorService threadPool = Executors.newFixedThreadPool(10); for (int i = 0; i &lt; 10; i++) &#123; threadPool.execute(new Runnable() &#123; public void run() &#123; for (int j = 0; j &lt; 10000; j++) &#123; NUM_I++; NUM_J++; NUM_K.incrementAndGet(); &#125; LATCH.countDown(); &#125; &#125;); &#125; LATCH.await(); System.out.println(&quot;NUM_I = &quot; + NUM_I); System.out.println(&quot;NUM_J = &quot; + NUM_J); System.out.println(&quot;NUM_K = &quot; + NUM_K.get()); threadPool.shutdown(); &#125;&#125; ä¸‹é¢å°±ä»AtomicIntegerå¼€å§‹äº†è§£CASã€‚ æºç åˆ†æpublic class AtomicInteger extends Number implements java.io.Serializable &#123; private static final long serialVersionUID = 6214790243416807050L; // setup to use Unsafe.compareAndSwapInt for updates private static final Unsafe unsafe = Unsafe.getUnsafe(); private static final long valueOffset; static &#123; try &#123; valueOffset = unsafe.objectFieldOffset (AtomicInteger.class.getDeclaredField(&quot;value&quot;)); &#125; catch (Exception ex) &#123; throw new Error(ex); &#125; &#125; private volatile int value; public final int incrementAndGet() &#123; return unsafe.getAndAddInt(this, valueOffset, 1) + 1; &#125; public final int decrementAndGet() &#123; return unsafe.getAndAddInt(this, valueOffset, -1) - 1; &#125;&#125; å¯ä»¥çœ‹å‡ºé‡Œé¢ä½¿ç”¨äº†Unsafeç±»ä¸‹çš„getAndAddIntæ–¹æ³•ï¼ŒUnsafeç±»å¾ˆå¤šæ–¹æ³•æ˜¯æœ¬åœ°ï¼ˆnativeï¼‰æ–¹æ³•ï¼Œä¸»è¦æ˜¯ç¡¬ä»¶çº§åˆ«çš„åŸå­æ“ä½œã€‚ /** * @param var1 å½“å‰å¯¹è±¡ * @param var2 å½“å‰å¯¹è±¡åœ¨å†…å­˜åç§»é‡ï¼ŒUnsafeå¯ä»¥æ ¹æ®å†…å­˜åç§»åœ°å€è·å–æ•°æ® * @param var4 æ“ä½œå€¼ * @return */public final int getAndAddInt(Object var1, long var2, int var4) &#123; int var5; do &#123; // è·å–åœ¨var1åœ¨å†…å­˜çš„å€¼ var5 = this.getIntVolatile(var1, var2); // å°†var1èµ‹å€¼ä¸ºvar5+var4ï¼Œ èµ‹å€¼æ—¶ä¼šåˆ¤æ–­var1æ˜¯å¦ä¸ºvar5 &#125; while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4)); return var5;&#125;// åŸå­æ“ä½œpublic final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5); è‡³äº compareAndSwapInt çš„åˆ†æå°±å¿½ç•¥äº†ã€‚ çœ‹å®Œä»£ç è¿‡ç¨‹å…¶å®å°±æ˜¯ï¼š æ¯”è¾ƒvar1çš„å€¼æ˜¯å¦ä¸ºvar4ï¼Œæ˜¯çš„è¯å°†var1æ›´æ–°ä¸ºvar5ã€‚ å¦‚æœä¸æ˜¯çš„è¯å°±ä¸€ç›´å¾ªç¯ï¼Œç›´åˆ°var1æ˜¯var4ã€‚ é—®é¢˜ è¿™è¦æ˜¯ä¸€ç›´è·å–ä¸åˆ°ï¼Œå²‚ä¸æ˜¯ä¸€ç›´å¾ªç¯ã€‚çº¿ç¨‹å¤šçš„æƒ…å†µä¸‹ï¼Œä¼šè‡ªæ—‹å¾ˆé•¿æ—¶é—´ï¼Œå¯¼è‡´æµªè´¹èµ„æºã€‚ ä½ æ›´æ–°äº†ï¼Œ æˆ‘åˆç»™ä½ æ›´æ–°å›å»äº†ï¼Œä½ ä¹Ÿä¸çŸ¥é“ã€‚ABAé—®é¢˜ï¼æ¯”å¦‚åƒè¿™æ ·ï¼ŒAæƒ³æ›´æ–°å€¼ä¸ºaï¼Œè¿˜æœªæŠ¢åˆ°èµ„æºï¼Œè¿™æ—¶å€™Bè¿›è¡Œäº†æ›´æ–°ï¼Œå°†å¯¹è±¡æ›´æ–°ä¸ºäº†bï¼Œç„¶ååˆé©¬ä¸Šæ›´æ–°å›äº†aï¼Œ è¿™æ—¶å€™Aæ˜¯ä»€ä¹ˆéƒ½ä¸çŸ¥é“çš„ã€‚ ä»¥ä¹è§‚é”ä¸¾ä¾‹ï¼š -- 0 -&gt; 1update trans_order set order_status = 1 where order_no = &#x27;xxxxxxxxxxx&#x27; and order_status = 0;-- 1 -&gt; 0update trans_order set order_status = 1 where order_no = &#x27;xxxxxxxxxxx&#x27; and order_status = 0;-- 0 -&gt; 1update trans_order set order_status = 1 where order_no = &#x27;xxxxxxxxxxx&#x27; and order_status = 0; è§£å†³åŠæ³•å¯ä»¥æ·»åŠ versionè¿›è¡Œç‰ˆæœ¬å·æ§åˆ¶ã€‚ -- 0 -&gt; 1update trans_order set order_status = 1 where order_no = &#x27;xxxxxxxxxxx&#x27; and order_status = 0 and version = 0;-- 1 -&gt; 0update trans_order set order_status = 1 where order_no = &#x27;xxxxxxxxxxx&#x27; and order_status = 0 and version = 1;-- 0 -&gt; 1update trans_order set order_status = 1 where order_no = &#x27;xxxxxxxxxxx&#x27; and order_status = 0 and version = 0; ä»£ç ä¸­å¯ä»¥çœ‹ AtomicStampedReference ç±»ï¼š /** * ä»¥åŸå­æ–¹å¼è®¾ç½®è¯¥å¼•ç”¨å’Œæ ‡å¿—ç»™å®šçš„æ›´æ–°å€¼çš„å€¼ï¼Œ * å¦‚æœå½“å‰å¼•ç”¨==é¢„æœŸçš„å¼•ç”¨ï¼Œå¹¶ä¸”å½“å‰æ ‡å¿—==é¢„æœŸæ ‡å¿—ã€‚ * * @param expectedReference é¢„æœŸå¼•ç”¨ * @param newReference æ›´æ–°çš„å€¼ * @param expectedStamp é¢„æœŸæ ‡å¿— * @param newStamp æ›´æ–°çš„æ ‡å¿— * @return &#123;@code true&#125; if successful */public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp) &#123; Pair&lt;V&gt; current = pair; return expectedReference == current.reference &amp;&amp; expectedStamp == current.stamp &amp;&amp; ((newReference == current.reference &amp;&amp; newStamp == current.stamp) || casPair(current, Pair.of(newReference, newStamp)));&#125; å…¶å®å°±æ˜¯é¢å¤–å¢åŠ ä¸€ä¸ªæ ‡å¿—ï¼ˆstampï¼‰æ¥é˜²æ­¢ABAçš„é—®é¢˜ï¼Œ ç±»ä¼¼ä¹è§‚é”çš„versionã€‚","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- HashMapçº¢é»‘æ ‘","slug":"source-code/java/HashMapçº¢é»‘æ•°","date":"2020-05-25T12:50:20.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/05/25/source-code-hashmap-red-black-tree.html","link":"","permalink":"https://liuzhihang.com/2020/05/25/source-code-hashmap-red-black-tree.html","excerpt":"","text":"å‰è¨€åœ¨é˜…è¯»HashMapæºç æ—¶ï¼Œä¼šå‘ç°åœ¨HashMapä¸­ä½¿ç”¨äº†çº¢é»‘æ ‘ï¼Œæ‰€ä»¥éœ€è¦å…ˆäº†è§£ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Œä»¥åŠå…¶åŸç†ã€‚ä»è€Œå†è¿›ä¸€æ­¥é˜…è¯»HashMapä¸­çš„é“¾è¡¨åˆ°çº¢é»‘æ ‘çš„è½¬æ¢ï¼Œçº¢é»‘æ ‘çš„å¢åˆ èŠ‚ç‚¹ç­‰ã€‚ ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿ åœ¨HashMapä¸­æ˜¯æ€ä¹ˆåº”ç”¨çš„ï¼Ÿ ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿ çº¢é»‘æ ‘ï¼ˆè‹±è¯­ï¼šRedâ€“black treeï¼‰æ˜¯ä¸€ç§è‡ªå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ˜¯åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ç”¨åˆ°çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå…¸å‹çš„ç”¨é€”æ˜¯å®ç°å…³è”æ•°ç»„ã€‚å®ƒåœ¨1972å¹´ç”±é²é“å¤«Â·è´å°”å‘æ˜ï¼Œè¢«ç§°ä¸ºâ€å¯¹ç§°äºŒå‰Bæ ‘â€ï¼Œå®ƒç°ä»£çš„åå­—æºäºLeo J. Guibaså’ŒRobert Sedgewickäº1978å¹´å†™çš„ä¸€ç¯‡è®ºæ–‡ã€‚çº¢é»‘æ ‘çš„ç»“æ„å¤æ‚ï¼Œä½†å®ƒçš„æ“ä½œæœ‰ç€è‰¯å¥½çš„æœ€åæƒ…å†µè¿è¡Œæ—¶é—´ï¼Œå¹¶ä¸”åœ¨å®è·µä¸­é«˜æ•ˆï¼šå®ƒå¯ä»¥åœ¨O(logN)æ—¶é—´å†…å®ŒæˆæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤ï¼Œè¿™é‡Œçš„næ˜¯æ ‘ä¸­å…ƒç´ çš„æ•°ç›®ã€‚ çº¢é»‘æ ‘çš„æ€§è´¨çº¢é»‘æ ‘æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½å¸¦æœ‰é¢œè‰²å±æ€§çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œé¢œè‰²ä¸ºçº¢è‰²æˆ–é»‘è‰²ã€‚åœ¨äºŒå‰æŸ¥æ‰¾æ ‘å¼ºåˆ¶ä¸€èˆ¬è¦æ±‚ä»¥å¤–ï¼Œå¯¹äºä»»ä½•æœ‰æ•ˆçš„çº¢é»‘æ ‘æˆ‘ä»¬å¢åŠ äº†å¦‚ä¸‹çš„é¢å¤–è¦æ±‚ï¼š èŠ‚ç‚¹æ˜¯çº¢è‰²æˆ–é»‘è‰²ã€‚ æ ¹æ˜¯é»‘è‰²ã€‚ æ‰€æœ‰å¶å­éƒ½æ˜¯é»‘è‰²ï¼ˆå¶å­æ˜¯NILèŠ‚ç‚¹ï¼‰ã€‚ æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹å¿…é¡»æœ‰ä¸¤ä¸ªé»‘è‰²çš„å­èŠ‚ç‚¹ã€‚ï¼ˆä»æ¯ä¸ªå¶å­åˆ°æ ¹çš„æ‰€æœ‰è·¯å¾„ä¸Šä¸èƒ½æœ‰ä¸¤ä¸ªè¿ç»­çš„çº¢è‰²èŠ‚ç‚¹ã€‚ï¼‰ ä»ä»»ä¸€èŠ‚ç‚¹åˆ°å…¶æ¯ä¸ªå¶å­çš„æ‰€æœ‰ç®€å•è·¯å¾„éƒ½åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ã€‚ çº¢é»‘æ ‘æ“ä½œå·¦æ—‹ã€å³æ—‹ æ’å…¥ ä»¥äºŒå‰æŸ¥æ‰¾æ ‘çš„æ–¹æ³•å¢åŠ èŠ‚ç‚¹ æ–°æ’å…¥èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼ˆå¦‚æœè®¾ä¸ºé»‘è‰²ï¼Œå°±ä¼šå¯¼è‡´æ ¹åˆ°å¶å­çš„è·¯å¾„ä¸Šæœ‰ä¸€æ¡è·¯ä¸Šï¼Œå¤šä¸€ä¸ªé¢å¤–çš„é»‘èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ˜¯å¾ˆéš¾è°ƒæ•´çš„ã€‚ä½†æ˜¯è®¾ä¸ºçº¢è‰²èŠ‚ç‚¹åï¼Œå¯èƒ½ä¼šå¯¼è‡´å‡ºç°ä¸¤ä¸ªè¿ç»­çº¢è‰²èŠ‚ç‚¹çš„å†²çªï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡é¢œè‰²è°ƒæ¢ï¼ˆcolor flipsï¼‰å’Œæ ‘æ—‹è½¬æ¥è°ƒæ•´ã€‚ï¼‰ æ³¨æ„ï¼š æ€§è´¨1å’Œæ€§è´¨3æ˜¯æ°¸è¿œä¿æŒç€çš„ã€‚ æ€§è´¨4åªåœ¨å¢åŠ çº¢è‰²èŠ‚ç‚¹ã€é‡ç»˜é»‘è‰²èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œæˆ–åšæ—‹è½¬æ—¶å—åˆ°å¨èƒã€‚ æ€§è´¨5åªåœ¨å¢åŠ é»‘è‰²èŠ‚ç‚¹ã€é‡ç»˜çº¢è‰²èŠ‚ç‚¹ä¸ºé»‘è‰²ï¼Œæˆ–åšæ—‹è½¬æ—¶å—åˆ°å¨èƒã€‚ æ’å…¥æ—¶ä¼šé‡åˆ°ä»¥ä¸‹äº”ç§æƒ…å½¢ï¼š æƒ…å½¢1ï¼šæ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æƒ…å½¢2ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²æƒ…å½¢3ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²æƒ…å½¢4ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²æˆ–ç¼ºçœï¼Œæ–°èŠ‚ç‚¹æ˜¯å³å­èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹åˆæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹æƒ…å½¢5ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²æˆ–ç¼ºçœï¼Œæ–°èŠ‚ç‚¹æ˜¯å·¦å­èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹åˆæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ã€‚ æƒ…å½¢1ï¼š æ“ä½œï¼šæ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è¿åæ€§è´¨2ï¼šâ€ æ ¹æ˜¯é»‘è‰²ã€‚ â€œæƒ…å½¢ï¼šç›´æ¥æ’å…¥çº¢è‰²èŠ‚ç‚¹ï¼Œç„¶åè¿›è¡ŒæŸ“è‰²ä¸ºé»‘è‰² æƒ…å½¢2ï¼š æ“ä½œï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²æœªè¿åæ€§è´¨æƒ…å½¢ï¼šç›´æ¥æ’å…¥ æƒ…å½¢3ï¼š æ“ä½œï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²è¿åæ€§è´¨4ï¼šâ€ æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹å¿…é¡»æœ‰ä¸¤ä¸ªé»‘è‰²çš„å­èŠ‚ç‚¹ã€‚ â€œæƒ…å½¢ï¼šå°†ç¥–çˆ¶èŠ‚ç‚¹æŸ“è‰²ï¼Œç¥–çˆ¶èŠ‚ç‚¹æŸ“è‰²åå†è¿›è¡Œé‡æ–°åˆ¤æ–­è¿›è¡ŒæŸ“è‰²æˆ–æ—‹è½¬ æƒ…å½¢4ï¼š æ“ä½œï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²æˆ–ç¼ºçœï¼Œæ–°èŠ‚ç‚¹æ˜¯å³å­èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹åˆæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹è¿åæ€§è´¨4ï¼šâ€ æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹å¿…é¡»æœ‰ä¸¤ä¸ªé»‘è‰²çš„å­èŠ‚ç‚¹ã€‚ â€œæƒ…å½¢ï¼šè¿›è¡Œå·¦æ—‹ï¼Œæ—‹è½¬åçˆ¶èŠ‚ç‚¹å˜æˆå·¦å­èŠ‚ç‚¹ï¼Œæ–°èŠ‚ç‚¹å˜æˆçˆ¶èŠ‚ç‚¹ï¼Œç„¶åé‡æ–°åˆ¤æ–­è¿›è¡ŒæŸ“è‰²æˆ–æ—‹è½¬ æƒ…å½¢5ï¼š æ“ä½œï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²æˆ–ç¼ºçœï¼Œæ–°èŠ‚ç‚¹æ˜¯å·¦å­èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹åˆæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ã€‚è¿åæ€§è´¨4ï¼šâ€ æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹å¿…é¡»æœ‰ä¸¤ä¸ªé»‘è‰²çš„å­èŠ‚ç‚¹ã€‚ â€œæƒ…å½¢ï¼šçˆ¶èŠ‚ç‚¹æŸ“è‰²ä¸ºé»‘è‰²ï¼Œè¿›è¡Œå³æ—‹ï¼Œç¥–çˆ¶èŠ‚ç‚¹å˜ä¸ºå³å­èŠ‚ç‚¹ï¼Œç„¶åé‡æ–°åˆ¤æ–­è¿›è¡ŒæŸ“è‰²æˆ–æ—‹è½¬ HashMapç»“æ„static final class TreeNode&lt;K,V&gt; extends LinkedHashMap.Entry&lt;K,V&gt; &#123; TreeNode&lt;K,V&gt; parent; // red-black tree links TreeNode&lt;K,V&gt; left; TreeNode&lt;K,V&gt; right; TreeNode&lt;K,V&gt; prev; // needed to unlink next upon deletion boolean red; // ... çœç•¥&#125; ä¸‰ä¸ªå‚æ•°/** * é“¾è¡¨è½¬ä¸ºæ ‘é˜ˆå€¼ã€‚ * å¤§äºç­‰äº8æ—¶ï¼Œä¼šè½¬æ¢ä¸ºæ ‘ã€‚ * 8 æ˜¯ç»¼åˆæ€§èƒ½è€ƒè™‘ç¡®å®šçš„å€¼ */static final int TREEIFY_THRESHOLD = 8;/** * ä»æ ‘è½¬æ¢ä¸ºé“¾è¡¨çš„é˜ˆå€¼ */static final int UNTREEIFY_THRESHOLD = 6;/** * æœ€å°æ ‘å½¢åŒ–å®¹é‡ï¼Œåªæœ‰å“ˆå¸Œè¡¨å…ƒç´ æ•°åˆ°è¾¾64æ‰ä¼šè¿›è¡Œæ ‘è½¬æ¢ */static final int MIN_TREEIFY_CAPACITY = 64; é“¾è¡¨è½¬çº¢é»‘æ ‘-treeifyBin æ•°ç»„ï¼ˆå“ˆå¸Œè¡¨ï¼‰é•¿åº¦åˆ°è¾¾64 å½“é“¾è¡¨é•¿åº¦å¤§äºç­‰äº8æ˜¯ä¼šå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ final void treeifyBin(Node&lt;K,V&gt;[] tab, int hash) &#123; int n, index; Node&lt;K,V&gt; e; // æ•°ç»„ä¸ºnullæˆ–è€…æ•°ç»„é•¿åº¦å°äºMIN_TREEIFY_CAPACITYï¼ˆ64ï¼‰æ—¶ï¼Œè¿›è¡Œæ‰©å®¹ if (tab == null || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY) resize(); else if ((e = tab[index = (n - 1) &amp; hash]) != null) &#123; // å¤´å°¾èŠ‚ç‚¹ hd-å¤´ tl-å°¾ TreeNode&lt;K,V&gt; hd = null, tl = null; do &#123; // åˆ›å»ºæ ‘èŠ‚ç‚¹ Node -&gt; TreeNode // å¾ªç¯æ‰§è¡Œå®Œä¹‹åå¾—åˆ°çš„æ˜¯åŒå‘é“¾è¡¨ TreeNode&lt;K,V&gt; p = replacementTreeNode(e, null); if (tl == null) hd = p; else &#123; p.prev = tl; tl.next = p; &#125; tl = p; &#125; while ((e = e.next) != null); // æ­¤æ—¶å¾—åˆ°çš„ä»…ä»…æ˜¯åŒå‘é“¾è¡¨ // æŒ‡é’ˆæŒ‡å‘é“¾è¡¨å¤´ if ((tab[index] = hd) != null) // å°†åŒå‘é“¾è¡¨è½¬æ¢ä¸ºæ ‘ hd.treeify(tab); &#125;&#125; final void treeify(Node&lt;K,V&gt;[] tab) &#123; TreeNode&lt;K,V&gt; root = null; for (TreeNode&lt;K,V&gt; x = this, next; x != null; x = next) &#123; next = (TreeNode&lt;K,V&gt;)x.next; x.left = x.right = null; if (root == null) &#123; // æƒ…å½¢1ï¼šæ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ x.parent = null; x.red = false; root = x; &#125; else &#123; // å½“å‰èŠ‚ç‚¹çš„ key å’Œ hash K k = x.key; int h = x.hash; Class&lt;?&gt; kc = null; // å†æ¬¡å¾ªç¯ for (TreeNode&lt;K,V&gt; p = root;;) &#123; int dir, ph; // å†…å±‚å¾ªç¯çš„key K pk = p.key; // å½“å‰èŠ‚ç‚¹çš„hashå’Œå†…å±‚å¾ªç¯çš„hashå€¼ä½œæ¯”è¾ƒ if ((ph = p.hash) &gt; h) // &lt; 0 leftæŸ¥æ‰¾ dir = -1; else if (ph &lt; h) // &gt; 0 right æŸ¥æ‰¾ dir = 1; else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) // æ¯”è¾ƒå¯¹è±¡ dir = tieBreakOrder(k, pk); TreeNode&lt;K,V&gt; xp = p; // dir &lt;= 0 åˆ™èµ° leftæŸ¥æ‰¾ &gt; 0 åˆ™èµ° rightæŸ¥æ‰¾ if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; x.parent = xp; if (dir &lt;= 0) xp.left = x; else xp.right = x; // æ­£å¼è½¬æ¢ä¸ºçº¢é»‘æ ‘ root = balanceInsertion(root, x); break; &#125; &#125; &#125; &#125; moveRootToFront(tab, root);&#125; // root æ ¹èŠ‚ç‚¹// x è¦æ“ä½œçš„èŠ‚ç‚¹static &lt;K,V&gt; TreeNode&lt;K,V&gt; balanceInsertion(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; x) &#123; // é»˜è®¤èŠ‚ç‚¹ä¸ºçº¢è‰² x.red = true; // xpï¼šxçš„çˆ¶èŠ‚ç‚¹ // xppï¼šxçš„ç¥–çˆ¶èŠ‚ç‚¹ // xpplï¼šxç¥–çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ // xpprï¼šxç¥–çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ for (TreeNode&lt;K,V&gt; xp, xpp, xppl, xppr;;) &#123; // æƒ…å½¢1ï¼š çˆ¶èŠ‚ç‚¹ä¸ºnullï¼Œ ç›´æ¥ç½®ä¸ºæ ¹ if ((xp = x.parent) == null) &#123; x.red = false; return x; &#125; // çˆ¶èŠ‚ç‚¹é»‘è‰² æˆ–è€… ç¥–çˆ¶èŠ‚ç‚¹ä¸ºç©ºï¼Œç›´æ¥è¿”å› // æƒ…å½¢2ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰² else if (!xp.red || (xpp = xp.parent) == null) return root; // çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ if (xp == (xppl = xpp.left)) &#123; // ç¥–çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸ä¸ºç©ºä¸”æ˜¯çº¢è‰² // æƒ…å½¢3ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰² if ((xppr = xpp.right) != null &amp;&amp; xppr.red) &#123; xppr.red = false; //ç¥–çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰² xp.red = false; // çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰² xpp.red = true; // ç¥–çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºçº¢è‰² x = xpp; // ç»§ç»­æ“ä½œç¥–çˆ¶èŠ‚ç‚¹ &#125; // æ—‹è½¬ else &#123; // æ–°æ’å…¥çš„æ˜¯å³å­èŠ‚ç‚¹ if (x == xp.right) &#123; // æ’å…¥çš„xæ˜¯çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œ è¿›è¡Œå·¦æ—‹ root = rotateLeft(root, x = xp); xpp = (xp = x.parent) == null ? null : xp.parent; &#125; if (xp != null) &#123; // çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰² xp.red = false; if (xpp != null) &#123; xpp.red = true; // å³æ—‹ root = rotateRight(root, xpp); &#125; &#125; &#125; &#125; // çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ else &#123; // ç¥–çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸ä¸ºç©ºä¸”ä¸ºçº¢è‰² if (xppl != null &amp;&amp; xppl.red) &#123; xppl.red = false; // ç¥–çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰² xp.red = false; // çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰² xpp.red = true; // ç¥–çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºçº¢è‰² x = xpp; // ç»§ç»­æ“ä½œç¥–çˆ¶èŠ‚ç‚¹ &#125; // æ—‹è½¬ else &#123; if (x == xp.left) &#123; root = rotateRight(root, x = xp); xpp = (xp = x.parent) == null ? null : xp.parent; &#125; if (xp != null) &#123; xp.red = false; if (xpp != null) &#123; xpp.red = true; root = rotateLeft(root, xpp); &#125; &#125; &#125; &#125; &#125;&#125;","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- HashMapæ‰©å®¹","slug":"source-code/java/HashMapæ‰©å®¹","date":"2020-05-17T12:50:20.000Z","updated":"2020-12-27T09:23:14.595Z","comments":true,"path":"2020/05/17/source-code-hashmap-resize.html","link":"","permalink":"https://liuzhihang.com/2020/05/17/source-code-hashmap-resize.html","excerpt":"","text":"æè¿°ä¸‹HashMap put(k,v)çš„æµç¨‹ï¼Ÿå®ƒçš„æ‰©å®¹æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ HashMap put(k,v)æµç¨‹ é€šè¿‡hash(keyæ–¹æ³•)è·å–åˆ°keyçš„hashå€¼ è°ƒç”¨putæ–¹æ³•, å°†valueå­˜æ”¾åˆ°æŒ‡å®šçš„ä½ç½® æ ¹æ®hashå€¼ç¡®å®šå½“å‰keyæ‰€åœ¨nodeæ•°ç»„çš„ç´¢å¼• (n - 1) &amp; hash å¦‚æœnode[i]==null åˆ™ç›´æ¥åˆ›å»ºæ–°æ•°ç»„ å¦‚æœnode[i]!=null åˆ¤æ–­ å½“å‰nodeçš„å¤´ç»“ç‚¹çš„ hashå’Œkeyæ˜¯å¦éƒ½ç›¸ç­‰, ç›¸ç­‰åˆ™éœ€è¦æ“ä½œçš„å°±æ˜¯è¯¥node åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºTreeNodeï¼Œå¯¹TreeNodeè¿›è¡Œæ“ä½œï¼Œå¹¶è¿”å›ç»“æœe å¦‚æœæ˜¯é“¾è¡¨åˆ™éå†é“¾è¡¨ï¼Œkeyå­˜åœ¨åˆ™è¿”å›èŠ‚ç‚¹eï¼Œä¸å­˜åœ¨åˆ™èµ‹å€¼ åˆ¤æ–­èŠ‚ç‚¹eæœ‰æ²¡æœ‰è¢«èµ‹å€¼ï¼Œè¦†ç›–æ—§å€¼ hashMap sizeè¿›è¡ŒåŠ 1ï¼ŒåŒæ—¶åˆ¤æ–­væ–°sizeæ˜¯å¦å¤§äºæ‰©å®¹é˜ˆå€¼ä»è€Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ public V put(K key, V value) &#123; return putVal(hash(key), key, value, false, true);&#125; final V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict) &#123; // å£°æ˜Nodeæ•°ç»„tab, NodeèŠ‚ç‚¹ Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, i; // å¯¹tabæ•°ç»„èµ‹å€¼ä¸ºå½“å‰HashMapçš„table, å¹¶åˆ¤æ–­æ˜¯å¦ä¸ºç©º, æˆ–è€…é•¿åº¦ä¸º0 // ä¸º0è¿›è¡Œåˆ™resize()æ•°ç»„, å¹¶å¯¹ nèµ‹å€¼ä¸ºå½“å‰tabçš„é•¿åº¦ // resize() å¯¹HashMapçš„tableæ‰©å®¹, å¹¶è¿”å›æ‰©å®¹åçš„æ–°æ•°ç»„ if ((tab = table) == null || (n = tab.length) == 0) n = (tab = resize()).length; // å¯¹ node p è¿›è¡Œèµ‹å€¼, æ•°ç»„æ‰€åœ¨ä½ç½® å³ node p å¦‚æœæ˜¯null åˆ™ç›´æ¥èµ‹å€¼ if ((p = tab[i = (n - 1) &amp; hash]) == null) tab[i] = newNode(hash, key, value, null); else &#123; // p ä¸ä¸ºnull, å£°æ˜ node e, key k Node&lt;K,V&gt; e; K k; // å¦‚æœhashå€¼ç›¸ç­‰ä¸”keyç›¸ç­‰, ç›´æ¥å°† e èµ‹å€¼ä¸ºå½“å‰nodeçš„å¤´èŠ‚ç‚¹ if (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != null &amp;&amp; key.equals(k)))) e = p; else if (p instanceof TreeNode) // å¦‚æœæ˜¯çº¢é»‘æ ‘, åˆ™å¯¹æ ‘è¿›è¡Œæ“ä½œ, è¿”å›èŠ‚ç‚¹e e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value); else &#123; // å¯¹é“¾è¡¨è¿›è¡Œéå†, æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ for (int binCount = 0; ; ++binCount) &#123; // å°† e èµ‹å€¼ä¸º å¤´èŠ‚ç‚¹pçš„next, å¦‚æœä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºnull if ((e = p.next) == null) &#123; // å¯¹èŠ‚ç‚¹è¿›è¡Œèµ‹å€¼ p.next = newNode(hash, key, value, null); // å¦‚æœé•¿åº¦åˆ°è¾¾æ•°è½¬æ¢é˜ˆå€¼, åˆ™éœ€è¦è½¬æ¢ä¸ºçº¢é»‘æ ‘ if (binCount &gt;= TREEIFY_THRESHOLD - 1) // -1 for 1st treeifyBin(tab, hash); break; &#125; // å¦‚æœeèŠ‚ç‚¹çš„hashç›¸ç­‰, keyç›¸ç­‰, åˆ™ ç›´æ¥è·³å‡ºå¾ªç¯ e å·²ç»è¢«èµ‹å€¼ä¸º p.next // æ­¤æ—¶eèŠ‚ç‚¹çš„valueæ²¡æœ‰è¢«èµ‹å€¼ if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) break; // æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹, ç»§ç»­éå† p = e; &#125; &#125; if (e != null) &#123; // existing mapping for key V oldValue = e.value; // å¯¹æ—§å€¼è¿›è¡Œè¦†ç›–, å¹¶è¿”å›æ—§å€¼ if (!onlyIfAbsent || oldValue == null) e.value = value; afterNodeAccess(e); return oldValue; &#125; &#125; ++modCount; // æ˜¯å¦éœ€è¦æ‰©å®¹ if (++size &gt; threshold) resize(); afterNodeInsertion(evict); return null; &#125; resize()æ‰©å®¹è¿‡ç¨‹ JDK 1.7 æ‰©å®¹æµç¨‹, æ¯æ¬¡éƒ½éœ€è¦æ•°ç»„æ‰©å®¹å, é“¾è¡¨éœ€è¦é‡æ–°è®¡ç®—åœ¨æ–°æ•°ç»„çš„ä½ç½® JDK 1.8 ä¸éœ€è¦é‡æ–°è®¡ç®— (ä¼˜åŒ–ç‚¹) æ•°ç»„ä¸‹æ ‡: (n - 1) &amp; hash å³æ•°ç»„é•¿åº¦-1 &amp; keyçš„hash æ‰©å®¹åçš„æ•°ç»„ä¸‹æ ‡: ((n &lt;&lt; 1) - 1) &amp; hash ç›¸å½“äºåœ¨ é«˜ä½1ä¹‹å‰åŠ äº†ä¸ª1 å¦‚å›¾æ‰€ç¤º, çœŸæ­£å‘ç”Ÿå½±å“çš„æ˜¯æ–°å¢çš„é‚£ä¸€ä½(çº¢è‰²ç®­å¤´æ‰€æŒ‡), æ‰€ä»¥ oldCap &amp; hash å®Œå…¨å¯ä»¥åˆ¤æ–­è¯¥å€¼æ˜¯æ”¾åœ¨æ—§ç´¢å¼•å€¼çš„ä½ç½®è¿˜æ˜¯æ”¾åœ¨æ—§ç´¢å¼•å€¼+æ—§æ•°ç»„é•¿åº¦çš„ä½ç½® final Node&lt;K,V&gt;[] resize() &#123; // æ—§æ•°ç»„ Node&lt;K,V&gt;[] oldTab = table; // æ—§æ•°ç»„é•¿åº¦ int oldCap = (oldTab == null) ? 0 : oldTab.length; // æ—§çš„æ‰©å®¹é˜ˆå€¼ int oldThr = threshold; // æ–°çš„æ•°ç»„é•¿åº¦å’Œæ–°æ‰©å®¹é˜ˆå€¼ int newCap, newThr = 0; // æ—§æ•°ç»„å­˜åœ¨ if (oldCap &gt; 0) &#123; if (oldCap &gt;= MAXIMUM_CAPACITY) &#123; threshold = Integer.MAX_VALUE; return oldTab; &#125; // æ–°æ•°ç»„é•¿åº¦ä¸ºæ—§æ•°ç»„é•¿åº¦çš„2å€ else if ((newCap = oldCap &lt;&lt; 1) &lt; MAXIMUM_CAPACITY &amp;&amp; oldCap &gt;= DEFAULT_INITIAL_CAPACITY) // æ‰©å®¹é˜ˆå€¼æ˜¯æ—§æ‰©å®¹é˜ˆå€¼çš„2å€ newThr = oldThr &lt;&lt; 1; // double threshold &#125; // æ—§æ•°ç»„ä¸å­˜åœ¨, ç›¸å½“äºé¦–æ¬¡put(K, V)æ—¶, å°†æ•°ç»„é•¿åº¦ç½®ä¸ºæ‰©å®¹é˜ˆå€¼ else if (oldThr &gt; 0) // initial capacity was placed in threshold newCap = oldThr; else &#123; // zero initial threshold signifies using defaults // æ—§æ•°ç»„ä¸å­˜åœ¨, new HashMap()æœªæŒ‡å®šé•¿åº¦, åˆæ¬¡put(K, V), è®¾ç½®ä¸ºé»˜è®¤å€¼ newCap = DEFAULT_INITIAL_CAPACITY; newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY); &#125; // æ–°çš„æ‰©å®¹é˜ˆå€¼æ˜¯0, åˆ™å°†æ‰©å®¹é˜ˆå€¼è®¾ç½®ä¸º æ–°æ•°ç»„é•¿åº¦*è´Ÿè½½å› å­ if (newThr == 0) &#123; float ft = (float)newCap * loadFactor; newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (float)MAXIMUM_CAPACITY ? (int)ft : Integer.MAX_VALUE); &#125; // å¯¹å…¨å±€çš„æ‰©å®¹é˜ˆå€¼è¿›è¡Œèµ‹å€¼ threshold = newThr; @SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;) // åˆ›å»ºæ–°æ•°ç»„, é•¿åº¦ä¸ºæ–°é•¿åº¦, å³åŸæ•°ç»„é•¿åº¦çš„2å€ Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])new Node[newCap]; // å°†tableå¤åˆ¶ä¸ºæ–°æ•°ç»„ table = newTab; if (oldTab != null) &#123; // å¯¹æ—§æ•°ç»„è¿›è¡Œéå† for (int j = 0; j &lt; oldCap; ++j) &#123; Node&lt;K,V&gt; e; // æ—§èŠ‚ç‚¹nodeèµ‹å€¼ if ((e = oldTab[j]) != null) &#123; oldTab[j] = null; if (e.next == null) // åªæœ‰å¤´ç»“ç‚¹, ç›´æ¥è®¡ç®—æ–°çš„ä½ç½®å¹¶èµ‹å€¼ newTab[e.hash &amp; (newCap - 1)] = e; else if (e instanceof TreeNode) // æ ‘å•ç‹¬å¤„ç† ((TreeNode&lt;K,V&gt;)e).split(this, newTab, j, oldCap); else &#123; // preserve order Node&lt;K,V&gt; loHead = null, loTail = null; Node&lt;K,V&gt; hiHead = null, hiTail = null; Node&lt;K,V&gt; next; do &#123; // nextèŠ‚ç‚¹ next = e.next; // èŠ‚ç‚¹hashä¸æ—§æ•°ç»„é•¿åº¦ &amp; çš„ç»“æœæ¥å†³å®šå…ƒç´ æ‰€åœ¨ä½ç½®, å‚è€ƒä¸Šé¢å›¾ç¤ºæ‰€è®² if ((e.hash &amp; oldCap) == 0) &#123; // åœ¨å…ƒç´¢å¼•å‡ºåˆ›å»ºæ–°é“¾è¡¨ if (loTail == null) loHead = e; else loTail.next = e; loTail = e; &#125; else &#123; // æ–°ç´¢å¼•å‡ºåˆ›å»ºé“¾è¡¨ if (hiTail == null) hiHead = e; else hiTail.next = e; hiTail = e; &#125; &#125; while ((e = next) != null); if (loTail != null) &#123; loTail.next = null; // ç´¢å¼•jå¤„ç›´æ¥èµ‹å€¼ newTab[j] = loHead; &#125; if (hiTail != null) &#123; hiTail.next = null; // ç´¢å¼• j + è€æ•°ç»„é•¿åº¦ä½ç½®å­˜æ”¾hiHead newTab[j + oldCap] = hiHead; &#125; &#125; &#125; &#125; &#125; return newTab;&#125;","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"ã€JDKæºç ç¬”è®°ã€‘- HashMapçš„åˆå§‹åŒ–","slug":"source-code/java/HashMapåˆå§‹åŒ–","date":"2020-05-11T10:50:20.000Z","updated":"2020-12-27T09:23:14.251Z","comments":true,"path":"2020/05/11/source-code-hashmap-init.html","link":"","permalink":"https://liuzhihang.com/2020/05/11/source-code-hashmap-init.html","excerpt":"","text":"HashMapåˆå§‹åŒ–å‚æ•°éƒ½æ˜¯ä»€ä¹ˆï¼Ÿé»˜è®¤æ˜¯å¤šå°‘ï¼Ÿä¸ºä»€ä¹ˆå»ºè®®åˆå§‹åŒ–è®¾ç½®å®¹é‡ï¼ŸtableSizeForæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿå¦‚ä½•è·å–åˆ°ä¸€ä¸ªkeyçš„hashå€¼ï¼ŸåŠè®¡ç®—ä¸‹æ ‡ï¼Ÿ HashMapåˆå§‹åŒ–å‚æ•°éƒ½æ˜¯ä»€ä¹ˆï¼Ÿé»˜è®¤æ˜¯å¤šå°‘ï¼ŸHashMapåˆå§‹åŒ–å‚æ•°åˆ†åˆ«æ˜¯åˆå§‹å®¹é‡å’Œè´Ÿè½½å› å­ã€‚ åˆå§‹å®¹é‡(threshold)ï¼šé»˜è®¤ 16ï¼Œ å¿…é¡»æ˜¯2çš„å¹‚ï¼Œ æœ€å¤§å®¹é‡ä¸º 1 &lt;&lt; 30 è´Ÿè½½å› å­(loadFactor)ï¼šæ˜¯æŒ‡å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ï¼Œå½“å“ˆå¸Œè¡¨çš„é•¿åº¦å¤§äºcapacity * loadFactoræ—¶ä¼šè¿›è¡Œæ‰©å®¹ï¼Œé»˜è®¤ 0.75f ä¸ºä»€ä¹ˆå»ºè®®åˆå§‹åŒ–è®¾ç½®å®¹é‡ è¿™å—æ¶‰åŠåˆ°HashMapçš„æ‰©å®¹ï¼Œ åœ¨é˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œä¸­å·²ç»è¯´æ˜äº†åŸå› ã€‚ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘é¢‘ç¹çš„æ‰©å®¹é€ æˆçš„èµ„æºæŸè€—ã€‚ tableSizeForæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿåˆå§‹åŒ–HashMapæ—¶, å¦‚æœä¼ å…¥åˆå§‹å®¹é‡, åœ¨åˆå§‹åŒ–æ—¶ä¼šè°ƒç”¨ tableSizeFor(initialCapacity) æ–¹æ³•å¯»æ‰¾å¤§äºç­‰äºå½“å‰å€¼çš„ä¸‹ä¸€ä¸ª2çš„å¹‚å€¼. ä»£ç å¦‚ä¸‹ï¼š static final int tableSizeFor(int cap) &#123; int n = cap - 1; // -1æ“ä½œ, é˜²æ­¢å½“capæ­£å¥½æ˜¯2çš„å¹‚æ—¶çš„å¤„ç† n |= n &gt;&gt;&gt; 1; // næ— ç¬¦å·å³ç§»1ä½, ç„¶åå’Œnåš | è¿ç®—, (1|0=1 1|1=1 0|0=0 0|1=1) n |= n &gt;&gt;&gt; 2; // næ— ç¬¦å·å³ç§»2ä½, ç„¶åå’Œnåš | è¿ç®—, n |= n &gt;&gt;&gt; 4; // næ— ç¬¦å·å³ç§»4ä½, ç„¶åå’Œnåš | è¿ç®—, n |= n &gt;&gt;&gt; 8; // næ— ç¬¦å·å³ç§»8ä½, ç„¶åå’Œnåš | è¿ç®—, n |= n &gt;&gt;&gt; 16; // næ— ç¬¦å·å³ç§»16ä½, ç„¶åå’Œnåš | è¿ç®—, // æœ€åè·å¾—çš„ç»“æœä¸º cap-1çš„ä¸‹ä¸€ä¸ª2çš„å¹‚å€¼-1, åªéœ€è¦å¯¹n+1å³å¯ return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;&#125; å‡è®¾capå€¼ä¸º100, å³0110 0100 capçš„ä¸‹ä¸€ä¸ª2çš„å¹‚ä¸º 0111 1111 å³ 1000 0000 0000 = 0111 1111 + 1 åªéœ€è¦è€ƒè™‘å°† é¦–ä¸ªä¸º1çš„æœ€é«˜ä½ä¹‹åçš„å€¼ç½®ä¸º1, ç„¶å+1å³å¯ ä¸ºé˜²æ­¢capæœ¬æ¥å°±æ˜¯2çš„å¹‚, åˆ™éœ€è¦å…ˆè¿›è¡Œå‡ä¸€æ“ä½œ å¦‚å›¾æ‰€ç¤º: æœ€åæ‰§è¡Œçš„ç»“æœè¿›è¡ŒåŠ 1å³å¯ å¦‚ä½•è·å–åˆ°ä¸€ä¸ªkeyçš„hashå€¼ï¼Ÿstatic final int hash(Object key) &#123; int h; // keyçš„hashCode ^ ä¸Šè‡ªå·±çš„é«˜16ä½ï¼Œ å¦‚æœæ˜¯nullçš„è¯åˆ™hashä¸º0 return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);&#125; è·å–åˆ°äº†hashå€¼ï¼Œ é‚£å¦‚ä½•è®¡ç®—åœ¨æ•°ç»„çš„é‚£ä¸ªä½ç½®å‘¢ï¼Ÿ // nä¸ºæ•°ç»„é•¿åº¦ æ•°ç»„ä¸‹æ ‡i = (n - 1) &amp; hash æ•°ç»„é•¿åº¦éƒ½æ˜¯ 2çš„å¹‚å‡è®¾ n = 1 &gt;&gt; xåˆ™ n - 1 åˆ™è¡¨ç¤º ä¸€ä¸ªä½xä½å…¨ä¸º1çš„æ•° (n - 1) &amp; hash åˆ™ç›¸å½“äº ä¸€ä¸ªä½xä½å…¨ä¸º1çš„æ•°å’Œhashåš&amp;æ“ä½œ. é€šè¿‡å›¾å¯ä»¥çœ‹å‡º, å‚ä¸è¿ç®—çš„åªæœ‰ä½xä½, ç›¸å½“äºä¹‹å‰çš„æ‰€æœ‰å€¼éƒ½ä¸ä¼šæœ‰æ•ˆ. æ‰€ä»¥å‰é¢çš„hash(key) å°†key.hashCode()é«˜ä½16ä½åš^æ“ä½œ, å¯ä»¥ä¿è¯, é«˜ä½16ä½éƒ½èƒ½å‚ä¸è¿ç®—.ä¸€å®šç¨‹åº¦ä¸Šé¿å…hashç¢°æ’.åœ¨æºç æ³¨é‡Šä¸­å·²ç»è¯´æ˜, æ˜¯è‚¯å®šä¼šæœ‰ç¢°æ’, ä½†æ˜¯è¿™æ˜¯æƒè¡¡ä¹‹åçš„ç»“æœ.","categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"}],"tags":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"}]},{"title":"markdownä»£ç æŠ˜å ","slug":"other/markdownä»£ç æŠ˜å ","date":"2020-04-20T07:20:20.000Z","updated":"2020-12-27T09:23:14.739Z","comments":true,"path":"2020/04/20/markdown-code-folding.html","link":"","permalink":"https://liuzhihang.com/2020/04/20/markdown-code-folding.html","excerpt":"","text":"æ•ˆæœå±•ç¤ºæŠ˜å å†…å®¹ æŠ˜å å†…å®¹ åœ¨markdownä¸­æŠ˜å ä¸€éƒ¨åˆ†å†…å®¹, ç‚¹å‡»å¯ä»¥å±•å¼€. æŠ˜å ä»£ç  æŠ˜å ä»£ç  public class HelloWorld &#123; public static void main(String[] args) &#123; System.out.println(&quot;HelloWorld&quot;); &#125;&#125; ä½¿ç”¨æ–¹å¼ä½¿ç”¨html &lt;details&gt;&lt;summary&gt;æŠ˜å å†…å®¹&lt;/summary&gt;åœ¨markdownä¸­æŠ˜å ä¸€éƒ¨åˆ†å†…å®¹, ç‚¹å‡»å¯ä»¥å±•å¼€.&lt;/details&gt; &lt;details&gt;&lt;summary&gt;æŠ˜å ä»£ç &lt;/summary&gt; ä»£ç å—&lt;/details&gt;","categories":[{"name":"markdown","slug":"markdown","permalink":"https://liuzhihang.com/categories/markdown/"}],"tags":[{"name":"markdown","slug":"markdown","permalink":"https://liuzhihang.com/tags/markdown/"},{"name":"å°æŠ€å·§","slug":"å°æŠ€å·§","permalink":"https://liuzhihang.com/tags/%E5%B0%8F%E6%8A%80%E5%B7%A7/"}]},{"title":"é›ªèŠ±ç®—æ³•","slug":"distributed/ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆæµæ°´å·","date":"2020-04-13T08:03:09.000Z","updated":"2020-12-27T09:23:14.248Z","comments":true,"path":"2020/04/13/snowflake-algorithm.html","link":"","permalink":"https://liuzhihang.com/2020/04/13/snowflake-algorithm.html","excerpt":"","text":"ç®€å•ä»‹ç»ä¸‹é›ªèŠ±ç®—æ³•, ä»¥åŠJavaç‰ˆé›ªèŠ±ç®—æ³•çš„ä»£ç .ä»…ä»…æ˜¯ä¸€ä¸ªæœ€ç®€å•ç‰ˆæœ¬, æ›´æ·±å±‚æ¬¡çš„æŒ‡é’ˆå›æ‹¨ç­‰. ç›¸å½“äºåœ¨å¼€å‘è¿‡æˆåŠŸå¯ä»¥å…ˆä½¿ç”¨.å°½é‡è¿˜æ˜¯ä½¿ç”¨ç»Ÿä¸€çš„åˆ†å¸ƒå¼æµæ°´å·ç”Ÿæˆç³»ç»Ÿ, ä¿è¯æµæ°´å·å…¨å±€å”¯ä¸€. é›ªèŠ±ç®—æ³•0 0000000000 0000000000 0000000000 0000000000 0 00000 00000 000000000000 ä½¿ç”¨64ä½longå‹æ•°å­—ä½œä¸ºå…¨å±€å”¯ä¸€id1ä½ æ— æ„ä¹‰ 041ä½ æ—¶é—´æˆ³5ä½ æœºæˆ¿id5ä½ æœºå™¨id12ä½è‡ªå¢åºå· è¡¨ç¤ºåŒä¸€æ—¶é—´åŒä¸€æœºæˆ¿åŒä¸€æœºå™¨ç”Ÿæˆçš„åºåˆ—å· ç¬¬ä¸€ä½ä¸ºä»€ä¹ˆæ— æ„ä¹‰ äºŒè¿›åˆ¶ä¸­ ç¬¬ä¸€ä½ä»£è¡¨ç¬¦å·ä½, é»˜è®¤ 0 è¡¨ç¤ºç”Ÿæˆçš„åºåˆ—å·ä¸ºæ­£æ•° 41ä½æ—¶é—´æˆ³ 41ä½æœ€å¤§èƒ½è¡¨ç¤º 2^41-1 çš„æ•°å­—. æ¯«ç§’å€¼ 69.7å¹´ (2^41-1)/1000/60/60/24 å½“æ—¶é—´å¤§äº69.7å³æ—¶é—´æˆ³å·®å€¼å¤§äº 2199023255551, ä¼šå¼€å§‹å‡ºç°è´Ÿå€¼æµæ°´å· 10ä½ æœºæˆ¿id+æœºå™¨id 2^10 1024å°æœºå™¨ // ä½†æ˜¯ä½¿ç”¨ä¸­ä¸å¯èƒ½æ¯éƒ¨ç½²ä¸€å°æœºå™¨éƒ½æ”¹ä¸‹ç¼–å·, æ‰€ä»¥æˆ‘åšå‡ºä»¥ä¸‹æ”¹åŠ¨// 8ä½æœºå™¨å·(æœ€å¤§256) 2ä½æœºæˆ¿å·// æœºå™¨å·ä½¿ç”¨IPåœ°å€åä¸‰ä½ æœºæˆ¿id é»˜è®¤1// åªéœ€è¦ç¡®ä¿æœºå™¨çš„ipåä¸‰ä½ä¸åŒå³å¯private static final long MACHINE_BIT = 8;private static final long DATA_CENTER_BIT = 2;private static final long DATA_CENTER_ID = 1;private static long address;static &#123; InetAddress localIp = IpUtils.getLocalIp(); address = localIp.getAddress()[3] &amp; 0xff; log.info(&quot;å½“å‰ç³»ç»Ÿçš„ address ä¸º: &#123;&#125;&quot;, address);&#125; 12ä½åºåˆ—å· è¡¨ç¤ºåŒä¸€æ¯«ç§’å†…ç”Ÿæˆçš„id 2^12-1 ä¸ªæ­£æ•´æ•° SnowFlakeæ¯ç§’èƒ½å¤Ÿäº§ç”Ÿ26ä¸‡IDå·¦å³ ä¼˜ç‚¹:ç”ŸæˆIDæ—¶ä¸ä¾èµ–äºDBï¼Œå®Œå…¨åœ¨å†…å­˜ç”Ÿæˆï¼Œé«˜æ€§èƒ½é«˜å¯ç”¨ã€‚IDå‘ˆè¶‹åŠ¿é€’å¢ï¼Œåç»­æ’å…¥ç´¢å¼•æ ‘çš„æ—¶å€™æ€§èƒ½è¾ƒå¥½ã€‚ç¼ºç‚¹:ä¾èµ–äºç³»ç»Ÿæ—¶é’Ÿçš„ä¸€è‡´æ€§ã€‚å¦‚æœæŸå°æœºå™¨çš„ç³»ç»Ÿæ—¶é’Ÿå›æ‹¨ï¼Œæœ‰å¯èƒ½é€ æˆIDå†²çªï¼Œæˆ–è€…IDä¹±åº SerialNumberpublic class SerialNumber &#123; /** * èµ·å§‹çš„æ—¶é—´æˆ³ 2018-01-01 00:00:00 */ private static final long START_STAMP = 1514736000000L; /** * æ¯ä¸€éƒ¨åˆ†å ç”¨çš„ä½æ•° * åºåˆ—å· å ç”¨ä½æ•° 12 ä½ (åŒä¸€æ¯«ç§’å†…ç”Ÿæˆçš„id 2^12-1 ä¸ªæ­£æ•´æ•°) * æœºå™¨æ ‡è¯† å ç”¨ä½æ•° 8 ä½ (ä¸€èˆ¬æ˜¯ä½¿ç”¨5ä½) * æ•°æ®ä¸­å¿ƒ å ç”¨ä½æ•° 2 ä½ (ä¸€èˆ¬æ˜¯ä½¿ç”¨5ä½) * */ private static final long SEQUENCE_BIT = 12; private static final long MACHINE_BIT = 8; private static final long DATA_CENTER_BIT = 2; /** * æ¯ä¸€éƒ¨åˆ†çš„æœ€å¤§å€¼ */ private static final long MAX_DATA_CENTER_NUM = ~(-1L &lt;&lt; DATA_CENTER_BIT); private static final long MAX_MACHINE_NUM = ~(-1L &lt;&lt; MACHINE_BIT); private static final long MAX_SEQUENCE = ~(-1L &lt;&lt; SEQUENCE_BIT); /** * æ¯ä¸€éƒ¨åˆ†å‘å·¦çš„ä½ç§» * æœºå™¨Idå·¦ç§»12ä½ (SEQUENCE_BIT = 12) * æ•°æ®ä¸­å¿ƒå·¦ç§»20ä½ (SEQUENCE_BIT + MACHINE_BIT = 12 + 8) * æ—¶é—´æˆ³å·¦ç§»22ä½ (DATA_CENTER_LEFT + DATA_CENTER_BIT = 12 + 8 + 2) * */ private static final long MACHINE_LEFT = SEQUENCE_BIT; private static final long DATA_CENTER_LEFT = SEQUENCE_BIT + MACHINE_BIT; private static final long TIME_STAMP_LEFT = DATA_CENTER_LEFT + DATA_CENTER_BIT; /** * æ•°æ®ä¸­å¿ƒ æœºå™¨æ ‡è¯† åºåˆ—å· ä¸Šä¸€æ¬¡æ—¶é—´æˆ³ * æ•°æ®ä¸­å¿ƒæ ‡è¯†å’Œæœºå™¨æ ‡è¯†ä¸€èˆ¬æ˜¯å¤–éƒ¨ä¼ å…¥ */ private static final long DATA_CENTER_ID = 1; private static long address; private long sequence = 0L; private long lastStamp = -1L; private static final DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern(&quot;yyMMdd&quot;); static &#123; InetAddress localIp = IpUtils.getLocalIp(); address = localIp.getAddress()[3] &amp; 0xff; log.info(&quot;å½“å‰ç³»ç»Ÿçš„ address ä¸º: &#123;&#125;&quot;, address); &#125; /** * äº§ç”Ÿä¸‹ä¸€ä¸ªID * * @return */ private synchronized long nextId() &#123; long currStamp = getNewStamp(); if (currStamp &lt; lastStamp) &#123; throw new RuntimeException(&quot;Clock moved backwards. Refusing to generate id&quot;); &#125; if (currStamp == lastStamp) &#123; // ç›¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·è‡ªå¢ (sequence + 1) &amp; (~(-1L &lt;&lt; SEQUENCE_BIT)) sequence = (sequence + 1) &amp; MAX_SEQUENCE; // åŒä¸€æ¯«ç§’çš„åºåˆ—æ•°å·²ç»è¾¾åˆ°æœ€å¤§ if (sequence == 0L) &#123; currStamp = getNextMill(); &#125; &#125; else &#123; // ä¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·ç½®ä¸º0 sequence = 0L; &#125; lastStamp = currStamp; // æ—¶é—´æˆ³éƒ¨åˆ† æ•°æ®ä¸­å¿ƒéƒ¨åˆ† æœºå™¨æ ‡è¯†éƒ¨åˆ† åºåˆ—å·éƒ¨åˆ† return (currStamp - START_STAMP) &lt;&lt; TIME_STAMP_LEFT | DATA_CENTER_ID &lt;&lt; DATA_CENTER_LEFT | address &lt;&lt; MACHINE_LEFT | sequence; &#125; private long getNextMill() &#123; long mill = getNewStamp(); while (mill &lt;= lastStamp) &#123; mill = getNewStamp(); &#125; return mill; &#125; private long getNewStamp() &#123; return System.currentTimeMillis(); &#125;&#125; IpUtilsimport java.net.*;import java.util.Enumeration;/** * @author liuzhihang * @date 2019/12/19 16:03 */public class IpUtils &#123; public static InetAddress getLocalIp() &#123; try &#123; for (Enumeration&lt;NetworkInterface&gt; e = NetworkInterface.getNetworkInterfaces(); e.hasMoreElements(); ) &#123; NetworkInterface item = e.nextElement(); for (InterfaceAddress address : item.getInterfaceAddresses()) &#123; if (item.isLoopback() || !item.isUp()) &#123; continue; &#125; if (address.getAddress() instanceof Inet4Address) &#123; return address.getAddress(); &#125; &#125; &#125; return InetAddress.getLocalHost(); &#125; catch (SocketException | UnknownHostException e) &#123; throw new RuntimeException(e); &#125; &#125;&#125;","categories":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"}],"tags":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"},{"name":"æµæ°´å·","slug":"æµæ°´å·","permalink":"https://liuzhihang.com/tags/%E6%B5%81%E6%B0%B4%E5%8F%B7/"},{"name":"é›ªèŠ±ç®—æ³•","slug":"é›ªèŠ±ç®—æ³•","permalink":"https://liuzhihang.com/tags/%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95/"}]},{"title":"é¡¹ç›®å¯åŠ¨å¤±è´¥:java.lang.NoClassDefFoundError","slug":"issue/é¡¹ç›®å¯åŠ¨å¤±è´¥","date":"2020-04-12T05:20:48.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/04/12/no-class-def-found-error-rule-configuration.html","link":"","permalink":"https://liuzhihang.com/2020/04/12/no-class-def-found-error-rule-configuration.html","excerpt":"","text":"è¿‘æœŸé‡åˆ°ä¸€ä¸ªå¾ˆä¹…æ²¡æœ‰å¯åŠ¨è¿‡çš„é¡¹ç›®, ç„¶åå¯åŠ¨å¤±è´¥, æŠ¥ java.lang.NoClassDefFoundError, ç°åœ¨è®°å½•é—®é¢˜æ’æŸ¥æƒ…å†µ. é”™è¯¯ä»£ç  é”™è¯¯ä»£ç è¾ƒé•¿, å¯ä»¥æ”¶ç¼©, ç›´æ¥çœ‹æ’æŸ¥ Error starting ApplicationContext. To display the conditions report re-run your application with &#39;debug&#39; enabled.][2020-04-10 13:26:11.478]-[main]-[]-[ERROR]-[org.springframework.boot.SpringApplication:821]-[Application run failed]org.springframework.context.ApplicationContextException: Unable to start web server; nested exception is org.springframework.boot.web.server.WebServerException: Unable to start embedded Tomcat at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh(ServletWebServerApplicationContext.java:155) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:543) ~[spring-context-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE] at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:140) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:742) [spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:389) [spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.SpringApplication.run(SpringApplication.java:311) [spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.SpringApplication.run(SpringApplication.java:1213) [spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.SpringApplication.run(SpringApplication.java:1202) [spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at com.opay.im.WebApplication.main(WebApplication.java:32) [classes!&#x2F;:1.0-SNAPSHOT] at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_221] at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_221] at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_221] at java.lang.reflect.Method.invoke(Method.java:498) ~[?:1.8.0_221] at org.springframework.boot.loader.MainMethodRunner.run(MainMethodRunner.java:48) [opay-im-web-1.0-SNAPSHOT.jar:1.0-SNAPSHOT] at org.springframework.boot.loader.Launcher.launch(Launcher.java:87) [opay-im-web-1.0-SNAPSHOT.jar:1.0-SNAPSHOT] at org.springframework.boot.loader.Launcher.launch(Launcher.java:50) [opay-im-web-1.0-SNAPSHOT.jar:1.0-SNAPSHOT] at org.springframework.boot.loader.JarLauncher.main(JarLauncher.java:58) [opay-im-web-1.0-SNAPSHOT.jar:1.0-SNAPSHOT]Caused by: org.springframework.boot.web.server.WebServerException: Unable to start embedded Tomcat at org.springframework.boot.web.embedded.tomcat.TomcatWebServer.initialize(TomcatWebServer.java:124) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.web.embedded.tomcat.TomcatWebServer.&lt;init&gt;(TomcatWebServer.java:86) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory.getTomcatWebServer(TomcatServletWebServerFactory.java:414) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory.getWebServer(TomcatServletWebServerFactory.java:178) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.createWebServer(ServletWebServerApplicationContext.java:179) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh(ServletWebServerApplicationContext.java:152) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] ... 16 moreCaused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;servletEndpointRegistrar&#39; defined in class path resource [org&#x2F;springframework&#x2F;boot&#x2F;actuate&#x2F;autoconfigure&#x2F;endpoint&#x2F;web&#x2F;ServletEndpointManagementContextConfiguration$WebMvcServletEndpointManagementContextConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.springframework.boot.actuate.endpoint.web.ServletEndpointRegistrar]: Factory method &#39;servletEndpointRegistrar&#39; threw exception; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &#39;healthEndpoint&#39; defined in class path resource [org&#x2F;springframework&#x2F;boot&#x2F;actuate&#x2F;autoconfigure&#x2F;health&#x2F;HealthEndpointConfiguration.class]: Unsatisfied dependency expressed through method &#39;healthEndpoint&#39; parameter 1; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;healthIndicatorRegistry&#39; defined in class path resource [org&#x2F;springframework&#x2F;boot&#x2F;actuate&#x2F;autoconfigure&#x2F;health&#x2F;HealthIndicatorAutoConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.springframework.boot.actuate.health.HealthIndicatorRegistry]: Factory method &#39;healthIndicatorRegistry&#39; threw exception; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &#39;org.springframework.boot.actuate.autoconfigure.jdbc.DataSourceHealthIndicatorAutoConfiguration&#39;: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &#39;dataSource&#39; defined in class path resource [com&#x2F;opay&#x2F;im&#x2F;config&#x2F;DatabaseConfig.class]: Unsatisfied dependency expressed through method &#39;dataSource&#39; parameter 0; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;defaultDataSource&#39; defined in class path resource [com&#x2F;opay&#x2F;im&#x2F;config&#x2F;DatabaseConfig.class]: Initialization of bean failed; nested exception is java.lang.NoClassDefFoundError: org&#x2F;apache&#x2F;shardingsphere&#x2F;api&#x2F;config&#x2F;RuleConfiguration at org.springframework.beans.factory.support.ConstructorResolver.instantiate(ConstructorResolver.java:627) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE] at org.springframework.beans.factory.support.ConstructorResolver.instantiateUsingFactoryMethod(ConstructorResolver.java:607) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE] at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.instantiateUsingFactoryMethod(AbstractAutowireCapableBeanFactory.java:1321) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE] at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1160) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE] at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:555) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE] at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:515) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE] at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:320) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE] at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:222) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE] at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:318) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE] at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:204) ~[spring-beans-5.1.8.RELEASE.jar!&#x2F;:5.1.8.RELEASE] at org.springframework.boot.web.servlet.ServletContextInitializerBeans.getOrderedBeansOfType(ServletContextInitializerBeans.java:211) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.web.servlet.ServletContextInitializerBeans.getOrderedBeansOfType(ServletContextInitializerBeans.java:202) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.web.servlet.ServletContextInitializerBeans.addServletContextInitializerBeans(ServletContextInitializerBeans.java:96) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.web.servlet.ServletContextInitializerBeans.&lt;init&gt;(ServletContextInitializerBeans.java:85) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.getServletContextInitializerBeans(ServletWebServerApplicationContext.java:252) ~[spring-boot-2.1.6.RELEASE.jar!&#x2F;:2.1.6.RELEASE] é—®é¢˜å®šä½ å¼€å§‹æ’æŸ¥æ˜¯å› ä¸ºç¼ºå°‘ sharding-core-api-4.0.0-RC2.2-1.8.jar åŒ…ä¸‹çš„ä¸€ä¸ªæ–‡ä»¶, ä½†æ˜¯æœ¬åœ°æ˜¯æœ‰çš„ æœ¬åœ°å¯ä»¥å¯åŠ¨ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥, å¯èƒ½æ˜¯jaråŒ…ç¼ºå°‘ æœ€åç»“æœå‘ç° sharding-core-api-4.0.0-RC2.2-1.8.jar æ˜¯é€šè¿‡å…¬å¸å°è£…çš„ä¸€ä¸ªåŒ…ä¼ é€’è¿›æ¥çš„, è€Œå°è£…çš„é‚£ä¸ªjaråŒ…åœ¨ç§æœä¸Šå·²ç»è¢«åˆ é™¤äº†. åˆ é™¤åŸå› ","categories":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/categories/issue/"}],"tags":[{"name":"error","slug":"error","permalink":"https://liuzhihang.com/tags/error/"}]},{"title":"Macåˆ›å»ºdataç›®å½•å¤±è´¥","slug":"mac/macåˆ›å»ºdataç›®å½•å¤±è´¥","date":"2020-01-05T10:30:30.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2020/01/05/mac-create-data-directory-failed.html","link":"","permalink":"https://liuzhihang.com/2020/01/05/mac-create-data-directory-failed.html","excerpt":"","text":"é—®é¢˜æè¿° éƒ¨åˆ†é¡¹ç›®logæ—¥å¿—è¾“å‡ºè·¯å¾„ä¸º /data/log, å‘ç°æ— æ³•åˆ›å»ºç›®å½•é”™è¯¯ä¿¡æ¯: mkdir: cannot create directory â€˜dataâ€™: Read-only file system è§£å†³æ–¹å¼å…³é—­SPI é‡å¯ æŒ‰ä½CMD+Rè¿›å…¥æ¢å¤æ¨¡å¼ æ‰“å¼€ç»ˆç«¯ ç»ˆç«¯è¾“å…¥å‘½ä»¤ï¼šcsrutil disable æŒ‚è½½data åœ¨ç”¨æˆ·ç›®å½•(å¯ä»¥è‡ªå·±æ‰¾ä¸€ä¸ªç›®å½•ä¸‹åˆ›å»ºdata) ~ % &gt; cd ~~ % &gt; mkdir data æ‰§è¡Œ sudo mount -uw / é‡æ–°æŒ‚è½½æ ¹ç›®å½• å»ºç«‹è½¯é“¾sudo ln -s /Users/liuzhihang/data /data ä¹‹åå¯ä»¥é‡å¯å†æ‰“å¼€spiäº†","categories":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/categories/issue/"}],"tags":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/tags/issue/"},{"name":"mac","slug":"mac","permalink":"https://liuzhihang.com/tags/mac/"}]},{"title":"Hexoä¸­æ’å…¥Bilibiliè§†é¢‘","slug":"hexo/hexoæ’å…¥bilibiliè§†é¢‘","date":"2019-09-14T07:06:54.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2019/09/14/hexo-inserts-bilibili-video.html","link":"","permalink":"https://liuzhihang.com/2019/09/14/hexo-inserts-bilibili-video.html","excerpt":"","text":"ä¿®æ”¹materyä¸»é¢˜é¦–é¡µæ˜¾ç¤ºè§†é¢‘ä¸ºBilibiliè§†é¢‘ åœ¨Markdownæ’å…¥Bilibiliè§†é¢‘, å¹¶è®¾ç½®å¤§å°. é¦–å…ˆæ‰¾åˆ°åˆ†äº«åµŒå…¥ä»£ç  &lt;iframe src=&quot;//player.bilibili.com/player.html?aid=17963687&amp;cid=29326684&amp;page=1&quot; scrolling=&quot;no&quot; border=&quot;0&quot; frameborder=&quot;no&quot; framespacing=&quot;0&quot; allowfullscreen=&quot;true&quot;&gt; &lt;/iframe&gt; åœ¨markdownä¸­ä½¿ç”¨åµŒå…¥ä»£ç  è°ƒæ•´å¤§å°å’Œå±…ä¸­ç­‰iframeæ ‡ç­¾å±æ€§è®¾ç½® &lt;!-- è°ƒæ•´å¤§å°: width=&quot;xxx&quot; height=&quot;xxx&quot;--&gt;&lt;iframe src=&quot;//player.bilibili.com/player.html?aid=17963687&amp;cid=29326684&amp;page=1&quot; width=&quot;600&quot; height=&quot;400&quot; scrolling=&quot;no&quot; border=&quot;0&quot; frameborder=&quot;no&quot; framespacing=&quot;0&quot; allowfullscreen=&quot;true&quot;&gt; &lt;/iframe&gt; è®¾ç½®è‡ªé€‚åº”&lt;div style=&quot;position: relative; width: 100%; height: 0; padding-bottom: 75%;&quot;&gt; &lt;iframe src=&quot;//player.bilibili.com/player.html?aid=17963687&amp;cid=29326684&amp;page=1&quot; scrolling=&quot;no&quot; border=&quot;0&quot; frameborder=&quot;no&quot; framespacing=&quot;0&quot; allowfullscreen=&quot;true&quot; style=&quot;position: absolute; width: 100%; height: 100%; left: 0; top: 0;&quot;&gt;&lt;/iframe&gt;&lt;/div&gt; matery ä¸»é¢˜ä¿®æ”¹é¦–é¡µå±•ç¤ºè§†é¢‘æ‰¾åˆ° /themes/hexo-theme-matery/layout/_widget/video.ejs å°†ç¬¬åä¸€è¡Œå·¦å³ä»£ç æ”¹æˆBilibiliè§†é¢‘å³å¯, å¼•å…¥çš„ script å¯ä»¥åˆ æ‰. ä¿®æ”¹åå¦‚ä¸‹. &lt;div class=&quot;video-player&quot;&gt; &lt;% if (theme.video.showTitle) &#123; %&gt; &lt;div class=&quot;title center-align&quot;&gt; &lt;i class=&quot;fas fa-video-camera&quot;&gt;&lt;/i&gt;&amp;nbsp;&amp;nbsp;&lt;%- theme.video.title %&gt; &lt;/div&gt; &lt;% &#125; %&gt; &lt;div class=&quot;row&quot;&gt; &lt;div class=&quot;col l8 offset-l2 m10 offset-m1 s12&quot;&gt; &lt;div id=&quot;dplayer&quot; class=&quot;dplayer-video&quot;&gt; &lt;div style=&quot;position: relative; width: 100%; height: 0; padding-bottom: 75%;&quot;&gt; &lt;iframe src=&quot;//player.bilibili.com/player.html?aid=16316393&amp;cid=26620787&amp;page=1&quot; scrolling=&quot;no&quot; border=&quot;0&quot; frameborder=&quot;no&quot; framespacing=&quot;0&quot; allowfullscreen=&quot;true&quot; style=&quot;position: absolute; width: 100%; height: 100%; left: 0; top: 0;&quot;&gt;&lt;/iframe&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;","categories":[{"name":"hexo","slug":"hexo","permalink":"https://liuzhihang.com/categories/hexo/"}],"tags":[{"name":"hexo","slug":"hexo","permalink":"https://liuzhihang.com/tags/hexo/"}]},{"title":"Redisåˆ†å¸ƒå¼é”çš„ç”Ÿäº§é—®é¢˜è§£å†³æ–¹æ¡ˆ","slug":"distributed/redisåˆ†å¸ƒå¼é”çš„ç”Ÿäº§é—®é¢˜è§£å†³æ–¹æ¡ˆ","date":"2019-08-18T08:36:20.000Z","updated":"2020-12-27T09:23:14.247Z","comments":true,"path":"2019/08/18/redis-distributed-lock-production-problem-solution.html","link":"","permalink":"https://liuzhihang.com/2019/08/18/redis-distributed-lock-production-problem-solution.html","excerpt":"","text":"Javaè¿›é˜¶è®­ç»ƒè¥å­¦ä¹ ç¬”è®°è¯¾ç¨‹: Javaè¿›é˜¶è®­ç»ƒè¥è€å¸ˆ: ä¸­åçŸ³æ‰é‚€è¯·ç : äºŒç»´ç  ä½¿ç”¨æ–¹å¼SET KEY VALUE TIME NX DEL KEY ä¸€èˆ¬ä½¿ç”¨ NX, åªæœ‰åœ¨é”ä¸å­˜åœ¨çš„æ—¶å€™æ‰åŠ é”æˆåŠŸ, è®¾ç½®æ—¶é—´æ˜¯ä¸ºäº†é”æ°¸è¿œå¾—ä¸åˆ°é‡Šæ”¾ å­˜åœ¨é—®é¢˜åŠè§£å†³æ–¹æ³• AåŠ é”, Bé‡Šæ”¾ æ–¹æ³•: Redisson åœ¨tryLockæ—¶ long threadId = Thread.currentThread().getId();protected String getLockName(long threadId) &#123; return id + &quot;:&quot; + threadId;&#125;// id ä¸º UUID ä¼šå°†å½“å‰ uuId+çº¿ç¨‹idå†™å…¥åˆ°é”ä¿¡æ¯ä¸­, unlockæ—¶ä¼šæ ¡éªŒæ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ A locké”ä½ä¹‹å, è®¾ç½®äº†æ—¶é—´, ä½†æ˜¯åœ¨æ—¶é—´å†…æœªå®Œæˆ, å¯¼è‡´é”è‡ªåŠ¨é‡Šæ”¾, ç„¶åBè·å–é”åŒæ—¶è¿›è¡Œæ“ä½œ æ–¹æ³•: Redisson åœ¨lockæ—¶ä¼šå¯åŠ¨å¼‚æ­¥çº¿ç¨‹, è‡ªåŠ¨å»¶æœŸ, æ—¶é—´ä¸º lockWatchdogTimeout(é»˜è®¤30s) Timeout task = commandExecutor.getConnectionManager().newTimeout(new TimerTask() &#123; çœç•¥...&#125;, internalLockLeaseTime / 3, TimeUnit.MILLISECONDS); çœ‹æºç æ˜¯å»¶æ—¶ 1/3çš„æ—¶é—´åå¼€å§‹, å°±æ˜¯æ¯æ¬¡1/3æ—¶é—´çš„æ—¶å€™å»¶æœŸä¸€æ¬¡. è¿™æ ·ç†è§£ä¸çŸ¥é“å¯¹ä¸å¯¹ ä¸»ä»ä¸‹, A åŠ é” Master æˆåŠŸåæœªåŒæ­¥ç»™Slave ä¾¿å®•æœº, å¯¼è‡´ Bå‘ç°æœªåŠ é” æ–¹æ³•: å¯ä»¥ä¿®æ”¹æºç , åŒæ—¶åŠ é”Master-Slave æ‰ç®—åŠ é”æˆåŠŸ é›†ç¾¤çŠ¶æ€ä¸‹å¯ä»¥å‚è€ƒRedLock(çº¢é”), åŠ é”å¤šå°æœºå™¨, å¤šæ•°æˆåŠŸæ‰ç®—æˆåŠŸ(locks.size()/2 + 1) public class RedissonRedLock extends RedissonMultiLock &#123; public RedissonRedLock(RLock... locks) &#123; super(locks); &#125;&#125;","categories":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"}],"tags":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"}]},{"title":"å¦‚ä½•è½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡","slug":"distributed/å¦‚ä½•è½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡","date":"2019-08-17T07:55:55.000Z","updated":"2020-12-27T09:23:14.248Z","comments":true,"path":"2019/08/17/how-to-land-the-final-consistency-transaction.html","link":"","permalink":"https://liuzhihang.com/2019/08/17/how-to-land-the-final-consistency-transaction.html","excerpt":"","text":"Javaè¿›é˜¶è®­ç»ƒè¥å­¦ä¹ ç¬”è®°è¯¾ç¨‹: Javaè¿›é˜¶è®­ç»ƒè¥è€å¸ˆ: ä¸­åçŸ³æ‰é‚€è¯·ç : äºŒç»´ç  ä½œä¸šï¼šå¦‚æœå¯¹è‡ªå·±çš„ç³»ç»Ÿè½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ï¼Œå¦‚ä½•è½åœ°å®ç°ï¼Ÿ é¦–å…ˆç†Ÿæ‚‰è‡ªå·±è´Ÿè´£çš„ä¸šåŠ¡, ç†Ÿæ‚‰ç³»ç»Ÿé—´äº¤äº’æµç¨‹, å“ªäº›å¯ä»¥å¼‚æ­¥, å“ªäº›æ˜¯å¿…é¡»åŒæ­¥ å¼‚æ­¥çš„æ—¶å€™è¦è€ƒè™‘æ˜¯å¦éœ€è¦ä¸€è‡´æ€§, å½“å‰ç³»ç»Ÿé€šçŸ¥æµç¨‹å¦‚å›¾ å¦‚ä½•è½åœ°æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ æ ¹æ®è¯¾ç¨‹æ€è€ƒæœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡ä¿®æ”¹: åœ¨æ”¶åˆ°äº¤æ˜“è¯·æ±‚, æˆåŠŸæ—¶å¯ä»¥ commit half message åŒæ—¶ éœ€è¦å®ç° checkæ–¹æ³•, ä¾›RocketMQå›è°ƒ, æ£€æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ åœ¨äº¤æ˜“æˆåŠŸæˆ–å¤±è´¥æ—¶å†è¿›è¡Œcommitæˆ–rollback rollbackæ¶ˆæ¯ RocketMQä¼šå®šæœŸåˆ é™¤ é€šçŸ¥ç³»ç»Ÿæ”¶åˆ°æ¶ˆæ¯å­˜å‚¨åˆ°æœ¬åœ°å¹¶é€šçŸ¥å•†æˆ· é—®é¢˜ä½†æ˜¯è€ƒè™‘åˆ°åœ¨è¿™è¾¹ç³»ç»Ÿå®Œå…¨æ²¡æœ‰å¿…è¦å¢åŠ äº‹åŠ¡, å› ä¸ºå‘é€æ¶ˆæ¯åˆ°MQæ˜¯åœ¨äº¤æ˜“ç»“æŸå, ç›´æ¥ç”¨ä¸€ä¸ªå­—æ®µåˆ¤æ–­çŠ¶æ€, ç„¶åç”¨å®šæ—¶ä¿è¯æŠ•é€’åˆ°MQå³å¯. RocketMQçš„ä¸¤æ®µæäº¤ half messageæ‰§è¡Œæµç¨‹æ ¹æ®æµç¨‹ç»“æœ: commit&#x2F;rockback å¯ä»¥æ”¹æˆ æ‰§è¡Œæµç¨‹RocketMQ send(æ™®é€šæ¶ˆæ¯) åœ¨è¿™è¾¹çš„ä½¿ç”¨åœºæ™¯ä¸­, å› ä¸ºæäº¤äº† half message ä¹Ÿä¸ä¼šå‘é€æ¶ˆæ¯, ç­‰åˆ°æµç¨‹æ‰§è¡Œç»“æŸäº†, ç„¶åä½¿ç”¨sendå‘é€æ™®é€šæ¶ˆæ¯å³å¯.","categories":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"}],"tags":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"}]},{"title":"äº¤æ˜“ç³»ç»Ÿæ¶æ„å›¾","slug":"distributed/äº¤æ˜“ç³»ç»Ÿæ¶æ„å›¾","date":"2019-08-10T03:19:54.000Z","updated":"2020-12-27T09:23:14.247Z","comments":true,"path":"2019/08/10/trading-system-architecture.html","link":"","permalink":"https://liuzhihang.com/2019/08/10/trading-system-architecture.html","excerpt":"","text":"Javaè¿›é˜¶è®­ç»ƒè¥å­¦ä¹ ç¬”è®°è¯¾ç¨‹: Javaè¿›é˜¶è®­ç»ƒè¥è€å¸ˆ: ä¸­åçŸ³æ‰é‚€è¯·ç : äºŒç»´ç  äº¤æ˜“ç³»ç»Ÿæ¶æ„ è¯·æ±‚æµç¨‹: è¯·æ±‚é¦–å…ˆåˆ°SLB(é˜¿é‡Œäº‘)ç»è¿‡è´Ÿè½½å‡è¡¡å, åˆ°Nginx Nginxåšç®€å•è´Ÿè½½å‡è¡¡åå‘ç»™äº¤æ˜“APIç³»ç»Ÿ, 4C8G * 5 ECS(é˜¿é‡Œäº‘) äº¤æ˜“ä¼šæ ¹æ®è¯·æ±‚å‚æ•°, è·¯ç”±åˆ°å„ä¸ªå­ç³»ç»Ÿ, ä½¿ç”¨dubbo å­ç³»ç»Ÿæ”¶åˆ°è¯·æ±‚, è¯·æ±‚é£æ§ç³»ç»Ÿæ ¡éªŒé£æ§ è¯·æ±‚åº”ç”¨ä¸­å¿ƒè·å–åº”ç”¨å‚æ•° (appId, appKeyç­‰) æ‹¼è£…æŠ¥æ–‡,è¯·æ±‚æ¸ é“ç³»ç»Ÿ è¿”å›ä¿¡æ¯ æ—¥å¿—æŠ¥é€æµç¨‹ äº¤æ˜“æˆåŠŸæŠ¥é€æ¸…ç»“ç®—, æŠ¥é€æ•°æ®ä¸­å¿ƒ filebeatæ‹‰å–æ—¥å¿—, æŠ¥é€kafka, å› filebeatå‡çº§ åŒæ—¶å­˜åœ¨5.xå’Œ6.x éœ€è¦åŠ ä¸­é—´ä¸€å±‚, ä¹‹å‰æ˜¯ç›´æ¥æŠ¥logstash logstashå¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤ç„¶åæ ¹æ®type åˆ†åˆ«ä¿é€åˆ° elasticsearchå’Œredis ç›‘æ§ç³»ç»Ÿç›‘æ§redisé˜Ÿåˆ—æ•°æ®, æ»¡è¶³è§„åˆ™, æŠ¥è­¦(å‘æ¶ˆæ¯åˆ°é€šçŸ¥ç³»ç»Ÿ) ç›‘æ§ç³»ç»Ÿå¯¹esæ•°æ®è¿›è¡Œè¿‡æ»¤, æ”¾åˆ°mysql, ç”¨æ¥å±•ç¤ºå•†æˆ·, æ¸ é“çš„äº¤æ˜“å˜åŒ–ç­‰ä¿¡æ¯ kibana(ç›´æ¥ç”¨çš„kibana)æä¾›ç»™æŠ€æœ¯æ”¯æŒæŸ¥è¯¢æ—¥å¿—. esæ•°æ®ä¼šå®šæœŸåˆ é™¤, ä¿ç•™15-30å¤©çš„æ•°æ®, ä»…ä»…æŠ€æœ¯æ”¯æŒç”¨, ä¸éœ€è¦æ•ˆç‡å¾ˆé«˜, æ‰€ä»¥æœºå™¨é…ç½®ç›¸å¯¹è¾ƒå·®. æ‰©å®¹æ–¹æ¡ˆå…¬å¸ä½“é‡è¾ƒå°, QPSé«˜å³°æœŸä¹Ÿå°±500å·¦å³, TPSé«˜å³°æœŸåœ¨100~200, æ‰€ä»¥åŸºæœ¬æ²¡æœ‰é‡åˆ°é—®é¢˜.ä¹‹å‰æœ‰è¿‡ä¸€æ®µæ—¶é—´å…¬ä¼—å·æ”¯ä»˜äº¤æ˜“é‡è¾ƒå¤§, ä¸»è¦åšæ³•æ˜¯å¢åŠ å…¬ä¼—å·æœºå™¨, åŒæ—¶å¢åŠ APIç³»ç»Ÿæœºå™¨.å‡å¦‚äº¤æ˜“é‡æé«˜, ä¸€èˆ¬åº”å¯¹å°±æ˜¯å¢åŠ æœºå™¨, å’Œæé«˜æœºå™¨é…ç½®, åŸºæœ¬ä¸Šéƒ½å¯ä»¥åº”å¯¹. å­˜åœ¨é—®é¢˜å®šæ—¶ç³»ç»Ÿæ˜¯ä»…ä»…é€šè¿‡dubboå‘é€è°ƒç”¨è¯·æ±‚, æ²¡æœ‰ä¸šåŠ¡é€»è¾‘. æ‰€ä»¥å•ä½“åŸºæœ¬æ²¡æœ‰é‡åˆ°æŒ‚æ‰. ä¹Ÿåœ¨è€ƒè™‘åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡.","categories":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"}],"tags":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"}]},{"title":"SpringCloudæ¶æ„åŸç†å›¾","slug":"distributed/springcloudæ¶æ„åŸç†å›¾","date":"2019-08-04T09:01:06.000Z","updated":"2020-12-27T09:23:14.247Z","comments":true,"path":"2019/08/04/springcloud-architecture-schematic.html","link":"","permalink":"https://liuzhihang.com/2019/08/04/springcloud-architecture-schematic.html","excerpt":"","text":"Javaè¿›é˜¶è®­ç»ƒè¥å­¦ä¹ ç¬”è®°è¯¾ç¨‹: Javaè¿›é˜¶è®­ç»ƒè¥è€å¸ˆ: ä¸­åçŸ³æ‰é‚€è¯·ç : äºŒç»´ç  springcloud é€šä¿¡åŸç† 1. Eureka é›†ç¾¤ Eurekaå¯åŠ¨å, ä¼šå‘å…¶ä»–èŠ‚ç‚¹æ³¨å†Œ, ç›¸äº’ç›´æ¥è§†ä¸º peer, å¹¶äº’ç›¸åŒæ­¥æ³¨å†Œä¿¡æ¯. 2. ç¼“å­˜æœºåˆ¶Eurekaå­˜åœ¨ä¸‰ä¸ªmap: registryã€readWriteCacheMapã€readOnlyCacheMap registry: CurrentHashMap å®æ—¶æ›´æ–°readWriteCacheMap: Guava Cache/LoadingCache ä¹Ÿæ˜¯å®æ—¶æ›´æ–°readOnlyCacheMap: CurrentHashMap 30ç§’åŒæ­¥ readWriteCacheMapä¸€æ¬¡ 3. æœåŠ¡æ³¨å†ŒæœåŠ¡æ³¨å†Œåæ¯30så‘é€ä¸€æ¬¡å¿ƒè·³(renew)å®¢æˆ·ç«¯æ¯30ç§’è¯·æ³¨å†Œä¸­å¿ƒè·å–ä¸€æ¬¡é…ç½®, å¹¶å­˜åˆ°æœ¬åœ°å†…å­˜ä¸­ æ³¨å†Œä¸­å¿ƒä¼šå®šæ—¶æ£€æŸ¥å¿ƒè·³, è¿ç»­æ²¡æœ‰3ä¸ªå›è¸¢æ‰æœåŠ¡","categories":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"}],"tags":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"}]},{"title":"Dubboåº•å±‚åŸç†æ¶æ„å›¾","slug":"distributed/dubboåº•å±‚åŸç†æ¶æ„å›¾","date":"2019-08-03T06:33:00.000Z","updated":"2020-12-27T09:23:14.248Z","comments":true,"path":"2019/08/03/dubbo-bottom-structure-diagram.html","link":"","permalink":"https://liuzhihang.com/2019/08/03/dubbo-bottom-structure-diagram.html","excerpt":"","text":"Javaè¿›é˜¶è®­ç»ƒè¥å­¦ä¹ ç¬”è®°è¯¾ç¨‹: Javaè¿›é˜¶è®­ç»ƒè¥è€å¸ˆ: ä¸­åçŸ³æ‰é‚€è¯·ç : äºŒç»´ç  æ“ä½œæµç¨‹å›¾ 1. æœåŠ¡æ³¨å†Œ, æ•…éšœåŠä¸‹çº¿ æ³¨å†Œ: providerå’ŒconsumeråŒæ—¶åœ¨zkä¸Šæ³¨å†Œä¸´æ—¶èŠ‚ç‚¹, åŒæ—¶consumerè®¢é˜…zk /dubbo/**/providers provideråœ°å€, providerså‘ç”Ÿå˜åŒ–, zkè‡ªåŠ¨æ¨é€ç»™consumer zkä¸Šç»“æ„å¦‚ä¸‹ ls /dubbo/cn.xxx.xxxService[consumers, routers, providers, configurators] [consumer:&#x2F;&#x2F;æœºå™¨ip&#x2F;æ¥å£?application&#x3D;æœåŠ¡å&amp;category&#x3D;consumers&amp;check&#x3D;false&amp;default.check&#x3D;false&amp;default.group&#x3D;beta&amp;default.timeout&#x3D;5000&amp;default.version&#x3D;1.0.0&amp;dubbo&#x3D;2.6.2&amp;interface&#x3D;æ¥å£&amp;methods&#x3D;æ–¹æ³•1,æ–¹æ³•2&amp;pid&#x3D;7828&amp;revision&#x3D;0.0.1&amp;side&#x3D;consumer&amp;timestamp&#x3D;1556173624632] [dubbo:&#x2F;&#x2F;æœºå™¨1ip:ç«¯å£&#x2F;æ¥å£?anyhost&#x3D;true&amp;application&#x3D;WalletOrderApplicationConsumer&amp;delay&#x3D;2000&amp;dubbo&#x3D;2.5.3&amp;group&#x3D;beta&amp;heartbeat&#x3D;10000&amp;interface&#x3D;æ¥å£&amp;methods&#x3D;æ–¹æ³•1,æ–¹æ³•2&amp;pid&#x3D;22419&amp;retries&#x3D;0&amp;revision&#x3D;1.0.0&amp;side&#x3D;provider&amp;timeout&#x3D;10000&amp;timestamp&#x3D;1564743170669&amp;version&#x3D;1.0.0,dubbo:&#x2F;&#x2F;æœºå™¨2ip:ç«¯å£&#x2F;æ¥å£?anyhost&#x3D;true&amp;application&#x3D;WalletOrderApplicationConsumer&amp;delay&#x3D;2000&amp;dubbo&#x3D;2.5.3&amp;group&#x3D;beta&amp;heartbeat&#x3D;10000&amp;interface&#x3D;cn.ipaynow.webank.wallet.order.api.provider.DataCenterTaskService&amp;methods&#x3D;syncRechargesRefund,syncTrans,syncTransCancel,syncTransRefunds,syncRecharges&amp;pid&#x3D;16801&amp;retries&#x3D;0&amp;revision&#x3D;0.0.1&amp;side&#x3D;provider&amp;timeout&#x3D;10000&amp;timestamp&#x3D;1563792977340&amp;version&#x3D;1.0.0] æ•…éšœ: zkè‡ªåŠ¨åˆ é™¤ä¸´æ—¶èŠ‚ç‚¹ ä¸‹çº¿: å–æ¶ˆæ³¨å†Œ, ä¸»åŠ¨åˆ é™¤èŠ‚ç‚¹ 2. Proxy åŠ¨æ€ä»£ç†æ ¹æ®é…ç½®çš„æ¥å£, ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡, ä½¿ç”¨ JDK + JAVAASSIST æ–¹å¼ åœ¨æœåŠ¡æä¾›ç«¯ï¼Œå°†æœåŠ¡çš„å…·ä½“å®ç°ç±»è½¬ä¸ºInvoker åœ¨æ¶ˆè´¹ç«¯ï¼Œé€šè¿‡ getProxy(Invoker invoker)å°†invokerè½¬ä¸ºå®¢æˆ·ç«¯éœ€è¦çš„æ¥å£ Invokerå°è£…äº†Provideråœ°å€åŠServiceæ¥å£ä¿¡æ¯ 3. Cluster é›†ç¾¤å±‚è·å–åˆ°è¦è°ƒç”¨çš„Invoker å¤šä¸ªæœåŠ¡ç«¯ä¼šæœ‰å¤šä¸ª Invokerå¯¹è±¡, ç»„åˆæˆDirectory, Directoryåœ¨zkæ¨é€ProviderèŠ‚ç‚¹å˜æ›´æ—¶, ä¼šå‘ç”Ÿå˜åŒ– Router, æŒ‰ç…§è·¯ç”±è§„åˆ™é€‰å‡ºæœ¬æ¬¡å¯ä»¥è°ƒç”¨çš„ Directoryå­é›†, zkæ³¨å†Œä¸­å¿ƒ routersèŠ‚ç‚¹ä¸‹é…ç½® LoadBalance ä»å­é›†ä¸­æŒ‰ç…§è´Ÿè½½å‡è¡¡é€‰å‡ºæœ¬æ¬¡è°ƒç”¨ Random LoadBalance éšæœº RoundRobin LoadBalance è½®è¯¢ LeastActive LoadBalance æœ€å°‘æ´»è·ƒ ConsistentHash LoadBalance ä¸€è‡´æ€§å“ˆå¸Œ å®¹é”™ Failover Cluster å¤±è´¥è‡ªåŠ¨åˆ‡æ¢ï¼Œå½“å‡ºç°å¤±è´¥ï¼Œé‡è¯•å…¶å®ƒæœåŠ¡å™¨ã€‚é€šå¸¸ç”¨äºè¯»æ“ä½œï¼Œä½†é‡è¯•ä¼šå¸¦æ¥æ›´é•¿å»¶è¿Ÿã€‚å¯é€šè¿‡ retries=â€2â€³ æ¥è®¾ç½®é‡è¯•æ¬¡æ•°(ä¸å«ç¬¬ä¸€æ¬¡)ã€‚ Failfast Clusterï¼šå¿«é€Ÿå¤±è´¥ï¼Œåªå‘èµ·ä¸€æ¬¡è°ƒç”¨ï¼Œå¤±è´¥ç«‹å³æŠ¥é”™ã€‚é€šå¸¸ç”¨äºéå¹‚ç­‰æ€§çš„å†™æ“ä½œï¼Œæ¯”å¦‚æ–°å¢è®°å½•ã€‚ Failsafe Clusterï¼šå¤±è´¥å®‰å…¨ï¼Œå‡ºç°å¼‚å¸¸æ—¶ï¼Œç›´æ¥å¿½ç•¥ã€‚é€šå¸¸ç”¨äºå†™å…¥å®¡è®¡æ—¥å¿—ç­‰æ“ä½œã€‚ Failback Clusterï¼šå¤±è´¥è‡ªåŠ¨æ¢å¤ï¼Œåå°è®°å½•å¤±è´¥è¯·æ±‚ï¼Œå®šæ—¶é‡å‘ã€‚é€šå¸¸ç”¨äºæ¶ˆæ¯é€šçŸ¥æ“ä½œã€‚ Forking Clusterï¼šå¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡å™¨ï¼Œåªè¦ä¸€ä¸ªæˆåŠŸå³è¿”å›ã€‚é€šå¸¸ç”¨äºå®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„è¯»æ“ä½œï¼Œä½†éœ€è¦æµªè´¹æ›´å¤šæœåŠ¡èµ„æºã€‚å¯é€šè¿‡ forks=â€2â€³ æ¥è®¾ç½®æœ€å¤§å¹¶è¡Œæ•°ã€‚ 4. Protocol è¿œç¨‹è°ƒç”¨å±‚åŒ…å«ä¸¤ä¸ªæ¥å£, åˆ†åˆ«æ˜¯ æš´éœ²æœåŠ¡(export) å’Œ å¼•ç”¨æœåŠ¡(refer) åˆ†åˆ«å¯¹åº”provider å’Œ consumeré€‰æ‹©é€šä¿¡åè®® dubbo, hessian, httpç­‰ 5. Exchange æ•°æ®äº¤æ¢å±‚å°†è¯·æ±‚ä¿¡æ¯å°è£…ä¸ºRequest, ç„¶åå‘é€ç»™ Transportå±‚, å¹¶å°†è¿”å›ä¿¡æ¯å°è£…ä¸ºResponse 6. Transport ç½‘ç»œä¼ è¾“å±‚ä½¿ç”¨nettyæˆ–minaè¿›è¡Œç½‘ç»œé€šä¿¡ 7. serialize åºåˆ—åŒ–å±‚å°†è¯·æ±‚æŠ¥æ–‡å’Œè¿”å›æŠ¥æ–‡è®°æ€§åºåˆ—åŒ–å’Œååºåˆ—åŒ– 8. provideræ”¶åˆ°è¯·æ±‚åå…ˆè¿›è¡Œååºåˆ—åŒ–, ç„¶ååœ¨è§£æè¯·æ±‚, é€šè¿‡åŠ¨æ€ä»£ç†è°ƒç”¨ç›¸åº”æ–¹æ³•","categories":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"}],"tags":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"}]},{"title":"SpringBooté¡¹ç›®ä¸­ä½¿ç”¨SpringSecurityå’ŒJWTåšæƒé™è®¤è¯","slug":"spring/springbooté¡¹ç›®ä¸­ä½¿ç”¨springsecurityå’Œjwtåšæƒé™è®¤è¯","date":"2019-07-22T05:36:22.000Z","updated":"2020-12-27T09:23:14.248Z","comments":true,"path":"2019/07/22/springsecurity-jwt-springboot-project.html","link":"","permalink":"https://liuzhihang.com/2019/07/22/springsecurity-jwt-springboot-project.html","excerpt":"","text":"èƒŒæ™¯ å‰æ®µæ—¶é—´åšäº†ä¸€ä¸ªé¡¹ç›®, å› ä¸ºæ¶‰åŠåˆ°æƒé™è®¤è¯, æ‰€ä»¥åˆ†åˆ«è°ƒç ”äº† SpringSecurity å’Œ Apache Shiro. æœ€åé€‰æ‹©ä½¿ç”¨äº† SpringSecurity + JWTåšæƒé™è®¤è¯, ç°åœ¨é¡¹ç›®å·²ç»ç»“æŸ, æ€»ç›¸å…³ç¬”è®°.é¡¹ç›®ä¸‹è½½åœ°å€ jwt-demo ä½¿ç”¨JWTç”Ÿæˆtoken tokenå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ ä½¿ç”¨ application/json ç™»å½• ä½¿ç”¨æ‰‹æœºå·è¿›è¡Œç™»å½• URIåŠ¨æ€æ‹¦æˆª é…ç½®è¿‡ç¨‹æ·»åŠ ä¾èµ– åˆ†åˆ«æ·»åŠ  SpringSecurity JWT å’Œ fastjson ä¾èµ– &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt; &lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt; &lt;artifactId&gt;jjwt&lt;/artifactId&gt; &lt;version&gt;0.9.0&lt;/version&gt;&lt;/dependency&gt;&lt;!--json--&gt;&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;fastjson&lt;/artifactId&gt; &lt;version&gt;1.2.60&lt;/version&gt;&lt;/dependency&gt; åŸºç¡€å‡†å¤‡å¯¹è±¡ ä¸»è¦æ˜¯åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸhandleæ—¶ä½¿ç”¨JWTç”ŸæˆTokenè¿”å›ç»™å®¢æˆ·ç«¯. åŸºç¡€ä½¿ç”¨dtoè¯·æ±‚è¿”å›åŸºç±» @Datapublic class BaseReqDto implements Serializable &#123; private String version;&#125;@Datapublic class BaseRespDto implements Serializable &#123; private String resultCode; private String resultMsg; private String resultTime;&#125; ç™»å½•è¯·æ±‚è¿”å›å¯¹è±¡ @Datapublic class LoginReqDto &#123; private String username; private String token;&#125;@Datapublic class LoginRespDto extends BaseRespDto &#123; private String token;&#125; ç”¨äºéªŒè¯çš„ç”¨æˆ·package com.liuzhihang.demo.bean;import org.springframework.security.core.GrantedAuthority;import org.springframework.security.core.userdetails.UserDetails;import java.io.Serializable;import java.util.Collection;/** * ç”¨æˆ·ä¿¡æ¯æ ¡éªŒéªŒè¯ç  * * @author liuzhihang */public class UserDetailsImpl implements UserDetails, Serializable &#123; /** * ç”¨æˆ·å */ private String username; /** * å¯†ç  */ private String password; /** * æƒé™é›†åˆ */ private Collection&lt;? extends GrantedAuthority&gt; authorities; @Override public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123; return this.authorities; &#125; public void setAuthorities(Collection&lt;? extends GrantedAuthority&gt; authorities) &#123; this.authorities = authorities; &#125; @Override public String getPassword() &#123; return this.password; &#125; @Override public String getUsername() &#123; return this.username; &#125; public void setUsername(String username) &#123; this.username = username; &#125; public void setPassword(String password) &#123; this.password = password; &#125; @Override public boolean isAccountNonExpired() &#123; return true; &#125; @Override public boolean isAccountNonLocked() &#123; return true; &#125; @Override public boolean isCredentialsNonExpired() &#123; return true; &#125; @Override public boolean isEnabled() &#123; return true; &#125;&#125; ç”¨æˆ·æœªç™»å½•handle/** * ç”¨æˆ·ç™»å½•è®¤è¯, æœªç™»å½•è¿”å›ä¿¡æ¯ * * @author liuzhihang * @date 2019-06-04 13:52 */@Componentpublic class AuthenticationEntryPointImpl implements AuthenticationEntryPoint &#123; private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyyMMddHHmmss&quot;); @Override public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException &#123; response.setContentType(&quot;application/json;charset=UTF-8&quot;); LoginRespDto respDto = new LoginRespDto(); respDto.setResultCode(&quot;0001&quot;); respDto.setResultMsg(&quot;ç”¨æˆ·æœªç™»å½•&quot;); respDto.setResultTime(LocalDateTime.now().format(FORMATTER)); response.getWriter().write(JSON.toJSONString(respDto)); &#125;&#125; ç”¨æˆ·ç™»å½•éªŒè¯å¤±è´¥handle/** * ç”¨æˆ·ç™»å½•è®¤è¯å¤±è´¥è¿”å›çš„ä¿¡æ¯ * * @author liuzhihang * @date 2019-06-04 13:57 */@Componentpublic class AuthenticationFailureHandlerImpl implements AuthenticationFailureHandler &#123; private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyyMMddHHmmss&quot;); @Override public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException &#123; response.setContentType(&quot;application/json;charset=UTF-8&quot;); LoginRespDto respDto = new LoginRespDto(); respDto.setResultCode(&quot;0001&quot;); respDto.setResultMsg(&quot;ç”¨æˆ·ç™»å½•è®¤è¯å¤±è´¥&quot;); respDto.setResultTime(LocalDateTime.now().format(FORMATTER)); response.getWriter().write(JSON.toJSONString(respDto)); &#125;&#125; ç”¨æˆ·æ— æƒè®¿é—®handle/** * å½“ç”¨æˆ·è®¿é—®æ— æƒé™é¡µé¢æ—¶, è¿”å›ä¿¡æ¯ * * @author liuzhihang * @date 2019-06-04 14:03 */@Componentpublic class AccessDeniedHandlerImpl implements AccessDeniedHandler &#123; private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyyMMddHHmmss&quot;); @Override public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) throws IOException &#123; response.setContentType(&quot;application/json;charset=UTF-8&quot;); LoginRespDto respDto = new LoginRespDto(); respDto.setResultCode(&quot;0002&quot;); respDto.setResultMsg(&quot;ç”¨æˆ·æ— æƒè®¿é—®&quot;); respDto.setResultTime(LocalDateTime.now().format(FORMATTER)); response.getWriter().write(JSON.toJSONString(respDto)); &#125;&#125; ç”¨æˆ·ç™»å½•æˆåŠŸhandle/** * ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åçš„è¿”å›ä¿¡æ¯ * * @author liuzhihang * @date 2019-06-04 14:20 */@Slf4j@Componentpublic class AuthenticationSuccessHandlerImpl implements AuthenticationSuccessHandler &#123; private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyyMMddHHmmss&quot;); @Resource private JwtTokenUtil jwtTokenUtil; @Override public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException &#123; UserDetailsImpl userDetails = (UserDetailsImpl) authentication.getPrincipal(); String jwtToken = jwtTokenUtil.generateToken(userDetails); // æŠŠç”Ÿæˆçš„tokenæ›´æ–°åˆ°æ•°æ®åº“ä¸­ // æ›´æ–°DBæ“ä½œ ... response.setContentType(&quot;application/json;charset=UTF-8&quot;); LoginRespDto respDto = new LoginRespDto(); respDto.setToken(jwtToken); respDto.setResultCode(&quot;0000&quot;); respDto.setResultMsg(&quot;ç™»å½•æˆåŠŸ&quot;); respDto.setResultTime(LocalDateTime.now().format(FORMATTER)); response.getWriter().write(JSON.toJSONString(respDto)); &#125;&#125; JwtTokenUtilä¸»è¦ç”¨æ¥ç”Ÿæˆtokenå’Œé€šè¿‡tokenè§£æå¯¹è±¡ç­‰æ“ä½œ. package com.liuzhihang.demo.utils;import com.liuzhihang.demo.bean.UserDetailsImpl;import io.jsonwebtoken.Claims;import io.jsonwebtoken.Jwts;import io.jsonwebtoken.SignatureAlgorithm;import org.springframework.security.core.userdetails.UserDetails;import org.springframework.stereotype.Component;import java.time.Instant;import java.util.Date;/** * ä½¿ç”¨ java-jwt jwtç±»åº“ * * @author liuzhihang * @date 2019-06-05 09:22 */@Componentpublic class JwtTokenUtil &#123; private static final SignatureAlgorithm SIGN_TYPE = SignatureAlgorithm.HS256; public static final String SECRET = &quot;jwt-secret&quot;; /** * JWTè¶…æ—¶æ—¶é—´ */ public static final long EXPIRED_TIME = 7 * 24 * 60 * 60 * 1000L; /** * claims ä¸ºè‡ªå®šä¹‰çš„ç§æœ‰å£°æ˜, è¦æ”¾åœ¨å‰é¢ * &lt;p&gt; * ç”Ÿæˆtoken */ public String generateToken(UserDetails userDetails) &#123; long instantNow = Instant.now().toEpochMilli(); Claims claims = Jwts.claims(); claims.put(Claims.SUBJECT, userDetails.getUsername()); return Jwts.builder().setClaims(claims).setIssuedAt(new Date(instantNow)) .setExpiration(new Date(instantNow + EXPIRED_TIME)) .signWith(SIGN_TYPE, SECRET).compact(); &#125; /** * claims ä¸ºè‡ªå®šä¹‰çš„ç§æœ‰å£°æ˜, è¦æ”¾åœ¨å‰é¢ * &lt;p&gt; * ç”Ÿæˆtoken */ public String generateToken(String userName) &#123; long instantNow = Instant.now().toEpochMilli(); Claims claims = Jwts.claims(); claims.put(Claims.SUBJECT, userName); return Jwts.builder().setClaims(claims).setIssuedAt(new Date(instantNow)) .setExpiration(new Date(instantNow + EXPIRED_TIME)) .signWith(SIGN_TYPE, SECRET).compact(); &#125; /** * å°†tokenè§£æ, æ˜ å°„ä¸º UserDetails * * @param jwtToken * @return */ public UserDetails getUserDetailsFromToken(String jwtToken) &#123; Claims claimsFromToken = getClaimsFromToken(jwtToken); String userName = claimsFromToken.get(Claims.SUBJECT, String.class); UserDetailsImpl userDetails = new UserDetailsImpl(); userDetails.setUsername(userName); return userDetails; &#125; /** * éªŒè¯token */ public Boolean validateToken(String token, UserDetails userDetails) &#123; UserDetailsImpl user = (UserDetailsImpl) userDetails; String username = getPhoneNoFromToken(token); return (username.equals(user.getUsername()) &amp;&amp; !isTokenExpired(token)); &#125; /** * åˆ·æ–°ä»¤ç‰Œ * * @param token åŸä»¤ç‰Œ * @return æ–°ä»¤ç‰Œ */ public String refreshToken(String token) &#123; String refreshedToken; try &#123; Claims claims = getClaimsFromToken(token); long instantNow = Instant.now().toEpochMilli(); refreshedToken = Jwts.builder().setClaims(claims).setIssuedAt(new Date(instantNow)) .setExpiration(new Date(instantNow + EXPIRED_TIME)) .signWith(SIGN_TYPE, SECRET).compact(); &#125; catch (Exception e) &#123; refreshedToken = null; &#125; return refreshedToken; &#125; /** * è·å–tokenæ˜¯å¦è¿‡æœŸ */ public Boolean isTokenExpired(String token) &#123; Date expiration = getExpirationDateFromToken(token); return expiration.before(new Date()); &#125; /** * æ ¹æ®tokenè·å–username */ public String getPhoneNoFromToken(String token) &#123; return getClaimsFromToken(token).getSubject(); &#125; /** * è·å–tokençš„è¿‡æœŸæ—¶é—´ */ public Date getExpirationDateFromToken(String token) &#123; return getClaimsFromToken(token).getExpiration(); &#125; /** * è§£æJWT */ private Claims getClaimsFromToken(String token) &#123; return Jwts.parser().setSigningKey(SECRET).parseClaimsJws(token).getBody(); &#125;&#125; WebSecurityConfig æ ¸å¿ƒé…ç½®package com.liuzhihang.demo.config;import com.liuzhihang.demo.filter.CustomizeAuthenticationFilter;import com.liuzhihang.demo.filter.JwtPerTokenFilter;import com.liuzhihang.demo.service.UserDetailServiceImpl;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Bean;import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;import org.springframework.security.config.annotation.web.builders.HttpSecurity;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;import org.springframework.security.config.http.SessionCreationPolicy;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;import org.springframework.security.crypto.password.PasswordEncoder;import org.springframework.security.web.AuthenticationEntryPoint;import org.springframework.security.web.access.AccessDeniedHandler;import org.springframework.security.web.authentication.AuthenticationFailureHandler;import org.springframework.security.web.authentication.AuthenticationSuccessHandler;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;import javax.annotation.Resource;/** * @author liuzhihang * @date 2019-06-03 14:25 */@EnableWebSecuritypublic class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123; @Autowired private UserDetailServiceImpl userDetailServiceImpl; @Resource private JwtPerTokenFilter jwtPerTokenFilter; @Resource(name = &quot;authenticationEntryPointImpl&quot;) private AuthenticationEntryPoint authenticationEntryPoint; @Resource(name = &quot;authenticationSuccessHandlerImpl&quot;) private AuthenticationSuccessHandler authenticationSuccessHandler; @Resource(name = &quot;authenticationFailureHandlerImpl&quot;) private AuthenticationFailureHandler authenticationFailureHandler; @Resource(name = &quot;accessDeniedHandlerImpl&quot;) private AccessDeniedHandler accessDeniedHandler; /** * åˆ›å»ºç”¨äºè®¤è¯æˆæƒçš„ç”¨æˆ· * * @param auth * @throws Exception */ @Autowired public void configureUserInfo(AuthenticationManagerBuilder auth) throws Exception &#123; // æ”¾å…¥è‡ªå·±çš„è®¤è¯æˆæƒç”¨æˆ·, å†…éƒ¨é€»è¾‘éœ€è¦è‡ªå·±å®ç° // UserDetailServiceImpl implements UserDetailsService auth.userDetailsService(userDetailServiceImpl); &#125; @Override protected void configure(HttpSecurity http) throws Exception &#123; http // ä½¿ç”¨JWT, å…³é—­session .csrf().disable().sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) .and().httpBasic().authenticationEntryPoint(authenticationEntryPoint) // ç™»å½•çš„æƒé™, æˆåŠŸè¿”å›ä¿¡æ¯, å¤±è´¥è¿”å›ä¿¡æ¯ .and().formLogin().permitAll() .loginProcessingUrl(&quot;/login&quot;) // é…ç½®url æƒé™ antMatchers: åŒ¹é…url æƒé™ .and().authorizeRequests() .antMatchers(&quot;/login&quot;, &quot;/getVersion&quot;) .permitAll() // å…¶ä»–éœ€è¦ç™»å½•æ‰èƒ½è®¿é—® .anyRequest().access(&quot;@dynamicAuthorityService.hasPermission(request,authentication)&quot;) // è®¿é—®æ— æƒé™ location æ—¶ .and().exceptionHandling().accessDeniedHandler(accessDeniedHandler) // è‡ªå®šä¹‰è¿‡æ»¤ .and().addFilterAt(customAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class) .addFilterBefore(jwtPerTokenFilter, UsernamePasswordAuthenticationFilter.class) .headers().cacheControl(); &#125; /** * å¯†ç åŠ å¯†å™¨ */ @Bean public PasswordEncoder passwordEncoder() &#123; /** * BCryptPasswordEncoderï¼šç›¸åŒçš„å¯†ç æ˜æ–‡æ¯æ¬¡ç”Ÿæˆçš„å¯†æ–‡éƒ½ä¸åŒï¼Œå®‰å…¨æ€§æ›´é«˜ */ return new BCryptPasswordEncoder(); &#125; @Bean CustomizeAuthenticationFilter customAuthenticationFilter() throws Exception &#123; CustomizeAuthenticationFilter filter = new CustomizeAuthenticationFilter(); filter.setAuthenticationSuccessHandler(authenticationSuccessHandler); filter.setAuthenticationFailureHandler(authenticationFailureHandler); filter.setAuthenticationManager(authenticationManagerBean()); return filter; &#125;&#125; ç™»å½•æ ¡éªŒè¿‡ç¨‹graph TD; A(è¯·æ±‚ç™»å½•) --&gt; B(CustomizeAuthenticationFilter#attemptAuthentication è§£æè¯·æ±‚çš„json); B --&gt; C(UserDetailServiceImpl#loadUserByUsername éªŒè¯ç”¨æˆ·åå¯†ç ); C --&gt; D(AuthenticationSuccessHandlerImpl#onAuthenticationSuccess æ„å»ºè¿”å›å‚æ•° åŒ…æ‹¬token); D --&gt; E(è¿”å›ç»“æœ) è‡ªå®šä¹‰æ‹¦æˆªå™¨è§£æ json æŠ¥æ–‡å‰ç«¯è¯·æ±‚ç™»å½•æŠ¥æ–‡ç±»å‹ä¸º application/json éœ€è¦åç«¯å¢åŠ æ‹¦æˆªå™¨, å¯¹ç™»å½•è¯·æ±‚æŠ¥æ–‡è¿›è¡Œè§£æ package com.liuzhihang.demo.filter;import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.JSONException;import com.alibaba.fastjson.JSONObject;import lombok.extern.slf4j.Slf4j;import org.springframework.http.MediaType;import org.springframework.security.authentication.AuthenticationServiceException;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;import org.springframework.security.core.Authentication;import org.springframework.security.core.AuthenticationException;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import java.io.BufferedReader;import java.io.IOException;/** * * è‡ªå®šä¹‰æ‹¦æˆªå™¨, é‡å†™UsernamePasswordAuthenticationFilter ä»è€Œå¯ä»¥å¤„ç† application/json ä¸­çš„jsonè¯·æ±‚æŠ¥æ–‡ * * @author liuzhihang * @date 2019-06-12 19:04 */@Slf4jpublic class CustomizeAuthenticationFilter extends UsernamePasswordAuthenticationFilter &#123; @Override public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException &#123; // attempt Authentication when Content-Type is json if (request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_UTF8_VALUE) || request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_VALUE)) &#123; try &#123; BufferedReader br = request.getReader(); String str; StringBuilder jsonStr = new StringBuilder(); while ((str = br.readLine()) != null) &#123; jsonStr.append(str); &#125; log.info(&quot;æœ¬æ¬¡ç™»å½•è¯·æ±‚å‚æ•°:&#123;&#125;&quot;, jsonStr); JSONObject jsonObject = JSON.parseObject(jsonStr.toString()); UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken( jsonObject.getString(&quot;username&quot;), jsonObject.getString(&quot;password&quot;)); setDetails(request, authRequest); return this.getAuthenticationManager().authenticate(authRequest); &#125; catch (IOException e) &#123; log.info(&quot;ç”¨æˆ·ç™»å½•, è¯·æ±‚å‚æ•° ä¸æ­£ç¡®&quot;); throw new AuthenticationServiceException(&quot;è·å–æŠ¥æ–‡è¯·æ±‚å‚æ•°å¤±è´¥&quot;); &#125; catch (JSONException e) &#123; log.info(&quot;ç”¨æˆ·ç™»å½•, è¯·æ±‚æŠ¥æ–‡æ ¼å¼ ä¸æ­£ç¡®&quot;); throw new AuthenticationServiceException(&quot;è¯·æ±‚æŠ¥æ–‡, è½¬æ¢Jsonå¤±è´¥&quot;); &#125; &#125; else &#123; log.error(&quot;ç”¨æˆ·ç™»å½•, contentType ä¸æ­£ç¡®&quot;); throw new AuthenticationServiceException( &quot;è¯·æ±‚ contentType ä¸æ­£ç¡®, è¯·ä½¿ç”¨ application/json;charset=UTF-8 æˆ–è€… application/json;&quot;); &#125; &#125;&#125; ç”¨æˆ·è®¤è¯æ¨¡å— æ ¹æ®è·å–åˆ°çš„usernameä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°å¯†ç , å°†ç”¨æˆ·åå¯†ç èµ‹å€¼ç»™UserDetailså¯¹è±¡, è¿”å›å…¶ä»–çš„æ¡†æ¶ä¼šè¿›è¡Œæ ¡éªŒ è¿™è¾¹ä½¿ç”¨ä¸­æ˜¯ä½¿ç”¨çš„æ‰‹æœºå·+éªŒè¯ç ç™»å½•, æ‰€ä»¥ ä¸Šé¢jsonè§£æçš„ä¹Ÿæ˜¯ phoneNo+verificationCode åœ¨è¿™å— usernameä»…ä»…ä»£æŒ‡ç™»å½•å, å¯ä»¥æ˜¯æ‰‹æœºå·å¯ä»¥æ˜¯åˆ«çš„. è¿™è¾¹ä½¿ç”¨ä¸­éªŒè¯ç æ˜¯ä»redisä¸­è·å–çš„. è·å–ä¸åˆ°è¿”å›å¤±è´¥, è·å–åˆ°å’Œä¼ é€’çš„ä¸ä¸€è‡´ä¹Ÿç®—å¤±è´¥. package com.liuzhihang.demo.service;import com.liuzhihang.demo.bean.UserDetailsImpl;import lombok.extern.slf4j.Slf4j;import org.springframework.security.core.userdetails.UserDetails;import org.springframework.security.core.userdetails.UserDetailsService;import org.springframework.security.core.userdetails.UsernameNotFoundException;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;import org.springframework.stereotype.Component;/** * @author liuzhihang */@Slf4j@Component(&quot;userDetailServiceImpl&quot;)public class UserDetailServiceImpl implements UserDetailsService &#123; /** * ç”¨æ¥éªŒè¯ç™»å½•åæ˜¯å¦æœ‰æƒé™è¿›è¡Œç™»å½• * * å¯ä»¥é€šè¿‡æ•°æ®åº“è¿›è¡Œæ ¡éªŒ ä¹Ÿå¯ä»¥é€šè¿‡redis ç­‰ç­‰ * * @param username * @return * @throws UsernameNotFoundException */ @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123; UserDetailsImpl userDetailsImpl = new UserDetailsImpl(); userDetailsImpl.setUsername(&quot;liuzhihang&quot;); userDetailsImpl.setPassword(new BCryptPasswordEncoder().encode(&quot;123456789&quot;)); return userDetailsImpl; &#125;&#125; è¯·æ±‚æ ¡éªŒè¿‡ç¨‹graph TD; A(è¯·æ±‚æ¥å£) --&gt; B(JwtPerTokenFilter#doFilterInternal éªŒè¯Headerä¸­çš„token); B --&gt; C(DynamicAuthorityService#hasPermission éªŒè¯æœ‰æ²¡æœ‰è¯·æ±‚urlæƒé™); C --&gt; D(å¤„ç†é€»è¾‘); D --&gt; E(è¿”å›ç»“æœ) JWTTokenæ‹¦æˆªå™¨ä¸»è¦æ˜¯æ‹¦æˆªè¯·æ±‚, éªŒè¯Headerä¸­çš„tokenæ˜¯å¦æ­£ç¡® package com.liuzhihang.demo.filter;import com.liuzhihang.demo.utils.JwtTokenUtil;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;import org.springframework.security.core.context.SecurityContextHolder;import org.springframework.security.core.userdetails.UserDetails;import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;import org.springframework.stereotype.Component;import org.springframework.web.filter.OncePerRequestFilter;import javax.servlet.FilterChain;import javax.servlet.ServletException;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import java.io.IOException;/** * @author liuzhihang * @date 2019-06-05 09:09 */@Slf4j@Componentpublic class JwtPerTokenFilter extends OncePerRequestFilter &#123; @Autowired private JwtTokenUtil jwtTokenUtil; /** * å­˜æ”¾Tokençš„Header Key */ private static final String HEADER_STRING = &quot;token&quot;; @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123; String token = request.getHeader(HEADER_STRING); if (null != token &amp;&amp; !jwtTokenUtil.isTokenExpired(token)) &#123; UserDetails userDetails = jwtTokenUtil.getUserDetailsFromToken(token); String username = userDetails.getUsername(); if (username != null &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null) &#123; // é€šè¿‡ username æŸ¥è¯¢æ•°æ®åº“ è·å–token ç„¶åå’Œåº“ä¸­tokenä½œæ¯”è¾ƒ if (username.equals(&quot;liuzhihang&quot;)) &#123; UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities()); authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request)); SecurityContextHolder.getContext().setAuthentication(authentication); &#125; &#125; &#125; filterChain.doFilter(request, response); &#125;&#125; URIåŠ¨æ€æ ¡éªŒpackage com.liuzhihang.demo.service;import lombok.extern.slf4j.Slf4j;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;import org.springframework.security.core.Authentication;import org.springframework.security.core.userdetails.UserDetails;import org.springframework.stereotype.Component;import javax.servlet.http.HttpServletRequest;import java.util.HashSet;import java.util.Set;/** * åŠ¨æ€æƒé™è®¤è¯ * * @author liuzhihang * @date 2019-06-25 15:51 */@Slf4j@Component(value = &quot;dynamicAuthorityService&quot;)public class DynamicAuthorityService &#123; public boolean hasPermission(HttpServletRequest request, Authentication authentication) &#123; try &#123; Object principal = authentication.getPrincipal(); if (principal instanceof UserDetails &amp;&amp; authentication instanceof UsernamePasswordAuthenticationToken) &#123; // æœ¬æ¬¡è¯·æ±‚çš„uri String uri = request.getRequestURI(); // è·å–å½“å‰ç”¨æˆ· UserDetails userDetails = (UserDetails) principal; String username = userDetails.getUsername(); log.info(&quot;æœ¬æ¬¡ç”¨æˆ·è¯·æ±‚è®¤è¯, username:&#123;&#125;, uri:&#123;&#125;&quot;, username, uri); // ä»æ•°æ®åº“å–é€»è¾‘ if (username.equals(&quot;liuzhihang&quot;))&#123; Set&lt;String&gt; set = new HashSet&lt;&gt;(); set.add(&quot;/homeInfo&quot;); set.add(&quot;/getAllUser&quot;); set.add(&quot;/editUserInfo&quot;); if (set.contains(uri)) &#123; return true; &#125; &#125; &#125; &#125; catch (Exception e) &#123; log.error(&quot;ç”¨æˆ·è¯·æ±‚ç™»å½•, uri:&#123;&#125; error&quot;, request.getRequestURI(), e); return false; &#125; return false; &#125;&#125; æµ‹è¯•è„šæœ¬åœ¨ httpclientè„šæœ¬ POST localhost:8080/loginContent-Type: application/json&#123; &quot;username&quot;: &quot;liuzhihang&quot;, &quot;password&quot;: &quot;123456789&quot;&#125;### è¯·æ±‚æ¥å£è„šæœ¬POST localhost:8080/homeInfoContent-Type: application/jsontoken: eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJsaXV6aGloYW5nIiwiaWF0IjoxNTY5MDI1NjY4LCJleHAiOjE1Njk2MzA0Njh9.Kot_uLnwtcq-t5o4x3V-xBnpf-mKEi7OV2eAfgMCKLk### è¿”å›: &#123; &quot;resultCode&quot;: &quot;0000&quot;, &quot;resultMsg&quot;: &quot;ç™»å½•æˆåŠŸ&quot;, &quot;resultTime&quot;: &quot;20190920191038&quot;, &quot;token&quot;: &quot;eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJsaXV6aGloYW5nIiwiaWF0IjoxNTY4OTc3ODM4LCJleHAiOjE1Njk1ODI2Mzh9.MAS9VkFdCF3agkCgTtc0VzPMFjY42vFyIvAEzkSeAfs&quot;&#125; å‚è€ƒå‰åç«¯åˆ†ç¦» SpringBoot + SpringSecurity + JWT + RBAC å®ç°ç”¨æˆ·æ— çŠ¶æ€è¯·æ±‚éªŒè¯","categories":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/categories/Spring/"}],"tags":[{"name":"JWT","slug":"JWT","permalink":"https://liuzhihang.com/tags/JWT/"},{"name":"SpringSecurity","slug":"SpringSecurity","permalink":"https://liuzhihang.com/tags/SpringSecurity/"}]},{"title":"Gitalkä½¿ç”¨MD5ç”ŸæˆId","slug":"hexo/Gitalkä½¿ç”¨MD5ç”ŸæˆId","date":"2019-07-20T07:43:07.000Z","updated":"2020-04-07T11:58:47.380Z","comments":true,"path":"2019/07/20/gitalk-uses-md5-to-generate-an-id.html","link":"","permalink":"https://liuzhihang.com/2019/07/20/gitalk-uses-md5-to-generate-an-id.html","excerpt":"","text":"Gitalké»˜è®¤ä½¿ç”¨: location.pathname ä½œä¸º gitalk çš„id, ä½†æ˜¯location.pathå¿…é¡»å°äº50ä½åˆ‡æ¢ä¸»é¢˜æ—¶, æ¯ä¸ªä¸»é¢˜ä½¿ç”¨çš„å¤„ç†æ–¹å¼éƒ½ä¸ç›¸åŒ, æœ‰å¯èƒ½ä¼šå¯¼è‡´æ¢äº†ä¸»é¢˜, å‘ç°ä¹‹å‰çš„è¯„è®ºä¸è§äº†, ä¸‹é¢ä»‹ç»ä½¿ç”¨MD5ä½œä¸ºid, åŒæ—¶åœ¨æ¢ä¸»é¢˜æ—¶ä¸€å®šè¦ä¿®æ”¹è¿™ä¸ªidçš„è§„åˆ™. Gitalkä½¿ç”¨ä½¿ç”¨Gitalkæ–¹æ³•: var gitalk = new Gitalk(&#123; clientID: &#x27;GitHub Application Client ID&#x27;, clientSecret: &#x27;GitHub Application Client Secret&#x27;, repo: &#x27;GitHub repo&#x27;, owner: &#x27;GitHub repo owner&#x27;, admin: [&#x27;GitHub repo owner and collaborators, only these guys can initialize github issues&#x27;], id: location.pathname, // Ensure uniqueness and length less than 50 distractionFreeMode: false // Facebook-like distraction free mode&#125;)gitalk.render(&#x27;gitalk-container&#x27;) ä½¿ç”¨MD5ç”Ÿæˆid å¼•å…¥js MD5 js ä¸‹è½½åœ°å€ &lt;script src=&quot;js/md5.min.js&quot;&gt;&lt;/script&gt; ä¿®æ”¹js &lt;script&gt; var gitalk_id = md5(location.pathname) if (&lt;%- page.comments_type == &#x27;404&#x27; %&gt;) &#123; gitalk_id = md5(&#x27;https://liuzhihang.com/404&#x27;) &#125; let gitalk = new Gitalk(&#123; clientID: &#x27;&lt;%- theme.gitalk.oauth.clientId %&gt;&#x27;, clientSecret: &#x27;&lt;%- theme.gitalk.oauth.clientSecret %&gt;&#x27;, repo: &#x27;&lt;%- theme.gitalk.repo %&gt;&#x27;, owner: &#x27;&lt;%- theme.gitalk.owner %&gt;&#x27;, admin: &lt;%- JSON.stringify(theme.gitalk.admin) %&gt;, id: gitalk_id, distractionFreeMode: false // Facebook-like distraction free mode &#125;); gitalk.render(&#x27;gitalk-container&#x27;);&lt;/script&gt;","categories":[{"name":"hexo","slug":"hexo","permalink":"https://liuzhihang.com/categories/hexo/"}],"tags":[{"name":"hexo","slug":"hexo","permalink":"https://liuzhihang.com/tags/hexo/"}]},{"title":"IDEAæ’ä»¶--Toolkit","slug":"plugin/tookit","date":"2019-05-11T06:50:48.000Z","updated":"2020-12-27T09:23:14.596Z","comments":true,"path":"2019/05/11/idea-plugin-toolkit.html","link":"","permalink":"https://liuzhihang.com/2019/05/11/idea-plugin-toolkit.html","excerpt":"","text":"Toolkit ä¸€ä¸ªå°å·¥å…·åŒ…, æš‚æ—¶è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½éœ€è¦æ‰©å±•. ç‰¹å¾ Mybatis é€šè¿‡ä¾§æ ç®­å¤´åœ¨ MyBatis XMLæ–‡ä»¶å’Œ Mapperæ–‡ä»¶ä¹‹é—´ç›¸äº’è·³è½¬ mapperæ–‡ä»¶idç®€å•æ£€æŸ¥ Json JavaBeanå¤åˆ¶ä¸ºJsonå­—ç¬¦ä¸² Jsonå­—ç¬¦ä¸²æ ¼å¼åŒ– Jsonå­—ç¬¦ä¸²è½¬æ¢ä¸ºJavaBean Jsonå‹ç¼© XML: Xmlæ ¼å¼åŒ– æ¼”ç¤º æ–‡æœ«æ¼”ç¤º å®‰è£… åœ¨çº¿å®‰è£…: File -&gt; Setting -&gt; Plugins -&gt; æœç´¢ Toolkit æ‰‹åŠ¨å®‰è£…: ä¸‹è½½æ’ä»¶ -&gt; File -&gt; Setting -&gt; Plugins -&gt; Install Plugin from Disk... ä½¿ç”¨ å³é”®èœå•é€‰æ‹© Tookit æ›´æ–°v1.0.7 (2020-02-27) ä¿®æ”¹ä½¿ç”¨åŒ…è£…ç±»å‹ æŸ¥çœ‹æ›´å¤šå†å²æ›´æ–°è®°å½• æ„Ÿè°¢MyBatis:&emsp;mybatis support: https://github.com/zhaoqin102/mybatis-support &emsp;free-idea-mybatis: https://github.com/wuzhizhan/free-idea-mybatis Json:&emsp;GsonFormat: https://github.com/zzz40500/GsonFormat æœ¬å·¥å…·ä½¿ç”¨ JetBrains IDEA è¿›è¡Œå¼€å‘ æ¼”ç¤º","categories":[{"name":"IDEA","slug":"IDEA","permalink":"https://liuzhihang.com/categories/IDEA/"}],"tags":[{"name":"plugin","slug":"plugin","permalink":"https://liuzhihang.com/tags/plugin/"}]},{"title":"elasticsearch cat API","slug":"elk/es-cat","date":"2019-03-14T14:01:00.000Z","updated":"2020-04-04T06:17:45.542Z","comments":true,"path":"2019/03/14/elasticsearch-cat-api.html","link":"","permalink":"https://liuzhihang.com/2019/03/14/elasticsearch-cat-api.html","excerpt":"cat APIå®˜æ–¹åœ°å€ GET /_cat/XXX?vGET /_cat/XXX?v&amp;format=json v æ˜¯æŒ‡å¸¦ç€åˆ—ä¿¡æ¯ æ”¯æŒæŒ‡å®šè¿”å›å†…å®¹çš„æ ¼å¼ é»˜è®¤ä¸ºtext ?format=text(json/smile/yaml/cbor)","text":"cat APIå®˜æ–¹åœ°å€ GET /_cat/XXX?vGET /_cat/XXX?v&amp;format=json v æ˜¯æŒ‡å¸¦ç€åˆ—ä¿¡æ¯ æ”¯æŒæŒ‡å®šè¿”å›å†…å®¹çš„æ ¼å¼ é»˜è®¤ä¸ºtext ?format=text(json/smile/yaml/cbor) æŸ¥çœ‹èŠ‚ç‚¹åˆ«å GET /_cat/aliases?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/aliases?vâ€ æ¯ä¸ªèŠ‚ç‚¹åˆ†é…äº†å‡ ä¸ªshardï¼Œå¯¹ç£ç›˜çš„å ç”¨ç©ºé—´å¤§å°ï¼Œä½¿ç”¨ç‡ GET /_cat/allocation?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/allocation?vâ€ ç¾¤é›†æˆ–å•ä¸ªç´¢å¼•çš„documentè®¡æ•° GET /_cat/count?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/count?v GET /_cat/count/index_name?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/count/index_name?vâ€ æ˜¾ç¤ºé›†ç¾¤ä¸­æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ä¸Šfielddataå½“å‰æ­£åœ¨ä½¿ç”¨çš„å †å†…å­˜é‡ GET /_cat/fielddata?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/fielddata?vâ€ æŸ¥çœ‹é›†ç¾¤å¥åº·æƒ…å†µ GET /_cat/health?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/health?vâ€ æŸ¥çœ‹ç´¢å¼•çš„ä¿¡æ¯ GET _cat/indices?vGET _cat/indices/index_name?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/indices/twi*?v&amp;s=indexâ€ æŸ¥çœ‹masterä¿¡æ¯ GET /_cat/master?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/master?vâ€ æŸ¥çœ‹nodeä¿¡æ¯ GET /_cat/nodes?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/nodes?vâ€ å½“å‰pendingæ²¡æ‰§è¡Œå®Œçš„taskçš„å…·ä½“æƒ…å†µï¼Œæ‰§è¡Œçš„æ˜¯ä»€ä¹ˆæ“ä½œ åˆ›å»ºç´¢å¼•ï¼Œæ›´æ–°æ˜ å°„ï¼Œåˆ†é…æˆ–å¤±è´¥åˆ†ç‰‡çš„åˆ—è¡¨GET /_cat/pending_tasks?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/pending_tasks?vâ€ æŸ¥çœ‹å®‰è£…çš„æ’ä»¶ GET /_cat/plugins?v&amp;s=component&amp;h=name,component,version,descriptioncurl -X GET â€œ192.168.xxx.xxx:9200/_cat/plugins?v&amp;s=component&amp;h=name,component,version,descriptionâ€ shard recoveryæ¢å¤çš„è¿‡ç¨‹æƒ…å†µ GET /_cat/recovery?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/recovery?vâ€ æŸ¥çœ‹åœ¨ç¾¤é›†ä¸­æ³¨å†Œçš„å¿«ç…§å­˜å‚¨åº“ GET /_cat/repositories?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/repositories?v æŸ¥çœ‹çº¿ç¨‹æ± ä½¿ç”¨ GET /_cat/thread_poolcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/thread_poolâ€ æŸ¥çœ‹shardæƒ…å†µ GET _cat/shards?vGET _cat/shards/index_name?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/shards/index_name?v ç´¢å¼•segmentæ–‡ä»¶çš„æƒ…å†µï¼Œåœ¨å“ªä¸ªnodeä¸Šï¼Œæœ‰å¤šå°‘ä¸ªdocumentï¼Œå ç”¨äº†å¤šå°‘ç£ç›˜ç©ºé—´ï¼Œæœ‰å¤šå°‘æ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæ˜¯å¦å¯ä»¥æœç´¢ GET /_cat/segments?vGET _cat/segments/index_name?vcurl -X GET â€œ192.168.xxx.xxx:9200/_cat/segments/index_name?v æŸ¥çœ‹tempalte GET /_cat/templates?v&amp;s=namecurl -X GET â€œ192.168.xxx.xxx:9200/_cat/templates?v&amp;s=nameâ€","categories":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/categories/ELK/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"ä¸ºä»€ä¹ˆesé›†ç¾¤è‡³å°‘éœ€è¦ä¸‰ä¸ªèŠ‚ç‚¹","slug":"elk/esé›†ç¾¤è‡³å°‘ä¸‰ä¸ªèŠ‚ç‚¹","date":"2019-03-13T13:01:04.000Z","updated":"2020-06-18T08:23:00.411Z","comments":true,"path":"2019/03/13/why-does-the-es-cluster-require-at-least-three-nodes.html","link":"","permalink":"https://liuzhihang.com/2019/03/13/why-does-the-es-cluster-require-at-least-three-nodes.html","excerpt":"elasticsearché›†ç¾¤graph LR; A(Master Node) --- B(Data Node); A --- C(Data Node); B --- C; Master: åœ¨Elasticsearchä¸­Masterä»…ä»…è´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ åˆ›å»ºæˆ–åˆ é™¤ç´¢å¼• è·Ÿè¸ªå“ªäº›èŠ‚ç‚¹æ˜¯é›†ç¾¤çš„ä¸€éƒ¨åˆ† å†³å®šå°†å“ªäº›ç¢ç‰‡åˆ†é…ç»™å“ªä¸ªèŠ‚ç‚¹ ç­‰é›†ç¾¤èŒƒå›´çš„æ“ä½œ ä¸Šé¢çš„ä¸€äº›é›†ç¾¤ä¿¡æ¯, æ˜¯ç”±MasterèŠ‚ç‚¹è¿›è¡Œç»´æŠ¤, ä½†æ˜¯ Masterä¹Ÿä¼šæŠŠèŠ‚ç‚¹ä¿¡æ¯, åŒæ­¥ç»™å…¶ä»–èŠ‚ç‚¹, ä½†æ˜¯åªæœ‰masterèŠ‚ç‚¹å¯ä»¥ä¿®æ”¹.","text":"elasticsearché›†ç¾¤graph LR; A(Master Node) --- B(Data Node); A --- C(Data Node); B --- C; Master: åœ¨Elasticsearchä¸­Masterä»…ä»…è´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ åˆ›å»ºæˆ–åˆ é™¤ç´¢å¼• è·Ÿè¸ªå“ªäº›èŠ‚ç‚¹æ˜¯é›†ç¾¤çš„ä¸€éƒ¨åˆ† å†³å®šå°†å“ªäº›ç¢ç‰‡åˆ†é…ç»™å“ªä¸ªèŠ‚ç‚¹ ç­‰é›†ç¾¤èŒƒå›´çš„æ“ä½œ ä¸Šé¢çš„ä¸€äº›é›†ç¾¤ä¿¡æ¯, æ˜¯ç”±MasterèŠ‚ç‚¹è¿›è¡Œç»´æŠ¤, ä½†æ˜¯ Masterä¹Ÿä¼šæŠŠèŠ‚ç‚¹ä¿¡æ¯, åŒæ­¥ç»™å…¶ä»–èŠ‚ç‚¹, ä½†æ˜¯åªæœ‰masterèŠ‚ç‚¹å¯ä»¥ä¿®æ”¹. ç‚¹å‡»æŸ¥çœ‹ElasticsearchèŠ‚ç‚¹ä»‹ç» ä¸ºä»€ä¹ˆè¦è‡³å°‘ä¸‰ä¸ªèŠ‚ç‚¹é¦–å…ˆæŸ¥çœ‹ Elasticsearch çš„é…ç½®æ–‡ä»¶, å¦‚ä¸‹:Zen Discovery å®˜æ–¹ä»‹ç» # ä¼ é€’åˆå§‹ä¸»æœºåˆ—è¡¨ï¼Œä»¥ä¾¿åœ¨å¯åŠ¨æ–°èŠ‚ç‚¹æ—¶æ‰§è¡Œå‘ç°discovery.zen.ping.unicast.hosts: [&quot;192.168.xxx.xxx:9300&quot;, &quot;192.168.xxx.xxx:9300&quot;]# é€‰ä¸¾Masteæ—¶éœ€è¦çš„èŠ‚ç‚¹æ•° (total number of master-eligible nodes / 2 + 1) é˜²æ­¢â€œé˜²æ­¢è„‘è£‚â€discovery.zen.minimum_master_nodes: 2# ä¸€ä¸ªèŠ‚ç‚¹å¤šä¹…pingä¸€æ¬¡ï¼Œé»˜è®¤1sdiscovery.zen.fd.ping_interval: 1s# ç­‰å¾…pingè¿”å›æ—¶é—´ï¼Œé»˜è®¤30sdiscovery.zen.fd.ping_timeout: 30s# pingè¶…æ—¶é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤3æ¬¡discovery.zen.fd.ping_retries: 3 discovery.zen.minimum_master_nodes: 2 å…¶ä¸­ minimum_master_nodes é…ç½®æ˜¯ä¸ºäº†é˜²æ­¢è„‘è£‚ å‡è®¾ Elasticsearch æœ‰ä¸¤ä¸ªèŠ‚ç‚¹graph LR; A(Master Node) --- B(Data Node); graph LR; A(Master Node) -.X.- B(Data Node); discovery.zen.minimum_master_nodes: 1 æ­¤æ—¶å‡ºç°ç½‘ç»œæ³¢åŠ¨, å¯¼è‡´ Aâ€”B ä¹‹é—´çŸ­æš‚æ–­å¼€è¿æ¥, æ ¹æ®é€‰ä¸¾è§„åˆ™, Bå°†è‡ªå·±é€‰ä¸¾ä¸º Master, å½“ç½‘ç»œæ³¢åŠ¨ç»“æŸ, å°±ä¼šå‡ºç°ä¸¤ä¸ªMasterçš„æƒ…å†µ. graph LR; A(Master Node å®•æœº) --- B(Data Node); discovery.zen.minimum_master_nodes: 2 Master å‡ºç°æ•…éšœ, åˆ™ B å°†æ°¸è¿œä¸å¯èƒ½å°†è‡ªå·±é€‰æ‹©ä¸º Master Elasticsearch æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ä¸‰èŠ‚ç‚¹é…ç½®: discovery.zen.minimum_master_nodes: 2 graph LR; A(Master Node) -.X.- B(Data Node); A -.X.- C(Data Node); B --- C; å‡ºç°ç½‘ç»œæ³¢åŠ¨ A èŠ‚ç‚¹ å’Œ åˆ«çš„èŠ‚ç‚¹çŸ­æš‚æ–­å¼€è¿æ¥ graph LR; A(Master Node -&gt; Data Node) -.X.- B(Data Node -&gt; Master Node); A -.X.- C(Data Node); B --- C; AèŠ‚ç‚¹é™çº§, Bå’ŒC è¿›è¡Œé€‰ä¸¾, æ­¤å¤„æ¨¡æ‹Ÿé€‰ä¸¾Bä¸º Master Node graph LR; A(Data Node) --- B(Master Node); A --- C(Data Node); B --- C; ç½‘ç»œæ¢å¤åçš„èŠ‚ç‚¹çŠ¶å†µ. æ€»ç»“ä»¥ä¸Šå¯ä»¥çœ‹å‡º, é€šè¿‡é…ç½® minimum_master_nodes æ¥é˜²æ­¢å‡ºç°è„‘è£‚åŒæ—¶åœ¨ç”Ÿäº§è¿‡ç¨‹ä¸­, ä¸ºäº†å°½é‡ä¿æŒé›†ç¾¤é«˜å¯ç”¨, è‡³å°‘éœ€è¦ä¸‰å°æœºå™¨æ­å»ºé›†ç¾¤","categories":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/categories/ELK/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"Elasticsearch æ•°æ®å†™å…¥æµç¨‹","slug":"elk/esæ•°æ®å†™å…¥è¿‡ç¨‹","date":"2019-03-12T06:25:59.000Z","updated":"2020-04-04T06:49:14.257Z","comments":true,"path":"2019/03/12/elasticsearch-data-writing-process.html","link":"","permalink":"https://liuzhihang.com/2019/03/12/elasticsearch-data-writing-process.html","excerpt":"ç®€å•æµç¨‹ å®¢æˆ·ç«¯éšæœºé€‰æ‹©ä¸€ä¸ªnodeå‘é€æ•°æ®, æ­¤æ—¶è¯¥nodeä¸ºåè°ƒèŠ‚ç‚¹(coordinating node) 1.1. coordinating node é€šè¿‡ _idè®¡ç®—å‡ºè¯¥documentåœ¨å“ªä¸ªshardä¸Š, å‡è®¾ä¸ºshard0, è®¡ç®—æ–¹å¼å¦‚ä¸‹: hash(_id) % number_of_primary_shards 1.2. node æ ¹æ® cluster state è·å–åˆ° shard0 åœ¨ node1 ä¸Š","text":"ç®€å•æµç¨‹ å®¢æˆ·ç«¯éšæœºé€‰æ‹©ä¸€ä¸ªnodeå‘é€æ•°æ®, æ­¤æ—¶è¯¥nodeä¸ºåè°ƒèŠ‚ç‚¹(coordinating node) 1.1. coordinating node é€šè¿‡ _idè®¡ç®—å‡ºè¯¥documentåœ¨å“ªä¸ªshardä¸Š, å‡è®¾ä¸ºshard0, è®¡ç®—æ–¹å¼å¦‚ä¸‹: hash(_id) % number_of_primary_shards 1.2. node æ ¹æ® cluster state è·å–åˆ° shard0 åœ¨ node1 ä¸Š å°†æ¶ˆæ¯å‘é€åˆ° node1 çš„ P0 ä¸Š P0 æ”¶åˆ°æ•°æ®å, å°†æ•°æ®åŒæ­¥åˆ° è‡ªå·±çš„ replica shard R0ä¸Š P0 å’Œ R0 éƒ½å¤„ç†å®Œæ¯•, æ‰ä¼šè¿”å›å®¢æˆ·ç«¯æˆåŠŸ Px ä¸º primary shardRx ä¸º replica shardå½“å®¢æˆ·ç«¯è¯·æ±‚ä¸ºæŸ¥è¯¢æ—¶, è·¯ç”±åˆ°ä»»æ„ shard(primary shard æˆ–è€… replica shard) æŸ¥è¯¢åˆ°æ•°æ®å³å¯è¿”å›. è¯¦ç»†æµç¨‹ P0æ”¶åˆ°document, åŒæ—¶å°†æ•°æ®å†™å…¥åˆ° å†…å­˜bufferå’Œtranslogä¸­ æ¯éš”1sæˆ–bufferæ»¡æ—¶, bufferä¸­çš„æ•°æ®ä¼š refresh åˆ°segmentä¸­, è€Œåè¿›å…¥os cache, ä¸€æ—¦segmentè¿›å…¥åˆ° cacheä¸­,å…¶ä¸­çš„æ•°æ®, åˆ™å¯ä»¥è¢«æœç´¢åˆ° refresh æ—¶é—´å¯ä»¥æ‰‹åŠ¨è®¾ç½®, ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘ refresh æ¸…ç©ºbuffer, translogä¸å¤„ç† é‡å¤1-3æ“ä½œ, translogä¸æ–­å¢å¤§, translogæ¯éš”30åˆ†é’Ÿ,æˆ–å¤§åˆ°ä¸€å®šé‡æ—¶, ä¼šè§¦å‘commitæ“ä½œ å°†bufferä¸­å†…å®¹åˆ·æ–°åˆ°segmentä¸­, å¹¶æ¸…ç©ºbuffer å°†ä¸€ä¸ªcommit point å†™å…¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­, æ ‡è¯†æ­¤æ¬¡commit å¯¹åº”çš„ segment æ‰§è¡Œ fsync å°† os cache ä¸­çš„æ•°æ®å¼ºåˆ¶åˆ·æ–°åˆ°ç£ç›˜æ–‡ä»¶ä¸­ åˆ é™¤ translog æ–‡ä»¶ åˆ é™¤å’Œæ›´æ–°æ“ä½œ åœ¨commitæ—¶, å¦‚æœæ“ä½œä¸ºåˆ é™¤, ç”Ÿæˆä¸€ä¸ª .delæ–‡ä»¶, å…¶ä¸­å°†è¯¥documentæ ‡è®°ä½deleted, å¹¶ä¸æ˜¯çœŸæ­£çš„ç‰©ç†åˆ é™¤, æ­¤æ—¶å¦‚æœæœ‰æŸ¥è¯¢è¯·æ±‚, ä¼šå…ˆæŸ¥è¯¢ .delæ–‡ä»¶ä¸­æ˜¯å¦æœ‰è¯¥è®°å½•, å¦‚æœæœ‰, åˆ™å›å¤ä¸å­˜åœ¨.åœ¨commitæ—¶, å¦‚æœä¸ºæ›´æ–°æ“ä½œ, åˆ™æ˜¯å°†åŸdocumentæ ‡è®°ä½deleted, åŒæ—¶å†™å…¥ä¸€æ¡æ–°æ•°æ® æœåŠ¡å®•æœºé‡å¯, translog æ—¥å¿—ä½œç”¨ translogæ˜¯å…ˆå†™å…¥åˆ° os cacheä¸­, ç„¶åæ¯éš”5så†™å…¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­, å‡å¦‚æœåŠ¡å®•æ‰, å¯èƒ½ä¼šå¤±å»5sæ•°æ®, ä¹Ÿå¯ä»¥ä¿®æ”¹å†™å…¥ç£ç›˜çš„æ—¶æœº, ä½†æ˜¯å¯èƒ½ä¼šå½±å“æ€§èƒ½translogä¸­è®°å½•çš„æ˜¯æ•°æ®æ“ä½œä¿¡æ¯, åœ¨æœåŠ¡å®•æœºé‡å¯æ—¶, ä¼šè¯»å–translogç£ç›˜æ–‡ä»¶, ç„¶åå°†translogä¸­çš„æ•°æ®é‡æ–°æ¢å¤åˆ° segmentä¸­, ç„¶åè¿›è¡Œåç»­æ“ä½œ segment merge è¿‡ç¨‹ segment æŒç»­ç”Ÿæˆ, ä¼šå¯¼è‡´ segmentä¸æ–­å˜å¤š, å ç”¨æ–‡ä»¶å¥æŸ„, cpuèµ„æºç­‰ç­‰esåå°æœ‰ä¸€ä¸ªä¸“é—¨çš„ç¨‹åºè´Ÿè´£åˆå¹¶segment, å°†å°çš„ segment åˆæˆå¤§çš„segment, åŒæ—¶å†™ä¸€ä¸ªcommit point, æ ‡è¯† æ–°çš„segment file.æ‰“å¼€æ–°çš„segmentä¾›æŸ¥è¯¢ä½¿ç”¨, åˆ é™¤æ—§çš„ segmentsegment åˆå¹¶è¿‡ç¨‹ä¸­, è¢«æ ‡è®°ä½ deleted çš„document ä¸ä¼šè¢«åˆå¹¶. å³: åœ¨åˆå¹¶ segmentæ—¶, æ‰å°† document çœŸæ­£ç‰©ç†åˆ é™¤åˆå¹¶çš„segment å¯ä»¥ä½¿ç£ç›˜ä¸Šå·²ç»commitçš„ç´¢å¼• ä¹Ÿå¯ä»¥æ˜¯å†…å­˜ä¸­è¿˜æœªcommitçš„ç´¢å¼•","categories":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/categories/ELK/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"logstash inputå¤šä¸ªkafkaå¼‚å¸¸","slug":"issue/logstash-kafka-error","date":"2019-03-04T11:09:06.000Z","updated":"2020-06-18T08:21:30.033Z","comments":true,"path":"2019/03/04/logstash-input-multiple-kafka-exceptions.html","link":"","permalink":"https://liuzhihang.com/2019/03/04/logstash-input-multiple-kafka-exceptions.html","excerpt":"é—®é¢˜æè¿°graph LR; filebeat --&gt; logstash; log4j --&gt; logstash; logstash --&gt; es; filebeat å’Œ log4j appender åŒæ—¶åˆ° kafka, logstashåœ¨å¯åŠ¨æ—¶æŠ¥é”™, é”™è¯¯å¦‚ä¸‹: javax.management.InstanceAlreadyExistsException: kafka.consumer:type&#x3D;app-info,id&#x3D;logstash-0","text":"é—®é¢˜æè¿°graph LR; filebeat --&gt; logstash; log4j --&gt; logstash; logstash --&gt; es; filebeat å’Œ log4j appender åŒæ—¶åˆ° kafka, logstashåœ¨å¯åŠ¨æ—¶æŠ¥é”™, é”™è¯¯å¦‚ä¸‹: javax.management.InstanceAlreadyExistsException: kafka.consumer:type&#x3D;app-info,id&#x3D;logstash-0 é—®é¢˜åŸå› åŠè§£å†³input æ¶ˆè´¹kafkaæ—¶, åˆ†åˆ«æŒ‡å®šä¸åŒçš„ client_id. kafka &#123; bootstrap_servers &#x3D;&gt; [&quot;192.168.103.43:9092&quot;] # æ³¨æ„è¿™é‡Œé…ç½®çš„kafkaçš„brokeråœ°å€ä¸æ˜¯zkçš„åœ°å€ client_id &#x3D;&gt; &quot;kafka_client_1&quot; group_id &#x3D;&gt; &quot;logstash&quot; topics &#x3D;&gt; [&quot;ipaynow_log&quot;] # kafka topic åç§° consumer_threads &#x3D;&gt; 5 decorate_events &#x3D;&gt; true type &#x3D;&gt; &quot;string&quot; codec &#x3D;&gt; &quot;json&quot;&#125;kafka &#123; bootstrap_servers &#x3D;&gt; [&quot;192.168.103.43:9092&quot;] # æ³¨æ„è¿™é‡Œé…ç½®çš„kafkaçš„brokeråœ°å€ä¸æ˜¯zkçš„åœ°å€ client_id &#x3D;&gt; &quot;kafka_client_2&quot; group_id &#x3D;&gt; &quot;logstash&quot; topics &#x3D;&gt; [&quot;ipaynow-hunter&quot;] # kafka topic åç§° consumer_threads &#x3D;&gt; 5 decorate_events &#x3D;&gt; true type &#x3D;&gt; &quot;string&quot; codec &#x3D;&gt; plain &#123; charset&#x3D;&gt;&quot;UTF-8&quot; &#125;&#125;","categories":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/categories/issue/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"ç¨‹åºæ— å¼‚å¸¸ä¸­æ–­","slug":"issue/ç¨‹åºæ— å¼‚å¸¸ä¸­æ–­","date":"2019-02-15T02:46:48.000Z","updated":"2020-04-04T06:23:27.483Z","comments":true,"path":"2019/02/15/no-abnormal-interruption-of-the-program.html","link":"","permalink":"https://liuzhihang.com/2019/02/15/no-abnormal-interruption-of-the-program.html","excerpt":"é—®é¢˜æè¿° ç¨‹åºæ‰§è¡Œåˆ°æŸä¸€å¤„ä¹‹ååœé¡¿, ä¸èƒ½ç»§ç»­æ‰§è¡Œ, ä¸æŠ›å‡ºå¼‚å¸¸, æ— è¿”å›å€¼ æœ¬åœ°æµ‹è¯•æ­£å¸¸ debugå¯ä»¥æ­£å¸¸æ‰§è¡Œ æ“ä½œä¸ºå…¥åº“ä¹‹å‰, åˆ›å»ºå¯¹è±¡, æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„setæ“ä½œ payInfoExtra.setToAccType(agPayReqDto.getToAccType().getValue()); å…¶ä¸­getæ“ä½œè·å–çš„ä¸ºä¸€ä¸ªæšä¸¾, ä¸»è¦æ“ä½œä¸ºä»æšä¸¾ä¸­è·å–value setåˆ°å¦ä¸€ä¸ªå¯¹è±¡ä¸­","text":"é—®é¢˜æè¿° ç¨‹åºæ‰§è¡Œåˆ°æŸä¸€å¤„ä¹‹ååœé¡¿, ä¸èƒ½ç»§ç»­æ‰§è¡Œ, ä¸æŠ›å‡ºå¼‚å¸¸, æ— è¿”å›å€¼ æœ¬åœ°æµ‹è¯•æ­£å¸¸ debugå¯ä»¥æ­£å¸¸æ‰§è¡Œ æ“ä½œä¸ºå…¥åº“ä¹‹å‰, åˆ›å»ºå¯¹è±¡, æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„setæ“ä½œ payInfoExtra.setToAccType(agPayReqDto.getToAccType().getValue()); å…¶ä¸­getæ“ä½œè·å–çš„ä¸ºä¸€ä¸ªæšä¸¾, ä¸»è¦æ“ä½œä¸ºä»æšä¸¾ä¸­è·å–value setåˆ°å¦ä¸€ä¸ªå¯¹è±¡ä¸­ public AccTypeEnum getToAccType() &#123; return toAccType;&#125; é—®é¢˜åŸå› åŠè§£å†³å°ä¼™ä¼´åœ¨ä»–ä»¬é¡¹ç›®ä¸­å¤ç”¨æœ¬é¡¹ç›®ä¸­çš„æšä¸¾ç±», æ²¡æœ‰ä¿®æ”¹åŒ…åç±»å, ä½†æ˜¯æŠŠæšä¸¾ä¸­valueå­—æ®µä» byteæ”¹æˆäº†String, åŒæ—¶æ”¾åœ¨äº†ä¾èµ–ä¸­, æä¾›ç»™æˆ‘ä»¬ä½¿ç”¨.è§£å†³æ–¹æ¡ˆå°±å¾ˆç®€å•äº†, è®©å°ä¼™ä¼´ä¿®æ”¹åŒ…åç±»åå°±å¯ä»¥äº†.åŸæšä¸¾ç±»å¦‚ä¸‹: public enum AccTypeEnum &#123; PRI((byte) 0, &quot;å¯¹ç§&quot;), PUB((byte) 1, &quot;å¯¹å…¬&quot;); private byte value; private String desc;&#125;","categories":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/categories/issue/"}],"tags":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/tags/issue/"}]},{"title":"skywalking5é›†ç¾¤éƒ¨ç½²","slug":"skywalking/skywalking5é›†ç¾¤éƒ¨ç½²","date":"2018-12-27T03:27:37.000Z","updated":"2020-04-04T06:25:19.101Z","comments":true,"path":"2018/12/27/skywalking5-cluster-deployment.html","link":"","permalink":"https://liuzhihang.com/2018/12/27/skywalking5-cluster-deployment.html","excerpt":"å‡†å¤‡ç¯å¢ƒ skywalking-5.0.0-GA zookeeper-3.4.10 elasticsearch-5.6.14 ä¸‹è½½åœ°å€å¦‚ä¸‹: skywalking: http://skywalking.apache.org/downloads/ zookeeper: http://mirrors.hust.edu.cn/apache/zookeeper/ elasticsearch: https://www.elastic.co/downloads/past-releases","text":"å‡†å¤‡ç¯å¢ƒ skywalking-5.0.0-GA zookeeper-3.4.10 elasticsearch-5.6.14 ä¸‹è½½åœ°å€å¦‚ä¸‹: skywalking: http://skywalking.apache.org/downloads/ zookeeper: http://mirrors.hust.edu.cn/apache/zookeeper/ elasticsearch: https://www.elastic.co/downloads/past-releases å®‰è£…zké›†ç¾¤ ä¸‹è½½å¹¶è§£å‹zkwget http://mirrors.hust.edu.cn/apache/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gztar -xvf zookeeper-3.4.10.tar.gz ä¿®æ”¹é…ç½®æ–‡ä»¶cd zookeeper-3.4.10/conf/cp zoo_sample.cfg zoo.cfgvim zoo.cfg å†…å®¹å¦‚ä¸‹tickTime=2000initLimit=10syncLimit=5dataDir=/opt/export/app/zookeeper-3.4.10/dataclientPort=2181server.1=192.168.***.236:2888:3888server.2=192.168.***.237:2888:3888 å†™å…¥é›†ç¾¤myidecho 1 &gt; /opt/export/app/zookeeper-3.4.10/data/myid# å¦ä¸€å°æœºå™¨åˆ™å†™å…¥2 zkåŸºæœ¬å‘½ä»¤# åœ¨zkçš„binç›®å½•ä¸‹# å¯åŠ¨./zkServer.sh start# åœæ­¢./zkServer.sh stop# æŸ¥çœ‹çŠ¶æ€./zkServer.sh status# æŸ¥çœ‹zkçš„èŠ‚ç‚¹./zkCli.sh# è¿æ¥åä½¿ç”¨ ls / å‘½ä»¤æŸ¥çœ‹ls /skywalking å®‰è£…esé›†ç¾¤ ä¸‹è½½å¹¶è§£å‹eswget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.14.tar.gztar -xvf elasticsearch-5.6.14.tar.gz ä¿®æ”¹é…ç½®æ–‡ä»¶cd elasticsearch-5.6.14/config/vim elasticsearch.yml å†…å®¹å¦‚ä¸‹cluster.name: CollectorDBClusternode.name: node-1path.data: /opt/export/app/elasticsearch-5.6.14/datapath.logs: /opt/export/app/elasticsearch-5.6.14/logsnetwork.host: 192.168.***.234discovery.zen.ping.unicast.hosts: [&quot;192.168.***.234:9300&quot;, &quot;192.168.***.235:9300&quot;]discovery.zen.minimum_master_nodes: 2bootstrap.memory_lock: falsebootstrap.system_call_filter: false# ä¿®æ”¹ä¸ŠæŠ¥æ•°æ®çº¿ç¨‹æ± å¤§å°thread_pool.bulk.queue_size: 1000 å¸¸ç”¨å‘½ä»¤# åå°å¯åŠ¨bin/elasticsearch -d# åˆ é™¤æ‰€æœ‰ç´¢å¼•curl -XDELETE 192.168.***.234:9200/* å®‰è£…skywalkingâ˜ å®˜æ–¹åœ°å€ ä¸‹è½½å¹¶è§£å‹wget http://mirrors.shu.edu.cn/apache/incubator/skywalking/5.0.0-GA/apache-skywalking-apm-incubating-5.0.0-GA.tar.gztar -xvf apache-skywalking-apm-incubating-5.0.0-GA.tar.gzmv apache-skywalking-apm-incubating-5.0.0-GA skywalking-5.0.0-GA ä¿®æ”¹é…ç½®cd skywalking-5.0.0-GA/config/vim application.yml ä¿®æ”¹å†…å®¹å¦‚ä¸‹ é›†ç¾¤é…ç½® cluster: zookeeper: hostPort: 192.168.***.236:2181,192.168.***.237:2181 sessionTimeout: 100000 esé…ç½® storage: elasticsearch: clusterName: CollectorDBCluster clusterTransportSniffer: true clusterNodes: 192.168.***.234:9300,192.168.***.235:9300 # å…¶ä»–é…ç½® å…¶ä»–é…ç½® # hosté…ç½®ä¿®æ”¹host: 192.168.***.236 ä¿®æ”¹webappé…ç½®vim webapp/webapp.yml collector: path: /graphql ribbon: ReadTimeout: 10000 listOfServers: 192.168.**.236:10800,192.168.**.237:10800 å¸¸ç”¨å‘½ä»¤# å¯åŠ¨collector+webUIbin/startup.sh# åªå¯åŠ¨collectoræˆ–webUIbin/collectorService.shbin/webappService.sh æ¢é’ˆä½¿ç”¨ â˜ å®˜æ–¹åœ°å€ java -javaagent:/path/to/skywalking-agent/skywalking-agent.jar -jar yourApp.jar","categories":[{"name":"skywalking","slug":"skywalking","permalink":"https://liuzhihang.com/categories/skywalking/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"},{"name":"skywalking","slug":"skywalking","permalink":"https://liuzhihang.com/tags/skywalking/"}]},{"title":"logstashæ—¶é—´æˆ³å·®8ä¸ªå°æ—¶","slug":"issue/å¤„ç†logstashæ—¶é—´æˆ³å·®8ä¸ªå°æ—¶","date":"2018-12-20T07:11:16.000Z","updated":"2020-04-04T06:23:27.485Z","comments":true,"path":"2018/12/20/logstash-timestamp-difference-8-hours.html","link":"","permalink":"https://liuzhihang.com/2018/12/20/logstash-timestamp-difference-8-hours.html","excerpt":"é—®é¢˜è¯´æ˜åŸå§‹é…ç½®: elasticsearch &#123; # manage_template &#x3D;&gt; false template_overwrite &#x3D;&gt; true template &#x3D;&gt; &quot;&#x2F;opt&#x2F;export&#x2F;app&#x2F;logstash-6.4.2&#x2F;bin&#x2F;dynamic_templates.json&quot; user &#x3D;&gt; xxxxxxx password &#x3D;&gt; xxxxxxx index &#x3D;&gt; &quot;%&#123;sys_name&#125;-%&#123;+YYYY.MM.dd&#125;&quot; hosts &#x3D;&gt; [&quot;172.19.3.51:9200&quot;,&quot;172.19.3.52:9200&quot;]&#125; åœ¨ä½¿ç”¨logstashè¾“å‡ºå†…å®¹è¦esä¸­æ—¶, æŒ‡å®šindexä¸ºç³»ç»Ÿåç§°+æ—¶é—´(å¹´æœˆæ—¥), æ—¶é—´ä¼šè‡ªåŠ¨åŒ¹é…â€˜@timestampâ€™å­—æ®µå¹¶æ ¼å¼åŒ–, ä½†æ˜¯åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­, å‘ç°åœ¨ä¸Šåˆå…«ç‚¹ä¹‹å‰çš„æ¶ˆæ¯ä¼šè¢«åˆ›å»ºåˆ°æ˜¨å¤©çš„ç´¢å¼•é‡Œé¢.æŸ¥é˜…ç›¸å…³èµ„æ–™, æœ‰ä»‹ç»åœ¨æ—¶é—´æˆ³ä¸Šé¢å¢åŠ 8ä¸ªå°æ—¶çš„æ–¹å¼, ä¹Ÿå¯ä»¥ä½¿ç”¨. è¿™é‡Œç»“åˆè‡ªå·±ä¸šåŠ¡ä½¿ç”¨çš„å…¶ä»–æ–¹å¼.","text":"é—®é¢˜è¯´æ˜åŸå§‹é…ç½®: elasticsearch &#123; # manage_template &#x3D;&gt; false template_overwrite &#x3D;&gt; true template &#x3D;&gt; &quot;&#x2F;opt&#x2F;export&#x2F;app&#x2F;logstash-6.4.2&#x2F;bin&#x2F;dynamic_templates.json&quot; user &#x3D;&gt; xxxxxxx password &#x3D;&gt; xxxxxxx index &#x3D;&gt; &quot;%&#123;sys_name&#125;-%&#123;+YYYY.MM.dd&#125;&quot; hosts &#x3D;&gt; [&quot;172.19.3.51:9200&quot;,&quot;172.19.3.52:9200&quot;]&#125; åœ¨ä½¿ç”¨logstashè¾“å‡ºå†…å®¹è¦esä¸­æ—¶, æŒ‡å®šindexä¸ºç³»ç»Ÿåç§°+æ—¶é—´(å¹´æœˆæ—¥), æ—¶é—´ä¼šè‡ªåŠ¨åŒ¹é…â€˜@timestampâ€™å­—æ®µå¹¶æ ¼å¼åŒ–, ä½†æ˜¯åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­, å‘ç°åœ¨ä¸Šåˆå…«ç‚¹ä¹‹å‰çš„æ¶ˆæ¯ä¼šè¢«åˆ›å»ºåˆ°æ˜¨å¤©çš„ç´¢å¼•é‡Œé¢.æŸ¥é˜…ç›¸å…³èµ„æ–™, æœ‰ä»‹ç»åœ¨æ—¶é—´æˆ³ä¸Šé¢å¢åŠ 8ä¸ªå°æ—¶çš„æ–¹å¼, ä¹Ÿå¯ä»¥ä½¿ç”¨. è¿™é‡Œç»“åˆè‡ªå·±ä¸šåŠ¡ä½¿ç”¨çš„å…¶ä»–æ–¹å¼. è§£å†³æ–¹æ¡ˆ ä¸»è¦æŠ¥é€å†…å®¹ä¸ºfilebeatçš„æ—¥å¿—ä¿¡æ¯, æ—¥å¿—ç»Ÿä¸€æœ‰æ—¶é—´æˆ³, æ ¼å¼å¦‚ä¸‹: [trans-mediapay]-[2018-12-19 02:00:00:187]-[queryThreadPool-14]-[]-[WeBankServiceImpl.java:101]-[INFO ]-[æµ‹è¯•2ç‚¹çš„æ—¥å¿—] è§£ææ—¶é—´æˆ³çš„æ—¶é—´ å…ˆåŒ¹é…æ•´ä½“æ—¥å¿—, è·å–â€™log_timeâ€™å­—æ®µ åŒ¹é…â€™log_timeâ€™å­—æ®µ ç”Ÿæˆå…ƒæ•°æ® â€˜[@metadata][index_suffix]â€™filter &#123; # æ—¥å¿—èšåˆä½¿ç”¨å…¨é‡é…ç½® grok &#123; match =&gt; &#123; &quot;message&quot; =&gt; &quot;\\[%&#123;DATA:sys_name&#125;\\]-\\[%&#123;DATA:log_time&#125;\\]-\\[%&#123;DATA:thread_name&#125;\\]-\\[%&#123;DATA:trace_id&#125;\\]-\\[%&#123;DATA:class_name&#125;\\]-\\[%&#123;DATA:log_level&#125;\\]-%&#123;GREEDYDATA:log_msg&#125;&quot; &#125; &#125; grok&#123; match =&gt; &#123; &quot;log_time&quot; =&gt; [&quot;%&#123;INT:index_year&#125;-%&#123;INT:index_mouth&#125;-%&#123;INT:index_day&#125;&quot;]&#125; &#125; mutate &#123; # ä½¿ç”¨å…ƒæ•°æ® [@metadata][index_suffix] add_field =&gt; &#123; &quot;[@metadata][index_suffix]&quot; =&gt; &quot;%&#123;index_year&#125;.%&#123;index_mouth&#125;.%&#123;index_day&#125;&quot; &#125; remove_field =&gt; [&quot;host&quot;,&quot;beat&quot;,&quot;tags&quot;,&quot;[beat][name]&quot;,&quot;[beat][version]&quot;,&quot;prospector&quot;,&quot;@version&quot;,&quot;offset&quot;,&quot;input&quot;,&quot;y_index&quot;,&quot;M_index&quot;,&quot;d_index&quot;] &#125;&#125; è¾“å‡ºæ—¶ä½¿ç”¨å…ƒæ•°æ®, è¯¥å­—æ®µä¸ä¼šå‡ºç°åœ¨esçš„å­—æ®µä¸­ elasticsearch &#123; # manage_template =&gt; false template_overwrite =&gt; true template =&gt; &quot;/opt/export/app/logstash-6.4.2/bin/dynamic_templates.json&quot; user =&gt; xxxxxxx password =&gt; xxxxxxx index =&gt; &quot;%&#123;sys_name&#125;-%&#123;[@metadata][index_suffix]&#125;&quot; hosts =&gt; [&quot;xxxx:9200&quot;,&quot;xxxx:9200&quot;]&#125;","categories":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/categories/issue/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"è·å–IPå’Œbyteè½¬longé‡åˆ°çš„å°é—®é¢˜","slug":"issue/è·å–IP&byteè½¬long","date":"2018-12-10T11:46:01.000Z","updated":"2020-11-13T03:00:24.670Z","comments":true,"path":"2018/12/10/get-the-small-problem-encountered-by-ip-and-byte-to-long.html","link":"","permalink":"https://liuzhihang.com/2018/12/10/get-the-small-problem-encountered-by-ip-and-byte-to-long.html","excerpt":"ä»‹ç»å› ä¸ºä¸šåŠ¡éœ€æ±‚æ–°é¡¹ç›®çš„æµæ°´å·ç³»ç»Ÿä» â€˜æ•°æ®åº“è‡ªå¢æ­¥é•¿+åˆ†æ®µå¼é”â€™ æ¢æˆä½¿ç”¨ é›ªèŠ±æµæ°´å·, ä¿®æ”¹æœºå™¨æ ‡è¯†å’Œæ•°æ®ä¸­å¿ƒå­—æ®µä¸ºè‡ªåŠ¨è·å–ipåä¸‰ä½, äººå·¥ä¿è¯ipåä¸‰ä½ä¸ç›¸åŒ ç¤ºä¾‹é›ªèŠ±æµæ°´å· - æ”¹é€ ç‰ˆ ä¿®æ”¹å†…å®¹å¦‚ä¸‹:åˆ é™¤æ„é€ , ä¿®æ”¹æ•°æ®ä½æ•°, æ·»åŠ é™æ€ä»£ç å—","text":"ä»‹ç»å› ä¸ºä¸šåŠ¡éœ€æ±‚æ–°é¡¹ç›®çš„æµæ°´å·ç³»ç»Ÿä» â€˜æ•°æ®åº“è‡ªå¢æ­¥é•¿+åˆ†æ®µå¼é”â€™ æ¢æˆä½¿ç”¨ é›ªèŠ±æµæ°´å·, ä¿®æ”¹æœºå™¨æ ‡è¯†å’Œæ•°æ®ä¸­å¿ƒå­—æ®µä¸ºè‡ªåŠ¨è·å–ipåä¸‰ä½, äººå·¥ä¿è¯ipåä¸‰ä½ä¸ç›¸åŒ ç¤ºä¾‹é›ªèŠ±æµæ°´å· - æ”¹é€ ç‰ˆ ä¿®æ”¹å†…å®¹å¦‚ä¸‹:åˆ é™¤æ„é€ , ä¿®æ”¹æ•°æ®ä½æ•°, æ·»åŠ é™æ€ä»£ç å— private final static long MACHINE_BIT = 8;private final static long DATA_CENTER_BIT = 2;static &#123; try &#123; InetAddress localHost = InetAddress.getLocalHost(); address = localHost.getAddress()[3] &amp; 0xff; System.out.println(&quot;å½“å‰ç³»ç»Ÿçš„ address ä¸º: &quot; + address); &#125; catch (UnknownHostException e) &#123; throw new IllegalArgumentException(&quot;DATA_CENTER_ID can&#x27;t be greater than MAX_DATA_CENTER_NUM or less than 0&quot;); &#125;&#125; æ³¨æ„ç‚¹æœåŠ¡å™¨é…ç½®hostæœåŠ¡å™¨å¯¹åº”çš„ hostname éœ€è¦é…ç½®ipåœ°å€ cat /etc/hosts byte è½¬æ¢ longéœ€è¦ &amp; 0xffå½“è·å–ipå¤§äº127æ—¶è½¬æ¢å‡ºæ¥ä¸ºè´Ÿå€¼, æ‰€ä»¥éœ€è¦ &amp; 0xff","categories":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/categories/issue/"}],"tags":[{"name":"ip","slug":"ip","permalink":"https://liuzhihang.com/tags/ip/"}]},{"title":"åŸºäºLinkHashMapçš„LRUç¼“å­˜æ·˜æ±°","slug":"redis/LRULinkedHashMap","date":"2018-11-19T13:24:52.000Z","updated":"2020-04-04T06:24:26.301Z","comments":true,"path":"2018/11/19/elimination-of-lru-cache-based-on-linkhashmap.html","link":"","permalink":"https://liuzhihang.com/2018/11/19/elimination-of-lru-cache-based-on-linkhashmap.html","excerpt":"","text":"LRUç¼“å­˜æ·˜æ±°LRUç¼“å­˜æ·˜æ±°æ˜¯redisä¸­çš„ä¸€ç§æ·˜æ±°ç­–ç•¥, å½“å†…å­˜å¤§å°ä¸è¶³ä»¥å­˜æ”¾æ•°æ®æ—¶, æ­¤æ—¶å­˜å…¥æ–°æ•°æ®, å°†åˆ é™¤è¾ƒæ—©å­˜å…¥çš„æ•°æ®.åœ¨dubboä¸­ä½¿ç”¨LRUæ¥ç¼“å­˜ hostName.åœ¨mysqlä¸­ä½¿ç”¨LRUæ¥ç¼“å­˜ serverSideStatementCheckCache å’Œ serverSideStatementCache. ä»£ç å®ç°package com.ipaynow.tool.lru;import java.util.LinkedHashMap;import java.util.Map;import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantLock;/** * åŸºäºLinkedHashMap LRU ç¼“å­˜æ·˜æ±°, ä»¥ä¸‹æ¡†æ¶ä¸­éƒ½æœ‰ä½¿ç”¨ * dubbo com.alibaba.dubbo.common.utils.LRUCache * com.mysql.jdbc.util.LRUCache * * @author liuzhihang * @date 2018/11/20 10:43 */public class LRULinkedHashMap&lt;K, V&gt; extends LinkedHashMap&lt;K, V&gt; &#123; /** * è®¾ç½®æœ€å¤§å®¹é‡ */ private volatile int maxCapacity; private static final int DEFAULT_MAX_CAPACITY = 1000; private static final float DEFAULT_LOAD_FACTOR = 0.75f; private final Lock lock = new ReentrantLock(); public LRULinkedHashMap() &#123; this.maxCapacity = DEFAULT_MAX_CAPACITY; &#125; public LRULinkedHashMap(int maxCapacity) &#123; // accessOrderè®¾ç½®ä¸ºtrue æŒ‰ç…§æ—¶é—´æ’åº super(maxCapacity, DEFAULT_LOAD_FACTOR, true); this.maxCapacity = maxCapacity; &#125; /** * å½“é“¾è¡¨é•¿åº¦å¤§äºæœ€å¤§å®¹é‡æ—¶ åˆ é™¤æœ€æ—§çš„å…ƒç´  */ @Override protected boolean removeEldestEntry(Map.Entry&lt;K, V&gt; eldest) &#123; return size() &gt; maxCapacity; &#125; @Override public boolean containsKey(Object key) &#123; try &#123; lock.lock(); return super.containsKey(key); &#125; finally &#123; lock.unlock(); &#125; &#125; @Override public V get(Object key) &#123; try &#123; lock.lock(); return super.get(key); &#125; finally &#123; lock.unlock(); &#125; &#125; @Override public V put(K key, V value) &#123; try &#123; lock.lock(); return super.put(key, value); &#125; finally &#123; lock.unlock(); &#125; &#125; @Override public V remove(Object key) &#123; try &#123; lock.lock(); return super.remove(key); &#125; finally &#123; lock.unlock(); &#125; &#125; @Override public int size() &#123; try &#123; lock.lock(); return super.size(); &#125; finally &#123; lock.unlock(); &#125; &#125; @Override public void clear() &#123; try &#123; lock.lock(); super.clear(); &#125; finally &#123; lock.unlock(); &#125; &#125; public int getMaxCapacity() &#123; return maxCapacity; &#125; public void setMaxCapacity(int maxCapacity) &#123; this.maxCapacity = maxCapacity; &#125;&#125; æµ‹è¯•ä»£ç åŠç»“æœpackage com.ipaynow.tool.lru;import java.time.LocalDateTime;import java.time.format.DateTimeFormatter;import java.util.Iterator;import java.util.Map;/** * @author liuzhihang * @date 2018/11/20 10:58 */public class LRUTest &#123; public static void main(String[] args) throws InterruptedException &#123; LRULinkedHashMap&lt;String, String&gt; map = new LRULinkedHashMap&lt;&gt;(5); for (int i = 0; i &lt; 10; i++) &#123; Thread.sleep(1000); map.put(LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss SSS&quot;)), &quot;value&quot; + i); &#125; for (Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iterator = map.entrySet().iterator(); iterator.hasNext(); ) &#123; Map.Entry&lt;String, String&gt; entry = iterator.next(); String key = entry.getKey(); String value = entry.getValue(); System.out.println(key + &quot;------------&quot; + value); &#125; &#125;&#125; æ§åˆ¶å°è¾“å‡ºç»“æœ: 2018-11-20 11:13:21 398------------value52018-11-20 11:13:22 399------------value62018-11-20 11:13:23 400------------value72018-11-20 11:13:24 400------------value82018-11-20 11:13:25 400------------value9Process finished with exit code 0","categories":[{"name":"Redis","slug":"Redis","permalink":"https://liuzhihang.com/categories/Redis/"},{"name":"cache","slug":"Redis/cache","permalink":"https://liuzhihang.com/categories/Redis/cache/"}],"tags":[{"name":"Redis","slug":"Redis","permalink":"https://liuzhihang.com/tags/Redis/"},{"name":"cache","slug":"cache","permalink":"https://liuzhihang.com/tags/cache/"}]},{"title":"ELKå¸¸ç”¨å¯åŠ¨å‘½ä»¤","slug":"elk/elk-start-command","date":"2018-10-29T09:03:38.000Z","updated":"2020-04-04T06:11:20.190Z","comments":true,"path":"2018/10/29/elk-common-start-command.html","link":"","permalink":"https://liuzhihang.com/2018/10/29/elk-common-start-command.html","excerpt":"elasticsearchå¯åŠ¨å‘½ä»¤# å‰å°å¯åŠ¨ å…³é—­çª—å£è¿æ¥åè‡ªåŠ¨é€€å‡º./bin/elasticsearch# åå°å¯åŠ¨./bin/elasticsearch -d","text":"elasticsearchå¯åŠ¨å‘½ä»¤# å‰å°å¯åŠ¨ å…³é—­çª—å£è¿æ¥åè‡ªåŠ¨é€€å‡º./bin/elasticsearch# åå°å¯åŠ¨./bin/elasticsearch -d logstashå¯åŠ¨å‘½ä»¤# å‰å°å¯åŠ¨ -f åé¢ä¸ºé…ç½®æ–‡ä»¶./logstash -f logstash.conf# åå°å¯åŠ¨nohup ./logstash -f logstash.conf &amp; kibanaå¯åŠ¨å‘½ä»¤# å‰å°å¯åŠ¨./bin/kibana# åå°å¯åŠ¨./bin/kibana &amp; kibanaåœæ­¢å‘½ä»¤å½“ps -ef | grep kibana æŸ¥ä¸åˆ°æ—¶ å¯ä»¥lsof -i:5601kill -9 çº¿ç¨‹ filebeatå¯åŠ¨å‘½ä»¤# å‰å°å¯åŠ¨./filebeat -e -c filebeat.yml# åå°å¯åŠ¨ ä¸è¾“å‡ºæ—¥å¿—/è¾“å‡ºæ—¥å¿—nohup ./filebeat -e -c filebeat.yml &gt;/dev/null 2&gt;&amp;1 &amp;nohup ./filebeat -e -c filebeat.yml &gt; filebeat.log &amp; jaråŒ…å¯åŠ¨å‘½ä»¤# å‰å°å¯åŠ¨java -jar server.ja# åå°å¯åŠ¨nohup java -jar server.jar &amp;","categories":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/categories/ELK/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"search-guard-6 é…ç½®ç”¨æˆ·","slug":"elk/search-guard-6-config-user","date":"2018-10-24T09:13:45.000Z","updated":"2020-04-04T06:18:21.574Z","comments":true,"path":"2018/10/24/searchguard6-configuration-user.html","link":"","permalink":"https://liuzhihang.com/2018/10/24/searchguard6-configuration-user.html","excerpt":"search-guard é…ç½®ç”¨æˆ·è·¯å¾„: /opt/export/app/elasticsearch-6.4.2/plugins/search-guard-6/sgconfig ç”Ÿæˆå¯†ç æ‰§è¡Œä»¥ä¸‹å‘½ä»¤, è¾“å…¥æ˜æ–‡ plugins/search-guard-6/tools/hasher.sh -p mycleartextpassword","text":"search-guard é…ç½®ç”¨æˆ·è·¯å¾„: /opt/export/app/elasticsearch-6.4.2/plugins/search-guard-6/sgconfig ç”Ÿæˆå¯†ç æ‰§è¡Œä»¥ä¸‹å‘½ä»¤, è¾“å…¥æ˜æ–‡ plugins/search-guard-6/tools/hasher.sh -p mycleartextpassword 1. é…ç½®ç”¨æˆ·åŠå¯†ç æ–‡ä»¶: sg_internal_users.yml zhangsan: hash: $2y$12$yKXk785zSTtB3kE7g.XnbOPrc690g9JE50Znwum924i2M/xYGG4qq roles: - trans_group æ ¼å¼: å§“å: å¯†ç : XXXX(æ˜æ–‡çš„hash, ä½¿ç”¨search-guardçš„å·¥å…·ç”Ÿæˆ) è§’è‰²: - è§’è‰²åç§° 2. é…ç½®æƒé™æ–‡ä»¶: sg_roles.xml é…ç½®â€™?kibanaâ€™ åŠâ€™?kibana-6â€™ æƒé™æ˜¯ä¸ºäº†ä¿è¯ç”¨æˆ·åœ¨kibanaä¸­èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨kibana sg_trans_group: cluster: - cluster:monitor/nodes - cluster:monitor/health indices: &#x27;log-system&#x27;: &#x27;*&#x27;: - indices:admin/mappings/fields/get - indices:admin/validate/query - indices:data/read/search - indices:data/read/msearch - indices:admin/get - indices:data/read/field_stats &#x27;?kibana&#x27;: &#x27;*&#x27;: - MANAGE - INDEX - READ - DELETE &#x27;?kibana-6&#x27;: &#x27;*&#x27;: - MANAGE - INDEX - READ - DELETE æ ¼å¼: æƒé™åç§°: é›†ç¾¤: - é›†ç¾¤åç§°:æƒé™ ç´¢å¼•: &#x27;ç´¢å¼•åç§°&#x27;: &#x27;ç±»å‹&#x27;: - æƒé™ 3. é…ç½®è§’è‰²æ˜ å°„æ–‡ä»¶: sg_roles_mapping.yml é…ç½®å®Œç”¨æˆ·çš„è´¦æˆ·å¯†ç , ä»¥åŠç›¸åº”è§’è‰²æƒé™ä¹‹å, éœ€è¦å°†ç”¨æˆ·å’Œæƒé™è¿›è¡Œå…³è”, å…³è”ä¹‹åå³å¯ä½¿ç”¨ sg_trans_group: backendroles: - trans_group æ ¼å¼: æ˜ å°„åç§°: è§’è‰²: - ç”¨æˆ·çš„è§’è‰² ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è¿›è¡Œå…³è”: sg_trans_group: users: - zhangsan - lisi# å³æ˜ å°„åç§°: ç”¨æˆ·åç§°: - ç”¨æˆ·å 4. ä½¿é…ç½®ç”Ÿæ•ˆä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ ./sgadmin.sh -cn é›†ç¾¤åç§° -cd ../sgconfig -ks ../../../config/sgadmin-keystore.jks -kspass changeit -ts ../../../config/truststore.jks -tspass changeit -nhnv","categories":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/categories/ELK/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"search-guard-6 å®‰è£…","slug":"elk/search-guard-6-install","date":"2018-10-23T11:19:45.000Z","updated":"2020-04-04T06:18:30.040Z","comments":true,"path":"2018/10/23/searchguard6-installation.html","link":"","permalink":"https://liuzhihang.com/2018/10/23/searchguard6-installation.html","excerpt":"ES å®‰è£… search-guard-6å®‰è£…æ’ä»¶â˜ å®˜æ–¹ç½‘ç«™åœ¨ESç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤ bin/elasticsearch-plugin install -b com.floragunn:search-guard-6:6.4.2-23.1 æ³¨: å®‰è£…ç‰ˆæœ¬éœ€è¦å’ŒElasticsearchç‰ˆæœ¬ç›¸å¯¹åº”. æŸ¥çœ‹ç‰ˆæœ¬ è¿™é‡Œä¸ä½¿ç”¨å®˜æ–¹çš„å¿«é€Ÿæ„å»ºæ–¹æ³•","text":"ES å®‰è£… search-guard-6å®‰è£…æ’ä»¶â˜ å®˜æ–¹ç½‘ç«™åœ¨ESç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤ bin/elasticsearch-plugin install -b com.floragunn:search-guard-6:6.4.2-23.1 æ³¨: å®‰è£…ç‰ˆæœ¬éœ€è¦å’ŒElasticsearchç‰ˆæœ¬ç›¸å¯¹åº”. æŸ¥çœ‹ç‰ˆæœ¬ è¿™é‡Œä¸ä½¿ç”¨å®˜æ–¹çš„å¿«é€Ÿæ„å»ºæ–¹æ³• ç”Ÿæˆè¯ä¹¦ ä¸‹è½½è„šæœ¬ git clone https://github.com/floragunncom/search-guard-ssl.git è¯ä¹¦é…ç½® è·¯å¾„ **/elasticsearch-6.4.2/search-guard-ssl/example-pki-scripts ç›®å½•å†…å®¹ etcä¸‹å¯å¯¹è¯ä¹¦è¿›è¡Œé…ç½® ä¿®æ”¹example.sh #!/bin/bashOPENSSL_VER=&quot;$(openssl version)&quot;if [[ $OPENSSL_VER == *&quot;0.9&quot;* ]]; then echo &quot;Your OpenSSL version is too old: $OPENSSL_VER&quot; echo &quot;Please install version 1.0.1 or later&quot; exit -1else echo &quot;Your OpenSSL version is: $OPENSSL_VER&quot;fiset -e./clean.sh# ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºCAæ ¹è¯ä¹¦å¯†ç ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºTSå¯†ç (truststoreï¼Œä¿¡ä»»è¯ä¹¦å¯†ç )./gen_root_ca.sh capass changeit# ç”ŸæˆèŠ‚ç‚¹è¯ä¹¦ï¼š ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºèŠ‚ç‚¹ç¼–å·ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºkeystoreæ–‡ä»¶å¯†ç ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºCAæ ¹è¯ä¹¦å¯†ç ã€‚# æ­¤å¤„æˆ‘ä»¬åªç”Ÿæˆä¸¤ä¸ªèŠ‚ç‚¹è¯ä¹¦./gen_node_cert.sh 0 changeit capass &amp;&amp; ./gen_node_cert.sh 1 changeit capass# ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦ï¼š ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå®¢æˆ·ç«¯åç§°, ç¬¬äºŒä¸ªå‚æ•°ä¸ºkeystoreæ–‡ä»¶åç§°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºCAæ ¹è¯ä¹¦åç§°ã€‚./gen_client_node_cert.sh spock changeit capass./gen_client_node_cert.sh kirk changeit capass./gen_client_node_cert.sh logstash changeit capass./gen_client_node_cert.sh filebeat changeit capass./gen_client_node_cert.sh kibana changeit capass# ç”Ÿæˆä¸€ä¸ªsgadminå®¢æˆ·ç«¯è¯ä¹¦ï¼Œç”¨äºé…ç½®ç®¡ç†./gen_client_node_cert.sh sgadmin changeit capass# ç”Ÿæˆä¸€ä¸ªjavaapiè®¿é—®çš„å®¢æˆ·ç«¯è¯ä¹¦./gen_client_node_cert.sh javaapi changeit capassrm -f ./*tmp* ç”Ÿæˆè¯ä¹¦ç§»åŠ¨åˆ°elasticsearch config åœ¨ESç›®å½•ä¸‹ ./example.shcp node-0-keystore.jks sgadmin-keystore.jks truststore.jks /opt/export/app/elasticsearch-6.4.2/config/ é…ç½®elasticsearch.yml, å¢åŠ ä»¥ä¸‹é…ç½® # é…ç½®èŠ‚ç‚¹é—´é€šä¿¡è¯ä¹¦ï¼ŒèŠ‚ç‚¹é—´é€šä¿¡ä½¿ç”¨TLSæ˜¯å¼ºåˆ¶çš„searchguard.ssl.transport.keystore_filepath: node-0-keystore.jkssearchguard.ssl.transport.keystore_password: changeitsearchguard.ssl.transport.truststore_filepath: truststore.jkssearchguard.ssl.transport.truststore_password: changeit# è®¾ç½®ä¸æ ¡éªŒhostnamesearchguard.ssl.transport.enforce_hostname_verification: falsesearchguard.ssl.transport.resolve_hostname: false# é…ç½®ç®¡ç†å‘˜è¯ä¹¦DNsearchguard.authcz.admin_dn: - CN=sgadmin,OU=client,O=client,L=Test, C=DEbootstrap.memory_lock: falsebootstrap.system_call_filter: falsexpack.security.enabled: false å¯åŠ¨è®¿é—®éœ€è¦æƒé™ æ·»åŠ è„šæœ¬æƒé™å¹¶åˆå§‹åŒ–ç”¨æˆ·cd /opt/export/app/elasticsearch-6.4.2/plugins/search-guard-6/toolschmod +x *.sh./sgadmin.sh -cn cluster-es -cd ../sgconfig -ks ../../../config/sgadmin-keystore.jks -kspass changeit -ts ../../../config/truststore.jks -tspass changeit -nhnv æ¯æ¬¡æ›´æ–°ç”¨æˆ·æƒé™æˆ–è€…æ–°å¢ä¿®æ”¹ç”¨æˆ·, åªéœ€è¦é‡æ–°æ‰§è¡Œç¬¬ä¸‰æ¡å‘½ä»¤, æ›´æ–°ç”¨æˆ·ä¿¡æ¯å³å¯ Kibanaå®‰è£…å‚ç…§å®˜æ–¹ç½‘ç«™å®‰è£…é…ç½®å³å¯. å®˜æ–¹ç½‘ç«™, æˆ–è€…æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤. åœ¨kibanaå®‰è£…ç›®å½•ä¸‹æ‰§è¡Œä¸€ä¸‹å—å‘½ä»¤ bin/kibana-plugin install https://search.maven.org/remotecontent?filepath=com/floragunn/search-guard-kibana-plugin/6.4.2-15/search-guard-kibana-plugin-6.4.2-15.zip ä¿®æ”¹kibana.yml # Use HTTPS instead of HTTP# elasticsearch.url: &quot;https://localhost:9200&quot;elasticsearch.url: &quot;http://localhost:9200&quot;# Configure the Kibana internal server userelasticsearch.username: &quot;kibanaserver&quot;elasticsearch.password: &quot;kibanaserver&quot;# Disable SSL verification because we use self-signed demo certificateselasticsearch.ssl.verificationMode: none# Whitelist the Search Guard Multi Tenancy Headerelasticsearch.requestHeadersWhitelist: [ &quot;Authorization&quot;, &quot;sgtenant&quot; ] æ‰“å¼€å¯¹åº”åŸŸåç™»å½•http://localhost:5601/ æ³¨:ä»¥ä¸Šå†…å®¹ä¸ºå‚è€ƒè‡ªMé†‰é€é¥, å¹¶æ­å»ºæˆåŠŸåæ€»ç»“è®°å½•, ä»¥ä½œå¤‡å¿˜. é“¾æ¥å¦‚ä¸‹:https://www.jianshu.com/p/319913a944af","categories":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/categories/ELK/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"hexoæ­å»ºåšå®¢","slug":"hexo/hexo-blog","date":"2018-10-08T12:17:11.000Z","updated":"2020-04-04T04:12:06.986Z","comments":true,"path":"2018/10/08/hexo-build-blog.html","link":"","permalink":"https://liuzhihang.com/2018/10/08/hexo-build-blog.html","excerpt":"å®‰è£…nodeä¸‹è½½åœ°å€: https://nodejs.org æŸ¥çœ‹å½“å‰ç‰ˆæœ¬: node -v å®‰è£…hexonpm install ä¹Ÿå¯ä»¥ä½¿ç”¨æ·˜å®é•œåƒ npm install -g cnpm --registry=https://registry.npm.taobao.org cnpm install hexo","text":"å®‰è£…nodeä¸‹è½½åœ°å€: https://nodejs.org æŸ¥çœ‹å½“å‰ç‰ˆæœ¬: node -v å®‰è£…hexonpm install ä¹Ÿå¯ä»¥ä½¿ç”¨æ·˜å®é•œåƒ npm install -g cnpm --registry=https://registry.npm.taobao.org cnpm install hexo hexoå¸¸ç”¨å‘½ä»¤åˆå§‹åŒ–hexo init æ¸…é™¤ç¼“å­˜hexo clean ç”Ÿæˆé™æ€æ–‡ä»¶hexo g hexo generate å¯åŠ¨hexo s hexo server éƒ¨ç½²hexo d hexo deploy ç”Ÿæˆå¹¶éƒ¨ç½²hexo g -d","categories":[{"name":"hexo","slug":"hexo","permalink":"https://liuzhihang.com/categories/hexo/"}],"tags":[{"name":"hexo","slug":"hexo","permalink":"https://liuzhihang.com/tags/hexo/"}]},{"title":"æœåŠ¡å™¨cpuå ç”¨ç‡é«˜","slug":"issue/cpu-high-occupancy-rate","date":"2018-09-25T10:38:31.000Z","updated":"2020-04-04T06:23:27.480Z","comments":true,"path":"2018/09/25/server-cpu-occupancy-rate-is-high.html","link":"","permalink":"https://liuzhihang.com/2018/09/25/server-cpu-occupancy-rate-is-high.html","excerpt":"1. top å‘½ä»¤æ‰¾åˆ°å ç”¨cpuæœ€é«˜çš„è¿›ç¨‹top - 14:37:14 up 34 days, 13:27, 2 users, load average: 0.21, 0.29, 0.29Tasks: 151 total, 1 running, 150 sleeping, 0 stopped, 0 zombieCpu(s): 4.4%us, 2.7%sy, 0.0%ni, 90.9%id, 0.5%wa, 0.0%hi, 0.2%si, 1.3%stMem: 16334064k total, 16171240k used, 162824k free, 16716k buffersSwap: 16383996k total, 4470816k used, 11913180k free, 539788k cachedPID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND1818 tomcat 20 0 3643m 983m 7548 S 0.7 24.8 190:40.13 java","text":"1. top å‘½ä»¤æ‰¾åˆ°å ç”¨cpuæœ€é«˜çš„è¿›ç¨‹top - 14:37:14 up 34 days, 13:27, 2 users, load average: 0.21, 0.29, 0.29Tasks: 151 total, 1 running, 150 sleeping, 0 stopped, 0 zombieCpu(s): 4.4%us, 2.7%sy, 0.0%ni, 90.9%id, 0.5%wa, 0.0%hi, 0.2%si, 1.3%stMem: 16334064k total, 16171240k used, 162824k free, 16716k buffersSwap: 16383996k total, 4470816k used, 11913180k free, 539788k cachedPID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND1818 tomcat 20 0 3643m 983m 7548 S 0.7 24.8 190:40.13 java å­—æ®µè§£é‡Š:top - æ—¶é—´ è¿è¡Œæ—¶é—´ ç”¨æˆ· ç³»ç»Ÿè´Ÿè½½Tasks: è¿›ç¨‹ç›¸å…³ä¿¡æ¯Cpu(s): cpuç›¸å…³ä¿¡æ¯Mem: å†…å­˜ç›¸å…³Swap: äº¤æ¢åŒºç›¸å…³ä¿¡æ¯ è¿›ç¨‹ç›¸å…³ä¿¡æ¯PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND 2. ä½¿ç”¨top -H -p æŸ¥çœ‹è¯¥è¿›ç¨‹å†…æ‰€æœ‰çº¿ç¨‹top -H -p 1818 PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND6656 tomcat 20 0 4193m 608m 11m R 21.0 3.8 1419:44 java 3. printf â€œ%x\\nâ€ å°†10è¿›åˆ¶çº¿ç¨‹å·è½¬æ¢ä¸º16è¿›åˆ¶ç»“æœ[liuzhihang@test08 ~]$ printf &quot;%x\\n&quot; 1876754[liuzhihang@test08 ~]$ 4. jstack |grep jstack 1818 | grep 754 -A 30 pid ä¸ºç¬¬ä¸€æ¬¡æ‰§è¡Œtopå‘½ä»¤æ—¶çš„ pidtid ä¸ºå°†ç¬¬äºŒæ¬¡çš„pidè¿›è¡Œåå…­è¿›åˆ¶è½¬æ¢åçš„ç»“æœ &quot;catalina-8180-89&quot; #1842 daemon prio=5 os_prio=0 tid=0x00007f4ec4096000 nid=0x5d96 waiting on condition [0x00007f4e87545000] java.lang.Thread.State: WAITING (parking) at sun.misc.Unsafe.park(Native Method) - parking to wait for &lt;0x00000000f418f898&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject) at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175) at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039) at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442) at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:104) at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:32) at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) at java.lang.Thread.run(Thread.java:748)&quot;catalina-8180-88&quot; #1841 daemon prio=5 os_prio=0 tid=0x00007f4eb848e800 nid=0x5d94 waiting on condition [0x00007f4e8bd8b000] java.lang.Thread.State: WAITING (parking) at sun.misc.Unsafe.park(Native Method)","categories":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/categories/issue/"}],"tags":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/tags/issue/"}]},{"title":"final finally finalizeåŒºåˆ«","slug":"source-code/java/final-finally-finalize","date":"2018-09-06T09:58:38.000Z","updated":"2020-04-04T06:21:20.355Z","comments":true,"path":"2018/09/06/final-finally-finalize-difference.html","link":"","permalink":"https://liuzhihang.com/2018/09/06/final-finally-finalize-difference.html","excerpt":"finalfinalä¸ºjavaå…³é”®å­—, å¯ä»¥ä½œç”¨äºæˆå‘˜å˜é‡ã€æ–¹æ³•ã€ç±»ä¸Š1.ä½œç”¨äºæˆå‘˜å˜é‡ä¸Š, åŸºæœ¬ç±»å‹åˆ™å€¼ä¸å¯ä¿®æ”¹, å¦‚æœæˆå‘˜å˜é‡ä¸ºå¯¹è±¡, åˆ™è¯¥å¯¹è±¡çš„å¼•ç”¨ä¸å¯ä¿®æ”¹.2.ä½œç”¨äºæ–¹æ³•, è¯¥æ–¹æ³•ä¸å¯è¢«é‡å†™3.ä½œç”¨äºç±», è¯¥ç±»ä¸å¯ç»§æ‰¿","text":"finalfinalä¸ºjavaå…³é”®å­—, å¯ä»¥ä½œç”¨äºæˆå‘˜å˜é‡ã€æ–¹æ³•ã€ç±»ä¸Š1.ä½œç”¨äºæˆå‘˜å˜é‡ä¸Š, åŸºæœ¬ç±»å‹åˆ™å€¼ä¸å¯ä¿®æ”¹, å¦‚æœæˆå‘˜å˜é‡ä¸ºå¯¹è±¡, åˆ™è¯¥å¯¹è±¡çš„å¼•ç”¨ä¸å¯ä¿®æ”¹.2.ä½œç”¨äºæ–¹æ³•, è¯¥æ–¹æ³•ä¸å¯è¢«é‡å†™3.ä½œç”¨äºç±», è¯¥ç±»ä¸å¯ç»§æ‰¿ finallyå¼‚å¸¸å¤„ç†çš„å…³é”®å­—, æ— è®ºå¼‚å¸¸æ˜¯å¦å‘ç”Ÿ, finallyå†…é€»è¾‘æ€»ä¼šæ‰§è¡Œ. finally å’Œ return çš„æ‰§è¡Œé¡ºåº1.ä¸€èˆ¬ä½¿ç”¨é€»è¾‘, returnåœ¨try-catch-finallyä¹‹å, è¯æ˜, æ— è®ºæ˜¯å¦å¼‚å¸¸, finallyéƒ½ä¼šæ‰§è¡Œ public class MainTest &#123; public static void main(String[] args) &#123; System.out.println(finallyTest()); &#125; private static String finallyTest() &#123; try &#123; System.out.println(&quot;å¤„ç†é€»è¾‘&quot;); // int i = 1 / 0; &#125; catch (Exception e) &#123; System.out.println(&quot;å¼‚å¸¸é€»è¾‘&quot;); &#125; finally &#123; System.out.println(&quot;finallyæ‰§è¡Œäº†&quot;); &#125; return &quot;æœ€ç»ˆreturnè¿”å›&quot;; &#125;&#125; 2.åœ¨try/catchå†…æ·»åŠ returntry/catchå†…çš„returnæ‰§è¡Œå®Œåä¼šç»§ç»­æ‰§è¡Œfinally, ä½†æ˜¯ä»æ‰“å°ç»“æœæ¥å¼€, finallyçš„è¯­å¥å…ˆæ‰“å°, åŸå› æ˜¯å› ä¸º returnçš„ public class MainTest &#123; public static void main(String[] args) &#123; System.out.println(finallyTest()); &#125; private static String finallyTest() &#123; try &#123; System.out.println(&quot;å¤„ç†é€»è¾‘&quot;); // int i = 1 / 0; return &quot;try - returnè¿”å›&quot;; &#125; catch (Exception e) &#123; System.out.println(&quot;å¼‚å¸¸é€»è¾‘&quot;); // return &quot;catch - returnè¿”å›&quot;; &#125; finally &#123; System.out.println(&quot;finallyæ‰§è¡Œäº†&quot;); &#125; return &quot;æœ€ç»ˆreturnè¿”å›&quot;; &#125;&#125; è¾“å‡ºç»“æœ å¤„ç†é€»è¾‘finallyæ‰§è¡Œäº†try - returnè¿”å› 3.finallyé‡Œé¢æ·»åŠ returnè¯­å¥finallyé‡Œé¢returnæ‰§è¡Œå®Œåä¼šç›´æ¥è¿”å›, ä¸ä¼šå†æ‰§è¡Œtryå—ä¸­çš„returnè¯­å¥ public class MainTest &#123; public static void main(String[] args) &#123; System.out.println(finallyTest()); &#125; private static String finallyTest() &#123; try &#123; System.out.println(&quot;å¤„ç†é€»è¾‘&quot;); // int i = 1 / 0; return &quot;try - returnè¿”å›&quot;; &#125; catch (Exception e) &#123; System.out.println(&quot;å¼‚å¸¸é€»è¾‘&quot;); // return &quot;catch - returnè¿”å›&quot;; &#125; finally &#123; System.out.println(&quot;finallyæ‰§è¡Œäº†&quot;); return &quot;finally - returnè¿”å›&quot;; &#125; // return &quot;æœ€ç»ˆreturnè¿”å›&quot;; &#125;&#125; æ‰§è¡Œç»“æœ å¤„ç†é€»è¾‘finallyæ‰§è¡Œäº†finally - returnè¿”å› 4.finallyå†…æ·»åŠ é€»è¾‘æ”¹å˜å˜é‡å€¼1).tryä¸­çš„returnå€¼åªæ˜¯æš‚æ—¶æ”¾åœ¨æ ˆä¸­, æ‰€ä»¥æœ€ç»ˆè¿”å›çš„è¿˜æ˜¯ 10, finallyä¸­å¹¶æ²¡æœ‰æ”¹å˜å…¶å€¼2).tryä¸­çš„returnå€¼å¦‚æœæ˜¯å¯¹è±¡, æ ˆä¸­å­˜æ”¾çš„æ˜¯å¯¹è±¡çš„å¼•ç”¨, å¯¹è±¡å±æ€§å€¼è¿˜æ˜¯å¯ä»¥é€šè¿‡finallyä¿®æ”¹ public class MainTest &#123; public static void main(String[] args) &#123; System.out.println(finallyTest()); &#125; private static String finallyTest() &#123; int temp = 10; try &#123; System.out.println(&quot;å¤„ç†é€»è¾‘&quot;); return &quot;try - returnè¿”å›: &quot; + temp; &#125; catch (Exception e) &#123; System.out.println(&quot;å¼‚å¸¸é€»è¾‘&quot;); // return &quot;catch - returnè¿”å›&quot;; &#125; finally &#123; temp = 100; System.out.println(&quot;finallyæ‰§è¡Œäº†&quot;); &#125; return &quot;æœ€ç»ˆreturnè¿”å›: &quot; + temp; &#125;&#125; è¾“å‡ºç»“æœ å¤„ç†é€»è¾‘finallyæ‰§è¡Œäº†try - returnè¿”å›: 10 public class MainTest &#123; public static void main(String[] args) &#123; Temp temp = new Temp(); temp.temp = 1; System.out.println(finallyTest(temp).toString()); &#125; private static Temp finallyTest(Temp temp) &#123; try &#123; System.out.println(&quot;å¤„ç†é€»è¾‘&quot;); return temp; &#125; catch (Exception e) &#123; System.out.println(&quot;å¼‚å¸¸é€»è¾‘&quot;); // return &quot;catch - returnè¿”å›&quot;; &#125; finally &#123; temp.temp = 100; System.out.println(&quot;finallyæ‰§è¡Œäº†&quot;); &#125; return temp; &#125;&#125;class Temp &#123; int temp; @Override public String toString() &#123; return &quot;Temp&#123;&quot; + &quot;temp=&quot; + temp + &#x27;&#125;&#x27;; &#125;&#125; æ‰“å°ç»“æœ å¤„ç†é€»è¾‘finallyæ‰§è¡Œäº†Temp&#123;temp=100&#125; finalizeæ–¹æ³•Objectç±»çš„æ–¹æ³•, å­ç±»å¯é‡å†™, ä¸»è¦æ˜¯åƒåœ¾å›æ”¶æ—¶ä½¿ç”¨.","categories":[{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"},{"name":"java","slug":"æºç å­¦ä¹ /java","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/java/"}],"tags":[{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"}]},{"title":"çº¿ç¨‹æ± åŸç†åŠæºç è§£æ","slug":"concurrent/thread-pool","date":"2018-09-05T08:40:35.000Z","updated":"2020-04-04T06:49:14.278Z","comments":true,"path":"2018/09/05/thread-pool-principle-and-source-code-analysis.html","link":"","permalink":"https://liuzhihang.com/2018/09/05/thread-pool-principle-and-source-code-analysis.html","excerpt":"çº¿ç¨‹æ± å¤„ç†æµç¨‹ åˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹æ± æ˜¯å¦å·²æ»¡, ä¸æ»¡åˆ™åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ ç­‰å¾…é˜Ÿåˆ—å¦‚æœæœ‰ç•Œ, åˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—æ˜¯å¦å·²æ»¡, ä¸æ»¡, åˆ™æ·»åŠ ä»»åŠ¡åˆ°ç­‰å¾…é˜Ÿåˆ— åˆ¤æ–­æœ€å¤§çº¿ç¨‹æ•°æ˜¯å¦å·²æ»¡, ä¸æ»¡åˆ™åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ æœ€å¤§çº¿ç¨‹æ•°å·²æ»¡, æŒ‰ç…§æ—¢å®šç­–ç•¥å¤„ç†æ–°ä»»åŠ¡","text":"çº¿ç¨‹æ± å¤„ç†æµç¨‹ åˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹æ± æ˜¯å¦å·²æ»¡, ä¸æ»¡åˆ™åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ ç­‰å¾…é˜Ÿåˆ—å¦‚æœæœ‰ç•Œ, åˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—æ˜¯å¦å·²æ»¡, ä¸æ»¡, åˆ™æ·»åŠ ä»»åŠ¡åˆ°ç­‰å¾…é˜Ÿåˆ— åˆ¤æ–­æœ€å¤§çº¿ç¨‹æ•°æ˜¯å¦å·²æ»¡, ä¸æ»¡åˆ™åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ æœ€å¤§çº¿ç¨‹æ•°å·²æ»¡, æŒ‰ç…§æ—¢å®šç­–ç•¥å¤„ç†æ–°ä»»åŠ¡ å…¨å‚æ„é€ åŠå„å‚æ•°å«ä¹‰public class ThreadPoolExecutor extends AbstractExecutorService &#123; public ThreadPoolExecutor(int corePoolSize, // æ ¸å¿ƒçº¿ç¨‹æ•° int maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•° long keepAliveTime, // æ ¸å¿ƒçº¿ç¨‹å¤–çº¿ç¨‹çš„å­˜æ´»æ—¶é—´ TimeUnit unit, // å­˜æ´»æ—¶é—´çš„å•ä½ BlockingQueue&lt;Runnable&gt; workQueue, // ä¿å­˜ç­‰å¾…æ‰§è¡Œçš„çº¿ç¨‹çš„é˜»å¡é˜Ÿåˆ— ThreadFactory threadFactory, // çº¿ç¨‹å·¥å‚ RejectedExecutionHandler handler) &#123; // çº¿ç¨‹æ‹’ç»ç­–ç•¥ if (corePoolSize &lt; 0 || maximumPoolSize &lt;= 0 || maximumPoolSize &lt; corePoolSize || keepAliveTime &lt; 0) throw new IllegalArgumentException(); if (workQueue == null || threadFactory == null || handler == null) throw new NullPointerException(); this.acc = System.getSecurityManager() == null ? null : AccessController.getContext(); this.corePoolSize = corePoolSize; this.maximumPoolSize = maximumPoolSize; this.workQueue = workQueue; this.keepAliveTime = unit.toNanos(keepAliveTime); this.threadFactory = threadFactory; this.handler = handler; &#125; // çœç•¥ . . .&#125; workQueueé˜»å¡é˜Ÿåˆ—ArrayBlockingQueue: æ˜¯ä¸€ä¸ªåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—, æ­¤é˜Ÿåˆ—æŒ‰ FIFO(å…ˆè¿›å…ˆå‡º) åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åº.LinkedBlockingQueue: ä¸€ä¸ªåŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—,æ­¤é˜Ÿåˆ—æŒ‰ FIFO(å…ˆè¿›å…ˆå‡º) æ’åºå…ƒç´ , ååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueue. é™æ€å·¥å‚æ–¹æ³•Executors.newFixedThreadPool()ä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—SynchronousQueue: ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—. æ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œ, å¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€, ååé‡é€šå¸¸è¦é«˜äºLinkedBlockingQueue, é™æ€å·¥å‚æ–¹æ³•Executors.newCachedThreadPoolä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—.PriorityBlockingQueue: ä¸€ä¸ªå…·æœ‰ä¼˜å…ˆçº§çš„æ— é™é˜»å¡é˜Ÿåˆ—. 2.threadFactoryçº¿ç¨‹å·¥å‚å¯ä»¥ä½¿ç”¨é»˜è®¤çš„å·¥å‚ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å·¥å‚, æˆ–è€…ä½¿ç”¨ google guava æä¾›çš„å·¥å‚, å¯ä»¥ä¸ºçº¿ç¨‹å‘½åå’Œè®¾ç½®æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹ // é»˜è®¤å·¥å‚ThreadFactory threadFactory = Executors.defaultThreadFactory();// google guavaå·¥å…·æä¾›ThreadFactory namedThreadFactory = new ThreadFactoryBuilder().setNameFormat(&quot;demo-pool-%d&quot;).build(); 3.handlerçº¿ç¨‹æ‹’ç»ç­–ç•¥å½“çº¿ç¨‹æ± è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°, å¹¶ä¸”é˜Ÿåˆ—æ»¡äº†, æ–°çš„çº¿ç¨‹è¦é‡‡å–çš„å¤„ç†ç­–ç•¥.1.AbortPolicy æ‹’ç»æ–°ä»»åŠ¡å¹¶æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸2.CallerRunsPolicy ç›´æ¥åœ¨è°ƒç”¨ç¨‹åºçš„çº¿ç¨‹ä¸­è¿è¡Œ3.DiscardOldestPolicy æ”¾å¼ƒæœ€æ—©çš„ä»»åŠ¡, å³é˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡4.DiscardPolicy ä¸¢å¼ƒ, ä¸å¤„ç† Executorsåˆå§‹åŒ–çº¿ç¨‹æ± çš„å››ç§æ–¹å¼è¿™å››ç§åˆå§‹åŒ–çº¿ç¨‹æ± çš„æ–¹å¼, å‰ä¸‰ç§éƒ½æ˜¯è°ƒç”¨ ThreadPoolExecutor ç±»çš„æ„é€ åˆ›å»ºçš„çº¿ç¨‹æ± , åªä¸è¿‡ä½¿ç”¨çš„é˜»å¡é˜Ÿåˆ—æ–¹å¼ä¸åŒ. newFixedThreadPool() public class Executors &#123; /** * å›ºå®šçº¿ç¨‹æ±  * æ ¸å¿ƒçº¿ç¨‹æ•° = æœ€å¤§çº¿ç¨‹æ•° * è¶…æ—¶æ—¶é—´ä¸º0 * LinkedBlockingQueueæ— ç•Œé˜Ÿåˆ—, ä¼šæŒç»­ç­‰å¾… * ä½¿ç”¨é»˜è®¤æ‹’ç»ç­–ç•¥ AbortPolicy */ public static ExecutorService newFixedThreadPool(int nThreads) &#123; return new ThreadPoolExecutor(nThreads, nThreads, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;()); &#125;&#125; newCachedThreadPool() public class Executors &#123; /** * æ— ç•Œçº¿ç¨‹æ±  * æ ¸å¿ƒçº¿ç¨‹æ•°0 æœ€å¤§çº¿ç¨‹æ•° (2Â³Â¹ -1) * è¶…æ—¶æ—¶é—´ 60ç§’ * SynchronousQueueä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ— * çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡60ç§’, ä¼šè‡ªåŠ¨é‡Šæ”¾èµ„æº, æäº¤ä»»åŠ¡å¦‚æœæ²¡æœ‰ç©ºé—²çº¿ç¨‹, åˆ™ä¼šåˆ›å»ºæ–°çº¿ç¨‹ */ public static ExecutorService newCachedThreadPool() &#123; return new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;()); &#125;&#125; 3.newSingleThreadExecutor() public class Executors &#123; /** * åˆ›å»ºåªæœ‰ 1ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ±  * å¦‚æœçº¿ç¨‹å¼‚å¸¸, åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œä»»åŠ¡ * */ public static ExecutorService newSingleThreadExecutor() &#123; return new FinalizableDelegatedExecutorService (new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;())); &#125;&#125; 4.newSingleThreadExecutor() public class Executors &#123; /** * ScheduledThreadPoolExecutor ç»§æ‰¿ ThreadPoolExecutor ç±» * å¯ä»¥åœ¨æŒ‡å®šæ—¶é—´å‘¨æœŸå†…æ‰§è¡Œä»»åŠ¡ * */ public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) &#123; return new ScheduledThreadPoolExecutor(corePoolSize); &#125;&#125; æºç è§£æå˜é‡public class ThreadPoolExecutor extends AbstractExecutorService &#123; /** * ctx ä¸ºåŸå­ç±»å‹çš„å˜é‡, æœ‰ä¸¤ä¸ªæ¦‚å¿µ * workerCount, è¡¨ç¤ºæœ‰æ•ˆçš„çº¿ç¨‹æ•° * runState, è¡¨ç¤ºçº¿ç¨‹çŠ¶æ€, æ˜¯å¦æ­£åœ¨è¿è¡Œ, å…³é—­ç­‰ */ private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0)); // 29 private static final int COUNT_BITS = Integer.SIZE - 3; // å®¹é‡ 2Â²â¹-1 private static final int CAPACITY = (1 &lt;&lt; COUNT_BITS) - 1; // runState is stored in the high-order bits çº¿ç¨‹æ± çš„äº”ä¸­çŠ¶æ€ // å³é«˜3ä½ä¸º111, æ¥å—æ–°ä»»åŠ¡å¹¶å¤„ç†æ’é˜Ÿä»»åŠ¡ private static final int RUNNING = -1 &lt;&lt; COUNT_BITS; // å³é«˜3ä½ä¸º000, ä¸æ¥å—æ–°ä»»åŠ¡, ä½†å¤„ç†æ’é˜Ÿä»»åŠ¡ private static final int SHUTDOWN = 0 &lt;&lt; COUNT_BITS; // å³é«˜3ä½ä¸º001, ä¸æ¥å—æ–°ä»»åŠ¡, ä¸å¤„ç†æ’é˜Ÿä»»åŠ¡, å¹¶ä¸­æ–­æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ private static final int STOP = 1 &lt;&lt; COUNT_BITS; // å³é«˜3ä½ä¸º010, æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»ˆæ­¢, å·¥ä½œçº¿ç¨‹ä¸º0, çº¿ç¨‹è½¬æ¢åˆ°çŠ¶æ€TIDYING, å°†è¿è¡Œterminate()é’©å­æ–¹æ³• private static final int TIDYING = 2 &lt;&lt; COUNT_BITS; // å³é«˜3ä½ä¸º011, æ ‡è¯†terminateï¼ˆï¼‰å·²ç»å®Œæˆ private static final int TERMINATED = 3 &lt;&lt; COUNT_BITS; // Packing and unpacking ctl ç”¨æ¥è®¡ç®—çº¿ç¨‹çš„æ–¹æ³• private static int runStateOf(int c) &#123; return c &amp; ~CAPACITY; &#125; private static int workerCountOf(int c) &#123; return c &amp; CAPACITY; &#125; private static int ctlOf(int rs, int wc) &#123; return rs | wc; &#125;&#125; executeæ–¹æ³•public class ThreadPoolExecutor extends AbstractExecutorService &#123; public void execute(Runnable command) &#123; // ç©ºåˆ™æŠ›å‡ºå¼‚å¸¸ if (command == null) throw new NullPointerException(); // è·å–å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€ int c = ctl.get(); // è®¡ç®—å·¥ä½œçº¿ç¨‹æ•° å¹¶åˆ¤æ–­æ˜¯å¦å°äºæ ¸å¿ƒçº¿ç¨‹æ•° if (workerCountOf(c) &lt; corePoolSize) &#123; // addWorkeræäº¤ä»»åŠ¡, æäº¤æˆåŠŸåˆ™ç»“æŸ if (addWorker(command, true)) return; // æäº¤å¤±è´¥å†æ¬¡è·å–å½“å‰çŠ¶æ€ c = ctl.get(); &#125; // åˆ¤æ–­çº¿ç¨‹çŠ¶æ€, å¹¶æ’å…¥é˜Ÿåˆ—, å¤±è´¥åˆ™ç§»é™¤ if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; // å†æ¬¡è·å–çŠ¶æ€ int recheck = ctl.get(); // å¦‚æœçŠ¶æ€ä¸æ˜¯RUNNING, å¹¶ç§»é™¤å¤±è´¥ if (! isRunning(recheck) &amp;&amp; remove(command)) // è°ƒç”¨æ‹’ç»ç­–ç•¥ reject(command); // å¦‚æœå·¥ä½œçº¿ç¨‹ä¸º0 åˆ™è°ƒç”¨ addWorker else if (workerCountOf(recheck) == 0) addWorker(null, false); &#125; // æäº¤ä»»åŠ¡å¤±è´¥ èµ°æ‹’ç»ç­–ç•¥ else if (!addWorker(command, false)) reject(command); &#125;&#125; addWorkeræ–¹æ³•public class ThreadPoolExecutor extends AbstractExecutorService &#123; /** * æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å¯ä»¥æäº¤ * */ private boolean addWorker(Runnable firstTask, boolean core) &#123; retry: // å¤–å±‚å¾ªç¯ for (;;) &#123; // è·å–å½“å‰çŠ¶æ€ int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. æ£€æŸ¥çº¿ç¨‹æ± æ˜¯å¦å…³é—­ if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; // å†…å±‚å¾ªç¯ for (;;) &#123; int wc = workerCountOf(c); // å·¥ä½œçº¿ç¨‹å¤§äºå®¹é‡ æˆ–è€…å¤§äº æ ¸å¿ƒæˆ–æœ€å¤§çº¿ç¨‹æ•° if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; // CAS çº¿ç¨‹æ•°å¢åŠ , æˆåŠŸåˆ™è°ƒåˆ°å¤–å±‚å¾ªç¯ if (compareAndIncrementWorkerCount(c)) break retry; // å¤±è´¥åˆ™å†æ¬¡è·å–çº¿ç¨‹çŠ¶æ€ c = ctl.get(); // Re-read ctl // ä¸ç›¸ç­‰åˆ™é‡æ–°èµ°å¤–å±‚å¾ªç¯ if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop &#125; &#125; /** * åˆ›å»ºæ–°worker å¼€å§‹æ–°çº¿ç¨‹ */ boolean workerStarted = false; boolean workerAdded = false; Worker w = null; try &#123; w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; // åŠ é” mainLock.lock(); try &#123; // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int rs = runStateOf(ctl.get()); if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; // åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å­˜æ´», å·²å­˜æ´»æŠ›å‡ºéæ³•å¼‚å¸¸ if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); // è®¾ç½®åŒ…å«æ± ä¸­çš„æ‰€æœ‰å·¥ä½œçº¿ç¨‹ã€‚ä»…åœ¨æŒæœ‰mainLockæ—¶è®¿é—® workersæ˜¯ HashSet é›†åˆ // private final HashSet&lt;Worker&gt; workers = new HashSet&lt;Worker&gt;(); workers.add(w); int s = workers.size(); // è®¾ç½®æ± æœ€å¤§å¤§å°, å¹¶å°† workerAddedè®¾ç½®ä¸º true if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; &#125; &#125; finally &#123; // è§£é” mainLock.unlock(); &#125; // æ·»åŠ æˆåŠŸ å¼€å§‹å¯åŠ¨çº¿ç¨‹ å¹¶å°† workerStarted è®¾ç½®ä¸º true if (workerAdded) &#123; t.start(); workerStarted = true; &#125; &#125; &#125; finally &#123; // å¯åŠ¨çº¿ç¨‹å¤±è´¥ if (! workerStarted) addWorkerFailed(w); &#125; return workerStarted; &#125; /** * å¯åŠ¨çº¿ç¨‹å¤±è´¥, åŠ é” * ç§»é™¤çº¿ç¨‹, å¹¶å‡å°‘çº¿ç¨‹æ€»æ•° * è½¬æ¢çŠ¶æ€ */ private void addWorkerFailed(Worker w) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; if (w != null) workers.remove(w); decrementWorkerCount(); tryTerminate(); &#125; finally &#123; mainLock.unlock(); &#125; &#125;&#125;","categories":[{"name":"å¹¶å‘å’Œé”","slug":"å¹¶å‘å’Œé”","permalink":"https://liuzhihang.com/categories/%E5%B9%B6%E5%8F%91%E5%92%8C%E9%94%81/"}],"tags":[{"name":"çº¿ç¨‹æ± ","slug":"çº¿ç¨‹æ± ","permalink":"https://liuzhihang.com/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"}]},{"title":"å¤šçº¿ç¨‹ç›¸å…³","slug":"concurrent/multi-thread","date":"2018-09-04T11:08:03.000Z","updated":"2020-04-04T06:16:02.599Z","comments":true,"path":"2018/09/04/multithreaded-correlation.html","link":"","permalink":"https://liuzhihang.com/2018/09/04/multithreaded-correlation.html","excerpt":"å¤šçº¿ç¨‹å¤šä¸ªçº¿ç¨‹åŒæ—¶æˆ–äº¤æ›¿è¿è¡Œ, å•æ ¸CPUä¸ºé¡ºåºæ‰§è¡Œ(äº¤æ›¿æ‰§è¡Œ), å¤šæ ¸æƒ…å†µä¸‹, æ¯ä¸ªCPUæœ‰è‡ªå·±çš„è¿ç®—å™¨, æ‰€ä»¥åœ¨å¤šä¸ªCPUä¸­å¯ä»¥åŒæ—¶è¿è¡Œ.","text":"å¤šçº¿ç¨‹å¤šä¸ªçº¿ç¨‹åŒæ—¶æˆ–äº¤æ›¿è¿è¡Œ, å•æ ¸CPUä¸ºé¡ºåºæ‰§è¡Œ(äº¤æ›¿æ‰§è¡Œ), å¤šæ ¸æƒ…å†µä¸‹, æ¯ä¸ªCPUæœ‰è‡ªå·±çš„è¿ç®—å™¨, æ‰€ä»¥åœ¨å¤šä¸ªCPUä¸­å¯ä»¥åŒæ—¶è¿è¡Œ. åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼1.ç»§æ‰¿Thread public class MyThread extends Thread &#123; @Override public void run() &#123; super.run(); System.out.println(Thread.currentThread().getName() + &quot;æ‰§è¡Œå®Œæ¯•&quot;); &#125;&#125; public class ThreadTest &#123; public static void main(String[] args) &#123; MyThread myThread = new MyThread(); myThread.setName(&quot;æµ‹è¯•&quot;); myThread.start(); System.out.println(Thread.currentThread().getName() + &quot;æ‰§è¡Œå®Œæ¯•&quot;); &#125;&#125; å¼€å§‹çº¿ç¨‹, å¯ä»¥çœ‹å‡ºmainçº¿ç¨‹å’Œæµ‹è¯•çº¿ç¨‹æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„çº¿ç¨‹è°ƒç”¨myThread.run();æ–¹æ³•ç›¸å½“äºç›´æ¥åœ¨ä¸»çº¿ç¨‹è¿è¡Œrunæ–¹æ³•, è€Œä¸æ˜¯å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹å»æ‰§è¡Œ 2.å®ç°Runnableæ¥å£ public class MyRunable implements Runnable &#123; @Override public void run() &#123; System.out.println(Thread.currentThread().getName() + &quot;æ‰§è¡Œå®Œæ¯•&quot;); &#125;&#125; public class ThreadTest &#123; public static void main(String[] args) &#123; MyRunable runable = new MyRunable(); Thread thread = new Thread(runable); thread.start(); System.out.println(Thread.currentThread().getName() + &quot;æ‰§è¡Œå®Œæ¯•&quot;); &#125;&#125; 3.ä½¿ç”¨çº¿ç¨‹æ± 3.1 å¯ä»¥åœ¨springä¸­é…ç½®ç›¸å…³çº¿ç¨‹æ± , ä½¿ç”¨æ—¶ä»å®¹å™¨å–å‡ºå³å¯, ä¹Ÿå¯ä»¥è‡ªå·±å£°æ˜çº¿ç¨‹æ±  &lt;bean id=&quot;threadPool&quot; class=&quot;org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor&quot;&gt; &lt;!-- æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé»˜è®¤ä¸º1 --&gt; &lt;property name=&quot;corePoolSize&quot; value=&quot;5&quot;/&gt; &lt;!-- æœ€å¤§çº¿ç¨‹æ•°ï¼Œé»˜è®¤ä¸ºInteger.MAX_VALUE --&gt; &lt;property name=&quot;maxPoolSize&quot; value=&quot;20&quot;/&gt; &lt;!-- é˜Ÿåˆ—æœ€å¤§é•¿åº¦ï¼Œä¸€èˆ¬éœ€è¦è®¾ç½®å€¼&gt;=notifyScheduledMainExecutor.maxNumï¼›é»˜è®¤ä¸ºInteger.MAX_VALUE &lt;property name=&quot;queueCapacity&quot; value=&quot;1000&quot; /&gt; --&gt; &lt;!-- çº¿ç¨‹æ± ç»´æŠ¤çº¿ç¨‹æ‰€å…è®¸çš„ç©ºé—²æ—¶é—´ï¼Œé»˜è®¤ä¸º60s --&gt; &lt;property name=&quot;keepAliveSeconds&quot; value=&quot;300&quot;/&gt; &lt;!-- é˜Ÿåˆ—æœ€å¤§é•¿åº¦ --&gt; &lt;property name=&quot;queueCapacity&quot; value=&quot;2000&quot;/&gt; &lt;!-- çº¿ç¨‹æ± å¯¹æ‹’ç»ä»»åŠ¡ï¼ˆæ— çº¿ç¨‹å¯ç”¨ï¼‰çš„å¤„ç†ç­–ç•¥ï¼Œç›®å‰åªæ”¯æŒAbortPolicyã€CallerRunsPolicyï¼›é»˜è®¤ä¸ºåè€… --&gt; &lt;property name=&quot;rejectedExecutionHandler&quot;&gt; &lt;!-- AbortPolicy:ç›´æ¥æŠ›å‡ºjava.utils.concurrent.RejectedExecutionExceptionå¼‚å¸¸ --&gt; &lt;!-- CallerRunsPolicy:ä¸»çº¿ç¨‹ç›´æ¥æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œä¹‹åå°è¯•æ·»åŠ ä¸‹ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­ï¼Œå¯ä»¥æœ‰æ•ˆé™ä½å‘çº¿ç¨‹æ± å†…æ·»åŠ ä»»åŠ¡çš„é€Ÿåº¦ --&gt; &lt;!-- DiscardOldestPolicy:æŠ›å¼ƒæ—§çš„ä»»åŠ¡ã€æš‚ä¸æ”¯æŒï¼›ä¼šå¯¼è‡´è¢«ä¸¢å¼ƒçš„ä»»åŠ¡æ— æ³•å†æ¬¡è¢«æ‰§è¡Œ --&gt; &lt;!-- DiscardPolicy:æŠ›å¼ƒå½“å‰ä»»åŠ¡ã€æš‚ä¸æ”¯æŒï¼›ä¼šå¯¼è‡´è¢«ä¸¢å¼ƒçš„ä»»åŠ¡æ— æ³•å†æ¬¡è¢«æ‰§è¡Œ --&gt; &lt;bean class=&quot;java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy&quot;/&gt; &lt;/property&gt;&lt;/bean&gt; 3.2 Executors åˆ›å»ºçº¿ç¨‹æ±  public class ThreadTest &#123; public static void main(String[] args) &#123; ExecutorService threadPool = Executors.newCachedThreadPool(); for (int i = 0; i &lt; 10; i++) &#123; threadPool.execute(new MyRunable()); &#125; &#125;&#125; å½“æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± æ—¶, å¦‚æœIDEAå®‰è£…é˜¿é‡Œ P3C æ’ä»¶åä¼šæŠ¥é”™æç¤ºä»¥ä¸‹å†…å®¹, å»ºè®® çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©ã€‚è¯´æ˜ï¼š Executors è¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š1ï¼‰ FixedThreadPool å’Œ SingleThreadPool:å…è®¸çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸º Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚2ï¼‰ CachedThreadPool å’Œ ScheduledThreadPool:å…è®¸çš„åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸º Integer.MAX_VALUEï¼Œ å¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚ å»ºè®®ä½¿ç”¨å¦‚ä¸‹æ–¹å¼: public class ThreadTest &#123; public static void main(String[] args) &#123; // å®šæ—¶ä»»åŠ¡ å»ºè®®ä¸ºçº¿ç¨‹èµ·å ScheduledExecutorService executorService = new ScheduledThreadPoolExecutor(3, new BasicThreadFactory.Builder().namingPattern(&quot;example-schedule-pool-%d&quot;).build()); executorService.scheduleAtFixedRate(new MyRunable(), 0, 1, TimeUnit.SECONDS); &#125;&#125; public class ThreadTest &#123; public static void main(String[] args) &#123; // çº¿ç¨‹å·¥å‚ ThreadFactory namedThreadFactory = new ThreadFactoryBuilder() .setNameFormat(&quot;demo-pool-%d&quot;).build(); //Common Thread Pool ExecutorService pool = new ThreadPoolExecutor(5, 20, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;&gt;(1024), namedThreadFactory, new ThreadPoolExecutor.AbortPolicy()); pool.execute(()-&gt; System.out.println(Thread.currentThread().getName())); pool.shutdown();//gracefully shutdown &#125;&#125; çº¿ç¨‹ä¼˜å…ˆçº§1.myThread.setPriority(1);è®¾ç½®ä¼˜å…ˆçº§2.ä¼˜å…ˆçº§ä»ä½åˆ°é«˜ä¸º 1-10, Threadç±»æä¾› Thread.MIN_PRIORITY=1, Thread.NORM_PRIORITY=5, Thread.MAX_PRIORITY=103.é»˜è®¤ä¼˜å…ˆçº§ä¸º 5 å³ NORM_PRIORITY4.ä¼˜å…ˆçº§é«˜çš„ä»…ä»£è¡¨è·å–è¿›å…¥è¿è¡Œæœºä¼šçš„å‡ ç‡å¤§, å¹¶ä¸ä»£è¡¨ä¸€å®šä¼šæ¯”ä¼˜å…ˆçº§ä½çš„å…ˆæ‰§è¡Œ sleep()å’Œwait()1.sleep()çº¿ç¨‹æœªé‡Šæ”¾é”, æ—¶é—´ç»“æŸåçº¿ç¨‹ç»§ç»­æ‰§è¡Œ2.waitçº¿ç¨‹é‡Šæ”¾é”, éœ€è¦ä½¿ç”¨notifyæˆ–notifyAll3.waitå¸¸ç”¨äºçº¿ç¨‹ä¹‹é—´çš„äº¤äº’ package com.liuzhihang.tool.alternate;/** * äº¤æ›¿æ‰“å°å¥‡å¶æ•° * * @author liuzhihang * @date 2018/9/4 18:39 */public class AlternateNum &#123; public static void main(String[] args) &#123; Num num = new Num(); Thread thread1 = new Thread(new Odd(num)); Thread thread2 = new Thread(new Even(num)); thread1.start(); thread2.start(); &#125;&#125;class Num &#123; int anInt = 1; boolean flag = true;&#125;class Odd implements Runnable &#123; private Num num; public Odd(Num num) &#123; this.num = num; &#125; @Override public void run() &#123; while (num.anInt &lt; 1000) &#123; // ä½¿ç”¨åŒä¸€æŠŠé” synchronized (num) &#123; if (num.flag) &#123; System.out.println(&quot;å¥‡æ•° -&gt; &quot; + num.anInt); num.anInt++; num.flag = false; num.notify(); &#125; else &#123; try &#123; num.wait(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125; &#125; &#125;&#125;class Even implements Runnable &#123; private Num num; public Even(Num num) &#123; this.num = num; &#125; @Override public void run() &#123; while (num.anInt &lt; 1000) &#123; // ä½¿ç”¨åŒä¸€æŠŠé” synchronized (num) &#123; if (!num.flag) &#123; System.out.println(&quot;å¶æ•° -&gt; &quot; + num.anInt); num.anInt++; num.flag = true; num.notify(); &#125; else &#123; try &#123; num.wait(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125; &#125; &#125;&#125;","categories":[{"name":"å¹¶å‘å’Œé”","slug":"å¹¶å‘å’Œé”","permalink":"https://liuzhihang.com/categories/%E5%B9%B6%E5%8F%91%E5%92%8C%E9%94%81/"}],"tags":[{"name":"å¤šçº¿ç¨‹","slug":"å¤šçº¿ç¨‹","permalink":"https://liuzhihang.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"}]},{"title":"åå°„å’Œåºåˆ—åŒ–ç ´è§£å•ä¾‹","slug":"source-code/java/ReflectSingleton","date":"2018-08-27T09:31:23.000Z","updated":"2020-11-13T03:00:25.027Z","comments":true,"path":"2018/08/27/reflection-and-serialization-cracking-singleton.html","link":"","permalink":"https://liuzhihang.com/2018/08/27/reflection-and-serialization-cracking-singleton.html","excerpt":"ä»‹ç»ä¸»è¦ä»‹ç»é€šè¿‡åå°„çš„æ–¹å¼è·å–å•ä¾‹å¯¹è±¡, éªŒè¯å•ä¾‹æ¨¡å¼çš„å®‰å…¨æ€§.ä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦æ¥ä»‹ç»åå°„ä¸‹çš„å•ä¾‹é¥¿æ±‰å¼åŒé‡é”æ£€æŸ¥æšä¸¾å•ä¾‹","text":"ä»‹ç»ä¸»è¦ä»‹ç»é€šè¿‡åå°„çš„æ–¹å¼è·å–å•ä¾‹å¯¹è±¡, éªŒè¯å•ä¾‹æ¨¡å¼çš„å®‰å…¨æ€§.ä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦æ¥ä»‹ç»åå°„ä¸‹çš„å•ä¾‹é¥¿æ±‰å¼åŒé‡é”æ£€æŸ¥æšä¸¾å•ä¾‹ é¥¿æ±‰å¼é¥¿æ±‰å¼ç›´æ¥ä½¿ç”¨åå°„å³å¯ç ´è§£å•ä¾‹æ¨¡å¼ public class ReflectTest &#123; public static void main(String[] args) &#123; try &#123; HungerPattern hungerPattern = HungerPattern.getHungerPattern(); Class&lt;HungerPattern&gt; hungerPatternClass = HungerPattern.class; Constructor&lt;HungerPattern&gt; conA = hungerPatternClass.getDeclaredConstructor(); Constructor&lt;HungerPattern&gt; conB = hungerPatternClass.getDeclaredConstructor(); conA.setAccessible(true); conB.setAccessible(true); HungerPattern instanceA = conA.newInstance(); HungerPattern instanceB = conB.newInstance(); // instanceA å’Œ instanceB ä¸æ˜¯åŒä¸€å¯¹è±¡ System.out.println(hungerPattern.hashCode()); System.out.println(instanceA.hashCode()); System.out.println(instanceB.hashCode()); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;&#125; è¾“å‡ºç»“æœ D:\\jdk1.8\\bin\\java.exe . . .713338599168423058821270929Process finished with exit code 0 åŒé‡é”æ£€æŸ¥åŒé‡é”æ£€æŸ¥åŒæ ·å­˜åœ¨ç›¸åŒçš„æƒ…å†µ ç›´æ¥ä½¿ç”¨public class ReflectTest &#123; public static void main(String[] args) &#123; try &#123; DoubleCheckLockLazyPattern pattern = DoubleCheckLockLazyPattern.getDoubleCheckLockLazyPattern(); Class&lt;DoubleCheckLockLazyPattern&gt; patternClass = DoubleCheckLockLazyPattern.class; Constructor&lt;DoubleCheckLockLazyPattern&gt; conA = patternClass.getDeclaredConstructor(); Constructor&lt;DoubleCheckLockLazyPattern&gt; conB = patternClass.getDeclaredConstructor(); conA.setAccessible(true); conB.setAccessible(true); DoubleCheckLockLazyPattern patternA = conA.newInstance(); DoubleCheckLockLazyPattern patternB = conA.newInstance(); System.out.println(pattern.hashCode()); System.out.println(patternA.hashCode()); System.out.println(patternB.hashCode()); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;&#125; è¾“å‡ºç»“æœ D:\\jdk1.8\\bin\\java.exe . . .713338599168423058821270929Process finished with exit code 0 åœ¨åŒé‡é”æ£€æŸ¥ç§æœ‰æ„é€ å†…åŠ å…¥å¼‚å¸¸ public class DoubleCheckLockLazyPattern &#123; private DoubleCheckLockLazyPattern() &#123; // åŠ å…¥å¼‚å¸¸åˆ¤æ–­, é˜²æ­¢åå°„ if (doubleCheckLockLazyPattern != null) &#123; throw new RuntimeException(); &#125; &#125; private static volatile DoubleCheckLockLazyPattern doubleCheckLockLazyPattern = null; public static DoubleCheckLockLazyPattern getDoubleCheckLockLazyPattern() &#123; try &#123; if (doubleCheckLockLazyPattern == null) &#123; // ä¸€ç³»åˆ—æ“ä½œ Thread.sleep(100); synchronized (DoubleCheckLockLazyPattern.class) &#123; // äºŒæ¬¡æ£€æŸ¥ if (doubleCheckLockLazyPattern == null) &#123; doubleCheckLockLazyPattern = new DoubleCheckLockLazyPattern(); &#125; &#125; &#125; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return doubleCheckLockLazyPattern; &#125;&#125; è¾“å‡ºç»“æœ D:\\jdk1.8\\bin\\java.exe . . .java.lang.reflect.InvocationTargetException at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method) at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62) at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) at java.lang.reflect.Constructor.newInstance(Constructor.java:423) at com.liuzhihang.demo.singleton.ReflectTest.main(ReflectTest.java:24)Caused by: java.lang.RuntimeException at com.liuzhihang.demo.singleton.DoubleCheckLockLazyPattern.&lt;init&gt;(DoubleCheckLockLazyPattern.java:15) ... 5 more é€šè¿‡åºåˆ—åŒ–ååºåˆ—åŒ–è·å–å¯¹è±¡ DoubleCheckLockLazyPattern å®ç°åºåˆ—åŒ– public class ReflectTest &#123; public static void main(String[] args) &#123; try &#123; DoubleCheckLockLazyPattern pattern = DoubleCheckLockLazyPattern.getDoubleCheckLockLazyPattern(); FileOutputStream fos= new FileOutputStream(&quot;C:/Users/liuzhihang/desktop/pattern.txt&quot;); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(pattern); oos.close(); fos.close(); ObjectInputStream oisA = new ObjectInputStream(new FileInputStream(&quot;C:/Users/liuzhihang/desktop/pattern.txt&quot;)); DoubleCheckLockLazyPattern patternA= (DoubleCheckLockLazyPattern) oisA.readObject(); ObjectInputStream oisB = new ObjectInputStream(new FileInputStream(&quot;C:/Users/liuzhihang/desktop/pattern.txt&quot;)); DoubleCheckLockLazyPattern patternB= (DoubleCheckLockLazyPattern) oisB.readObject(); System.out.println(pattern.hashCode()); System.out.println(patternA.hashCode()); System.out.println(patternB.hashCode()); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;&#125; è¾“å‡ºç»“æœ D:\\jdk1.8\\bin\\java.exe . . .25895249917022972011996181658Process finished with exit code 0 ä¿®æ”¹ååºåˆ—åŒ–æ–¹æ³•, å¯ä»¥é˜²æ­¢ååºåˆ—åŒ– æ·»åŠ ä»¥ä¸‹æ–¹æ³• private Object readResolve() &#123; return doubleCheckLockLazyPattern;&#125; è¾“å‡ºç»“æœ D:\\jdk1.8\\bin\\java.exe . . .258952499258952499258952499Process finished with exit code 0 æšä¸¾å•ä¾‹public enum SingletonEnum &#123; /** * å•ä¾‹ */ INSTANCE; private Resource resource; SingletonEnum() &#123; this.resource = new Resource(); &#125; public Resource getResource() &#123; return resource; &#125;&#125;class Resource &#123;&#125; æšä¸¾å•ä¾‹åˆ†æåœ¨æšä¸¾åå°„è·å–å¯¹è±¡æ—¶æŠ›å‡ºå¼‚å¸¸, é€šè¿‡ Constructorç±» æºç å¯ä»¥çœ‹å‡º, åœ¨åå°„åˆ›å»ºå¯¹è±¡æ—¶ä¼šåˆ¤æ–­æ˜¯å¦æ˜¯æšä¸¾ä¿®é¥°, æ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸ @CallerSensitive public T newInstance(Object ... initargs) throws InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123; if (!override) &#123; if (!Reflection.quickCheckMemberAccess(clazz, modifiers)) &#123; Class&lt;?&gt; caller = Reflection.getCallerClass(); checkAccess(caller, clazz, null, modifiers); &#125; &#125; if ((clazz.getModifiers() &amp; Modifier.ENUM) != 0) throw new IllegalArgumentException(&quot;Cannot reflectively create enum objects&quot;); ConstructorAccessor ca = constructorAccessor; // read volatile if (ca == null) &#123; ca = acquireConstructorAccessor(); &#125; @SuppressWarnings(&quot;unchecked&quot;) T inst = (T) ca.newInstance(initargs); return inst; &#125; åŒæ—¶åœ¨çˆ¶ç±» Enumç±» ä¸­é‡å†™äº† readObjectæ–¹æ³•, æ‰€ä»¥æšä¸¾ä¹Ÿå¯ä»¥é¿å…ååºåˆ—åŒ– /** * prevent default deserialization */private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException &#123; throw new InvalidObjectException(&quot;can&#x27;t deserialize enum&quot;);&#125;","categories":[{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"}],"tags":[{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"},{"name":"åå°„","slug":"åå°„","permalink":"https://liuzhihang.com/tags/%E5%8F%8D%E5%B0%84/"}]},{"title":"åå°„","slug":"utils/reflection/Reflect","date":"2018-08-24T11:24:38.000Z","updated":"2020-04-04T07:33:24.454Z","comments":true,"path":"2018/08/24/reflection.html","link":"","permalink":"https://liuzhihang.com/2018/08/24/reflection.html","excerpt":"ä»‹ç»javaåå°„å¯ä»¥åœ¨è¿è¡Œæ—¶è·å–å¯¹è±¡çš„æˆå‘˜å’Œå±æ€§, å¹¶ä¸”å¯ä»¥åŠ¨æ€çš„åˆ›å»ºå¯¹è±¡å¹¶è°ƒç”¨å¯¹è±¡çš„å±æ€§.åå°„ä¸€èˆ¬ç¼–ç¨‹ä¸­å¾ˆå°‘ä½¿ç”¨,ä½†æ˜¯åœ¨å¾ˆå¤šæ¡†æ¶ä¸­éƒ½ä½¿ç”¨äº†åå°„, æ¯”å¦‚é…ç½®Springçš„Xmlé…ç½®æ–‡ä»¶ä¸­, å°±ä½¿ç”¨å…¨ç±»åé…ç½®æ–¹å¼, å…¶å®å°±æ˜¯åå°„çš„ä¸€ç§ä½¿ç”¨æ–¹å¼. åŒæ—¶åå°„å¯¹å•ä¾‹æ¨¡å¼æœ‰ä¸€å®šçš„å½±å“, å¯ä»¥å‚è€ƒåå°„è·å–å•ä¾‹å¯¹è±¡","text":"ä»‹ç»javaåå°„å¯ä»¥åœ¨è¿è¡Œæ—¶è·å–å¯¹è±¡çš„æˆå‘˜å’Œå±æ€§, å¹¶ä¸”å¯ä»¥åŠ¨æ€çš„åˆ›å»ºå¯¹è±¡å¹¶è°ƒç”¨å¯¹è±¡çš„å±æ€§.åå°„ä¸€èˆ¬ç¼–ç¨‹ä¸­å¾ˆå°‘ä½¿ç”¨,ä½†æ˜¯åœ¨å¾ˆå¤šæ¡†æ¶ä¸­éƒ½ä½¿ç”¨äº†åå°„, æ¯”å¦‚é…ç½®Springçš„Xmlé…ç½®æ–‡ä»¶ä¸­, å°±ä½¿ç”¨å…¨ç±»åé…ç½®æ–¹å¼, å…¶å®å°±æ˜¯åå°„çš„ä¸€ç§ä½¿ç”¨æ–¹å¼. åŒæ—¶åå°„å¯¹å•ä¾‹æ¨¡å¼æœ‰ä¸€å®šçš„å½±å“, å¯ä»¥å‚è€ƒåå°„è·å–å•ä¾‹å¯¹è±¡ è·å–åå°„å¯¹è±¡è·å–åå°„Classå¯¹è±¡ä¸€å…±ä¸‰ç§æ–¹å¼ // 1. ä½¿ç”¨å®ä¾‹è·å–User user = new User();Class&lt;? extends User&gt; aClass = user.getClass();// 2. ä½¿ç”¨ç±»è·å–Class&lt;User&gt; userClass = User.class;// 3. å…¨ç±»åè·å–, å¯èƒ½ä¼šæŠ›å‡º ClassNotFoundException å¼‚å¸¸Class&lt;?&gt; aClass1 = Class.forName(&quot;com.liuzhihang.tool.reflect.User&quot;); è·å–å±æ€§ è·å–å­—æ®µ// è·å–æ‰€æœ‰å…¬æœ‰å­—æ®µ (public)Field[] fields = aClass.getFields();// è·å–æ‰€æœ‰å­—æ®µ (public ç¼ºçœ, protected, private)Field[] fields = aClass.getDeclaredFields()// è·å–æŒ‡å®šå…¬å…±å­—æ®µField age = aClass.getField(&quot;age&quot;);// è·å–æŒ‡å®šå­—æ®µ (public ç¼ºçœ, protected, private)Field userName = aClass.getDeclaredField(&quot;userName&quot;); è·å–æ„é€  è·å–æ„é€ // è·å–æ‰€æœ‰æ„é€  ä¸èƒ½è·å–ç§æœ‰Constructor&lt;?&gt;[] constructors = aClass.getConstructors();// è·å–æŒ‡å®šå‚æ•°ç±»å‹çš„æ„é€  ä¸èƒ½è·å–ç§æœ‰ ç©ºåˆ™è·å–ç©ºå‚æ„é€  getConstructor(Class&lt;?&gt;... parameterTypes)Constructor&lt;User&gt; constructor = aClass.getConstructor(String.class);// è·å–æ‰€æœ‰æ„é€  åŒ…å«ç§æœ‰Constructor&lt;?&gt;[] declaredConstructors = aClass.getDeclaredConstructors();// è·å–æŒ‡å®šå‚æ•°ç±»å‹çš„æ„é€  å¯ä»¥è·å–ç§æœ‰ ç©ºåˆ™è·å–ç©ºå‚æ„é€  getDeclaredConstructor(Class&lt;?&gt;... parameterTypes)Constructor&lt;User&gt; declaredConstructor = aClass.getDeclaredConstructor(String.class); ä½¿ç”¨æ„é€ åˆ›å»ºå¯¹è±¡ å¯ä»¥é€šè¿‡ constructor.setAccessible(true); æš´åŠ›ç ´è§£å¿½ç•¥è®¿é—®ä¿®é¥°ç¬¦, æ¥ä½¿ç”¨ç§æœ‰æ„é€ å‚æ•° Constructor&lt;User&gt; constructor = aClass.getDeclaredConstructor(String.class);// æš´åŠ›ç ´è§£constructor.setAccessible(true);User test = constructor.newInstance(&quot;test&quot;); è·å–æ–¹æ³• è·å–æ–¹æ³•// è·å–æ‰€æœ‰å…¬å…±æ–¹æ³•(åŒ…å«çˆ¶ç±»)Method[] methods = aClass.getMethods();// è·å–æ‰€æœ‰æ–¹æ³•Method[] methods = aClass.getDeclaredMethods();// è·å–ç§æœ‰æ–¹æ³• ç¬¬ä¸€ä¸ªå‚æ•°å¡«æ–¹æ³•åç§°Method address = aClass.getDeclaredMethod(&quot;setAddress&quot;, String.class);// è·å–å…¬å…±æ–¹æ³•Method address = aClass.getMethod(&quot;setAddress&quot;, String.class); ä½¿ç”¨æ–¹æ³•Class&lt;?&gt; aClass = Class.forName(&quot;com.liuzhihang.tool.reflect.User&quot;)Method address = aClass.getDeclaredMethod(&quot;setAddress&quot;, String.class);User user = aClass.getConstructor().newInstance();System.out.println(user.toString());// è§£é™¤ç§æœ‰é™åˆ¶address.setAccessible(true);// ä½¿ç”¨invokeæ¥è°ƒç”¨æ–¹æ³•address.invoke(user, &quot;åŒ—äº¬&quot;);System.out.println(user.toString()); è·å–å…¶ä»–å±æ€§è¿˜å¯ä»¥è·å–ç±»å®ç°çš„æ¥å£, çˆ¶ç±», æ³¨è§£, ä»¥åŠåˆ¤æ–­ç±»çš„ç±»å‹ç­‰å¤šç§ä½¿ç”¨æ–¹å¼.","categories":[{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/categories/utils/"}],"tags":[{"name":"åå°„","slug":"åå°„","permalink":"https://liuzhihang.com/tags/%E5%8F%8D%E5%B0%84/"}]},{"title":"LinkListç›¸å…³å­¦ä¹ ","slug":"source-code/java/LinkList","date":"2018-08-23T09:56:29.000Z","updated":"2020-04-04T06:54:14.566Z","comments":true,"path":"2018/08/23/linklist-related-learning.html","link":"","permalink":"https://liuzhihang.com/2018/08/23/linklist-related-learning.html","excerpt":"ä»‹ç» LinkListä¹Ÿæ˜¯å·¥ä½œä¸­å¸¸è§çš„é›†åˆ, åº•å±‚ä½¿ç”¨åŒå‘é“¾è¡¨ç»“æ„æ¯”è¾ƒé€‚åˆæ–°å¢å’Œåˆ é™¤, æŸ¥è¯¢å’Œä¿®æ”¹éœ€è¦éå†ç›¸å¯¹ArrayListæ¯”è¾ƒæ¶ˆè€—æ€§èƒ½","text":"ä»‹ç» LinkListä¹Ÿæ˜¯å·¥ä½œä¸­å¸¸è§çš„é›†åˆ, åº•å±‚ä½¿ç”¨åŒå‘é“¾è¡¨ç»“æ„æ¯”è¾ƒé€‚åˆæ–°å¢å’Œåˆ é™¤, æŸ¥è¯¢å’Œä¿®æ”¹éœ€è¦éå†ç›¸å¯¹ArrayListæ¯”è¾ƒæ¶ˆè€—æ€§èƒ½ å†…éƒ¨ç±» Nodeprivate static class Node&lt;E&gt; &#123; // å…ƒç´ å€¼ E item; // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ Node&lt;E&gt; next; // ä¸Šä¸€ä¸ªå‡ ç‚¹ Node&lt;E&gt; prev; // æ„é€ ä¸€ä¸ªæ–°èŠ‚ç‚¹ æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹å’Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹ Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123; this.item = element; this.next = next; this.prev = prev; &#125;&#125; add æ–°å¢é€šè¿‡ä»£ç å¯ä»¥çœ‹å‡º, åœ¨æ–°å¢å…ƒç´ æ—¶åªéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ Node, å¹¶å°†åŸå§‹é“¾è¡¨æœ€åä¸€ä¸ªNodeçš„nextæŒ‡å‘æ–°Node public boolean add(E e) &#123; linkLast(e); return true;&#125;/** * Links e as last element. */void linkLast(E e) &#123; // å£°æ˜ l ä¸ºæœ€åä¸€ä¸ªèŠ‚ç‚¹ final Node&lt;E&gt; l = last; // åˆ›å»ºæ–°èŠ‚ç‚¹, æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©º final Node&lt;E&gt; newNode = new Node&lt;&gt;(l, e, null); // æœ€åä¸€ä¸ªèŠ‚ç‚¹ä¸ºæ–°åˆ›å»ºçš„èŠ‚ç‚¹ last = newNode; // åˆ¤æ–­æ˜¯å¦ä¸ºç¬¬ä¸€ä¸ªå…ƒç´ , å¦åˆ™å°† æ–°åˆ›å»ºçš„ NodeåŠ å…¥é“¾è¡¨ if (l == null) first = newNode; else l.next = newNode; size++; modCount++;&#125; remove åˆ é™¤1.åˆ é™¤æ“ä½œéœ€è¦éå†é“¾è¡¨æ‰¾åˆ°ç›¸åº”å…ƒç´ , ç„¶åç§»åŠ¨æŒ‡é’ˆå³å¯2.åˆ é™¤é¦–å°¾å…ƒç´ ç›´æ¥ç§»åŠ¨æŒ‡é’ˆå³å¯ removeFirst()/removeLast() æ–¹æ³• public boolean remove(Object o) &#123; if (o == null) &#123; // éå†é“¾è¡¨ for (Node&lt;E&gt; x = first; x != null; x = x.next) &#123; if (x.item == null) &#123; unlink(x); return true; &#125; &#125; &#125; else &#123; for (Node&lt;E&gt; x = first; x != null; x = x.next) &#123; if (o.equals(x.item)) &#123; unlink(x); return true; &#125; &#125; &#125; return false;&#125;/** * åˆ é™¤å…ƒç´  */E unlink(Node&lt;E&gt; x) &#123; // assert x != null; final E element = x.item; final Node&lt;E&gt; next = x.next; final Node&lt;E&gt; prev = x.prev; // åˆ¤æ–­ä¸Šä¸€ä¸ªNodeæ˜¯å¦ä¸ºç©º if (prev == null) &#123; // ç©º, è¯¥èŠ‚ç‚¹ä¸ºé“¾è¡¨å¤´, å°†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸ºé“¾è¡¨å¤´ first = next; &#125; else &#123; // ä¸ä¸ºç©º, å°†ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„next æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ next, å¹¶å°†å½“å‰èŠ‚ç‚¹çš„ prevç½®ä¸ºç©º prev.next = next; x.prev = null; &#125; // åˆ¤æ–­ä¸‹ä¸€ä¸ªNodeæ˜¯å¦ä¸ºç©º if (next == null) &#123; // ç©º, è¯¥èŠ‚ç‚¹ä¸ºé“¾è¡¨å°¾, å°†é“¾è¡¨å°¾è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ last = prev; &#125; else &#123; // ä¸ä¸ºç©º, å°†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„prev, è®¾ç½®ä¸ºä¸Šä¸€ä¸ªèŠ‚ç‚¹, å¹¶å°†å½“å‰èŠ‚ç‚¹çš„ nextç½®ä¸ºç©º next.prev = prev; x.next = null; &#125; x.item = null; size--; modCount++; return element;&#125; get/setget/setæ—¶éƒ½éœ€è¦è·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´ , ä½¿ç”¨äºŒåˆ†æ³•æŸ¥æ‰¾, ç„¶åè¿›è¡Œéå†æŸ¥æ‰¾, æ‰€ä»¥æ­¤å¤„ç›¸è¾ƒäºArrayListå¤šäº†éå†æŸ¥è¯¢, è™½ç„¶ä½¿ç”¨äº†äºŒåˆ†æ³•è¿›è¡Œä¼˜åŒ–, ä½†æ˜¯get/setæ“ä½œç›¸æ¯”ArrayListæ¥è¯´æ€§èƒ½è¿˜æ˜¯ç›¸å¯¹è¾ƒå·® public E get(int index) &#123; // æ ¡éªŒç´¢å¼• checkElementIndex(index); // äºŒåˆ†æ³•éå†æŸ¥æ‰¾èŠ‚ç‚¹ return node(index).item;&#125;public E set(int index, E element) &#123; // æ ¡éªŒç´¢å¼• checkElementIndex(index); // äºŒåˆ†æ³•éå†æŸ¥æ‰¾èŠ‚ç‚¹ Node&lt;E&gt; x = node(index); // ä¿®æ”¹NodeèŠ‚ç‚¹çš„ itemå€¼ E oldVal = x.item; x.item = element; return oldVal;&#125;/** * è¿”å›æŒ‡å®šç´¢å¼•å¤„énullèŠ‚ç‚¹. */Node&lt;E&gt; node(int index) &#123; // assert isElementIndex(index); // åˆ¤æ–­ç´¢å¼•æ˜¯å¦å°äºé•¿åº¦çš„ä¸€åŠ (äºŒåˆ†æ³•) ç„¶åéå†æŸ¥æ‰¾ if (index &lt; (size &gt;&gt; 1)) &#123; Node&lt;E&gt; x = first; for (int i = 0; i &lt; index; i++) x = x.next; return x; &#125; else &#123; Node&lt;E&gt; x = last; for (int i = size - 1; i &gt; index; i--) x = x.prev; return x; &#125;&#125;","categories":[{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"},{"name":"java","slug":"æºç å­¦ä¹ /java","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/java/"}],"tags":[{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"},{"name":"LinkList","slug":"LinkList","permalink":"https://liuzhihang.com/tags/LinkList/"}]},{"title":"ArrayListç›¸å…³å­¦ä¹ ","slug":"source-code/java/ArrayList","date":"2018-08-23T07:17:40.000Z","updated":"2020-04-04T06:20:52.869Z","comments":true,"path":"2018/08/23/arraylist-related-learning.html","link":"","permalink":"https://liuzhihang.com/2018/08/23/arraylist-related-learning.html","excerpt":"ArrayListæ˜¯å·¥ä½œä¸­å¸¸ç”¨çš„é›†åˆ, åŸºäºæ•°ç»„å®ç°, å¯ä»¥æ’å…¥ç©ºæ•°æ®, ä¹Ÿæ”¯æŒéšæœºè®¿é—®.ArrayListæ¯”è¾ƒé€‚åˆ get/setæ“ä½œ, å› ä¸º add/removeéœ€è¦ç§»åŠ¨æ•°æ®, ç›¸å¯¹æ¥è¯´æ¯”è¾ƒæ¶ˆè€—æ€§èƒ½. é»˜è®¤åˆå§‹é•¿åº¦1.é»˜è®¤åˆå§‹é•¿åº¦ä¸º 102.åº•å±‚ç»“æ„ä¸ºObject[] æ•°ç»„","text":"ArrayListæ˜¯å·¥ä½œä¸­å¸¸ç”¨çš„é›†åˆ, åŸºäºæ•°ç»„å®ç°, å¯ä»¥æ’å…¥ç©ºæ•°æ®, ä¹Ÿæ”¯æŒéšæœºè®¿é—®.ArrayListæ¯”è¾ƒé€‚åˆ get/setæ“ä½œ, å› ä¸º add/removeéœ€è¦ç§»åŠ¨æ•°æ®, ç›¸å¯¹æ¥è¯´æ¯”è¾ƒæ¶ˆè€—æ€§èƒ½. é»˜è®¤åˆå§‹é•¿åº¦1.é»˜è®¤åˆå§‹é•¿åº¦ä¸º 102.åº•å±‚ç»“æ„ä¸ºObject[] æ•°ç»„ private static final int DEFAULT_CAPACITY = 10;private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;/** * æ„é€ ä¸€ä¸ªåˆå§‹å®¹é‡ä¸º10çš„ç©ºåˆ—è¡¨ */public ArrayList() &#123; this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;&#125; æ·»åŠ æ–¹æ³• add() å‘æ•°ç»„ä¸­æ·»åŠ å…ƒç´ , æµç¨‹å¦‚ä¸‹ /** * å°†æŒ‡å®šçš„å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾. */public boolean add(E e) &#123; // æ‰©å®¹ ensureCapacityInternal(size + 1); // Increments modCount!! // æ·»åŠ å…ƒç´  elementData[size++] = e; return true;&#125; 2.æ‰©å®¹è¿‡ç¨‹ transient Object[] elementData;// æ‰©å®¹private void ensureCapacityInternal(int minCapacity) &#123; ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));&#125;// è®¡ç®—å®¹é‡, elementDataä¸ºç©º åˆ™ä½¿ç”¨é»˜è®¤å®¹é‡ 10, æŒ‡å®šå®¹é‡private static int calculateCapacity(Object[] elementData, int minCapacity) &#123; if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123; return Math.max(DEFAULT_CAPACITY, minCapacity); &#125; return minCapacity;&#125;// ä¿®æ”¹æ¬¡æ•°è‡ªå¢, å¹¶ä¸”å¦‚æœ æ–°çš„é•¿åº¦-åŸé•¿åº¦&gt;0 åˆ™ä½¿ç”¨ grow(minCapacity)æ–¹æ³•è¿›è¡Œæ‰©å®¹private void ensureExplicitCapacity(int minCapacity) &#123; modCount++; // overflow-conscious code if (minCapacity - elementData.length &gt; 0) grow(minCapacity);&#125; æ·»åŠ å…ƒç´ èµ‹å€¼elementData[size++] = e; æ‰©å®¹æµç¨‹ grow(minCapacity)é€šè¿‡æ‰©å®¹æµç¨‹å¯ä»¥çœ‹å‡ºæ‰©å®¹è¿‡ç¨‹ä¸­, æ˜¯å°†åˆ›å»ºä¸€ä¸ªåŸæ•°ç»„1.5å€å¤§å°çš„æ–°æ•°ç»„, åŒæ—¶å°†æ•°ç»„å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„, æ‰€ä»¥ä¸€èˆ¬ä½¿ç”¨ä¸­, å°½é‡æŒ‡å®šæ•°ç»„å¤§å°, ä»è€Œé¿å…æ•°ç»„çš„å¤åˆ¶. /** * å¢åŠ å®¹é‡ç¡®ä¿èƒ½å®¹çº³ minCapacity æ•°é‡çš„å…ƒç´  */private void grow(int minCapacity) &#123; // overflow-conscious code // è·å–å½“å‰ elementData çš„é•¿åº¦ int oldCapacity = elementData.length; // è·å–æ–°çš„é•¿åº¦ ä¸ºå½“å‰é•¿åº¦çš„ 1.5å€ int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1); // æ¯”è¾ƒå¹¶äº¤æ¢ if (newCapacity - minCapacity &lt; 0) newCapacity = minCapacity; // é˜²æ­¢è¶…å‡ºæœ€å¤§é•¿åº¦ if (newCapacity - MAX_ARRAY_SIZE &gt; 0) newCapacity = hugeCapacity(minCapacity); // minCapacity is usually close to size, so this is a win: // æ•°ç»„å¤åˆ¶ elementData = Arrays.copyOf(elementData, newCapacity);&#125; åˆ é™¤ remove æ–¹æ³•åˆ é™¤è¿‡ç¨‹ä¸­ä½¿ç”¨ System.arraycopy æœ¬åœ°æ–¹æ³•, å¯¹æ•°ç»„è¿›è¡Œå¤åˆ¶, æ‰€ä»¥ ArrayListçš„ æ–°å¢å’Œåˆ é™¤æ–¹æ³•æ€§èƒ½ä¸å¦‚, LinkList, ä½†æ˜¯ getå’Œsetæ–¹æ³•, åˆ™ç›´æ¥æ ¹æ®ç´¢å¼•ä¿®æ”¹æ•°æ®, æ¯”è¾ƒé€‚åˆå¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„æ“ä½œ. /** * åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ , åé¢çš„å…ƒç´ å°†å‰ç§» */public E remove(int index) &#123; // æ£€æŸ¥ç´¢å¼• å¦åˆ™æŠ›å‡º IndexOutOfBoundsException(outOfBoundsMsg(index)) rangeCheck(index); // ä¿®æ”¹æ¬¡æ•°è‡ªå¢ modCount++; E oldValue = elementData(index); int numMoved = size - index - 1; if (numMoved &gt; 0) // æ•°ç»„å¤åˆ¶ System.arraycopy(elementData, index+1, elementData, index, numMoved); elementData[--size] = null; // clear to let GC do its work return oldValue;&#125;/** * åˆ é™¤æŒ‡å®šå…ƒç´  */public boolean remove(Object o) &#123; if (o == null) &#123; for (int index = 0; index &lt; size; index++) if (elementData[index] == null) &#123; fastRemove(index); return true; &#125; &#125; else &#123; for (int index = 0; index &lt; size; index++) if (o.equals(elementData[index])) &#123; fastRemove(index); return true; &#125; &#125; return false;&#125;/** * System.arraycopy æ–¹æ³•æ‹·è´ åˆ é™¤ */private void fastRemove(int index) &#123; modCount++; int numMoved = size - index - 1; if (numMoved &gt; 0) System.arraycopy(elementData, index+1, elementData, index, numMoved); elementData[--size] = null; // clear to let GC do its work&#125;","categories":[{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"},{"name":"java","slug":"æºç å­¦ä¹ /java","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/java/"}],"tags":[{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"}]},{"title":"@Valueæ³¨å…¥å±æ€§çš„å°bug","slug":"issue/inject-bean","date":"2018-08-21T06:47:41.000Z","updated":"2020-04-04T06:23:27.471Z","comments":true,"path":"2018/08/21/value-injects-a-small-bug-in-the-property.html","link":"","permalink":"https://liuzhihang.com/2018/08/21/value-injects-a-small-bug-in-the-property.html","excerpt":"@Valueæ³¨å…¥å±æ€§å·¥ä½œä¸­ä¸€äº›å…¬å…±å±æ€§, ä¸€èˆ¬é€šè¿‡@Valueæ³¨å…¥çš„å¯¹è±¡çš„å±æ€§ä¸­, ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ @Configurationpublic class WeChatConfig &#123; /** * å¾®ä¿¡æ”¯ä»˜å‚æ•° */ @Value(&quot;$&#123;wx.appId&#125;&quot;) public String WX_APP_ID;&#125; é€šè¿‡@Valueæ³¨è§£, å°†é…ç½®æ–‡ä»¶ä¸­çš„å€¼æ³¨å…¥åˆ°å¯¹è±¡å±æ€§ä¸­, åœ¨ä½¿ç”¨æ—¶åªéœ€è¦æ³¨å…¥WeChatConfigå¯¹è±¡ç„¶åè°ƒç”¨å³å¯, è€Œå®é™…å·¥ä½œä¸­, å¾€å¾€ç”¨é™æ€å±æ€§, æ–¹ä¾¿ä½¿ç”¨, äºæ˜¯å¯ä»¥å†™æˆå¦‚ä¸‹æ–¹å¼","text":"@Valueæ³¨å…¥å±æ€§å·¥ä½œä¸­ä¸€äº›å…¬å…±å±æ€§, ä¸€èˆ¬é€šè¿‡@Valueæ³¨å…¥çš„å¯¹è±¡çš„å±æ€§ä¸­, ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ @Configurationpublic class WeChatConfig &#123; /** * å¾®ä¿¡æ”¯ä»˜å‚æ•° */ @Value(&quot;$&#123;wx.appId&#125;&quot;) public String WX_APP_ID;&#125; é€šè¿‡@Valueæ³¨è§£, å°†é…ç½®æ–‡ä»¶ä¸­çš„å€¼æ³¨å…¥åˆ°å¯¹è±¡å±æ€§ä¸­, åœ¨ä½¿ç”¨æ—¶åªéœ€è¦æ³¨å…¥WeChatConfigå¯¹è±¡ç„¶åè°ƒç”¨å³å¯, è€Œå®é™…å·¥ä½œä¸­, å¾€å¾€ç”¨é™æ€å±æ€§, æ–¹ä¾¿ä½¿ç”¨, äºæ˜¯å¯ä»¥å†™æˆå¦‚ä¸‹æ–¹å¼ @Configurationpublic class WeChatConfig &#123; /** * å¾®ä¿¡æ”¯ä»˜å‚æ•° */ @Value(&quot;$&#123;wx.appId&#125;&quot;) public static String WX_APP_ID;&#125; ä½¿ç”¨æ­¤æ–¹å¼ä¸ä¼šæŠ¥é”™, ä½†æ˜¯å´å–ä¸åˆ°å±æ€§å€¼, å¹¶ä¸”ä¸ä¼šæŠ¥é”™. å˜é€šæ–¹å¼å¯ä»¥å¦‚ä¸‹: @Configurationpublic class WeChatConfig &#123; /** * å¾®ä¿¡æ”¯ä»˜å‚æ•° */ @Value(&quot;$&#123;wx.appId&#125;&quot;) public static String WX_APP_ID; @Value(&quot;$&#123;wx.app.id&#125;&quot;) private void setWxAppId(String wxAppId) &#123; WX_APP_ID = wxAppId; &#125;&#125; æ³¨æ„: æ­¤å¤„çš„ setæ–¹æ³•ä¸å¯ä»¥è®¾ç½®ä¸ºé™æ€, å¦åˆ™åŒæ ·ä¸èƒ½æ³¨å…¥å±æ€§","categories":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/categories/issue/"}],"tags":[{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/tags/issue/"}]},{"title":"ä½¿ç”¨æšä¸¾å®ç°å•ä¾‹","slug":"design-patterns/å•ä¾‹æ¨¡å¼-æšä¸¾å®ç°","date":"2018-08-17T12:05:10.000Z","updated":"2020-04-04T04:12:06.877Z","comments":true,"path":"2018/08/17/use-enumeration-to-implement-a-singleton.html","link":"","permalink":"https://liuzhihang.com/2018/08/17/use-enumeration-to-implement-a-singleton.html","excerpt":"ç®€ä»‹ä»‹ç»ä½¿ç”¨æšä¸¾çš„æ–¹å¼åˆ›å»ºå•ä¾‹, å…¶ä»–æ–¹å¼å¯ä»¥å‚è€ƒå•ä¾‹æ¨¡å¼","text":"ç®€ä»‹ä»‹ç»ä½¿ç”¨æšä¸¾çš„æ–¹å¼åˆ›å»ºå•ä¾‹, å…¶ä»–æ–¹å¼å¯ä»¥å‚è€ƒå•ä¾‹æ¨¡å¼ ä»£ç /** * ä½¿ç”¨æšä¸¾å•ä¾‹ * * @author liuzhihang * @date 2018/8/17 17:34 */public class SingletonPattern &#123; private SingletonPattern() &#123; &#125; public static SingletonPattern getInstance() &#123; return SingleEnum.INSTANCE.getSingletonPattern(); &#125; private enum SingleEnum &#123; /** * å•ä¾‹ */ INSTANCE; private SingletonPattern singletonPattern; SingleEnum() &#123; this.singletonPattern = new SingletonPattern(); &#125; public SingletonPattern getSingletonPattern() &#123; return singletonPattern; &#125; &#125;&#125; ä¼˜ç‚¹1.æ¯”åŒé‡é”æ£€æŸ¥ç›¸å¯¹ç®€æ´2.çº¿ç¨‹å®‰å…¨3.è‡ªåŠ¨å¤„ç†åºåˆ—åŒ–4.é˜²æ­¢åå°„","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://liuzhihang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://liuzhihang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"},{"name":"å•ä¾‹æ¨¡å¼","slug":"å•ä¾‹æ¨¡å¼","permalink":"https://liuzhihang.com/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"}]},{"title":"ElasticsearchåŸºæœ¬è¯­å¥","slug":"elk/es-query","date":"2018-06-26T13:30:29.000Z","updated":"2020-04-04T06:17:49.305Z","comments":true,"path":"2018/06/26/elasticsearch-basic-statement.html","link":"","permalink":"https://liuzhihang.com/2018/06/26/elasticsearch-basic-statement.html","excerpt":"æŸ¥çœ‹é›†ç¾¤1. æŸ¥çœ‹é›†ç¾¤å¥åº·curl -X GET &quot;localhost:9200/_cat/health?v&quot; 2. æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹curl -X GET &quot;localhost:9200/_cat/nodes?v&quot;","text":"æŸ¥çœ‹é›†ç¾¤1. æŸ¥çœ‹é›†ç¾¤å¥åº·curl -X GET &quot;localhost:9200/_cat/health?v&quot; 2. æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹curl -X GET &quot;localhost:9200/_cat/nodes?v&quot; 3. æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰ç´¢å¼•curl -X GET &quot;localhost:9200/_cat/indices?v&quot; get è·å–æŒ‡å®šæ•°æ®1. ç›´æ¥è·å–æ•°æ®curl -X GET &quot;localhost:9200/monitor_log_mch_order_out/logs/AWSudIFgTuj3oZBEhyxK?pretty&quot; æ ¼å¼ä¸º /{index}/{type}/{id} å­—æ®µ å«ä¹‰ monitor_log_mch_order_out ç´¢å¼• (_index) logs ç´¢å¼•çš„ç±»å‹ (_type), ä¸çŸ¥é“ç±»å‹å¯ä»¥ç”¨ _all åŒ¹é… AWSudIFgTuj3oZBEhyxK id (_id) pretty jsonæ ¼å¼æ˜¾ç¤ºæ•°æ®, å¯çœç•¥ 2. å±è”½æˆ–åªæŸ¥çœ‹ _sourcecurl -X GET &quot;localhost:9200/monitor_log_mch_order_out/logs/AWSudIFgTuj3oZBEhyxK?pretty&amp;_source=false&quot; æ·»åŠ  _source=false å³å¯ curl -X GET &quot;localhost:9200/monitor_log_mch_order_out/logs/AWSudIFgTuj3oZBEhyxK/_source?pretty&quot; 3. è¿‡æ»¤å­—æ®µcurl -X GET &quot;localhost:9200/monitor_log_mch_order_out/logs/AWSudIFgTuj3oZBEhyxK?pretty&amp;_source_include=log*&amp;_source_exclude=logType&quot; è·å–åŒ…å« log* ä¸”ä¸ä¸º logType çš„å­—æ®µ curl -X GET &quot;localhost:9200/monitor_log_mch_order_out/logs/AWSudIFgTuj3oZBEhyxK?pretty&amp;_source=logType,logLevel&quot; åªæŸ¥è¯¢æŒ‡å®šå­—æ®µçš„ç®€æ˜“å†™æ³• mget å¤šæ¡ä»¶åŒ¹é…æŸ¥è¯¢ åŒ¹é…å¤šä¸ªç´¢å¼•, åŒæ—¶æŸ¥è¯¢å¤šä¸ªidçš„æ•°æ® curl -X GET &quot;localhost:9200/_mget?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;&#123; &quot;docs&quot; : [ &#123; &quot;_index&quot; : &quot;monitor_log_mch_order_out&quot;, &quot;_type&quot; : &quot;logs&quot;, &quot;_id&quot; : &quot;AWSudIFgTuj3oZBEhyxK&quot; &#125;, &#123; &quot;_index&quot; : &quot;monitor_log_mch_order_out&quot;, &quot;_type&quot; : &quot;logs&quot;, &quot;_id&quot; : &quot;AWSuXewETuj3oZBEhywS&quot; &#125; ]&#125;&#x27; å¯ä»¥å°†ç´¢å¼•å†™åœ¨hoståé¢, ä»£è¡¨æŸ¥è¯¢çš„éƒ½ä¸ºåŒä¸€ç´¢å¼•ä¸‹çš„æ•°æ® curl -X GET &quot;localhost:9200/monitor_log_mch_order_out/_mget?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;&#123; &quot;docs&quot; : [ &#123; &quot;_type&quot; : &quot;logs&quot;, &quot;_id&quot; : &quot;AWSudIFgTuj3oZBEhyxK&quot; &#125;, &#123; &quot;_type&quot; : &quot;logs&quot;, &quot;_id&quot; : &quot;AWSuXewETuj3oZBEhywS&quot; &#125; ]&#125;&#x27; åˆå¹¶indexå’Œtype, ä»£è¡¨æŸ¥è¯¢çš„éƒ½ä¸ºåŒä¸€ç´¢å¼•ä¸‹typeä¹Ÿç›¸åŒçš„æ•°æ® curl -X GET &quot;localhost:9200/monitor_log_mch_order_out/logs/_mget?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;&#123; &quot;docs&quot; : [ &#123; &quot;_id&quot; : &quot;AWSudIFgTuj3oZBEhyxK&quot; &#125;, &#123; &quot;_id&quot; : &quot;AWSuXewETuj3oZBEhywS&quot; &#125; ]&#125;&#x27; ç®€åŒ–åå¦‚ä¸‹: curl -X GET &quot;localhost:9200/monitor_log_mch_order_out/logs/_mget?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;&#123; &quot;ids&quot; : [&quot;AWSudIFgTuj3oZBEhyxK&quot;, &quot;AWSuXewETuj3oZBEhywS&quot;]&#125;&#x27; æ³¨: å½“å¤šä¸ªæ¡ä»¶çš„ _type ç›¸åŒæ—¶ å¯ä»¥ä½¿ç”¨ _all æˆ–è€…çœç•¥ è¿‡æ»¤å­—æ®µ, æ¯ä¸ªIdåˆ†åˆ«å¯¹ _sourceè¿›è¡Œè¿‡æ»¤curl -X GET &quot;localhost:9200/monitor_log_mch_order_out/_mget?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;&#123; &quot;docs&quot; : [ &#123; &quot;_id&quot; : &quot;AWSudIFgTuj3oZBEhyxK&quot;, &quot;_source&quot; : false &#125;, &#123; &quot;_id&quot; : &quot;AWSuXewETuj3oZBEhywS&quot;, &quot;_source&quot; : [&quot;bizId&quot;, &quot;method&quot;] &#125;, &#123; &quot;_id&quot; : &quot;AWSuLAYqTuj3oZBEhysH&quot;, &quot;_source&quot; : &#123; &quot;include&quot;: [&quot;log*&quot;], &quot;exclude&quot;: [&quot;logLevel&quot;] &#125; &#125; ]&#125;&#x27; _search æœç´¢1. åŒ¹é…bizId æŸ¥è¯¢curl -X GET &quot;localhost:9200/monitor_log_mch_order_out/_search?pretty&amp;q=bizId:2009011201807190133430748068&quot; 2. åŒæ—¶æŒ‡å®šç±»å‹åŒæ—¶æŒ‡å®šç±»å‹, å¤šä¸ªç±»å‹ç”¨ â€˜,â€™ éš”å¼€, ä¹Ÿæ”¯æŒå¤šä¸ªç´¢å¼•å‹‡å£«æœç´¢, å¤šä¸ªç´¢å¼•ç”¨ â€˜,â€™ éš”å¼€, æˆ–è€…æ¨¡ç³Šæœç´¢ curl -X GET &quot;localhost:9200/monitor_log_mch_order_out/logs/_search?pretty&amp;q=bizId:2009011201807190133430748068&quot; 3. å ä½ç¬¦ _all åŒ¹é…æ‰€æœ‰ç´¢å¼•curl -X GET &quot;localhost:9200/_all/logs/_search?pretty&amp;q=bizId:2009011201807190133430748068&quot; 4. åŒ¹é…æ‰€æœ‰ç´¢å¼•æ‰€æœ‰ç±»å‹curl -X GET &quot;localhost:9200/_search?pretty&amp;q=bizId:2009011201807190133430748068&quot; æ³¨: q ä»£è¡¨æ˜ å°„query_string 5. è¯·æ±‚ä½“çš„æ–¹å¼curl -X GET &quot;localhost:9200/monitor_log_mch_order_out/logs/_search?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;&#123; &quot;query&quot; : &#123; &quot;term&quot; : &#123; &quot;bizId&quot; : &quot;2009011201807190133430748068&quot; &#125; &#125;&#125;&#x27; 6. åˆ†é¡µæŸ¥è¯¢ from/sizecurl -X GET &quot;localhost:9200/monitor_log_mch_order_out/logs/_search?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;&#123; &quot;from&quot; : 0, &quot;size&quot; : 1, &quot;query&quot; : &#123; &quot;term&quot; : &#123; &quot;bizId&quot; : &quot;2009011201807190133430748068&quot; &#125; &#125;&#125;&#x27; 7. æŸ¥è¯¢å¹¶è¿‡æ»¤å­—æ®µæ ¹æ®å­—æ®µæŸ¥è¯¢å¹¶ç­›é€‰æ‰æŒ‡å®šå­—æ®µ curl -X GET &quot;localhost:9200/_search?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;&#123; &quot;_source&quot;: &#123; &quot;includes&quot;: [ &quot;costTime&quot;, &quot;bizId&quot; ], &quot;excludes&quot;: [ &quot;logLevel&quot; ] &#125;, &quot;query&quot; : &#123; &quot;term&quot; : &#123; &quot;bizId&quot; : &quot;2009011201807190133430748068&quot; &#125; &#125;&#125;&#x27; èŒƒå›´æŸ¥è¯¢1. æŒ‰ç…§æ—¶é—´èŒƒå›´æŸ¥è¯¢å¯ä»¥çœç•¥ç´¢å¼•æŸ¥è¯¢å…¨éƒ¨ curl -X GET &quot;localhost:9200/monitor_log_mch_order_out/_search?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;&#123; &quot;query&quot;: &#123; &quot;range&quot; : &#123; &quot;time&quot; : &#123; &quot;gte&quot;: &quot;2018-07-19 00:14:25:000&quot;, &quot;lte&quot;: &quot;2018-07-19 00:14:30:000&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss:SSS&quot; &#125; &#125; &#125;&#125;&#x27;","categories":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/categories/ELK/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"logstashé…ç½®","slug":"elk/logstash-config","date":"2018-06-20T14:28:02.000Z","updated":"2020-04-04T06:18:05.805Z","comments":true,"path":"2018/06/20/logstash-configuration.html","link":"","permalink":"https://liuzhihang.com/2018/06/20/logstash-configuration.html","excerpt":"è¾“å…¥input &#123; beats &#123; port =&gt; &quot;5043&quot; &#125;&#125; é…ç½®æ—¥å¿—è¾“å…¥æ–¹å¼ä¸º filebeat, å¹¶é…ç½®ç«¯å£","text":"è¾“å…¥input &#123; beats &#123; port =&gt; &quot;5043&quot; &#125;&#125; é…ç½®æ—¥å¿—è¾“å…¥æ–¹å¼ä¸º filebeat, å¹¶é…ç½®ç«¯å£ è¿‡æ»¤filter &#123; grok &#123; match =&gt; &#123; &quot;message&quot; =&gt; &quot;\\[%&#123;DATA:time&#125;\\]-\\[%&#123;DATA:method&#125;\\] - \\[%&#123;DATA:catalina&#125;\\] -\\[%&#123;DATA:logLevel&#125;\\] - \\[%&#123;DATA:index_prefix&#125;\\|%&#123;WORD:logType&#125;\\|%&#123;WORD:sysNo&#125;\\|%&#123;WORD:objType&#125;\\|%&#123;DATA:funcode&#125;\\|%&#123;WORD:monitorObjNo&#125;\\|%&#123;WORD:bizId&#125;\\|%&#123;WORD:respCode&#125;\\|%&#123;DATA:respMsg&#125;\\|%&#123;WORD:costTime&#125;|%&#123;DATA:exField&#125;\\]&quot; &#125; &#125; grok&#123; match =&gt; &#123; &quot;time&quot; =&gt; [&quot;%&#123;INT:y_index&#125;-%&#123;INT:M_index&#125;-%&#123;INT:d_index&#125;&quot;]&#125; &#125; mutate &#123; add_field =&gt; &#123; &quot;[@metadata][index_suffix]&quot; =&gt; &quot;%&#123;y_index&#125;%&#123;M_index&#125;%&#123;d_index&#125;&quot; &#125; remove_field =&gt; [&quot;beat&quot;,&quot;host&quot;,&quot;thread&quot;,&quot;class&quot;,&quot;source&quot;,&quot;tags&quot;,&quot;type&quot;,&quot;y_index&quot;,&quot;M_index&quot;,&quot;d_index&quot;] lowercase =&gt; [ &quot;index_prefix&quot; ] lowercase =&gt; [ &quot;funcode&quot; ] lowercase =&gt; [ &quot;objType&quot; ] lowercase =&gt; [ &quot;monitorObjNo&quot; ] &#125;&#125; ä½¿ç”¨gorkè¿‡æ»¤å™¨å¯¹æ—¥å¿—è¿›è¡Œç­›é€‰, å¹¶å¯¹éƒ¨åˆ†å­—æ®µèµ‹å€¼. ä½¿ç”¨mutateæ’ä»¶å¯¹å­—æ®µè¿›è¡Œè½¬æ¢, add_field ä¸ºæ·»åŠ å­—æ®µ [@metadata][index_suffix] æ„æ€æ˜¯æ·»åŠ ä¸´æ—¶å­—æ®µ, è¯¥å­—æ®µä¸ä¼šè¾“å‡ºåˆ°esä¸­ è¾“å‡ºoutput &#123; if [logType] == &quot;info&quot; &#123; elasticsearch &#123; hosts =&gt; [ &quot;xxx.xxx.xxx.xxx:9200&quot; ] index =&gt; &quot;%&#123;index_prefix&#125;_%&#123;objType&#125;_%&#123;funcode&#125;_%&#123;[@metadata][index_suffix]&#125;&quot; user =&gt; elastic password =&gt; xxx &#125; &#125; if [logType] == &quot;error&quot; &#123; redis &#123; data_type =&gt; &quot;list&quot; db =&gt; 0 #key =&gt; &quot;%&#123;index_prefix&#125;_%&#123;sysNo&#125;_%&#123;objType&#125;_%&#123;funcode&#125;_%&#123;[@metadata][index_suffix]&#125;&quot; key =&gt; &quot;%&#123;index_prefix&#125;_%&#123;sysNo&#125;_%&#123;objType&#125;_%&#123;monitorObjNo&#125;&quot; host =&gt; &quot;xxx.xxx.xxx.xxx&quot; port =&gt; &quot;6379&quot; password =&gt; &quot;xxx&quot; &#125; &#125;&#125; å°†è¿‡æ»¤åçš„å­—æ®µæŒ‰ç…§ç±»å‹è¾“å‡ºåˆ°Esæˆ–è€…redisé˜Ÿåˆ—ä¸­ å¯åŠ¨å‘½ä»¤ ./bin/logstash -f first-pipelines.yml nohup ./logstash -f ../first-pipelines.yml &gt;/dev/null 2&gt;&amp;1 &amp; å…¶ä»–é…ç½®# è¾“å‡ºåˆ°æ§åˆ¶å°stdout &#123; codec =&gt; rubydebug &#125;","categories":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/categories/ELK/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"filebeaté…ç½®","slug":"elk/filebeat-config","date":"2018-06-20T13:30:29.000Z","updated":"2020-04-04T06:17:59.180Z","comments":true,"path":"2018/06/20/filebeat-configuration.html","link":"","permalink":"https://liuzhihang.com/2018/06/20/filebeat-configuration.html","excerpt":"","text":"filebeaté…ç½®filebeat.prospectors:- input_type: log#è¯»å–æ—¥å¿—çš„è·¯å¾„ paths: - /opt/export/log/info-xxx.log fields: log_type: &quot;monitor_log&quot; fields_under_root: true#è¿‡æ»¤éƒ¨åˆ†æ—¥å¿— include_lines: [&#x27;Monitor_log&#x27;]#----------------------------- Logstash output --------------------------------output.logstash: # The Logstash hosts hosts: [&quot;xxx.xxx.xxx.xxx:5043&quot;,&quot;xxx.xxx.xxx.xxx:5043&quot;] loadbalance: true#================================ Logging =====================================logging.level: infologging.to_files: truelogging.to_syslog: falselogging.files: path: /opt/export/app/filebeat/logs name: mybeat.log keepfiles: 5 è¿‡æ»¤ä¸åŒ…å«æŒ‡å®šå­—æ®µçš„æ—¥å¿—, å¹¶ä»…ä»…è¾“å‡ºåˆ°logstash, ä¹Ÿå¯ä»¥ç›´æ¥è¾“å‡ºåˆ°Elasticsearch å¯åŠ¨å‘½ä»¤ å‰å°å¯åŠ¨ï¼šå…³é—­çª—å£è¿æ¥åè‡ªåŠ¨é€€å‡º ./filebeat -e -c filebeat.yml åå°å¯åŠ¨: nohup ./filebeat -e -c filebeat.yml &gt;/dev/null 2&gt;&amp;1 &amp; å…³é—­: kill -9 xxxx","categories":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/categories/ELK/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"ç›‘æ§ç³»ç»Ÿæ¶æ„","slug":"elk/framework","date":"2018-06-20T12:25:29.000Z","updated":"2020-04-04T06:18:02.309Z","comments":true,"path":"2018/06/20/monitoring-system-architecture.html","link":"","permalink":"https://liuzhihang.com/2018/06/20/monitoring-system-architecture.html","excerpt":"ç›‘æ§ç³»ç»ŸåŸºæœ¬æ¡†æ¶","text":"ç›‘æ§ç³»ç»ŸåŸºæœ¬æ¡†æ¶ è§£é‡Š å„ä¸šåŠ¡ç³»ç»ŸæŒ‰ç…§æŒ‡å®šæ ¼å¼æ‰“å°æ—¥å¿— filebeatè‡ªåŠ¨è¯»å–æ—¥å¿—ä¿¡æ¯, å¹¶è¿›è¡Œè¿‡æ»¤, è¾“å‡ºåˆ°logstash logstashè¿›è¡ŒäºŒæ¬¡å¤„ç†, å°†æ—¥å¿—å†…å®¹æ ¼å¼åŒ–, å¹¶å°† infoæ—¥å¿—å’Œerroræ—¥å¿—åˆ†åˆ«å­˜æ”¾åˆ°Elasticsearchå’Œredisé˜Ÿåˆ—ä¸­ ç›‘æ§ç³»ç»Ÿå®šæ—¶ä»Eså’Œredisä¸­è·å–æ•°æ®, å­˜æ”¾åˆ°mysqlå¹¶è¿›è¡ŒæŠ¥è­¦åˆ†æ ä½¿ç”¨EChartå›¾å½¢åŒ–å±•ç¤ºä¿¡æ¯â€¦","categories":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/categories/ELK/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"}]},{"title":"çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ","slug":"concurrent/thread-life-cycle","date":"2018-06-15T11:31:00.000Z","updated":"2020-04-04T06:16:51.741Z","comments":true,"path":"2018/06/15/thread-life-cycle.html","link":"","permalink":"https://liuzhihang.com/2018/06/15/thread-life-cycle.html","excerpt":"çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ","text":"çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ å›¾è§£æ1.ä¸€èˆ¬æƒ…å†µä¸‹çº¿ç¨‹ä¸»è¦ç»å†: å‡†å¤‡, å°±ç»ª, è¿è¡Œ, æ­»äº¡å››ç§çŠ¶æ€.2.å‡†å¤‡:å³åˆ›å»ºçº¿ç¨‹, åŒ…æ‹¬é›†æˆThread, çº¿ç¨‹æ± , springæ–¹å¼ç­‰ç­‰3.å°±ç»ª:çº¿ç¨‹åˆ›å»ºå¹¶è°ƒç”¨start()æ–¹æ³•å¹¶ä¸ä»£è¡¨çº¿ç¨‹å°†ç«‹å³è·å¾—èµ„æº, è€Œæ˜¯è¿›å…¥åˆ°å°±ç»ªçŠ¶æ€è¿›è¡Œèµ„æºåˆ†é…4.è¿è¡Œ:æŠ¢å åˆ°èµ„æºçš„çº¿ç¨‹å°†æ‰§è¡Œ, æ‰§è¡Œè¿‡ç¨‹å¯èƒ½ä¼šå«æœ‰ä¸€äº›åˆ«çš„æ“ä½œ&emsp;1).çº¿ç¨‹ç­‰å¾…, ç›´åˆ°è°ƒç”¨ notify()æˆ–notifyAll()æ–¹æ³•è¢«å”¤é†’, è¿™é‡Œå”¤é†’åä¸ä¼šç«‹å³ç»§ç»­æ‰§è¡Œçº¿ç¨‹, è€Œæ˜¯è¿›å…¥å°±ç»ªçŠ¶æ€é‡æ–°æŠ¢å èµ„æº&emsp;2).çº¿ç¨‹ä¼‘çœ , ç›´åˆ°ä¼‘çœ æ—¶é—´ç»“æŸ, åŒæ ·ç»“æŸåä¸ä¼šç«‹å³ç»§ç»­æ‰§è¡Œçº¿ç¨‹, è€Œæ˜¯è¿›å…¥å°±ç»ªçŠ¶æ€é‡æ–°æŠ¢å èµ„æº&emsp;3).çº¿ç¨‹é˜»å¡, IOèµ„æºé˜»å¡, é”ç­‰æ–¹å¼ä½¿çº¿ç¨‹è¿›å…¥é˜»å¡é˜Ÿåˆ—, é‡Šæ”¾é”å°†ç»§ç»­æ‰§è¡Œ5.æ­»äº¡: è°ƒç”¨stop()æ–¹æ³•, çº¿ç¨‹ä¸­æ–­, æˆ–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åˆ™çº¿ç¨‹æ­»äº¡","categories":[{"name":"å¹¶å‘å’Œé”","slug":"å¹¶å‘å’Œé”","permalink":"https://liuzhihang.com/categories/%E5%B9%B6%E5%8F%91%E5%92%8C%E9%94%81/"}],"tags":[{"name":"å¤šçº¿ç¨‹","slug":"å¤šçº¿ç¨‹","permalink":"https://liuzhihang.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"}]},{"title":"synchronizedé”çš„ä»‹ç»","slug":"concurrent/synchronized-thread","date":"2018-06-13T12:25:00.000Z","updated":"2020-04-04T06:16:28.556Z","comments":true,"path":"2018/06/13/introduction-of-synchronized-lock.html","link":"","permalink":"https://liuzhihang.com/2018/06/13/introduction-of-synchronized-lock.html","excerpt":"synchronizedé”çš„ä½¿ç”¨synchronizedå¯ä»¥ä½¿ç”¨åœ¨æ–¹æ³•å’Œä»£ç å—ä¸­, ä½¿ç”¨çš„æ–¹å¼ä¸åŒé”ä»£è¡¨çš„å«ä¹‰ä¸åŒ, ä¸‹é¢å°†ä»å‡ ä¸ªæ–¹é¢è¿›è¡Œä»‹ç». æ™®é€šæ–¹æ³• é™æ€æ–¹æ³• ä»£ç å—synchronized(this) ä»£ç å—synchronized(*.class)","text":"synchronizedé”çš„ä½¿ç”¨synchronizedå¯ä»¥ä½¿ç”¨åœ¨æ–¹æ³•å’Œä»£ç å—ä¸­, ä½¿ç”¨çš„æ–¹å¼ä¸åŒé”ä»£è¡¨çš„å«ä¹‰ä¸åŒ, ä¸‹é¢å°†ä»å‡ ä¸ªæ–¹é¢è¿›è¡Œä»‹ç». æ™®é€šæ–¹æ³• é™æ€æ–¹æ³• ä»£ç å—synchronized(this) ä»£ç å—synchronized(*.class) ç»“è®º åœ¨ä½¿ç”¨synchronizedå…³é”®å­—ä¸­é”ä¸»è¦åˆ†ä¸ºä¸¤ç±», ä¸€ç§æ˜¯å¯¹è±¡é”, å¦ä¸€ç§ç±»é” æ™®é€šåŠ é”æ–¹æ³•å’Œsynchronized(this)éƒ½æ˜¯å¯¹è±¡é”, é™æ€åŠ é”æ–¹æ³•å’Œsynchronized(*.class)éƒ½æ˜¯ç±»é” å¯¹è±¡é”: åŒä¸€å¯¹è±¡æŒæœ‰é”, ç›¸åŒå¯¹è±¡ç­‰å¾…, å…¶ä»–å¯¹è±¡ä¸å—å½±å“; ä¸åŒå¯¹è±¡æŒæœ‰é”, äº’ä¸å½±å“. ç±»é”: ç±»é”æ—¶, åªè¦è¯¥ç±»çš„å¯¹è±¡æŒæœ‰é”, æ— è®ºæ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡è®¿é—®é™æ€åŒæ­¥æ–¹æ³•æ—¶éƒ½ç­‰å¾…, è®¿é—®éé™æ€åŒæ­¥æ–¹æ³•ä¸å—å½±å“. å¯¹è±¡é”å’Œç±»é”äº’ç›¸ä¸å½±å“ æµ‹è¯•ä»£ç åŠè¿‡ç¨‹package com.liuzhihang.tool.sync;/** * @author liuzhihang * @date 2018/7/11 16:25 */public class SyncMainTest &#123; public static void main(String[] args) &#123; SyncTest syncTest1 = new SyncTest(); // SyncTest syncTest2 = new SyncTest(); new Thread(() -&gt; syncTest1.methodA(), &quot;çº¿ç¨‹ 01 &quot;).start(); new Thread(() -&gt; syncTest1.methodB(), &quot;çº¿ç¨‹ 02 &quot;).start(); &#125;&#125;class SyncTest &#123; void methodA() &#123; System.out.println(Thread.currentThread().getName() + &quot;start&quot;); try &#123; System.out.println(Thread.currentThread().getName() + &quot;sleep&quot;); Thread.sleep(500); &#125; catch (InterruptedException e) &#123; &#125; System.out.println(Thread.currentThread().getName() + &quot;end&quot;); &#125; void methodB() &#123; System.out.println(Thread.currentThread().getName() + &quot;start&quot;); try &#123; System.out.println(Thread.currentThread().getName() + &quot;sleep&quot;); Thread.sleep(300); &#125; catch (InterruptedException e) &#123; &#125; System.out.println(Thread.currentThread().getName() + &quot;end&quot;); &#125;&#125; ä»¥ä¸Šä¸ºä¸€ä¸ªç®€å•çš„æµ‹è¯•ä»£ç , æŒ‡ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è°ƒç”¨ä¸¤ä¸ªæ–¹æ³•, é€šè¿‡æ‰“å°ç»“æœå¯ä»¥çœ‹å‡ºé¡ºåºæ˜¯ä¹±åºçš„, å…¶ä¸­çº¿ç¨‹çš„ start() é¡ºåºå¹¶ä¸ä»£è¡¨çº¿ç¨‹çš„æ‰§è¡Œé¡ºåº, åœ¨ä¸‹é¢æµ‹è¯•ä¸­å‡è®¾æ˜¯ â€œçº¿ç¨‹01â€ å…ˆæ‰§è¡Œ. 1.A B æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­— + åŒä¸€å¯¹è±¡class SyncTest &#123; synchronized void methodA() &#123; // ... &#125; synchronized void methodB() &#123; // ... &#125;&#125; ç»“è®º: æ–¹æ³• A é˜»å¡, æ–¹æ³• B ç­‰å¾… A æ‰§è¡Œå®Œæ¯•åæ‰ç»§ç»­æ‰§è¡Œ. 2.A B æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­— + ä¸åŒå¯¹è±¡public class SyncMainTest &#123; public static void main(String[] args) &#123; SyncTest syncTest1 = new SyncTest(); SyncTest syncTest2 = new SyncTest(); new Thread(() -&gt; syncTest1.methodA(), &quot;çº¿ç¨‹ 01 &quot;).start(); new Thread(() -&gt; syncTest2.methodB(), &quot;çº¿ç¨‹ 02 &quot;).start(); &#125;&#125;class SyncTest &#123; synchronized void methodA() &#123; // ... &#125; synchronized void methodB() &#123; // ... &#125;&#125; ç»“è®º: æ–¹æ³• A é˜»å¡, æ–¹æ³• B ä¸å—å½±å“. 3.A æ–¹æ³•åˆ†åˆ«æ·»åŠ synchronizedå…³é”®å­— Bæ–¹æ³•ä¸æ·»åŠ class SyncTest &#123; synchronized void methodA() &#123; // ... &#125; void methodB() &#123; // ... &#125;&#125; ç»“è®º: æ–¹æ³• A é˜»å¡, æ–¹æ³• B ä¸å—å½±å“. 4.A B æ–¹æ³•åˆ†åˆ«æ·»åŠ  static synchronized + ä¸åŒå¯¹è±¡public class SyncMainTest &#123; public static void main(String[] args) &#123; SyncTest syncTest1 = new SyncTest(); SyncTest syncTest2 = new SyncTest(); new Thread(() -&gt; syncTest1.methodA(), &quot;çº¿ç¨‹ 01 &quot;).start(); new Thread(() -&gt; syncTest2.methodB(), &quot;çº¿ç¨‹ 02 &quot;).start(); &#125;&#125;class SyncTest &#123; static synchronized void methodA() &#123; // ... &#125; static synchronized void methodB() &#123; // ... &#125;&#125; ç»“è®º: æ–¹æ³• A é˜»å¡, æ–¹æ³• B ç­‰å¾… Aç»“æŸåç»§ç»­æ‰§è¡Œ. 5.A æ–¹æ³•æ·»åŠ  static synchronized, B æ–¹æ³•æ·»åŠ  synchronized + ä¸åŒå¯¹è±¡public class SyncMainTest &#123; public static void main(String[] args) &#123; SyncTest syncTest1 = new SyncTest(); SyncTest syncTest2 = new SyncTest(); new Thread(() -&gt; syncTest1.methodA(), &quot;çº¿ç¨‹ 01 &quot;).start(); new Thread(() -&gt; syncTest2.methodB(), &quot;çº¿ç¨‹ 02 &quot;).start(); &#125;&#125;class SyncTest &#123; static synchronized void methodA() &#123; // ... &#125; synchronized void methodB() &#123; // ... &#125;&#125; ç»“è®º: æ–¹æ³• A é˜»å¡, æ–¹æ³• B ä¸å—å½±å“. 6.A B æ–¹æ³•å†…æ·»åŠ  synchronized(this)class SyncTest &#123; void methodA() &#123; synchronized (this) &#123; // ... &#125; &#125; void methodB() &#123; synchronized (this) &#123; // ... &#125; &#125;&#125; ç»“è®º: åŒä¸€å¯¹è±¡ A é˜»å¡ Bç­‰å¾…, ä¸åŒå¯¹è±¡ Aé˜»å¡ Bä¸å—å½±å“ 7.A B æ–¹æ³•å†…æ·»åŠ  synchronized(SyncTest.class)class SyncTest &#123; void methodA() &#123; synchronized (SyncTest.class) &#123; // ... &#125; &#125; void methodB() &#123; synchronized (SyncTest.class) &#123; // ... &#125; &#125;&#125; ç»“è®º: åŒä¸€/ä¸åŒå¯¹è±¡ A é˜»å¡ Bç­‰å¾… 8.A æ–¹æ³•å†…æ·»åŠ  synchronized(SyncTest.class), B æ–¹æ³•å†…æ·»åŠ  synchronized(this)class SyncTest &#123; void methodA() &#123; synchronized (SyncTest.class) &#123; // ... &#125; &#125; void methodB() &#123; synchronized (this) &#123; // ... &#125; &#125;&#125; ç»“è®º: åŒä¸€/ä¸åŒå¯¹è±¡ A é˜»å¡ Bä¸å—å½±å“ 9.A æ–¹æ³•å†…æ·»åŠ  synchronized(SyncTest.class), B æ–¹æ³•å†…æ·»åŠ  synchronized(OtherObj)class SyncTest &#123; private String string = &quot;lock&quot;; void methodA() &#123; synchronized (SyncTest.class) &#123; // ... &#125; &#125; void methodB() &#123; synchronized (string) &#123; // ... &#125; &#125;&#125; ç»“è®º: åŒä¸€/ä¸åŒå¯¹è±¡ A é˜»å¡ Bä¸å—å½±å“","categories":[{"name":"å¹¶å‘å’Œé”","slug":"å¹¶å‘å’Œé”","permalink":"https://liuzhihang.com/categories/%E5%B9%B6%E5%8F%91%E5%92%8C%E9%94%81/"}],"tags":[{"name":"å¤šçº¿ç¨‹","slug":"å¤šçº¿ç¨‹","permalink":"https://liuzhihang.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"}]},{"title":"synchronizedåŒæ­¥é”åŸç†","slug":"concurrent/synchronized","date":"2018-06-11T12:25:29.000Z","updated":"2020-04-04T06:16:09.670Z","comments":true,"path":"2018/06/11/synchronized-synchronous-lock-principle.html","link":"","permalink":"https://liuzhihang.com/2018/06/11/synchronized-synchronous-lock-principle.html","excerpt":"ä»‹ç» åœ¨å¤šçº¿ç¨‹æ“ä½œä¸­volatileå…³é”®å­—å¯ä»¥ä¿è¯å…±äº«å˜é‡çš„å†…å­˜å¯è§æ€§, ä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯æ“ä½œçš„åŸå­æ€§, è¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°é”, synchronizedåŒæ­¥é”æ˜¯javaå…³é”®å­—, æ˜¯å†…ç½®çš„è¯­è¨€å®ç°. synchronizedåŠ é”å’Œçº¿ç¨‹ç»“æŸæˆ–å¼‚å¸¸é”çš„é‡Šæ”¾è¿‡ç¨‹ç”±JVMè¿›è¡Œæ§åˆ¶ synchronizedå…³é”®å­—å¯ä»¥ä½¿ç”¨åœ¨æ–¹æ³•å’ŒåŒæ­¥ä»£ç å—ä¸­, ä¸åŒçš„ä½¿ç”¨æ–¹å¼, é”çš„ç»“æœæ˜¯ä¸åŒçš„ é‡é‡çº§é” + å¯é‡å…¥","text":"ä»‹ç» åœ¨å¤šçº¿ç¨‹æ“ä½œä¸­volatileå…³é”®å­—å¯ä»¥ä¿è¯å…±äº«å˜é‡çš„å†…å­˜å¯è§æ€§, ä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯æ“ä½œçš„åŸå­æ€§, è¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°é”, synchronizedåŒæ­¥é”æ˜¯javaå…³é”®å­—, æ˜¯å†…ç½®çš„è¯­è¨€å®ç°. synchronizedåŠ é”å’Œçº¿ç¨‹ç»“æŸæˆ–å¼‚å¸¸é”çš„é‡Šæ”¾è¿‡ç¨‹ç”±JVMè¿›è¡Œæ§åˆ¶ synchronizedå…³é”®å­—å¯ä»¥ä½¿ç”¨åœ¨æ–¹æ³•å’ŒåŒæ­¥ä»£ç å—ä¸­, ä¸åŒçš„ä½¿ç”¨æ–¹å¼, é”çš„ç»“æœæ˜¯ä¸åŒçš„ é‡é‡çº§é” + å¯é‡å…¥ synchronizedåº•å±‚åŸç†1.ä»£ç ç¤ºä¾‹ package com.liuzhihang.tool.java;/** * @author liuzhihang * @date 2018/06/11 16:05 */public class SynchronizedTest &#123; private int i; private int j; public void syncTest1() &#123; synchronized (this) &#123; i++; &#125; &#125; public synchronized void syncTest2() &#123; j++; &#125;&#125; 2.ä½¿ç”¨ javap -v SynchronizedTest.class æŸ¥çœ‹ä»£ç çš„å¯¹åº”å­—èŠ‚ç å¦‚ä¸‹: $ javap -v SynchronizedTest.classClassfile &#x2F;C:&#x2F;Users&#x2F;liuzhihang&#x2F;Desktop&#x2F;SynchronizedTest.class Last modified 2018-7-10; size 518 bytes MD5 checksum ba48def77b226e7b9ac28121ec423c16 Compiled from &quot;SynchronizedTest.java&quot;public class com.liuzhihang.tool.java.SynchronizedTest minor version: 0 major version: 52 flags: ACC_PUBLIC, ACC_SUPERConstant pool: &#x2F;&#x2F; å¸¸é‡æ± çœç•¥&#123; &#x2F;&#x2F; æ„é€ æ–¹æ³•çœç•¥ public void syncTest1(); descriptor: ()V flags: ACC_PUBLIC Code: stack&#x3D;3, locals&#x3D;3, args_size&#x3D;1 0: aload_0 1: dup 2: astore_1 3: monitorenter 4: aload_0 5: dup 6: getfield #2 &#x2F;&#x2F; Field i:I 9: iconst_1 10: iadd 11: putfield #2 &#x2F;&#x2F; Field i:I 14: aload_1 15: monitorexit 16: goto 24 19: astore_2 20: aload_1 21: monitorexit 22: aload_2 23: athrow 24: return Exception table: &#x2F;&#x2F; çœç•¥ä»£ç  public synchronized void syncTest2(); descriptor: ()V flags: ACC_PUBLIC, ACC_SYNCHRONIZED Code: stack&#x3D;3, locals&#x3D;1, args_size&#x3D;1 0: aload_0 1: dup 2: getfield #3 &#x2F;&#x2F; Field j:I 5: iconst_1 6: iadd 7: putfield #3 &#x2F;&#x2F; Field j:I 10: return LineNumberTable: line 22: 0 line 23: 10&#125;SourceFile: &quot;SynchronizedTest.java&quot; 3.ç»“è®º åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ monitorenter å’Œ monitorexit æŒ‡ä»¤, å…¶ä¸­æœ‰ä¸¤ä¸ª monitorexit å› ä¸ºä¸èƒ½ç¡®ä¿æ˜¯æ­£å¸¸ç»“æŸè¿˜æ˜¯å¼‚å¸¸ç»“æŸ, æ‰€ä»¥å¦ä¸€ä¸ªæ˜¯ç”¨æ¥ç¡®ä¿å¼‚å¸¸ç»“æŸæ—¶é‡Šæ”¾ monitoræŒ‡ä»¤. åŒæ­¥æ–¹æ³•æ—¶ä½¿ç”¨çš„æ˜¯ flagsä¸­çš„ ACC_SYNCHRONIZED æ¥æ ‡è¯†è¯¥æ–¹æ³•ä¸ºåŒæ­¥æ–¹æ³•, JVMåœ¨è°ƒç”¨è¯¥æ–¹æ³•æ—¶ä¾¿ä¼šæ‰§è¡Œç›¸åº”çš„åŒæ­¥è°ƒç”¨. æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤è‡ªå·±çš„ç›‘è§†å™¨(monitor), åªè¦æ˜¯åŒæ­¥è°ƒç”¨è¿›è¡Œç›¸å…³æ“ä½œæ—¶è¦å…ˆè·å¾— monitor, å¦åˆ™å°†è¢«é˜»å¡","categories":[{"name":"å¹¶å‘å’Œé”","slug":"å¹¶å‘å’Œé”","permalink":"https://liuzhihang.com/categories/%E5%B9%B6%E5%8F%91%E5%92%8C%E9%94%81/"}],"tags":[{"name":"å¤šçº¿ç¨‹","slug":"å¤šçº¿ç¨‹","permalink":"https://liuzhihang.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"}]},{"title":"volatileå…³é”®å­—","slug":"concurrent/volatile","date":"2018-06-09T14:31:29.000Z","updated":"2020-04-04T06:49:14.260Z","comments":true,"path":"2018/06/09/volatile-keyword.html","link":"","permalink":"https://liuzhihang.com/2018/06/09/volatile-keyword.html","excerpt":"ä»‹ç»åœ¨å¤šçº¿ç¨‹æ“ä½œå…±äº«å˜é‡æ—¶, ä¼šä½¿ç”¨volatileä¿®é¥°å…±äº«å˜é‡, æ¯”å¦‚å•ä¾‹æ¨¡å¼çš„åŒé‡é”æ£€æŸ¥ä¸­, å¹¶ä¸”åœ¨concurrentåŒ…ä¸‹ä¹Ÿå¤§é‡ä½¿ç”¨äº†volatileå…³é”®å­—;volatileå¯ä»¥å¯¹ç±»å±æ€§è¿›è¡Œä¿®é¥°, ä»è€Œç¡®ä¿çº¿ç¨‹æ¯æ¬¡éƒ½æ˜¯ä»ä¸»å­˜ä¸­è·å–å±æ€§, æ“ä½œå®Œæ¯•åå†™å›ä¸»å­˜.","text":"ä»‹ç»åœ¨å¤šçº¿ç¨‹æ“ä½œå…±äº«å˜é‡æ—¶, ä¼šä½¿ç”¨volatileä¿®é¥°å…±äº«å˜é‡, æ¯”å¦‚å•ä¾‹æ¨¡å¼çš„åŒé‡é”æ£€æŸ¥ä¸­, å¹¶ä¸”åœ¨concurrentåŒ…ä¸‹ä¹Ÿå¤§é‡ä½¿ç”¨äº†volatileå…³é”®å­—;volatileå¯ä»¥å¯¹ç±»å±æ€§è¿›è¡Œä¿®é¥°, ä»è€Œç¡®ä¿çº¿ç¨‹æ¯æ¬¡éƒ½æ˜¯ä»ä¸»å­˜ä¸­è·å–å±æ€§, æ“ä½œå®Œæ¯•åå†™å›ä¸»å­˜. javaå†…å­˜æ¨¡å‹ åœ¨å¤šçº¿ç¨‹åŒæ—¶å¯¹å…±äº«å˜é‡è¿›è¡Œæ“ä½œè¿‡ç¨‹ä¸­, æ¯ä¸ªçº¿ç¨‹ä¼šæ‹·è´ä¸€ä»½å…±äº«å˜é‡åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­è¿›è¡Œç›¸å…³æ“ä½œ, æ“ä½œå®Œæ¯•åä¼šå°†ç»“æœå†™å…¥åˆ°ä¸»å­˜ä¸­. è€Œvolatileå…³é”®å­—å¯ä»¥ä¿è¯æ“ä½œçš„å¯è§æ€§å’Œæœ‰åºæ€§, ä½†æ˜¯å´ä¸èƒ½ä¿è¯åŸå­æ€§. æ‰©å±•åŸå­æ€§æŒ‡ä¸€ä¸ªæ“ä½œæˆ–è€…å¤šä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œè¦ä¹ˆå…¨éƒ¨éƒ½ä¸æ‰§è¡Œ, æ“ä½œè¿‡ç¨‹æ•´ä½“æ˜¯ä¸€ä¸ªåŸå­, ä¸è¢«åˆ†å‰²æ‰“æ–­. å¯è§æ€§å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶, ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼, å…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼. æœ‰åºæ€§å³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œä¸»è¦åŸå› æ˜¯å› ä¸ºå¤„ç†å™¨åœ¨å¤„ç†ç¨‹åºæ—¶ä¼šè¿›è¡ŒæŒ‡ä»¤é‡æ’, å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–, æŒ‡ä»¤é‡æ’åœ¨å•çº¿ç¨‹ä¸­å¾—åˆ°çš„ç»“æœæ˜¯ä¸€è‡´çš„, ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸­å°±ä¼šé€ æˆå„ç§é”™è¯¯. volatileå…³é”®å­—ä½œç”¨1.ä½¿ç”¨volatileå…³é”®å­—ä¿®é¥°çš„å˜é‡,ä¼šå¼ºåˆ¶å°†ä¿®æ”¹çš„å€¼å†™å…¥åˆ°ä¸»å­˜ä¸­2.volatileä¸ä¿è¯åŸå­æ€§, åœ¨å¤šçº¿ç¨‹æ“ä½œä¸‹ä»…èƒ½ä¿è¯æ“ä½œåˆ«çš„çº¿ç¨‹å¯è§, åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹åŒæ—¶æ“ä½œå…±äº«å˜é‡ä¾ç„¶ä¼šæœ‰æ•°æ®ä¸æ­£ç¡®çš„æƒ…å†µ.3.volatileä¼šé˜²æ­¢æŒ‡ä»¤é‡æ’","categories":[{"name":"å¹¶å‘å’Œé”","slug":"å¹¶å‘å’Œé”","permalink":"https://liuzhihang.com/categories/%E5%B9%B6%E5%8F%91%E5%92%8C%E9%94%81/"}],"tags":[{"name":"volatile","slug":"volatile","permalink":"https://liuzhihang.com/tags/volatile/"}]},{"title":"SpringAopä»£ç†çš„é€‰æ‹©","slug":"spring/springAop","date":"2018-05-21T06:50:13.000Z","updated":"2020-04-04T04:12:06.927Z","comments":true,"path":"2018/05/21/springaop-agent-selection.html","link":"","permalink":"https://liuzhihang.com/2018/05/21/springaop-agent-selection.html","excerpt":"ä»‹ç»SpringåŠ¨æ€åˆ›å»ºbeanè¿‡ç¨‹, æ˜¯å¦‚ä½•è¿›è¡Œé€‰æ‹©ä½¿ç”¨ jdkè¿˜æ˜¯cglibè¿›è¡Œä»£ç†çš„, å¯ä»¥é€šè¿‡æºç è¿›è¡Œè§£æ æ‰§è¡Œè¿‡ç¨‹é€šè¿‡æ–­ç‚¹è¿›è¡Œè·Ÿè¸ªä¸»è¦æ‰§è¡Œè¿‡ç¨‹åœ¨ DefaultAopProxyFactory, é€šè¿‡åˆ¤æ–­æ¡ä»¶æ˜¯ä½¿ç”¨Cglibè¿˜æ˜¯Jdk","text":"ä»‹ç»SpringåŠ¨æ€åˆ›å»ºbeanè¿‡ç¨‹, æ˜¯å¦‚ä½•è¿›è¡Œé€‰æ‹©ä½¿ç”¨ jdkè¿˜æ˜¯cglibè¿›è¡Œä»£ç†çš„, å¯ä»¥é€šè¿‡æºç è¿›è¡Œè§£æ æ‰§è¡Œè¿‡ç¨‹é€šè¿‡æ–­ç‚¹è¿›è¡Œè·Ÿè¸ªä¸»è¦æ‰§è¡Œè¿‡ç¨‹åœ¨ DefaultAopProxyFactory, é€šè¿‡åˆ¤æ–­æ¡ä»¶æ˜¯ä½¿ç”¨Cglibè¿˜æ˜¯Jdk ç›¸å…³æºç è§£æpublic class DefaultAopProxyFactory implements AopProxyFactory, Serializable &#123; @Override public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException &#123; //åˆ¤æ–­æ¡ä»¶ æ˜¯å¦ä¼˜åŒ–, è¿”å›æ˜¯å¦ç›´æ¥ä»£ç†ç›®æ ‡ç±»ä»¥åŠä»»ä½•æ¥å£æˆ–è€…æ²¡æœ‰ç”¨æˆ·æä¾›çš„ä»£ç†æ¥å£ if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123; Class&lt;?&gt; targetClass = config.getTargetClass(); if (targetClass == null) &#123; throw new AopConfigException(&quot;TargetSource cannot determine target class: &quot; + &quot;Either an interface or a target is required for proxy creation.&quot;); &#125; //åˆ¤æ–­æ˜¯å¦æ˜¯æ¥å£, å’Œå·²ç»ä½¿ç”¨jdkä»£ç† if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123; return new JdkDynamicAopProxy(config); &#125; return new ObjenesisCglibAopProxy(config); &#125; else &#123; return new JdkDynamicAopProxy(config); &#125; &#125; /** * Determine whether the supplied &#123;@link AdvisedSupport&#125; has only the * &#123;@link org.springframework.aop.SpringProxy&#125; interface specified * (or no proxy interfaces specified at all). */ private boolean hasNoUserSuppliedProxyInterfaces(AdvisedSupport config) &#123; Class&lt;?&gt;[] ifcs = config.getProxiedInterfaces(); return (ifcs.length == 0 || (ifcs.length == 1 &amp;&amp; SpringProxy.class.isAssignableFrom(ifcs[0]))); &#125;&#125;","categories":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"aop","slug":"aop","permalink":"https://liuzhihang.com/tags/aop/"}]},{"title":"cglibåŠ¨æ€ä»£ç†","slug":"spring/CglibProxy","date":"2018-05-18T11:55:01.000Z","updated":"2020-04-04T06:26:10.822Z","comments":true,"path":"2018/05/18/cglib-dynamic-proxy.html","link":"","permalink":"https://liuzhihang.com/2018/05/18/cglib-dynamic-proxy.html","excerpt":"ä»‹ç»SpringåŠ¨æ€ä»£ç†å¯ä»¥é€‰æ‹©ä½¿ç”¨jdkåŠ¨æ€ä»£ç†, æˆ–è€…cglibåŠ¨æ€ä»£ç†, cglibåŠ¨æ€ä»£ç†ä½äº net.sf.cglib.proxy åŒ…ä¸‹. ä½¿ç”¨æ—¶æ¶‰åŠæ¥å£: net.sf.cglib.proxy.MethodInterceptorç”¨æ¥ç”ŸæˆåŠ¨æ€å­ç±»çš„ç±»ç±»: net.sf.cglib.proxy.Enhancer æ³¨æ„: cglib åŠ¨æ€ä»£ç†æ˜¯åŸºäºç±»çš„ä»£ç†, æ˜¯é€šè¿‡å¯¹æŒ‡å®šçš„ä¸šåŠ¡ç±»ç”Ÿæˆä¸€ä¸ªå­ç±», å¹¶è¦†ç›–å…¶ä¸­ä¸šåŠ¡æ–¹æ³•å®ç°ä»£ç†. å› ä¸ºä½¿ç”¨ç»§æ‰¿, æ‰€ä»¥è¢«ä»£ç†ç±»ä¸èƒ½ä½¿ final ä¿®é¥°","text":"ä»‹ç»SpringåŠ¨æ€ä»£ç†å¯ä»¥é€‰æ‹©ä½¿ç”¨jdkåŠ¨æ€ä»£ç†, æˆ–è€…cglibåŠ¨æ€ä»£ç†, cglibåŠ¨æ€ä»£ç†ä½äº net.sf.cglib.proxy åŒ…ä¸‹. ä½¿ç”¨æ—¶æ¶‰åŠæ¥å£: net.sf.cglib.proxy.MethodInterceptorç”¨æ¥ç”ŸæˆåŠ¨æ€å­ç±»çš„ç±»ç±»: net.sf.cglib.proxy.Enhancer æ³¨æ„: cglib åŠ¨æ€ä»£ç†æ˜¯åŸºäºç±»çš„ä»£ç†, æ˜¯é€šè¿‡å¯¹æŒ‡å®šçš„ä¸šåŠ¡ç±»ç”Ÿæˆä¸€ä¸ªå­ç±», å¹¶è¦†ç›–å…¶ä¸­ä¸šåŠ¡æ–¹æ³•å®ç°ä»£ç†. å› ä¸ºä½¿ç”¨ç»§æ‰¿, æ‰€ä»¥è¢«ä»£ç†ç±»ä¸èƒ½ä½¿ final ä¿®é¥° ä½¿ç”¨æ­¥éª¤1.åˆ›å»ºMethodInterceptoræ¥å£çš„å®ç°ç±», å¹¶ç¼–å†™interceptæ–¹æ³•çš„å®ç°2.é€šè¿‡methodProxy.invokeSuper(o, objects);è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•3.åˆ›å»ºEnhancer, é€šè¿‡ setSuperclass(Class superclass)æ–¹æ³•æŒ‡å®šçˆ¶ç±»(è¢«ä»£ç†ç±»), é€šè¿‡ setCallback(final Callback callback)æ–¹æ³•æŒ‡å®šä»£ç†4.enhancer.create() ç”Ÿæˆä»£ç†, è°ƒç”¨è¢«ä»£ç†ç±»çš„æ–¹æ³• ä»£ç æ¼”ç¤ºæŒ‰ç…§æ­¥éª¤ç¼–å†™ç®€æ˜“é€»è¾‘ä»£ç . åˆ›å»ºMethodInterceptoræ¥å£çš„å®ç°ç±»/** * åŸºäºç±»çš„ä»£ç† å³ä½¿ç±»æ²¡æœ‰å®ç°æ¥å£ä¹Ÿå¯ä»¥è¢«ä»£ç† * ä¸»è¦æ˜¯åŸºäºç±»ç”Ÿæˆä¸€ä¸ªç»§æ‰¿çš„å­ç±» æ‰€ä»¥ ç±»å’Œæ–¹æ³•ä¸è¦å£°æ˜ä¸º final * * * @author liuzhihang * @date 2018/5/18 10:10 */public class MyMethodInterceptor implements MethodInterceptor &#123; @Override public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123; System.out.println(&quot;cglibåŠ¨æ€ä»£ç† before . . .&quot;); Object invoke = null; try &#123; invoke = methodProxy.invokeSuper(o, objects); &#125; catch (Throwable throwable) &#123; throwable.printStackTrace(); System.err.println(&quot;cglibåŠ¨æ€ä»£ç† error: &quot; + throwable.getMessage()); &#125; finally &#123; System.out.println(&quot;cglibåŠ¨æ€ä»£ç† after . . .&quot;); &#125; return invoke; &#125;&#125; åˆ›å»ºEnhanceråˆ›å»ºEnhancer, é€šè¿‡ setSuperclass(Class superclass)æ–¹æ³•æŒ‡å®šçˆ¶ç±»(è¢«ä»£ç†ç±»), é€šè¿‡ setCallback(final Callback callback)æ–¹æ³•æŒ‡å®šä»£ç† public class CglibMainTest &#123; public static void main(String[] args) &#123; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(SubjectCglib.class); enhancer.setCallback(new MyMethodInterceptor()); SubjectCglib subjectCglib = (SubjectCglib) enhancer.create(); System.err.println(subjectCglib.getAge(&quot;liuzhihang&quot;)); &#125;&#125; å¯ä»¥å°†äºŒè€…åˆå¹¶åˆ°MyInterceptorä¸­/** * åŸºäºç±»çš„ä»£ç† å³ä½¿ç±»æ²¡æœ‰å®ç°æ¥å£ä¹Ÿå¯ä»¥è¢«ä»£ç† * * * @author liuzhihang * @date 2018/5/18 10:10 */public class MyCglibInterceptor implements MethodInterceptor &#123; private Object object; public Object getInstance(Object object) &#123; this.object = object; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(object.getClass()); enhancer.setCallback(this); return enhancer.create(); &#125; @Override public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123; System.out.println(&quot;cglibåŠ¨æ€ä»£ç† before . . .&quot;); Object invoke = null; try &#123; invoke = methodProxy.invokeSuper(o, objects); &#125; catch (Throwable throwable) &#123; throwable.printStackTrace(); System.err.println(&quot;cglibåŠ¨æ€ä»£ç† error: &quot; + throwable.getMessage()); &#125; finally &#123; System.out.println(&quot;cglibåŠ¨æ€ä»£ç† after . . .&quot;); &#125; return invoke; &#125;&#125;","categories":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"åŠ¨æ€ä»£ç†","slug":"åŠ¨æ€ä»£ç†","permalink":"https://liuzhihang.com/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"}]},{"title":"jdkåŠ¨æ€ä»£ç†åŠæºç è§£æ","slug":"spring/JDKProxy","date":"2018-05-17T11:55:01.000Z","updated":"2020-04-04T06:27:13.047Z","comments":true,"path":"2018/05/17/jdk-dynamic-proxy-and-source-code-analysis.html","link":"","permalink":"https://liuzhihang.com/2018/05/17/jdk-dynamic-proxy-and-source-code-analysis.html","excerpt":"ä»‹ç»SpringåŠ¨æ€ä»£ç†å¯ä»¥é€‰æ‹©ä½¿ç”¨jdkåŠ¨æ€ä»£ç†, æˆ–è€…cglibåŠ¨æ€ä»£ç†, jdkåŠ¨æ€ä»£ç†ä½äº java.lang.reflect åŒ…ä¸‹. ä½¿ç”¨æ—¶æ¶‰åŠæ¥å£: java.lang.reflect.InvocationHandleråŠ¨æ€ä»£ç†ç±»: java.lang.reflect.Proxy æ³¨æ„: JDK åŠ¨æ€ä»£ç†æ˜¯åŸºäºæ¥å£çš„ä»£ç†, åªèƒ½å¯¹å®ç°æ¥å£çš„ç±»ç”Ÿæˆä»£ç†, ä¸èƒ½å¯¹ç±»è¿›è¡Œä»£ç†","text":"ä»‹ç»SpringåŠ¨æ€ä»£ç†å¯ä»¥é€‰æ‹©ä½¿ç”¨jdkåŠ¨æ€ä»£ç†, æˆ–è€…cglibåŠ¨æ€ä»£ç†, jdkåŠ¨æ€ä»£ç†ä½äº java.lang.reflect åŒ…ä¸‹. ä½¿ç”¨æ—¶æ¶‰åŠæ¥å£: java.lang.reflect.InvocationHandleråŠ¨æ€ä»£ç†ç±»: java.lang.reflect.Proxy æ³¨æ„: JDK åŠ¨æ€ä»£ç†æ˜¯åŸºäºæ¥å£çš„ä»£ç†, åªèƒ½å¯¹å®ç°æ¥å£çš„ç±»ç”Ÿæˆä»£ç†, ä¸èƒ½å¯¹ç±»è¿›è¡Œä»£ç† ä½¿ç”¨æ­¥éª¤1.åˆ›å»ºInvocationHandleræ¥å£çš„å®ç°ç±», å¹¶ç¼–å†™invokeæ–¹æ³•çš„å®ç°2.åˆ›å»ºè¢«ä»£ç†ç±»çš„æ¥å£åŠå®ç°ç±»3.ä½¿ç”¨åŠ¨æ€ä»£ç†ç±»Proxyçš„é™æ€æ–¹æ³•ç”Ÿæˆä»£ç†ç±»å®ä¾‹4.ä½¿ç”¨å®ä¾‹è°ƒç”¨æ–¹æ³• ä»£ç æ¼”ç¤ºæŒ‰ç…§æ­¥éª¤ç¼–å†™ç®€æ˜“é€»è¾‘ä»£ç . åˆ›å»ºInvocationHandleræ¥å£çš„å®ç°ç±»/** * JDK åŠ¨æ€ä»£ç† * åŸºäºæ¥å£çš„ä»£ç†, åªèƒ½å¯¹å®ç°æ¥å£çš„ç±»ç”Ÿæˆä»£ç†, ä¸èƒ½å¯¹ç±»è¿›è¡Œä»£ç† * * @author liuzhihang * @date 2018/5/17 10:36 */public class MyInvocationHandler implements InvocationHandler &#123; /** * ç›®æ ‡å¯¹è±¡ */ private Object target; public MyInvocationHandler(Object target) &#123; this.target = target; &#125; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; System.out.println(&quot;jdk åŠ¨æ€ä»£ç† before . . . &quot;); System.out.println(&quot;å½“å‰ä»£ç†æ–¹æ³•ä¸º:&quot; + method); Object invoke = method.invoke(target, args); System.out.println(&quot;jdk åŠ¨æ€ä»£ç† after . . . &quot;); return invoke; &#125;&#125; åˆ›å»ºè¢«ä»£ç†ç±»çš„æ¥å£åŠå®ç°ç±»/** * è¢«ä»£ç†ç±»çš„æ¥å£ * @author liuzhihang * @date 2018/5/17 10:47 */public interface Subject &#123; /** * è·å–åå­— * @return */ String getName(); /** * è·å–å¹´é¾„ * @param name * @return */ String getAge(String name);&#125; /** * è¢«ä»£ç†ç±» * * @author liuzhihang * @date 2018/5/17 10:48 */public class SubjectImpl implements Subject &#123; @Override public String getName() &#123; System.out.println(&quot;SubjectImplçš„è·å–åå­—æ–¹æ³• . . .&quot;); return &quot;liuzhihang&quot;; &#125; @Override public String getAge(String name) &#123; System.out.println(name + &quot;å¼€å§‹è·å–å¹´é¾„ . . .&quot;); return &quot;25&quot;; &#125;&#125; ä½¿ç”¨åŠ¨æ€ä»£ç†ç±»Proxyçš„é™æ€æ–¹æ³•ç”Ÿæˆä»£ç†ç±»å®ä¾‹è·å–ä»£ç†ç±»å®ä¾‹æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼, ä¸€ç§æ˜¯é€šè¿‡Proxy.newProxyInstance(..)è·å–, ä¸€ç§æ˜¯é€šè¿‡ Proxy.getProxyClass(..) æ–¹å¼è·å–1.Proxy.newProxyInstance(..) /** * å½“ä»£ç†ç±»å®ä¾‹è°ƒç”¨æ–¹æ³•æ—¶, ä¼šè‡ªåŠ¨è·³è½¬åˆ°ä»£ç†ç±»å…³è”çš„ handler å¯¹è±¡, é€šè¿‡ method.invoke(target, args) è¿›è¡Œè°ƒç”¨ * * * @author liuzhihang * @date 2018/5/17 10:49 */public class ProxyMainTest &#123; public static void main(String[] args) &#123; Subject subject = new SubjectImpl(); ClassLoader classLoader = subject.getClass().getClassLoader(); Class&lt;?&gt;[] interfaces = subject.getClass().getInterfaces(); MyInvocationHandler handler = new MyInvocationHandler(subject); // ç”Ÿæˆä»£ç†ç±»å®ä¾‹ Subject proxyInstance = (Subject) Proxy.newProxyInstance(classLoader, interfaces, handler); String name = proxyInstance.getName(); String instanceAge = proxyInstance.getAge(&quot;liuzhihang&quot;); System.err.println(name + &quot; &quot; + instanceAge); &#125;&#125; 2.Proxy.getProxyClass(..) /** * å½“ä»£ç†ç±»å®ä¾‹è°ƒç”¨æ–¹æ³•æ—¶, ä¼šè‡ªåŠ¨è·³è½¬åˆ°ä»£ç†ç±»å…³è”çš„ handler å¯¹è±¡, é€šè¿‡ method.invoke(target, args) è¿›è¡Œè°ƒç”¨ * æ­¤æ–¹å¼æœ‰å¼‚å¸¸æŠ›å‡º * * @author liuzhihang * @date 2018/5/17 10:49 */public class ProxyMainTest &#123; public static void main(String[] args) &#123; try &#123; Subject subject = new SubjectImpl(); ClassLoader classLoader = subject.getClass().getClassLoader(); Class&lt;?&gt;[] interfaces = subject.getClass().getInterfaces(); MyInvocationHandler handler = new MyInvocationHandler(subject); Class&lt;?&gt; proxyClass = Proxy.getProxyClass(classLoader, interfaces); Constructor&lt;?&gt; constructor = proxyClass.getConstructor(InvocationHandler.class); Subject subject1 = (Subject) constructor.newInstance(handler); String name1 = subject1.getName(); String instanceAge1 = subject1.getAge(&quot;liuzhihang&quot;); System.err.println(name1 + &quot; &quot; + instanceAge1); &#125; catch (NoSuchMethodException | IllegalAccessException | InvocationTargetException | InstantiationException e) &#123; e.printStackTrace(); &#125; &#125;&#125; æ‰§è¡Œç»“æœD:\\jdk1.8\\bin\\java.exe . . .liuzhihang 25jdk åŠ¨æ€ä»£ç† before . . .å½“å‰ä»£ç†æ–¹æ³•ä¸º:public abstract java.lang.String com.liuzhihang.tool.proxy.jdk.Subject.getName()SubjectImplçš„è·å–åå­—æ–¹æ³• . . .jdk åŠ¨æ€ä»£ç† after . . .jdk åŠ¨æ€ä»£ç† before . . .å½“å‰ä»£ç†æ–¹æ³•ä¸º:public abstract java.lang.String com.liuzhihang.tool.proxy.jdk.Subject.getAge(java.lang.String)liuzhihangå¼€å§‹è·å–å¹´é¾„ . . .jdk åŠ¨æ€ä»£ç† after . . .Process finished with exit code 0 ç»“è®º: ä»£ç†å®ä¾‹åœ¨æ¯æ¬¡è°ƒç”¨æ–¹æ³•æ˜¯éƒ½ä¼šé€šè¿‡ä»£ç†ç±»è¿›è¡Œè°ƒç”¨ ç›¸å…³æºç è§£æå®Œæ•´æ³¨é‡Šå¯è‡ªå·±æŸ¥çœ‹ç›¸å…³æºç , æºç è¿‡ç¨‹åº”å½“DeBugå¤šèµ°èµ°.1.è°ƒç”¨ Proxy.newProxyInstance æ–¹æ³• &#x2F;** * è¿”å›æŒ‡å®šæ¥å£çš„ä»£ç†ç±»å®ä¾‹ï¼Œè¯¥æ¥å£å°†æ–¹æ³•è°ƒç”¨åˆ†æ´¾ç»™æŒ‡å®šçš„è°ƒç”¨å¤„ç†ç¨‹åº *&#x2F;@CallerSensitivepublic static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h) throws IllegalArgumentException &#123; &#x2F;&#x2F; éç©ºæ ¡éªŒ Objects.requireNonNull(h); final Class&lt;?&gt;[] intfs &#x3D; interfaces.clone(); &#x2F;&#x2F; è·å–ç³»ç»Ÿå®‰å…¨æ¥å£ final SecurityManager sm &#x3D; System.getSecurityManager(); if (sm !&#x3D; null) &#123; &#x2F;&#x2F; æ ¡éªŒæƒé™ checkProxyAccess(Reflection.getCallerClass(), loader, intfs); &#125; &#x2F;* * ä»ç¼“å­˜ä¸­è·å–ä»£ç†ç±» æˆ–è€… ç”Ÿæˆæ–°çš„ä»£ç†ç±» *&#x2F; Class&lt;?&gt; cl &#x3D; getProxyClass0(loader, intfs); &#x2F;* * é€šè¿‡åå°„è·å–æ„é€ å‡½æ•°å¯¹è±¡å¹¶ç”Ÿæˆä»£ç†ç±»å®ä¾‹ *&#x2F; try &#123; if (sm !&#x3D; null) &#123; checkNewProxyPermission(Reflection.getCallerClass(), cl); &#125; &#x2F;&#x2F; è·å–æ„é€  final Constructor&lt;?&gt; cons &#x3D; cl.getConstructor(constructorParams); final InvocationHandler ih &#x3D; h; &#x2F;&#x2F; éªŒè¯ä»£ç†ç±»çš„ä¿®é¥°ç¬¦ if (!Modifier.isPublic(cl.getModifiers())) &#123; &#x2F;&#x2F; ä¿®æ”¹è®¿é—®æƒé™ AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123; public Void run() &#123; &#x2F;&#x2F; å°†æ­¤å¯¹è±¡çš„å¯è®¿é—®æ ‡å¿—è®¾ç½®ä¸ºæŒ‡å®šçš„å¸ƒå°”å€¼, trueè¡¨ç¤ºåå°„å¯¹è±¡åœ¨ä½¿ç”¨æ—¶åº”ç¦æ­¢Javaè¯­è¨€è®¿é—®æ£€æŸ¥, falseè¡¨ç¤ºåå°„å¯¹è±¡åº”å¼ºåˆ¶æ‰§è¡ŒJavaè¯­è¨€è®¿é—®æ£€æŸ¥ cons.setAccessible(true); return null; &#125; &#125;); &#125; &#x2F;&#x2F;ç”Ÿæˆå®ä¾‹, å¹¶å°†å‚æ•°ä¼ å…¥æ„é€  return cons.newInstance(new Object[]&#123;h&#125;); &#125; catch (IllegalAccessException | InstantiationException e) &#123; throw new InternalError(e.toString(), e); &#125; catch (InvocationTargetException e) &#123; Throwable t &#x3D; e.getCause(); if (t instanceof RuntimeException) &#123; throw (RuntimeException) t; &#125; else &#123; throw new InternalError(t.toString(), t); &#125; &#125; catch (NoSuchMethodException e) &#123; throw new InternalError(e.toString(), e); &#125;&#125; å¯ä»¥çœ‹å‡ºè·å–ä»£ç†ç±»æ˜¯åœ¨ Class&lt;?&gt; cl = getProxyClass0(loader, intfs); å¤„, ç»§ç»­ç›¸å…³é€»è¾‘2.è·å–ä»£ç†ç±»ç›¸å…³é€»è¾‘ &#x2F;** * ç”Ÿæˆä»£ç†ç±», ä¹‹å‰å¿…é¡»è¿›è¡Œæƒé™æ£€æŸ¥ *&#x2F;private static Class&lt;?&gt; getProxyClass0(ClassLoader loader, Class&lt;?&gt;... interfaces) &#123; if (interfaces.length &gt; 65535) &#123; throw new IllegalArgumentException(&quot;interface limit exceeded&quot;); &#125; &#x2F;&#x2F;å¦‚æœç”±å®ç°ç»™å®šæ¥å£çš„ç»™å®šåŠ è½½å™¨å®šä¹‰çš„ä»£ç†ç±»å­˜åœ¨ï¼Œåˆ™å®ƒå°†ç®€å•åœ°è¿”å›ç¼“å­˜å‰¯æœ¬; å¦åˆ™ï¼Œå®ƒå°†é€šè¿‡Proxy Class Factoryåˆ›å»ºä»£ç†ç±» return proxyClassCache.get(loader, interfaces);&#125; 3.proxyClassCache.get(loader, interfaces);java.lang.reflect.WeakCache#get(..) ä»‹ç» &#x2F;** * é€šè¿‡ç¼“å­˜æŸ¥æ‰¾å€¼, å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ç»™å®šçš„ï¼ˆkeyï¼Œsub Keyï¼‰å¯¹çš„æ¡ç›®æˆ–æ¡ç›®å·²è¢«æ¸…é™¤ï¼Œåˆ™å®ƒæ€»æ˜¯è¯„ä¼°&#123;Key sub Key Factory&#125;å‡½æ•°å¹¶å¯é€‰æ‹©è¯„ä¼°&#123;Factory value&#125;å‡½æ•° *&#x2F;public V get(K key, P parameter) &#123; &#x2F;&#x2F; éç©ºæ ¡éªŒ Objects.requireNonNull(parameter); &#x2F;&#x2F; åˆ¤æ–­ç§»é™¤é˜Ÿåˆ— expungeStaleEntries(); &#x2F;&#x2F; ç¼“å­˜key Object cacheKey &#x3D; CacheKey.valueOf(key, refQueue); &#x2F;&#x2F; å»¶è¿ŸåŠ è½½ä½¿ç”¨äºŒçº§map ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap &#x3D; map.get(cacheKey); if (valuesMap &#x3D;&#x3D; null) &#123; ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; oldValuesMap &#x3D; map.putIfAbsent(cacheKey, valuesMap &#x3D; new ConcurrentHashMap&lt;&gt;()); if (oldValuesMap !&#x3D; null) &#123; valuesMap &#x3D; oldValuesMap; &#125; &#125; &#x2F;&#x2F; åˆ›å»ºå­key å¹¶æ ¹æ®key æ£€ç´¢supplier Object subKey &#x3D; Objects.requireNonNull(subKeyFactory.apply(key, parameter)); &#x2F;&#x2F; æ ¹æ®keyè·å–supplier Supplier&lt;V&gt; supplier &#x3D; valuesMap.get(subKey); Factory factory &#x3D; null; while (true) &#123; if (supplier !&#x3D; null) &#123; &#x2F;&#x2F; supplier å¯èƒ½ä¸º Factory æˆ–è€… CacheValue&lt;V&gt; çš„å®ä¾‹, ä»ç¼“å­˜ä¸­è·å–åˆ°åˆ™ç›´æ¥è¿”å› V value &#x3D; supplier.get(); if (value !&#x3D; null) &#123; return value; &#125; &#125; &#x2F;&#x2F; factoryä¸å­˜åœ¨åˆ™åˆ›å»º if (factory &#x3D;&#x3D; null) &#123; factory &#x3D; new Factory(key, parameter, subKey, valuesMap); &#125; &#x2F;&#x2F; supplier ä¸ºnull if (supplier &#x3D;&#x3D; null) &#123; &#x2F;&#x2F; ä»valuesMapè·å–supplier supplier &#x3D; valuesMap.putIfAbsent(subKey, factory); if (supplier &#x3D;&#x3D; null) &#123; &#x2F;&#x2F; successfully installed Factory supplier &#x3D; factory; &#125; &#x2F;&#x2F; else retry with winning supplier &#125; else &#123; if (valuesMap.replace(subKey, supplier, factory)) &#123; &#x2F;&#x2F; successfully replaced &#x2F;&#x2F; cleared CacheEntry &#x2F; unsuccessful Factory &#x2F;&#x2F; with our Factory supplier &#x3D; factory; &#125; else &#123; &#x2F;&#x2F; retry with current supplier supplier &#x3D; valuesMap.get(subKey); &#125; &#125; &#125;&#125; å¯ä»¥å‘ç°é‡ç‚¹åœ¨ Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter)); è·å– subKey çš„è¿‡ç¨‹ä¸­.4.subKeyFactory.apply(key, parameter)Debugå‘ç°åœ¨æ­¤å¤„è°ƒç”¨çš„æ˜¯ java.lang.reflect.Proxy.ProxyClassFactory é™æ€å†…éƒ¨ç±»,æ­¤å¤„æ ¹æ®æ¥å£çš„æ•°é‡ç”ŸæˆäºŒçº§ç¼“å­˜ /** * ä¸€ä¸ªå·¥å‚å‡½æ•°, ç”¨äºç”Ÿæˆ, å®šä¹‰å¹¶è¿”å›ç»™å®šClassLoaderå’Œæ¥å£æ•°ç»„çš„ä»£ç†ç±» */private static final class ProxyClassFactory implements BiFunction&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;&#123; // æ‰€æœ‰ä»£ç†ç±»çš„å‰ç¼€ private static final String proxyClassNamePrefix = &quot;$Proxy&quot;; // next number to use for generation of unique proxy class names private static final AtomicLong nextUniqueNumber = new AtomicLong(); @Override public Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123; // åœ¨IdentityHashMapä¸­, å½“ä¸”ä»…å½“ä¸¤ä¸ªkeyä¸¥æ ¼ç›¸ç­‰ï¼ˆkey1==key2ï¼‰æ—¶ï¼ŒIdentityHashMapæ‰è®¤ä¸ºä¸¤ä¸ªkeyç›¸ç­‰ Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = new IdentityHashMap&lt;&gt;(interfaces.length); // å¾ªç¯æ¥å£æ•°ç»„ for (Class&lt;?&gt; intf : interfaces) &#123; /* * éªŒè¯ç±»åŠ è½½å™¨æ˜¯å¦å°†æ­¤æ¥å£çš„åç§°è§£æä¸ºåŒä¸€ä¸ªClasså¯¹è±¡ */ Class&lt;?&gt; interfaceClass = null; try &#123; // è·å–æ¥å£çš„ class interfaceClass = Class.forName(intf.getName(), false, loader); &#125; catch (ClassNotFoundException e) &#123; &#125; if (interfaceClass != intf) &#123; throw new IllegalArgumentException( intf + &quot; is not visible from class loader&quot;); &#125; /* * éªŒè¯interfaceClassæ˜¯å¦ä¸ºæ¥å£ */ if (!interfaceClass.isInterface()) &#123; throw new IllegalArgumentException( interfaceClass.getName() + &quot; is not an interface&quot;); &#125; /* * éªŒè¯æ¥å£æ˜¯å¦é‡å¤ */ if (interfaceSet.put(interfaceClass, Boolean.TRUE) != null) &#123; throw new IllegalArgumentException( &quot;repeated interface: &quot; + interfaceClass.getName()); &#125; &#125; String proxyPkg = null; // package to define proxy class in int accessFlags = Modifier.PUBLIC | Modifier.FINAL; /* * éªŒè¯æ‰€æœ‰éå…¬å¼€ä»£ç†æ¥å£æ˜¯å¦åœ¨åŒä¸€ä¸ªåŒ…ä¸­ */ for (Class&lt;?&gt; intf : interfaces) &#123; int flags = intf.getModifiers(); if (!Modifier.isPublic(flags)) &#123; accessFlags = Modifier.FINAL; String name = intf.getName(); int n = name.lastIndexOf(&#x27;.&#x27;); String pkg = ((n == -1) ? &quot;&quot; : name.substring(0, n + 1)); if (proxyPkg == null) &#123; proxyPkg = pkg; &#125; else if (!pkg.equals(proxyPkg)) &#123; throw new IllegalArgumentException( &quot;non-public interfaces from different packages&quot;); &#125; &#125; &#125; if (proxyPkg == null) &#123; // å¦‚æœæ²¡æœ‰éå…¬å¼€çš„ä»£ç†æ¥å£ï¼Œä½¿ç”¨ com.sun.proxy package proxyPkg = ReflectUtil.PROXY_PACKAGE + &quot;.&quot;; &#125; /* * ä¸ºè¦ç”Ÿæˆçš„ä»£ç†ç±»é€‰æ‹©ä¸€ä¸ªåç§° */ long num = nextUniqueNumber.getAndIncrement(); String proxyName = proxyPkg + proxyClassNamePrefix + num; /* * ç”Ÿæˆä»£ç†ç±» */ byte[] proxyClassFile = ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags); try &#123; return defineClass0(loader, proxyName, proxyClassFile, 0, proxyClassFile.length); &#125; catch (ClassFormatError e) &#123; /* * A ClassFormatError here means that (barring bugs in the * proxy class generation code) there was some other * invalid aspect of the arguments supplied to the proxy * class creation (such as virtual machine limitations * exceeded). */ throw new IllegalArgumentException(e.toString()); &#125; &#125;&#125; 5.ç”Ÿè¾°ç»™ä»£ç†ç±»byte[] proxyClassFile = ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags);å¯ä»¥åœ¨æµ‹è¯•ç±»ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹æ‰“å°å‡ºä»£ç†ç±»: System.setProperty(&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;, &quot;true&quot;); ä»£ç†ç±»å†…å®¹å¦‚ä¸‹: //// Source code recreated from a .class file by IntelliJ IDEA// (powered by Fernflower decompiler)//package com.sun.proxy;import com.liuzhihang.tool.proxy.jdk.Subject;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;import java.lang.reflect.UndeclaredThrowableException;public final class $Proxy0 extends Proxy implements Subject &#123; private static Method m1; private static Method m3; private static Method m2; private static Method m4; private static Method m0; public $Proxy0(InvocationHandler var1) throws &#123; super(var1); &#125; public final boolean equals(Object var1) throws &#123; try &#123; return (Boolean)super.h.invoke(this, m1, new Object[]&#123;var1&#125;); &#125; catch (RuntimeException | Error var3) &#123; throw var3; &#125; catch (Throwable var4) &#123; throw new UndeclaredThrowableException(var4); &#125; &#125; public final String getName() throws &#123; try &#123; return (String)super.h.invoke(this, m3, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; public final String toString() throws &#123; try &#123; return (String)super.h.invoke(this, m2, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; public final String getAge(String var1) throws &#123; try &#123; return (String)super.h.invoke(this, m4, new Object[]&#123;var1&#125;); &#125; catch (RuntimeException | Error var3) &#123; throw var3; &#125; catch (Throwable var4) &#123; throw new UndeclaredThrowableException(var4); &#125; &#125; public final int hashCode() throws &#123; try &#123; return (Integer)super.h.invoke(this, m0, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; static &#123; try &#123; m1 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;equals&quot;, Class.forName(&quot;java.lang.Object&quot;)); m3 = Class.forName(&quot;com.liuzhihang.tool.proxy.jdk.Subject&quot;).getMethod(&quot;getName&quot;); m2 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;toString&quot;); m4 = Class.forName(&quot;com.liuzhihang.tool.proxy.jdk.Subject&quot;).getMethod(&quot;getAge&quot;, Class.forName(&quot;java.lang.String&quot;)); m0 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;hashCode&quot;); &#125; catch (NoSuchMethodException var2) &#123; throw new NoSuchMethodError(var2.getMessage()); &#125; catch (ClassNotFoundException var3) &#123; throw new NoClassDefFoundError(var3.getMessage()); &#125; &#125;&#125; å¯ä»¥çœ‹å‡ºç”Ÿæˆçš„$Proxy0ç±»ç»§æ‰¿ProxyåŠ¨æ€ä»£ç†ç±»å¹¶å®ç°äº†Subjectè¢«ä»£ç†æ¥å£, å®ç°æ‰€æœ‰æ–¹æ³•é€šè¿‡ super.h.invoke(this, m1, new Object[]{var1}) å†…éƒ¨è°ƒç”¨äº† InvocationHandler.invoke(â€¦)æ–¹æ³•, é€šè¿‡åå°„è°ƒç”¨ä»£ç†å®ä¾‹çš„æ–¹æ³•","categories":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"åŠ¨æ€ä»£ç†","slug":"åŠ¨æ€ä»£ç†","permalink":"https://liuzhihang.com/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"}]},{"title":"æ‡’æ±‰å•ä¾‹æ¨¡å¼çº¿ç¨‹å®‰å…¨","slug":"design-patterns/å•ä¾‹æ¨¡å¼","date":"2018-02-21T09:15:29.000Z","updated":"2020-04-04T04:12:06.880Z","comments":true,"path":"2018/02/21/lazy-singleton-mode-thread-safe.html","link":"","permalink":"https://liuzhihang.com/2018/02/21/lazy-singleton-mode-thread-safe.html","excerpt":"ä¸€ä¸ªç±»ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹, ä¸”èƒ½å¤Ÿè‡ªè¡Œå®ä¾‹åŒ–æä¾›è¿™ä¸ªå®ä¾‹, åŒæ—¶æä¾›å…¨å±€è®¿é—®çš„æ–¹æ³•. ç»“æ„1.æ„é€ ç§æœ‰åŒ–: ç¡®ä¿å¤–éƒ¨ä¸èƒ½ä½¿ç”¨newç›´æ¥åˆ›å»ºå¯¹è±¡2.å†…éƒ¨é™æ€å±æ€§åˆ›å»ºå®ä¾‹3.å¯¹å¤–å…¬å…±é™æ€è·å–å¯¹è±¡æ–¹æ³•","text":"ä¸€ä¸ªç±»ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹, ä¸”èƒ½å¤Ÿè‡ªè¡Œå®ä¾‹åŒ–æä¾›è¿™ä¸ªå®ä¾‹, åŒæ—¶æä¾›å…¨å±€è®¿é—®çš„æ–¹æ³•. ç»“æ„1.æ„é€ ç§æœ‰åŒ–: ç¡®ä¿å¤–éƒ¨ä¸èƒ½ä½¿ç”¨newç›´æ¥åˆ›å»ºå¯¹è±¡2.å†…éƒ¨é™æ€å±æ€§åˆ›å»ºå®ä¾‹3.å¯¹å¤–å…¬å…±é™æ€è·å–å¯¹è±¡æ–¹æ³• demo/** * å•ä¾‹æ¨¡å¼ * 1. æ„é€ ç§æœ‰åŒ–: ç¡®ä¿å¤–éƒ¨ä¸èƒ½ä½¿ç”¨newç›´æ¥åˆ›å»ºå¯¹è±¡ * 2. å†…éƒ¨é™æ€å±æ€§åˆ›å»ºå®ä¾‹ * 3. å¯¹å¤–å…¬å…±é™æ€è·å–å¯¹è±¡æ–¹æ³• * * @author liuzhihang * @date 2018/3/27 17:45 */public class SingletonPattern &#123; private SingletonPattern() &#123; &#125; private static SingletonPattern singletonPattern = null; public static SingletonPattern getSingletonPattern() &#123; if (singletonPattern == null) &#123; singletonPattern = new SingletonPattern(); &#125; return singletonPattern; &#125;&#125; åˆ†ç±»1.æ‡’æ±‰å¼: æ‡’æ±‰æ¨¡å¼, é¡¹ç›®å¯åŠ¨æ—¶ä¸ç”Ÿæˆå¯¹è±¡, è€Œæ˜¯åœ¨é¦–æ¬¡åˆ›å»ºè¯¥å¯¹è±¡çš„æ—¶å€™ç”Ÿæˆå”¯ä¸€å®ä¾‹ /** * æ‡’æ±‰æ¨¡å¼, é¡¹ç›®å¯åŠ¨æ—¶ä¸ç”Ÿæˆå¯¹è±¡, è€Œæ˜¯åœ¨é¦–æ¬¡åˆ›å»ºè¯¥å¯¹è±¡çš„æ—¶å€™ç”Ÿæˆå”¯ä¸€å®ä¾‹ * * @author liuzhihang * @date 2018/4/2 16:24 */public class LazyPattern &#123; private LazyPattern() &#123; &#125; private static LazyPattern lazyPattern = null; public static LazyPattern getLazyPattern() &#123; try &#123; if (lazyPattern == null) &#123; // æ¨¡æ‹Ÿä¸€ç³»åˆ—è€—æ—¶æ“ä½œ Thread.sleep(50); lazyPattern = new LazyPattern(); &#125; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return lazyPattern; &#125;&#125; 2.é¥¿æ±‰å¼: é¡¹ç›®å¯åŠ¨æ—¶, è¿›è¡ŒåŠ è½½, ä¼šå¯¼è‡´é¡¹ç›®å¯åŠ¨è¾ƒæ…¢, å¹¶ä¸”æ— è®ºåé¢æ˜¯å¦ç”¨åˆ°éƒ½ä¼šè¿›è¡ŒåŠ è½½ /** * * é¥¿æ±‰å¼å•ä¾‹æ¨¡å¼ * é¡¹ç›®å¯åŠ¨æ—¶, è¿›è¡ŒåŠ è½½, ä¼šå¯¼è‡´é¡¹ç›®å¯åŠ¨è¾ƒæ…¢, å¹¶ä¸”æ— è®ºåé¢æ˜¯å¦ç”¨åˆ°éƒ½ä¼šè¿›è¡ŒåŠ è½½ * * @author liuzhihang * @date 2018/4/2 18:44 */public class HungerPattern &#123; private HungerPattern() &#123; &#125; private static HungerPattern hungerPattern = new HungerPattern(); public static HungerPattern getHungerPattern() &#123; return hungerPattern; &#125;&#125; æµ‹è¯•ç”¨ä¾‹åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹å¯¹å•ä¾‹æ¨¡å¼è¿›è¡Œæµ‹è¯•: /** * @author liuzhihang * @date 2018/3/27 19:02 */public class SingletonTest &#123; public static void main(String[] args) &#123; ThreadTest[] threadTests = new ThreadTest[10]; for (int i = 0; i &lt; threadTests.length; i++) &#123; threadTests[i] = new ThreadTest(); &#125; for (int i = 0; i &lt; threadTests.length; i++) &#123; threadTests[i].start(); &#125; &#125;&#125;class ThreadTest extends Thread &#123; @Override public void run() &#123; // æ‡’æ±‰æ¨¡å¼ System.out.println(LazyPattern.getLazyPattern().hashCode()); // é¥¿æ±‰æ¨¡å¼ // System.out.println(HungerPattern.getHungerPattern().hashCode()); &#125;&#125; ç»“æœ: 1.é¥¿æ±‰æ¨¡å¼ D:\\jdk1.8\\bin\\java.exe . . .1294123621129412362112941236211294123621129412362112941236211294123621129412362112941236211294123621Process finished with exit code 0 2.æ‡’æ±‰æ¨¡å¼ D:\\jdk1.8\\bin\\java.exe . . .14091981613591281341385166630924507082676413855088322625749263951409198161442414714896298396Process finished with exit code 0 ç»“è®º: åœ¨æ‡’æ±‰å•ä¾‹æ¨¡å¼ä¸‹ä¸èƒ½ä¿è¯çº¿ç¨‹çš„å®‰å…¨æ€§ æ‡’æ±‰æ¨¡å¼çš„çº¿ç¨‹å®‰å…¨ä¼˜åŒ–é¥¿æ±‰æ¨¡å¼ä¼šé€ æˆèµ„æºæµªè´¹, å¯åŠ¨æ…¢ç­‰ç»“æœ, ä¸‹é¢å¯¹æ‡’æ±‰æ¨¡å¼è¿›è¡Œçº¿ç¨‹å®‰å…¨ä¼˜åŒ–. synchronized é”ä½é™æ€æ–¹æ³•é”ä½é™æ€æ–¹æ³• ç±»çº§é” å½±å“èŒƒå›´è¾ƒå¤§, å¯¼è‡´æ•ˆç‡ç›¸å¯¹è¾ƒä½ /** * æ‡’æ±‰å¼ * åœ¨æ–¹æ³•ä¸Šæ·»åŠ  synchronized å…³é”®å­— é”ç±» * åŒæ­¥æ–¹æ³•çš„æ–¹å¼, å¯¼è‡´æ•ˆç‡ç›¸å¯¹è¾ƒä½ * * @author liuzhihang * @date 2018/4/3 14:27 */public class SyncLazyPattern &#123; private SyncLazyPattern() &#123; &#125; private static SyncLazyPattern syncLazyPattern = null; public static synchronized SyncLazyPattern getSyncLazyPattern() &#123; try &#123; if (syncLazyPattern == null) &#123; Thread.sleep(100); syncLazyPattern = new SyncLazyPattern(); &#125; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return syncLazyPattern; &#125;&#125; synchronized é”ä½ä»£ç å—package com.liuzhihang.demo.singleton;/** * é”ä»£ç å—çš„æ–¹å¼è™½ç„¶å¯ä»¥ä¿è¯ç»“æœä¸€è‡´æ€§ * ä½†é”ä½å¾ˆå¤šæ“ä½œ, åŒæ ·ä¼šå¯¼è‡´æ•ˆç‡ä½ä¸‹ * * @author liuzhihang * @date 2018/4/3 15:22 */public class SyncCodeBlockLazyPattern &#123; private SyncCodeBlockLazyPattern() &#123; &#125; private static SyncCodeBlockLazyPattern syncCodeBlockLazyPattern = null; public static SyncCodeBlockLazyPattern getSyncCodeBlockLazyPattern() &#123; try &#123; // é”ä½å…·ä½“æ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„ä»£ç  synchronized (SyncCodeBlockLazyPattern.class) &#123; if (syncCodeBlockLazyPattern == null) &#123; Thread.sleep(100); syncCodeBlockLazyPattern = new SyncCodeBlockLazyPattern(); &#125; &#125; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return syncCodeBlockLazyPattern; &#125;&#125; åŒé‡æ£€æŸ¥é”æœºåˆ¶(æ¨è)package com.liuzhihang.demo.singleton;/** * åŒé‡é”æ£€æŸ¥æœºåˆ¶, ä»…é”ä½åˆ›å»ºå¯¹è±¡çš„éƒ¨åˆ†ä»£ç  * æ³¨æ„: åœ¨å¯¹è±¡å‰ æ·»åŠ  volatile å…³é”®å­— ç¡®ä¿å¯è§æ€§, å³ æ¯æ¬¡è·å–å€¼ä»ä¸»å†…å­˜ä¸­è·å–, åŒæ—¶é˜²æ­¢æŒ‡ä»¤é‡æ’åº * * @author liuzhihang * @date 2018/4/3 15:29 */public class DubboCheckLockLazyPattern &#123; private DubboCheckLockLazyPattern() &#123; &#125; private static volatile DubboCheckLockLazyPattern dubboCheckLockLazyPattern = null; public static DubboCheckLockLazyPattern getDubboCheckLockLazyPattern() &#123; try &#123; if (dubboCheckLockLazyPattern == null) &#123; // ä¸€ç³»åˆ—æ“ä½œ Thread.sleep(100); synchronized (DubboCheckLockLazyPattern.class) &#123; // äºŒæ¬¡æ£€æŸ¥ if (dubboCheckLockLazyPattern == null) &#123; dubboCheckLockLazyPattern = new DubboCheckLockLazyPattern(); &#125; &#125; &#125; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return dubboCheckLockLazyPattern; &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://liuzhihang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://liuzhihang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"},{"name":"å•ä¾‹æ¨¡å¼","slug":"å•ä¾‹æ¨¡å¼","permalink":"https://liuzhihang.com/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"}]},{"title":"poiè¯»å†™Excelç®€å•ä»‹ç»","slug":"utils/excel/poiForExcel","date":"2018-02-15T10:12:20.000Z","updated":"2020-11-13T03:00:25.320Z","comments":true,"path":"2018/02/15/poi-read-and-write-excel-brief-introduction.html","link":"","permalink":"https://liuzhihang.com/2018/02/15/poi-read-and-write-excel-brief-introduction.html","excerpt":"Apache POI å¯ä»¥å¯¹Microsoft Office è¿›è¡Œæ“ä½œ, ä¸‹é¢æ˜¯å·¥ä½œä¸­ä½¿ç”¨çš„å¯¹Excelè¿›è¡Œè¯»å†™æ“ä½œçš„å¸¸ç”¨æ–¹å¼. å¼•å…¥ä¾èµ–&lt;!-- excel poi --&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.poi&lt;/groupId&gt; &lt;artifactId&gt;poi&lt;/artifactId&gt; &lt;version&gt;3.17&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.poi&lt;/groupId&gt; &lt;artifactId&gt;poi-ooxml&lt;/artifactId&gt; &lt;version&gt;3.17&lt;/version&gt;&lt;/dependency&gt;","text":"Apache POI å¯ä»¥å¯¹Microsoft Office è¿›è¡Œæ“ä½œ, ä¸‹é¢æ˜¯å·¥ä½œä¸­ä½¿ç”¨çš„å¯¹Excelè¿›è¡Œè¯»å†™æ“ä½œçš„å¸¸ç”¨æ–¹å¼. å¼•å…¥ä¾èµ–&lt;!-- excel poi --&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.poi&lt;/groupId&gt; &lt;artifactId&gt;poi&lt;/artifactId&gt; &lt;version&gt;3.17&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.poi&lt;/groupId&gt; &lt;artifactId&gt;poi-ooxml&lt;/artifactId&gt; &lt;version&gt;3.17&lt;/version&gt;&lt;/dependency&gt; ç®€å•ä½¿ç”¨ä¸»è¦ä»‹ç»è¯»å†™æ—¶, åˆ†åˆ«å¸¸ç”¨åˆ°çš„ä¸€äº›å¯¹è±¡åŠå…¶å«ä¹‰, æ–¹ä¾¿è‡ªå·±ç¼–å†™util. package com.liuzhihang.tool.excel.poi;import org.apache.poi.hssf.usermodel.HSSFWorkbook;import org.apache.poi.ss.usermodel.Row;import org.apache.poi.ss.usermodel.Sheet;import org.apache.poi.ss.usermodel.Workbook;import org.apache.poi.xssf.usermodel.XSSFSheet;import org.apache.poi.xssf.usermodel.XSSFWorkbook;import java.io.File;import java.io.FileOutputStream;import java.io.IOException;import java.io.OutputStream;/** * @author liuzhihang * @date 2018/4/20 16:12 */public class ExcelTest &#123; public static void main(String[] args) throws Exception &#123; // readerTest(); writerTest(); &#125; private static void writerTest() throws IOException &#123; File file = new File(&quot;c:Users/liuzhihang/Desktop/test.xlsx&quot;); if (file.exists()) &#123; System.out.println(&quot;è¯»å–çš„æ–‡ä»¶å­˜åœ¨!&quot;); file.delete(); &#125; file.createNewFile(); // æ“ä½œ .xls çš„ workbook Workbook hssfWorkbook = new HSSFWorkbook(); // æ“ä½œ .xlsx çš„ workbook XSSFWorkbook xssfWorkbook = new XSSFWorkbook(); // åˆ›å»º sheet é¡µ XSSFSheet sheet = xssfWorkbook.createSheet(); // åˆ›å»º 0 è¡Œ æ“ä½œå¯¹è±¡ Row row0 = sheet.createRow(0); // åˆ›å»ºå•å…ƒæ ¼å¹¶èµ‹å€¼ row0.createCell(0).setCellValue(&quot;åºå·&quot;); OutputStream outputStream = new FileOutputStream(file); // å†™å…¥æ–‡ä»¶ xssfWorkbook.write(outputStream); &#125; private static void readerTest() throws Exception &#123; File file = new File(&quot;c:Users/liuzhihang/Desktop/parkingLotTempLate.xlsx&quot;); Workbook workBook = ExcelUtil.getWorkBook(file); // è·å– excel é¡µ // Sheet sheetByIndex = workBook.getSheetAt(0); // Sheet sheetByName = workBook.getSheet(&quot;Sheet0&quot;); // æ“ä½œ sheet Sheet sheet = workBook.getSheetAt(0); // è·å–æœ€åä¸€è¡Œè¡Œæ•° ä» 0 å¼€å§‹ int lastRowNum = sheet.getLastRowNum(); // è·å–æ€»è¡Œæ•° int physicalNumberOfRows = sheet.getPhysicalNumberOfRows(); // æ“ä½œè¡Œ è·å–ç¬¬0è¡Œ Row row = sheet.getRow(0); String value = row.getCell(0).getStringCellValue(); &#125;&#125; ExcelUtil ç®€å•å·¥å…·poiè¯»å†™ excel çš„ç®€å•å·¥å…· ExcelUtil, å®é™…å·¥ä½œä¸­å¯ç»“åˆjavaBeanä½¿ç”¨å¹¶é‡æ–°ç¼–å†™util. package com.liuzhihang.tool.excel.poi;import lombok.extern.log4j.Log4j2;import org.apache.commons.lang.StringUtils;import org.apache.poi.hssf.usermodel.HSSFWorkbook;import org.apache.poi.ss.usermodel.Cell;import org.apache.poi.ss.usermodel.Row;import org.apache.poi.ss.usermodel.Sheet;import org.apache.poi.ss.usermodel.Workbook;import org.apache.poi.xssf.usermodel.XSSFWorkbook;import java.io.*;import java.util.ArrayList;import java.util.List;/** * @author liuzhihang * @date 2018/4/20 12:02 */@Log4j2public class ExcelUtil &#123; /** * è¯»å–ä¸¤åˆ—excel è¿”å›ç¬¬äºŒåˆ—çš„é›†åˆ * * @param workbook * @return */ public static List&lt;String&gt; readExcelForTwoColumns(Workbook workbook) &#123; if (workbook == null) &#123; log.info(&quot;è·å– workbook ä¸ºnull&quot;); return null; &#125; List&lt;String&gt; list = new ArrayList&lt;&gt;(); try &#123; Sheet sheet = workbook.getSheetAt(0); //è·å–æ€»è¡Œæ•° int rowNum = sheet.getLastRowNum(); //æ­£æ–‡å†…å®¹åº”è¯¥ä»ç¬¬äºŒè¡Œå¼€å§‹ï¼Œç¬¬ä¸€è¡Œä¸ºæ–‡ä»¶çš„æ ‡å¤´çš„æ ‡é¢˜ for (int i = 0; i &lt; rowNum; i++) &#123; Row row = sheet.getRow(i + 1); String value = getCellValue(row.getCell(1)).toString(); if (StringUtils.isNotBlank(value)) &#123; list.add(value); &#125; &#125; &#125; catch (Exception e) &#123; log.error(e.getMessage()); &#125; return list; &#125; /** * å†™ excel * * @param excelFile * @param list */ public static void writerExcelForTwoColumns(File excelFile, List&lt;String&gt; list) &#123; OutputStream outputStream = null; try &#123; outputStream = new FileOutputStream(excelFile); Workbook workBook = null; String fileName = excelFile.getName(); if (fileName.endsWith(&quot;.xls&quot;)) &#123; workBook = new HSSFWorkbook(); &#125; else if (fileName.endsWith(&quot;.xlsx&quot;)) &#123; workBook = new XSSFWorkbook(); &#125; else &#123; log.info(&quot;æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®!, å½“å‰æ–‡ä»¶å:&#123;&#125;&quot;, fileName); throw new Exception(&quot;æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®&quot;); &#125; // åˆ›å»ºç¬¬ 0 é¡µ Sheet sheet = workBook.createSheet(); Row row1 = sheet.createRow(0); row1.createCell(0).setCellValue(&quot;åºå·&quot;); row1.createCell(1).setCellValue(&quot;ç¼–å·&quot;); for (int i = 0; i &lt; list.size(); i++) &#123; Row row = sheet.createRow(i + 1); row.createCell(0).setCellValue(i + 1); row.createCell(1).setCellValue(list.get(i)); &#125; workBook.write(outputStream); &#125; catch (Exception e) &#123; log.error(&quot;å†™excelå¤±è´¥&quot;, e); &#125; finally &#123; try &#123; outputStream.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125; /** * è·å–å·¥ä½œè¡¨ * * @param file * @return */ public static Workbook getWorkBook(File file) throws Exception &#123; String fileName = file.getName(); Workbook workbook = null; try &#123; InputStream inputStream = new FileInputStream(file); if (fileName.endsWith(&quot;.xls&quot;)) &#123; workbook = new HSSFWorkbook(inputStream); &#125; else if (fileName.endsWith(&quot;.xlsx&quot;)) &#123; workbook = new XSSFWorkbook(inputStream); &#125; else &#123; log.info(&quot;æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®!, å½“å‰æ–‡ä»¶å:&#123;&#125;&quot;, fileName); throw new Exception(&quot;æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®&quot;); &#125; &#125; catch (Exception e) &#123; throw e; &#125; return workbook; &#125; /** * è·å–å•å…ƒæ ¼çš„æ•°æ® * * @param cell * @return */ public static Object getCellValue(Cell cell) &#123; if (cell != null) &#123; switch (cell.getCellTypeEnum()) &#123; // æ•°å­— case NUMERIC: return cell.getNumericCellValue(); // å­—ç¬¦ä¸² case STRING: return cell.getStringCellValue(); // å…¬å¼ case FORMULA: return cell.getCellFormula(); // å¸ƒå°” case BOOLEAN: return cell.getBooleanCellValue(); case ERROR: return cell.getErrorCellValue(); // ç©º default: return &quot;&quot;; &#125; &#125; return &quot;&quot;; &#125;&#125;","categories":[{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/categories/utils/"}],"tags":[{"name":"poi","slug":"poi","permalink":"https://liuzhihang.com/tags/poi/"},{"name":"excel","slug":"excel","permalink":"https://liuzhihang.com/tags/excel/"}]},{"title":"protostuffåºåˆ—åŒ–å·¥å…·","slug":"utils/serialize/protostuff","date":"2018-02-05T12:12:20.000Z","updated":"2020-04-04T07:33:24.448Z","comments":true,"path":"2018/02/05/protostuff-serialization-tool.html","link":"","permalink":"https://liuzhihang.com/2018/02/05/protostuff-serialization-tool.html","excerpt":"ä»‹ç»åœ¨å¾ˆå¤šåœ°æ–¹éƒ½éœ€è¦ç”¨åˆ°åºåˆ—åŒ–, æ¯”å¦‚åœ¨ä½¿ç”¨redisç¼“å­˜å¯¹è±¡æ—¶, ä¸€èˆ¬æƒ…å†µæ˜¯å®ç°java Serializableæ¥å£. ç®€å•ä»‹ç»ä¸‹åœ¨æ…•è¯¾ç½‘å­¦ä¹ åˆ°çš„ä¸€ä¸ªæ–°çš„åºåˆ—åŒ–å·¥å…· â€”- protostuff. åœ¨å­¦ä¹ ä¸­ä»‹ç»ä½¿ç”¨è¯¥å·¥å…·å¯ä»¥å¤§å¤§å‡å°‘å¯¹è±¡åºåˆ—åŒ–åå­—èŠ‚æ‰€å ç©ºé—´, å¹¶æé«˜åºåˆ—åŒ–æ—¶é—´ç­‰. 1.æ…•è¯¾ç½‘è¯¾ç¨‹åœ°å€2.åºåˆ—åŒ–ç›¸å…³å·¥å…·æ¯”è¾ƒ","text":"ä»‹ç»åœ¨å¾ˆå¤šåœ°æ–¹éƒ½éœ€è¦ç”¨åˆ°åºåˆ—åŒ–, æ¯”å¦‚åœ¨ä½¿ç”¨redisç¼“å­˜å¯¹è±¡æ—¶, ä¸€èˆ¬æƒ…å†µæ˜¯å®ç°java Serializableæ¥å£. ç®€å•ä»‹ç»ä¸‹åœ¨æ…•è¯¾ç½‘å­¦ä¹ åˆ°çš„ä¸€ä¸ªæ–°çš„åºåˆ—åŒ–å·¥å…· â€”- protostuff. åœ¨å­¦ä¹ ä¸­ä»‹ç»ä½¿ç”¨è¯¥å·¥å…·å¯ä»¥å¤§å¤§å‡å°‘å¯¹è±¡åºåˆ—åŒ–åå­—èŠ‚æ‰€å ç©ºé—´, å¹¶æé«˜åºåˆ—åŒ–æ—¶é—´ç­‰. 1.æ…•è¯¾ç½‘è¯¾ç¨‹åœ°å€2.åºåˆ—åŒ–ç›¸å…³å·¥å…·æ¯”è¾ƒ å¼•å…¥ä¾èµ–&lt;!-- protostuff åºåˆ—åŒ–å·¥å…· --&gt;&lt;dependency&gt; &lt;groupId&gt;com.dyuproject.protostuff&lt;/groupId&gt; &lt;artifactId&gt;protostuff-core&lt;/artifactId&gt; &lt;version&gt;1.1.3&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.dyuproject.protostuff&lt;/groupId&gt; &lt;artifactId&gt;protostuff-runtime&lt;/artifactId&gt; &lt;version&gt;1.1.3&lt;/version&gt;&lt;/dependency&gt; ç›¸å…³ä½¿ç”¨import com.dyuproject.protostuff.LinkedBuffer;import com.dyuproject.protostuff.ProtostuffIOUtil;import com.dyuproject.protostuff.runtime.RuntimeSchema;/** * @author liuzhihang * @date 2018/4/18 15:04 */public class ProtostuffUtil &#123; public static &lt;T&gt; byte[] serialize(T t, Class&lt;T&gt; cls) &#123; RuntimeSchema&lt;T&gt; schema = RuntimeSchema.createFrom(cls); return ProtostuffIOUtil.toByteArray(t, schema, LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE)); &#125; public static &lt;T&gt; T unSerialize(byte[] bytes, Class&lt;T&gt; cls) &#123; RuntimeSchema&lt;T&gt; schema = RuntimeSchema.createFrom(cls); T message = schema.newMessage(); ProtostuffIOUtil.mergeFrom(bytes, message, schema); return message; &#125;&#125; æµ‹è¯•import lombok.Data;/** * @author liuzhihang * @date 2018/4/17 19:01 */@Datapublic class User &#123; private String id; private String userName;&#125;import com.alibaba.fastjson.JSON;/** * @author liuzhihang * @date 2018/4/17 19:02 */public class ProtostuffTest &#123; public static void main(String[] args) &#123; User user = new User(); user.setId(&quot;test0001&quot;); user.setUserName(&quot;æµ‹è¯•ç”¨æˆ·0001&quot;); System.out.println(JSON.toJSONString(user)); byte[] serialize = ProtostuffUtil.serialize(user, User.class); User unSerialize = ProtostuffUtil.unSerialize(serialize, User.class); System.err.println(JSON.toJSONString(unSerialize)); &#125;&#125;ç»“æœ:&#123;&quot;id&quot;:&quot;test0001&quot;,&quot;userName&quot;:&quot;æµ‹è¯•ç”¨æˆ·0001&quot;&#125;&#123;&quot;id&quot;:&quot;test0001&quot;,&quot;userName&quot;:&quot;æµ‹è¯•ç”¨æˆ·0001&quot;&#125;","categories":[{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/categories/utils/"}],"tags":[{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/tags/utils/"},{"name":"serialize","slug":"serialize","permalink":"https://liuzhihang.com/tags/serialize/"}]},{"title":"Transactionalå£°æ˜å¼äº‹åŠ¡","slug":"spring/Transactional","date":"2018-01-27T03:50:13.000Z","updated":"2020-04-04T04:12:06.921Z","comments":true,"path":"2018/01/27/transactional-declarative-transaction.html","link":"","permalink":"https://liuzhihang.com/2018/01/27/transactional-declarative-transaction.html","excerpt":"ä»‹ç»1.å£°æ˜å¼äº‹åŠ¡ç®¡ç†å»ºç«‹åœ¨AOPä¹‹ä¸Šçš„. å…¶æœ¬è´¨æ˜¯å¯¹æ–¹æ³•å‰åè¿›è¡Œæ‹¦æˆª, ç„¶ååœ¨ç›®æ ‡æ–¹æ³•å¼€å§‹ä¹‹å‰åˆ›å»ºæˆ–è€…åŠ å…¥ä¸€ä¸ªäº‹åŠ¡, åœ¨æ‰§è¡Œå®Œç›®æ ‡æ–¹æ³•ä¹‹åæ ¹æ®æ‰§è¡Œæƒ…å†µæäº¤æˆ–è€…å›æ»šäº‹åŠ¡.2.å£°æ˜å¼äº‹åŠ¡æœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯ä¸éœ€è¦é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼ç®¡ç†äº‹åŠ¡, è¿™æ ·å°±ä¸éœ€è¦åœ¨ä¸šåŠ¡é€»è¾‘ä»£ç ä¸­æºæ‚äº‹åŠ¡ç®¡ç†çš„ä»£ç , åªéœ€åœ¨é…ç½®æ–‡ä»¶ä¸­åšç›¸å…³çš„äº‹åŠ¡è§„åˆ™å£°æ˜(æˆ–é€šè¿‡åŸºäº@Transactionalæ³¨è§£çš„æ–¹å¼), ä¾¿å¯ä»¥å°†äº‹åŠ¡è§„åˆ™åº”ç”¨åˆ°ä¸šåŠ¡é€»è¾‘ä¸­.3.å£°æ˜å¼äº‹åŠ¡ä¸è¶³çš„åœ°æ–¹åœ¨äº, ä¸ç¼–ç¨‹å¼äº‹åŠ¡ç›¸æ¯”, åªèƒ½ä½œç”¨åˆ°æ–¹æ³•çº§åˆ«, æ— æ³•åƒç¼–ç¨‹å¼äº‹åŠ¡é‚£æ ·å¯ä»¥ä½œç”¨åˆ°ä»£ç å—çº§åˆ«. xmlé…ç½®1.æ·»åŠ å‘½åç©ºé—´","text":"ä»‹ç»1.å£°æ˜å¼äº‹åŠ¡ç®¡ç†å»ºç«‹åœ¨AOPä¹‹ä¸Šçš„. å…¶æœ¬è´¨æ˜¯å¯¹æ–¹æ³•å‰åè¿›è¡Œæ‹¦æˆª, ç„¶ååœ¨ç›®æ ‡æ–¹æ³•å¼€å§‹ä¹‹å‰åˆ›å»ºæˆ–è€…åŠ å…¥ä¸€ä¸ªäº‹åŠ¡, åœ¨æ‰§è¡Œå®Œç›®æ ‡æ–¹æ³•ä¹‹åæ ¹æ®æ‰§è¡Œæƒ…å†µæäº¤æˆ–è€…å›æ»šäº‹åŠ¡.2.å£°æ˜å¼äº‹åŠ¡æœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯ä¸éœ€è¦é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼ç®¡ç†äº‹åŠ¡, è¿™æ ·å°±ä¸éœ€è¦åœ¨ä¸šåŠ¡é€»è¾‘ä»£ç ä¸­æºæ‚äº‹åŠ¡ç®¡ç†çš„ä»£ç , åªéœ€åœ¨é…ç½®æ–‡ä»¶ä¸­åšç›¸å…³çš„äº‹åŠ¡è§„åˆ™å£°æ˜(æˆ–é€šè¿‡åŸºäº@Transactionalæ³¨è§£çš„æ–¹å¼), ä¾¿å¯ä»¥å°†äº‹åŠ¡è§„åˆ™åº”ç”¨åˆ°ä¸šåŠ¡é€»è¾‘ä¸­.3.å£°æ˜å¼äº‹åŠ¡ä¸è¶³çš„åœ°æ–¹åœ¨äº, ä¸ç¼–ç¨‹å¼äº‹åŠ¡ç›¸æ¯”, åªèƒ½ä½œç”¨åˆ°æ–¹æ³•çº§åˆ«, æ— æ³•åƒç¼–ç¨‹å¼äº‹åŠ¡é‚£æ ·å¯ä»¥ä½œç”¨åˆ°ä»£ç å—çº§åˆ«. xmlé…ç½®1.æ·»åŠ å‘½åç©ºé—´ &lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; . . . xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xsi:schemaLocation=&quot; . . . http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd&quot;&gt; 2.æ·»åŠ ç›¸å…³äº‹åŠ¡æ”¯æŒ &lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt; &lt;!-- æŒ‡å‘æ•°æ®æº --&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;masterDataSource&quot;/&gt;&lt;/bean&gt;&lt;!-- å¼€å¯äº‹åŠ¡çš„Annotationæ”¯æŒ --&gt;&lt;tx:annotation-driven transaction-manager=&quot;transactionManager&quot;/&gt; @Transactionalæ³¨è§£ ä½¿ç”¨@Transactional å¯ä»¥ä½œç”¨äºæ¥å£,æ¥å£æ–¹æ³•,ç±»ä»¥åŠç±»æ–¹æ³•ä¸Š. åªéœ€è¦åœ¨ç›¸åº”æ¥å£,ç±»æˆ–æ–¹æ³•ä¸ŠåŠ ä¸Š@Transactionalæ³¨è§£å³å¯. @Transactional æ³¨è§£ä»‹ç»package org.springframework.transaction.annotation;import java.lang.annotation.Documented;import java.lang.annotation.ElementType;import java.lang.annotation.Inherited;import java.lang.annotation.Retention;import java.lang.annotation.RetentionPolicy;import java.lang.annotation.Target;import org.springframework.core.annotation.AliasFor;import org.springframework.transaction.TransactionDefinition;import org.springframework.transaction.annotation.Isolation;import org.springframework.transaction.annotation.Propagation;/** * @Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;) : å¯ç”¨äºæ¥å£, ç±», æšä¸¾, æ³¨è§£, æ–¹æ³• * @Retention(RetentionPolicy.RUNTIME) : æ³¨è§£ä¼šåœ¨classå­—èŠ‚ç æ–‡ä»¶ä¸­å­˜åœ¨ï¼Œåœ¨è¿è¡Œæ—¶å¯ä»¥é€šè¿‡åå°„è·å–åˆ° * @Inherited : å­ç±»å¯ä»¥ç»§æ‰¿çˆ¶ç±»ä¸­çš„æ³¨è§£ * @Documented : æ³¨è§£å°†è¢«åŒ…å«åœ¨javadocä¸­ */@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Inherited@Documentedpublic @interface Transactional &#123; /** * äº‹åŠ¡ç®¡ç†å™¨çš„åˆ«å * ç³»ç»ŸæŒ‡å®šå¤šä¸ªäº‹åŠ¡ç®¡ç†å™¨æ—¶å¯é€šè¿‡åˆ«åè¿›è¡ŒåŒºåˆ† */ @AliasFor(&quot;transactionManager&quot;) String value() default &quot;&quot;; /** * å¯é€šè¿‡åœ¨ transactionManager ä¸­è®¾ç½® &lt;qualifier value=&quot;managerOne&quot;/&gt; å±æ€§ç±»æŒ‡å®šåç§° * å¯ç”¨äºç¡®å®šç›®æ ‡äº‹åŠ¡ç®¡ç†å™¨ï¼ŒåŒ¹é…ç‰¹å®šçš„é™å®šç¬¦å€¼ï¼ˆæˆ–beanåç§°ï¼‰ */ @AliasFor(&quot;value&quot;) String transactionManager() default &quot;&quot;; /** * äº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶ * é»˜è®¤ Propagation.REQUIRED */ Propagation propagation() default Propagation.REQUIRED; /** * äº‹åŠ¡çš„éš”ç¦»çº§åˆ« * é»˜è®¤ Isolation.DEFAULT */ Isolation isolation() default Isolation.DEFAULT; /** * äº‹åŠ¡è¶…æ—¶æ—¶é—´ * é»˜è®¤ TransactionDefinition.TIMEOUT_DEFAULT å³ -1 */ int timeout() default TransactionDefinition.TIMEOUT_DEFAULT; /** * è®¾ç½®äº‹åŠ¡åªè¯» */ boolean readOnly() default false; /** * è®¾ç½®éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™è¿›è¡Œäº‹åŠ¡å›æ»š * rollbackFor = Exception.class æˆ– rollbackFor = &#123;RuntimeException.class, Exception.class&#125; */ Class&lt;? extends Throwable&gt;[] rollbackFor() default &#123;&#125;; /** * è®¾ç½®éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶, äº‹åŠ¡è¿›è¡Œå›æ»š */ String[] rollbackForClassName() default &#123;&#125;; /** * è®¾ç½®ä¸éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™ä¸è¿›è¡Œäº‹åŠ¡å›æ»š */ Class&lt;? extends Throwable&gt;[] noRollbackFor() default &#123;&#125;; /** * è®¾ç½®ä¸éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶, äº‹åŠ¡ä¸è¿›è¡Œå›æ»š */ String[] noRollbackForClassName() default &#123;&#125;;&#125; ä¼ æ’­è¡Œä¸ºä»‹ç»äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º, ä¸€å…± 7 ç§1.æšä¸¾ä»‹ç» package org.springframework.transaction.annotation;import org.springframework.transaction.TransactionDefinition;public enum Propagation &#123; /** * æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨, åˆ™åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡ * äº‹åŠ¡çš„é»˜è®¤è®¾ç½® */ REQUIRED(TransactionDefinition.PROPAGATION_REQUIRED), /** * æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨, åˆ™ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ */ SUPPORTS(TransactionDefinition.PROPAGATION_SUPPORTS), /** * æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸ */ MANDATORY(TransactionDefinition.PROPAGATION_MANDATORY), /** * å¼€å§‹ä¸€ä¸ªæ–°çš„äº‹åŠ¡, å¹¶æš‚åœå½“å‰äº‹åŠ¡(å¦‚æœå­˜åœ¨) */ REQUIRES_NEW(TransactionDefinition.PROPAGATION_REQUIRES_NEW), /** * ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ, æš‚åœå½“å‰äº‹åŠ¡(å¦‚æœå­˜åœ¨) */ NOT_SUPPORTED(TransactionDefinition.PROPAGATION_NOT_SUPPORTED), /** * ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ, å¦‚æœå­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸ */ NEVER(TransactionDefinition.PROPAGATION_NEVER), /** * å¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨, åˆ™åœ¨åµŒå¥—äº‹åŠ¡ä¸­æ‰§è¡Œ. * å¦‚æœäº‹åŠ¡ä¸å­˜åœ¨, åˆ™ç­‰åŒäº PROPAGATION_REQUIRED */ NESTED(TransactionDefinition.PROPAGATION_NESTED); private final int value; Propagation(int value) &#123; this.value = value; &#125; public int value() &#123; return this.value; &#125;&#125; 2.åˆ—è¡¨ Propagation å«ä¹‰ REQUIRED æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨, åˆ™åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡ SUPPORTS æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨, åˆ™ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ MANDATORY æ”¯æŒå½“å‰äº‹åŠ¡, å¦‚æœä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸ REQUIRES_NEW å¼€å§‹ä¸€ä¸ªæ–°çš„äº‹åŠ¡, å¹¶æš‚åœå½“å‰äº‹åŠ¡(å¦‚æœå­˜åœ¨) NOT_SUPPORTED ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ, æš‚åœå½“å‰äº‹åŠ¡(å¦‚æœå­˜åœ¨) NEVER ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ, å¦‚æœå­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸ NESTED å¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨, åˆ™åœ¨åµŒå¥—äº‹åŠ¡ä¸­æ‰§è¡Œ. å¦‚æœäº‹åŠ¡ä¸å­˜åœ¨, åˆ™ç­‰åŒäº PROPAGATION_REQUIRED éš”ç¦»çº§åˆ«ä»‹ç»1.æšä¸¾ä»‹ç» package org.springframework.transaction.annotation;import org.springframework.transaction.TransactionDefinition;public enum Isolation &#123; /** * ä½¿ç”¨åº•å±‚æ•°æ®å­˜å‚¨é»˜è®¤çš„éš”ç¦»çº§åˆ« * ä¸€èˆ¬å­˜å‚¨åº•å±‚é»˜è®¤ä¸º: READ_COMMITTED */ DEFAULT(TransactionDefinition.ISOLATION_DEFAULT), /** * è¯»æœªæäº¤ * ä¼šå‡ºç°è„è¯»å’Œä¸å¯é‡å¤è¯», ä¸€èˆ¬ä¸ä½¿ç”¨ */ READ_UNCOMMITTED(TransactionDefinition.ISOLATION_READ_UNCOMMITTED), /** * è¯»å·²æäº¤ * è¯¥çº§åˆ«ä»…ç¦æ­¢äº‹åŠ¡è¯»å–å…¶ä¸­æœªæäº¤æ›´æ”¹çš„è¡Œ * å¯èƒ½ä¼šå‡ºç°ä¸å¯é‡å¤è¯»å–å’Œå¹»åƒè¯»å– */ READ_COMMITTED(TransactionDefinition.ISOLATION_READ_COMMITTED), /** * å¯é‡å¤è¯» * ç¦æ­¢äº‹åŠ¡è¯»å–å…¶ä¸­æœ‰æœªæäº¤æ›´æ”¹çš„è¡Œ, å¹¶ä¸”è¿˜ç¦æ­¢ä¸€ä¸ªäº‹åŠ¡è¯»å–ä¸€è¡Œ, ç¬¬äºŒä¸ªäº‹åŠ¡æ›´æ”¹è¯¥è¡Œ. å¹¶ä¸”ç¬¬ä¸€ä¸ªäº‹åŠ¡é‡æ–°è¯»å–è¯¥è¡Œ, ç¬¬äºŒæ¬¡è·å–ä¸åŒå€¼çš„æƒ…å†µ * å³ ç¦æ­¢ è¯»æœªæäº¤, ä¸å¯é‡å¤è¯» * ä¼šå‡ºç°å¹»è¯» */ REPEATABLE_READ(TransactionDefinition.ISOLATION_REPEATABLE_READ), /** * ä¸²è¡Œ * æ‰€æœ‰äº‹ç‰©ä¾æ¬¡æ‰§è¡Œ, ä¸ä¼šå½±å“åˆ«çš„äº‹åŠ¡, æ‰€ä»¥ä¼šé˜²æ­¢ ä¸å¯é‡å¤è¯» è„è¯» å¹»è¯» * ä¼šå½±å“æ€§èƒ½ */ SERIALIZABLE(TransactionDefinition.ISOLATION_SERIALIZABLE); private final int value; Isolation(int value) &#123; this.value = value; &#125; public int value() &#123; return this.value; &#125;&#125; 2.åˆ—è¡¨ Isolation å«ä¹‰ DEFAULT ä½¿ç”¨åº•å±‚æ•°æ®å­˜å‚¨é»˜è®¤çš„éš”ç¦»çº§åˆ«, ä¸€èˆ¬å­˜å‚¨åº•å±‚é»˜è®¤ä¸º: READ_COMMITTED READ_UNCOMMITTED è¯»æœªæäº¤, ä¼šå‡ºç°è„è¯»å’Œä¸å¯é‡å¤è¯», ä¸€èˆ¬ä¸ä½¿ç”¨ READ_COMMITTED è¯¥çº§åˆ«ä»…ç¦æ­¢äº‹åŠ¡è¯»å–å…¶ä¸­æœªæäº¤æ›´æ”¹çš„è¡Œ. å¯èƒ½ä¼šå‡ºç°ä¸å¯é‡å¤è¯»å–å’Œå¹»åƒè¯»å– REPEATABLE_READ å¯é‡å¤è¯», ç¦æ­¢äº‹åŠ¡è¯»å–å…¶ä¸­æœ‰æœªæäº¤æ›´æ”¹çš„è¡Œ, å¹¶ä¸”è¿˜ç¦æ­¢ä¸€ä¸ªäº‹åŠ¡è¯»å–ä¸€è¡Œ, ç¬¬äºŒä¸ªäº‹åŠ¡æ›´æ”¹è¯¥è¡Œ. å¹¶ä¸”ç¬¬ä¸€ä¸ªäº‹åŠ¡é‡æ–°è¯»å–è¯¥è¡Œ, ç¬¬äºŒæ¬¡è·å–ä¸åŒå€¼çš„æƒ…å†µ. å³ ç¦æ­¢ è¯»æœªæäº¤, ä¸å¯é‡å¤è¯». ä¼šå‡ºç°å¹»è¯» SERIALIZABLE ä¸²è¡Œ, æ‰€æœ‰äº‹ç‰©ä¾æ¬¡æ‰§è¡Œ, ä¸ä¼šå½±å“åˆ«çš„äº‹åŠ¡, æ‰€ä»¥ä¼šé˜²æ­¢ ä¸å¯é‡å¤è¯» è„è¯» å¹»è¯». ä¼šå½±å“æ€§èƒ½ 3.è„è¯» å¹»è¯» ä¸å¯é‡å¤è¯» è„è¯» å½“ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨è®¿é—®æ•°æ®ï¼Œå¹¶ä¸”å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œè¿™ç§ä¿®æ”¹è¿˜æ²¡æœ‰æäº¤åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¿™ä¸ªæ•°æ®ï¼Œç„¶åä½¿ç”¨äº†è¿™ä¸ªæ•°æ®ã€‚ å¹»è¯» äº‹åŠ¡è¯»å–æ—¶ä¸å­˜åœ¨è¯¥æ•°æ®, è¯»å–åå‘ç°è¯¥æ•°æ®å­˜åœ¨. ä¸­é—´å› ä¸ºåˆ«çš„äº‹åŠ¡åœ¨è¿›è¡Œæ’å…¥æ“ä½œ ä¸å¯é‡å¤è¯» ä¸€ä¸ªäº‹åŠ¡åœ¨è¯»å–è¯¥æ•°æ®æ—¶å¦ä¸€ä¸ªäº‹åŠ¡åœ¨ä¿®æ”¹è¯¥æ•°æ®, å¯¼è‡´å¤šæ¬¡è¯»å–æ•°æ®å†…å®¹ä¸ä¸€è‡´","categories":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"transactional","slug":"transactional","permalink":"https://liuzhihang.com/tags/transactional/"}]},{"title":"æ•´æ•°åŒ…è£…ç±»å‹çš„ç¼“å­˜","slug":"source-code/java/IntegerCache","date":"2018-01-15T12:12:20.000Z","updated":"2020-04-04T06:53:41.581Z","comments":true,"path":"2018/01/15/integer-wrapper-type-cache.html","link":"","permalink":"https://liuzhihang.com/2018/01/15/integer-wrapper-type-cache.html","excerpt":"éƒ¨åˆ†åŒ…è£…ç±»å‹å­˜åœ¨ç¼“å­˜æœºåˆ¶, ä¼šåœ¨JVMå¯åŠ¨æ—¶, ç¼“å­˜ä¸€å®šæ•°é‡çš„å¯¹è±¡, æœ‰åŠ©äºèŠ‚çœå†…å­˜, æé«˜æ€§èƒ½. ç¼“å­˜åŒºé—´ ç±»å‹ èŒƒå›´ æ˜¯å¦ä¿®æ”¹ Integer -128 åˆ° 127 true : -XX:AutoBoxCacheMax=size ä¿®æ”¹ ByteCache -128 åˆ° 127 false ShortCache -128 åˆ° 127 false LongCache -128 åˆ° 127 false CharacterCache 0 åˆ° 127 false","text":"éƒ¨åˆ†åŒ…è£…ç±»å‹å­˜åœ¨ç¼“å­˜æœºåˆ¶, ä¼šåœ¨JVMå¯åŠ¨æ—¶, ç¼“å­˜ä¸€å®šæ•°é‡çš„å¯¹è±¡, æœ‰åŠ©äºèŠ‚çœå†…å­˜, æé«˜æ€§èƒ½. ç¼“å­˜åŒºé—´ ç±»å‹ èŒƒå›´ æ˜¯å¦ä¿®æ”¹ Integer -128 åˆ° 127 true : -XX:AutoBoxCacheMax=size ä¿®æ”¹ ByteCache -128 åˆ° 127 false ShortCache -128 åˆ° 127 false LongCache -128 åˆ° 127 false CharacterCache 0 åˆ° 127 false ä¸¾ä¾‹Integer a = 100;Integer b = 100;Integer c = 1000;Integer d = 1000;Integer e = new Integer(100);Integer f = Integer.valueOf(100);System.out.println(a == b); // trueSystem.out.println(c == d); // falseSystem.out.println(a == e); // falseSystem.out.println(f == e); // falseSystem.out.println(a == f); // true åˆ†æ== åœ¨æ¯”è¾ƒå¯¹è±¡æ—¶, åˆ¤æ–­æ˜¯å¦æŒ‡å‘åŒä¸€åœ°å€ a b f éƒ½æ˜¯ä»ç¼“å­˜ä¸­å–å‡ºæ•°æ®, æ‰€ä»¥åœ°å€æ˜¯ç›¸åŒçš„ c d ä¸åœ¨ç¼“å­˜èŒƒå›´å†…, æ‰€ä»¥æ˜¯æ–°çš„å¯¹è±¡ e æ˜¯æ–°å¯¹è±¡ IntegerCacheprivate static class IntegerCache &#123; static final int low = -128; static final int high; static final Integer cache[]; static &#123; // high value may be configured by property int h = 127; String integerCacheHighPropValue = sun.misc.VM.getSavedProperty(&quot;java.lang.Integer.IntegerCache.high&quot;); if (integerCacheHighPropValue != null) &#123; try &#123; int i = parseInt(integerCacheHighPropValue); i = Math.max(i, 127); // Maximum array size is Integer.MAX_VALUE h = Math.min(i, Integer.MAX_VALUE - (-low) -1); &#125; catch( NumberFormatException nfe) &#123; // If the property cannot be parsed into an int, ignore it. &#125; &#125; high = h; cache = new Integer[(high - low) + 1]; int j = low; for(int k = 0; k &lt; cache.length; k++) cache[k] = new Integer(j++); // range [-128, 127] must be interned (JLS7 5.1.7) assert IntegerCache.high &gt;= 127; &#125; private IntegerCache() &#123;&#125; &#125; å¯ä»¥é€šè¿‡è®¾ç½® java.lang.Integer.IntegerCache.high æ¥ä¿®æ”¹ç¼“å­˜çš„å€¼. æ–¹æ³•ä¸ºä¿®æ”¹ JVM çš„å¯åŠ¨å‚æ•° -XX:AutoBoxCacheMax=size","categories":[{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"},{"name":"java","slug":"æºç å­¦ä¹ /java","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/java/"}],"tags":[{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"}]},{"title":"Interceptoræ‹¦æˆªå™¨","slug":"spring/Interceptor","date":"2018-01-10T06:50:13.000Z","updated":"2020-04-04T04:12:06.923Z","comments":true,"path":"2018/01/10/interceptor.html","link":"","permalink":"https://liuzhihang.com/2018/01/10/interceptor.html","excerpt":"ä»‹ç»Interceptor: æ‹¦æˆªå™¨ï¼Œä½œç”¨ç±»ä¼¼ Filter, ä¸»è¦ä½œç”¨æ˜¯æ‹¦æˆªç”¨æˆ·è¯·æ±‚, åœ¨ Action æ‰§è¡Œçš„å‰åå„æ‰§è¡Œä¸€æ®µä»£ç , è¿›è¡Œç›¸åº”çš„ä¸šåŠ¡å¤„ç†. ä½œç”¨æƒé™è®¤è¯ç»Ÿä¸€é€»è¾‘å¤„ç†æ—¥å¿—ç›‘æ§ç­‰","text":"ä»‹ç»Interceptor: æ‹¦æˆªå™¨ï¼Œä½œç”¨ç±»ä¼¼ Filter, ä¸»è¦ä½œç”¨æ˜¯æ‹¦æˆªç”¨æˆ·è¯·æ±‚, åœ¨ Action æ‰§è¡Œçš„å‰åå„æ‰§è¡Œä¸€æ®µä»£ç , è¿›è¡Œç›¸åº”çš„ä¸šåŠ¡å¤„ç†. ä½œç”¨æƒé™è®¤è¯ç»Ÿä¸€é€»è¾‘å¤„ç†æ—¥å¿—ç›‘æ§ç­‰ ä½¿ç”¨æ–¹å¼åŠæ–¹æ³•ä»‹ç»ä½¿ç”¨æ–¹å¼åˆ†ä¸ºä¸¤ç§, ä¸€ç§ä¸º: å®ç°HandlerInterceptoræ¥å£æˆ–è€…æ˜¯ç»§æ‰¿å®ç°äº†HandlerInterceptoræ¥å£çš„ç±», å¦ä¸€ç§ä¸º: å®ç°Springçš„WebRequestInterceptoræ¥å£, æˆ–è€…æ˜¯ç»§æ‰¿å®ç°äº†WebRequestInterceptorçš„ç±».1.HandlerInterceptor ä»‹ç» package org.springframework.web.servlet;import org.springframework.web.servlet.ModelAndView;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;public interface HandlerInterceptor &#123; /** * è¯·æ±‚å¤„ç†ä¹‹å‰è°ƒç”¨ é“¾å¼ ä¼šæŒ‰ç…§å£°æ˜é¡ºåºä¾æ¬¡æ‰§è¡Œ * è¿”å› true åˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª Interceptor æ— åˆ™æ‰§è¡Œ Controller * è¿”å› false è¯·æ±‚ç»“æŸ */ boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception; /** * åœ¨è¯·æ±‚å¤„ç†ä¹‹åï¼ŒDispatcherServletè¿›è¡Œè§†å›¾è¿”å›æ¸²æŸ“ä¹‹å‰è¿›è¡Œè°ƒç”¨ï¼Œå¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å¯¹Controller å¤„ç†ä¹‹åçš„ModelAndView å¯¹è±¡è¿›è¡Œæ“ä½œã€‚ * è°ƒåº¦ç¨‹åºServletåœ¨æ‰§è¡Œé“¾ä¸­å¤„ç†ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œç”±ä»»æ„æ•°é‡çš„æ‹¦æˆªå™¨ç»„æˆï¼Œå¤„ç†å™¨æœ¬èº«åœ¨æœ€åã€‚ ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæ¯ä¸ªæ‹¦æˆªå™¨å¯ä»¥åå¤„ç†ä¸€ä¸ªæ‰§è¡Œï¼Œå¹¶æŒ‰ç…§æ‰§è¡Œé“¾çš„ç›¸åé¡ºåºè¿›è¡Œåº”ç”¨ */ void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception; /** * è¯·æ±‚å¤„ç†å®Œæˆåçš„å›è°ƒï¼Œå³æ¸²æŸ“è§†å›¾åçš„å›è°ƒã€‚ å°†è¢«è°ƒç”¨å¤„ç†ç¨‹åºæ‰§è¡Œçš„ä»»ä½•ç»“æœï¼Œä»è€Œå…è®¸é€‚å½“çš„èµ„æºæ¸…ç†ã€‚ * æ³¨æ„ï¼šåªæœ‰å½“è¿™ä¸ªæ‹¦æˆªå™¨çš„é¢„å¤„ç†æ–¹æ³•å·²ç»æˆåŠŸå®Œæˆå¹¶è¿”å›æ—¶æ‰ä¼šè¢«è°ƒç”¨ * ä¸postHandleæ–¹æ³•ä¸€æ ·ï¼Œè¯¥æ–¹æ³•å°†ä»¥ç›¸åçš„é¡ºåºåœ¨é“¾ä¸­çš„æ¯ä¸ªæ‹¦æˆªå™¨ä¸Šè°ƒç”¨ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨å°†æˆä¸ºæœ€åè¢«è°ƒç”¨çš„æ‹¦æˆªå™¨ */ void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception;&#125; 2.WebRequestInterceptor ä»‹ç» package org.springframework.web.context.request;import org.springframework.ui.ModelMap;import org.springframework.web.context.request.WebRequest;public interface WebRequestInterceptor &#123; /** * åœ¨è°ƒç”¨ä¹‹å‰æ‹¦æˆªè¯·æ±‚å¤„ç†ç¨‹åºçš„æ‰§è¡Œã€‚ å…è®¸å‡†å¤‡ä¸Šä¸‹æ–‡èµ„æºï¼ˆå¦‚Hibernate Sessionï¼‰å¹¶å°†å®ƒä»¬å…¬å¼€ä¸ºè¯·æ±‚å±æ€§æˆ–çº¿ç¨‹æœ¬åœ°å¯¹è±¡. * å³ å‡†å¤‡ä¸€äº›éœ€è¦çš„èµ„æº, ä¾‹å¦‚, å°†è¯·æ±‚å±æ€§æ”¾ç½®åˆ° WebRequest ä¸­ * æ— è¿”å›å¯¹è±¡ */ void preHandle(WebRequest request) throws Exception; /** * åœ¨è§†å›¾å‘ˆç°å‰ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰åœ¨æˆåŠŸè°ƒç”¨ä¹‹åæ‹¦æˆªè¯·æ±‚å¤„ç†ç¨‹åºçš„æ‰§è¡Œã€‚ * å…è®¸åœ¨æˆåŠŸå¤„ç†ç¨‹åºæ‰§è¡Œåä¿®æ”¹ä¸Šä¸‹æ–‡èµ„æºï¼ˆä¾‹å¦‚ï¼Œåˆ·æ–°ä¼‘çœ ä¼šè¯ï¼‰ * å¯ä»¥é€šè¿‡ä¿®æ”¹ ModelMap çš„å±æ€§æ¥æ”¹å˜ä½ è¿”å›çš„è¯•å›¾æ¨¡å‹ */ void postHandle(WebRequest request, ModelMap model) throws Exception; /** * æ±‚å¤„ç†å®Œæˆåçš„å›è°ƒï¼Œå³æ¸²æŸ“è§†å›¾åçš„å›è°ƒã€‚ å°†è¢«è°ƒç”¨å¤„ç†ç¨‹åºæ‰§è¡Œçš„ä»»ä½•ç»“æœï¼Œä»è€Œå…è®¸é€‚å½“çš„èµ„æºæ¸…ç†ã€‚ * æ³¨æ„ï¼šåªæœ‰åœ¨æ‹¦æˆªå™¨çš„é¢„å¤„ç†æ–¹æ³•æˆåŠŸå®Œæˆæ—¶æ‰ä¼šè°ƒç”¨ */ void afterCompletion(WebRequest request, Exception ex) throws Exception;&#125; xml é…ç½®1.åœ¨ *-servlet.xml ä¸­æ·»åŠ  MVC schema xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;xsi:schemaLocation=&quot; http://www.springframework.org/schema/mvchttp://www.springframework.org/schema/mvc/spring-mvc-3.0.xsd&quot; 2.é…ç½® mvc:interceptors æ ‡ç­¾ &lt;mvc:interceptors&gt; &lt;mvc:interceptor&gt; &lt;!-- æ‹¦æˆªè·¯å¾„ --&gt; &lt;mvc:mapping path=&quot;/**&quot;/&gt; &lt;!-- æŒ‡å®šæ‹¦æˆªå™¨ --&gt; &lt;bean class=&quot;com.liuzhihang.myprojext.controller.interceptor.RequestInterceptor&quot;/&gt; &lt;/mvc:interceptor&gt;&lt;/mvc:interceptors&gt; ä½¿ç”¨ç¤ºä¾‹package com.liuzhihang.myprojext.controller.interceptor;import org.springframework.web.servlet.HandlerInterceptor;import org.springframework.web.servlet.ModelAndView;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;public class RequestInterceptor implements HandlerInterceptor &#123; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; // å¤„ç†é€»è¾‘ return true; &#125; @Override public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123; &#125; @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123; &#125;&#125;","categories":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"interceptor","slug":"interceptor","permalink":"https://liuzhihang.com/tags/interceptor/"},{"name":"servlet","slug":"servlet","permalink":"https://liuzhihang.com/tags/servlet/"}]},{"title":"utilså·¥å…·--ValidationUtil å‚æ•°æ ¡éªŒ","slug":"utils/validation/ValidationUtil","date":"2017-12-30T13:20:20.000Z","updated":"2020-11-13T03:00:25.327Z","comments":true,"path":"2017/12/30/utils-tool-validationutil-parameter-check.html","link":"","permalink":"https://liuzhihang.com/2017/12/30/utils-tool-validationutil-parameter-check.html","excerpt":"åœ¨å·¥ä½œä¸­ä¸å¯é¿å…çš„è¦é¢å¯¹å¾ˆå¤šå‚æ•°æ ¡éªŒ, æ¯”å¦‚å†™æ–°æ¥å£æ—¶éœ€è¦å¯¹ä¼ å…¥VOçš„å¿…è¦å­—æ®µè¿›è¡Œæ ¡éªŒ, String æ˜¯å¦ä¸ºç©º, Integer æœ€å°å€¼, å¯¹è±¡æ˜¯å¦ä¸ºnull, ç­‰ç­‰.è€Œä½¿ç”¨ hibernateçš„validatorå·¥å…·å¯¹å‚æ•°è¿›è¡Œæ ¡éªŒ, å¯ä»¥æå¤§çš„ç®€åŒ–æµç¨‹, å½“ç„¶ä¸å¯é¿å…çš„å°±æ˜¯éœ€è¦åœ¨è¢«æ ¡éªŒå­—æ®µä¸ŠåŠ ä¸Šæ³¨è§£ä¿¡æ¯. 1. ç›¸å…³ä¾èµ–&lt;!-- å‚æ•°æ ¡éªŒå·¥å…· --&gt;&lt;dependency&gt; &lt;groupId&gt;org.hibernate&lt;/groupId&gt; &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt; &lt;version&gt;5.4.2.Final&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.glassfish.web&lt;/groupId&gt; &lt;artifactId&gt;el-impl&lt;/artifactId&gt; &lt;version&gt;2.2&lt;/version&gt;&lt;/dependency&gt;","text":"åœ¨å·¥ä½œä¸­ä¸å¯é¿å…çš„è¦é¢å¯¹å¾ˆå¤šå‚æ•°æ ¡éªŒ, æ¯”å¦‚å†™æ–°æ¥å£æ—¶éœ€è¦å¯¹ä¼ å…¥VOçš„å¿…è¦å­—æ®µè¿›è¡Œæ ¡éªŒ, String æ˜¯å¦ä¸ºç©º, Integer æœ€å°å€¼, å¯¹è±¡æ˜¯å¦ä¸ºnull, ç­‰ç­‰.è€Œä½¿ç”¨ hibernateçš„validatorå·¥å…·å¯¹å‚æ•°è¿›è¡Œæ ¡éªŒ, å¯ä»¥æå¤§çš„ç®€åŒ–æµç¨‹, å½“ç„¶ä¸å¯é¿å…çš„å°±æ˜¯éœ€è¦åœ¨è¢«æ ¡éªŒå­—æ®µä¸ŠåŠ ä¸Šæ³¨è§£ä¿¡æ¯. 1. ç›¸å…³ä¾èµ–&lt;!-- å‚æ•°æ ¡éªŒå·¥å…· --&gt;&lt;dependency&gt; &lt;groupId&gt;org.hibernate&lt;/groupId&gt; &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt; &lt;version&gt;5.4.2.Final&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.glassfish.web&lt;/groupId&gt; &lt;artifactId&gt;el-impl&lt;/artifactId&gt; &lt;version&gt;2.2&lt;/version&gt;&lt;/dependency&gt; 2. ValidationUtilå¯¹åŠ ä¸Šç›¸å…³æ³¨è§£å­—æ®µè¿›è¡Œæ ¡éªŒ, ä½¿ç”¨åˆ° ValidationUtil.javaå’ŒValidationResult.javaä¸¤ä¸ªæ–‡ä»¶, ä¹Ÿå¯åœ¨å·¥å…·ä¸­ç›´æ¥æŠ›å‡ºå¼‚å¸¸. ValidationUtil å†…å®¹å¦‚ä¸‹: package com.liuzhihang.tool.validate;import org.apache.commons.collections.CollectionUtils;import javax.validation.ConstraintViolation;import javax.validation.Validation;import javax.validation.Validator;import java.beans.IntrospectionException;import java.beans.Introspector;import java.beans.PropertyDescriptor;import java.util.Set;/** * å¯¹æ·»åŠ  hibernate.validator æ³¨è§£çš„å­—æ®µè¿›è¡Œæ ¡éªŒ * * ä½¿ç”¨å‰ éœ€è¦å¼•å…¥ hibernate-validator ä¾èµ– * * @author liuzhihang * @date 2017/11/22 11:08 */public class ValidationUtil &#123; private static Validator validator = Validation.buildDefaultValidatorFactory().getValidator(); /** * ä¼š éªŒè¯ æ‰€æœ‰å­—æ®µ * * @param obj * @param &lt;T&gt; * @return è¿”å›æ‰€æœ‰ä¸ç¬¦åˆçš„ä¿¡æ¯ */ public static &lt;T&gt; ValidationResult validateAllField(T obj) &#123; ValidationResult result = new ValidationResult(true); StringBuilder errorMsg = new StringBuilder(); if (obj == null) &#123; result.setHasPass(false); result.setErrorMsg(&quot;The class is null!&quot;); return result; &#125; Set&lt;ConstraintViolation&lt;T&gt;&gt; violationSet = validator.validate(obj); if (CollectionUtils.isNotEmpty(violationSet)) &#123; for (ConstraintViolation&lt;T&gt; violation : violationSet) &#123; errorMsg.append(violation.getMessage()); &#125; result.setHasPass(false); result.setErrorMsg(errorMsg.toString()); &#125; return result; &#125; /** * éªŒè¯æŒ‡å®šå­—æ®µ æ˜¯å¦ç¬¦åˆä¿¡æ¯ * * @param obj * @param fieldName * @param &lt;T&gt; * @return */ public static &lt;T&gt; ValidationResult validateOneField(T obj, String fieldName) &#123; ValidationResult result = new ValidationResult(true); if (obj == null) &#123; result.setHasPass(false); result.setErrorMsg(&quot;The class is null!&quot;); return result; &#125; Set&lt;ConstraintViolation&lt;T&gt;&gt; violationSet = validator.validateProperty(obj, fieldName); if (CollectionUtils.isNotEmpty(violationSet)) &#123; for (ConstraintViolation&lt;T&gt; violation : violationSet) &#123; result.setHasPass(false); result.setErrorMsg(violation.getMessage()); &#125; &#125; return result; &#125; /** * éªŒè¯ æ‰€æœ‰å­—æ®µ, å½“ç¬¬ä¸€ä¸ªä¸ç¬¦åˆæ—¶ åˆ™ç›´æ¥è¿”å›ä¿¡æ¯ * * @param obj * @param &lt;T&gt; * @return */ public static &lt;T&gt; ValidationResult validateAllFieldForOneBack(T obj) &#123; ValidationResult result = new ValidationResult(true); if (obj == null) &#123; result.setHasPass(false); result.setErrorMsg(&quot;The class is null!&quot;); return result; &#125; try &#123; PropertyDescriptor[] propertyDescriptors = Introspector.getBeanInfo(obj.getClass()).getPropertyDescriptors(); for (PropertyDescriptor propertyDescriptor : propertyDescriptors) &#123; result = validateOneField(obj, propertyDescriptor.getName()); if (result.getHasPass()) &#123; return result; &#125; &#125; &#125; catch (IntrospectionException e) &#123; result.setHasPass(false); result.setErrorMsg(&quot;This validate has error : &quot; + e); &#125; return result; &#125;&#125; ValidationResult å†…å®¹å¦‚ä¸‹: package com.liuzhihang.tool.validate;/** * @Description: * @Author: liuzhihang * @Date: 2018/1/6 17:57 */public class ValidationResult &#123; private Boolean hasPass; private String errorMsg; public ValidationResult(Boolean hasPass) &#123; this.hasPass = hasPass; &#125; public Boolean getHasPass() &#123; return hasPass; &#125; public void setHasPass(Boolean hasPass) &#123; this.hasPass = hasPass; &#125; public String getErrorMsg() &#123; return errorMsg; &#125; public void setErrorMsg(String errorMsg) &#123; this.errorMsg = errorMsg; &#125; @Override public String toString() &#123; return &quot;ValidationResult&#123;&quot; + &quot;hasPass=&quot; + hasPass + &quot;, errorMsg=&#x27;&quot; + errorMsg + &#x27;\\&#x27;&#x27; + &#x27;&#125;&#x27;; &#125;&#125; 3. å¸¸ç”¨æ³¨è§£Bean Validation ä¸­å†…ç½®çš„ constraint@Null è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º null@NotNull è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸ä¸º null@AssertTrue è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º true@AssertFalse è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º false@Min(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼@Max(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼@DecimalMin(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼@DecimalMax(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼@Size(max&#x3D;, min&#x3D;) è¢«æ³¨é‡Šçš„å…ƒç´ çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†…@Digits (integer, fraction) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»åœ¨å¯æ¥å—çš„èŒƒå›´å†…@Past è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªè¿‡å»çš„æ—¥æœŸ@Future è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªå°†æ¥çš„æ—¥æœŸ@Pattern(regex&#x3D;,flag&#x3D;) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ç¬¦åˆæŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼Hibernate Validator é™„åŠ çš„ constraint@NotBlank(message &#x3D;) éªŒè¯å­—ç¬¦ä¸²énullï¼Œä¸”é•¿åº¦å¿…é¡»å¤§äº0@Email è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ç”µå­é‚®ç®±åœ°å€@Length(min&#x3D;,max&#x3D;) è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†…@NotEmpty è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¿…é¡»éç©º@Range(min&#x3D;,max&#x3D;,message&#x3D;) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»åœ¨åˆé€‚çš„èŒƒå›´å†… 4 æµ‹è¯•ç¤ºä¾‹ä»£ç : package com.liuzhihang.tool.validate;import lombok.Data;import org.hibernate.validator.constraints.NotBlank;import org.hibernate.validator.constraints.NotEmpty;import javax.validation.constraints.Min;import javax.validation.constraints.NotNull;/** * @author liuzhihang * @date 2017/11/22 18:25 */@Datapublic class ValidationVo &#123; @NotBlank(message = &quot;The name must notEmpty!&quot;) private String name; @NotNull(message = &quot;The age must notNull!&quot;) @Min(value = 1, message = &quot;The age must greater than 0!&quot;) private Integer age; public static void main(String[] args) &#123; ValidationVo validationVo = new ValidationVo(); System.out.println(ValidationUtil.validateAllField(validationVo).toString()); validationVo.setAge(1); System.out.println(ValidationUtil.validateAllField(validationVo).toString()); validationVo.setName(&quot;äºŒè›‹&quot;); System.out.println(ValidationUtil.validateAllField(validationVo).toString()); &#125;&#125; è¾“å‡ºç»“æœ: ValidationResult&#123;hasPass&#x3D;false, errorMsg&#x3D;&#39;The name must notEmpty!The age must notNull!&#39;&#125;ValidationResult&#123;hasPass&#x3D;false, errorMsg&#x3D;&#39;The name must notEmpty!&#39;&#125;ValidationResult&#123;hasPass&#x3D;true, errorMsg&#x3D;&#39;null&#39;&#125;","categories":[{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/categories/utils/"}],"tags":[{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/tags/utils/"},{"name":"validation","slug":"validation","permalink":"https://liuzhihang.com/tags/validation/"}]},{"title":"xmlè§£æ--dom4j","slug":"utils/xml/xml-dom4j","date":"2017-12-30T12:12:20.000Z","updated":"2020-11-13T03:00:24.719Z","comments":true,"path":"2017/12/30/xml-parsing-dom4j.html","link":"","permalink":"https://liuzhihang.com/2017/12/30/xml-parsing-dom4j.html","excerpt":"åœ¨å·¥ä½œä¸­æœ‰æ—¶å€™ä¼šç”¨åˆ°dom4jå¯¹xmlæ–‡ä»¶æˆ–è€…å­—ç¬¦ä¸²è¿›è¡Œè§£æ, ä»¥ä¸‹å†…å®¹ä¸ºéšæ‰‹ç¬”è®°, é˜²æ­¢ä»¥åé—å¿˜. 1. ç›¸å…³ä¾èµ–&lt;!-- dom4j --&gt;&lt;dependency&gt; &lt;groupId&gt;dom4j&lt;/groupId&gt; &lt;artifactId&gt;dom4j&lt;/artifactId&gt; &lt;version&gt;1.6.1&lt;/version&gt;&lt;/dependency&gt;","text":"åœ¨å·¥ä½œä¸­æœ‰æ—¶å€™ä¼šç”¨åˆ°dom4jå¯¹xmlæ–‡ä»¶æˆ–è€…å­—ç¬¦ä¸²è¿›è¡Œè§£æ, ä»¥ä¸‹å†…å®¹ä¸ºéšæ‰‹ç¬”è®°, é˜²æ­¢ä»¥åé—å¿˜. 1. ç›¸å…³ä¾èµ–&lt;!-- dom4j --&gt;&lt;dependency&gt; &lt;groupId&gt;dom4j&lt;/groupId&gt; &lt;artifactId&gt;dom4j&lt;/artifactId&gt; &lt;version&gt;1.6.1&lt;/version&gt;&lt;/dependency&gt; 2. è·å–domå¯¹è±¡è·å–domå¯¹è±¡æ–¹å¼ä¸»è¦ä»¥ä¸‹å‡ ç§: // è¯»å– xml æ–‡ä»¶ æ–¹å¼SAXReader reader = new SAXReader();Document doc1 = reader.read(new File(&quot;src/main/java/com/liuzhihang/tool/xml/alipay.xml&quot;));// è§£æ xml æ–‡æœ¬ æ–¹å¼String aliPayStr = XmlTest.getAliPayStr();Document doc2 = DocumentHelper.parseText(aliPayStr);// ä¸»åŠ¨åˆ›å»ºDocument doc3 = DocumentHelper.createDocument();Element element = doc3.addElement(&quot;Test&quot;); 3. æ“ä½œdomå¯¹è±¡å½“è·å–åˆ°domå¯¹è±¡åä¾¿å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯¹domè¿›è¡Œæ“ä½œ // è·å–æ ¹èŠ‚ç‚¹Element rootElement = dom.getRootElement();// System.out.println(rootElement.getName());// è·å–å­èŠ‚ç‚¹Element element = rootElement.element(&quot;response&quot;).element(&quot;alipay&quot;);// System.out.println(element.asXML());// è·å–èŠ‚ç‚¹çš„æ–‡å­—String text = element.element(&quot;alipay_buyer_login_id&quot;).getText();// System.out.println(text);// è·å–èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹ å¿«æ·é”® iter / itcoList elements = element.elements();// for (Object o : elements) &#123;// Element tempElement = (Element) o;// System.out.println(tempElement.getName() + &quot;\\t&quot; + tempElement.getText());// &#125;// for (Iterator iterator = elements.iterator(); iterator.hasNext(); ) &#123;// Element next = (Element)iterator.next();// System.out.println(next.getName() + &quot;\\t&quot; + next.getText());// &#125;// è·å–èŠ‚ç‚¹ä¸‹æ‰€æœ‰èŠ‚ç‚¹ Iteratorå¯¹è±¡ å¿«æ·é”® ititIterator iterator = element.elementIterator();// while (iterator.hasNext()) &#123;// Element next = (Element)iterator.next();// System.out.println(next.getName() + &quot;\\t&quot; + next.getText());// &#125;// æ·»åŠ èŠ‚ç‚¹Element testElement = element.addElement(&quot;testElement&quot;);// æŒ‡å®šæ·»åŠ æ–‡å­—testElement.setText(&quot;æµ‹è¯•æ·»åŠ æ–‡å­—&quot;);System.out.println(element.asXML());// åˆ é™¤èŠ‚ç‚¹boolean remove = element.remove(testElement);System.out.println(remove + &quot;\\n&quot; + element.asXML()); 4. è¯¦ç»†ä»£ç Dom4jTest.java","categories":[{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/categories/utils/"}],"tags":[{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/tags/utils/"},{"name":"xml","slug":"xml","permalink":"https://liuzhihang.com/tags/xml/"}]},{"title":"xmlè§£æ--JaxbUtil","slug":"utils/xml/xml-jaxb","date":"2017-12-17T12:12:20.000Z","updated":"2020-11-13T03:00:25.259Z","comments":true,"path":"2017/12/17/xml-parsing-jaxbutil.html","link":"","permalink":"https://liuzhihang.com/2017/12/17/xml-parsing-jaxbutil.html","excerpt":"ä¸»è¦ä»‹ç»ä½¿ç”¨jaxbå¯¹xmlè¿›è¡Œè§£æ, äº’è½¬. jaxb æ˜¯ç›¸å¯¹è¾ƒå¤šçš„xmlå·¥å…·, åªéœ€è¦åœ¨javaBeançš„å±æ€§ä¸Šæ·»åŠ ç›¸åº”æ³¨è§£, å°±å¯ä»¥ä½¿ç”¨å·¥å…·è¿›è¡Œè§£æ. å…·ä½“ä½¿ç”¨è¿‡ç¨‹å¦‚ä¸‹: 1. ç¼–å†™javaBeanå¹¶æ·»åŠ æ³¨è§£ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸€èˆ¬å¸¸ç”¨@XmlRootElement, @XmlAccessorType, @XmlElement, @XmlAttributeå››ä¸ªæ³¨è§£, å…¶ä½™ä½¿ç”¨æ–¹å¼å¯ä»¥å†è‡ªè¡Œæ·±å…¥ç ”ç©¶. @XmlRootElement: æ ¹å…ƒç´ @XmlAccessorType: javaå¯¹è±¡ç”Ÿæˆxmlæ–‡ä»¶æ—¶å¯¹javaå¯¹è±¡å±æ€§çš„è®¿é—®æ–¹å¼ å±æ€§ä¸ºXmlAccessType.FIELD æŒ‡javaæ‰€æœ‰æˆå‘˜å˜é‡@XmlElement: å­èŠ‚ç‚¹, name å¯æŒ‡å®šèŠ‚ç‚¹å@XmlAttribute: æ˜ å°„ä¸ºxmlæ–‡ä»¶çš„å±æ€§, name å¯æŒ‡å®šå±æ€§å","text":"ä¸»è¦ä»‹ç»ä½¿ç”¨jaxbå¯¹xmlè¿›è¡Œè§£æ, äº’è½¬. jaxb æ˜¯ç›¸å¯¹è¾ƒå¤šçš„xmlå·¥å…·, åªéœ€è¦åœ¨javaBeançš„å±æ€§ä¸Šæ·»åŠ ç›¸åº”æ³¨è§£, å°±å¯ä»¥ä½¿ç”¨å·¥å…·è¿›è¡Œè§£æ. å…·ä½“ä½¿ç”¨è¿‡ç¨‹å¦‚ä¸‹: 1. ç¼–å†™javaBeanå¹¶æ·»åŠ æ³¨è§£ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸€èˆ¬å¸¸ç”¨@XmlRootElement, @XmlAccessorType, @XmlElement, @XmlAttributeå››ä¸ªæ³¨è§£, å…¶ä½™ä½¿ç”¨æ–¹å¼å¯ä»¥å†è‡ªè¡Œæ·±å…¥ç ”ç©¶. @XmlRootElement: æ ¹å…ƒç´ @XmlAccessorType: javaå¯¹è±¡ç”Ÿæˆxmlæ–‡ä»¶æ—¶å¯¹javaå¯¹è±¡å±æ€§çš„è®¿é—®æ–¹å¼ å±æ€§ä¸ºXmlAccessType.FIELD æŒ‡javaæ‰€æœ‰æˆå‘˜å˜é‡@XmlElement: å­èŠ‚ç‚¹, name å¯æŒ‡å®šèŠ‚ç‚¹å@XmlAttribute: æ˜ å°„ä¸ºxmlæ–‡ä»¶çš„å±æ€§, name å¯æŒ‡å®šå±æ€§å javaBean: @Data@XmlRootElement(name = &quot;alipay&quot;)@XmlAccessorType(XmlAccessType.FIELD)class AliPayXml &#123; @XmlElement(name = &quot;alipay_buyer_login_id&quot; ) private String buyerLoginId; @XmlElement(name = &quot;alipay_buyer_user_id&quot;) private String buyerUserId;&#125; 2. ä½¿ç”¨ JaxbUtilJaxbUtilä»£ç  package com.liuzhihang.tool.xml;import javax.xml.bind.JAXBContext;import javax.xml.bind.JAXBException;import javax.xml.bind.Marshaller;import javax.xml.bind.Unmarshaller;import java.io.StringReader;import java.io.StringWriter;/** * Jaxb å·¥å…· * * @author liuzhihang * @date 2017/11/28 19:13 */public class JaxbUtil &#123; private static final String CHARTSET = &quot;UTF-8&quot;; public static String bean2Xml(Object obj) throws JAXBException &#123; return bean2Xml(obj, CHARTSET); &#125; public static String bean2Xml(Object obj, String chartset) throws JAXBException &#123; JAXBContext jaxbContext = JAXBContext.newInstance(obj.getClass()); Marshaller marshaller = jaxbContext.createMarshaller(); marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true); marshaller.setProperty(Marshaller.JAXB_ENCODING, chartset); StringWriter writer = new StringWriter(); marshaller.marshal(obj, writer); return writer.getBuffer().toString(); &#125; public static &lt;T&gt; T xml2Bean(String xmlString, Class&lt;T&gt; clazz) throws JAXBException &#123; JAXBContext jaxbContext = JAXBContext.newInstance(clazz); Unmarshaller unmarshaller = jaxbContext.createUnmarshaller(); T t = (T) unmarshaller.unmarshal(new StringReader(xmlString)); return t; &#125;&#125; 3. æµ‹è¯•ä»£ç å¾…æµ‹è¯•å­—ç¬¦ä¸²: xmlStr &lt;alipay&gt; &lt;alipay_buyer_login_id&gt;176****3035&lt;/alipay_buyer_login_id&gt; &lt;alipay_buyer_user_id&gt;2088912868994947&lt;/alipay_buyer_user_id&gt;&lt;/alipay&gt; æµ‹è¯•ä»£ç : /** * @Description: * @Author: liuzhihang * @Date: 2017/12/17 23:11 */public class JaxbTest &#123; public static void main(String[] args) throws JAXBException &#123; String aliPayXmlStr = &quot;&lt;alipay&gt;\\n&quot; + &quot; &lt;alipay_buyer_login_id&gt;176****3035&lt;/alipay_buyer_login_id&gt;\\n&quot; + &quot; &lt;alipay_buyer_user_id&gt;2088912868994947&lt;/alipay_buyer_user_id&gt;\\n&quot; + &quot;&lt;/alipay&gt;&quot;; AliPayXml aliPayXml = JaxbUtil.xml2Bean(aliPayXmlStr, AliPayXml.class); System.out.println(JSON.toJSONString(aliPayXml)); &#125;&#125; æµ‹è¯•ç»“æœ: æ‰“å°çš„ä¸ºjsonæ ¼å¼ç»“æœ, å¯debuggeræŸ¥çœ‹. åŒæ ·ä¹Ÿå¯ä»¥å°†javaBeanè½¬æ¢ä¸ºxmlStr &#123;&quot;buyerLoginId&quot;:&quot;176****3035&quot;,&quot;buyerUserId&quot;:&quot;2088912868994947&quot;&#125;","categories":[{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/categories/utils/"}],"tags":[{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/tags/utils/"},{"name":"xml","slug":"xml","permalink":"https://liuzhihang.com/tags/xml/"}]}],"categories":[{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"Spring","slug":"æºç ç¬”è®°/Spring","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/Spring/"},{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/"},{"name":"Doc View","slug":"å·¥å…·å†Œ/Doc-View","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/Doc-View/"},{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/categories/issue/"},{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"æºç ç¬”è®°/JDK","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/JDK/"},{"name":"é“¾è·¯è¿½è¸ª","slug":"å·¥ä½œç¬”è®°/é“¾è·¯è¿½è¸ª","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/"},{"name":"ELK","slug":"å·¥ä½œç¬”è®°/ELK","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/ELK/"},{"name":"IDEA","slug":"IDEA","permalink":"https://liuzhihang.com/categories/IDEA/"},{"name":"IDEA","slug":"å·¥å…·å†Œ/IDEA","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E5%85%B7%E5%86%8C/IDEA/"},{"name":"Archetype","slug":"å·¥ä½œç¬”è®°/Archetype","permalink":"https://liuzhihang.com/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/Archetype/"},{"name":"markdown","slug":"markdown","permalink":"https://liuzhihang.com/categories/markdown/"},{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"},{"name":"hexo","slug":"hexo","permalink":"https://liuzhihang.com/categories/hexo/"},{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/categories/Spring/"},{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/categories/ELK/"},{"name":"skywalking","slug":"skywalking","permalink":"https://liuzhihang.com/categories/skywalking/"},{"name":"Redis","slug":"Redis","permalink":"https://liuzhihang.com/categories/Redis/"},{"name":"cache","slug":"Redis/cache","permalink":"https://liuzhihang.com/categories/Redis/cache/"},{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"},{"name":"java","slug":"æºç å­¦ä¹ /java","permalink":"https://liuzhihang.com/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/java/"},{"name":"å¹¶å‘å’Œé”","slug":"å¹¶å‘å’Œé”","permalink":"https://liuzhihang.com/categories/%E5%B9%B6%E5%8F%91%E5%92%8C%E9%94%81/"},{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/categories/utils/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://liuzhihang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://liuzhihang.com/tags/Spring/"},{"name":"æºç ç¬”è®°","slug":"æºç ç¬”è®°","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/"},{"name":"å·¥å…·å†Œ","slug":"å·¥å…·å†Œ","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E5%85%B7%E5%86%8C/"},{"name":"Doc View","slug":"Doc-View","permalink":"https://liuzhihang.com/tags/Doc-View/"},{"name":"issue","slug":"issue","permalink":"https://liuzhihang.com/tags/issue/"},{"name":"mac","slug":"mac","permalink":"https://liuzhihang.com/tags/mac/"},{"name":"brew","slug":"brew","permalink":"https://liuzhihang.com/tags/brew/"},{"name":"å·¥ä½œç¬”è®°","slug":"å·¥ä½œç¬”è®°","permalink":"https://liuzhihang.com/tags/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/"},{"name":"JDK","slug":"JDK","permalink":"https://liuzhihang.com/tags/JDK/"},{"name":"é“¾è·¯è¿½è¸ª","slug":"é“¾è·¯è¿½è¸ª","permalink":"https://liuzhihang.com/tags/%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/"},{"name":"ELK","slug":"ELK","permalink":"https://liuzhihang.com/tags/ELK/"},{"name":"plugin","slug":"plugin","permalink":"https://liuzhihang.com/tags/plugin/"},{"name":"IDEA","slug":"IDEA","permalink":"https://liuzhihang.com/tags/IDEA/"},{"name":"Archetype","slug":"Archetype","permalink":"https://liuzhihang.com/tags/Archetype/"},{"name":"markdown","slug":"markdown","permalink":"https://liuzhihang.com/tags/markdown/"},{"name":"å°æŠ€å·§","slug":"å°æŠ€å·§","permalink":"https://liuzhihang.com/tags/%E5%B0%8F%E6%8A%80%E5%B7%A7/"},{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://liuzhihang.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"},{"name":"æµæ°´å·","slug":"æµæ°´å·","permalink":"https://liuzhihang.com/tags/%E6%B5%81%E6%B0%B4%E5%8F%B7/"},{"name":"é›ªèŠ±ç®—æ³•","slug":"é›ªèŠ±ç®—æ³•","permalink":"https://liuzhihang.com/tags/%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95/"},{"name":"error","slug":"error","permalink":"https://liuzhihang.com/tags/error/"},{"name":"hexo","slug":"hexo","permalink":"https://liuzhihang.com/tags/hexo/"},{"name":"JWT","slug":"JWT","permalink":"https://liuzhihang.com/tags/JWT/"},{"name":"SpringSecurity","slug":"SpringSecurity","permalink":"https://liuzhihang.com/tags/SpringSecurity/"},{"name":"skywalking","slug":"skywalking","permalink":"https://liuzhihang.com/tags/skywalking/"},{"name":"ip","slug":"ip","permalink":"https://liuzhihang.com/tags/ip/"},{"name":"Redis","slug":"Redis","permalink":"https://liuzhihang.com/tags/Redis/"},{"name":"cache","slug":"cache","permalink":"https://liuzhihang.com/tags/cache/"},{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://liuzhihang.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"},{"name":"çº¿ç¨‹æ± ","slug":"çº¿ç¨‹æ± ","permalink":"https://liuzhihang.com/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"},{"name":"å¤šçº¿ç¨‹","slug":"å¤šçº¿ç¨‹","permalink":"https://liuzhihang.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"},{"name":"åå°„","slug":"åå°„","permalink":"https://liuzhihang.com/tags/%E5%8F%8D%E5%B0%84/"},{"name":"LinkList","slug":"LinkList","permalink":"https://liuzhihang.com/tags/LinkList/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://liuzhihang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"},{"name":"å•ä¾‹æ¨¡å¼","slug":"å•ä¾‹æ¨¡å¼","permalink":"https://liuzhihang.com/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"},{"name":"volatile","slug":"volatile","permalink":"https://liuzhihang.com/tags/volatile/"},{"name":"aop","slug":"aop","permalink":"https://liuzhihang.com/tags/aop/"},{"name":"åŠ¨æ€ä»£ç†","slug":"åŠ¨æ€ä»£ç†","permalink":"https://liuzhihang.com/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"},{"name":"poi","slug":"poi","permalink":"https://liuzhihang.com/tags/poi/"},{"name":"excel","slug":"excel","permalink":"https://liuzhihang.com/tags/excel/"},{"name":"utils","slug":"utils","permalink":"https://liuzhihang.com/tags/utils/"},{"name":"serialize","slug":"serialize","permalink":"https://liuzhihang.com/tags/serialize/"},{"name":"transactional","slug":"transactional","permalink":"https://liuzhihang.com/tags/transactional/"},{"name":"interceptor","slug":"interceptor","permalink":"https://liuzhihang.com/tags/interceptor/"},{"name":"servlet","slug":"servlet","permalink":"https://liuzhihang.com/tags/servlet/"},{"name":"validation","slug":"validation","permalink":"https://liuzhihang.com/tags/validation/"},{"name":"xml","slug":"xml","permalink":"https://liuzhihang.com/tags/xml/"}]}